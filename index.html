<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>ã‚°ãƒ«ãƒ¼ãƒ—ãƒ›ãƒ¼ãƒ  å€‹äººè¨˜éŒ²</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <style>
    * { box-sizing: border-box; }
/* è¨˜éŒ²ä¸€è¦§ï¼šæ”¯æ´å†…å®¹ã‚’â€œæŠ˜ã‚ŠãŸãŸã¿â†’ã‚‚ã£ã¨è¦‹ã‚‹â€ */
.support-preview{
  white-space: pre-wrap;     /* æ”¹è¡Œã‚’ãã®ã¾ã¾è¡¨ç¤º */
  word-break: break-word;    /* é•·ã„æ–‡ç« ã‚‚æŠ˜ã‚Šè¿”ã™ */
  overflow: hidden;
  max-height: 5.2em;         /* â†æœ€åˆã¯ã“ã®é«˜ã•ã¾ã§ï¼ˆç´„3è¡Œï¼‰ */
}
.support-preview.expanded{
  max-height: none;          /* ã‚‚ã£ã¨è¦‹ã‚‹â†’å…¨æ–‡è¡¨ç¤º */
}

.support-toggle{
  border: none;
  background: transparent;
  padding: 0;
  margin-top: 6px;
  font-size: 12px;
  cursor: pointer;
  text-decoration: underline;
  color: #2563eb;
}

    body {
      margin: 0;
      font-family: -apple-system, BlinkMacSystemFont, "Helvetica Neue",
        "YuGothic", "Meiryo", sans-serif;
      background: #f3f4f6;
      color: #111827;
      font-size: 16px;
      line-height: 1.6;
    }

    header {
      background: #2563eb;
      color: white;
      padding: 16px 18px;
      font-size: 22px;
      font-weight: bold;
      text-align: center;
      position: sticky;
      top: 0;
      z-index: 10;
    }

    main {
      max-width: 1280px;
      margin: 0 auto;
      padding: 18px;
    }

    .layout {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 18px;
    }

    @media (max-width: 900px) {
      .layout { grid-template-columns: 1fr; }
    }

    .card {
      background: white;
      border-radius: 18px;
      padding: 20px 22px 22px;
      box-shadow: 0 8px 24px rgba(15, 23, 42, 0.1);
      margin-bottom: 18px;
    }

    .card-title {
      font-size: 20px;
      font-weight: 600;
      margin-bottom: 14px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 10px;
      flex-wrap: wrap;
    }

    .card-subtitle {
      font-size: 13px;
      color: #6b7280;
      margin-bottom: 14px;
    }

    label {
      font-size: 14px;
      font-weight: 600;
      display: block;
      margin-bottom: 5px;
      color: #374151;
    }

    input[type="text"],
    input[type="date"],
    select,
    textarea {
      width: 100%;
      border-radius: 12px;
      border: 1px solid #d1d5db;
      padding: 10px 12px;
      font-size: 15px;
      outline: none;
      transition: border-color 0.15s, box-shadow 0.15s;
      background: #f9fafb;
    }

    input[type="text"]:focus,
    input[type="date"]:focus,
    select:focus,
    textarea:focus {
      border-color: #2563eb;
      box-shadow: 0 0 0 1px rgba(37, 99, 235, 0.5);
      background: white;
    }

    textarea { min-height: 80px; resize: vertical; }

    .field-row {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 12px;
    }

    .field-row-3 {
      display: grid;
      grid-template-columns: repeat(3, minmax(0, 1fr));
      gap: 12px;
    }

    @media (max-width: 900px) {
      .field-row-3 { grid-template-columns: 1fr; }
    }

    .field { margin-bottom: 12px; }

    .checkbox-row {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      align-items: center;
      margin-bottom: 6px;
    }

    .checkbox-row label {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      font-weight: 500;
      font-size: 14px;
      margin-bottom: 0;
    }

    .btn-row {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      margin-top: 12px;
      align-items: center;
    }

    button {
      border: none;
      border-radius: 999px;
      padding: 10px 18px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: transform 0.05s ease-out, box-shadow 0.1s;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      white-space: nowrap;
    }

    button:active { transform: translateY(1px); box-shadow: none; }

    .btn-primary {
      background: #2563eb;
      color: white;
      box-shadow: 0 4px 12px rgba(37, 99, 235, 0.4);
    }

    .btn-secondary { background: #e5e7eb; color: #111827; }
    .btn-danger { background: #dc2626; color: white; }

    /* â˜…åˆå¿ƒè€…å‘ã‘ï¼šç·‘ãƒœã‚¿ãƒ³ï¼ˆé‡è¦æ“ä½œï¼‰ */
    .btn-beginner {
      background: #16a34a;
      color: #fff;
      box-shadow: 0 4px 12px rgba(22, 163, 74, 0.35);
    }

    .pill {
      border-radius: 999px;
      background: #eff6ff;
      padding: 4px 11px;
      font-size: 12px;
      color: #1d4ed8;
      border: 1px solid #bfdbfe;
    }

    .record-count { font-size: 13px; color: #6b7280; }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 13px;
      margin-top: 6px;
    }

    thead { position: sticky; top: 0; background: #eff6ff; z-index: 1; }

    th, td {
      border-bottom: 1px solid #e5e7eb;
      padding: 8px 6px;
      text-align: left;
      vertical-align: top;
    }

    

    .day-support-cell { white-space: normal; word-break: break-word; color: #374151; }
th { font-weight: 600; color: #374151; white-space: nowrap; }
    tbody tr:nth-child(even) { background: #f9fafb; }

    .table-wrapper {
      max-height: 520px;
      overflow: auto;
      border-radius: 14px;
      border: 1px solid #e5e7eb;
      margin-top: 10px;
    }

    .badge {
      display: inline-block;
      padding: 3px 9px;
      border-radius: 999px;
      font-size: 11px;
      font-weight: 600;
      color: white;
    }

    .badge-day { background: #22c55e; }
    .badge-evening { background: #f59e0b; }
    .badge-night { background: #6366f1; }

    .small-text { font-size: 12px; color: #6b7280; }

    .no-records {
      padding: 14px;
      font-size: 13px;
      color: #6b7280;
      text-align: center;
    }

    .resident-select-row {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      margin-bottom: 10px;
      align-items: center;
    }

    .resident-select-row span { font-size: 13px; color: #4b5563; }
    .resident-select-row select { max-width: 240px; }

    /* ã‚¿ã‚°ãƒœã‚¿ãƒ³ã¾ã‚ã‚Š */
    .tag-buttons {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      margin-bottom: 4px;
    }

    .tag-button {
      border-radius: 999px;
      border: 1px solid #e5e7eb;
      background: #f3f4f6;
      padding: 4px 10px;
      font-size: 12px;
      cursor: pointer;
    }

    .tag-button.tag-button-active {
      background: #f59e0b;
      border-color: #f97316;
      color: #fff;
    }
/* è¨˜éŒ²ä¸€è¦§ï¼šæ—¥ä¸­ã®ä¸»ãªæ”¯æ´ï¼ˆãƒãƒƒãƒ—è¡¨ç¤ºï¼‰ */
.list-support-tags{
  display:flex;
  flex-wrap:wrap;
  gap:6px;
}
.list-support-tag{
  display:inline-flex;
  align-items:center;
  padding:3px 9px;
  border-radius:999px;
  font-size:11px;
  font-weight:700;
  border:1px solid #bfdbfe;
  background:#eff6ff;
  color:#1d4ed8;
}

    .tag-chip {
      display: inline-block;
      margin-top: 2px;
      margin-right: 4px;
      padding: 2px 7px;
      border-radius: 999px;
      border: 1px solid #fde68a;
      background: #fffbeb;
      font-size: 11px;
    }

    /* PCè‹¦æ‰‹ãªäººå‘ã‘ï¼šå¤§ããªé¸æŠãƒœã‚¿ãƒ³ */
    .quick-row {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      margin-top: 6px;
      margin-bottom: 4px;
    }

    .quick-btn {
      flex: 1 0 0;
      min-width: 70px;
      justify-content: center;
      padding: 8px 10px;
      border-radius: 999px;
      border: 1px solid #d1d5db;
      background: #f3f4f6;
      font-size: 13px;
      cursor: pointer;
    }

    .quick-btn-active {
      background: #2563eb;
      color: #fff;
      border-color: #1d4ed8;
      box-shadow: 0 0 0 1px rgba(37, 99, 235, 0.4);
    }

    /* ãƒ¢ãƒ¼ãƒ€ãƒ« */
    .detail-modal-backdrop {
      position: fixed;
      inset: 0;
      background: rgba(15, 23, 42, 0.45);
      display: none;
      align-items: center;
      justify-content: center;
      padding: 16px;
      z-index: 50;
    }

    .detail-modal-backdrop.show { display: flex; }

    .detail-modal {
      background: #ffffff;
      border-radius: 18px;
      max-width: 720px;
      width: 100%;
      max-height: 90vh;
      padding: 18px 20px 20px;
      box-shadow: 0 20px 40px rgba(15, 23, 42, 0.35);
      overflow: auto;
    }

    .detail-modal-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 8px;
      gap: 10px;
      flex-wrap: wrap;
    }

    .detail-modal-title { font-size: 18px; font-weight: 600; }

    .detail-modal-close {
      border-radius: 999px;
      border: none;
      padding: 4px 10px;
      font-size: 16px;
      cursor: pointer;
      background: #e5e7eb;
    }

    .detail-modal-body { font-size: 14px; color: #111827; }

    .detail-field { margin-bottom: 6px; }

    .detail-field strong {
      display: inline-block;
      min-width: 120px;
      color: #4b5563;
    }

    .detail-multiline { margin-top: 8px; margin-bottom: 8px; }

    .detail-multiline strong {
      display: block;
      margin-bottom: 2px;
      color: #4b5563;
    }

    .detail-multiline pre {
      margin: 0;
      padding: 8px 10px;
      background: #f9fafb;
      border-radius: 10px;
      border: 1px solid #e5e7eb;
      white-space: pre-wrap;
      word-break: break-word;
      font-family: inherit;
      font-size: 13px;
    }

    /* ====== ã“ã“ã‹ã‚‰ï¼šåˆå¿ƒè€…ãŒè§¦ã‚‹ã¨ã“ã‚ã‚’ç·‘ã« ====== */
    .beginner-guide {
      border: 2px solid #22c55e;
      background: #f0fdf4;
      border-radius: 16px;
      padding: 12px 14px;
      margin-bottom: 12px;
    }
    .beginner-guide .title {
      font-weight: 800;
      color: #166534;
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 6px;
    }
    .beginner-guide .steps {
      font-size: 13px;
      color: #166534;
    }

    .beginner-zone {
      border: 2px solid #22c55e;
      background: #f0fdf4;
      border-radius: 14px;
      padding: 10px 12px;
      margin-bottom: 12px;
    }
    .beginner-badge {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 3px 10px;
      border-radius: 999px;
      font-size: 12px;
      font-weight: 800;
      background: #dcfce7;
      color: #166534;
      border: 1px solid #86efac;
      margin-left: 8px;
      white-space: nowrap;
    }
    .beginner-hint {
      font-size: 12px;
      color: #166534;
      margin-top: 6px;
    }
    /* ====== ã“ã“ã¾ã§ï¼šåˆå¿ƒè€…ã®ç·‘ ====== */

    /* ====== ç®¡ç†ã‚¨ãƒªã‚¢è‰²åˆ†ã‘ï¼ˆã‚ã¾ã‚Šè§¦ã‚‰ãªã„æ‰€ï¼‰ ====== */
    .admin-card {
      border: 2px solid #f59e0b;
      background: #fffbeb;
    }
    .admin-card .admin-note {
      font-size: 12px;
      color: #92400e;
      margin-top: 6px;
    }
    .admin-pill {
      border-radius: 999px;
      background: #fff7ed;
      padding: 4px 10px;
      font-size: 12px;
      color: #9a3412;
      border: 1px solid #fed7aa;
      font-weight: 800;
    }
    /* ===== è©³ç´°ãƒ¢ãƒ¼ãƒ€ãƒ«ï¼šä¸»ãªæ”¯æ´ã‚’ã‚¿ã‚°ã§ç›®ç«‹ãŸã›ã‚‹ ===== */
.detail-field.detail-tagrow{
  display:flex;
  align-items:flex-start;
  gap:10px;
  margin-bottom: 8px;
}
.detail-field.detail-tagrow strong{
  min-width:120px;           /* æ—¢å­˜ã¨åˆã‚ã›ã‚‹ */
  color:#4b5563;
}

.support-tags{
  display:flex;
  flex-wrap:wrap;
  gap:8px 10px;
  flex:1;
}

.support-tag{
  display:inline-flex;
  align-items:center;
  padding:6px 10px;
  border-radius:9999px;
  font-weight:800;
  font-size:13px;
  border:1px solid rgba(37,99,235,.25);
  background: rgba(37,99,235,.10);
  color:#1d4ed8;
}
.support-tag::before{
  content:"âœ“";
  font-weight:900;
  margin-right:6px;
}

/* æ¬ å¸­ç†ç”±ã¯è‰²ã‚’å¤‰ãˆã‚‹ï¼ˆä»»æ„ï¼‰ */
.support-tag.reason{
  border-color: rgba(245,158,11,.35);
  background: rgba(245,158,11,.18);
  color:#b45309;
}
.support-tag.reason::before{
  content:"!";
}

  </style>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
</head>

<body>
  <header>ã‚°ãƒ«ãƒ¼ãƒ—ãƒ›ãƒ¼ãƒ  å€‹äººè¨˜éŒ² WEBã‚¢ãƒ—ãƒªï¼ˆåˆå¿ƒè€…ã‚¬ã‚¤ãƒ‰ä»˜ãï¼‰</header>

  <main>
    <div class="layout">
      <!-- å…¥åŠ›ãƒ•ã‚©ãƒ¼ãƒ  -->
      <section class="card">
        <div class="card-title">
          <span>ä»Šæ—¥ã®å€‹äººè¨˜éŒ²</span>
          <span class="pill" id="modeLabel">æ–°è¦å…¥åŠ›ãƒ¢ãƒ¼ãƒ‰</span>
        </div>

        <!-- â˜…åˆå¿ƒè€…ã‚¬ã‚¤ãƒ‰ -->
        <div class="beginner-guide">
          <div class="title">âœ… åˆå¿ƒè€…ã¯ã€Œç·‘ã®æ ã ã‘ã€ã§OK</div>
          <div class="steps">
            â‘  æ—¥ä»˜ãƒ»åˆ©ç”¨è€… â†’ â‘¡ ã‚ˆãä½¿ã†é …ç›®ãƒã‚§ãƒƒã‚¯ â†’ â‘¢ã€æ—¥ä¸­ã«è¡Œã£ãŸä¸»ãªæ”¯æ´ã€‘ â†’ â‘£ è‡ªå‹• â†’ â‘¤ è¨˜éŒ²ã‚’ä¿å­˜
          </div>
        </div>

        <form id="recordForm">

          <!-- â˜…æ—¥ä»˜ãƒ»åˆ©ç”¨è€…ï¼ˆåˆå¿ƒè€…OKï¼‰ -->
          <div class="beginner-zone">
            <div style="display:flex; align-items:center; justify-content:space-between; gap:8px; flex-wrap:wrap;">
              <div style="font-weight:800; color:#166534;">â‘  æ—¥ä»˜ãƒ»åˆ©ç”¨è€… <span class="beginner-badge">ã“ã“ã ã‘OK</span></div>
              <div class="beginner-hint">â€»åˆ©ç”¨è€…ã‚’é¸ã¶ã¨ã€Œã‚ˆãä½¿ã†é …ç›®ã€ãŒè‡ªå‹•ã§ONã«ãªã‚Šã¾ã™ã€‚</div>
            </div>

            <div class="field-row" style="margin-top:10px;">
              <div class="field" style="margin-bottom:0;">
                <label for="date">æ—¥ä»˜</label>
                <input type="date" id="date" required />
              </div>
              <div class="field" style="margin-bottom:0;">
                <label for="resident">åˆ©ç”¨è€…</label>
                <select id="resident" required></select>
              </div>
            </div>
          </div>

          <div class="field-row-3">
            <div class="field">
              <label for="timeSlot">æ™‚é–“å¸¯</label>
              <select id="timeSlot">
                <option>æ—¥ä¸­</option>
                <option>å¤•æ–¹</option>
                <option>å¤œé–“</option>
              </select>
              <div class="quick-row" data-target="timeSlot">
                <button type="button" class="quick-btn" data-value="æ—¥ä¸­">æ—¥ä¸­</button>
                <button type="button" class="quick-btn" data-value="å¤•æ–¹">å¤•æ–¹</button>
                <button type="button" class="quick-btn" data-value="å¤œé–“">å¤œé–“</button>
              </div>
              <div class="small-text">ä¸Šã®ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯ã™ã‚‹ã¨æ™‚é–“å¸¯ãŒé¸æŠã•ã‚Œã¾ã™ã€‚</div>
            </div>

            <div class="field">
              <label for="condition">ä½“èª¿</label>
              <select id="condition">
                <option>è‰¯å¥½</option>
                <option>æ™®é€š</option>
                <option>ä¸è‰¯</option>
              </select>
              <div class="quick-row" data-target="condition">
                <button type="button" class="quick-btn" data-value="è‰¯å¥½">ğŸ˜Š è‰¯å¥½</button>
                <button type="button" class="quick-btn" data-value="æ™®é€š">ğŸ˜ æ™®é€š</button>
                <button type="button" class="quick-btn" data-value="ä¸è‰¯">ğŸ˜Ÿ ä¸è‰¯</button>
              </div>
              <div class="small-text">ãƒœã‚¿ãƒ³ã‚’æŠ¼ã™ã ã‘ã§ä½“èª¿ã‚’é¸ã¹ã¾ã™ã€‚</div>
            </div>

            <div class="field">
              <label for="mental">å¿ƒã®çŠ¶æ…‹</label>
              <select id="mental">
                <option>å®‰å®š</option>
                <option>ã‚„ã‚„ä¸å®‰</option>
                <option>ä¸å®‰å®š</option>
              </select>
              <div class="quick-row" data-target="mental">
                <button type="button" class="quick-btn" data-value="å®‰å®š">ğŸ˜Š å®‰å®š</button>
                <button type="button" class="quick-btn" data-value="ã‚„ã‚„ä¸å®‰">ğŸ˜ ã‚„ã‚„ä¸å®‰</button>
                <button type="button" class="quick-btn" data-value="ä¸å®‰å®š">ğŸ˜Ÿ ä¸å®‰å®š</button>
              </div>
              <div class="small-text">å¿ƒã®çŠ¶æ…‹ã‚‚ãƒœã‚¿ãƒ³ã§é¸ã¹ã¾ã™ã€‚</div>
            </div>
          </div>

          <div class="field">
            <label for="meal">é£Ÿäº‹ã®æ§˜å­ï¼ˆæœãƒ»æ˜¼ãƒ»å¤• / æ‘‚å–é‡ãªã©ï¼‰</label>
            <input type="text" id="meal" placeholder="ä¾‹ï¼‰æœï¼šå®Œé£Ÿ / æ˜¼ï¼š7å‰² / å¤•ï¼šå°‘ãªã‚ ãªã©" />
          </div>

          <div class="field">
            <div class="checkbox-row">
              <label><input type="checkbox" id="medTaken" /> æœè–¬æ¸ˆã¿</label>
              <span class="small-text">ï¼ˆé£²ã¿å¿˜ã‚Œç­‰ãŒã‚ã‚Œã°ä¸‹ã®æ”¯æ´å†…å®¹ã«è¨˜å…¥ï¼‰</span>
            </div>
          </div>

          <!-- ã‚¿ã‚° -->
          <div class="field">
            <label>ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ï¼ˆã‚¿ã‚°ï¼‰</label>
            <div class="tag-buttons" id="tagButtons"></div>
            <div class="small-text" id="selectedTagsInfo">é¸æŠä¸­ï¼šãªã—</div>
          </div>

          <!-- â˜…è‡ªå‹•å…¥åŠ›ã—ãŸã„æ”¯æ´é …ç›®ï¼ˆåˆå¿ƒè€…OKï¼‰ -->
          <div class="beginner-zone">
            <div style="display:flex; align-items:center; justify-content:space-between; gap:8px; flex-wrap:wrap;">
              <div style="font-weight:800; color:#166534;">â‘¡ è‡ªå‹•å…¥åŠ›ã—ãŸã„æ”¯æ´é …ç›® <span class="beginner-badge">ã“ã“ã ã‘OK</span></div>
              <div class="small-text">â€»åˆ©ç”¨è€…ã‚’é¸ã¶ã¨ã€Œã‚ˆãä½¿ã†é …ç›®ã€ãŒè‡ªå‹•ã§ONã«ãªã‚Šã¾ã™</div>
            </div>

            <div class="btn-row" style="margin-top:8px;">
              <button type="button" class="btn-secondary" id="openFavModalBtn">ğŸ›  ã‚ˆãä½¿ã†é …ç›®ç·¨é›†ï¼ˆã“ã®åˆ©ç”¨è€…ï¼‰</button>
            </div>

            <div class="checkbox-row" id="autoItemCheckboxes" style="margin-top:8px;"></div>
          </div>

          <!-- æ—¥ä¸­æ”¯æ´åŠ ç®— åŒºåˆ† -->
          <div class="field">
            <label for="daySupportType">æ—¥ä¸­æ”¯æ´åŠ ç®—ã®åŒºåˆ†</label>
            <select id="daySupportType">
              <option value="">é¸æŠãªã—</option>
              <option value="â… ">æ—¥ä¸­æ”¯æ´åŠ ç®—â… </option>
              <option value="â…¡">æ—¥ä¸­æ”¯æ´åŠ ç®—â…¡</option>
            </select>
            <div class="small-text">
              æ—¥ä¸­æ”¯æ´åŠ ç®—ã«è©²å½“ã™ã‚‹å ´åˆã®ã¿ã€â…  / â…¡ ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚ï¼ˆè‡ªå‹•æ–‡ç« ã®ç½®æ›ã«ã‚‚åæ˜ ï¼‰
            </div>
          </div>

          <!-- â˜…æ—¥ä¸­æ”¯æ´ï¼šä¸»ãªæ”¯æ´ï¼ˆåˆå¿ƒè€…OKï¼‰ -->
          <div class="beginner-zone">
            <div style="display:flex; align-items:center; justify-content:space-between; gap:8px; flex-wrap:wrap;">
              <div style="font-weight:800; color:#166534;">â‘¢ã€æ—¥ä¸­ã«è¡Œã£ãŸä¸»ãªæ”¯æ´ã€‘ <span class="beginner-badge">ã“ã“ã ã‘OK</span></div>
              <div class="beginner-hint">â€»è©²å½“ã™ã‚‹ã‚‚ã®ã«ãƒã‚§ãƒƒã‚¯ï¼ˆæ¼ã‚Œé˜²æ­¢ï¼‰</div>
            </div>

            <div class="btn-row" style="margin-top:8px;">
              <button type="button" class="btn-secondary" id="openDaySupportModalBtn">ğŸ›  æ—¥ä¸­æ”¯æ´ãƒã‚§ãƒƒã‚¯ç·¨é›†ï¼ˆåˆ©ç”¨è€…åˆ¥ï¼‰</button>
            </div>

            <div class="checkbox-row" id="daySupportMainCheckboxes" style="margin-top:8px;"></div>
          </div>

          <!-- æ—¥ä¸­æ”¯æ´ï¼šç†ç”±ï¼ˆä»»æ„/ä¸Šç´šï¼‰ -->
          <div class="field">
            <label>ã€æ—¥ä¸­æ´»å‹•ã«è¡Œã‘ãªã‹ã£ãŸç†ç”±ã€‘ï¼ˆä»»æ„ï¼‰</label>
            <div class="small-text" style="margin-bottom:4px;">
              â€»è©²å½“ã™ã‚‹å ´åˆã®ã¿ãƒã‚§ãƒƒã‚¯ã—ã¦ãã ã•ã„ï¼ˆå¿…è¦ãŒã‚ã‚‹ã¨ãã ã‘ï¼‰ã€‚
            </div>
            <div class="checkbox-row" id="daySupportReasonCheckboxes"></div>
          </div>

          <div class="field">
            <label for="daySupportTime">æ—¥ä¸­æ”¯æ´ã®ä¸»ãªæ™‚é–“å¸¯ï¼ˆä»»æ„ï¼‰</label>
            <input type="text" id="daySupportTime" placeholder="ä¾‹ï¼‰9:00ã€œ15:00 ã®é–“ã€å±…å®¤ã¨å…±æœ‰ã‚¹ãƒšãƒ¼ã‚¹ã§ç¶™ç¶šçš„ã«è¦‹å®ˆã‚Šæ”¯æ´" />
          </div>

          <!-- è‡ªä½œãƒ†ãƒ³ãƒ—ãƒ¬ç®¡ç†ï¼ˆå…±é€šï¼‰ -->
          <div class="field">
            <label>æ”¯æ´å†…å®¹ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆï¼ˆè‡ªä½œï¼‰</label>

            <div class="field-row">
              <div class="field">
                <label for="templateScope" class="small-text">ãƒ†ãƒ³ãƒ—ãƒ¬ã®å¯¾è±¡é …ç›®</label>
                <select id="templateScope">
                  <option value="common">å…±é€šï¼ˆã©ã®é …ç›®ã§ã‚‚ï¼‰</option>
                  <option value="med_manage">æœè–¬ç®¡ç†</option>
                  <option value="oral_check">å†…æœç¢ºèª</option>
                  <option value="bathing">å…¥æµ´</option>
                  <option value="day_support">æ—¥ä¸­æ”¯æ´åŠ ç®—</option>
                </select>
                <div class="small-text">å¯¾è±¡ã‚’é¸ã¶ã¨ã€ãã®é …ç›®ç”¨ã®ãƒ†ãƒ³ãƒ—ãƒ¬ä¸€è¦§ãŒä¸‹ã«è¡¨ç¤ºã•ã‚Œã¾ã™ã€‚</div>
              </div>
              <div class="field">
                <label for="templateNameInput" class="small-text">ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆå</label>
                <input type="text" id="templateNameInput" placeholder="ä¾‹ï¼šæœè–¬ç®¡ç†ãƒ»å®‰å®šãƒ‘ã‚¿ãƒ¼ãƒ³" />
                <div class="small-text">ä»Šã®ã€Œæœ¬æ—¥ã®æ”¯æ´å†…å®¹ãƒ»æ§˜å­ã€ã‚’ã€ã“ã®åå‰ãƒ»å¯¾è±¡é …ç›®ã®ãƒ†ãƒ³ãƒ—ãƒ¬ã¨ã—ã¦ä¿å­˜ã—ã¾ã™ã€‚</div>
              </div>
            </div>

            <div class="field" style="margin-top:8px;">
              <select id="templateSelect"><option value="">é¸æŠã—ã¦ãã ã•ã„</option></select>
              <div class="small-text">
                ãƒ»ã€Œãƒ†ãƒ³ãƒ—ãƒ¬æŒ¿å…¥ã€ï¼šé¸ã‚“ã ãƒ†ãƒ³ãƒ—ãƒ¬ã ã‘ã‚’è¿½è¨˜ã—ã¾ã™ã€‚<br>
                ãƒ»ã€Œâœ¨ è‡ªå‹•ã€ï¼šåˆ©ç”¨è€…åˆ¥ãƒ†ãƒ³ãƒ—ãƒ¬ï¼ˆã‚ã‚Œã°ï¼‰ï¼‹é¸ã‚“ã ãƒ†ãƒ³ãƒ—ãƒ¬ï¼ˆã‚ã‚Œã°ï¼‰ï¼‹ãƒã‚§ãƒƒã‚¯é …ç›®ï¼ˆã‚ã‚Œã°ï¼‰ã‚’ã¾ã¨ã‚ã¦è¿½è¨˜ã—ã¾ã™ã€‚<br>
                â€»ã©ã‚Œã‚‚ã€Œä¸‹ã«è¿½è¨˜ã€ãªã®ã§ã€æ—¢å­˜ã®æ–‡ç« ã¯æ¶ˆãˆã¾ã›ã‚“ã€‚
              </div>
            </div>

            <div class="btn-row">
              <button type="button" class="btn-secondary" id="templateApplyButton">ãƒ†ãƒ³ãƒ—ãƒ¬æŒ¿å…¥</button>
              <button type="button" class="btn-primary" id="templateSaveButton">ãƒ†ãƒ³ãƒ—ãƒ¬ä¿å­˜ / ä¸Šæ›¸ã</button>
              <button type="button" class="btn-danger" id="templateDeleteButton">é¸æŠãƒ†ãƒ³ãƒ—ãƒ¬å‰Šé™¤</button>
            </div>

            <div class="small-text">
              â€»ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã¯ã“ã®ãƒ‘ã‚½ã‚³ãƒ³ã®ãƒ–ãƒ©ã‚¦ã‚¶ã«ä¿å­˜ã•ã‚Œã¾ã™ã€‚ä»–ã®PCã¨ã¯å…±æœ‰ã•ã‚Œã¾ã›ã‚“ã€‚
            </div>

            <!-- âœ… è‡ªå‹•ãƒ†ãƒ³ãƒ—ãƒ¬ï¼ˆåˆ©ç”¨è€…åˆ¥ï¼‰ -->
            <div class="field" style="margin-top:10px;">
              <label for="residentTemplateSelect">è‡ªå‹•ãƒ†ãƒ³ãƒ—ãƒ¬ï¼ˆåˆ©ç”¨è€…åˆ¥ï¼‰</label>
              <div class="field-row" style="align-items:end;">
                <div class="field" style="margin-bottom:0;">
                  <select id="residentTemplateSelect">
                    <option value="">ï¼ˆãªã—ï¼‰</option>
                  </select>
                </div>
                <div class="field" style="margin-bottom:0;">
                  <button type="button" class="btn-secondary" id="openResidentTemplateModalBtn">ğŸ›  è‡ªå‹•ãƒ†ãƒ³ãƒ—ãƒ¬ç·¨é›†ï¼ˆåˆ©ç”¨è€…åˆ¥ï¼‰</button>
                </div>
              </div>
              <div class="small-text">â€»åˆ©ç”¨è€…ã”ã¨ã®ã€Œè‡ªå‹•æ–‡ç« ã€ã‚’ç®¡ç†ã§ãã¾ã™ã€‚</div>
            </div>

          </div>

          <div class="field">
            <label for="support">æœ¬æ—¥ã®æ”¯æ´å†…å®¹ãƒ»æ§˜å­</label>
            <textarea id="support" rows="8" placeholder="ã€æ¨™æº–ã®æ›¸ãæ–¹ä¾‹ã€‘
æ—¥ä¸­ã¯è½ã¡ç€ã„ã¦ç©ã‚„ã‹ã«éã”ã•ã‚Œã‚‹ã€‚é£Ÿäº‹ãƒ»æœè–¬ã¨ã‚‚ã«è¦‹å®ˆã‚Šä¸­å¿ƒã§å®Ÿæ–½ã€‚
å¿…è¦æ™‚ã®ã¿å£°ã‹ã‘ãƒ»ä»‹åŠ©ã‚’è¡Œã£ãŸã€‚"></textarea>
          </div>

          <!-- â˜…è‡ªå‹•ãƒœã‚¿ãƒ³ï¼ˆåˆå¿ƒè€…OKï¼‰ -->
          <div class="beginner-zone">
            <div style="display:flex; align-items:center; justify-content:space-between; gap:8px; flex-wrap:wrap;">
              <div style="font-weight:800; color:#166534;">â‘£ è‡ªå‹•ï¼ˆæ–‡ç« ã‚’è¿½è¨˜ï¼‰ <span class="beginner-badge">ã“ã“ã ã‘OK</span></div>
              <div class="beginner-hint">â€»æ–‡ç« ã¯ã€Œæ¶ˆãˆãšã«ä¸‹ã«è¿½è¨˜ã€ã•ã‚Œã¾ã™</div>
            </div>

            <div class="btn-row" style="margin-top:10px;">
              <button type="button" class="btn-beginner" id="autoSupportBtn">âœ¨ è‡ªå‹•</button>
              <button type="button" class="btn-secondary" id="voiceSupportBtn">ğŸ™ éŸ³å£°å…¥åŠ›</button>
              <span class="small-text">
                ãƒ»åˆ©ç”¨è€…åˆ¥ãƒ†ãƒ³ãƒ—ãƒ¬ï¼ˆé¸æŠï¼‰ â†’ è¿½è¨˜<br>
                ãƒ»å…±é€šãƒ†ãƒ³ãƒ—ãƒ¬ï¼ˆé¸æŠï¼‰ â†’ è¿½è¨˜<br>
                ãƒ»ãƒã‚§ãƒƒã‚¯ã—ãŸé …ç›® â†’ è¿½è¨˜<br>
              </span>
            </div>
            <div class="small-text" id="voiceStatus" style="margin-top:4px;"></div>
          </div>

          <div class="field">
            <label for="note">ç‰¹è¨˜äº‹é …ï¼ˆäº‹æ•…ãƒ»ãƒˆãƒ©ãƒ–ãƒ«ãƒ»å—è¨ºãƒ»ç›¸è«‡ãªã©ï¼‰</label>
            <textarea id="note" rows="4" placeholder="ä¾‹ï¼‰é€šé™¢ã€å®¶æ—ã‹ã‚‰ã®é›»è©±ã€å¤œé–“ã®è¦‹å®ˆã‚Šå¼·åŒ–ãŒå¿…è¦ ãªã©"></textarea>
          </div>

          <!-- â˜…ä¿å­˜ï¼ˆåˆå¿ƒè€…OKï¼‰ -->
          <div class="beginner-zone">
            <div style="display:flex; align-items:center; justify-content:space-between; gap:8px; flex-wrap:wrap;">
              <div style="font-weight:800; color:#166534;">â‘¤ è¨˜éŒ²ã‚’ä¿å­˜ <span class="beginner-badge">ã“ã“ã ã‘OK</span></div>
              <div class="beginner-hint">â€»çµ‚ã‚ã£ãŸã‚‰ä¿å­˜ã€‚</div>
            </div>

            <div class="btn-row" style="margin-top:10px;">
              <button type="submit" class="btn-beginner" id="saveButton">ğŸ’¾ è¨˜éŒ²ã‚’ä¿å­˜</button>
              <button type="button" class="btn-secondary" id="resetButton">ğŸ§¹ å…¥åŠ›ãƒªã‚»ãƒƒãƒˆ</button>
            </div>
          </div>

        </form>
      </section>

      <!-- ä¸€è¦§è¡¨ç¤º -->
      <section class="card">
        <div class="card-title">
          <span>è¨˜éŒ²ä¸€è¦§</span>
          <div style="display:flex; align-items:center; gap:8px; flex-wrap:wrap;">
  <button type="button"
          onclick="window.open('records.html', '_blank')"
          class="btn-secondary"
          style="font-size:12px; padding:6px 10px;">
    ğŸ“„ åˆ¥ãƒšãƒ¼ã‚¸ã§é–‹ã
  </button>

  <button type="button" class="btn-secondary" id="backupBtn"
          style="font-size:12px; padding:6px 10px;">
    ğŸ§· ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—
  </button>

  <button type="button" class="btn-secondary" id="restoreBtn" title="ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—JSONã‹ã‚‰å¾©å…ƒ">å¾©å…ƒ</button>
            <button type="button" class="btn-secondary" id="exportExcelBtn"
          style="font-size:12px; padding:6px 10px;">
    â¬‡ Excelå‡ºåŠ›
  </button>
            <input id="restoreFileInput" type="file" accept="application/json" style="display:none" />

  <span class="record-count" id="recordCount">0ä»¶</span>
</div>


        <div class="resident-select-row">
          <span>è¡¨ç¤ºã™ã‚‹åˆ©ç”¨è€…ï¼š</span>
          <select id="filterResident"></select>
          <span class="small-text">â€»ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã‚’å¤‰ãˆã‚‹ã¨ã€ãã®åˆ©ç”¨è€…ã®è¨˜éŒ²ã ã‘è¡¨ç¤ºã•ã‚Œã¾ã™ã€‚</span>
        </div>

        <div class="resident-select-row">
          <span>æœŸé–“ï¼š</span>
          <select id="periodFilter">
            <option value="today">ä»Šæ—¥</option>
            <option value="week">ç›´è¿‘7æ—¥é–“</option>
            <option value="month" selected>ä»Šæœˆ</option>
            <option value="year">ä»Šå¹´</option>
            <option value="all">å…¨æœŸé–“</option>
            <option value="custom">æ—¥ä»˜æŒ‡å®š</option>
          </select>
          <span class="small-text">â€»å…¨æœŸé–“ã¯ä»¶æ•°ãŒå¤šããªã‚‹å ´åˆãŒã‚ã‚Šã¾ã™ã€‚</span>
        </div>

        <div class="resident-select-row" id="customPeriodRow" style="display:none;">
          <span>æœŸé–“æŒ‡å®šï¼š</span>
          <input type="date" id="periodFrom">
          <span>ã€œ</span>
          <input type="date" id="periodTo">
          <button type="button" class="btn-secondary" id="applyCustomPeriod">åæ˜ </button>
        </div>

        <div class="resident-select-row">
          <span>ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰æ¤œç´¢ï¼š</span>
          <input type="text" id="searchKeyword" placeholder="ä¾‹ï¼šé€šé™¢, å¤œé–“, #ä½“èª¿ä¸è‰¯ ãªã©" style="flex:1; min-width:180px;" />
          <button type="button" class="btn-secondary" id="searchClearButton">ã‚¯ãƒªã‚¢</button>
        </div>

        <div class="table-wrapper" id="tableWrapper">
          <table>
            <thead>
  <tr>
    <th>æ—¥ä»˜</th>
    <th>åˆ©ç”¨è€…</th>
    <th>æ—¥ä¸­ã®ä¸»ãªæ”¯æ´</th>
    <th>æ”¯æ´å†…å®¹ãƒ»ã‚¿ã‚°</th>
    <th>æœè–¬</th>
    <th>æ“ä½œ</th>
  </tr>
</thead>
            <tbody id="recordTableBody"></tbody>
          </table>
        </div>
      </section>
    </div>

    <!-- ====== ã“ã“ã‹ã‚‰ä¸‹ï¼šç®¡ç†ã‚¨ãƒªã‚¢ï¼ˆåˆå¿ƒè€…ã¯åŸºæœ¬è§¦ã‚‰ãªã„ï¼‰ ====== -->

    <!-- åˆ©ç”¨è€…ç®¡ç† -->
    <section class="card admin-card">
      <div class="card-title">
        <span>åˆ©ç”¨è€…ç®¡ç†</span>
        <span class="admin-pill">ç®¡ç†ï¼ˆæ…£ã‚ŒãŸäººå‘ã‘ï¼‰</span>
        <span class="record-count" id="residentCount">0å</span>
      </div>
      <div class="card-subtitle">
        åˆ©ç”¨è€…åã®è¿½åŠ ãƒ»å¤‰æ›´ãƒ»å‰Šé™¤ã‚’è¡Œã„ã¾ã™ã€‚ã“ã“ã§å¤‰æ›´ã™ã‚‹ã¨ã€è¨˜éŒ²ä¸€è¦§ã®è¡¨ç¤ºã«ã‚‚åæ˜ ã•ã‚Œã¾ã™ã€‚
      </div>

      <div class="field-row">
        <div class="field">
          <label for="residentManageSelect">å¯¾è±¡ã®åˆ©ç”¨è€…</label>
          <select id="residentManageSelect"></select>
        </div>
        <div class="field">
          <label for="residentNameInput">åå‰ï¼ˆè¿½åŠ ãƒ»å¤‰æ›´å¾Œï¼‰</label>
          <input type="text" id="residentNameInput" placeholder="ä¾‹ï¼šAã•ã‚“" />
        </div>
      </div>

      <div class="btn-row">
        <button type="button" class="btn-primary" id="residentAddButton">ï¼‹ æ–°ã—ãè¿½åŠ </button>
        <button type="button" class="btn-secondary" id="residentRenameButton">âœï¸ é¸æŠã‚’ã“ã®åå‰ã«å¤‰æ›´</button>
        <button type="button" class="btn-danger" id="residentDeleteButton">ğŸ—‘ï¸ åˆ©ç”¨è€…ã¨è¨˜éŒ²ã‚’å‰Šé™¤</button>
      </div>

      <div class="admin-note">â€»å‰Šé™¤ã™ã‚‹ã¨ã€ãã®åˆ©ç”¨è€…ã®ã™ã¹ã¦ã®è¨˜éŒ²ã‚‚å‰Šé™¤ã•ã‚Œã¾ã™ã€‚</div>
    </section>

    <!-- è‡ªå‹•å…¥åŠ›é …ç›® ç®¡ç† -->
    <section class="card admin-card">
      <div class="card-title">
        <span>è‡ªå‹•å…¥åŠ›ã®æ”¯æ´é …ç›® ç®¡ç†ï¼ˆã‚µã‚¤ãƒˆä¸Šã§è¿½åŠ ãƒ»ç·¨é›†ãƒ»å‰Šé™¤ï¼‰</span>
        <span class="admin-pill">ç®¡ç†ï¼ˆæ…£ã‚ŒãŸäººå‘ã‘ï¼‰</span>
        <span class="record-count" id="autoItemCount">0ä»¶</span>
      </div>
      <div class="card-subtitle">
        ã“ã“ã§è¿½åŠ ã—ãŸé …ç›®ã¯ã€ä¸Šã®ã€Œè‡ªå‹•å…¥åŠ›ã—ãŸã„æ”¯æ´é …ç›®ã€ã«è‡ªå‹•ã§è¡¨ç¤ºã•ã‚Œã¾ã™ã€‚<br>
        â€»ã“ã®PCï¼ˆãƒ–ãƒ©ã‚¦ã‚¶ï¼‰å†…ã«ä¿å­˜ã•ã‚Œã¾ã™ã€‚ä»–PCã¨ã¯å…±æœ‰ã•ã‚Œã¾ã›ã‚“ã€‚
      </div>

      <div class="field-row">
        <div class="field">
          <label for="autoItemSelect">æ—¢å­˜é …ç›®ï¼ˆç·¨é›†ã—ãŸã„å ´åˆã«é¸æŠï¼‰</label>
          <select id="autoItemSelect">
            <option value="">ï¼ˆæ–°è¦è¿½åŠ ï¼‰</option>
          </select>
          <div class="small-text">é¸ã¶ã¨ä¸‹ã®å…¥åŠ›æ¬„ã«å†…å®¹ãŒå…¥ã‚Šã¾ã™ã€‚</div>
        </div>
        <div class="field">
          <label for="autoItemKey">å†…éƒ¨ã‚­ãƒ¼ï¼ˆè‹±æ•°å­—ãƒ»é‡è¤‡ä¸å¯ï¼‰</label>
          <input type="text" id="autoItemKey" placeholder="ä¾‹ï¼šmoney_support" />
          <div class="small-text">â€»æœ€åˆã«æ±ºã‚ãŸã‚‰ã€åŸºæœ¬å¤‰æ›´ã—ãªã„ã®ãŒå®‰å…¨ã§ã™ã€‚</div>
        </div>
      </div>

      <div class="field-row">
        <div class="field">
          <label for="autoItemLabel">è¡¨ç¤ºå</label>
          <input type="text" id="autoItemLabel" placeholder="ä¾‹ï¼šé‡‘éŠ­ç®¡ç†" />
        </div>
        <div class="field">
          <label for="autoItemText">è‡ªå‹•ã§è¿½è¨˜ã™ã‚‹å®šå‹æ–‡</label>
          <textarea id="autoItemText" rows="3" placeholder="ä¾‹ï¼šã€é‡‘éŠ­ç®¡ç†ã€‘é‡‘éŠ­ã®ç¢ºèªã¨å£°ã‹ã‘ã‚’è¡Œã„ã€å¿…è¦ã«å¿œã˜ã¦æ”¯æ´ã—ãŸã€‚"></textarea>
          <div class="small-text">
            æ—¥ä¸­æ”¯æ´åŠ ç®—ã®åŒºåˆ†ã‚’å…¥ã‚ŒãŸã„å ´åˆï¼š<br>
            <b>{{daySupportTypeLabel}}</b> ã‚’æ–‡ä¸­ã«å…¥ã‚Œã‚‹ã¨ã€Œæ—¥ä¸­æ”¯æ´åŠ ç®—â… /â…¡ã€ã«ç½®æ›ã•ã‚Œã¾ã™ã€‚
          </div>
        </div>
      </div>

      <div class="btn-row">
        <button type="button" class="btn-primary" id="autoItemSaveBtn">ğŸ’¾ è¿½åŠ  / æ›´æ–°</button>
        <button type="button" class="btn-danger" id="autoItemDeleteBtn">ğŸ—‘ï¸ é¸æŠé …ç›®ã‚’å‰Šé™¤</button>
        <button type="button" class="btn-secondary" id="autoItemClearBtn">ğŸ§¹ å…¥åŠ›ã‚¯ãƒªã‚¢</button>
        <button type="button" class="btn-secondary" id="autoItemResetDefaultBtn">â†© åˆæœŸé …ç›®ã«æˆ»ã™</button>
      </div>

      <div class="admin-note">â€»åˆå¿ƒè€…ã¯åŸºæœ¬ã“ã“ã‚’è§¦ã‚‰ãªãã¦OKã§ã™ã€‚</div>
    </section>

    <!-- âœ… ã‚ˆãä½¿ã†é …ç›® ç®¡ç†ï¼ˆåˆ©ç”¨è€…åˆ¥ï¼‰ -->
    <section class="card admin-card">
      <div class="card-title">
        <span>ã‚ˆãä½¿ã†é …ç›® ç®¡ç†ï¼ˆåˆ©ç”¨è€…åˆ¥ï¼‰</span>
        <span class="admin-pill">ç®¡ç†ï¼ˆæ…£ã‚ŒãŸäººå‘ã‘ï¼‰</span>
      </div>
      <div class="card-subtitle">
        åˆ©ç”¨è€…ã”ã¨ã«ã€Œè‡ªå‹•å…¥åŠ›ã—ãŸã„æ”¯æ´é …ç›®ã€ã¨ã€Œæ—¥ä¸­ã«è¡Œã£ãŸä¸»ãªæ”¯æ´ã€ã®åˆæœŸãƒã‚§ãƒƒã‚¯ã‚’ä¿å­˜ã§ãã¾ã™ï¼ˆåˆ©ç”¨è€…ã‚’é¸ã¶ã¨è‡ªå‹•ã§ONã«ãªã‚Šã¾ã™ï¼‰ã€‚
      </div>

      <div class="field">
        <label for="favResidentSelect">å¯¾è±¡ã®åˆ©ç”¨è€…</label>
        <select id="favResidentSelect"></select>
      </div>

      <div class="field">
        <label>ã‚ˆãä½¿ã†é …ç›®ï¼ˆè‡ªå‹•å…¥åŠ›ï¼‰</label>
        <div class="checkbox-row" id="favAutoItemCheckboxes"></div>
      </div>

      <div class="field" style="margin-top:10px;">
        <label>æ—¥ä¸­ã«è¡Œã£ãŸä¸»ãªæ”¯æ´ï¼ˆã‚ˆãä½¿ã†ï¼‰</label>
        <div class="checkbox-row" id="favDaySupportMainCheckboxes"></div>
        <div class="small-text">â€»ã“ã®åˆ©ç”¨è€…ã‚’é¸ã¶ã¨ã€ãƒ•ã‚©ãƒ¼ãƒ ã®ã€æ—¥ä¸­ã«è¡Œã£ãŸä¸»ãªæ”¯æ´ã€‘ã‚‚è‡ªå‹•ã§ONã«ãªã‚Šã¾ã™ã€‚</div>
      </div>

      <div class="btn-row">
        <button type="button" class="btn-primary" id="favSaveBtn">ğŸ’¾ ä¿å­˜</button>
        <button type="button" class="btn-secondary" id="favApplyNowBtn">â†ª ä»Šã™ããƒ•ã‚©ãƒ¼ãƒ ã¸åæ˜ </button>
        <button type="button" class="btn-secondary" id="favClearBtn">ğŸ§¹ å…¨è§£é™¤</button>
      </div>
    </section>

    <!-- âœ… è‡ªå‹•ãƒ†ãƒ³ãƒ—ãƒ¬ç·¨é›†ï¼ˆåˆ©ç”¨è€…åˆ¥ï¼‰ -->
    <section class="card admin-card">
      <div class="card-title">
        <span>è‡ªå‹•ãƒ†ãƒ³ãƒ—ãƒ¬ç·¨é›†ï¼ˆåˆ©ç”¨è€…åˆ¥ï¼‰</span>
        <span class="admin-pill">ç®¡ç†ï¼ˆæ…£ã‚ŒãŸäººå‘ã‘ï¼‰</span>
      </div>
      <div class="card-subtitle">
        åˆ©ç”¨è€…ã”ã¨ã®ã€Œè‡ªå‹•ãƒ†ãƒ³ãƒ—ãƒ¬ã€ã‚’ç®¡ç†ã—ã¾ã™ï¼ˆãƒ•ã‚©ãƒ¼ãƒ ã®ã€Œè‡ªå‹•ãƒ†ãƒ³ãƒ—ãƒ¬ï¼ˆåˆ©ç”¨è€…åˆ¥ï¼‰ã€ã«åæ˜ ã•ã‚Œã¾ã™ï¼‰ã€‚
      </div>

      <div class="field-row">
        <div class="field">
          <label for="rtResidentSelect">å¯¾è±¡ã®åˆ©ç”¨è€…</label>
          <select id="rtResidentSelect"></select>
        </div>
        <div class="field">
          <label for="rtTemplateSelect">æ—¢å­˜ãƒ†ãƒ³ãƒ—ãƒ¬</label>
          <select id="rtTemplateSelect">
            <option value="">ï¼ˆæ–°è¦ä½œæˆï¼‰</option>
          </select>
          <div class="small-text" id="rtDefaultInfo">æ—¢å®šï¼šãªã—</div>
        </div>
      </div>

      <div class="field-row">
        <div class="field">
          <label for="rtTemplateName">ãƒ†ãƒ³ãƒ—ãƒ¬å</label>
          <input type="text" id="rtTemplateName" placeholder="ä¾‹ï¼šæ—¥ä¸­ãƒ»æ¨™æº–" />
        </div>
        <div class="field">
          <label for="rtTemplateText">ãƒ†ãƒ³ãƒ—ãƒ¬æœ¬æ–‡ï¼ˆè‡ªå‹•ã§è¿½è¨˜ï¼‰</label>
          <textarea id="rtTemplateText" rows="5" placeholder="ä¾‹ï¼‰æ—¥ä¸­ã¯è½ã¡ç€ã„ã¦éã”ã•ã‚Œã‚‹ã€‚å¿…è¦æ™‚ã«å£°ã‹ã‘ãƒ»è¦‹å®ˆã‚Šã‚’è¡Œã£ãŸã€‚"></textarea>
        </div>
      </div>

      <div class="btn-row">
        <button type="button" class="btn-primary" id="rtSaveBtn">ğŸ’¾ è¿½åŠ  / æ›´æ–°</button>
        <button type="button" class="btn-secondary" id="rtSetDefaultBtn">â­ æ—¢å®šã«ã™ã‚‹</button>
        <button type="button" class="btn-danger" id="rtDeleteBtn">ğŸ—‘ï¸ å‰Šé™¤</button>
        <button type="button" class="btn-secondary" id="rtClearBtn">ğŸ§¹ æ–°è¦å…¥åŠ›ã«æˆ»ã™</button>
      </div>
    </section>

    <!-- âœ… ğŸ›  æ—¥ä¸­æ”¯æ´ãƒã‚§ãƒƒã‚¯ç·¨é›†ï¼ˆåˆ©ç”¨è€…åˆ¥ï¼‰ -->
    <section class="card admin-card">
      <div class="card-title">
        <span>ğŸ›  æ—¥ä¸­æ”¯æ´ãƒã‚§ãƒƒã‚¯ç·¨é›†ï¼ˆåˆ©ç”¨è€…åˆ¥ï¼‰</span>
        <span class="admin-pill">ç®¡ç†ï¼ˆæ…£ã‚ŒãŸäººå‘ã‘ï¼‰</span>
      </div>
      <div class="card-subtitle">
        åˆ©ç”¨è€…ã”ã¨ã«ã€Œä¸»ãªæ”¯æ´ã€ã€Œæ¬ å¸­ç†ç”±ã€ã®ãƒã‚§ãƒƒã‚¯é …ç›®ãƒªã‚¹ãƒˆã‚’ç·¨é›†ã§ãã¾ã™ï¼ˆ1è¡Œ=1é …ç›®ï¼‰ã€‚
      </div>

      <div class="field">
        <label for="dsResidentSelect">å¯¾è±¡ã®åˆ©ç”¨è€…</label>
        <select id="dsResidentSelect"></select>
      </div>

      <div class="field-row">
        <div class="field">
          <label for="dsMainList">ä¸»ãªæ”¯æ´ï¼ˆ1è¡Œ=1é …ç›®ï¼‰</label>
          <textarea id="dsMainList" rows="8"></textarea>
        </div>
        <div class="field">
          <label for="dsReasonList">æ¬ å¸­ç†ç”±ï¼ˆ1è¡Œ=1é …ç›®ï¼‰</label>
          <textarea id="dsReasonList" rows="8"></textarea>
        </div>
      </div>

      <div class="btn-row">
        <button type="button" class="btn-primary" id="dsSaveBtn">ğŸ’¾ ä¿å­˜</button>
        <button type="button" class="btn-secondary" id="dsResetBtn">â†© åˆæœŸã«æˆ»ã™</button>
      </div>

      <div class="admin-note">â€»åˆå¿ƒè€…ã¯åŸºæœ¬ã“ã“ã‚’è§¦ã‚‰ãªãã¦OKã§ã™ã€‚</div>
    </section>

    <!-- â˜…ã‚¿ã‚°ç®¡ç†ï¼ˆè¿½åŠ ãƒ»ç·¨é›†ãƒ»å‰Šé™¤ï¼‰ -->
    <section class="card admin-card">
      <div class="card-title">
        <span>ã‚¿ã‚° ç®¡ç†ï¼ˆè¿½åŠ ãƒ»ç·¨é›†ãƒ»å‰Šé™¤ï¼‰</span>
        <span class="admin-pill">ç®¡ç†ï¼ˆæ…£ã‚ŒãŸäººå‘ã‘ï¼‰</span>
        <span class="record-count" id="tagCount">0ä»¶</span>
      </div>
      <div class="card-subtitle">
        ã“ã“ã§ä½œã£ãŸã‚¿ã‚°ã¯ã€ä¸Šã®ã€Œã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ï¼ˆã‚¿ã‚°ï¼‰ã€ã®ãƒœã‚¿ãƒ³ã«åæ˜ ã•ã‚Œã¾ã™ã€‚<br>
        â€»ã“ã®PCï¼ˆãƒ–ãƒ©ã‚¦ã‚¶ï¼‰å†…ã«ä¿å­˜ã•ã‚Œã¾ã™ã€‚ä»–PCã¨ã¯å…±æœ‰ã•ã‚Œã¾ã›ã‚“ã€‚
      </div>

      <div class="field-row">
        <div class="field">
          <label for="tagSelect">æ—¢å­˜ã‚¿ã‚°ï¼ˆç·¨é›†ã—ãŸã„å ´åˆã«é¸æŠï¼‰</label>
          <select id="tagSelect">
            <option value="">ï¼ˆæ–°è¦è¿½åŠ ï¼‰</option>
          </select>
          <div class="small-text">é¸ã¶ã¨å³ã®å…¥åŠ›æ¬„ã«å…¥ã‚Šã¾ã™ã€‚</div>
        </div>
        <div class="field">
          <label for="tagNameInput">ã‚¿ã‚°åï¼ˆ#ã¯ä¸è¦ï¼‰</label>
          <input type="text" id="tagNameInput" placeholder="ä¾‹ï¼šé€šé™¢ / å¤œé–“å¯¾å¿œ / ä½“èª¿ä¸è‰¯ ãªã©" />
          <div class="small-text">â€»ã€Œ#ã€ã¯è‡ªå‹•ã§ä»˜ãã®ã§å…¥åŠ›ä¸è¦ã§ã™ã€‚</div>
        </div>
      </div>

      <div class="btn-row">
        <button type="button" class="btn-primary" id="tagSaveBtn">ğŸ’¾ è¿½åŠ  / æ›´æ–°</button>
        <button type="button" class="btn-danger" id="tagDeleteBtn">ğŸ—‘ï¸ é¸æŠã‚¿ã‚°ã‚’å‰Šé™¤</button>
        <button type="button" class="btn-secondary" id="tagClearBtn">ğŸ§¹ å…¥åŠ›ã‚¯ãƒªã‚¢</button>
        <button type="button" class="btn-secondary" id="tagResetDefaultBtn">â†© åˆæœŸã‚¿ã‚°ã«æˆ»ã™</button>
      </div>

      <div class="admin-note">â€»åˆå¿ƒè€…ã¯åŸºæœ¬ã“ã“ã‚’è§¦ã‚‰ãªãã¦OKã§ã™ã€‚</div>
    </section>

  </main>

  <!-- è¨˜éŒ²ã®è©³ç´°ãƒ¢ãƒ¼ãƒ€ãƒ« -->
  <div id="detailModal" class="detail-modal-backdrop">
    <div class="detail-modal">
      <div class="detail-modal-header">
        <div class="detail-modal-title" id="detailModalTitle">è¨˜éŒ²ã®è©³ç´°</div>
        <button type="button" class="detail-modal-close" id="detailModalClose">Ã—</button>
      </div>
      <div class="detail-modal-body" id="detailModalContent"></div>
    </div>
  </div>

  <!-- è¨˜éŒ²ã®ç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ«ï¼ˆå°çª“ï¼‰ -->
  <div id="editModal" class="detail-modal-backdrop">
    <div class="detail-modal">
      <div class="detail-modal-header">
        <div class="detail-modal-title" id="editModalTitle">è¨˜éŒ²ã®ç·¨é›†</div>
        <button type="button" class="detail-modal-close" id="editModalClose">Ã—</button>
      </div>

      <div class="detail-modal-body">
        <div class="field-row">
          <div class="field">
            <label for="editDate">æ—¥ä»˜</label>
            <input type="date" id="editDate" />
          </div>
          <div class="field">
            <label for="editResident">åˆ©ç”¨è€…</label>
            <select id="editResident"></select>
          </div>
        </div>

        <div class="field-row-3">
          <div class="field">
            <label for="editTimeSlot">æ™‚é–“å¸¯</label>
            <select id="editTimeSlot">
              <option>æ—¥ä¸­</option>
              <option>å¤•æ–¹</option>
              <option>å¤œé–“</option>
            </select>
          </div>

          <div class="field">
            <label for="editCondition">ä½“èª¿</label>
            <select id="editCondition">
              <option>è‰¯å¥½</option>
              <option>æ™®é€š</option>
              <option>ä¸è‰¯</option>
            </select>
          </div>

          <div class="field">
            <label for="editMental">å¿ƒã®çŠ¶æ…‹</label>
            <select id="editMental">
              <option>å®‰å®š</option>
              <option>ã‚„ã‚„ä¸å®‰</option>
              <option>ä¸å®‰å®š</option>
            </select>
          </div>
        </div>

        <div class="field">
          <label for="editMeal">é£Ÿäº‹ã®æ§˜å­</label>
          <input type="text" id="editMeal" placeholder="ä¾‹ï¼‰æœï¼šå®Œé£Ÿ / æ˜¼ï¼š7å‰² ãªã©" />
        </div>

        <div class="field">
          <div class="checkbox-row">
            <label><input type="checkbox" id="editMedTaken" /> æœè–¬æ¸ˆã¿</label>
          </div>
        </div>

        <div class="field">
          <label>ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ï¼ˆã‚¿ã‚°ï¼‰</label>
          <div class="tag-buttons" id="editTagButtons"></div>
          <div class="small-text" id="editSelectedTagsInfo">é¸æŠä¸­ï¼šãªã—</div>
        </div>

        <div class="field">
          <label for="editDaySupportType">æ—¥ä¸­æ”¯æ´åŠ ç®—ã®åŒºåˆ†</label>
          <select id="editDaySupportType">
            <option value="">é¸æŠãªã—</option>
            <option value="â… ">æ—¥ä¸­æ”¯æ´åŠ ç®—â… </option>
            <option value="â…¡">æ—¥ä¸­æ”¯æ´åŠ ç®—â…¡</option>
          </select>
        </div>

        <div class="field">
          <label for="editDaySupportTime">æ—¥ä¸­æ”¯æ´ã®ä¸»ãªæ™‚é–“å¸¯ï¼ˆä»»æ„ï¼‰</label>
          <input type="text" id="editDaySupportTime" placeholder="ä¾‹ï¼‰9:00ã€œ15:00 ã®é–“ã€è¦‹å®ˆã‚Šæ”¯æ´" />
        </div>

        <div class="field">
          <label>ã€æ—¥ä¸­ã«è¡Œã£ãŸä¸»ãªæ”¯æ´ã€‘</label>
          <div class="checkbox-row" id="editDaySupportMainCheckboxes"></div>
        </div>

        <div class="field">
          <label>ã€æ—¥ä¸­æ´»å‹•ã«è¡Œã‘ãªã‹ã£ãŸç†ç”±ã€‘ï¼ˆä»»æ„ï¼‰</label>
          <div class="checkbox-row" id="editDaySupportReasonCheckboxes"></div>
        </div>

        <div class="field">
          <label for="editSupport">æœ¬æ—¥ã®æ”¯æ´å†…å®¹ãƒ»æ§˜å­</label>
          <textarea id="editSupport" rows="8"></textarea>
        </div>

        <div class="field">
          <label for="editNote">ç‰¹è¨˜äº‹é …</label>
          <textarea id="editNote" rows="4"></textarea>
        </div>

        <div class="btn-row" style="margin-top:10px;">
          <button type="button" class="btn-primary" id="editModalSaveBtn">ğŸ’¾ ä¸Šæ›¸ãä¿å­˜</button>
          <button type="button" class="btn-secondary" id="editModalCancelBtn">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
        </div>

        <div class="small-text" style="margin-top:6px;">
          â€»ã“ã“ã§ä¿å­˜ã™ã‚‹ã¨ä¸€è¦§ãŒæ›´æ–°ã•ã‚Œã¾ã™ï¼ˆå·¦ã®ãƒ•ã‚©ãƒ¼ãƒ ã¯è§¦ã‚‰ãªãã¦OKï¼‰
        </div>
      </div>
    </div>
  </div>

  <!-- âœ… ã‚ˆãä½¿ã†é …ç›®ï¼ˆã“ã®åˆ©ç”¨è€…ï¼‰ç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ«ï¼šâ€»é‡è¤‡ã‚’å»ƒæ­¢ã—ã¦1ã¤ã«çµ±ä¸€ -->
  <div id="favModal" class="detail-modal-backdrop">
    <div class="detail-modal">
      <div class="detail-modal-header">
        <div class="detail-modal-title" id="favModalTitle">ã‚ˆãä½¿ã†é …ç›®ï¼ˆã“ã®åˆ©ç”¨è€…ï¼‰</div>
        <button type="button" class="detail-modal-close" id="favModalClose">Ã—</button>
      </div>
      <div class="detail-modal-body">
        <div class="small-text" style="margin-bottom:8px;">
          â€»åˆ©ç”¨è€…ã‚’é¸ã‚“ã æ™‚ã«è‡ªå‹•ã§ONã«ãªã‚‹ãƒã‚§ãƒƒã‚¯ã‚’ã“ã“ã§ä¿å­˜ã§ãã¾ã™ã€‚
        </div>

        <div class="field">
          <label>ã‚ˆãä½¿ã†é …ç›®ï¼ˆè‡ªå‹•å…¥åŠ›ï¼‰</label>
          <div class="checkbox-row" id="favModalCheckboxes"></div>
        </div>

        <div class="field" style="margin-top:10px;">
          <label>æ—¥ä¸­ã«è¡Œã£ãŸä¸»ãªæ”¯æ´ï¼ˆã‚ˆãä½¿ã†ï¼‰</label>
          <div class="checkbox-row" id="favModalDaySupportMainCheckboxes"></div>
        </div>

        <div class="btn-row" style="margin-top:10px;">
          <button type="button" class="btn-primary" id="favModalSave">ğŸ’¾ ä¿å­˜</button>
          <button type="button" class="btn-secondary" id="favModalCancel">é–‰ã˜ã‚‹</button>
        </div>
      </div>
    </div>
  </div>

  <!-- âœ… è‡ªå‹•ãƒ†ãƒ³ãƒ—ãƒ¬ï¼ˆåˆ©ç”¨è€…åˆ¥ï¼‰ å°çª“ãƒ¢ãƒ¼ãƒ€ãƒ«ï¼šç„¡ã„ã¨JSãŒæ­¢ã¾ã‚‹ã®ã§è¿½åŠ  -->
  <div id="rtModal" class="detail-modal-backdrop">
    <div class="detail-modal">
      <div class="detail-modal-header">
        <div class="detail-modal-title">è‡ªå‹•ãƒ†ãƒ³ãƒ—ãƒ¬ç·¨é›†ï¼ˆã“ã®åˆ©ç”¨è€…ï¼‰</div>
        <button type="button" class="detail-modal-close" id="rtModalClose">Ã—</button>
      </div>

      <div class="detail-modal-body">
        <div class="small-text" id="rtModalResidentInfo" style="margin-bottom:8px;">å¯¾è±¡ï¼š</div>

        <div class="field-row">
          <div class="field">
            <label for="rtModalSelect">æ—¢å­˜ãƒ†ãƒ³ãƒ—ãƒ¬</label>
            <select id="rtModalSelect">
              <option value="">ï¼ˆæ–°è¦ä½œæˆï¼‰</option>
            </select>
            <div class="small-text" id="rtModalDefaultInfo">æ—¢å®šï¼šãªã—</div>
          </div>
          <div class="field">
            <label for="rtModalName">ãƒ†ãƒ³ãƒ—ãƒ¬å</label>
            <input type="text" id="rtModalName" placeholder="ä¾‹ï¼šæ—¥ä¸­ãƒ»æ¨™æº–" />
          </div>
        </div>

        <div class="field">
          <label for="rtModalText">ãƒ†ãƒ³ãƒ—ãƒ¬æœ¬æ–‡ï¼ˆè‡ªå‹•ã§è¿½è¨˜ï¼‰</label>
          <textarea id="rtModalText" rows="7" placeholder="ä¾‹ï¼‰æ—¥ä¸­ã¯è½ã¡ç€ã„ã¦éã”ã•ã‚Œã‚‹ã€‚å¿…è¦æ™‚ã«å£°ã‹ã‘ãƒ»è¦‹å®ˆã‚Šã‚’è¡Œã£ãŸã€‚"></textarea>
        </div>

        <div class="btn-row" style="margin-top:10px;">
          <button type="button" class="btn-primary" id="rtModalSaveBtn">ğŸ’¾ ä¿å­˜</button>
          <button type="button" class="btn-secondary" id="rtModalSetDefaultBtn">â­ æ—¢å®šã«ã™ã‚‹</button>
          <button type="button" class="btn-danger" id="rtModalDeleteBtn">ğŸ—‘ï¸ å‰Šé™¤</button>
          <button type="button" class="btn-secondary" id="rtModalCloseBtn">é–‰ã˜ã‚‹</button>
        </div>
      </div>
    </div>
  </div>

  <!-- æ—¥ä¸­æ”¯æ´ãƒã‚§ãƒƒã‚¯ï¼ˆã“ã®åˆ©ç”¨è€…ï¼‰ç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ« -->
  <div id="dsModal" class="detail-modal-backdrop">
    <div class="detail-modal">
      <div class="detail-modal-header">
        <div class="detail-modal-title" id="dsModalTitle">æ—¥ä¸­æ”¯æ´ãƒã‚§ãƒƒã‚¯ç·¨é›†ï¼ˆåˆ©ç”¨è€…åˆ¥ï¼‰</div>
        <button type="button" class="detail-modal-close" id="dsModalClose">Ã—</button>
      </div>
      <div class="detail-modal-body">
        <div class="small-text" id="dsModalResidentInfo" style="margin-bottom:8px;"></div>

        <div class="field-row">
          <div class="field">
            <label for="dsModalMain">ä¸»ãªæ”¯æ´ï¼ˆ1è¡Œ=1é …ç›®ï¼‰</label>
            <textarea id="dsModalMain" rows="10"></textarea>
          </div>
          <div class="field">
            <label for="dsModalReason">æ¬ å¸­ç†ç”±ï¼ˆ1è¡Œ=1é …ç›®ï¼‰</label>
            <textarea id="dsModalReason" rows="10"></textarea>
          </div>
        </div>

        <div class="btn-row" style="margin-top:10px;">
          <button type="button" class="btn-primary" id="dsModalSaveBtn">ğŸ’¾ ä¿å­˜</button>
          <button type="button" class="btn-secondary" id="dsModalResetBtn">â†© åˆæœŸã«æˆ»ã™</button>
          <button type="button" class="btn-secondary" id="dsModalCloseBtn">é–‰ã˜ã‚‹</button>
        </div>
      </div>
    </div>
  </div>

  <!-- ãƒ¡ã‚¤ãƒ³ã‚¹ã‚¯ãƒªãƒ—ãƒˆ -->
  <script>
    const STORAGE_KEY   = "group_home_records_v1";
    const RESIDENTS_KEY = "group_home_residents_v1";
    const TEMPLATES_KEY = "group_home_support_templates_v1";

    // è‡ªå‹•å…¥åŠ›ï¼ˆæ”¯æ´é …ç›®ï¼‰
    const AUTO_ITEM_DEFS_KEY = "group_home_auto_item_defs_v1";

    // ã‚¿ã‚°
    const TAGS_KEY = "group_home_tags_v1";

    // âœ… åˆ©ç”¨è€…åˆ¥ï¼šä¿å­˜ã‚­ãƒ¼
    const FAV_BY_RESIDENT_KEY = "group_home_fav_by_resident_v1";
    const RESIDENT_AUTO_TEMPLATES_KEY = "group_home_resident_auto_templates_v1";
    const DAY_SUPPORT_BY_RESIDENT_KEY = "group_home_day_support_by_resident_v1";

    const DEFAULT_AUTO_ITEM_DEFS = [
      { key: "med_manage",  label: "æœè–¬ç®¡ç†", defaultText: "ã€æœè–¬ç®¡ç†ã€‘å‡¦æ–¹è–¬ã¯äº‹å‹™æ‰€ã«ã¦ä¸€æ‹¬ç®¡ç†ã—ã€æœè–¬æ™‚ã«è·å“¡ãŒæ‰‹æ¸¡ã—å¯¾å¿œã‚’è¡Œã£ãŸã€‚" },
      { key: "oral_check",  label: "å†…æœç¢ºèª", defaultText: "ã€å†…æœç¢ºèªã€‘æœè–¬æ™‚ã¯è·å“¡ãŒæ‰‹æ¸¡ã—ã€ç›®ã®å‰ã§é£²ã‚“ã§é ‚ãå†…æœç¢ºèªã‚’è¡Œã£ãŸã€‚" },
      { key: "bathing",     label: "å…¥æµ´",     defaultText: "ã€å…¥æµ´ã€‘å…¥æµ´ã®å£°ã‹ã‘ã¨æº–å‚™ã®ä¸€éƒ¨ä»‹åŠ©ã‚’è¡Œã„ã€æœ¬äººã®ãƒšãƒ¼ã‚¹ã‚’å°Šé‡ã—ãªãŒã‚‰è¦‹å®ˆã£ãŸã€‚" },
      { key: "day_support", label: "æ—¥ä¸­æ”¯æ´åŠ ç®—", defaultText: "ã€æ—¥ä¸­æ”¯æ´åŠ ç®—ã€‘{{daySupportTypeLabel}}ã®å¯¾è±¡ã¨ã—ã¦ã€æ—¥ä¸­ã‚‚ã‚°ãƒ«ãƒ¼ãƒ—ãƒ›ãƒ¼ãƒ å†…ã§è¦‹å®ˆã‚Šãƒ»å£°ã‹ã‘ãƒ»èª˜å°ç­‰ã®æ”¯æ´ã‚’ç¶™ç¶šã—ã¦å®Ÿæ–½ã—ãŸã€‚" }
    ];

    const DEFAULT_TAG_LIST = [
      "æœè–¬","é€šé™¢","å…¥æµ´","å¤–å‡º","ä½“èª¿ä¸è‰¯","ç›¸è«‡","ä»•äº‹","æƒé™¤","é‡‘éŠ­","å¤œé–“å¯¾å¿œ"
    ];

    // â˜…æ—¥ä¸­æ”¯æ´ï¼šä¸»ãªæ”¯æ´ï¼ˆåˆæœŸï¼‰
    const DEFAULT_DAY_SUPPORT_MAIN = [
      "ä½“èª¿ç®¡ç†ï¼ˆæ¤œæ¸©ãƒ»ç—‡çŠ¶ç¢ºèªãƒ»å®‰é™ã®è¦‹å®ˆã‚Šãªã©ï¼‰",
      "é£Ÿäº‹ã®æ”¯æ´ï¼ˆæº–å‚™ãƒ»é…è†³ãƒ»ä»‹åŠ©ï¼‰",
      "æœè–¬ç®¡ç†ãƒ»å†…æœç¢ºèª",
      "æ°´åˆ†ãƒ»ãƒˆã‚¤ãƒ¬ã®å£°ã‹ã‘ãƒ»ä»‹åŠ©",
      "å…¥æµ´ãƒ»æ¸…æ½”ä¿æŒã®æ”¯æ´",
      "è¡Œå‹•ã‚„å®‰å…¨é¢ã®è¦‹å®ˆã‚Š",
      "å¿ƒç†é¢ã®æ”¯æ´ã‚„ç›¸è«‡",
      "æ—¥ä¸­ã®æ´»å‹•æ”¯æ´ãƒ»ç”Ÿæ´»ãƒªã‚ºãƒ ã®èª¿æ•´"
    ];

    // â˜…æ—¥ä¸­æ”¯æ´ï¼šç†ç”±ï¼ˆåˆæœŸï¼‰
    const DEFAULT_DAY_SUPPORT_REASON = [
      "ä½“èª¿ä¸è‰¯ã§æ—¥ä¸­æ´»å‹•ï¼ˆé€šæ‰€ãƒ»å°±åŠ´ï¼‰ã‚’æ¬ å¸­",
      "é€šæ‰€å…ˆãƒ»å°±åŠ´å…ˆãŒä¼‘ã¿ï¼è‡¨æ™‚ä¼‘æ¥­ã®ãŸã‚åœ¨å®…",
      "éšœå®³ç‰¹æ€§ãƒ»è¡Œå‹•é¢ã®ä¸å®‰ã§æ—¥ä¸­æ´»å‹•åˆ©ç”¨ãŒå›°é›£",
      "åŒ»å¸«ã®æŒ‡ç¤ºã§å¤–å‡ºãƒ»é€šæ‰€ã‚’æ§ãˆã¦ã„ã‚‹"
    ];

    let records = [];
    let residents = [];
    let currentTags = [];
    let templates = [];

    // è‡ªå‹•å…¥åŠ›é …ç›® / ã‚¿ã‚°
    let AUTO_ITEM_DEFS = [];
    let TAG_LIST = [];

    // æ—¥ä¸­æ”¯æ´ãƒã‚§ãƒƒã‚¯ï¼ˆãƒ•ã‚©ãƒ¼ãƒ è¡¨ç¤ºç”¨ï¼šç¾åœ¨ã®åˆ©ç”¨è€…ã«åˆã‚ã›ã‚‹ï¼‰
    let DAY_SUPPORT_MAIN_LIST = DEFAULT_DAY_SUPPORT_MAIN.slice();
    let DAY_SUPPORT_REASON_LIST = DEFAULT_DAY_SUPPORT_REASON.slice();

    // åˆ©ç”¨è€…åˆ¥ãƒ‡ãƒ¼ã‚¿
    let favByResident = {};
    let residentAutoTemplates = {};
    let daySupportByResident = {};

    // ç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ«ç”¨
    let editingRecordId = null;
    let editTags = [];

    function loadJSON(key, fallback) {
      const raw = localStorage.getItem(key);
      if (!raw) return fallback;
      try {
        const parsed = JSON.parse(raw);
        return parsed ?? fallback;
      } catch {
        return fallback;
      }
    }

    function saveJSON(key, value) {
      localStorage.setItem(key, JSON.stringify(value));
    }

    function loadTags() {
      const parsed = loadJSON(TAGS_KEY, null);
      if (Array.isArray(parsed) && parsed.length) return parsed;
      saveJSON(TAGS_KEY, DEFAULT_TAG_LIST);
      return DEFAULT_TAG_LIST.slice();
    }

    function saveTags() { saveJSON(TAGS_KEY, TAG_LIST); }

    function loadAutoItemDefs() {
      const raw = localStorage.getItem(AUTO_ITEM_DEFS_KEY);
      if (raw) {
        try {
          const parsed = JSON.parse(raw);
          if (Array.isArray(parsed)) return parsed;
        } catch {}
      }
      localStorage.setItem(AUTO_ITEM_DEFS_KEY, JSON.stringify(DEFAULT_AUTO_ITEM_DEFS));
      return DEFAULT_AUTO_ITEM_DEFS.slice();
    }

    function saveAutoItemDefs() {
      localStorage.setItem(AUTO_ITEM_DEFS_KEY, JSON.stringify(AUTO_ITEM_DEFS));
    }

    function loadRecords() {
      try {
        const raw = localStorage.getItem(STORAGE_KEY);
        if (!raw) return [];
        const parsed = JSON.parse(raw);
        if (!Array.isArray(parsed)) return [];
        return parsed;
      } catch (e) {
        console.error("load error", e);
        return [];
      }
    }

    function saveRecords() { localStorage.setItem(STORAGE_KEY, JSON.stringify(records)); }

    function loadResidents() {
      try {
        const raw = localStorage.getItem(RESIDENTS_KEY);
        if (raw) {
          const parsed = JSON.parse(raw);
          if (Array.isArray(parsed) && parsed.length > 0) return parsed;
        }
      } catch (e) {
        console.error("load residents error", e);
      }
      const fromRecords = Array.from(new Set(records.map((r) => r.resident).filter(Boolean)));
      if (fromRecords.length > 0) return fromRecords;
      return ["åˆ©ç”¨è€…A","åˆ©ç”¨è€…B","åˆ©ç”¨è€…C","åˆ©ç”¨è€…D","åˆ©ç”¨è€…E","åˆ©ç”¨è€…F","åˆ©ç”¨è€…G"];
    }

    function saveResidents() { localStorage.setItem(RESIDENTS_KEY, JSON.stringify(residents)); }

    // ===== åˆ©ç”¨è€…åˆ¥ï¼šã‚ˆãä½¿ã†é …ç›®ï¼ˆæ—§ãƒ‡ãƒ¼ã‚¿å¯¾ç­–ã‚ã‚Šï¼‰ =====
    function normalizeFavStore(obj) {
      const out = { ...(obj || {}) };
      Object.keys(out).forEach((name) => {
        const v = out[name];
        // æ—§å½¢å¼ï¼šé…åˆ—ï¼ˆautoKeysã®ã¿ï¼‰â†’ æ–°å½¢å¼ã¸å¤‰æ›
        if (Array.isArray(v)) {
          out[name] = { autoKeys: v, dayMain: [] };
          return;
        }
        // æ–°å½¢å¼ï¼šã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ
        if (v && typeof v === "object") {
          out[name] = {
            autoKeys: Array.isArray(v.autoKeys) ? v.autoKeys : [],
            dayMain: Array.isArray(v.dayMain) ? v.dayMain : [],
          };
          return;
        }
        out[name] = { autoKeys: [], dayMain: [] };
      });
      return out;
    }

    function loadFavByResident() {
      const raw = loadJSON(FAV_BY_RESIDENT_KEY, {});
      const norm = normalizeFavStore(raw);
      saveJSON(FAV_BY_RESIDENT_KEY, norm);
      return norm;
    }
    function saveFavByResident() { saveJSON(FAV_BY_RESIDENT_KEY, favByResident); }

    function getFavForResident(name) {
      const v = favByResident[name];
      if (Array.isArray(v)) return { autoKeys: v, dayMain: [] }; // æ—§å½¢å¼å¯¾ç­–
      if (v && typeof v === "object") {
        return {
          autoKeys: Array.isArray(v.autoKeys) ? v.autoKeys : [],
          dayMain: Array.isArray(v.dayMain) ? v.dayMain : [],
        };
      }
      return { autoKeys: [], dayMain: [] };
    }

    function applyFavToMainCheckboxes(name) {
      const fav = getFavForResident(name);

      // è‡ªå‹•å…¥åŠ›ï¼ˆæ”¯æ´é …ç›®ï¼‰
      const autoSet = new Set(fav.autoKeys);
      document.querySelectorAll(".auto-item").forEach((cb) => {
        cb.checked = autoSet.has(cb.value);
      });

      // æ—¥ä¸­æ”¯æ´ï¼šä¸»ãªæ”¯æ´
      const daySet = new Set(fav.dayMain);
      document.querySelectorAll(".day-main-item").forEach((cb) => {
        cb.checked = daySet.has(cb.value);
      });
    }

    // ===== åˆ©ç”¨è€…åˆ¥ï¼šè‡ªå‹•ãƒ†ãƒ³ãƒ—ãƒ¬ =====
    function loadResidentAutoTemplates() { return loadJSON(RESIDENT_AUTO_TEMPLATES_KEY, {}); }
    function saveResidentAutoTemplates() { saveJSON(RESIDENT_AUTO_TEMPLATES_KEY, residentAutoTemplates); }

    function ensureResidentTemplateState(resident) {
      if (!residentAutoTemplates[resident] || typeof residentAutoTemplates[resident] !== "object") {
        residentAutoTemplates[resident] = { templates: [], defaultId: "" };
      }
      const st = residentAutoTemplates[resident];
      if (!Array.isArray(st.templates)) st.templates = [];
      if (typeof st.defaultId !== "string") st.defaultId = "";
      return st;
    }

    // ===== åˆ©ç”¨è€…åˆ¥ï¼šæ—¥ä¸­æ”¯æ´ãƒã‚§ãƒƒã‚¯ =====
    function loadDaySupportByResident() { return loadJSON(DAY_SUPPORT_BY_RESIDENT_KEY, {}); }
    function saveDaySupportByResident() { saveJSON(DAY_SUPPORT_BY_RESIDENT_KEY, daySupportByResident); }

    function getDaySupportForResident(resident) {
      const st = daySupportByResident[resident];
      if (st && Array.isArray(st.main) && Array.isArray(st.reason)) return st;
      return { main: DEFAULT_DAY_SUPPORT_MAIN.slice(), reason: DEFAULT_DAY_SUPPORT_REASON.slice() };
    }

    function applyDaySupportListsForResident(resident) {
      if (!resident) return;

      // ç¾åœ¨ãƒã‚§ãƒƒã‚¯ã‚’é€€é¿ï¼ˆå†æç”»ã§æ¶ˆãˆã‚‹ã®ã§ï¼‰
      const prevMain = new Set(Array.from(document.querySelectorAll(".day-main-item:checked")).map((x) => x.value));
      const prevReason = new Set(Array.from(document.querySelectorAll(".day-reason-item:checked")).map((x) => x.value));

      const conf = getDaySupportForResident(resident);
      DAY_SUPPORT_MAIN_LIST = conf.main.slice();
      DAY_SUPPORT_REASON_LIST = conf.reason.slice();

      renderDaySupportMainCheckboxes();
      renderDaySupportReasonCheckboxes();

      // é€€é¿ã—ãŸãƒã‚§ãƒƒã‚¯ã‚’å¾©å…ƒï¼ˆå­˜åœ¨ã™ã‚‹ã‚‚ã®ã ã‘ï¼‰
      document.querySelectorAll(".day-main-item").forEach((x) => { x.checked = prevMain.has(x.value); });
      document.querySelectorAll(".day-reason-item").forEach((x) => { x.checked = prevReason.has(x.value); });
    }

    // ===== ãƒ†ãƒ³ãƒ—ãƒ¬ï¼ˆå…±é€šï¼‰ =====
    function loadTemplates() {
      try {
        const raw = localStorage.getItem(TEMPLATES_KEY);
        if (!raw) return [];
        const parsed = JSON.parse(raw);
        if (!Array.isArray(parsed)) return [];
        return parsed
          .filter((t) => t && typeof t.name === "string" && typeof t.text === "string")
          .map((t) => (!t.scope ? { ...t, scope: "common" } : t));
      } catch (e) {
        console.error("load templates error", e);
        return [];
      }
    }
    function saveTemplates() { localStorage.setItem(TEMPLATES_KEY, JSON.stringify(templates)); }

    // ===== å…±é€šãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ =====
    function escapeHtml(str) {
      return String(str)
        .replaceAll("&", "&amp;")
        .replaceAll("<", "&lt;")
        .replaceAll(">", "&gt;")
        .replaceAll('"', "&quot;")
        .replaceAll("'", "&#039;");
    }
    function toLocalISODate(d = new Date()) {
  const tz = d.getTimezoneOffset() * 60000;
  return new Date(d.getTime() - tz).toISOString().slice(0, 10);
}
function parseLocalISODate(iso) {
  return iso ? new Date(iso + "T00:00:00") : null; // ãƒ­ãƒ¼ã‚«ãƒ«0æ™‚
}

    function escapeHtmlAttr(str) { return escapeHtml(str); }

    function populateResidentSelect(selectEl, placeholderText = "é¸æŠã—ã¦ãã ã•ã„") {
      if (!selectEl) return;
      const cur = selectEl.value;
      selectEl.innerHTML = "";
      const ph = document.createElement("option");
      ph.value = "";
      ph.textContent = placeholderText;
      selectEl.appendChild(ph);
      residents.forEach((name) => {
        const opt = document.createElement("option");
        opt.value = name;
        opt.textContent = name;
        selectEl.appendChild(opt);
      });
      selectEl.value = (cur && residents.includes(cur)) ? cur : "";
    }

    function renderResidentSelects() {
      const residentSelect = document.getElementById("resident");
      const filterSelect = document.getElementById("filterResident");
      const manageSelect = document.getElementById("residentManageSelect");
      const residentCountLabel = document.getElementById("residentCount");

      if (residentCountLabel) residentCountLabel.textContent = residents.length + "å";

      if (residentSelect) {
        const current = residentSelect.value;
        residentSelect.innerHTML = "";
        const placeholder = document.createElement("option");
        placeholder.value = "";
        placeholder.textContent = "é¸æŠã—ã¦ãã ã•ã„";
        residentSelect.appendChild(placeholder);
        residents.forEach((name) => {
          const opt = document.createElement("option");
          opt.value = name;
          opt.textContent = name;
          residentSelect.appendChild(opt);
        });
        residentSelect.value = (current && residents.includes(current)) ? current : "";
      }

      if (filterSelect) {
        const current = filterSelect.value;
        filterSelect.innerHTML = "";
        const optAll = document.createElement("option");
        optAll.value = "";
        optAll.textContent = "å…¨å“¡";
        filterSelect.appendChild(optAll);
        residents.forEach((name) => {
          const opt = document.createElement("option");
          opt.value = name;
          opt.textContent = name;
          filterSelect.appendChild(opt);
        });
        filterSelect.value = (current && residents.includes(current)) ? current : "";
      }

      if (manageSelect) {
        const current = manageSelect.value;
        manageSelect.innerHTML = "";
        const placeholder = document.createElement("option");
        placeholder.value = "";
        placeholder.textContent = "é¸æŠã—ã¦ãã ã•ã„";
        manageSelect.appendChild(placeholder);
        residents.forEach((name) => {
          const opt = document.createElement("option");
          opt.value = name;
          opt.textContent = name;
          manageSelect.appendChild(opt);
        });
        manageSelect.value = (current && residents.includes(current)) ? current : "";
      }

      // ç®¡ç†ï¼šåˆ©ç”¨è€…åˆ¥ç³»
      populateResidentSelect(document.getElementById("favResidentSelect"));
      populateResidentSelect(document.getElementById("rtResidentSelect"));
      populateResidentSelect(document.getElementById("dsResidentSelect"));

      // ç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ«ï¼šåˆ©ç”¨è€…
      populateResidentSelect(document.getElementById("editResident"));
    }

    function formatSupportSummary(text) {
      if (!text) return "";
      const trimmed = text.trim().replace(/\s+/g, " ");
      if (trimmed.length <= 40) return trimmed;
      return trimmed.slice(0, 40) + "â€¦";
    }

    function getTimeBadgeClass(timeSlot) {
      switch (timeSlot) {
        case "æ—¥ä¸­": return "badge-day";
        case "å¤•æ–¹": return "badge-evening";
        case "å¤œé–“": return "badge-night";
        default: return "badge-day";
      }
    }

    function renderRecords() {
      const tbody = document.getElementById("recordTableBody");
      const filterResident = document.getElementById("filterResident").value;
      const keyword = document.getElementById("searchKeyword").value.trim().toLowerCase();

      const periodFilterElement = document.getElementById("periodFilter");
      const periodFilter = periodFilterElement ? periodFilterElement.value : "month";

      const periodFromInput = document.getElementById("periodFrom");
      const periodToInput = document.getElementById("periodTo");
      const periodFrom = periodFromInput ? periodFromInput.value : "";
      const periodTo = periodToInput ? periodToInput.value : "";

     const now = new Date();
const todayStr = toLocalISODate(now);
const today0 = parseLocalISODate(todayStr);
const monthPrefix = todayStr.slice(0, 7);
const yearPrefix = todayStr.slice(0, 4);

const weekStart = new Date(today0);
weekStart.setDate(weekStart.getDate() - 6);


      tbody.innerHTML = "";

      const filtered = records.filter((r) => {
        if (filterResident && r.resident !== filterResident) return false;

        const dateStr = r.date;
        if (dateStr) {
          if (periodFilter === "today") {
            if (dateStr !== todayStr) return false;
          } else if (periodFilter === "week") {
            const d = new Date(dateStr);
            const d0 = parseLocalISODate(dateStr);
if (!d0) return false;
if (d0 < weekStart || d0 > today0) return false;
          } else if (periodFilter === "month") {
            if (dateStr.slice(0, 7) !== monthPrefix) return false;
          } else if (periodFilter === "year") {
            if (dateStr.slice(0, 4) !== yearPrefix) return false;
          } else if (periodFilter === "custom") {
            if (periodFrom && dateStr < periodFrom) return false;
            if (periodTo && dateStr > periodTo) return false;
          }
        } else {
          if (periodFilter !== "all") return false;
        }

        if (keyword) {
          const tagsText = (r.tags || []).join(" ");
          const target = (((r.support || "") + " " + (r.note || "") + " " + (r.meal || "") + " " + tagsText)).toLowerCase();
          if (!target.includes(keyword)) return false;
        }

        return true;
      });

      document.getElementById("recordCount").textContent = filtered.length + "ä»¶";

      if (filtered.length === 0) {
        const tr = document.createElement("tr");
        const td = document.createElement("td");
        td.colSpan = 7;
        td.className = "no-records";
        td.textContent = "ã¾ã è¨˜éŒ²ãŒã‚ã‚Šã¾ã›ã‚“ã€‚å·¦ã®ãƒ•ã‚©ãƒ¼ãƒ ã‹ã‚‰ç™»éŒ²ã™ã‚‹ã‹ã€æœŸé–“ãƒ»åˆ©ç”¨è€…ã®æ¡ä»¶ã‚’å¤‰ãˆã¦ã¿ã¦ãã ã•ã„ã€‚";
        tr.appendChild(td);
        tbody.appendChild(tr);
        return;
      }

      filtered.slice().sort((a, b) => (a.date < b.date ? 1 : -1)).forEach((record) => {
        const tr = document.createElement("tr");

        const tdDate = document.createElement("td");
        tdDate.textContent = record.date || "";
        tr.appendChild(tdDate);

        const tdResident = document.createElement("td");
        tdResident.textContent = record.resident || "";
        tr.appendChild(tdResident);
        tr.appendChild(tdDaySupport);

        const tdDaySupport = document.createElement("td");
        tdDaySupport.className = "day-support-cell";

        const dsParts = [];
        const dsType = (record.daySupportType || "").trim();
        const dsTime = (record.daySupportTime || "").trim();
        const dsMain = Array.isArray(record.daySupportMainItems) ? record.daySupportMainItems.filter(Boolean) : [];
        const dsReason = Array.isArray(record.daySupportReasonItems) ? record.daySupportReasonItems.filter(Boolean) : [];

        if (dsType) dsParts.push(dsType);
        if (dsTime) dsParts.push(dsTime);
        if (dsMain.length) dsParts.push(dsMain.join("ã€"));
        if (dsReason.length) dsParts.push("ç†ç”±:" + dsReason.join("ã€"));

        tdDaySupport.textContent = dsParts.join(" / ");

        const tdSupport = document.createElement("td");

// æ”¯æ´å†…å®¹ï¼ˆæŠ˜ã‚ŠãŸãŸã¿ï¼‰
const full = (record.support || "").trim();
const supportDiv = document.createElement("div");
supportDiv.className = "support-preview";
supportDiv.textContent = full;

// é•·æ–‡ã ã‘ã€Œã‚‚ã£ã¨è¦‹ã‚‹ã€ã‚’å‡ºã™
const needToggle = full.length > 120 || full.includes("\n");
if (needToggle) {
  const toggle = document.createElement("button");
  toggle.type = "button";
  toggle.className = "support-toggle";
  toggle.textContent = "ã‚‚ã£ã¨è¦‹ã‚‹";
  toggle.addEventListener("click", () => {
    const expanded = supportDiv.classList.toggle("expanded");
    toggle.textContent = expanded ? "é–‰ã˜ã‚‹" : "ã‚‚ã£ã¨è¦‹ã‚‹";
  });
  tdSupport.appendChild(supportDiv);
  tdSupport.appendChild(toggle);
} else {
  tdSupport.appendChild(supportDiv);
}

// ã‚¿ã‚°è¡¨ç¤ºï¼ˆä»Šã¾ã§é€šã‚Šï¼‰
if (record.tags && record.tags.length) {
  const tagDiv = document.createElement("div");
  tagDiv.className = "small-text";
  record.tags.forEach((tag) => {
    const spanTag = document.createElement("span");
    spanTag.className = "tag-chip";
    spanTag.textContent = "#" + tag;
    tagDiv.appendChild(spanTag);
  });
  tdSupport.appendChild(tagDiv);
}

tr.appendChild(tdSupport);


        const tdMed = document.createElement("td");
        tdMed.textContent = record.medTaken ? "æœè–¬æ¸ˆã¿" : "";
        tr.appendChild(tdMed);

        const tdActions = document.createElement("td");

        const viewBtn = document.createElement("button");
        viewBtn.textContent = "è©³ç´°";
        viewBtn.className = "btn-secondary";
        viewBtn.style.fontSize = "12px";
        viewBtn.onclick = () => showRecordDetail(record.id);

        const editBtn = document.createElement("button");
        editBtn.textContent = "ç·¨é›†";
        editBtn.className = "btn-secondary";
        editBtn.style.fontSize = "12px";
        editBtn.onclick = () => openEditModal(record.id);

        const delBtn = document.createElement("button");
        delBtn.textContent = "å‰Šé™¤";
        delBtn.className = "btn-danger";
        delBtn.style.fontSize = "12px";
        delBtn.onclick = () => deleteRecord(record.id);

        tdActions.appendChild(viewBtn);
        tdActions.appendChild(editBtn);
        tdActions.appendChild(delBtn);
        tr.appendChild(tdActions);

        tbody.appendChild(tr);
      });
    }

    function resetForm() {
      document.getElementById("recordForm").reset();
      document.getElementById("date").value = toLocalISODate();
      document.getElementById("timeSlot").value = "æ—¥ä¸­";
      document.getElementById("condition").value = "è‰¯å¥½";
      document.getElementById("mental").value = "å®‰å®š";
      document.getElementById("medTaken").checked = false;

      const daySupportType = document.getElementById("daySupportType");
      if (daySupportType) daySupportType.value = "";
      const daySupportTime = document.getElementById("daySupportTime");
      if (daySupportTime) daySupportTime.value = "";

      currentTags = [];
      updateTagUI();
      syncQuickButtonsAll();

      document.getElementById("modeLabel").textContent = "æ–°è¦å…¥åŠ›ãƒ¢ãƒ¼ãƒ‰";
      document.getElementById("modeLabel").style.background = "#eff6ff";
      document.getElementById("modeLabel").style.color = "#1d4ed8";
      document.getElementById("saveButton").textContent = "ğŸ’¾ è¨˜éŒ²ã‚’ä¿å­˜";

      document.querySelectorAll(".auto-item").forEach((el) => { el.checked = false; });

      // æ—¥ä¸­æ”¯æ´ãƒã‚§ãƒƒã‚¯ãƒªã‚»ãƒƒãƒˆ
      document.querySelectorAll(".day-main-item").forEach((el) => { el.checked = false; });
      document.querySelectorAll(".day-reason-item").forEach((el) => { el.checked = false; });

      const templateScope = document.getElementById("templateScope");
      if (templateScope) templateScope.value = "common";
      renderTemplateSelect();

      // åˆ©ç”¨è€…åˆ¥ãƒ†ãƒ³ãƒ—ãƒ¬ã®é¸æŠã‚‚æ›´æ–°
      renderResidentTemplateSelectForForm();
    }

    function deleteRecord(id) {
      if (!confirm("ã“ã®è¨˜éŒ²ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")) return;
      records = records.filter((r) => r.id !== id);
      saveRecords();
      renderRecords();
    }

    function handleSubmit(event) {
      event.preventDefault();

      const date = document.getElementById("date").value;
      const resident = document.getElementById("resident").value;
      if (!date || !resident) {
        alert("æ—¥ä»˜ã¨åˆ©ç”¨è€…ã¯å¿…é ˆã§ã™ã€‚");
        return;
      }

      const daySupportType = document.getElementById("daySupportType")?.value || "";
      const daySupportTime = document.getElementById("daySupportTime")?.value || "";

      const daySupportMainItems = Array.from(document.querySelectorAll(".day-main-item:checked")).map((el) => el.value);
      const daySupportReasonItems = Array.from(document.querySelectorAll(".day-reason-item:checked")).map((el) => el.value);

      const recordData = {
        id: Date.now().toString(),
        date,
        resident,
        timeSlot: document.getElementById("timeSlot").value,
        condition: document.getElementById("condition").value,
        mental: document.getElementById("mental").value,
        meal: document.getElementById("meal").value,
        medTaken: document.getElementById("medTaken").checked,
        support: document.getElementById("support").value,
        note: document.getElementById("note").value,
        tags: [...currentTags],
        daySupportType,
        daySupportTime,
        daySupportMainItems,
        daySupportReasonItems,
      };

      records.push(recordData);
      saveRecords();
      renderRecords();
      resetForm();
    }

    // â˜…è‡ªå‹•ï¼šåˆ©ç”¨è€…åˆ¥ãƒ†ãƒ³ãƒ—ãƒ¬ï¼ˆé¸æŠï¼‰ï¼‹å…±é€šãƒ†ãƒ³ãƒ—ãƒ¬ï¼ˆé¸æŠï¼‰ï¼‹ãƒã‚§ãƒƒã‚¯é …ç›®ï¼ˆé¸æŠï¼‰ã‚’ã¾ã¨ã‚ã¦è¿½è¨˜
    function generateSupportText() {
      const textArea = document.getElementById("support");
      const resident = document.getElementById("resident")?.value;

      const parts = [];

      // 1) åˆ©ç”¨è€…åˆ¥ãƒ†ãƒ³ãƒ—ãƒ¬ï¼ˆé¸æŠã•ã‚Œã¦ã„ã‚Œã°ï¼‰
      const rtSel = document.getElementById("residentTemplateSelect");
      if (resident && rtSel && rtSel.value) {
        const st = ensureResidentTemplateState(resident);
        const tpl = st.templates.find((t) => t.id === rtSel.value);
        if (tpl && (tpl.text || "").trim()) parts.push(tpl.text.trim());
      }

      // 2) å…±é€šãƒ†ãƒ³ãƒ—ãƒ¬ï¼ˆé¸æŠã•ã‚Œã¦ã„ã‚Œã°ï¼‰
      const templateSelectEl = document.getElementById("templateSelect");
      const idxStr = templateSelectEl ? templateSelectEl.value : "";
      if (idxStr) {
        const idx = parseInt(idxStr, 10);
        if (!Number.isNaN(idx) && templates[idx]) {
          const t = (templates[idx].text || "").trim();
          if (t) parts.push(t);
        }
      }

      // 3) ãƒã‚§ãƒƒã‚¯é …ç›®
      const checkedKeys = Array.from(document.querySelectorAll(".auto-item:checked")).map((el) => el.value);
      if (checkedKeys.length > 0) {
        const daySupportType = document.getElementById("daySupportType")?.value || "";
        const daySupportTypeLabel = daySupportType ? ("æ—¥ä¸­æ”¯æ´åŠ ç®—" + daySupportType) : "æ—¥ä¸­æ”¯æ´åŠ ç®—";

        checkedKeys.forEach((key) => {
          const def = AUTO_ITEM_DEFS.find((d) => d.key === key);
          if (!def) return;
          let text = (def.defaultText || "").trim();
          if (!text) return;
          text = text.replaceAll("{{daySupportTypeLabel}}", daySupportTypeLabel);
          parts.push(text);
        });
      }

      if (parts.length === 0) {
        alert("è¿½è¨˜ã™ã‚‹å†…å®¹ãŒã‚ã‚Šã¾ã›ã‚“ã€‚\nãƒ»è‡ªå‹•ãƒ†ãƒ³ãƒ—ãƒ¬ï¼ˆåˆ©ç”¨è€…åˆ¥ï¼‰ã‚’é¸ã¶\nãƒ»å…±é€šãƒ†ãƒ³ãƒ—ãƒ¬ã‚’é¸ã¶\nãƒ»ã¾ãŸã¯ã€Œè‡ªå‹•å…¥åŠ›ã—ãŸã„æ”¯æ´é …ç›®ã€ã«ãƒã‚§ãƒƒã‚¯\nã®ã©ã‚Œã‹ã‚’è¡Œã£ã¦ãã ã•ã„ã€‚");
        return;
      }

      const newText = parts.join("\n");

      if (textArea.value.trim()) textArea.value = textArea.value.replace(/\s*$/, "") + "\n" + newText;
      else textArea.value = newText;
    }

      // è¨˜éŒ²è©³ç´°ãƒ¢ãƒ¼ãƒ€ãƒ«è¡¨ç¤º
    function showRecordDetail(id) {
      const record = records.find((r) => r.id === id);
      if (!record) return;

      const modal = document.getElementById("detailModal");
      const content = document.getElementById("detailModalContent");
      const titleEl = document.getElementById("detailModalTitle");
      if (!modal || !content) return;

      content.innerHTML = "";

      const addRow = (label, value) => {
        const div = document.createElement("div");
        div.className = "detail-field";
        const strong = document.createElement("strong");
        strong.textContent = label;
        const span = document.createElement("span");
        span.textContent = value || "";
        div.appendChild(strong);
        div.appendChild(span);
        content.appendChild(div);
      };

      // âœ… ã‚¿ã‚°è¡Œï¼ˆä¸»ãªæ”¯æ´ / æ¬ å¸­ç†ç”±ï¼‰
      const addTagRow = (label, items, type = "main") => {
        const div = document.createElement("div");
        div.className = "detail-field detail-tagrow";

        const strong = document.createElement("strong");
        strong.textContent = label;
        div.appendChild(strong);

        const arr = Array.isArray(items) ? items : [];
        if (arr.length === 0) {
          const span = document.createElement("span");
          span.textContent = "ãªã—";
          div.appendChild(span);
        } else {
          const box = document.createElement("div");
          box.className = "support-tags";

          arr.forEach((txt) => {
            const tag = document.createElement("span");
            tag.className = "support-tag" + (type === "reason" ? " reason" : "");
            tag.textContent = txt;
            box.appendChild(tag);
          });

          div.appendChild(box);
        }

        content.appendChild(div);
      };

      const addMultiline = (label, value) => {
        const wrap = document.createElement("div");
        wrap.className = "detail-multiline";
        const strong = document.createElement("strong");
        strong.textContent = label;
        const pre = document.createElement("pre");
        pre.textContent = value || "";
        wrap.appendChild(strong);
        wrap.appendChild(pre);
        content.appendChild(wrap);
      };

      const tagsText = record.tags && record.tags.length ? record.tags.map((t) => "#" + t).join(" ") : "ãªã—";
      const medText = record.medTaken ? "æœè–¬æ¸ˆã¿" : "æœªç¢ºèªï¼æœªå†…æœã®å¯èƒ½æ€§ã‚ã‚Š";
      const daySupportTypeLabel = record.daySupportType ? "æ—¥ä¸­æ”¯æ´åŠ ç®—" + record.daySupportType : "ãªã—";

      if (titleEl) titleEl.textContent = `${record.date || ""} ${record.resident || ""} ã•ã‚“ã®è¨˜éŒ²`;

      addRow("æ—¥ä»˜ï¼š", record.date || "");
      addRow("åˆ©ç”¨è€…ï¼š", record.resident || "");
      addRow("æ™‚é–“å¸¯ï¼š", record.timeSlot || "");
      addRow("ä½“èª¿ï¼š", record.condition || "");
      addRow("å¿ƒã®çŠ¶æ…‹ï¼š", record.mental || "");
      addRow("é£Ÿäº‹ã®æ§˜å­ï¼š", record.meal || "");
      addRow("æœè–¬ï¼š", medText);
      addRow("ã‚¿ã‚°ï¼š", tagsText);
      addRow("æ—¥ä¸­æ”¯æ´åŠ ç®—åŒºåˆ†ï¼š", daySupportTypeLabel);
      addRow("æ—¥ä¸­æ”¯æ´ã®æ™‚é–“å¸¯ï¼š", record.daySupportTime || "");

      // âœ… ã“ã“ãŒã‚¿ã‚°è¡¨ç¤º
      addTagRow("ä¸»ãªæ”¯æ´ï¼š", record.daySupportMainItems, "main");
      addTagRow("æ¬ å¸­ç†ç”±ï¼š", record.daySupportReasonItems, "reason");

      addMultiline("æœ¬æ—¥ã®æ”¯æ´å†…å®¹ãƒ»æ§˜å­ï¼š", record.support || "");
      addMultiline("ç‰¹è¨˜äº‹é …ï¼š", record.note || "");

      modal.classList.add("show");
    }


    function closeRecordDetail() {
      const modal = document.getElementById("detailModal");
      if (modal) modal.classList.remove("show");
    }

    // ===== ã‚¿ã‚°ï¼ˆãƒ¡ã‚¤ãƒ³ï¼‰ =====
    function setupTagButtons() {
      const container = document.getElementById("tagButtons");
      container.innerHTML = "";
      TAG_LIST.forEach((tag) => {
        const btn = document.createElement("button");
        btn.type = "button";
        btn.className = "tag-button";
        btn.textContent = "#" + tag;
        btn.dataset.tag = tag;
        btn.addEventListener("click", () => toggleTag(tag));
        container.appendChild(btn);
      });
      updateTagUI();
    }

    function toggleTag(tag) {
      const idx = currentTags.indexOf(tag);
      if (idx >= 0) currentTags.splice(idx, 1);
      else currentTags.push(tag);
      updateTagUI();
    }

    function updateTagUI() {
      const info = document.getElementById("selectedTagsInfo");
      if (!info) return;

      if (currentTags.length === 0) info.textContent = "é¸æŠä¸­ï¼šãªã—";
      else info.textContent = "é¸æŠä¸­ï¼š " + currentTags.map((t) => "#" + t).join(" ");

      const buttons = document.querySelectorAll("#tagButtons .tag-button");
      buttons.forEach((btn) => {
        const t = btn.dataset.tag;
        if (currentTags.includes(t)) btn.classList.add("tag-button-active");
        else btn.classList.remove("tag-button-active");
      });
    }

    // ===== ã‚¿ã‚°ï¼ˆç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ«ï¼‰ =====
    function renderEditTagButtons() {
      const container = document.getElementById("editTagButtons");
      const info = document.getElementById("editSelectedTagsInfo");
      if (!container || !info) return;

      container.innerHTML = "";
      TAG_LIST.forEach((tag) => {
        const btn = document.createElement("button");
        btn.type = "button";
        btn.className = "tag-button";
        btn.textContent = "#" + tag;
        btn.dataset.tag = tag;
        btn.addEventListener("click", () => {
          const idx = editTags.indexOf(tag);
          if (idx >= 0) editTags.splice(idx, 1);
          else editTags.push(tag);
          updateEditTagUI();
        });
        container.appendChild(btn);
      });
      updateEditTagUI();
    }

    function updateEditTagUI() {
      const info = document.getElementById("editSelectedTagsInfo");
      if (!info) return;

      if (editTags.length === 0) info.textContent = "é¸æŠä¸­ï¼šãªã—";
      else info.textContent = "é¸æŠä¸­ï¼š " + editTags.map((t) => "#" + t).join(" ");

      const buttons = document.querySelectorAll("#editTagButtons .tag-button");
      buttons.forEach((btn) => {
        const t = btn.dataset.tag;
        if (editTags.includes(t)) btn.classList.add("tag-button-active");
        else btn.classList.remove("tag-button-active");
      });
    }

    // ===== ã‚¯ã‚¤ãƒƒã‚¯ãƒœã‚¿ãƒ³ =====
    function setupQuickButtons() {
      const groups = document.querySelectorAll(".quick-row");
      groups.forEach((row) => {
        const targetId = row.dataset.target;
        const select = document.getElementById(targetId);
        if (!select) return;

        const buttons = row.querySelectorAll(".quick-btn");

        function syncFromSelect() {
          const val = select.value;
          buttons.forEach((btn) => {
            if (btn.dataset.value === val) btn.classList.add("quick-btn-active");
            else btn.classList.remove("quick-btn-active");
          });
        }

        buttons.forEach((btn) => {
          btn.addEventListener("click", () => {
            select.value = btn.dataset.value;
            syncFromSelect();
          });
        });

        select.addEventListener("change", syncFromSelect);
        syncFromSelect();
      });
    }

    function syncQuickButtonsAll() {
      const groups = document.querySelectorAll(".quick-row");
      groups.forEach((row) => {
        const targetId = row.dataset.target;
        const select = document.getElementById(targetId);
        if (!select) return;
        const buttons = row.querySelectorAll(".quick-btn");
        const val = select.value;
        buttons.forEach((btn) => {
          if (btn.dataset.value === val) btn.classList.add("quick-btn-active");
          else btn.classList.remove("quick-btn-active");
        });
      });
    }

    // ===== åˆ©ç”¨è€…ç®¡ç† =====
    function handleResidentAdd() {
      const nameInput = document.getElementById("residentNameInput");
      const name = nameInput.value.trim();
      if (!name) { alert("è¿½åŠ ã™ã‚‹åå‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚"); return; }
      if (residents.includes(name)) { alert("åŒã˜åå‰ã®åˆ©ç”¨è€…ãŒã™ã§ã«å­˜åœ¨ã—ã¾ã™ã€‚"); return; }
      residents.push(name);
      saveResidents();
      renderResidentSelects();
      renderAllResidentScopedUIs();
      nameInput.value = "";
      alert("åˆ©ç”¨è€…ã‚’è¿½åŠ ã—ã¾ã—ãŸã€‚");
    }

    function handleResidentRename() {
      const manageSelect = document.getElementById("residentManageSelect");
      const oldName = manageSelect.value;
      const nameInput = document.getElementById("residentNameInput");
      const newName = nameInput.value.trim();

      if (!oldName) { alert("å¤‰æ›´ã™ã‚‹åˆ©ç”¨è€…ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚"); return; }
      if (!newName) { alert("æ–°ã—ã„åå‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚"); return; }
      if (oldName === newName) { alert("åŒã˜åå‰ã§ã™ã€‚"); return; }

      if (residents.includes(newName)) {
        const ok = confirm("åŒã˜åå‰ã®åˆ©ç”¨è€…ãŒã™ã§ã«å­˜åœ¨ã—ã¾ã™ã€‚çµ±åˆã—ã¾ã™ã‹ï¼Ÿ");
        if (!ok) return;
      }

      // residents / records
      residents = residents.map((n) => (n === oldName ? newName : n));
      records = records.map((r) => (r.resident === oldName ? { ...r, resident: newName } : r));

      // åˆ©ç”¨è€…åˆ¥ãƒ‡ãƒ¼ã‚¿ã‚‚å¼•ãç¶™ã
      if (favByResident[oldName] && !favByResident[newName]) favByResident[newName] = favByResident[oldName];
      delete favByResident[oldName];
      saveFavByResident();

      if (residentAutoTemplates[oldName] && !residentAutoTemplates[newName]) residentAutoTemplates[newName] = residentAutoTemplates[oldName];
      delete residentAutoTemplates[oldName];
      saveResidentAutoTemplates();

      if (daySupportByResident[oldName] && !daySupportByResident[newName]) daySupportByResident[newName] = daySupportByResident[oldName];
      delete daySupportByResident[oldName];
      saveDaySupportByResident();

      saveResidents();
      saveRecords();
      renderResidentSelects();
      renderRecords();
      renderAllResidentScopedUIs();

      nameInput.value = "";
      alert("åˆ©ç”¨è€…åã‚’å¤‰æ›´ã—ã¾ã—ãŸã€‚");
    }

    function handleResidentDelete() {
      const manageSelect = document.getElementById("residentManageSelect");
      const target = manageSelect.value;
      if (!target) { alert("å‰Šé™¤ã™ã‚‹åˆ©ç”¨è€…ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚"); return; }

      const ok = confirm(target + " ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ\nã“ã®åˆ©ç”¨è€…ã®ã™ã¹ã¦ã®è¨˜éŒ²ã‚‚å‰Šé™¤ã•ã‚Œã¾ã™ã€‚");
      if (!ok) return;

      residents = residents.filter((n) => n !== target);
      records = records.filter((r) => r.resident !== target);

      // åˆ©ç”¨è€…åˆ¥ãƒ‡ãƒ¼ã‚¿ã‚‚å‰Šé™¤
      delete favByResident[target];
      delete residentAutoTemplates[target];
      delete daySupportByResident[target];
      saveFavByResident();
      saveResidentAutoTemplates();
      saveDaySupportByResident();

      saveResidents();
      saveRecords();
      renderResidentSelects();
      renderRecords();
      renderAllResidentScopedUIs();

      document.getElementById("residentNameInput").value = "";
      alert("å‰Šé™¤ã—ã¾ã—ãŸã€‚");
    }

    // ===== å…±é€šãƒ†ãƒ³ãƒ—ãƒ¬ï¼ˆscopeï¼‰ =====
    function renderTemplateSelect() {
      const select = document.getElementById("templateSelect");
      const scopeSelect = document.getElementById("templateScope");
      if (!select || !scopeSelect) return;
      const currentScope = scopeSelect.value || "common";

      select.innerHTML = "";
      const placeholder = document.createElement("option");
      placeholder.value = "";
      placeholder.textContent = "é¸æŠã—ã¦ãã ã•ã„";
      select.appendChild(placeholder);

      templates.forEach((tpl, index) => {
        const scope = tpl.scope || "common";
        if (scope !== currentScope) return;
        const opt = document.createElement("option");
        opt.value = String(index);
        opt.textContent = tpl.name;
        select.appendChild(opt);
      });
    }

    function handleTemplateApply() {
      const select = document.getElementById("templateSelect");
      const idxStr = select.value;
      if (!idxStr) { alert("æŒ¿å…¥ã™ã‚‹ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚"); return; }
      const idx = parseInt(idxStr, 10);
      const tpl = templates[idx];
      if (!tpl) { alert("ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚"); return; }
      const support = document.getElementById("support");

      if (support.value.trim()) support.value = support.value.replace(/\s*$/, "") + "\n" + tpl.text;
      else support.value = tpl.text;
    }

    function handleTemplateSave() {
      const nameInput = document.getElementById("templateNameInput");
      const name = nameInput.value.trim();
      if (!name) { alert("ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆåã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚"); return; }

      const scopeSelect = document.getElementById("templateScope");
      const scope = scopeSelect ? (scopeSelect.value || "common") : "common";

      const support = document.getElementById("support");
      const text = support.value;

      if (!text.trim()) {
        const ok = confirm("ã€æœ¬æ—¥ã®æ”¯æ´å†…å®¹ãƒ»æ§˜å­ã€ãŒç©ºã§ã™ãŒã€ã“ã®ã¾ã¾ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã¨ã—ã¦ä¿å­˜ã—ã¾ã™ã‹ï¼Ÿ");
        if (!ok) return;
      }

      const existingIndex = templates.findIndex((t) => t.name === name && (t.scope || "common") === scope);

      let targetIndex;
      if (existingIndex >= 0) {
        const ok = confirm("åŒã˜åå‰ãƒ»å¯¾è±¡é …ç›®ã®ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆãŒã‚ã‚Šã¾ã™ã€‚ä¸Šæ›¸ãã—ã¾ã™ã‹ï¼Ÿ");
        if (!ok) return;
        templates[existingIndex].text = text;
        targetIndex = existingIndex;
      } else {
        templates.push({ name, text, scope });
        targetIndex = templates.length - 1;
      }

      saveTemplates();
      renderTemplateSelect();

      const select = document.getElementById("templateSelect");
      if (select) select.value = String(targetIndex);

      alert("ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’ä¿å­˜ã—ã¾ã—ãŸã€‚ï¼ˆãƒ—ãƒ«ãƒ€ã‚¦ãƒ³ã«é¸æŠã•ã‚Œã¾ã—ãŸï¼‰");
    }

    function handleTemplateDelete() {
      const select = document.getElementById("templateSelect");
      const idxStr = select.value;
      if (!idxStr) { alert("å‰Šé™¤ã™ã‚‹ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚"); return; }
      const idx = parseInt(idxStr, 10);
      const tpl = templates[idx];
      if (!tpl) { alert("ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚"); return; }
      const ok = confirm(`ã€Œ${tpl.name}ã€ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ`);
      if (!ok) return;

      templates.splice(idx, 1);
      saveTemplates();
      renderTemplateSelect();
      alert("ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’å‰Šé™¤ã—ã¾ã—ãŸã€‚");
    }

    // ===== è‡ªå‹•å…¥åŠ›é …ç›®ãƒã‚§ãƒƒã‚¯æ¬„ =====
    function renderAutoItemCheckboxes() {
      const wrap = document.getElementById("autoItemCheckboxes");
      if (!wrap) return;

      wrap.innerHTML = "";
      AUTO_ITEM_DEFS.forEach((def) => {
        const label = document.createElement("label");
        label.innerHTML = `<input type="checkbox" class="auto-item" value="${def.key}"> ${escapeHtml(def.label)}`;
        wrap.appendChild(label);
      });
    }

    // ===== æ—¥ä¸­æ”¯æ´ï¼ˆãƒ•ã‚©ãƒ¼ãƒ ï¼‰ãƒã‚§ãƒƒã‚¯ç”Ÿæˆ =====
    function renderDaySupportMainCheckboxes() {
      const wrap = document.getElementById("daySupportMainCheckboxes");
      if (!wrap) return;
      wrap.innerHTML = "";
      DAY_SUPPORT_MAIN_LIST.forEach((text) => {
        const label = document.createElement("label");
        label.innerHTML = `<input type="checkbox" class="day-main-item" value="${escapeHtmlAttr(text)}"> ${escapeHtml(text)}`;
        wrap.appendChild(label);
      });
    }

    function renderDaySupportReasonCheckboxes() {
      const wrap = document.getElementById("daySupportReasonCheckboxes");
      if (!wrap) return;
      wrap.innerHTML = "";
      DAY_SUPPORT_REASON_LIST.forEach((text) => {
        const label = document.createElement("label");
        label.innerHTML = `<input type="checkbox" class="day-reason-item" value="${escapeHtmlAttr(text)}"> ${escapeHtml(text)}`;
        wrap.appendChild(label);
      });
    }

    // ===== æ”¯æ´é …ç›®ç®¡ç†UI =====
    function renderAutoItemManager() {
      const sel = document.getElementById("autoItemSelect");
      const count = document.getElementById("autoItemCount");
      if (!sel) return;

      sel.innerHTML = `<option value="">ï¼ˆæ–°è¦è¿½åŠ ï¼‰</option>`;
      AUTO_ITEM_DEFS.forEach((d, i) => {
        const opt = document.createElement("option");
        opt.value = String(i);
        opt.textContent = `${d.label}ï¼ˆ${d.key}ï¼‰`;
        sel.appendChild(opt);
      });

      if (count) count.textContent = AUTO_ITEM_DEFS.length + "ä»¶";
    }

    function clearAutoItemInputs() {
      document.getElementById("autoItemSelect").value = "";
      document.getElementById("autoItemKey").value = "";
      document.getElementById("autoItemLabel").value = "";
      document.getElementById("autoItemText").value = "";
    }

    function fillAutoItemInputsBySelect() {
      const sel = document.getElementById("autoItemSelect");
      const idxStr = sel.value;
      if (!idxStr) {
        clearAutoItemInputs();
        return;
      }
      const idx = parseInt(idxStr, 10);
      const d = AUTO_ITEM_DEFS[idx];
      if (!d) return;

      document.getElementById("autoItemKey").value = d.key || "";
      document.getElementById("autoItemLabel").value = d.label || "";
      document.getElementById("autoItemText").value = d.defaultText || "";
    }

    function saveAutoItemFromInputs() {
      const sel = document.getElementById("autoItemSelect");
      const idxStr = sel.value;

      const key = document.getElementById("autoItemKey").value.trim();
      const label = document.getElementById("autoItemLabel").value.trim();
      const text = document.getElementById("autoItemText").value;

      if (!key) { alert("å†…éƒ¨ã‚­ãƒ¼ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ï¼ˆè‹±æ•°å­—ãƒ»é‡è¤‡ä¸å¯ï¼‰"); return; }
      if (!/^[a-zA-Z0-9_]+$/.test(key)) {
        alert("å†…éƒ¨ã‚­ãƒ¼ã¯è‹±æ•°å­—ã¨ _ ã®ã¿ã§å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚ä¾‹ï¼šmoney_support");
        return;
      }
      if (!label) { alert("è¡¨ç¤ºåã‚’å…¥åŠ›ã—ã¦ãã ã•ã„"); return; }
      if (!text.trim()) { alert("å®šå‹æ–‡ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„"); return; }

      const existsOther = AUTO_ITEM_DEFS.some((d, i) => d.key === key && String(i) !== idxStr);
      if (existsOther) {
        alert("åŒã˜å†…éƒ¨ã‚­ãƒ¼ãŒã™ã§ã«å­˜åœ¨ã—ã¾ã™ã€‚åˆ¥ã®ã‚­ãƒ¼ã«ã—ã¦ãã ã•ã„ã€‚");
        return;
      }

      if (idxStr) {
        const idx = parseInt(idxStr, 10);
        if (!AUTO_ITEM_DEFS[idx]) return;
        AUTO_ITEM_DEFS[idx] = { key, label, defaultText: text };
      } else {
        AUTO_ITEM_DEFS.push({ key, label, defaultText: text });
      }

      saveAutoItemDefs();
      renderAutoItemCheckboxes();
      renderAutoItemManager();
      renderFavManager(); // åˆ©ç”¨è€…åˆ¥UIã‚‚æ›´æ–°
      alert("ä¿å­˜ã—ã¾ã—ãŸã€‚");
    }

    function deleteSelectedAutoItem() {
      const sel = document.getElementById("autoItemSelect");
      const idxStr = sel.value;
      if (!idxStr) { alert("å‰Šé™¤ã™ã‚‹é …ç›®ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚"); return; }

      const idx = parseInt(idxStr, 10);
      const d = AUTO_ITEM_DEFS[idx];
      if (!d) return;

      const ok = confirm(`ã€Œ${d.label}ï¼ˆ${d.key}ï¼‰ã€ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ`);
      if (!ok) return;

      AUTO_ITEM_DEFS.splice(idx, 1);
      saveAutoItemDefs();
      renderAutoItemCheckboxes();
      renderAutoItemManager();
      renderFavManager();
      clearAutoItemInputs();
      alert("å‰Šé™¤ã—ã¾ã—ãŸã€‚");
    }

    function resetAutoItemsToDefault() {
      const ok = confirm("è‡ªå‹•å…¥åŠ›ã®æ”¯æ´é …ç›®ã‚’åˆæœŸçŠ¶æ…‹ã«æˆ»ã—ã¾ã™ã‹ï¼Ÿï¼ˆä»Šè¿½åŠ ã—ãŸé …ç›®ã¯æ¶ˆãˆã¾ã™ï¼‰");
      if (!ok) return;
      AUTO_ITEM_DEFS = DEFAULT_AUTO_ITEM_DEFS.slice();
      saveAutoItemDefs();
      renderAutoItemCheckboxes();
      renderAutoItemManager();
      renderFavManager();
      clearAutoItemInputs();
      alert("åˆæœŸçŠ¶æ…‹ã«æˆ»ã—ã¾ã—ãŸã€‚");
    }

    // ===== ã‚¿ã‚°ç®¡ç†ï¼ˆè¿½åŠ ãƒ»ç·¨é›†ãƒ»å‰Šé™¤ï¼‰ =====
    function renderTagManager() {
      const sel = document.getElementById("tagSelect");
      const count = document.getElementById("tagCount");
      if (!sel) return;

      sel.innerHTML = `<option value="">ï¼ˆæ–°è¦è¿½åŠ ï¼‰</option>`;
      TAG_LIST.forEach((t, i) => {
        const opt = document.createElement("option");
        opt.value = String(i);
        opt.textContent = t;
        sel.appendChild(opt);
      });

      if (count) count.textContent = TAG_LIST.length + "ä»¶";
    }

    function clearTagInputs() {
      document.getElementById("tagSelect").value = "";
      document.getElementById("tagNameInput").value = "";
    }

    function fillTagInputBySelect() {
      const sel = document.getElementById("tagSelect");
      const idxStr = sel.value;
      if (!idxStr) { clearTagInputs(); return; }
      const idx = parseInt(idxStr, 10);
      const t = TAG_LIST[idx];
      if (!t) return;
      document.getElementById("tagNameInput").value = t;
    }

    function saveTagFromInputs() {
      const sel = document.getElementById("tagSelect");
      const idxStr = sel.value;

      let name = document.getElementById("tagNameInput").value.trim();
      name = name.replace(/^#/, "").trim();
      if (!name) { alert("ã‚¿ã‚°åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„"); return; }

      const existsOther = TAG_LIST.some((t, i) => t === name && String(i) !== idxStr);
      if (existsOther) { alert("åŒã˜ã‚¿ã‚°ãŒã™ã§ã«å­˜åœ¨ã—ã¾ã™ã€‚åˆ¥åã«ã—ã¦ãã ã•ã„ã€‚"); return; }

      if (idxStr) {
        const idx = parseInt(idxStr, 10);
        if (!TAG_LIST[idx]) return;
        TAG_LIST[idx] = name;
      } else {
        TAG_LIST.push(name);
      }

      saveTags();
      setupTagButtons();
      renderTagManager();
      renderEditTagButtons();
      alert("ä¿å­˜ã—ã¾ã—ãŸã€‚");
    }

    function deleteSelectedTag() {
      const sel = document.getElementById("tagSelect");
      const idxStr = sel.value;
      if (!idxStr) { alert("å‰Šé™¤ã™ã‚‹ã‚¿ã‚°ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚"); return; }
      const idx = parseInt(idxStr, 10);
      const t = TAG_LIST[idx];
      if (!t) return;

      const ok = confirm(`ã€Œ${t}ã€ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ`);
      if (!ok) return;

      currentTags = currentTags.filter((x) => x !== t);
      editTags = editTags.filter((x) => x !== t);

      TAG_LIST.splice(idx, 1);
      saveTags();
      setupTagButtons();
      renderTagManager();
      renderEditTagButtons();
      clearTagInputs();
      updateTagUI();
      updateEditTagUI();
      alert("å‰Šé™¤ã—ã¾ã—ãŸã€‚");
    }

    function resetTagsToDefault() {
      const ok = confirm("ã‚¿ã‚°ã‚’åˆæœŸçŠ¶æ…‹ã«æˆ»ã—ã¾ã™ã‹ï¼Ÿï¼ˆä»Šè¿½åŠ ã—ãŸã‚¿ã‚°ã¯æ¶ˆãˆã¾ã™ï¼‰");
      if (!ok) return;
      TAG_LIST = DEFAULT_TAG_LIST.slice();
      saveTags();
      setupTagButtons();
      renderTagManager();
      renderEditTagButtons();
      clearTagInputs();
      alert("åˆæœŸã‚¿ã‚°ã«æˆ»ã—ã¾ã—ãŸã€‚");
    }

    // ===== ã‚ˆãä½¿ã†é …ç›® ç®¡ç†ï¼ˆåˆ©ç”¨è€…åˆ¥ï¼‰ =====
    function renderFavManager() {
      const resSel = document.getElementById("favResidentSelect");
      const autoBox = document.getElementById("favAutoItemCheckboxes");
      const dayBox  = document.getElementById("favDaySupportMainCheckboxes");
      if (!resSel || !autoBox || !dayBox) return;

      populateResidentSelect(resSel);
      const resident = resSel.value || residents[0] || "";
      if (!resSel.value && resident) resSel.value = resident;

      const fav = getFavForResident(resident);
      const autoSet = new Set(fav.autoKeys);
      const daySet  = new Set(fav.dayMain);

      // è‡ªå‹•å…¥åŠ›ï¼ˆæ”¯æ´é …ç›®ï¼‰
      autoBox.innerHTML = "";
      AUTO_ITEM_DEFS.forEach((def) => {
        const label = document.createElement("label");
        label.innerHTML = `<input type="checkbox" class="fav-item" value="${def.key}"> ${escapeHtml(def.label)}`;
        autoBox.appendChild(label);
      });
      autoBox.querySelectorAll(".fav-item").forEach((cb) => {
        cb.checked = autoSet.has(cb.value);
      });

      // æ—¥ä¸­æ”¯æ´ï¼šä¸»ãªæ”¯æ´ï¼ˆåˆ©ç”¨è€…åˆ¥ãƒªã‚¹ãƒˆã«åˆã‚ã›ã‚‹ï¼‰
      const conf = getDaySupportForResident(resident);
      dayBox.innerHTML = "";
      (conf.main || []).forEach((text) => {
        const label = document.createElement("label");
        label.innerHTML = `<input type="checkbox" class="fav-day-main-item" value="${escapeHtmlAttr(text)}"> ${escapeHtml(text)}`;
        dayBox.appendChild(label);
      });
      dayBox.querySelectorAll(".fav-day-main-item").forEach((cb) => {
        cb.checked = daySet.has(cb.value);
      });
    }

    function saveFavFromManager() {
      const res = document.getElementById("favResidentSelect")?.value;
      if (!res) { alert("å¯¾è±¡ã®åˆ©ç”¨è€…ã‚’é¸æŠã—ã¦ãã ã•ã„"); return; }

      const autoKeys = Array.from(document.querySelectorAll("#favAutoItemCheckboxes .fav-item:checked")).map((x) => x.value);
      const dayMain  = Array.from(document.querySelectorAll("#favDaySupportMainCheckboxes .fav-day-main-item:checked")).map((x) => x.value);

      favByResident[res] = { autoKeys, dayMain };
      saveFavByResident();
      alert("ä¿å­˜ã—ã¾ã—ãŸã€‚");
    }

    function applyFavNowFromManager() {
      const res = document.getElementById("favResidentSelect")?.value;
      if (!res) return;

      const autoKeys = Array.from(document.querySelectorAll("#favAutoItemCheckboxes .fav-item:checked")).map((x) => x.value);
      const dayMain  = Array.from(document.querySelectorAll("#favDaySupportMainCheckboxes .fav-day-main-item:checked")).map((x) => x.value);

      favByResident[res] = { autoKeys, dayMain };
      saveFavByResident();

      const current = document.getElementById("resident")?.value;
      if (current === res) {
        applyDaySupportListsForResident(res);
        applyFavToMainCheckboxes(res);
      }
      alert("ãƒ•ã‚©ãƒ¼ãƒ ã¸åæ˜ ã—ã¾ã—ãŸã€‚");
    }

    function clearFavChecks() {
      document.querySelectorAll("#favAutoItemCheckboxes .fav-item").forEach((x) => x.checked = false);
      document.querySelectorAll("#favDaySupportMainCheckboxes .fav-day-main-item").forEach((x) => x.checked = false);
    }

    // ===== è‡ªå‹•ãƒ†ãƒ³ãƒ—ãƒ¬ï¼ˆåˆ©ç”¨è€…åˆ¥ï¼‰ç®¡ç†ï¼ˆä¸‹ã®ç®¡ç†ã‚«ãƒ¼ãƒ‰ï¼‰ =====
    function renderResidentTemplateManager() {
      const resSel = document.getElementById("rtResidentSelect");
      const tplSel = document.getElementById("rtTemplateSelect");
      const defInfo = document.getElementById("rtDefaultInfo");
      if (!resSel || !tplSel) return;

      populateResidentSelect(resSel);
      const resident = resSel.value || residents[0] || "";
      if (!resSel.value && resident) resSel.value = resident;

      const st = ensureResidentTemplateState(resident);

      tplSel.innerHTML = `<option value="">ï¼ˆæ–°è¦ä½œæˆï¼‰</option>`;
      st.templates.forEach((t) => {
        const opt = document.createElement("option");
        opt.value = t.id;
        opt.textContent = t.name;
        tplSel.appendChild(opt);
      });

      const defaultName = st.templates.find((t) => t.id === st.defaultId)?.name || "ãªã—";
      if (defInfo) defInfo.textContent = "æ—¢å®šï¼š" + defaultName;
    }

    function fillResidentTemplateManagerInputs() {
      const resident = document.getElementById("rtResidentSelect")?.value;
      const tplId = document.getElementById("rtTemplateSelect")?.value;
      const nameEl = document.getElementById("rtTemplateName");
      const textEl = document.getElementById("rtTemplateText");
      if (!resident || !nameEl || !textEl) return;

      const st = ensureResidentTemplateState(resident);
      const tpl = st.templates.find((t) => t.id === tplId);

      if (!tplId || !tpl) {
        nameEl.value = "";
        textEl.value = "";
        return;
      }
      nameEl.value = tpl.name || "";
      textEl.value = tpl.text || "";
    }

    function saveResidentTemplateFromManager() {
      const resident = document.getElementById("rtResidentSelect")?.value;
      const tplId = document.getElementById("rtTemplateSelect")?.value;
      const name = document.getElementById("rtTemplateName")?.value.trim();
      const text = document.getElementById("rtTemplateText")?.value || "";
      if (!resident) { alert("å¯¾è±¡ã®åˆ©ç”¨è€…ã‚’é¸æŠã—ã¦ãã ã•ã„"); return; }
      if (!name) { alert("ãƒ†ãƒ³ãƒ—ãƒ¬åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„"); return; }
      if (!text.trim()) { if (!confirm("æœ¬æ–‡ãŒç©ºã§ã™ãŒä¿å­˜ã—ã¾ã™ã‹ï¼Ÿ")) return; }

      const st = ensureResidentTemplateState(resident);
      if (tplId) {
        const idx = st.templates.findIndex((t) => t.id === tplId);
        if (idx >= 0) st.templates[idx] = { ...st.templates[idx], name, text };
      } else {
        st.templates.push({ id: Date.now().toString(), name, text });
      }

      saveResidentAutoTemplates();
      renderResidentTemplateManager();
      document.getElementById("rtTemplateSelect").value = "";
      fillResidentTemplateManagerInputs();
      renderResidentTemplateSelectForForm();
      alert("ä¿å­˜ã—ã¾ã—ãŸ");
    }

    function setDefaultResidentTemplateFromManager() {
      const resident = document.getElementById("rtResidentSelect")?.value;
      const tplId = document.getElementById("rtTemplateSelect")?.value;
      if (!resident) return;
      if (!tplId) { alert("æ—¢å®šã«ã™ã‚‹ãƒ†ãƒ³ãƒ—ãƒ¬ã‚’é¸æŠã—ã¦ãã ã•ã„"); return; }
      const st = ensureResidentTemplateState(resident);
      st.defaultId = tplId;
      saveResidentAutoTemplates();
      renderResidentTemplateManager();
      renderResidentTemplateSelectForForm();
      alert("æ—¢å®šã«è¨­å®šã—ã¾ã—ãŸ");
    }

    function deleteResidentTemplateFromManager() {
      const resident = document.getElementById("rtResidentSelect")?.value;
      const tplId = document.getElementById("rtTemplateSelect")?.value;
      if (!resident || !tplId) { alert("å‰Šé™¤ã™ã‚‹ãƒ†ãƒ³ãƒ—ãƒ¬ã‚’é¸æŠã—ã¦ãã ã•ã„"); return; }

      const st = ensureResidentTemplateState(resident);
      const tpl = st.templates.find((t) => t.id === tplId);
      if (!confirm(`ã€Œ${tpl?.name || ""}ã€ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ`)) return;

      st.templates = st.templates.filter((t) => t.id !== tplId);
      if (st.defaultId === tplId) st.defaultId = "";

      saveResidentAutoTemplates();
      renderResidentTemplateManager();
      document.getElementById("rtTemplateSelect").value = "";
      fillResidentTemplateManagerInputs();
      renderResidentTemplateSelectForForm();
      alert("å‰Šé™¤ã—ã¾ã—ãŸ");
    }

    function clearResidentTemplateManagerInputs() {
      document.getElementById("rtTemplateSelect").value = "";
      document.getElementById("rtTemplateName").value = "";
      document.getElementById("rtTemplateText").value = "";
    }

    function renderResidentTemplateSelectForForm() {
      const resident = document.getElementById("resident")?.value;
      const sel = document.getElementById("residentTemplateSelect");
      if (!sel) return;

      sel.innerHTML = `<option value="">ï¼ˆãªã—ï¼‰</option>`;
      if (!resident) return;

      const st = ensureResidentTemplateState(resident);
      st.templates.forEach((t) => {
        const opt = document.createElement("option");
        opt.value = t.id;
        opt.textContent = t.name;
        sel.appendChild(opt);
      });

      if (st.defaultId && st.templates.some((t) => t.id === st.defaultId)) sel.value = st.defaultId;
      else sel.value = "";
    }

    // ===== æ—¥ä¸­æ”¯æ´ãƒã‚§ãƒƒã‚¯ï¼ˆåˆ©ç”¨è€…åˆ¥ï¼‰ç®¡ç†ï¼ˆä¸‹ã®ç®¡ç†ã‚«ãƒ¼ãƒ‰ï¼‰ =====
    function renderDaySupportManager() {
      const sel = document.getElementById("dsResidentSelect");
      const mainTa = document.getElementById("dsMainList");
      const reasonTa = document.getElementById("dsReasonList");
      if (!sel || !mainTa || !reasonTa) return;

      populateResidentSelect(sel);
      const resident = sel.value || residents[0] || "";
      if (!sel.value && resident) sel.value = resident;

      const conf = getDaySupportForResident(resident);
      mainTa.value = conf.main.join("\n");
      reasonTa.value = conf.reason.join("\n");
    }

    function saveDaySupportFromManager() {
      const resident = document.getElementById("dsResidentSelect")?.value;
      if (!resident) { alert("å¯¾è±¡ã®åˆ©ç”¨è€…ã‚’é¸æŠã—ã¦ãã ã•ã„"); return; }

      const mainLines = (document.getElementById("dsMainList")?.value || "")
        .split("\n").map((x) => x.trim()).filter(Boolean);
      const reasonLines = (document.getElementById("dsReasonList")?.value || "")
        .split("\n").map((x) => x.trim()).filter(Boolean);

      if (mainLines.length === 0 && !confirm("ä¸»ãªæ”¯æ´ãŒç©ºã§ã™ã€‚ç©ºã§ä¿å­˜ã—ã¾ã™ã‹ï¼Ÿ")) return;

      daySupportByResident[resident] = { main: mainLines, reason: reasonLines };
      saveDaySupportByResident();

      const current = document.getElementById("resident")?.value;
      if (current === resident) applyDaySupportListsForResident(resident);

      alert("ä¿å­˜ã—ã¾ã—ãŸï¼ˆãƒ•ã‚©ãƒ¼ãƒ ã«ã‚‚åæ˜ æ¸ˆã¿ï¼‰");
    }

    function resetDaySupportToDefaultFromManager() {
      const resident = document.getElementById("dsResidentSelect")?.value;
      if (!resident) return;
      if (!confirm("ã“ã®åˆ©ç”¨è€…ã®æ—¥ä¸­æ”¯æ´ãƒã‚§ãƒƒã‚¯ã‚’åˆæœŸã«æˆ»ã—ã¾ã™ã‹ï¼Ÿ")) return;

      delete daySupportByResident[resident];
      saveDaySupportByResident();
      renderDaySupportManager();

      const current = document.getElementById("resident")?.value;
      if (current === resident) applyDaySupportListsForResident(resident);

      alert("åˆæœŸã«æˆ»ã—ã¾ã—ãŸ");
    }

    // ===== ç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ«ï¼ˆè¨˜éŒ²ç·¨é›†ï¼‰ =====
    function openEditModal(id) {
      const record = records.find((r) => r.id === id);
      if (!record) return;

      editingRecordId = id;

      // åˆ©ç”¨è€…ãŒrecordsç”±æ¥ã§æœªç™»éŒ²ãªã‚‰è¿½åŠ 
      if (record.resident && !residents.includes(record.resident)) {
        residents.push(record.resident);
        saveResidents();
        renderResidentSelects();
        renderAllResidentScopedUIs();
      }

      // å…¥åŠ›
      document.getElementById("editDate").value = record.date || "";
      document.getElementById("editResident").value = record.resident || "";
      document.getElementById("editTimeSlot").value = record.timeSlot || "æ—¥ä¸­";
      document.getElementById("editCondition").value = record.condition || "è‰¯å¥½";
      document.getElementById("editMental").value = record.mental || "å®‰å®š";
      document.getElementById("editMeal").value = record.meal || "";
      document.getElementById("editMedTaken").checked = !!record.medTaken;
      document.getElementById("editSupport").value = record.support || "";
      document.getElementById("editNote").value = record.note || "";
      document.getElementById("editDaySupportType").value = record.daySupportType || "";
      document.getElementById("editDaySupportTime").value = record.daySupportTime || "";

      // ã‚¿ã‚°
      editTags = Array.isArray(record.tags) ? [...record.tags] : [];
      renderEditTagButtons();

      // æ—¥ä¸­æ”¯æ´ãƒã‚§ãƒƒã‚¯ï¼ˆã“ã®è¨˜éŒ²ã®åˆ©ç”¨è€…ã«åˆã‚ã›ã‚‹ï¼‰
      renderEditDaySupportCheckboxes(record.resident, record.daySupportMainItems || [], record.daySupportReasonItems || []);

      document.getElementById("editModalTitle").textContent = `è¨˜éŒ²ã®ç·¨é›†ï¼ˆ${record.date || ""} / ${record.resident || ""}ï¼‰`;

      document.getElementById("editModal").classList.add("show");
    }

    function closeEditModal() {
      document.getElementById("editModal").classList.remove("show");
      editingRecordId = null;
      editTags = [];
    }

    function renderEditDaySupportCheckboxes(resident, checkedMainArr, checkedReasonArr) {
      const mainWrap = document.getElementById("editDaySupportMainCheckboxes");
      const reasonWrap = document.getElementById("editDaySupportReasonCheckboxes");
      if (!mainWrap || !reasonWrap) return;

      const conf = getDaySupportForResident(resident);
      const checkedMain = new Set(Array.isArray(checkedMainArr) ? checkedMainArr : []);
      const checkedReason = new Set(Array.isArray(checkedReasonArr) ? checkedReasonArr : []);

      mainWrap.innerHTML = "";
      conf.main.forEach((text) => {
        const label = document.createElement("label");
        const v = text;
        label.innerHTML = `<input type="checkbox" class="edit-day-main-item" value="${escapeHtmlAttr(v)}"> ${escapeHtml(v)}`;
        mainWrap.appendChild(label);
      });
      mainWrap.querySelectorAll(".edit-day-main-item").forEach((cb) => {
        cb.checked = checkedMain.has(cb.value);
      });

      reasonWrap.innerHTML = "";
      conf.reason.forEach((text) => {
        const label = document.createElement("label");
        const v = text;
        label.innerHTML = `<input type="checkbox" class="edit-day-reason-item" value="${escapeHtmlAttr(v)}"> ${escapeHtml(v)}`;
        reasonWrap.appendChild(label);
      });
      reasonWrap.querySelectorAll(".edit-day-reason-item").forEach((cb) => {
        cb.checked = checkedReason.has(cb.value);
      });
    }

    function saveEditModal() {
      if (!editingRecordId) return;
      const idx = records.findIndex((r) => r.id === editingRecordId);
      if (idx < 0) return;

      const resident = document.getElementById("editResident").value;
      const date = document.getElementById("editDate").value;
      if (!resident || !date) { alert("æ—¥ä»˜ã¨åˆ©ç”¨è€…ã¯å¿…é ˆã§ã™"); return; }

      const mainItems = Array.from(document.querySelectorAll(".edit-day-main-item:checked")).map((x) => x.value);
      const reasonItems = Array.from(document.querySelectorAll(".edit-day-reason-item:checked")).map((x) => x.value);

      const updated = {
        ...records[idx],
        date,
        resident,
        timeSlot: document.getElementById("editTimeSlot").value,
        condition: document.getElementById("editCondition").value,
        mental: document.getElementById("editMental").value,
        meal: document.getElementById("editMeal").value,
        medTaken: document.getElementById("editMedTaken").checked,
        support: document.getElementById("editSupport").value,
        note: document.getElementById("editNote").value,
        tags: [...editTags],
        daySupportType: document.getElementById("editDaySupportType").value,
        daySupportTime: document.getElementById("editDaySupportTime").value,
        daySupportMainItems: mainItems,
        daySupportReasonItems: reasonItems,
      };

      records[idx] = updated;
      saveRecords();
      renderRecords();
      closeEditModal();
      alert("ä¿å­˜ã—ã¾ã—ãŸ");
    }

    // ===== ãƒ•ã‚©ãƒ¼ãƒ å´ï¼šã‚ˆãä½¿ã†é …ç›®ç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ«ï¼ˆã“ã®åˆ©ç”¨è€…ï¼‰ =====
    function openFavModalForCurrentResident() {
      const resident = document.getElementById("resident")?.value;
      if (!resident) { alert("å…ˆã«åˆ©ç”¨è€…ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚"); return; }

      document.getElementById("favModalTitle").textContent = `ã‚ˆãä½¿ã†é …ç›®ï¼ˆ${resident}ï¼‰`;

      const fav = getFavForResident(resident);
      const autoSet = new Set(fav.autoKeys || []);
      const daySet  = new Set(fav.dayMain || []);

      // è‡ªå‹•å…¥åŠ›
      const autoWrap = document.getElementById("favModalCheckboxes");
      autoWrap.innerHTML = "";
      AUTO_ITEM_DEFS.forEach((def) => {
        const label = document.createElement("label");
        label.innerHTML = `<input type="checkbox" class="fav-modal-item" value="${def.key}"> ${escapeHtml(def.label)}`;
        autoWrap.appendChild(label);
      });
      autoWrap.querySelectorAll(".fav-modal-item").forEach((cb) => {
        cb.checked = autoSet.has(cb.value);
      });

      // æ—¥ä¸­æ”¯æ´ï¼šä¸»ãªæ”¯æ´ï¼ˆåˆ©ç”¨è€…åˆ¥ãƒªã‚¹ãƒˆï¼‰
      const dayWrap = document.getElementById("favModalDaySupportMainCheckboxes");
      const conf = getDaySupportForResident(resident);
      dayWrap.innerHTML = "";
      (conf.main || []).forEach((text) => {
        const label = document.createElement("label");
        label.innerHTML = `<input type="checkbox" class="fav-modal-day-main-item" value="${escapeHtmlAttr(text)}"> ${escapeHtml(text)}`;
        dayWrap.appendChild(label);
      });
      dayWrap.querySelectorAll(".fav-modal-day-main-item").forEach((cb) => {
        cb.checked = daySet.has(cb.value);
      });

      document.getElementById("favModal").classList.add("show");
    }

    function saveFavModal() {
      const resident = document.getElementById("resident")?.value;
      if (!resident) return;

      const autoKeys = Array.from(document.querySelectorAll("#favModalCheckboxes .fav-modal-item:checked"))
        .map((x) => x.value);

      const dayMain = Array.from(document.querySelectorAll("#favModalDaySupportMainCheckboxes .fav-modal-day-main-item:checked"))
        .map((x) => x.value);

      favByResident[resident] = { autoKeys, dayMain };
      saveFavByResident();

      // åæ˜ ï¼ˆãƒ•ã‚©ãƒ¼ãƒ å´ï¼‰
      applyDaySupportListsForResident(resident);
      applyFavToMainCheckboxes(resident);

      renderFavManager();

      document.getElementById("favModal").classList.remove("show");
      alert("ä¿å­˜ã—ã¾ã—ãŸï¼ˆãƒ•ã‚©ãƒ¼ãƒ ã«åæ˜ ï¼‰");
    }

    // ===== ãƒ•ã‚©ãƒ¼ãƒ å´ï¼šè‡ªå‹•ãƒ†ãƒ³ãƒ—ãƒ¬ç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ«ï¼ˆã“ã®åˆ©ç”¨è€…ï¼‰ =====
    function openResidentTemplateModalForCurrentResident() {
      const resident = document.getElementById("resident")?.value;
      if (!resident) { alert("å…ˆã«åˆ©ç”¨è€…ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚"); return; }

      const st = ensureResidentTemplateState(resident);
      document.getElementById("rtModalResidentInfo").textContent = `å¯¾è±¡ï¼š${resident}`;

      const sel = document.getElementById("rtModalSelect");
      sel.innerHTML = `<option value="">ï¼ˆæ–°è¦ä½œæˆï¼‰</option>`;
      st.templates.forEach((t) => {
        const opt = document.createElement("option");
        opt.value = t.id;
        opt.textContent = t.name;
        sel.appendChild(opt);
      });

      const defaultName = st.templates.find((t) => t.id === st.defaultId)?.name || "ãªã—";
      document.getElementById("rtModalDefaultInfo").textContent = "æ—¢å®šï¼š" + defaultName;

      document.getElementById("rtModalName").value = "";
      document.getElementById("rtModalText").value = "";
      sel.value = "";

      document.getElementById("rtModal").classList.add("show");
    }

    function fillResidentTemplateModalInputs() {
      const resident = document.getElementById("resident")?.value;
      if (!resident) return;
      const st = ensureResidentTemplateState(resident);
      const id = document.getElementById("rtModalSelect").value;

      const tpl = st.templates.find((t) => t.id === id);
      if (!id || !tpl) {
        document.getElementById("rtModalName").value = "";
        document.getElementById("rtModalText").value = "";
        return;
      }
      document.getElementById("rtModalName").value = tpl.name || "";
      document.getElementById("rtModalText").value = tpl.text || "";
    }

    function saveResidentTemplateModal() {
      const resident = document.getElementById("resident")?.value;
      if (!resident) return;
      const st = ensureResidentTemplateState(resident);

      const id = document.getElementById("rtModalSelect").value;
      const name = document.getElementById("rtModalName").value.trim();
      const text = document.getElementById("rtModalText").value || "";

      if (!name) { alert("ãƒ†ãƒ³ãƒ—ãƒ¬åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„"); return; }
      if (!text.trim()) { if (!confirm("æœ¬æ–‡ãŒç©ºã§ã™ãŒä¿å­˜ã—ã¾ã™ã‹ï¼Ÿ")) return; }

      if (id) {
        const idx = st.templates.findIndex((t) => t.id === id);
        if (idx >= 0) st.templates[idx] = { ...st.templates[idx], name, text };
      } else {
        st.templates.push({ id: Date.now().toString(), name, text });
      }

      saveResidentAutoTemplates();
      renderResidentTemplateSelectForForm();
      renderResidentTemplateManager();

      alert("ä¿å­˜ã—ã¾ã—ãŸ");
      openResidentTemplateModalForCurrentResident();
    }

    function setDefaultResidentTemplateModal() {
      const resident = document.getElementById("resident")?.value;
      if (!resident) return;
      const st = ensureResidentTemplateState(resident);
      const id = document.getElementById("rtModalSelect").value;
      if (!id) { alert("æ—¢å®šã«ã™ã‚‹ãƒ†ãƒ³ãƒ—ãƒ¬ã‚’é¸æŠã—ã¦ãã ã•ã„"); return; }
      st.defaultId = id;
      saveResidentAutoTemplates();
      renderResidentTemplateSelectForForm();
      renderResidentTemplateManager();
      alert("æ—¢å®šã«è¨­å®šã—ã¾ã—ãŸ");
      openResidentTemplateModalForCurrentResident();
    }

    function deleteResidentTemplateModal() {
      const resident = document.getElementById("resident")?.value;
      if (!resident) return;
      const st = ensureResidentTemplateState(resident);
      const id = document.getElementById("rtModalSelect").value;
      if (!id) { alert("å‰Šé™¤ã™ã‚‹ãƒ†ãƒ³ãƒ—ãƒ¬ã‚’é¸æŠã—ã¦ãã ã•ã„"); return; }

      const tpl = st.templates.find((t) => t.id === id);
      if (!confirm(`ã€Œ${tpl?.name || ""}ã€ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ`)) return;

      st.templates = st.templates.filter((t) => t.id !== id);
      if (st.defaultId === id) st.defaultId = "";

      saveResidentAutoTemplates();
      renderResidentTemplateSelectForForm();
      renderResidentTemplateManager();

      alert("å‰Šé™¤ã—ã¾ã—ãŸ");
      openResidentTemplateModalForCurrentResident();
    }

    // ===== æ—¥ä¸­æ”¯æ´ãƒã‚§ãƒƒã‚¯ï¼ˆã“ã®åˆ©ç”¨è€…ï¼‰å°çª“ =====
    function openDaySupportModalForCurrentResident() {
      const resident = document.getElementById("resident")?.value;
      if (!resident) { alert("å…ˆã«åˆ©ç”¨è€…ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚"); return; }

      document.getElementById("dsModalResidentInfo").textContent = `å¯¾è±¡ï¼š${resident}`;
      const conf = getDaySupportForResident(resident);

      document.getElementById("dsModalMain").value = conf.main.join("\n");
      document.getElementById("dsModalReason").value = conf.reason.join("\n");

      document.getElementById("dsModal").classList.add("show");
    }

    function saveDaySupportModal() {
      const resident = document.getElementById("resident")?.value;
      if (!resident) return;

      const mainLines = (document.getElementById("dsModalMain").value || "").split("\n").map((x) => x.trim()).filter(Boolean);
      const reasonLines = (document.getElementById("dsModalReason").value || "").split("\n").map((x) => x.trim()).filter(Boolean);

      daySupportByResident[resident] = { main: mainLines, reason: reasonLines };
      saveDaySupportByResident();

      applyDaySupportListsForResident(resident);
      renderDaySupportManager();

      document.getElementById("dsModal").classList.remove("show");
      alert("ä¿å­˜ã—ã¾ã—ãŸï¼ˆãƒ•ã‚©ãƒ¼ãƒ ã«åæ˜ ï¼‰");
    }

    function resetDaySupportModalToDefault() {
      const resident = document.getElementById("resident")?.value;
      if (!resident) return;
      if (!confirm("ã“ã®åˆ©ç”¨è€…ã®æ—¥ä¸­æ”¯æ´ãƒã‚§ãƒƒã‚¯ã‚’åˆæœŸã«æˆ»ã—ã¾ã™ã‹ï¼Ÿ")) return;

      delete daySupportByResident[resident];
      saveDaySupportByResident();

      applyDaySupportListsForResident(resident);
      renderDaySupportManager();

      openDaySupportModalForCurrentResident();
    }

    function renderAllResidentScopedUIs() {
      renderFavManager();
      renderResidentTemplateManager();
      renderDaySupportManager();
      renderResidentTemplateSelectForForm();
    }

    // ===== èµ·å‹• =====
    document.addEventListener("DOMContentLoaded", () => {
      document.getElementById("date").value = toLocalISODate();

      records = loadRecords();
      residents = loadResidents();
      templates = loadTemplates();

      AUTO_ITEM_DEFS = loadAutoItemDefs();
      TAG_LIST = loadTags();

      favByResident = loadFavByResident();
      residentAutoTemplates = loadResidentAutoTemplates();
      daySupportByResident = loadDaySupportByResident();

      renderResidentSelects();
      renderRecords();

      setupTagButtons();
      updateTagUI();

      setupQuickButtons();
      syncQuickButtonsAll();

      renderAutoItemCheckboxes();
      renderAutoItemManager();

      // åˆæœŸï¼ˆæ—¥ä¸­æ”¯æ´ãƒã‚§ãƒƒã‚¯ï¼‰
      renderDaySupportMainCheckboxes();
      renderDaySupportReasonCheckboxes();

      const templateScopeEl = document.getElementById("templateScope");
      if (templateScopeEl) {
        templateScopeEl.addEventListener("change", renderTemplateSelect);
        templateScopeEl.value = "common";
      }
      renderTemplateSelect();

      renderAllResidentScopedUIs();

      // ===== åŸºæœ¬ã‚¤ãƒ™ãƒ³ãƒˆ =====
      document.getElementById("recordForm").addEventListener("submit", handleSubmit);
      document.getElementById("resetButton").addEventListener("click", resetForm);

      document.getElementById("filterResident").addEventListener("change", renderRecords);
      document.getElementById("searchKeyword").addEventListener("input", renderRecords);
      document.getElementById("searchClearButton").addEventListener("click", () => {
        document.getElementById("searchKeyword").value = "";
        renderRecords();
      });

      const periodFilterElement = document.getElementById("periodFilter");
      if (periodFilterElement) {
        periodFilterElement.addEventListener("change", () => {
          const val = periodFilterElement.value;
          const row = document.getElementById("customPeriodRow");
          if (row) row.style.display = (val === "custom") ? "flex" : "none";
          renderRecords();
        });
      }
      document.getElementById("applyCustomPeriod").addEventListener("click", renderRecords);

      // âœ… åˆ©ç”¨è€…å¤‰æ›´ï¼šã‚ˆãä½¿ã†é …ç›®ON / æ—¥ä¸­æ”¯æ´ãƒªã‚¹ãƒˆåæ˜  / åˆ©ç”¨è€…åˆ¥ãƒ†ãƒ³ãƒ—ãƒ¬é¸æŠæ›´æ–°
      document.getElementById("resident")?.addEventListener("change", () => {
        const r = document.getElementById("resident").value;
        if (!r) return;
        applyDaySupportListsForResident(r);
        applyFavToMainCheckboxes(r);
        renderResidentTemplateSelectForForm();
      });

      // è‡ªå‹•
      document.getElementById("autoSupportBtn").addEventListener("click", generateSupportText);

      // ãƒ†ãƒ³ãƒ—ãƒ¬ï¼ˆå…±é€šï¼‰
      document.getElementById("templateApplyButton").addEventListener("click", handleTemplateApply);
      document.getElementById("templateSaveButton").addEventListener("click", handleTemplateSave);
      document.getElementById("templateDeleteButton").addEventListener("click", handleTemplateDelete);

      // è©³ç´°ãƒ¢ãƒ¼ãƒ€ãƒ«
      const detailModal = document.getElementById("detailModal");
      const detailModalClose = document.getElementById("detailModalClose");
      if (detailModal && detailModalClose) {
        detailModalClose.addEventListener("click", closeRecordDetail);
        detailModal.addEventListener("click", (e) => { if (e.target === detailModal) closeRecordDetail(); });
      }

      // ç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ«
      document.getElementById("editModalClose").addEventListener("click", closeEditModal);
      document.getElementById("editModalCancelBtn").addEventListener("click", closeEditModal);
      document.getElementById("editModalSaveBtn").addEventListener("click", saveEditModal);
      document.getElementById("editModal").addEventListener("click", (e) => { if (e.target.id === "editModal") closeEditModal(); });

      // ç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ«ï¼šåˆ©ç”¨è€…å¤‰æ›´æ™‚
      document.getElementById("editResident").addEventListener("change", () => {
        const res = document.getElementById("editResident").value;
        const mainChecked = Array.from(document.querySelectorAll(".edit-day-main-item:checked")).map(x => x.value);
        const reasonChecked = Array.from(document.querySelectorAll(".edit-day-reason-item:checked")).map(x => x.value);
        renderEditDaySupportCheckboxes(res, mainChecked, reasonChecked);
      });

      // åˆ©ç”¨è€…ç®¡ç†
      document.getElementById("residentAddButton").addEventListener("click", handleResidentAdd);
      document.getElementById("residentRenameButton").addEventListener("click", handleResidentRename);
      document.getElementById("residentDeleteButton").addEventListener("click", handleResidentDelete);

      // æ”¯æ´é …ç›®ç®¡ç†UI
      document.getElementById("autoItemSelect").addEventListener("change", fillAutoItemInputsBySelect);
      document.getElementById("autoItemSaveBtn").addEventListener("click", saveAutoItemFromInputs);
      document.getElementById("autoItemDeleteBtn").addEventListener("click", deleteSelectedAutoItem);
      document.getElementById("autoItemClearBtn").addEventListener("click", clearAutoItemInputs);
      document.getElementById("autoItemResetDefaultBtn").addEventListener("click", resetAutoItemsToDefault);

      // ã‚¿ã‚°ç®¡ç†UI
      renderTagManager();
      document.getElementById("tagSelect").addEventListener("change", fillTagInputBySelect);
      document.getElementById("tagSaveBtn").addEventListener("click", saveTagFromInputs);
      document.getElementById("tagDeleteBtn").addEventListener("click", deleteSelectedTag);
      document.getElementById("tagClearBtn").addEventListener("click", clearTagInputs);
      document.getElementById("tagResetDefaultBtn").addEventListener("click", resetTagsToDefault);

      // ã‚ˆãä½¿ã†é …ç›®ï¼ˆåˆ©ç”¨è€…åˆ¥ï¼‰
      document.getElementById("favResidentSelect").addEventListener("change", renderFavManager);
      document.getElementById("favSaveBtn").addEventListener("click", saveFavFromManager);
      document.getElementById("favApplyNowBtn").addEventListener("click", applyFavNowFromManager);
      document.getElementById("favClearBtn").addEventListener("click", clearFavChecks);

      // è‡ªå‹•ãƒ†ãƒ³ãƒ—ãƒ¬ï¼ˆåˆ©ç”¨è€…åˆ¥ï¼‰ç®¡ç†
      document.getElementById("rtResidentSelect").addEventListener("change", () => {
        renderResidentTemplateManager();
        document.getElementById("rtTemplateSelect").value = "";
        fillResidentTemplateManagerInputs();
      });
      document.getElementById("rtTemplateSelect").addEventListener("change", fillResidentTemplateManagerInputs);
      document.getElementById("rtSaveBtn").addEventListener("click", saveResidentTemplateFromManager);
      document.getElementById("rtSetDefaultBtn").addEventListener("click", setDefaultResidentTemplateFromManager);
      document.getElementById("rtDeleteBtn").addEventListener("click", deleteResidentTemplateFromManager);
      document.getElementById("rtClearBtn").addEventListener("click", clearResidentTemplateManagerInputs);

      // æ—¥ä¸­æ”¯æ´ãƒã‚§ãƒƒã‚¯ï¼ˆåˆ©ç”¨è€…åˆ¥ï¼‰ç®¡ç†
      document.getElementById("dsResidentSelect").addEventListener("change", renderDaySupportManager);
      document.getElementById("dsSaveBtn").addEventListener("click", saveDaySupportFromManager);
      document.getElementById("dsResetBtn").addEventListener("click", resetDaySupportToDefaultFromManager);

      // ===== ãƒ•ã‚©ãƒ¼ãƒ å´ãƒœã‚¿ãƒ³ï¼ˆå°çª“ï¼‰ =====
      document.getElementById("openFavModalBtn").addEventListener("click", openFavModalForCurrentResident);
      document.getElementById("favModalClose").addEventListener("click", () => document.getElementById("favModal").classList.remove("show"));
      document.getElementById("favModalCancel").addEventListener("click", () => document.getElementById("favModal").classList.remove("show"));
      document.getElementById("favModalSave").addEventListener("click", saveFavModal);
      document.getElementById("favModal").addEventListener("click", (e) => { if (e.target.id === "favModal") document.getElementById("favModal").classList.remove("show"); });

      // è‡ªå‹•ãƒ†ãƒ³ãƒ—ãƒ¬å°çª“ï¼ˆrtModalï¼‰
      document.getElementById("openResidentTemplateModalBtn").addEventListener("click", openResidentTemplateModalForCurrentResident);
      document.getElementById("rtModalClose").addEventListener("click", () => document.getElementById("rtModal").classList.remove("show"));
      document.getElementById("rtModalCloseBtn").addEventListener("click", () => document.getElementById("rtModal").classList.remove("show"));
      document.getElementById("rtModalSelect").addEventListener("change", fillResidentTemplateModalInputs);
      document.getElementById("rtModalSaveBtn").addEventListener("click", saveResidentTemplateModal);
      document.getElementById("rtModalSetDefaultBtn").addEventListener("click", setDefaultResidentTemplateModal);
      document.getElementById("rtModalDeleteBtn").addEventListener("click", deleteResidentTemplateModal);
      document.getElementById("rtModal").addEventListener("click", (e) => { if (e.target.id === "rtModal") document.getElementById("rtModal").classList.remove("show"); });

      // æ—¥ä¸­æ”¯æ´å°çª“ï¼ˆdsModalï¼‰
      document.getElementById("openDaySupportModalBtn").addEventListener("click", openDaySupportModalForCurrentResident);
      document.getElementById("dsModalClose").addEventListener("click", () => document.getElementById("dsModal").classList.remove("show"));
      document.getElementById("dsModalCloseBtn").addEventListener("click", () => document.getElementById("dsModal").classList.remove("show"));
      document.getElementById("dsModalSaveBtn").addEventListener("click", saveDaySupportModal);
      document.getElementById("dsModalResetBtn").addEventListener("click", resetDaySupportModalToDefault);
      document.getElementById("dsModal").addEventListener("click", (e) => { if (e.target.id === "dsModal") document.getElementById("dsModal").classList.remove("show"); });
    });
  

// ===== ãƒ‡ãƒ¼ã‚¿æ“ä½œï¼ˆãƒãƒƒã‚¯ã‚¢ãƒƒãƒ— / å¾©å…ƒ / ã‚¨ã‚¯ã‚»ãƒ«å‡ºåŠ›ï¼‰ =====
function getBackupKeys() {
  const keys = [];
  const add = (k) => { if (k && !keys.includes(k)) keys.push(k); };

  // æ—¢å­˜ã®å®šæ•°ã‚­ãƒ¼ï¼ˆã‚ã‚Œã°ï¼‰ã‚’å„ªå…ˆ
  try { add(STORAGE_KEY); } catch(e) {}
  try { add(FAVORITES_KEY); } catch(e) {}
  try { add(COMMON_TEMPLATES_KEY); } catch(e) {}
  try { add(AUTO_ITEM_DEFS_KEY); } catch(e) {}
  try { add(AUTO_ITEMS_BY_RESIDENT_KEY); } catch(e) {}
  try { add(CHECK_ITEMS_SELECTED_KEY); } catch(e) {}
  try { add(RECORD_ID_SEQ_KEY); } catch(e) {}
  try { add(LIST_SETTINGS_KEY); } catch(e) {}

  // å¿µã®ãŸã‚ prefix ã‚‚æ‹¾ã†
  for (let i = 0; i < localStorage.length; i++) {
    const k = localStorage.key(i);
    if (!k) continue;
    if (k.startsWith("gh_") || k.startsWith("group_home_")) add(k);
  }
  return keys;
}

function downloadBlob(filename, blob) {
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = filename;
  document.body.appendChild(a);
  a.click();
  setTimeout(() => {
    URL.revokeObjectURL(a.href);
    a.remove();
  }, 0);
}

function downloadJSON(filename, obj) {
  const blob = new Blob([JSON.stringify(obj, null, 2)], { type: "application/json;charset=utf-8" });
  downloadBlob(filename, blob);
}

function backupDataNow() {
  const keys = getBackupKeys();
  const data = {};
  keys.forEach((k) => { data[k] = localStorage.getItem(k); });

  const stamp = new Date();
  const y = stamp.getFullYear();
  const m = String(stamp.getMonth() + 1).padStart(2, "0");
  const d = String(stamp.getDate()).padStart(2, "0");
  const hh = String(stamp.getHours()).padStart(2, "0");
  const mm = String(stamp.getMinutes()).padStart(2, "0");
  const filename = `group_home_backup_${y}${m}${d}_${hh}${mm}.json`;

  downloadJSON(filename, {
    app: "group_home_personal_record",
    version: 1,
    exportedAt: stamp.toISOString(),
    keys,
    data
  });
}

function restoreFromBackupFile(file) {
  const reader = new FileReader();
  reader.onload = () => {
    let obj;
    try {
      obj = JSON.parse(String(reader.result || ""));
    } catch (e) {
      alert("ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—JSONã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚");
      return;
    }
    if (!obj || typeof obj !== "object" || !obj.data || typeof obj.data !== "object") {
      alert("ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—JSONã®å½¢å¼ãŒé•ã†ã‚ˆã†ã§ã™ã€‚");
      return;
    }

    const ok = confirm("ã“ã®ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã§ä¸Šæ›¸ãå¾©å…ƒã—ã¾ã™ã€‚ç¾åœ¨ã®ãƒ‡ãƒ¼ã‚¿ã¯ç½®ãæ›ã‚ã‚Šã¾ã™ã€‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ");
    if (!ok) return;

    const data = obj.data;
    Object.keys(data).forEach((k) => {
      const v = data[k];
      if (v === null || typeof v === "undefined") localStorage.removeItem(k);
      else localStorage.setItem(k, String(v));
    });

    alert("å¾©å…ƒã—ã¾ã—ãŸã€‚ãƒšãƒ¼ã‚¸ã‚’å†èª­ã¿è¾¼ã¿ã—ã¾ã™ã€‚");
    location.reload();
  };
  reader.readAsText(file, "utf-8");
}

function exportRecordsToExcel() {
  let records = [];
  try {
    records = loadRecords();
  } catch (e) {
    // fallback
    try {
      records = JSON.parse(localStorage.getItem("group_home_records_v1") || "[]");
    } catch (e2) { records = []; }
  }

  if (!records || records.length === 0) {
    alert("ã‚¨ã‚¯ã‚»ãƒ«ã«å‡ºåŠ›ã™ã‚‹è¨˜éŒ²ãŒã‚ã‚Šã¾ã›ã‚“ã€‚");
    return;
  }

  const rows = records.map((r) => ({
    "æ—¥ä»˜": r.date || "",
    "åˆ©ç”¨è€…": r.resident || "",
    "æ™‚é–“å¸¯": r.timeSlot || "",
    "ä½“èª¿ / å¿ƒã®çŠ¶æ…‹": [r.condition || "", r.mental || ""].filter(Boolean).join(" / "),
    "é£Ÿäº‹": r.meal || "",
    "æœè–¬": r.medTaken ? "æœè–¬æ¸ˆ" : "æœª",
    "æ—¥ä¸­ï¼ˆç¨®åˆ¥ï¼‰": r.daySupportType || "",
    "æ—¥ä¸­ï¼ˆã„ã¤é ƒï¼‰": r.daySupportTime || "",
    "æ—¥ä¸­ã«è¡Œã£ãŸä¸»ãªæ”¯æ´": Array.isArray(r.daySupportMainItems) ? r.daySupportMainItems.filter(Boolean).join("ã€") : (r.daySupportMainItems || ""),
    "æ—¥ä¸­ã«è¡Œã£ãŸä¸»ãªæ”¯æ´ï¼ˆç†ç”±ãªã©ï¼‰": Array.isArray(r.daySupportReasonItems) ? r.daySupportReasonItems.filter(Boolean).join("ã€") : (r.daySupportReasonItems || ""),
    "æœ¬æ—¥ã®æ”¯æ´å†…å®¹ãƒ»æ§˜å­": r.support || "",
    "ç‰¹è¨˜äº‹é …": r.note || "",
    "ã‚¿ã‚°": Array.isArray(r.tags) ? r.tags.filter(Boolean).join("ã€") : ""
  }));

  const stamp = new Date();
  const y = stamp.getFullYear();
  const m = String(stamp.getMonth() + 1).padStart(2, "0");
  const d = String(stamp.getDate()).padStart(2, "0");
  const filename = `group_home_records_${y}${m}${d}.xlsx`;

  // XLSX ãŒä½¿ãˆãªã„ç’°å¢ƒã¯CSVã§ä»£æ›¿
  const canXlsx = typeof XLSX !== "undefined" && XLSX.utils && XLSX.writeFile;
  if (!canXlsx) {
    const headers = Object.keys(rows[0] || {});
    const esc = (v) => `"${String(v ?? "").replace(/"/g, '""')}"`;
    const csv = [headers.map(esc).join(",")]
      .concat(rows.map((row) => headers.map((h) => esc(row[h])).join(",")))
      .join("\r\n");
    downloadBlob(filename.replace(/\.xlsx$/i, ".csv"), new Blob([csv], { type: "text/csv;charset=utf-8" }));
    return;
  }

  const ws = XLSX.utils.json_to_sheet(rows);
  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws, "è¨˜éŒ²");
  XLSX.writeFile(wb, filename);
}

function setupBackupRestoreExportButtons() {
  const backupBtn = document.getElementById("backupBtn");
  const restoreBtn = document.getElementById("restoreBtn");
  const exportBtn = document.getElementById("exportExcelBtn");
  const restoreInput = document.getElementById("restoreFileInput");

  if (backupBtn && !backupBtn.dataset.bound) {
    backupBtn.dataset.bound = "1";
    backupBtn.addEventListener("click", backupDataNow);
  }

  if (exportBtn && !exportBtn.dataset.bound) {
    exportBtn.dataset.bound = "1";
    exportBtn.addEventListener("click", exportRecordsToExcel);
  }

  if (restoreBtn && restoreInput && !restoreBtn.dataset.bound) {
    restoreBtn.dataset.bound = "1";
    restoreBtn.addEventListener("click", () => restoreInput.click());
    restoreInput.addEventListener("change", () => {
      const f = restoreInput.files && restoreInput.files[0];
      restoreInput.value = "";
      if (!f) return;
      restoreFromBackupFile(f);
    });
  }
}

document.addEventListener("DOMContentLoaded", setupBackupRestoreExportButtons);
</script>

  <!-- éŸ³å£°å…¥åŠ›ã‚¹ã‚¯ãƒªãƒ—ãƒˆï¼ˆãƒ¡ã‚¤ãƒ³ãƒ•ã‚©ãƒ¼ãƒ ï¼‰ -->
  <script>
    document.addEventListener("DOMContentLoaded", () => {
      const voiceBtn = document.getElementById("voiceSupportBtn");
      const voiceStatus = document.getElementById("voiceStatus");
      const support = document.getElementById("support");

      if (!voiceBtn || !voiceStatus || !support) return;

      const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;

      if (!SpeechRecognition) {
        voiceBtn.disabled = true;
        voiceStatus.textContent = "â€» ã“ã®ãƒ–ãƒ©ã‚¦ã‚¶ã§ã¯éŸ³å£°å…¥åŠ›ãŒä½¿ãˆã¾ã›ã‚“ï¼ˆChrome / Edge æ¨å¥¨ï¼‰";
        return;
      }

      const recognition = new SpeechRecognition();
      recognition.lang = "ja-JP";
      recognition.interimResults = true;
      recognition.continuous = true;

      let recognizing = false;

      voiceBtn.addEventListener("click", () => {
        if (!recognizing) {
          try { recognition.start(); } catch (e) {}
        } else {
          recognition.stop();
        }
      });

      recognition.addEventListener("start", () => {
        recognizing = true;
        voiceBtn.textContent = "â–  åœæ­¢";
        voiceStatus.textContent = "éŸ³å£°å…¥åŠ›ä¸­â€¦ è©±ã—çµ‚ã‚ã£ãŸã‚‰ã‚‚ã†ä¸€åº¦ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦åœæ­¢ã—ã¦ãã ã•ã„ã€‚";
      });

      recognition.addEventListener("end", () => {
        recognizing = false;
        voiceBtn.textContent = "ğŸ™ éŸ³å£°å…¥åŠ›";
        voiceStatus.textContent = "";
      });

      recognition.addEventListener("result", (event) => {
        let finalText = "";
        for (let i = event.resultIndex; i < event.results.length; i++) {
          const res = event.results[i];
          if (res.isFinal) finalText += res[0].transcript;
        }
        if (!finalText) return;

        if (support.value.trim()) support.value = support.value.replace(/\s*$/, "") + "\n" + finalText;
        else support.value = finalText;
      });

      recognition.addEventListener("error", (e) => {
        recognizing = false;
        voiceBtn.textContent = "ğŸ™ éŸ³å£°å…¥åŠ›";
        voiceStatus.textContent = "éŸ³å£°å…¥åŠ›ã‚¨ãƒ©ãƒ¼ï¼š" + e.error;
      });
    });
  </script>
</body>
</html>






