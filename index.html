<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>ã‚°ãƒ«ãƒ¼ãƒ—ãƒ›ãƒ¼ãƒ  å€‹äººè¨˜éŒ²</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <style>
    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      font-family: -apple-system, BlinkMacSystemFont, "Helvetica Neue",
        "YuGothic", "Meiryo", sans-serif;
      background: #f3f4f6;
      color: #111827;
    }

    header {
      background: #2563eb;
      color: white;
      padding: 14px 16px;
      font-size: 20px;
      font-weight: bold;
      text-align: center;
      position: sticky;
      top: 0;
      z-index: 10;
    }

    main {
      max-width: 1100px;
      margin: 0 auto;
      padding: 16px;
    }

    .layout {
      display: grid;
      grid-template-columns: minmax(0, 1.1fr) minmax(0, 1.5fr);
      gap: 16px;
    }

    @media (max-width: 800px) {
      .layout {
        grid-template-columns: 1fr;
      }
    }

    .card {
      background: white;
      border-radius: 16px;
      padding: 16px 18px 18px;
      box-shadow: 0 8px 20px rgba(15, 23, 42, 0.08);
      margin-bottom: 16px;
    }

    .card-title {
      font-size: 18px;
      font-weight: 600;
      margin-bottom: 12px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .card-subtitle {
      font-size: 12px;
      color: #6b7280;
      margin-bottom: 12px;
    }

    label {
      font-size: 13px;
      font-weight: 600;
      display: block;
      margin-bottom: 4px;
      color: #374151;
    }

    input[type="text"],
    input[type="date"],
    select,
    textarea {
      width: 100%;
      border-radius: 10px;
      border: 1px solid #d1d5db;
      padding: 8px 10px;
      font-size: 14px;
      outline: none;
      transition: border-color 0.15s, box-shadow 0.15s;
      background: #f9fafb;
    }

    input[type="text"]:focus,
    input[type="date"]:focus,
    select:focus,
    textarea:focus {
      border-color: #2563eb;
      box-shadow: 0 0 0 1px rgba(37, 99, 235, 0.5);
      background: white;
    }

    textarea {
      min-height: 70px;
      resize: vertical;
    }

    .field-row {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 10px;
    }

    .field-row-3 {
      display: grid;
      grid-template-columns: repeat(3, minmax(0, 1fr));
      gap: 10px;
    }

    .field {
      margin-bottom: 10px;
    }

    .checkbox-row {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      align-items: center;
      margin-bottom: 6px;
    }

    .checkbox-row label {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      font-weight: 500;
      font-size: 13px;
      margin-bottom: 0;
    }

    .btn-row {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-top: 10px;
    }

    button {
      border: none;
      border-radius: 999px;
      padding: 8px 16px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: transform 0.05s ease-out, box-shadow 0.1s;
      display: inline-flex;
      align-items: center;
      gap: 4px;
    }

    button:active {
      transform: translateY(1px);
      box-shadow: none;
    }

    .btn-primary {
      background: #2563eb;
      color: white;
      box-shadow: 0 4px 10px rgba(37, 99, 235, 0.35);
    }

    .btn-secondary {
      background: #e5e7eb;
      color: #111827;
    }

    .btn-danger {
      background: #dc2626;
      color: white;
    }

    .pill {
      border-radius: 999px;
      background: #eff6ff;
      padding: 3px 10px;
      font-size: 11px;
      color: #1d4ed8;
      border: 1px solid #bfdbfe;
    }

    .record-count {
      font-size: 12px;
      color: #6b7280;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 12px;
      margin-top: 4px;
    }

    thead {
      position: sticky;
      top: 0;
      background: #eff6ff;
      z-index: 1;
    }

    th,
    td {
      border-bottom: 1px solid #e5e7eb;
      padding: 6px 4px;
      text-align: left;
      vertical-align: top;
    }

    th {
      font-weight: 600;
      color: #374151;
      white-space: nowrap;
    }

    tbody tr:nth-child(even) {
      background: #f9fafb;
    }

    .table-wrapper {
      max-height: 480px;
      overflow: auto;
      border-radius: 12px;
      border: 1px solid #e5e7eb;
      margin-top: 8px;
    }

    .badge {
      display: inline-block;
      padding: 2px 8px;
      border-radius: 999px;
      font-size: 10px;
      font-weight: 600;
      color: white;
    }

    .badge-day {
      background: #22c55e;
    }

    .badge-evening {
      background: #f59e0b;
    }

    .badge-night {
      background: #6366f1;
    }

    .small-text {
      font-size: 11px;
      color: #6b7280;
    }

    .no-records {
      padding: 12px;
      font-size: 13px;
      color: #6b7280;
      text-align: center;
    }

    .resident-select-row {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      margin-bottom: 8px;
      align-items: center;
    }

    .resident-select-row span {
      font-size: 12px;
      color: #4b5563;
    }

    .resident-select-row select {
      max-width: 220px;
    }

    /* ã‚¿ã‚°ãƒœã‚¿ãƒ³ã¾ã‚ã‚Š */
    .tag-buttons {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      margin-bottom: 4px;
    }

    .tag-button {
      border-radius: 999px;
      border: 1px solid #e5e7eb;
      background: #f3f4f6;
      padding: 3px 10px;
      font-size: 11px;
      cursor: pointer;
    }

    .tag-button.tag-button-active {
      background: #f59e0b;
      border-color: #f97316;
      color: #fff;
    }

    .tag-chip {
      display: inline-block;
      margin-top: 2px;
      margin-right: 4px;
      padding: 1px 6px;
      border-radius: 999px;
      border: 1px solid #fde68a;
      background: #fffbeb;
      font-size: 10px;
    }
  </style>
</head>
<body>
  <header>ã‚°ãƒ«ãƒ¼ãƒ—ãƒ›ãƒ¼ãƒ  å€‹äººè¨˜éŒ² WEBã‚¢ãƒ—ãƒªï¼ˆã‚¿ã‚°ãƒ»æ¤œç´¢ä»˜ãï¼‰</header>

  <main>
    <div class="layout">
      <!-- å…¥åŠ›ãƒ•ã‚©ãƒ¼ãƒ  -->
      <section class="card">
        <div class="card-title">
          <span>ä»Šæ—¥ã®å€‹äººè¨˜éŒ²</span>
          <span class="pill" id="modeLabel">æ–°è¦å…¥åŠ›ãƒ¢ãƒ¼ãƒ‰</span>
        </div>
        <div class="card-subtitle">
          åˆ©ç”¨è€…ã‚’é¸ã³ã€æ—¥ä¸­ã®æ§˜å­ãƒ»æ”¯æ´å†…å®¹ãƒ»æœè–¬çŠ¶æ³ãªã©ã‚’è¨˜éŒ²ã—ã¾ã™ã€‚
          ãƒ–ãƒ©ã‚¦ã‚¶å†…ã«è‡ªå‹•ä¿å­˜ã•ã‚Œã¾ã™ï¼ˆlocalStorageï¼‰ã€‚
        </div>

        <form id="recordForm">
          <div class="field-row">
            <div class="field">
              <label for="date">æ—¥ä»˜</label>
              <input type="date" id="date" required />
            </div>
            <div class="field">
              <label for="resident">åˆ©ç”¨è€…</label>
              <select id="resident" required>
                <!-- JSã§æŒ¿å…¥ -->
              </select>
            </div>
          </div>

          <div class="field-row-3">
            <div class="field">
              <label for="timeSlot">æ™‚é–“å¸¯</label>
              <select id="timeSlot">
                <option>æ—¥ä¸­</option>
                <option>å¤•æ–¹</option>
                <option>å¤œé–“</option>
              </select>
            </div>
            <div class="field">
              <label for="condition">ä½“èª¿</label>
              <select id="condition">
                <option>è‰¯å¥½</option>
                <option>æ™®é€š</option>
                <option>ä¸è‰¯</option>
              </select>
            </div>
            <div class="field">
              <label for="mental">å¿ƒã®çŠ¶æ…‹</label>
              <select id="mental">
                <option>å®‰å®š</option>
                <option>ã‚„ã‚„ä¸å®‰</option>
                <option>ä¸å®‰å®š</option>
              </select>
            </div>
          </div>

          <div class="field">
            <label for="meal">é£Ÿäº‹ã®æ§˜å­ï¼ˆæœãƒ»æ˜¼ãƒ»å¤• / æ‘‚å–é‡ãªã©ï¼‰</label>
            <input
              type="text"
              id="meal"
              placeholder="ä¾‹ï¼‰æœï¼šå®Œé£Ÿ / æ˜¼ï¼š7å‰² / å¤•ï¼šå°‘ãªã‚ ãªã©"
            />
          </div>

          <div class="field">
            <div class="checkbox-row">
              <label>
                <input type="checkbox" id="medTaken" />
                æœè–¬æ¸ˆã¿
              </label>
              <span class="small-text">
                ï¼ˆæœè–¬çŠ¶æ³ã®ãƒã‚§ãƒƒã‚¯ã‚„ã€é£²ã¿å¿˜ã‚Œãªã©ãŒã‚ã‚Œã°ä¸‹ã®æ”¯æ´å†…å®¹ã«è¨˜å…¥ï¼‰
              </span>
            </div>
          </div>

          <div class="field">
            <label>ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ï¼ˆã‚¿ã‚°ï¼‰</label>
            <div class="tag-buttons" id="tagButtons">
              <!-- JSã§æŒ¿å…¥ -->
            </div>
            <div class="small-text" id="selectedTagsInfo">
              é¸æŠä¸­ï¼šãªã—
            </div>
          </div>

          <<div class="field">
  <label for="support">æœ¬æ—¥ã®æ”¯æ´å†…å®¹ãƒ»æ§˜å­</label>
  <textarea
    id="support"
    rows="8"
    placeholder="ã€æ¨™æº–ã®æ›¸ãæ–¹ä¾‹ã€‘
æ—¥ä¸­ã¯è½ã¡ç€ã„ã¦ç©ã‚„ã‹ã«éã”ã•ã‚Œã‚‹ã€‚é£Ÿäº‹ãƒ»æœè–¬ã¨ã‚‚ã«è¦‹å®ˆã‚Šä¸­å¿ƒã§å®Ÿæ–½ã€‚
å¿…è¦æ™‚ã®ã¿å£°ã‹ã‘ãƒ»ä»‹åŠ©ã‚’è¡Œã£ãŸã€‚"
  ></textarea>
</div>

          <div class="field">
            <label for="note">ç‰¹è¨˜äº‹é …ï¼ˆäº‹æ•…ãƒ»ãƒˆãƒ©ãƒ–ãƒ«ãƒ»å—è¨ºãƒ»ç›¸è«‡ãªã©ï¼‰</label>
            <textarea
              id="note"
              placeholder="ä¾‹ï¼‰é€šé™¢ã€å®¶æ—ã‹ã‚‰ã®é›»è©±ã€å¤œé–“ã®è¦‹å®ˆã‚Šå¼·åŒ–ãŒå¿…è¦ ãªã©"
            ></textarea>
          </div>

          <div class="btn-row">
            <button type="submit" class="btn-primary" id="saveButton">
              ğŸ’¾ è¨˜éŒ²ã‚’ä¿å­˜
            </button>
            <button type="button" class="btn-secondary" id="resetButton">
              ğŸ§¹ å…¥åŠ›ãƒªã‚»ãƒƒãƒˆ
            </button>
          </div>
        </form>
      </section>

      <!-- ä¸€è¦§è¡¨ç¤º -->
      <section class="card">
        <div class="card-title">
          <span>è¨˜éŒ²ä¸€è¦§</span>
          <span class="record-count" id="recordCount">0ä»¶</span>
        </div>

        <div class="resident-select-row">
          <span>è¡¨ç¤ºã™ã‚‹åˆ©ç”¨è€…ï¼š</span>
          <select id="filterResident">
            <!-- JSã§æŒ¿å…¥ -->
          </select>
          <span class="small-text">
            â€»ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã‚’å¤‰ãˆã‚‹ã¨ã€ãã®åˆ©ç”¨è€…ã®è¨˜éŒ²ã ã‘è¡¨ç¤ºã•ã‚Œã¾ã™ã€‚
          </span>
        </div>

        <div class="resident-select-row">
          <span>ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰æ¤œç´¢ï¼š</span>
          <input
            type="text"
            id="searchKeyword"
            placeholder="ä¾‹ï¼šé€šé™¢, å¤œé–“, #ä½“èª¿ä¸è‰¯ ãªã©"
            style="flex:1; min-width:160px;"
          />
          <button type="button" class="btn-secondary" id="searchClearButton">
            ã‚¯ãƒªã‚¢
          </button>
        </div>

        <div class="table-wrapper" id="tableWrapper">
          <table>
            <thead>
              <tr>
                <th>æ—¥ä»˜</th>
                <th>åˆ©ç”¨è€…</th>
                <th>æ™‚é–“å¸¯</th>
                <th>ä½“èª¿ / å¿ƒã®çŠ¶æ…‹</th>
                <th>æ”¯æ´å†…å®¹ãƒ»ã‚¿ã‚°</th>
                <th>æœè–¬</th>
                <th>æ“ä½œ</th>
              </tr>
            </thead>
            <tbody id="recordTableBody">
              <!-- JSã§æŒ¿å…¥ -->
            </tbody>
          </table>
        </div>
      </section>
    </div>

    <!-- åˆ©ç”¨è€…ç®¡ç† -->
    <section class="card">
      <div class="card-title">
        <span>åˆ©ç”¨è€…ç®¡ç†</span>
        <span class="record-count" id="residentCount">0å</span>
      </div>
      <div class="card-subtitle">
        åˆ©ç”¨è€…åã®è¿½åŠ ãƒ»å¤‰æ›´ãƒ»å‰Šé™¤ã‚’è¡Œã„ã¾ã™ã€‚ã“ã“ã§å¤‰æ›´ã™ã‚‹ã¨ã€è¨˜éŒ²ä¸€è¦§ã®è¡¨ç¤ºã«ã‚‚åæ˜ ã•ã‚Œã¾ã™ã€‚
      </div>

      <div class="field-row">
        <div class="field">
          <label for="residentManageSelect">å¯¾è±¡ã®åˆ©ç”¨è€…</label>
          <select id="residentManageSelect">
            <!-- JSã§æŒ¿å…¥ -->
          </select>
        </div>
        <div class="field">
          <label for="residentNameInput">åå‰ï¼ˆè¿½åŠ ãƒ»å¤‰æ›´å¾Œï¼‰</label>
          <input
            type="text"
            id="residentNameInput"
            placeholder="ä¾‹ï¼šAã•ã‚“"
          />
        </div>
      </div>

      <div class="btn-row">
        <button type="button" class="btn-primary" id="residentAddButton">
          ï¼‹ æ–°ã—ãè¿½åŠ 
        </button>
        <button type="button" class="btn-secondary" id="residentRenameButton">
          âœï¸ é¸æŠã‚’ã“ã®åå‰ã«å¤‰æ›´
        </button>
        <button type="button" class="btn-danger" id="residentDeleteButton">
          ğŸ—‘ï¸ åˆ©ç”¨è€…ã¨è¨˜éŒ²ã‚’å‰Šé™¤
        </button>
      </div>
      <div class="small-text" style="margin-top:6px;">
        â€»å‰Šé™¤ã™ã‚‹ã¨ã€ãã®åˆ©ç”¨è€…ã®ã™ã¹ã¦ã®è¨˜éŒ²ã‚‚å‰Šé™¤ã•ã‚Œã¾ã™ã€‚
      </div>
    </section>
  </main>

  <script>
    const STORAGE_KEY = "group_home_records_v1";
    const RESIDENTS_KEY = "group_home_residents_v1";

    // ã‚¿ã‚°å€™è£œï¼ˆå¿…è¦ã«å¿œã˜ã¦ã“ã“ã‚’æ›¸ãæ›ãˆã‚Œã°OKï¼‰
    const TAG_LIST = [
      "æœè–¬",
      "é€šé™¢",
      "å…¥æµ´",
      "å¤–å‡º",
      "ä½“èª¿ä¸è‰¯",
      "ç›¸è«‡",
      "ä»•äº‹",
      "æƒé™¤",
      "é‡‘éŠ­",
      "å¤œé–“å¯¾å¿œ",
    ];

    /** @type {Array} */
    let records = [];
    /** @type {Array<string>} */
    let residents = [];
    /** @type {Array<string>} */
    let currentTags = [];
    let editingIndex = null; // null ã®ã¨ãã¯æ–°è¦ã€ãã‚Œä»¥å¤–ã¯ç·¨é›†

    function loadRecords() {
      try {
        const raw = localStorage.getItem(STORAGE_KEY);
        if (!raw) return [];
        const parsed = JSON.parse(raw);
        if (!Array.isArray(parsed)) return [];
        return parsed;
      } catch (e) {
        console.error("load error", e);
        return [];
      }
    }

    function saveRecords() {
      localStorage.setItem(STORAGE_KEY, JSON.stringify(records));
    }

    function loadResidents() {
      try {
        const raw = localStorage.getItem(RESIDENTS_KEY);
        if (raw) {
          const parsed = JSON.parse(raw);
          if (Array.isArray(parsed) && parsed.length > 0) {
            return parsed;
          }
        }
      } catch (e) {
        console.error("load residents error", e);
      }

      // è¨˜éŒ²ã‹ã‚‰è‡ªå‹•ç”Ÿæˆ
      const fromRecords = Array.from(
        new Set(records.map((r) => r.resident).filter(Boolean))
      );
      if (fromRecords.length > 0) {
        return fromRecords;
      }

      // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ
      return [
        "åˆ©ç”¨è€…A",
        "åˆ©ç”¨è€…B",
        "åˆ©ç”¨è€…C",
        "åˆ©ç”¨è€…D",
        "åˆ©ç”¨è€…E",
        "åˆ©ç”¨è€…F",
        "åˆ©ç”¨è€…G",
      ];
    }

    function saveResidents() {
      localStorage.setItem(RESIDENTS_KEY, JSON.stringify(residents));
    }

    function renderResidentSelects() {
      const residentSelect = document.getElementById("resident");
      const filterSelect = document.getElementById("filterResident");
      const manageSelect = document.getElementById("residentManageSelect");
      const residentCountLabel = document.getElementById("residentCount");

      if (residentCountLabel) {
        residentCountLabel.textContent = residents.length + "å";
      }

      if (residentSelect) {
        const current = residentSelect.value;
        residentSelect.innerHTML = "";
        const placeholder = document.createElement("option");
        placeholder.value = "";
        placeholder.textContent = "é¸æŠã—ã¦ãã ã•ã„";
        residentSelect.appendChild(placeholder);
        residents.forEach((name) => {
          const opt = document.createElement("option");
          opt.value = name;
          opt.textContent = name;
          residentSelect.appendChild(opt);
        });
        if (current && residents.includes(current)) {
          residentSelect.value = current;
        } else {
          residentSelect.value = "";
        }
      }

      if (filterSelect) {
        const current = filterSelect.value;
        filterSelect.innerHTML = "";
        const optAll = document.createElement("option");
        optAll.value = "";
        optAll.textContent = "å…¨å“¡";
        filterSelect.appendChild(optAll);
        residents.forEach((name) => {
          const opt = document.createElement("option");
          opt.value = name;
          opt.textContent = name;
          filterSelect.appendChild(opt);
        });
        if (current && residents.includes(current)) {
          filterSelect.value = current;
        } else {
          filterSelect.value = "";
        }
      }

      if (manageSelect) {
        const current = manageSelect.value;
        manageSelect.innerHTML = "";
        const placeholder = document.createElement("option");
        placeholder.value = "";
        placeholder.textContent = "é¸æŠã—ã¦ãã ã•ã„";
        manageSelect.appendChild(placeholder);
        residents.forEach((name) => {
          const opt = document.createElement("option");
          opt.value = name;
          opt.textContent = name;
          manageSelect.appendChild(opt);
        });
        if (current && residents.includes(current)) {
          manageSelect.value = current;
        } else {
          manageSelect.value = "";
        }
      }
    }

    function formatSupportSummary(text) {
      if (!text) return "";
      const trimmed = text.trim().replace(/\s+/g, " ");
      if (trimmed.length <= 30) return trimmed;
      return trimmed.slice(0, 30) + "â€¦";
    }

    function renderRecords() {
      const tbody = document.getElementById("recordTableBody");
      const filterResident = document.getElementById("filterResident").value;
      const keyword = document
        .getElementById("searchKeyword")
        .value.trim()
        .toLowerCase();
      tbody.innerHTML = "";

      const filtered = records.filter((r) => {
        if (filterResident && r.resident !== filterResident) return false;
        if (!keyword) return true;

        const tagsText = (r.tags || []).join(" ");
        const target =
          ((r.support || "") +
            " " +
            (r.note || "") +
            " " +
            (r.meal || "") +
            " " +
            tagsText)
            .toLowerCase();

        return target.includes(keyword);
      });

      document.getElementById("recordCount").textContent =
        filtered.length + "ä»¶";

      if (filtered.length === 0) {
        const tr = document.createElement("tr");
        const td = document.createElement("td");
        td.colSpan = 7;
        td.className = "no-records";
        td.textContent = "ã¾ã è¨˜éŒ²ãŒã‚ã‚Šã¾ã›ã‚“ã€‚å·¦ã®ãƒ•ã‚©ãƒ¼ãƒ ã‹ã‚‰ç™»éŒ²ã—ã¦ãã ã•ã„ã€‚";
        tr.appendChild(td);
        tbody.appendChild(tr);
        return;
      }

      filtered
        .slice()
        .sort((a, b) => (a.date < b.date ? 1 : -1)) // æ–°ã—ã„æ—¥ä»˜ã‚’ä¸Šã«
        .forEach((record) => {
          const tr = document.createElement("tr");

          const tdDate = document.createElement("td");
          tdDate.textContent = record.date || "";
          tr.appendChild(tdDate);

          const tdResident = document.createElement("td");
          tdResident.textContent = record.resident || "";
          tr.appendChild(tdResident);

          const tdTime = document.createElement("td");
          const span = document.createElement("span");
          span.textContent = record.timeSlot || "";
          span.className = "badge " + getTimeBadgeClass(record.timeSlot);
          tdTime.appendChild(span);
          tr.appendChild(tdTime);

          const tdCond = document.createElement("td");
          tdCond.innerHTML =
            (record.condition || "") +
            "<br><span class='small-text'>" +
            (record.mental || "") +
            "</span>";
          tr.appendChild(tdCond);

          const tdSupport = document.createElement("td");
          tdSupport.textContent = formatSupportSummary(record.support);

          if (record.tags && record.tags.length) {
            const tagDiv = document.createElement("div");
            tagDiv.className = "small-text";
            record.tags.forEach((tag) => {
              const spanTag = document.createElement("span");
              spanTag.className = "tag-chip";
              spanTag.textContent = "#" + tag;
              tagDiv.appendChild(spanTag);
            });
            tdSupport.appendChild(document.createElement("br"));
            tdSupport.appendChild(tagDiv);
          }

          tr.appendChild(tdSupport);

          const tdMed = document.createElement("td");
          tdMed.textContent = record.medTaken ? "æœè–¬æ¸ˆã¿" : "";
          tr.appendChild(tdMed);

          const tdActions = document.createElement("td");
          const editBtn = document.createElement("button");
          editBtn.textContent = "ç·¨é›†";
          editBtn.className = "btn-secondary";
          editBtn.style.fontSize = "11px";
          editBtn.onclick = () => startEdit(record.id);

          const delBtn = document.createElement("button");
          delBtn.textContent = "å‰Šé™¤";
          delBtn.className = "btn-danger";
          delBtn.style.fontSize = "11px";
          delBtn.onclick = () => deleteRecord(record.id);

          tdActions.appendChild(editBtn);
          tdActions.appendChild(delBtn);
          tr.appendChild(tdActions);

          tbody.appendChild(tr);
        });
    }

    function getTimeBadgeClass(timeSlot) {
      switch (timeSlot) {
        case "æ—¥ä¸­":
          return "badge-day";
        case "å¤•æ–¹":
          return "badge-evening";
        case "å¤œé–“":
          return "badge-night";
        default:
          return "badge-day";
      }
    }

    function resetForm() {
      document.getElementById("recordForm").reset();
      // æ—¥ä»˜ã¯ä»Šæ—¥ã«æˆ»ã™
      document.getElementById("date").value = new Date()
        .toISOString()
        .slice(0, 10);
      document.getElementById("timeSlot").value = "æ—¥ä¸­";
      document.getElementById("condition").value = "è‰¯å¥½";
      document.getElementById("mental").value = "å®‰å®š";
      document.getElementById("medTaken").checked = false;

      editingIndex = null;
      currentTags = [];
      updateTagUI();

      document.getElementById("modeLabel").textContent = "æ–°è¦å…¥åŠ›ãƒ¢ãƒ¼ãƒ‰";
      document.getElementById("modeLabel").style.background = "#eff6ff";
      document.getElementById("modeLabel").style.color = "#1d4ed8";
      document.getElementById("saveButton").textContent = "ğŸ’¾ è¨˜éŒ²ã‚’ä¿å­˜";
    }

    function startEdit(id) {
      const index = records.findIndex((r) => r.id === id);
      if (index === -1) return;

      const r = records[index];

      if (r.resident && !residents.includes(r.resident)) {
        residents.push(r.resident);
        saveResidents();
        renderResidentSelects();
      }

      editingIndex = index;

      document.getElementById("date").value = r.date || "";
      document.getElementById("resident").value = r.resident || "";
      document.getElementById("timeSlot").value = r.timeSlot || "æ—¥ä¸­";
      document.getElementById("condition").value = r.condition || "è‰¯å¥½";
      document.getElementById("mental").value = r.mental || "å®‰å®š";
      document.getElementById("meal").value = r.meal || "";
      document.getElementById("medTaken").checked = !!r.medTaken;
      document.getElementById("support").value = r.support || "";
      document.getElementById("note").value = r.note || "";

      currentTags = Array.isArray(r.tags) ? [...r.tags] : [];
      updateTagUI();

      document.getElementById("modeLabel").textContent =
        "ç·¨é›†ãƒ¢ãƒ¼ãƒ‰ï¼ˆä¸Šæ›¸ãä¿å­˜ï¼‰";
      document.getElementById("modeLabel").style.background = "#fee2e2";
      document.getElementById("modeLabel").style.color = "#b91c1c";
      document.getElementById("saveButton").textContent = "âœï¸ ã“ã®å†…å®¹ã§ä¸Šæ›¸ã";
    }

    function deleteRecord(id) {
      if (!confirm("ã“ã®è¨˜éŒ²ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")) return;
      records = records.filter((r) => r.id !== id);
      saveRecords();
      renderRecords();
      if (editingIndex !== null) {
        resetForm();
      }
    }

    function handleSubmit(event) {
      event.preventDefault();

      const date = document.getElementById("date").value;
      const resident = document.getElementById("resident").value;
      if (!date || !resident) {
        alert("æ—¥ä»˜ã¨åˆ©ç”¨è€…ã¯å¿…é ˆã§ã™ã€‚");
        return;
      }

      const recordData = {
        id:
          editingIndex !== null
            ? records[editingIndex].id
            : Date.now().toString(),
        date,
        resident,
        timeSlot: document.getElementById("timeSlot").value,
        condition: document.getElementById("condition").value,
        mental: document.getElementById("mental").value,
        meal: document.getElementById("meal").value,
        medTaken: document.getElementById("medTaken").checked,
        support: document.getElementById("support").value,
        note: document.getElementById("note").value,
        tags: [...currentTags],
      };

      if (editingIndex !== null) {
        records[editingIndex] = recordData;
      } else {
        records.push(recordData);
      }

      saveRecords();
      renderRecords();
      resetForm();
    }

    // ===== ã‚¿ã‚°ãƒœã‚¿ãƒ³ã¾ã‚ã‚Š =====
    function setupTagButtons() {
      const container = document.getElementById("tagButtons");
      container.innerHTML = "";
      TAG_LIST.forEach((tag) => {
        const btn = document.createElement("button");
        btn.type = "button";
        btn.className = "tag-button";
        btn.textContent = "#" + tag;
        btn.dataset.tag = tag;
        btn.addEventListener("click", () => toggleTag(tag));
        container.appendChild(btn);
      });
      updateTagUI();
    }

    function toggleTag(tag) {
      const idx = currentTags.indexOf(tag);
      if (idx >= 0) {
        currentTags.splice(idx, 1);
      } else {
        currentTags.push(tag);
      }
      updateTagUI();
    }

    function updateTagUI() {
      const info = document.getElementById("selectedTagsInfo");
      if (!info) return;

      if (currentTags.length === 0) {
        info.textContent = "é¸æŠä¸­ï¼šãªã—";
      } else {
        info.textContent =
          "é¸æŠä¸­ï¼š " + currentTags.map((t) => "#" + t).join(" ");
      }

      const buttons = document.querySelectorAll(".tag-button");
      buttons.forEach((btn) => {
        const t = btn.dataset.tag;
        if (currentTags.includes(t)) {
          btn.classList.add("tag-button-active");
        } else {
          btn.classList.remove("tag-button-active");
        }
      });
    }

    // ===== åˆ©ç”¨è€…ç®¡ç†ãƒœã‚¿ãƒ³ =====
    function handleResidentAdd() {
      const nameInput = document.getElementById("residentNameInput");
      const name = nameInput.value.trim();
      if (!name) {
        alert("è¿½åŠ ã™ã‚‹åå‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚");
        return;
      }
      if (residents.includes(name)) {
        alert("åŒã˜åå‰ã®åˆ©ç”¨è€…ãŒã™ã§ã«å­˜åœ¨ã—ã¾ã™ã€‚");
        return;
      }
      residents.push(name);
      saveResidents();
      renderResidentSelects();
      nameInput.value = "";
      alert("åˆ©ç”¨è€…ã‚’è¿½åŠ ã—ã¾ã—ãŸã€‚");
    }

    function handleResidentRename() {
      const manageSelect = document.getElementById("residentManageSelect");
      const oldName = manageSelect.value;
      const nameInput = document.getElementById("residentNameInput");
      const newName = nameInput.value.trim();

      if (!oldName) {
        alert("å¤‰æ›´ã™ã‚‹åˆ©ç”¨è€…ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚");
        return;
      }
      if (!newName) {
        alert("æ–°ã—ã„åå‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚");
        return;
      }
      if (oldName === newName) {
        alert("åŒã˜åå‰ã§ã™ã€‚");
        return;
      }
      if (residents.includes(newName)) {
        const ok = confirm(
          "åŒã˜åå‰ã®åˆ©ç”¨è€…ãŒã™ã§ã«å­˜åœ¨ã—ã¾ã™ã€‚çµ±åˆã—ã¾ã™ã‹ï¼Ÿ"
        );
        if (!ok) return;
      }

      residents = residents.map((n) => (n === oldName ? newName : n));
      records = records.map((r) =>
        r.resident === oldName ? { ...r, resident: newName } : r
      );

      saveResidents();
      saveRecords();
      renderResidentSelects();
      renderRecords();
      nameInput.value = "";
      alert("åˆ©ç”¨è€…åã‚’å¤‰æ›´ã—ã¾ã—ãŸã€‚");
    }

    function handleResidentDelete() {
      const manageSelect = document.getElementById("residentManageSelect");
      const target = manageSelect.value;
      if (!target) {
        alert("å‰Šé™¤ã™ã‚‹åˆ©ç”¨è€…ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚");
        return;
      }
      const ok = confirm(
        target +
          " ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ\nã“ã®åˆ©ç”¨è€…ã®ã™ã¹ã¦ã®è¨˜éŒ²ã‚‚å‰Šé™¤ã•ã‚Œã¾ã™ã€‚"
      );
      if (!ok) return;

      residents = residents.filter((n) => n !== target);
      records = records.filter((r) => r.resident !== target);

      saveResidents();
      saveRecords();
      renderResidentSelects();
      renderRecords();
      document.getElementById("residentNameInput").value = "";
      alert("å‰Šé™¤ã—ã¾ã—ãŸã€‚");
    }

    document.addEventListener("DOMContentLoaded", () => {
      // ä»Šæ—¥ã®æ—¥ä»˜ã‚’åˆæœŸå€¤ã«
      document.getElementById("date").value = new Date()
        .toISOString()
        .slice(0, 10);

      records = loadRecords();
      residents = loadResidents();

      renderResidentSelects();
      renderRecords();
      setupTagButtons();
      updateTagUI();

      document
        .getElementById("recordForm")
        .addEventListener("submit", handleSubmit);

      document
        .getElementById("resetButton")
        .addEventListener("click", resetForm);

      document
        .getElementById("filterResident")
        .addEventListener("change", renderRecords);

      document
        .getElementById("searchKeyword")
        .addEventListener("input", renderRecords);

      document
        .getElementById("searchClearButton")
        .addEventListener("click", () => {
          document.getElementById("searchKeyword").value = "";
          renderRecords();
        });

      document
        .getElementById("residentAddButton")
        .addEventListener("click", handleResidentAdd);

      document
        .getElementById("residentRenameButton")
        .addEventListener("click", handleResidentRename);

      document
        .getElementById("residentDeleteButton")
        .addEventListener("click", handleResidentDelete);
    });
  </script>
</body>
</html>

