<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>ã‚°ãƒ«ãƒ¼ãƒ—ãƒ›ãƒ¼ãƒ  å€‹äººè¨˜éŒ²</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <style>
    * { box-sizing: border-box; }
/* è¨˜éŒ²ä¸€è¦§ï¼šæ”¯æ´å†…å®¹ã‚’â€œæŠ˜ã‚ŠãŸãŸã¿â†’ã‚‚ã£ã¨è¦‹ã‚‹â€ */
.support-preview{
  white-space: pre-wrap;     /* æ”¹è¡Œã‚’ãã®ã¾ã¾è¡¨ç¤º */
  word-break: break-word;    /* é•·ã„æ–‡ç« ã‚‚æŠ˜ã‚Šè¿”ã™ */
  overflow: hidden;
  max-height: 5.2em;         /* â†æœ€åˆã¯ã“ã®é«˜ã•ã¾ã§ï¼ˆç´„3è¡Œï¼‰ */
}
.support-preview.expanded{
  max-height: none;          /* ã‚‚ã£ã¨è¦‹ã‚‹â†’å…¨æ–‡è¡¨ç¤º */
}

.support-toggle{
  border: none;
  background: transparent;
  padding: 0;
  margin-top: 6px;
  font-size: 12px;
  cursor: pointer;
  text-decoration: underline;
  color: #2563eb;
}

/* ãƒã‚¤ã‚¿ãƒ«ï¼ˆä½“é‡ãƒ»è¡€åœ§ãƒ»è„ˆæ‹ï¼‰ï¼šã‚³ãƒ³ãƒ‘ã‚¯ãƒˆè¡¨ç¤º */
.vitals-compact{ margin-top:8px; }
.vitals-compact .vitals-title{ font-weight:700; font-size:13px; margin-bottom:4px; }
.vitals-compact label{ font-size:12px; }
.vitals-compact input{ padding:6px 8px; font-size:13px; height:34px; }
.vitals-compact .small-text{ font-size:11px; margin-top:4px; }



/* æ›œæ—¥ã‚«ãƒ©ãƒ¼ï¼ˆä¸€è¦§ï¼šæ—¥ä»˜ï¼‰ */
.dow-sun{ color:#dc2626; font-weight:800; }
.dow-sat{ color:#2563eb; font-weight:800; }
    /* æ—¥ä»˜ã‚»ãƒ«ï¼šæ›œæ—¥ã‚’æ—¥ä»˜ã®ä¸‹ã«è¡¨ç¤ºï¼ˆé‡ãªã‚Šé˜²æ­¢ï¼‰ */
    .date-cell { white-space: normal !important; line-height: 1.2; }
    .date-dow { font-size: 12px; margin-top: 2px; line-height: 1; }



    body {
      margin: 0;
      font-family: -apple-system, BlinkMacSystemFont, "Helvetica Neue",
        "YuGothic", "Meiryo", sans-serif;
      background: #f3f4f6;
      color: #111827;
      font-size: 16px;
      line-height: 1.6;
    }

    header {
      background: #2563eb;
      color: white;
      padding: 16px 18px;
      font-size: 22px;
      font-weight: bold;
      text-align: center;
      position: sticky;
      top: 0;
      z-index: 10;
    }

    main {
      max-width: 1720px;
      margin: 0 auto;
      padding: 16px;
    }

    .layout {
      display: grid;
      /* PCå‰æï¼šå·¦ã¯å¯å¤‰ã€å³ï¼ˆè¨˜éŒ²ä¸€è¦§ï¼‰ã¯èª­ã¿ã‚„ã™ã„å¹…ã§å›ºå®š */
      grid-template-columns: minmax(0, 1fr) 560px;
      align-items: start;
      gap: 18px;
    }


    /* ===== PCå‰æï¼šå³ã®è¨˜éŒ²ä¸€è¦§ã¯å¸¸ã«å³ã§è¿½å¾“ ===== */
    /* è¨˜éŒ²ä¸€è¦§ï¼ˆå³ï¼‰ï¼šãƒšãƒ¼ã‚¸ã¨ä¸€ç·’ã«ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ï¼ˆå·¦å³ãŒâ€œå›ºå®šã§å‹•ãâ€æ„Ÿã˜ã‚’é¿ã‘ã‚‹ï¼‰ */
    .records-panel{ align-self: start; }

    /* âœ… Gridã®å³ã‚«ãƒ©ãƒ ï¼ˆè¨˜éŒ²ä¸€è¦§ï¼‰ãŒæ¶ˆãˆã‚‹/æŠ¼ã—å‡ºã•ã‚Œã‚‹å¯¾ç­–ï¼šå­è¦ç´ ã‚’ç¸®ã‚ã‚‰ã‚Œã‚‹ã‚ˆã†ã«ã™ã‚‹ */
    .layout > * { min-width: 0; }
    .card {
      background: white;
      border-radius: 18px;
      padding: 20px 22px 22px;
      box-shadow: 0 8px 24px rgba(15, 23, 42, 0.1);
      margin-bottom: 18px;
    }

    .card-title {
      font-size: 20px;
      font-weight: 600;
      margin-bottom: 14px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 10px;
      flex-wrap: wrap;
    }

    
    /* è¨˜éŒ²ä¸€è¦§ï¼šæ“ä½œãƒœã‚¿ãƒ³ï¼ˆåˆ¥ãƒšãƒ¼ã‚¸/ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—/å¾©å…ƒ/Excelï¼‰ */
    .record-tools{
      display:flex;
      flex-direction:column;
      align-items:flex-end;
      gap:8px;
      margin: 0 0 12px; /* ã‚¿ã‚¤ãƒˆãƒ«ç›´ä¸‹ã«é…ç½® */
    }
    .record-tools-top{
      display:flex;
      justify-content:flex-end;
      width:100%;
    }

    .record-tools-bottom{
      display:flex;
      align-items:center;
      justify-content:flex-end;
      gap:8px;
      flex-wrap:wrap;
    }

    .card-subtitle {
      font-size: 13px;
      color: #6b7280;
      margin-bottom: 14px;
    }

    label {
      font-size: 14px;
      font-weight: 600;
      display: block;
      margin-bottom: 5px;
      color: #374151;
    }

    input[type="text"],
    input[type="date"],
    select,
    textarea {
      width: 100%;
      border-radius: 12px;
      border: 1px solid #d1d5db;
      padding: 10px 12px;
      font-size: 15px;
      outline: none;
      transition: border-color 0.15s, box-shadow 0.15s;
      background: #f9fafb;
    }

    input[type="text"]:focus,
    input[type="date"]:focus,
    select:focus,
    textarea:focus {
      border-color: #2563eb;
      box-shadow: 0 0 0 1px rgba(37, 99, 235, 0.5);
      background: white;
    }

    textarea { min-height: 80px; resize: vertical; }

    /* æ¥­å‹™æ—¥èªŒãƒ»æ´»å‹•çŠ¶æ³ï¼ˆç‰¹è¨˜äº‹é …å«ã‚€ï¼‰ï¼šå°‘ã—å¤§ãã‚ */
    #note, #editNote { min-height: 220px; }
    @media (max-width: 900px) { #note, #editNote { min-height: 180px; } }


    /* ãƒ•ã‚©ãƒ¼ãƒ ã®2åˆ—é…ç½®ï¼ˆã‚«ãƒ¼ãƒ‰å†…ç”¨ï¼‰ */
    .field-row {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 12px;
    }
    @media (max-width: 900px) {
      .field-row { grid-template-columns: 1fr; }
    }

    .field-row-3 {
      display: grid;
      grid-template-columns: repeat(3, minmax(0, 1fr));
      gap: 12px;
    }

    .field-row-4 {
      display: grid;
      grid-template-columns: repeat(4, minmax(0, 1fr));
      gap: 12px;
    }

    @media (max-width: 900px) {
      .field-row-4 { grid-template-columns: 1fr; }
    }

    @media (max-width: 900px) {
      .field-row-3 { grid-template-columns: 1fr; }
    }

    .field { margin-bottom: 12px; }

    .checkbox-row {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      align-items: center;
      margin-bottom: 6px;
    }

    .checkbox-row label {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      font-weight: 500;
      font-size: 14px;
      margin-bottom: 0;
    }

    /* æ—¥ä¸­æ”¯æ´ï¼šä¸»ãªæ”¯æ´ï¼ˆâ‘¢ï¼‰ã‚’è¦‹ã‚„ã™ãæ•´ãˆã‚‹ï¼ˆ2åˆ—ã‚°ãƒªãƒƒãƒ‰ï¼‰ */
    .checkbox-row.checkbox-grid {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 8px 12px;
      align-items: start;
    }
    .checkbox-row.checkbox-grid label {
      align-items: flex-start;
      line-height: 1.35;
      padding: 2px 0;
    }
    .checkbox-row.checkbox-grid input[type="checkbox"] {
      margin-top: 2px;
    }
    @media (max-width: 900px) {
      .checkbox-row.checkbox-grid {
        grid-template-columns: 1fr;
      }
    }

    
    /* æ—¥ä¸­æ”¯æ´ï¼šè¤‡åˆãƒã‚§ãƒƒã‚¯ï¼ˆå…¥æµ´å¯¾å¿œãªã©ï¼‰ */
    .day-main-composite {
      display: inline-flex;
      align-items: center;
      flex-wrap: wrap;
      gap: 8px;
      padding: 2px 0;
    }

    /* ===== â‘¡ è‡ªå‹•å…¥åŠ›ï¼šå…¥æµ´å¯¾å¿œï¼ˆå£°ã‹ã‘/è¦‹å®ˆã‚Š/ä»‹åŠ©ï¼‰è¤‡åˆãƒã‚§ãƒƒã‚¯ ===== */
    .auto-compound{
      display:inline-flex;
      align-items:center;
      flex-wrap:wrap;
      gap:10px;
      padding:4px 8px;
      border:1px dashed #d1d5db;
      border-radius:10px;
    }
    .auto-compound-sub{
      display:inline-flex;
      align-items:center;
      gap:10px;
      font-size:13px;
    }
    .auto-compound-sub label{
      font-weight:500;
    }

    .day-main-subwrap {
      display: inline-flex;
      align-items: center;
      gap: 10px;
      font-size: 13px;
      color: #555;
    }
    .day-main-subwrap.disabled {
      opacity: 0.45;
      pointer-events: none;
    }
    .day-main-subwrap .paren {
      color: #777;
      font-weight: 600;
    }
    .day-main-subwrap label {
      font-weight: 500;
      font-size: 13px;
      gap: 5px;
    }
.btn-row {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      margin-top: 12px;
      align-items: center;
    }

    button {
      border: none;
      border-radius: 999px;
      padding: 10px 18px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: transform 0.05s ease-out, box-shadow 0.1s;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      white-space: nowrap;
    }

    button:active { transform: translateY(1px); box-shadow: none; }

    .btn-primary {
      background: #2563eb;
      color: white;
      box-shadow: 0 4px 12px rgba(37, 99, 235, 0.4);
    }

    .btn-secondary { background: #e5e7eb; color: #111827; }
    .btn-danger { background: #dc2626; color: white; }

    /* â˜…åˆå¿ƒè€…å‘ã‘ï¼šè‰²ä»˜ãæ ï¼ˆé‡è¦æ“ä½œï¼‰ */
    .btn-beginner {
      background: #16a34a;
      color: #fff;
      box-shadow: 0 4px 12px rgba(22, 163, 74, 0.35);
    }

    .pill {
      border-radius: 999px;
      background: #eff6ff;
      padding: 4px 11px;
      font-size: 12px;
      color: #1d4ed8;
      border: 1px solid #bfdbfe;
    }

    .record-count { font-size: 13px; color: #6b7280; }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 13px;
      margin-top: 6px;
    }

    thead { position: sticky; top: 0; background: #eff6ff; z-index: 1; }

    th, td {
      border-bottom: 1px solid #e5e7eb;
      padding: 8px 6px;
      text-align: left;
      vertical-align: top;
    }

    th { font-weight: 600; color: #374151; white-space: nowrap; }
    tbody tr:nth-child(even) { background: #f9fafb; }

    .table-wrapper {
      max-width: 100%;
      max-height: 1050px;
      overflow: auto;
      border-radius: 14px;
      border: 1px solid #e5e7eb;
      margin-top: 10px;
    }

    .badge {
      display: inline-block;
      padding: 3px 9px;
      border-radius: 999px;
      font-size: 11px;
      font-weight: 600;
      color: white;
    }

    .badge-day { background: #3b82f6; }
    .badge-evening { background: #f59e0b; }
    .badge-night { background: #6366f1; }

    .small-text { font-size: 12px; color: #6b7280; }

    .no-records {
      padding: 14px;
      font-size: 13px;
      color: #6b7280;
      text-align: center;
    }

    .resident-select-row {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      margin-bottom: 10px;
      align-items: center;
    }

    .resident-select-row span { font-size: 13px; color: #4b5563; }
    .resident-select-row select { max-width: 240px; }

    /* ã‚¿ã‚°ãƒœã‚¿ãƒ³ã¾ã‚ã‚Š */
    .tag-buttons {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      margin-bottom: 4px;
    }

    .tag-button {
      border-radius: 999px;
      border: 1px solid #e5e7eb;
      background: #f3f4f6;
      padding: 4px 10px;
      font-size: 12px;
      cursor: pointer;
    }

    .tag-button.tag-button-active {
      background: #f59e0b;
      border-color: #f97316;
      color: #fff;
    }
/* è¨˜éŒ²ä¸€è¦§ï¼šæ—¥ä¸­ã®ä¸»ãªæ”¯æ´ï¼ˆãƒãƒƒãƒ—è¡¨ç¤ºï¼‰ */
.list-support-tags{
  display:flex;
  flex-wrap:wrap;
  gap:6px;
}
.list-support-tag{
  display:inline-flex;
  align-items:center;
  padding:3px 9px;
  border-radius:999px;
  font-size:11px;
  font-weight:700;
  border:1px solid #bfdbfe;
  background:#eff6ff;
  color:#1d4ed8;
}

    .tag-chip {
      display: inline-block;
      margin-top: 2px;
      margin-right: 4px;
      padding: 2px 7px;
      border-radius: 999px;
      border: 1px solid #fde68a;
      background: #fffbeb;
      font-size: 11px;
    }

    /* PCè‹¦æ‰‹ãªäººå‘ã‘ï¼šå¤§ããªé¸æŠãƒœã‚¿ãƒ³ */
    .quick-row {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      margin-top: 6px;
      margin-bottom: 4px;
    }

    .quick-btn {
      flex: 1 0 0;
      min-width: 70px;
      justify-content: center;
      padding: 8px 10px;
      border-radius: 999px;
      border: 1px solid #d1d5db;
      background: #f3f4f6;
      font-size: 13px;
      cursor: pointer;
    }

    .quick-btn-active {
      background: #2563eb;
      color: #fff;
      border-color: #1d4ed8;
      box-shadow: 0 0 0 1px rgba(37, 99, 235, 0.4);
    }

    /* ãƒ¢ãƒ¼ãƒ€ãƒ« */
    .detail-modal-backdrop {
      position: fixed;
      inset: 0;
      background: rgba(15, 23, 42, 0.45);
      display: none;
      align-items: center;
      justify-content: center;
      padding: 16px;
      z-index: 50;
    }

    .detail-modal-backdrop.show { display: flex; }

    .detail-modal {
      background: #ffffff;
      border-radius: 18px;
      max-width: 720px;
      width: 100%;
      max-height: 90vh;
      padding: 18px 20px 20px;
      box-shadow: 0 20px 40px rgba(15, 23, 42, 0.35);
      overflow: auto;
    }

    .detail-modal-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 8px;
      gap: 10px;
      flex-wrap: wrap;
    }

    .detail-modal-title { font-size: 18px; font-weight: 600; }

    .detail-modal-close {
      border-radius: 999px;
      border: none;
      padding: 4px 10px;
      font-size: 16px;
      cursor: pointer;
      background: #e5e7eb;
    }

    .detail-modal-body { font-size: 14px; color: #111827; }

    .detail-field { margin-bottom: 6px; }

    .detail-field strong {
      display: inline-block;
      min-width: 120px;
      color: #4b5563;
    }

    .detail-multiline { margin-top: 8px; margin-bottom: 8px; }

    .detail-multiline strong {
      display: block;
      margin-bottom: 2px;
      color: #4b5563;
    }

    .detail-multiline pre {
      margin: 0;
      padding: 8px 10px;
      background: #f9fafb;
      border-radius: 10px;
      border: 1px solid #e5e7eb;
      white-space: pre-wrap;
      word-break: break-word;
      font-family: inherit;
      font-size: 13px;
    }

    /* ====== ã“ã“ã‹ã‚‰ï¼šåˆå¿ƒè€…ãŒè§¦ã‚‹ã¨ã“ã‚ã‚’è‰²ä»˜ãæ ã« ====== */
    .beginner-guide {
      border: 2px solid #3b82f6;
      background: #eff6ff;
      border-radius: 16px;
      padding: 12px 14px;
      margin-bottom: 12px;
    }
    .beginner-guide .title {
      font-weight: 800;
      color: #1e3a8a;
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 6px;
    }
    .beginner-guide .steps {
      font-size: 13px;
      color: #1e3a8a;
    }

    .beginner-zone {
      border: 2px solid #3b82f6;
      background: #eff6ff;
      border-radius: 14px;
      padding: 10px 12px;
      margin-bottom: 12px;
    }
    .beginner-badge {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 3px 10px;
      border-radius: 999px;
      font-size: 12px;
      font-weight: 800;
      background: #dbeafe;
      color: #1e3a8a;
      border: 1px solid #93c5fd;
      margin-left: 8px;
      white-space: nowrap;
    }
    .beginner-hint {
      font-size: 12px;
      color: #1e3a8a;
      margin-top: 6px;
    }
        /* ====== æ—¥ä¸­æ”¯æ´ãƒ†ãƒ³ãƒ—ãƒ¬ï¼ˆæ—¥ä¸­æ”¯æ´åŠ ç®—â… ãƒ»æ¥­å‹™æ—¥èªŒã¸è¿½è¨˜ï¼‰ï¼šå°‚ç”¨ãƒœãƒƒã‚¯ã‚¹ ====== */
    .daynote-template-box{
      border: 2px solid #60a5fa;
      background: #eff6ff;
      border-radius: 14px;
      padding: 10px 12px;
      margin-top: 10px;
    }
    .daynote-template-head{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:8px;
      flex-wrap:wrap;
      margin-bottom: 6px;
    }
    .daynote-template-title{
      font-weight: 800;
      color: #1d4ed8;
    }

    /* æ—¥ä¸­æ”¯æ´ãƒ†ãƒ³ãƒ—ãƒ¬ï¼šãƒ‘ã‚¿ãƒ¼ãƒ³ï¼ˆâ‘ â‘¡â‘¢ï¼‰é¸æŠ */
    .dn-compound{
      display:flex;
      align-items:center;
      flex-wrap:wrap;
      gap:10px;
      padding:6px 10px;
      border:1px dashed #93c5fd;
      border-radius:12px;
      background: rgba(255,255,255,0.65);
    }
    .dn-subwrap{
      display:inline-flex;
      align-items:center;
      gap:10px;
      font-size:12px;
      color:#1e3a8a;
    }
    .dn-subwrap .paren{ opacity:.65; }
    .dn-subwrap.disabled{
      opacity:.55;
      pointer-events:none;
      filter: grayscale(0.25);
    }
    .dn-subwrap label{
      display:inline-flex;
      align-items:center;
      gap:4px;
      margin:0;
      white-space:nowrap;
      padding: 2px 6px;
      border: 1px solid #cbd5e1;
      border-radius: 8px;
      background: #ffffff;
      cursor: pointer;
      user-select: none;
    }

    /* æ—¥ä¸­æ”¯æ´ãƒ†ãƒ³ãƒ—ãƒ¬ï¼šã‚µãƒ–ï¼ˆâ‘ â‘¡â‘¢ï¼‰ã‚’â–¡ãƒ‡ã‚¶ã‚¤ãƒ³ï¼‹è‰²åˆ†ã‘ */
    .dn-subwrap input.day-note-tpl-pat{
      appearance: none;
      -webkit-appearance: none;
      width: 16px;
      height: 16px;
      border: 1.5px solid #94a3b8;
      border-radius: 3px;
      background: #ffffff;
      display: inline-grid;
      place-content: center;
      transform: translateY(0.5px);
    }
    .dn-subwrap input.day-note-tpl-pat[value="1"]{ --pat:#2563eb; }
    .dn-subwrap input.day-note-tpl-pat[value="2"]{ --pat:#f97316; }
    .dn-subwrap input.day-note-tpl-pat[value="3"]{ --pat:#7c3aed; }
    .dn-subwrap input.day-note-tpl-pat:checked{
      border-color: var(--pat);
      background: var(--pat);
    }
    .dn-subwrap input.day-note-tpl-pat:checked::after{
      content: "âœ“";
      color: #ffffff;
      font-size: 12px;
      font-weight: 900;
      line-height: 1;
      transform: translateY(-0.5px);
    }
    .dn-subwrap input.day-note-tpl-pat:focus-visible{
      outline: 3px solid rgba(37,99,235,.25);
      outline-offset: 2px;
    }

    /* ãƒ©ãƒ™ãƒ«å´ã‚‚è‰²ã¥ã‘ï¼ˆå¯¾å¿œãƒ–ãƒ©ã‚¦ã‚¶ï¼šChrome/Edgeãªã©ï¼‰ */
    .dn-subwrap label:has(input.day-note-tpl-pat:checked){
      font-weight: 800;
    }
    .dn-subwrap label:has(input.day-note-tpl-pat[value="1"]:checked){
      border-color: #2563eb;
      background: rgba(37,99,235,.12);
      color: #1d4ed8;
    }
    .dn-subwrap label:has(input.day-note-tpl-pat[value="2"]:checked){
      border-color: #f97316;
      background: rgba(249,115,22,.14);
      color: #9a3412;
    }
    .dn-subwrap label:has(input.day-note-tpl-pat[value="3"]:checked){
      border-color: #7c3aed;
      background: rgba(124,58,237,.12);
      color: #5b21b6;
    }
    /* DayNote templates: compact 2-column layout (PC) */
    .daynote-template-grid{
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 8px 10px;
    }
    .daynote-template-grid .dn-compound{
      width: 100%;
      margin: 0;
      padding: 5px 8px;
      gap: 8px;
    }
    .daynote-template-grid .dn-subwrap{
      gap: 8px;
    }
    @media (max-width: 920px){
      .daynote-template-grid{ grid-template-columns: 1fr; }
    }


    /* æ—¥ä¸­æ”¯æ´ãƒ†ãƒ³ãƒ—ãƒ¬ï¼šç›´è¿‘ã®è¿½è¨˜ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ï¼ˆã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ä¸è¦ï¼‰ */
    .daynote-last-preview{
      font-size: 12px;
      color: #1e3a8a;
      margin-top: 6px;
      padding: 6px 8px;
      border: 1px dashed #93c5fd;
      border-radius: 10px;
      background: rgba(255,255,255,0.65);
      cursor: pointer;
      user-select: none;
    }
    .daynote-last-preview.empty{
      opacity: .75;
      cursor: default;
    }
    .daynote-last-preview:hover{
      filter: brightness(0.985);
    }

    /* ãƒˆãƒ¼ã‚¹ãƒˆé€šçŸ¥ï¼ˆãƒã‚§ãƒƒã‚¯å¾Œã®ç¢ºèªç”¨ï¼‰ */
    .dn-toast{
      position: fixed;
      right: 14px;
      bottom: 14px;
      width: min(460px, calc(100vw - 28px));
      background: #ffffff;
      border: 1.5px solid #cbd5e1;
      border-radius: 14px;
      padding: 10px 12px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.12);
      z-index: 9999;
      display: none;
    }
    .dn-toast.show{ display: block; }
    .dn-toast-title{
      font-weight: 900;
      font-size: 13px;
      margin-bottom: 6px;
      color: #0f172a;
    }
    .dn-toast-body{
      font-size: 12.5px;
      color: #0f172a;
      white-space: pre-wrap;
      max-height: 120px;
      overflow: auto;
      border: 1px solid #e2e8f0;
      border-radius: 10px;
      padding: 8px;
      background: #f8fafc;
    }
    .dn-toast-actions{
      display: flex;
      gap: 8px;
      justify-content: flex-end;
      margin-top: 8px;
      flex-wrap: wrap;
    }

    @keyframes dnflash{
      0% { box-shadow: 0 0 0 0 rgba(37,99,235,0); }
      35%{ box-shadow: 0 0 0 6px rgba(37,99,235,0.25); }
      100%{ box-shadow: 0 0 0 0 rgba(37,99,235,0); }
    }
    .dn-flash{ animation: dnflash 1.2s ease-in-out; }

    /* ====== ã“ã“ã¾ã§ï¼šåˆå¿ƒè€…ã®è‰²ä»˜ãæ  ====== */

    /* ====== ç®¡ç†ã‚¨ãƒªã‚¢è‰²åˆ†ã‘ï¼ˆã‚ã¾ã‚Šè§¦ã‚‰ãªã„æ‰€ï¼‰ ====== */
    .admin-card {
      border: 2px solid #f59e0b;
      background: #fffbeb;
    }
    .admin-card .admin-note {
      font-size: 12px;
      color: #92400e;
      margin-top: 6px;
    }
    .admin-pill {
      border-radius: 999px;
      background: #fff7ed;
      padding: 4px 10px;
      font-size: 12px;
      color: #9a3412;
      border: 1px solid #fed7aa;
      font-weight: 800;
    }
    /* ===== è©³ç´°ãƒ¢ãƒ¼ãƒ€ãƒ«ï¼šä¸»ãªæ”¯æ´ã‚’ã‚¿ã‚°ã§ç›®ç«‹ãŸã›ã‚‹ ===== */
.detail-field.detail-tagrow{
  display:flex;
  align-items:flex-start;
  gap:10px;
  margin-bottom: 8px;
}
.detail-field.detail-tagrow strong{
  min-width:120px;           /* æ—¢å­˜ã¨åˆã‚ã›ã‚‹ */
  color:#4b5563;
}

.support-tags{
  display:flex;
  flex-wrap:wrap;
  gap:8px 10px;
  flex:1;
}

.support-tag{
  display:inline-flex;
  align-items:center;
  padding:6px 10px;
  border-radius:9999px;
  font-weight:800;
  font-size:13px;
  border:1px solid rgba(37,99,235,.25);
  background: rgba(37,99,235,.10);
  color:#1d4ed8;
}
.support-tag::before{
  content:"âœ“";
  font-weight:900;
  margin-right:6px;
}

/* æ¬ å¸­ç†ç”±ã¯è‰²ã‚’å¤‰ãˆã‚‹ï¼ˆä»»æ„ï¼‰ */
.support-tag.reason{
  border-color: rgba(245,158,11,.35);
  background: rgba(245,158,11,.18);
  color:#b45309;
}
.support-tag.reason::before{
  content:"!";
}

  
    /* ===== ä¿å­˜ãƒˆãƒ¼ã‚¹ãƒˆï¼ˆä¿å­˜ã—ã¾ã—ãŸè¡¨ç¤ºï¼‰ ===== */
    #saveToast{
      position: fixed;
      left: 50%;
      bottom: 18px;
      transform: translateX(-50%);
      background: rgba(17, 24, 39, 0.95);
      color: #fff;
      padding: 10px 14px;
      border-radius: 999px;
      font-size: 14px;
      box-shadow: 0 10px 28px rgba(0,0,0,0.25);
      opacity: 0;
      pointer-events: none;
      transition: opacity .18s ease, transform .18s ease;
      z-index: 9999;
      max-width: calc(100vw - 24px);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    #saveToast.show{
      opacity: 1;
      transform: translateX(-50%) translateY(-6px);
    }


    /* ===== ç‰¹è¨˜äº‹é …ã‚ã‚Šï¼ˆãƒãƒƒã‚¸/å¼·èª¿ï¼‰ ===== */
    /* ===== ç‰¹è¨˜äº‹é …ãƒ•ã‚£ãƒ«ã‚¿ï¼ˆä¸€è¦§ï¼‰ ===== */
    .special-filter{
      display:inline-flex;
      align-items:center;
      gap:6px;
      padding:6px 10px;
      border:1px solid #ddd;
      border-radius:999px;
      background:#fafafa;
      cursor:pointer;
      user-select:none;
    }
    .special-filter input{ transform: translateY(1px); }
    .special-filter-on{
      border-color:#fca5a5;
      background:#fff1f2;
    }

    .special-flag{
      display:inline-flex;
      align-items:center;
      gap:6px;
      font-weight:800;
      padding:4px 10px;
      border-radius:999px;
      border:1px solid #fecaca;
      background:#fff1f2;
      color:#991b1b;
      cursor:pointer;
      user-select:none;
      white-space:nowrap;
    }
    .special-flag input{ transform: translateY(1px); }
    .special-flag-help{
      margin-top:6px;
      margin-bottom:6px;
    }
    .special-badge{
      display:inline-flex;
      align-items:center;
      gap:6px;
      padding:2px 8px;
      border-radius:999px;
      font-size:12px;
      font-weight:900;
      border:1px solid #fecaca;
      background:#fff1f2;
      color:#991b1b;
      margin-left:8px;
      white-space:nowrap;
    }
    .special-note-on{
      border-color:#dc2626 !important;
      box-shadow:0 0 0 2px rgba(220,38,38,.15) !important;
    }
    /* ===== ã“ã“ã¾ã§ï¼šç‰¹è¨˜äº‹é …ã‚ã‚Š ===== */


    /* ===== ã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ãƒˆé€šçŸ¥ãƒãƒŠãƒ¼ ===== */
    .update-banner{
      max-width:1720px;
      margin:10px auto 0;
      padding:12px 16px;
      border:1px solid #fde68a;
      background:#fffbeb;
      color:#92400e;
      border-radius:12px;
      display:none;
      gap:12px;
      align-items:flex-start;
      justify-content:space-between;
    }
    .update-banner.show{ display:flex; }
    .update-banner .left{ flex:1; min-width:0; }
    .update-banner .title{
      font-weight:900;
      margin-bottom:6px;
      font-size:14px;
      display:flex;
      gap:8px;
      align-items:center;
      flex-wrap:wrap;
    }
    .update-banner .meta{
      font-weight:700;
      font-size:12px;
      opacity:.85;
      border:1px solid #fcd34d;
      background:#fff7ed;
      padding:2px 8px;
      border-radius:999px;
      white-space:nowrap;
    }
    .update-banner ul{
      margin:0;
      padding-left:18px;
      font-size:13px;
      line-height:1.5;
    }
    .update-banner .close{
      border:none;
      background:#f59e0b;
      color:white;
      padding:8px 10px;
      border-radius:10px;
      font-weight:800;
      cursor:pointer;
      white-space:nowrap;
    }
    .update-banner .close:hover{ filter:brightness(.95); }
    /* ===== ã“ã“ã¾ã§ï¼šã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ãƒˆé€šçŸ¥ ===== */

</style>

<!-- Excelãƒ©ã‚¤ãƒ–ãƒ©ãƒªï¼ˆã‚¹ã‚¿ã‚¤ãƒ«å¯¾å¿œï¼šxlsx-js-styleï¼‰ãƒ­ãƒ¼ãƒ€ãƒ¼ -->
<script>
(function(){
  function load(src, onok, onng){
    var s=document.createElement('script');
    s.src=src;
    s.onload=function(){ onok && onok(); };
    s.onerror=function(){ onng && onng(); };
    document.head.appendChild(s);
  }
  var sources=[
    "https://cdn.jsdelivr.net/npm/xlsx-js-style@1.2.0/dist/xlsx.bundle.js",
    "https://unpkg.com/xlsx-js-style@1.2.0/dist/xlsx.bundle.js"
  ];
  var i=0;
  function next(){
    if(i>=sources.length){
      window.__xlsxLoadFailed=true;
      return;
    }
    load(sources[i++], function(){ window.__xlsxReady=true; }, next);
  }
  next();
})();
</script>

</head>

<body>
  <header>ã‚°ãƒ«ãƒ¼ãƒ—ãƒ›ãƒ¼ãƒ  å€‹äººè¨˜éŒ² WEBã‚¢ãƒ—ãƒªï¼ˆåˆå¿ƒè€…ã‚¬ã‚¤ãƒ‰ä»˜ãï¼‰</header>

<!-- XLSXãƒ­ãƒ¼ã‚«ãƒ«èª­ã¿è¾¼ã¿ï¼ˆãƒãƒƒãƒˆä¸å¯æ™‚ã®æ•‘æ¸ˆï¼‰ -->
<div id="xlsxLoadMsg" style="display:none; max-width:1720px; margin:10px auto 0; padding:10px 12px; border-radius:12px; border:1px solid #fca5a5; background:#fef2f2; color:#991b1b; font-size:14px;">
  Excelãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’èª­ã¿è¾¼ã‚ã¾ã›ã‚“ã§ã—ãŸï¼ˆãƒãƒƒãƒˆæ¥ç¶šãªã—/åˆ¶é™ã‚ã‚Šã®å¯èƒ½æ€§ï¼‰ã€‚<br>
  âœ… å¯¾å¿œæ–¹æ³•ï¼š<b>xlsx.bundle.js</b> ã‚’PCã«ä¿å­˜ã—ã¦ã€ã“ã“ã‹ã‚‰èª­ã¿è¾¼ã‚“ã§ãã ã•ã„ï¼ˆ1å›èª­ã¿è¾¼ã‚ã°ã“ã®ãƒšãƒ¼ã‚¸ã‚’é–‹ã„ã¦ã„ã‚‹é–“ã¯Excelå‡ºåŠ›ã§ãã¾ã™ï¼‰ã€‚<br>
  <input type="file" id="xlsxLocalFile" accept=".js" style="margin-top:8px;">
  <div id="xlsxLocalStatus" style="margin-top:6px; font-size:13px;"></div>
</div>


<!-- ğŸ†• ã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ãƒˆé€šçŸ¥ï¼ˆæ–°ã—ã„æ›´æ–°ãŒã‚ã£ãŸæ™‚ã ã‘è¡¨ç¤ºï¼‰ -->
<div id="updateBanner" class="update-banner" aria-live="polite">
  <div class="left">
    <div class="title">
      ğŸ†• ã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ãƒˆã—ã¾ã—ãŸ
      <span class="meta" id="updateBannerMeta"></span>
    </div>
    <ul id="updateBannerList"></ul>
  </div>
  <button type="button" class="close" id="updateBannerClose">é–‰ã˜ã‚‹</button>
</div>



<script>
  // ç”»é¢è¡¨ç¤ºå¾Œã«ã€CDNèª­è¾¼å¤±æ•—ãªã‚‰ãƒ­ãƒ¼ã‚«ãƒ«èª­è¾¼UIã‚’è¡¨ç¤º
  document.addEventListener("DOMContentLoaded", function(){
    function showLocalUI(){
      var box=document.getElementById("xlsxLoadMsg");
      if(!box) return;
      box.style.display="block";
      var inp=document.getElementById("xlsxLocalFile");
      var st=document.getElementById("xlsxLocalStatus");
      if(!inp) return;

      inp.addEventListener("change", function(){
        var file = inp.files && inp.files[0];
        if(!file) return;
        var reader = new FileReader();
        reader.onload = function(){
          try{
            var sc=document.createElement("script");
            sc.textContent = reader.result;
            document.head.appendChild(sc);
            setTimeout(function(){
              if(typeof XLSX !== "undefined"){
                if(st) st.innerHTML = "âœ… ãƒ­ãƒ¼ã‚«ãƒ«ã‹ã‚‰Excelãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸã€‚ã‚‚ã†ä¸€åº¦ã€ŒExcelå‡ºåŠ›ã€ã‚’æŠ¼ã—ã¦ãã ã•ã„ã€‚";
                box.style.borderColor = "#93c5fd";
                box.style.background = "#eff6ff";
                box.style.color = "#1e3a8a";
              }else{
                if(st) st.innerHTML = "âŒ ãƒ­ãƒ¼ã‚«ãƒ«èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸï¼ˆãƒ•ã‚¡ã‚¤ãƒ«ãŒé•ã†å¯èƒ½æ€§ï¼‰ã€‚";
              }
            }, 50);
          }catch(e){
            if(st) st.innerHTML = "âŒ ãƒ­ãƒ¼ã‚«ãƒ«èª­ã¿è¾¼ã¿ä¸­ã«ã‚¨ãƒ©ãƒ¼: " + (e && e.message ? e.message : e);
          }
        };
        reader.readAsText(file);
      });
    }

    // CDNèª­ã¿è¾¼ã¿ãŒå¤±æ•—ã—ãŸå ´åˆã«ã ã‘è¡¨ç¤ºï¼ˆå°‘ã—å¾…ã¤ï¼‰
    setTimeout(function(){
      if(typeof XLSX === "undefined" && window.__xlsxLoadFailed){
        showLocalUI();
      }
    }, 800);
  });
</script>

  <main>
    <div class="layout">
      <!-- å…¥åŠ›ãƒ•ã‚©ãƒ¼ãƒ  -->
      <section class="card">
        <div class="card-title">
          <span>ä»Šæ—¥ã®å€‹äººè¨˜éŒ²</span>
          <span class="pill" id="modeLabel">æ–°è¦å…¥åŠ›ãƒ¢ãƒ¼ãƒ‰</span>
        </div>

        <!-- â˜…åˆå¿ƒè€…ã‚¬ã‚¤ãƒ‰ -->
        <div class="beginner-guide">
          <div class="title">âœ… åˆå¿ƒè€…ã¯ã€Œè‰²ä»˜ãã®æ ã ã‘ã€ã§OK</div>
          <div class="steps">
            â‘  æ—¥ä»˜ãƒ»åˆ©ç”¨è€…ãƒ»è¨˜éŒ²è€… â†’ â‘¡ ã‚ˆãä½¿ã†é …ç›®ãƒã‚§ãƒƒã‚¯ â†’ â‘¢ã€æ—¥ä¸­ã«è¡Œã£ãŸä¸»ãªæ”¯æ´ã€‘ â†’ â‘£ æ—¥ä¸­æ´»å‹• â†’ â‘¤ğŸ’¾ è¨˜éŒ²ã‚’ä¿å­˜
          </div>
        </div>

        <form id="recordForm">

          <!-- â˜…æ—¥ä»˜ãƒ»åˆ©ç”¨è€…ï¼ˆåˆå¿ƒè€…OKï¼‰ -->
          <div class="beginner-zone">
            <div style="display:flex; align-items:center; justify-content:space-between; gap:8px; flex-wrap:wrap;">
              <div style="font-weight:800; color:#1e3a8a;">â‘  æ—¥ä»˜ãƒ»åˆ©ç”¨è€…ãƒ»è¨˜éŒ²è€… <span class="beginner-badge">ã“ã“ã ã‘OK</span></div>
              <div class="beginner-hint">â€»åˆ©ç”¨è€…åˆ¥ã«è¨­å®šã—ãŸåˆæœŸå€¤ãŒã‚ã‚‹å ´åˆã¯è‡ªå‹•ã§åæ˜ ã•ã‚Œã¾ã™ã€‚</div>
            </div>

            <div class="field-row-3" style="margin-top:10px;">
              <div class="field" style="margin-bottom:0;">
                <label for="date">æ—¥ä»˜</label>
                <input type="date" id="date" required />
              </div>
              <div class="field" style="margin-bottom:0;">
                <label for="resident">åˆ©ç”¨è€…</label>
                <select id="resident" required></select>
              </div>
              <div class="field" style="margin-bottom:0;">
                <label for="recorder">è¨˜éŒ²è€…</label>
                <select id="recorder"></select>
              </div>
            </div>
          </div>
<div class="field vitals-compact" id="abnormalVitalsBox" style="margin-top:8px;">
                <div class="vitals-title">ä½“é‡ãƒ»è¡€åœ§ãƒ»è„ˆæ‹ï¼ˆç•°å¸¸ãŒã‚ã£ãŸå ´åˆã®ã¿ï¼‰</div>
                <div class="small-text" style="margin:4px 0 6px;">â€»ç•°å¸¸ã‚„æ°—ã«ãªã‚‹å¤‰åŒ–ãŒã‚ã£ãŸå ´åˆã®ã¿è¨˜å…¥ã€‚æ™®æ®µã¯ç©ºæ¬„ã§OKã€‚</div>
<div class="field-row-4" id="abnormalVitalsInputs" style="align-items:end;">
                  <div class="field" style="margin-bottom:0;">
                    <label for="abnormalWeight">ä½“é‡ï¼ˆkgï¼‰</label>
                    <input type="text" id="abnormalWeight" placeholder="ä¾‹ï¼š56.2" inputmode="decimal" />
                  </div>
                  <div class="field" style="margin-bottom:0;">
                    <label for="abnormalBPsys">è¡€åœ§ï¼ˆä¸Š / mmHgï¼‰</label>
                    <input type="text" id="abnormalBPsys" placeholder="ä¾‹ï¼š120" inputmode="numeric" />
                  </div>
                  <div class="field" style="margin-bottom:0;">
                    <label for="abnormalBPdia">è¡€åœ§ï¼ˆä¸‹ / mmHgï¼‰</label>
                    <input type="text" id="abnormalBPdia" placeholder="ä¾‹ï¼š80" inputmode="numeric" />
                  </div>
                  <div class="field" style="margin-bottom:0;">
                    <label for="abnormalPulse">è„ˆæ‹ï¼ˆå›/åˆ†ï¼‰</label>
                    <input type="text" id="abnormalPulse" placeholder="ä¾‹ï¼š72" inputmode="numeric" />
                  </div>
                </div>
                <div class="small-text" style="margin-top:6px;">â€»ä»»æ„ã€‚å…¥åŠ›ã™ã‚‹ã¨æ¥­å‹™æ—¥èªŒã®è‡ªå‹•æ¬„ã«ã‚‚åæ˜ ã•ã‚Œã¾ã™ã€‚</div>
              </div>
          <!-- ã‚¿ã‚° -->
          <div class="field">
            <label>ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ï¼ˆã‚¿ã‚°ï¼‰</label>
            <div class="tag-buttons" id="tagButtons"></div>
            <div class="small-text" id="selectedTagsInfo">é¸æŠä¸­ï¼šãªã—</div>
          </div>

          <!-- â˜…è‡ªå‹•å…¥åŠ›ã—ãŸã„æ”¯æ´é …ç›®ï¼ˆåˆå¿ƒè€…OKï¼‰ -->
          <div class="beginner-zone">
            <div style="display:flex; align-items:center; justify-content:space-between; gap:8px; flex-wrap:wrap;">
              <div style="font-weight:800; color:#1e3a8a;">â‘¡ è‡ªå‹•å…¥åŠ›ã—ãŸã„æ”¯æ´é …ç›® <span class="beginner-badge">ã“ã“ã ã‘OK</span></div>
              <div class="small-text">â€»åˆ©ç”¨è€…åˆ¥ã«è¨­å®šã—ãŸåˆæœŸå€¤ãŒã‚ã‚‹å ´åˆã¯è‡ªå‹•ã§åæ˜ ã•ã‚Œã¾ã™</div>
            </div>

            <div class="btn-row" style="margin-top:8px;">
              <button type="button" class="btn-secondary" id="openFavModalBtn">ğŸ›  ã‚ˆãä½¿ã†é …ç›®ç·¨é›†ï¼ˆã“ã®åˆ©ç”¨è€…ï¼‰</button>
            </div>

            <div class="checkbox-row" id="autoItemCheckboxes" style="margin-top:8px;"></div>
          </div>

          <!-- æ—¥ä¸­æ”¯æ´åŠ ç®— åŒºåˆ† -->
          <div class="field">
            <label for="daySupportType">æ—¥ä¸­æ”¯æ´åŠ ç®—ã®åŒºåˆ†</label>
            <select id="daySupportType">
              <option value="">é¸æŠãªã—</option>
              <option value="â… ">æ—¥ä¸­æ”¯æ´åŠ ç®—â… </option>
              <option value="â…¡">æ—¥ä¸­æ”¯æ´åŠ ç®—â…¡</option>
            </select>
            <div class="small-text">
              æ—¥ä¸­æ”¯æ´åŠ ç®—ã«è©²å½“ã™ã‚‹å ´åˆã®ã¿ã€â…  / â…¡ ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚ï¼ˆè‡ªå‹•æ–‡ç« ã®ç½®æ›ã«ã‚‚åæ˜ ï¼‰
            </div>
          </div>

          <!-- â˜…æ—¥ä¸­æ”¯æ´ï¼šä¸»ãªæ”¯æ´ï¼ˆåˆå¿ƒè€…OKï¼‰ -->
          <div class="beginner-zone">
            <div style="display:flex; align-items:center; justify-content:space-between; gap:8px; flex-wrap:wrap;">
              <div style="font-weight:800; color:#1e3a8a;">â‘¢ã€æ—¥ä¸­ã«è¡Œã£ãŸä¸»ãªæ”¯æ´ã€‘ <span class="beginner-badge">ã“ã“ã ã‘OK</span></div>
              <div class="beginner-hint">â€»è©²å½“ã™ã‚‹ã‚‚ã®ã«ãƒã‚§ãƒƒã‚¯ï¼ˆæ¼ã‚Œé˜²æ­¢ï¼‰</div>
            </div>

            <div class="btn-row" style="margin-top:8px;">
              <button type="button" class="btn-secondary" id="openDaySupportModalBtn">ğŸ›  æ—¥ä¸­æ”¯æ´ãƒã‚§ãƒƒã‚¯ç·¨é›†ï¼ˆåˆ©ç”¨è€…åˆ¥ï¼‰</button>
            </div>

            <div class="checkbox-row checkbox-grid" id="daySupportMainCheckboxes" style="margin-top:8px;"></div>

            <div class="daynote-template-box" style="margin-top:10px;">
              <div class="daynote-template-head">
                <div class="daynote-template-title">æ—¥ä¸­æ”¯æ´ãƒ†ãƒ³ãƒ—ãƒ¬ï¼ˆæ—¥ä¸­æ”¯æ´åŠ ç®—â… ãƒ»æ¥­å‹™æ—¥èªŒã¸è¿½è¨˜ï¼‰</div>
                <button type="button" class="btn-secondary" id="openDayNoteTemplateModalBtn" style="padding:6px 10px; font-size:12px;">ğŸ›  ç·¨é›†</button>
              </div>
              <div class="daynote-last-preview empty" id="dayNoteLastPreview" title="ç›´è¿‘ã®è¿½è¨˜å†…å®¹ï¼ˆã‚¯ãƒªãƒƒã‚¯ã§è¡¨ç¤ºï¼‰">æœ€æ–°ï¼šãªã—</div>
              <div class="checkbox-row daynote-template-grid" id="dayNoteTemplateChecks" style="margin-top:8px;"></div>
              <div class="small-text">â€»æ—¥ä¸­æ”¯æ´åŠ ç®—â… ã®è¨˜éŒ²ç”¨ãƒ†ãƒ³ãƒ—ãƒ¬ã§ã™ã€‚â‘ â‘¡â‘¢ï¼ˆè‰²ä»˜ãï¼‰ã®ã©ã‚Œã‹ã‚’é¸ã¶ã¨ã€Œæ¥­å‹™æ—¥èªŒã€ã«è‡ªå‹•è¿½è¨˜ã•ã‚Œã¾ã™ã€‚OFFã«ã™ã‚‹ã¨ã€ãã®ãƒ†ãƒ³ãƒ—ãƒ¬ã§è¿½åŠ ã—ãŸæ–‡ç« ã ã‘å‰Šé™¤ã•ã‚Œã¾ã™ï¼ˆæ‰‹å…¥åŠ›ã¯æ¶ˆãˆã¾ã›ã‚“ï¼‰ã€‚</div>
            </div>


          </div>

          <div class="beginner-zone" style="margin-top:10px;">
  <div style="display:flex; align-items:center; justify-content:space-between; gap:8px; flex-wrap:wrap;">
    <div style="font-weight:800; color:#1e3a8a;">â‘£ æ—¥ä¸­æ´»å‹• <span class="beginner-badge">ã“ã“ã ã‘OK</span></div>
    <div class="beginner-hint">â€»é€šæ‰€/æ¬ å¸­ã‚’ãƒã‚§ãƒƒã‚¯ã€‚</div>
  </div>

  <div class="field" style="margin-top:8px;">
    <label>æ—¥ä¸­æ´»å‹•ï¼ˆAå‹ / Bå‹ï¼‰</label>
    <div class="checkbox-row" id="dayActivityCheckboxes"></div>
  </div>

  <div class="field">
    <label>ã€æ—¥ä¸­æ´»å‹•ã«è¡Œã‘ãªã‹ã£ãŸç†ç”±ã€‘ï¼ˆä»»æ„ï¼‰</label>
    <div class="small-text" style="margin-bottom:4px;">â€»è©²å½“ã™ã‚‹å ´åˆã®ã¿ãƒã‚§ãƒƒã‚¯ã—ã¦ãã ã•ã„ï¼ˆå¿…è¦ãŒã‚ã‚‹ã¨ãã ã‘ï¼‰ã€‚</div>
    <div class="checkbox-row" id="daySupportReasonCheckboxes"></div>
  </div>
</div>

<div class="field" style="margin-top:18px;">
  <label for="support">æœ¬æ—¥ã®æ”¯æ´å†…å®¹ (è·å“¡å´)</label>
            <div class="small-text">
              â€»è·å“¡å´ã®è¨˜å…¥æ¬„ï¼šæ™®æ®µåŒã˜å†…å®¹ã§ã‚‚OKã€‚æ—¥ä¸­ã®æ§˜å­ã¨è¡Œã£ãŸæ”¯æ´ã‚’ç°¡æ½”ã«è¨˜å…¥ã—ã¦ãã ã•ã„ã€‚<br>
              â‘¡ã®ãƒã‚§ãƒƒã‚¯å†…å®¹ã¯ã“ã®æ¬„ã«è‡ªå‹•åæ˜ ã•ã‚Œã¾ã™ã€‚å¿…è¦ã«å¿œã˜ã¦ã€Œãƒ†ãƒ³ãƒ—ãƒ¬æŒ¿å…¥ã€ã§æ–‡ç« ã‚’è¿½è¨˜ã§ãã¾ã™ã€‚<br>
              äº‹æ•…ãƒ»ãƒˆãƒ©ãƒ–ãƒ«ãƒ»å—è¨ºãƒ»ç›¸è«‡ãªã©é‡è¦äº‹é …ã¯ä¸‹ã®ã€Œæ¥­å‹™æ—¥èªŒãƒ»åˆ©ç”¨è€…ã®æ´»å‹•çŠ¶æ³ï¼ˆç‰¹è¨˜äº‹é …å«ã‚€ï¼‰ã€ã¸ã€‚</div>
            <textarea id="support" rows="8" placeholder="ã€æ¨™æº–ã®æ›¸ãæ–¹ä¾‹ã€‘
â‘  æ—¥ä¸­ã®æ§˜å­ï¼šè½ã¡ç€ã„ã¦ç©ã‚„ã‹ã«éã”ã•ã‚Œã‚‹ã€‚è¡¨æƒ…ã¯å®‰å®šã€‚
â‘¡ æ”¯æ´é …ç›®ï¼ˆè‡ªå‹•ï¼‰ï¼šâ‘¡ã®ãƒã‚§ãƒƒã‚¯å†…å®¹ãŒã“ã“ã«è‡ªå‹•åæ˜ ã•ã‚Œã¾ã™ã€‚
â‘¢ å¯¾å¿œï¼šå¿…è¦æ™‚ã®ã¿å£°ã‹ã‘ãƒ»è¦‹å®ˆã‚Šãƒ»ä»‹åŠ©ã‚’è¡Œã£ãŸã€‚"></textarea>
          </div>
          <div class="field" id="noteField">
              <div style="display:flex; align-items:center; justify-content:space-between; gap:10px; flex-wrap:wrap;">
                <label for="note" style="margin:0;">æ¥­å‹™æ—¥èªŒãƒ»åˆ©ç”¨è€…ã®æ´»å‹•çŠ¶æ³ï¼ˆç‰¹è¨˜äº‹é …å«ã‚€ï¼‰</label>
                <div style="display:flex; align-items:center; gap:8px; flex-wrap:wrap;">
                  <button type="button" class="btn-secondary" id="voiceNoteBtn" style="padding:6px 10px; font-size:12px;">ğŸ™ éŸ³å£°å…¥åŠ›</button>
                  <label class="special-flag" title="äº‹æ•…ãƒ»ãƒˆãƒ©ãƒ–ãƒ«ãƒ»å—è¨ºãƒ»ç›¸è«‡ãªã©ã€å…±æœ‰ãƒ»å ±å‘Šãƒ»å¼•ç¶™ããŒå¿…è¦ãªå†…å®¹ãŒã‚ã‚‹å ´åˆã«ON">
                  <input type="checkbox" id="hasSpecialNote">
                  <span>ç‰¹è¨˜äº‹é …ã‚ã‚Š</span>
                </label>
                </div>
              </div>
              <div class="small-text special-flag-help">
                â€»äº‹æ•…ãƒ»ãƒˆãƒ©ãƒ–ãƒ«ãƒ»å—è¨ºãƒ»ç›¸è«‡ãƒ»æ€¥ãªä½“èª¿å¤‰åŒ–ãªã©ã€å…±æœ‰ãƒ»å ±å‘Šãƒ»å¼•ç¶™ããŒå¿…è¦ãªå†…å®¹ãŒã‚ã‚‹å ´åˆã«ONã€‚ONã®è¨˜éŒ²ã¯ä¸€è¦§ã§ã€Œç‰¹è¨˜äº‹é …ã€ãƒãƒƒã‚¸è¡¨ç¤ºã•ã‚Œã¾ã™ã€‚
              </div>
              <div class="small-text" id="voiceNoteStatus" style="margin-top:4px;"></div>
              </div>
              <textarea id="note" rows="10" placeholder="ä¾‹ï¼‰é€šé™¢ã€å®¶æ—ã‹ã‚‰ã®é›»è©±ã€å¤œé–“ã®è¦‹å®ˆã‚Šå¼·åŒ–ãŒå¿…è¦ ãªã©"></textarea>
            </div>

          <!-- â˜…ä¿å­˜ï¼ˆåˆå¿ƒè€…OKï¼‰ -->
          <div class="beginner-zone">
            <div style="display:flex; align-items:center; justify-content:space-between; gap:8px; flex-wrap:wrap;">
              <div style="font-weight:800; color:#1e3a8a;">â‘¤ è¨˜éŒ²ã‚’ä¿å­˜ <span class="beginner-badge">ã“ã“ã ã‘OK</span></div>
              <div class="beginner-hint">â€»çµ‚ã‚ã£ãŸã‚‰ä¿å­˜ã€‚</div>
            </div>

            <div class="btn-row" style="margin-top:10px;">
              <button type="submit" class="btn-beginner" id="saveButton">ğŸ’¾ è¨˜éŒ²ã‚’ä¿å­˜</button>
              <button type="button" class="btn-secondary" id="resetButton">ğŸ§¹ å…¥åŠ›ãƒªã‚»ãƒƒãƒˆ</button>
            </div>
          </div>

        </form>
      </section>

      <!-- ä¸€è¦§è¡¨ç¤º -->
      <section class="card records-panel">
        <div class="card-title">
          <span>è¨˜éŒ²ä¸€è¦§</span>
          <span class="record-count" id="recordCount">0ä»¶</span>
        </div>

        <div class="record-tools">
          <div class="record-tools-top">
            <button type="button"
                    onclick="window.open('records.html', '_blank')"
                    class="btn-secondary"
                    style="font-size:12px; padding:6px 10px;">
              ğŸ“„ åˆ¥ãƒšãƒ¼ã‚¸ã§é–‹ã
            </button>
            <button type="button"
                    onclick="window.open('vitals.html', '_blank')"
                    class="btn-secondary"
                    style="font-size:12px; padding:6px 10px;">
              ğŸ©º ãƒã‚¤ã‚¿ãƒ«å…¥åŠ›
            </button>
          </div>

          <div class="record-tools-bottom">
            <button type="button" class="btn-secondary" id="backupBtn"
                    style="font-size:12px; padding:6px 10px;">
              ğŸ§· ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—
            </button>

            <button type="button" class="btn-secondary" id="restoreBtn"
                    style="font-size:12px; padding:6px 10px;">
              â™» å¾©å…ƒ
            </button>
            <input type="file" id="restoreFile" accept=".json,application/json" style="display:none" />

            <button type="button" class="btn-secondary" id="exportExcelBtn"
                    style="font-size:12px; padding:6px 10px;">
              â¬‡ Excelå‡ºåŠ›
            </button>
          </div>
        </div>


        <div class="resident-select-row">
          <span>è¡¨ç¤ºã™ã‚‹åˆ©ç”¨è€…ï¼š</span>
          <select id="filterResident"></select>
          <span class="small-text">â€»ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã‚’å¤‰ãˆã‚‹ã¨ã€ãã®åˆ©ç”¨è€…ã®è¨˜éŒ²ã ã‘è¡¨ç¤ºã•ã‚Œã¾ã™ã€‚</span>
        </div>

        <div class="resident-select-row">
          <span>æœŸé–“ï¼š</span>
          <select id="periodFilter">
            <option value="today">ä»Šæ—¥</option>
            <option value="week">ç›´è¿‘7æ—¥é–“</option>
            <option value="month" selected>ä»Šæœˆ</option>
            <option value="year">ä»Šå¹´</option>
            <option value="all">å…¨æœŸé–“</option>
            <option value="custom">æ—¥ä»˜æŒ‡å®š</option>
          </select>
          <span class="small-text">â€»å…¨æœŸé–“ã¯ä»¶æ•°ãŒå¤šããªã‚‹å ´åˆãŒã‚ã‚Šã¾ã™ã€‚</span>
        </div>

        <div class="resident-select-row" id="customPeriodRow" style="display:none;">
          <span>æœŸé–“æŒ‡å®šï¼š</span>
          <input type="date" id="periodFrom">
          <span>ã€œ</span>
          <input type="date" id="periodTo">
          <button type="button" class="btn-secondary" id="applyCustomPeriod">åæ˜ </button>
        </div>

        <div class="resident-select-row">
          <span>ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰æ¤œç´¢ï¼š</span>
          <input type="text" id="searchKeyword" placeholder="ä¾‹ï¼šé€šé™¢, å¤œé–“, #ä½“èª¿ä¸è‰¯ ãªã©" style="flex:1; min-width:180px;" />
          <button type="button" class="btn-secondary" id="searchClearButton">ã‚¯ãƒªã‚¢</button>
        </div>

        <div class="resident-select-row">
          <label class="special-filter" id="specialFilterLabel" title="ã€Œç‰¹è¨˜äº‹é …ã‚ã‚Šã€ã«ãƒã‚§ãƒƒã‚¯ãŒä»˜ã„ãŸè¨˜éŒ²ã ã‘ã‚’è¡¨ç¤ºã—ã¾ã™">
            <input type="checkbox" id="filterSpecialOnly">
            <span>ç‰¹è¨˜äº‹é …ã‚ã‚Šã®ã¿è¡¨ç¤º</span>
          </label>
          <span class="small-text" id="specialOnlyCount" style="margin-left:8px;"></span>
        </div>


        <div class="table-wrapper" id="tableWrapper">
          <table>
            <thead>
  <tr>
    <th>æ—¥ä»˜</th>
    <th>åˆ©ç”¨è€…</th>
    <th>æ—¥ä¸­ã®ä¸»ãªæ”¯æ´</th>
    <th>æ”¯æ´å†…å®¹ãƒ»ã‚¿ã‚°</th>
    <th>æ“ä½œ</th>
  </tr>
</thead>
            <tbody id="recordTableBody"></tbody>
          </table>
        </div>
      </section>
    </div>

    <!-- ====== ã“ã“ã‹ã‚‰ä¸‹ï¼šç®¡ç†ã‚¨ãƒªã‚¢ï¼ˆåˆå¿ƒè€…ã¯åŸºæœ¬è§¦ã‚‰ãªã„ï¼‰ ====== -->

    <!-- åˆ©ç”¨è€…ç®¡ç† -->
    <section class="card admin-card">
      <div class="card-title">
        <span>â‘  åˆ©ç”¨è€…ç®¡ç†</span>
        <span class="admin-pill">ç®¡ç†ï¼ˆæ…£ã‚ŒãŸäººå‘ã‘ï¼‰</span>
        <span class="record-count" id="residentCount">0å</span>
      </div>
      <div class="card-subtitle">
        åˆ©ç”¨è€…åã®è¿½åŠ ãƒ»å¤‰æ›´ãƒ»å‰Šé™¤ã‚’è¡Œã„ã¾ã™ã€‚ã“ã“ã§å¤‰æ›´ã™ã‚‹ã¨ã€è¨˜éŒ²ä¸€è¦§ã®è¡¨ç¤ºã«ã‚‚åæ˜ ã•ã‚Œã¾ã™ã€‚
      </div>

      <div class="field-row">
        <div class="field">
          <label for="residentManageSelect">å¯¾è±¡ã®åˆ©ç”¨è€…</label>
          <select id="residentManageSelect"></select>
        </div>
        <div class="field">
          <label for="residentNameInput">åå‰ï¼ˆè¿½åŠ ãƒ»å¤‰æ›´å¾Œï¼‰</label>
          <input type="text" id="residentNameInput" placeholder="ä¾‹ï¼šAã•ã‚“" />
        </div>
      </div>

      <div class="btn-row">
        <button type="button" class="btn-primary" id="residentAddButton">ï¼‹ æ–°ã—ãè¿½åŠ </button>
        <button type="button" class="btn-secondary" id="residentRenameButton">âœï¸ é¸æŠã‚’ã“ã®åå‰ã«å¤‰æ›´</button>
        <button type="button" class="btn-danger" id="residentDeleteButton">ğŸ—‘ï¸ åˆ©ç”¨è€…ã¨è¨˜éŒ²ã‚’å‰Šé™¤</button>
      </div>

      <div class="admin-note">â€»å‰Šé™¤ã™ã‚‹ã¨ã€ãã®åˆ©ç”¨è€…ã®ã™ã¹ã¦ã®è¨˜éŒ²ã‚‚å‰Šé™¤ã•ã‚Œã¾ã™ã€‚</div>
    </section>

    <!-- è¨˜éŒ²è€…ç®¡ç† -->
    <section class="card admin-card">
      <div class="card-title">
        <span>â‘  è¨˜éŒ²è€…ç®¡ç†</span>
        <span class="admin-pill">ç®¡ç†ï¼ˆæ…£ã‚ŒãŸäººå‘ã‘ï¼‰</span>
        <span class="record-count" id="recorderCount">0å</span>
      </div>
      <div class="card-subtitle">
        è¨˜éŒ²è€…ï¼ˆè·å“¡åï¼‰ã®è¿½åŠ ãƒ»å¤‰æ›´ãƒ»å‰Šé™¤ã‚’è¡Œã„ã¾ã™ã€‚ã“ã“ã§å¤‰æ›´ã™ã‚‹ã¨ã€ãƒ•ã‚©ãƒ¼ãƒ ã®ã€Œè¨˜éŒ²è€…ã€å€™è£œã«ã‚‚åæ˜ ã•ã‚Œã¾ã™ã€‚
      </div>

      <div class="field-row">
        <div class="field">
          <label for="recorderManageSelect">å¯¾è±¡ã®è¨˜éŒ²è€…</label>
          <select id="recorderManageSelect"></select>
        </div>
        <div class="field">
          <label for="recorderNameInput">åå‰ï¼ˆè¿½åŠ ãƒ»å¤‰æ›´å¾Œï¼‰</label>
          <input type="text" id="recorderNameInput" placeholder="ä¾‹ï¼šè·å“¡A" />
        </div>
      </div>

      <div class="btn-row">
        <button type="button" class="btn-primary" id="recorderAddButton">ï¼‹ æ–°ã—ãè¿½åŠ </button>
        <button type="button" class="btn-secondary" id="recorderRenameButton">âœï¸ é¸æŠã‚’ã“ã®åå‰ã«å¤‰æ›´</button>
        <button type="button" class="btn-danger" id="recorderDeleteButton">ğŸ—‘ï¸ è¨˜éŒ²è€…ã‚’å‰Šé™¤</button>
      </div>

      <div class="admin-note">â€»å‰Šé™¤ã—ã¦ã‚‚éå»ã®è¨˜éŒ²ãƒ‡ãƒ¼ã‚¿ã¯æ¶ˆãˆã¾ã›ã‚“ï¼ˆè¡¨ç¤ºå€™è£œã‹ã‚‰å¤–ã‚Œã‚‹ã ã‘ã§ã™ï¼‰ã€‚</div>
    </section>

    <!-- è‡ªå‹•å…¥åŠ›é …ç›® ç®¡ç† -->
    <section class="card admin-card">
      <div class="card-title">
        <span>â‘¡ è‡ªå‹•å…¥åŠ›ã®æ”¯æ´é …ç›® ç®¡ç†ï¼ˆã‚µã‚¤ãƒˆä¸Šã§è¿½åŠ ãƒ»ç·¨é›†ãƒ»å‰Šé™¤ï¼‰</span>
        <span class="admin-pill">ç®¡ç†ï¼ˆæ…£ã‚ŒãŸäººå‘ã‘ï¼‰</span>
        <span class="record-count" id="autoItemCount">0ä»¶</span>
      </div>
      <div class="card-subtitle">
        ã“ã“ã§è¿½åŠ ã—ãŸé …ç›®ã¯ã€ä¸Šã®ã€Œè‡ªå‹•å…¥åŠ›ã—ãŸã„æ”¯æ´é …ç›®ã€ã«è‡ªå‹•ã§è¡¨ç¤ºã•ã‚Œã¾ã™ã€‚<br>
        â€»ã“ã®PCï¼ˆãƒ–ãƒ©ã‚¦ã‚¶ï¼‰å†…ã«ä¿å­˜ã•ã‚Œã¾ã™ã€‚ä»–PCã¨ã¯å…±æœ‰ã•ã‚Œã¾ã›ã‚“ã€‚
      </div>

      <div class="field-row">
        <div class="field">
          <label for="autoItemSelect">æ—¢å­˜é …ç›®ï¼ˆç·¨é›†ã—ãŸã„å ´åˆã«é¸æŠï¼‰</label>
          <select id="autoItemSelect">
            <option value="">ï¼ˆæ–°è¦è¿½åŠ ï¼‰</option>
          </select>
          <div class="small-text">é¸ã¶ã¨ä¸‹ã®å…¥åŠ›æ¬„ã«å†…å®¹ãŒå…¥ã‚Šã¾ã™ã€‚</div>
        </div>
        <div class="field">
          <label for="autoItemKey">å†…éƒ¨ã‚­ãƒ¼ï¼ˆè‹±æ•°å­—ãƒ»é‡è¤‡ä¸å¯ï¼‰</label>
          <input type="text" id="autoItemKey" placeholder="ä¾‹ï¼šmoney_support" />
          <div class="small-text">â€»æœ€åˆã«æ±ºã‚ãŸã‚‰ã€åŸºæœ¬å¤‰æ›´ã—ãªã„ã®ãŒå®‰å…¨ã§ã™ã€‚</div>
        </div>
      </div>

      <div class="field-row">
        <div class="field">
          <label for="autoItemLabel">è¡¨ç¤ºå</label>
          <input type="text" id="autoItemLabel" placeholder="ä¾‹ï¼šé‡‘éŠ­ç®¡ç†" />
        </div>
        <div class="field">
          <label for="autoItemText">è‡ªå‹•ã§è¿½è¨˜ã™ã‚‹å®šå‹æ–‡</label>
          <textarea id="autoItemText" rows="3" placeholder="ä¾‹ï¼šã€é‡‘éŠ­ç®¡ç†ã€‘é‡‘éŠ­ã®ç¢ºèªã¨å£°ã‹ã‘ã‚’è¡Œã„ã€å¿…è¦ã«å¿œã˜ã¦æ”¯æ´ã—ãŸã€‚"></textarea>
          <div class="small-text">
            æ—¥ä¸­æ”¯æ´åŠ ç®—ã®åŒºåˆ†ã‚’å…¥ã‚ŒãŸã„å ´åˆï¼š<br>
            <b>{{daySupportTypeLabel}}</b> ã‚’æ–‡ä¸­ã«å…¥ã‚Œã‚‹ã¨ã€Œæ—¥ä¸­æ”¯æ´åŠ ç®—â… /â…¡ã€ã«ç½®æ›ã•ã‚Œã¾ã™ã€‚
          </div>
        </div>
      </div>

      <div class="btn-row">
        <button type="button" class="btn-primary" id="autoItemSaveBtn">ğŸ’¾ è¿½åŠ  / æ›´æ–°</button>
        <button type="button" class="btn-danger" id="autoItemDeleteBtn">ğŸ—‘ï¸ é¸æŠé …ç›®ã‚’å‰Šé™¤</button>
        <button type="button" class="btn-secondary" id="autoItemClearBtn">ğŸ§¹ å…¥åŠ›ã‚¯ãƒªã‚¢</button>
        <button type="button" class="btn-secondary" id="autoItemResetDefaultBtn">â†© åˆæœŸé …ç›®ã«æˆ»ã™</button>
      </div>

      <div class="admin-note">â€»åˆå¿ƒè€…ã¯åŸºæœ¬ã“ã“ã‚’è§¦ã‚‰ãªãã¦OKã§ã™ã€‚</div>
    </section>

    <!-- âœ… ã‚ˆãä½¿ã†é …ç›® ç®¡ç†ï¼ˆåˆ©ç”¨è€…åˆ¥ï¼‰ -->
    <section class="card admin-card">
      <div class="card-title">
        <span>â‘¡â‘¢ ã‚ˆãä½¿ã†é …ç›® ç®¡ç†ï¼ˆåˆ©ç”¨è€…åˆ¥ï¼‰</span>
        <span class="admin-pill">ç®¡ç†ï¼ˆæ…£ã‚ŒãŸäººå‘ã‘ï¼‰</span>
      </div>
      <div class="card-subtitle">
        åˆ©ç”¨è€…ã”ã¨ã«ã€Œâ‘¡ è‡ªå‹•å…¥åŠ›ã€ã¨ã€Œâ‘¢ æ—¥ä¸­ã«è¡Œã£ãŸä¸»ãªæ”¯æ´ã€ã®åˆæœŸãƒã‚§ãƒƒã‚¯ã‚’ä¿å­˜ã§ãã¾ã™ï¼ˆä¿å­˜ã—ãŸå†…å®¹ãŒã‚ã‚‹å ´åˆã®ã¿è‡ªå‹•åæ˜ ã•ã‚Œã¾ã™ï¼‰ã€‚å…¥æµ´å¯¾å¿œãƒ»ä½“èª¿ç®¡ç†ã¯ã‚µãƒ–ãƒã‚§ãƒƒã‚¯ã‚‚ä¿å­˜ã§ãã¾ã™ã€‚
      </div>

      <div class="field">
        <label for="favResidentSelect">å¯¾è±¡ã®åˆ©ç”¨è€…</label>
        <select id="favResidentSelect"></select>
      </div>

      <div class="field">
        <label>ã‚ˆãä½¿ã†é …ç›®ï¼ˆè‡ªå‹•å…¥åŠ›ï¼‰</label>
        <div class="checkbox-row" id="favAutoItemCheckboxes"></div>
      </div>

      <div class="field" style="margin-top:10px;">
        <label>æ—¥ä¸­ã«è¡Œã£ãŸä¸»ãªæ”¯æ´ï¼ˆã‚ˆãä½¿ã†ï¼‰</label>
        <div class="checkbox-row checkbox-grid" id="favDaySupportMainCheckboxes"></div>
        <div class="small-text">â€»ã“ã®åˆ©ç”¨è€…ã«ä¿å­˜ã—ãŸåˆæœŸå€¤ãŒã‚ã‚‹å ´åˆã€ãƒ•ã‚©ãƒ¼ãƒ ã®ãƒã‚§ãƒƒã‚¯ã«è‡ªå‹•åæ˜ ã•ã‚Œã¾ã™ã€‚</div>
      </div>

      <div class="btn-row">
        <button type="button" class="btn-primary" id="favSaveBtn">ğŸ’¾ ä¿å­˜</button>
        <button type="button" class="btn-secondary" id="favApplyNowBtn">â†ª ä»Šã™ããƒ•ã‚©ãƒ¼ãƒ ã¸åæ˜ </button>
        <button type="button" class="btn-secondary" id="favClearBtn">ğŸ§¹ å…¨è§£é™¤</button>
      </div>
    </section>

    <!-- âœ… ğŸ›  æ—¥ä¸­æ”¯æ´ãƒã‚§ãƒƒã‚¯ç·¨é›†ï¼ˆåˆ©ç”¨è€…åˆ¥ï¼‰ -->
    <section class="card admin-card">
      <div class="card-title">
        <span>â‘¢ã€æ—¥ä¸­ã«è¡Œã£ãŸä¸»ãªæ”¯æ´ã€‘ ğŸ›  æ—¥ä¸­æ”¯æ´ãƒã‚§ãƒƒã‚¯ç·¨é›†ï¼ˆåˆ©ç”¨è€…åˆ¥ï¼‰</span>
        <span class="admin-pill">ç®¡ç†ï¼ˆæ…£ã‚ŒãŸäººå‘ã‘ï¼‰</span>
      </div>
      <div class="card-subtitle">
        åˆ©ç”¨è€…ã”ã¨ã«ã€Œä¸»ãªæ”¯æ´ã€ã€Œæ¬ å¸­ç†ç”±ã€ã®ãƒã‚§ãƒƒã‚¯é …ç›®ãƒªã‚¹ãƒˆã‚’ç·¨é›†ã§ãã¾ã™ï¼ˆ1è¡Œ=1é …ç›®ï¼‰ã€‚
      </div>

      <div class="field">
        <label for="dsResidentSelect">å¯¾è±¡ã®åˆ©ç”¨è€…</label>
        <select id="dsResidentSelect"></select>
      </div>

      <div class="field-row">
        <div class="field">
          <label for="dsMainList">ä¸»ãªæ”¯æ´ï¼ˆ1è¡Œ=1é …ç›®ï¼‰</label>
          <textarea id="dsMainList" rows="8"></textarea>
        </div>
        <div class="field">
          <label for="dsReasonList">æ¬ å¸­ç†ç”±ï¼ˆ1è¡Œ=1é …ç›®ï¼‰</label>
          <textarea id="dsReasonList" rows="8"></textarea>
        </div>
      </div>

      <div class="btn-row">
        <button type="button" class="btn-primary" id="dsSaveBtn">ğŸ’¾ ä¿å­˜</button>
        <button type="button" class="btn-secondary" id="dsResetBtn">â†© åˆæœŸã«æˆ»ã™</button>
      </div>

      <div class="admin-note">â€»åˆå¿ƒè€…ã¯åŸºæœ¬ã“ã“ã‚’è§¦ã‚‰ãªãã¦OKã§ã™ã€‚</div>
    </section>

    <!-- â˜…ã‚¿ã‚°ç®¡ç†ï¼ˆè¿½åŠ ãƒ»ç·¨é›†ãƒ»å‰Šé™¤ï¼‰ -->
    <section class="card admin-card">
      <div class="card-title">
        <span>ã‚¿ã‚° ç®¡ç†ï¼ˆè¿½åŠ ãƒ»ç·¨é›†ãƒ»å‰Šé™¤ï¼‰</span>
        <span class="admin-pill">ç®¡ç†ï¼ˆæ…£ã‚ŒãŸäººå‘ã‘ï¼‰</span>
        <span class="record-count" id="tagCount">0ä»¶</span>
      </div>
      <div class="card-subtitle">
        ã“ã“ã§ä½œã£ãŸã‚¿ã‚°ã¯ã€ä¸Šã®ã€Œã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ï¼ˆã‚¿ã‚°ï¼‰ã€ã®ãƒœã‚¿ãƒ³ã«åæ˜ ã•ã‚Œã¾ã™ã€‚<br>
        â€»ã“ã®PCï¼ˆãƒ–ãƒ©ã‚¦ã‚¶ï¼‰å†…ã«ä¿å­˜ã•ã‚Œã¾ã™ã€‚ä»–PCã¨ã¯å…±æœ‰ã•ã‚Œã¾ã›ã‚“ã€‚
      </div>

      <div class="field-row">
        <div class="field">
          <label for="tagSelect">æ—¢å­˜ã‚¿ã‚°ï¼ˆç·¨é›†ã—ãŸã„å ´åˆã«é¸æŠï¼‰</label>
          <select id="tagSelect">
            <option value="">ï¼ˆæ–°è¦è¿½åŠ ï¼‰</option>
          </select>
          <div class="small-text">é¸ã¶ã¨å³ã®å…¥åŠ›æ¬„ã«å…¥ã‚Šã¾ã™ã€‚</div>
        </div>
        <div class="field">
          <label for="tagNameInput">ã‚¿ã‚°åï¼ˆ#ã¯ä¸è¦ï¼‰</label>
          <input type="text" id="tagNameInput" placeholder="ä¾‹ï¼šé€šé™¢ / å¤œé–“å¯¾å¿œ / ä½“èª¿ä¸è‰¯ ãªã©" />
          <div class="small-text">â€»ã€Œ#ã€ã¯è‡ªå‹•ã§ä»˜ãã®ã§å…¥åŠ›ä¸è¦ã§ã™ã€‚</div>
        </div>
      </div>

      <div class="btn-row">
        <button type="button" class="btn-primary" id="tagSaveBtn">ğŸ’¾ è¿½åŠ  / æ›´æ–°</button>
        <button type="button" class="btn-danger" id="tagDeleteBtn">ğŸ—‘ï¸ é¸æŠã‚¿ã‚°ã‚’å‰Šé™¤</button>
        <button type="button" class="btn-secondary" id="tagClearBtn">ğŸ§¹ å…¥åŠ›ã‚¯ãƒªã‚¢</button>
        <button type="button" class="btn-secondary" id="tagResetDefaultBtn">â†© åˆæœŸã‚¿ã‚°ã«æˆ»ã™</button>
      </div>

      <div class="admin-note">â€»åˆå¿ƒè€…ã¯åŸºæœ¬ã“ã“ã‚’è§¦ã‚‰ãªãã¦OKã§ã™ã€‚</div>
    </section>

  </main>

  <!-- è¨˜éŒ²ã®è©³ç´°ãƒ¢ãƒ¼ãƒ€ãƒ« -->
  <div id="detailModal" class="detail-modal-backdrop">
    <div class="detail-modal">
      <div class="detail-modal-header">
        <div class="detail-modal-title" id="detailModalTitle">è¨˜éŒ²ã®è©³ç´°</div>
        <button type="button" class="detail-modal-close" id="detailModalClose">Ã—</button>
      </div>
      <div class="detail-modal-body" id="detailModalContent"></div>
    </div>
  </div>

  <!-- è¨˜éŒ²ã®ç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ«ï¼ˆå°çª“ï¼‰ -->
  <div id="editModal" class="detail-modal-backdrop">
    <div class="detail-modal">
      <div class="detail-modal-header">
        <div class="detail-modal-title" id="editModalTitle">è¨˜éŒ²ã®ç·¨é›†</div>
        <button type="button" class="detail-modal-close" id="editModalClose">Ã—</button>
      </div>

      <div class="detail-modal-body">
        <div class="field-row">
          <div class="field">
            <label for="editDate">æ—¥ä»˜</label>
            <input type="date" id="editDate" />
          </div>
          <div class="field">
            <label for="editResident">åˆ©ç”¨è€…</label>
            <select id="editResident"></select>
          </div>
        </div>


        <div class="field" style="margin-top:10px;">
          <label for="editRecorder">è¨˜éŒ²è€…</label>
          <select id="editRecorder"></select>
        </div>
<div class="field vitals-compact" id="editAbnormalVitalsBox" style="margin-top:8px;">
            <div class="vitals-title">ä½“é‡ãƒ»è¡€åœ§ãƒ»è„ˆæ‹ï¼ˆç•°å¸¸ãŒã‚ã£ãŸå ´åˆã®ã¿ï¼‰</div>
            <div class="small-text" style="margin:4px 0 6px;">â€»ç•°å¸¸ã‚„æ°—ã«ãªã‚‹å¤‰åŒ–ãŒã‚ã£ãŸå ´åˆã®ã¿è¨˜å…¥ã€‚æ™®æ®µã¯ç©ºæ¬„ã§OKã€‚</div>
<div class="field-row-4" id="editAbnormalVitalsInputs" style="align-items:end;">
              <div class="field" style="margin-bottom:0;">
                <label for="editAbnormalWeight">ä½“é‡ï¼ˆkgï¼‰</label>
                <input type="text" id="editAbnormalWeight" placeholder="ä¾‹ï¼š56.2" inputmode="decimal" />
              </div>
              <div class="field" style="margin-bottom:0;">
                <label for="editAbnormalBPsys">è¡€åœ§ï¼ˆä¸Š / mmHgï¼‰</label>
                <input type="text" id="editAbnormalBPsys" placeholder="ä¾‹ï¼š120" inputmode="numeric" />
              </div>
              <div class="field" style="margin-bottom:0;">
                <label for="editAbnormalBPdia">è¡€åœ§ï¼ˆä¸‹ / mmHgï¼‰</label>
                <input type="text" id="editAbnormalBPdia" placeholder="ä¾‹ï¼š80" inputmode="numeric" />
              </div>
              <div class="field" style="margin-bottom:0;">
                <label for="editAbnormalPulse">è„ˆæ‹ï¼ˆå›/åˆ†ï¼‰</label>
                <input type="text" id="editAbnormalPulse" placeholder="ä¾‹ï¼š72" inputmode="numeric" />
              </div>
            </div>
            <div class="small-text" style="margin-top:6px;">â€»ä»»æ„ã€‚å…¥åŠ›ã™ã‚‹ã¨æ¥­å‹™æ—¥èªŒã®è‡ªå‹•æ¬„ã«ã‚‚åæ˜ ã•ã‚Œã¾ã™ã€‚</div>
          </div>
        <div class="field">
          <label>ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ï¼ˆã‚¿ã‚°ï¼‰</label>
          <div class="tag-buttons" id="editTagButtons"></div>
          <div class="small-text" id="editSelectedTagsInfo">é¸æŠä¸­ï¼šãªã—</div>
        </div>

        <div class="field">
          <label for="editDaySupportType">æ—¥ä¸­æ”¯æ´åŠ ç®—ã®åŒºåˆ†</label>
          <select id="editDaySupportType">
            <option value="">é¸æŠãªã—</option>
            <option value="â… ">æ—¥ä¸­æ”¯æ´åŠ ç®—â… </option>
            <option value="â…¡">æ—¥ä¸­æ”¯æ´åŠ ç®—â…¡</option>
          </select>
        </div>
<div class="beginner-zone" style="margin-top:10px;">
  <div style="display:flex; align-items:center; justify-content:space-between; gap:8px; flex-wrap:wrap;">
    <div style="font-weight:800; color:#1e3a8a;">â‘£ æ—¥ä¸­æ´»å‹•</div>
    <div class="beginner-hint">â€»é€šæ‰€/æ¬ å¸­ã‚’ãƒã‚§ãƒƒã‚¯ã€‚</div>
  </div>

  <div class="field" style="margin-top:8px;">
    <label>æ—¥ä¸­æ´»å‹•ï¼ˆAå‹ / Bå‹ï¼‰</label>
    <div class="checkbox-row" id="editDayActivityCheckboxes"></div>
  </div>

  <div class="field">
    <label>ã€æ—¥ä¸­æ´»å‹•ã«è¡Œã‘ãªã‹ã£ãŸç†ç”±ã€‘ï¼ˆä»»æ„ï¼‰</label>
    <div class="checkbox-row" id="editDaySupportReasonCheckboxes"></div>
  </div>

  <div class="field">
    <label>ã€æ—¥ä¸­ã«è¡Œã£ãŸä¸»ãªæ”¯æ´ã€‘</label>
    <div class="checkbox-row checkbox-grid" id="editDaySupportMainCheckboxes"></div>
  </div>
</div>

<div class="field" style="margin-top:18px;">
  <label for="editSupport">æœ¬æ—¥ã®æ”¯æ´å†…å®¹ (è·å“¡å´)</label>
          <textarea id="editSupport" rows="8"></textarea>
        </div>

        <div class="field" id="editNoteField">
          <div style="display:flex; align-items:center; justify-content:space-between; gap:10px; flex-wrap:wrap;">
            <label for="editNote" style="margin:0;">æ¥­å‹™æ—¥èªŒãƒ»åˆ©ç”¨è€…ã®æ´»å‹•çŠ¶æ³ï¼ˆç‰¹è¨˜äº‹é …å«ã‚€ï¼‰</label>
            <div style="display:flex; align-items:center; gap:8px; flex-wrap:wrap;">
              <button type="button" class="btn-secondary" id="voiceEditNoteBtn" style="padding:6px 10px; font-size:12px;">ğŸ™ éŸ³å£°å…¥åŠ›</button>
              <label class="special-flag" title="äº‹æ•…ãƒ»ãƒˆãƒ©ãƒ–ãƒ«ãƒ»å—è¨ºãƒ»ç›¸è«‡ãªã©ã€å…±æœ‰ãƒ»å ±å‘Šãƒ»å¼•ç¶™ããŒå¿…è¦ãªå†…å®¹ãŒã‚ã‚‹å ´åˆã«ON">
              <input type="checkbox" id="editHasSpecialNote">
              <span>ç‰¹è¨˜äº‹é …ã‚ã‚Š</span>
            </label>
            </div>
          </div>
          <div class="small-text special-flag-help">
            â€»äº‹æ•…ãƒ»ãƒˆãƒ©ãƒ–ãƒ«ãƒ»å—è¨ºãƒ»ç›¸è«‡ãƒ»æ€¥ãªä½“èª¿å¤‰åŒ–ãªã©ã€å…±æœ‰ãƒ»å ±å‘Šãƒ»å¼•ç¶™ããŒå¿…è¦ãªå†…å®¹ãŒã‚ã‚‹å ´åˆã«ONã€‚ONã®è¨˜éŒ²ã¯ä¸€è¦§ã§ã€Œç‰¹è¨˜äº‹é …ã€ãƒãƒƒã‚¸è¡¨ç¤ºã•ã‚Œã¾ã™ã€‚
          </div>
          <div class="small-text" id="voiceEditNoteStatus" style="margin-top:4px;"></div>

          <div class="daynote-template-box" style="margin-top:6px;">
            <div class="daynote-template-head">
              <div class="daynote-template-title">æ—¥ä¸­æ”¯æ´ãƒ†ãƒ³ãƒ—ãƒ¬ï¼ˆæ—¥ä¸­æ”¯æ´åŠ ç®—â… ãƒ»æ¥­å‹™æ—¥èªŒã¸è¿½è¨˜ï¼‰</div>
            </div>
            <div class="checkbox-row daynote-template-grid" id="editDayNoteTemplateChecks" style="margin-top:8px;"></div>
            <div class="small-text">â€»æ—¥ä¸­æ”¯æ´åŠ ç®—â… ã®è¨˜éŒ²ç”¨ãƒ†ãƒ³ãƒ—ãƒ¬ã§ã™ã€‚â‘ â‘¡â‘¢ï¼ˆè‰²ä»˜ãï¼‰ã®ã©ã‚Œã‹ã‚’é¸ã¶ã¨ã€Œæ¥­å‹™æ—¥èªŒã€ã«è‡ªå‹•è¿½è¨˜ã•ã‚Œã¾ã™ã€‚OFFã«ã™ã‚‹ã¨ã€ãã®ãƒ†ãƒ³ãƒ—ãƒ¬ã§è¿½åŠ ã—ãŸæ–‡ç« ã ã‘å‰Šé™¤ã•ã‚Œã¾ã™ï¼ˆæ‰‹å…¥åŠ›ã¯æ¶ˆãˆã¾ã›ã‚“ï¼‰ã€‚</div>
          </div>


          </div>
          <textarea id="editNote" rows="10"></textarea>
        </div>

        <div class="btn-row" style="margin-top:10px;">
          <button type="button" class="btn-primary" id="editModalSaveBtn">ğŸ’¾ ä¸Šæ›¸ãä¿å­˜</button>
          <button type="button" class="btn-secondary" id="editModalCancelBtn">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
        </div>

        <div class="small-text" style="margin-top:6px;">
          â€»ã“ã“ã§ä¿å­˜ã™ã‚‹ã¨ä¸€è¦§ãŒæ›´æ–°ã•ã‚Œã¾ã™ï¼ˆå·¦ã®ãƒ•ã‚©ãƒ¼ãƒ ã¯è§¦ã‚‰ãªãã¦OKï¼‰
        </div>
      </div>
    </div>
  </div>

  <!-- âœ… ã‚ˆãä½¿ã†é …ç›®ï¼ˆã“ã®åˆ©ç”¨è€…ï¼‰ç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ«ï¼šâ€»é‡è¤‡ã‚’å»ƒæ­¢ã—ã¦1ã¤ã«çµ±ä¸€ -->
  <div id="favModal" class="detail-modal-backdrop">
    <div class="detail-modal">
      <div class="detail-modal-header">
        <div class="detail-modal-title" id="favModalTitle">ã‚ˆãä½¿ã†é …ç›®ï¼ˆã“ã®åˆ©ç”¨è€…ï¼‰</div>
        <button type="button" class="detail-modal-close" id="favModalClose">Ã—</button>
      </div>
      <div class="detail-modal-body">
        <div class="small-text" style="margin-bottom:8px;">
          â€»ã“ã®åˆ©ç”¨è€…ã®ã€ŒåˆæœŸå€¤ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§ONã«ã—ãŸã„ãƒã‚§ãƒƒã‚¯ï¼‰ã€ã‚’ã“ã“ã§ä¿å­˜ã§ãã¾ã™ã€‚
        </div>

        <div class="field">
          <label>ã‚ˆãä½¿ã†é …ç›®ï¼ˆè‡ªå‹•å…¥åŠ›ï¼‰</label>
          <div class="checkbox-row" id="favModalCheckboxes"></div>
        </div>

        <div class="field" style="margin-top:10px;">
          <label>æ—¥ä¸­ã«è¡Œã£ãŸä¸»ãªæ”¯æ´ï¼ˆã‚ˆãä½¿ã†ï¼‰</label>
          <div class="checkbox-row checkbox-grid" id="favModalDaySupportMainCheckboxes"></div>
        </div>

        <div class="btn-row" style="margin-top:10px;">
          <button type="button" class="btn-primary" id="favModalSave">ğŸ’¾ ä¿å­˜</button>
          <button type="button" class="btn-secondary" id="favModalCancel">é–‰ã˜ã‚‹</button>
        </div>
      </div>
    </div>
  </div>

  <!-- âœ… è‡ªå‹•ãƒ†ãƒ³ãƒ—ãƒ¬ï¼ˆåˆ©ç”¨è€…åˆ¥ï¼‰ å°çª“ãƒ¢ãƒ¼ãƒ€ãƒ«ï¼šç„¡ã„ã¨JSãŒæ­¢ã¾ã‚‹ã®ã§è¿½åŠ  -->
  <!-- æ—¥ä¸­æ”¯æ´ãƒã‚§ãƒƒã‚¯ï¼ˆã“ã®åˆ©ç”¨è€…ï¼‰ç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ« -->
  <div id="dsModal" class="detail-modal-backdrop">
    <div class="detail-modal">
      <div class="detail-modal-header">
        <div class="detail-modal-title" id="dsModalTitle">æ—¥ä¸­æ”¯æ´ãƒã‚§ãƒƒã‚¯ç·¨é›†ï¼ˆåˆ©ç”¨è€…åˆ¥ï¼‰</div>
        <button type="button" class="detail-modal-close" id="dsModalClose">Ã—</button>
      </div>
      <div class="detail-modal-body">
        <div class="small-text" id="dsModalResidentInfo" style="margin-bottom:8px;"></div>

        <div class="field-row">
          <div class="field">
            <label for="dsModalMain">ä¸»ãªæ”¯æ´ï¼ˆ1è¡Œ=1é …ç›®ï¼‰</label>
            <textarea id="dsModalMain" rows="10"></textarea>
          </div>
          <div class="field">
            <label for="dsModalReason">æ¬ å¸­ç†ç”±ï¼ˆ1è¡Œ=1é …ç›®ï¼‰</label>
            <textarea id="dsModalReason" rows="10"></textarea>
          </div>
        </div>

        <div class="btn-row" style="margin-top:10px;">
          <button type="button" class="btn-primary" id="dsModalSaveBtn">ğŸ’¾ ä¿å­˜</button>
          <button type="button" class="btn-secondary" id="dsModalResetBtn">â†© åˆæœŸã«æˆ»ã™</button>
          <button type="button" class="btn-secondary" id="dsModalCloseBtn">é–‰ã˜ã‚‹</button>
        </div>
      </div>
    </div>
  </div>

  

  <!-- æ—¥ä¸­æ”¯æ´ãƒ†ãƒ³ãƒ—ãƒ¬ï¼ˆå…±é€šï¼‰ç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ« -->
  <div id="dayNoteTplModal" class="detail-modal-backdrop">
    <div class="detail-modal">
      <div class="detail-modal-header">
        <div class="detail-modal-title" id="dayNoteTplModalTitle">æ—¥ä¸­æ”¯æ´ãƒ†ãƒ³ãƒ—ãƒ¬ç·¨é›†ï¼ˆå…±é€šï¼‰</div>
        <button type="button" class="detail-modal-close" id="dayNoteTplModalClose">Ã—</button>
      </div>
      <div class="detail-modal-body">
        <div class="small-text" style="margin-bottom:8px;">â‘¢ã®ã€Œæ—¥ä¸­æ”¯æ´ãƒ†ãƒ³ãƒ—ãƒ¬ï¼ˆæ—¥ä¸­æ”¯æ´åŠ ç®—â… ãƒ»æ¥­å‹™æ—¥èªŒã¸è¿½è¨˜ï¼‰ã€ã§ä½¿ã†ãƒ†ãƒ³ãƒ—ãƒ¬ã§ã™ã€‚ãƒã‚§ãƒƒã‚¯ã™ã‚‹ã¨æ¥­å‹™æ—¥èªŒã¸è¿½è¨˜ã•ã‚Œã¾ã™ã€‚</div>

        <div class="field-row">
          <div class="field">
            <label for="dnTplSelect">æ—¢å­˜ãƒ†ãƒ³ãƒ—ãƒ¬</label>
            <select id="dnTplSelect">
              <option value="">ï¼ˆæ–°è¦ä½œæˆï¼‰</option>
            </select>
            <div class="small-text">é¸ã¶ã¨ä¸‹ã®å…¥åŠ›æ¬„ã«å…¥ã‚Šã¾ã™ã€‚</div>
          </div>
          <div class="field">
            <label for="dnTplName">ãƒ†ãƒ³ãƒ—ãƒ¬å</label>
            <input type="text" id="dnTplName" placeholder="ä¾‹ï¼šæ•£æ­©åŒè¡Œï¼ˆä½™æš‡ï¼‰" />
          </div>
        </div>

        <div class="field">
          <label for="dnTplText">ãƒ†ãƒ³ãƒ—ãƒ¬æœ¬æ–‡ï¼ˆæ¥­å‹™æ—¥èªŒã¸è¿½è¨˜ï¼‰</label>
          <textarea id="dnTplText" rows="7" placeholder="ä¾‹ï¼‰ã€æ—¥ä¸­æ”¯æ´ï¼ˆä½™æš‡ï¼‰ã€‘è·å“¡åŒè¡Œã§æ•£æ­©ã¸å¤–å‡ºã€‚æœ¬äººã®æ§˜å­ï¼šï¼¿ï¼¿ã€‚æ”¯æ´ï¼šå£°ã‹ã‘ãƒ»è¦‹å®ˆã‚Šï¼ˆå¿…è¦æ™‚ä»‹åŠ©ï¼‰ã€‚å®‰å…¨é…æ…®ï¼šè»¢å€’ãƒ»äº¤é€šã«ç•™æ„ã€‚çµæœï¼šï¼¿ï¼¿ã€‚"></textarea>
        </div>

        <div class="btn-row" style="margin-top:10px;">
          <button type="button" class="btn-primary" id="dnTplSaveBtn">ğŸ’¾ è¿½åŠ  / æ›´æ–°</button>
          <button type="button" class="btn-danger" id="dnTplDeleteBtn">ğŸ—‘ï¸ å‰Šé™¤</button>
          <button type="button" class="btn-secondary" id="dnTplClearBtn">ğŸ§¹ æ–°è¦å…¥åŠ›ã«æˆ»ã™</button>
          <button type="button" class="btn-secondary" id="dnTplResetDefaultBtn">â†© åˆæœŸãƒ†ãƒ³ãƒ—ãƒ¬ã«æˆ»ã™</button>
          <button type="button" class="btn-secondary" id="dayNoteTplModalCloseBtn">é–‰ã˜ã‚‹</button>
        </div>

        <div class="small-text" style="margin-top:8px;">â€»ãƒ†ãƒ³ãƒ—ãƒ¬ã¯ã“ã®PCï¼ˆãƒ–ãƒ©ã‚¦ã‚¶ï¼‰å†…ã«ä¿å­˜ã•ã‚Œã¾ã™ã€‚ä»–PCã¨ã¯å…±æœ‰ã•ã‚Œã¾ã›ã‚“ã€‚</div>
      </div>
    </div>
  </div>
<!-- ãƒ¡ã‚¤ãƒ³ã‚¹ã‚¯ãƒªãƒ—ãƒˆ -->
  <script>
    const STORAGE_KEY   = "group_home_records_v1";
    const RESIDENTS_KEY = "group_home_residents_v1";
    const RECORDERS_KEY = "group_home_recorders_v1";
    const TEMPLATES_KEY = "group_home_support_templates_v1";

    // è‡ªå‹•å…¥åŠ›ï¼ˆæ”¯æ´é …ç›®ï¼‰
    const AUTO_ITEM_DEFS_KEY = "group_home_auto_item_defs_v1";

    // ã‚¿ã‚°
    const TAGS_KEY = "group_home_tags_v1";

    // âœ… åˆ©ç”¨è€…åˆ¥ï¼šä¿å­˜ã‚­ãƒ¼
    const FAV_BY_RESIDENT_KEY = "group_home_fav_by_resident_v1";
    const RESIDENT_AUTO_TEMPLATES_KEY = "group_home_resident_auto_templates_v1";
    const DAY_SUPPORT_BY_RESIDENT_KEY = "group_home_day_support_by_resident_v1";
    const DAY_SUPPORT_DEFAULT_KEY = "group_home_day_support_default_v1";
    const DAY_SUPPORT_DEFAULT_VALUE = "__DEFAULT__";

    // â˜…æ—¥ä¸­æ”¯æ´ãƒ†ãƒ³ãƒ—ãƒ¬ï¼ˆæ—¥ä¸­æ”¯æ´åŠ ç®—â… ãƒ»æ¥­å‹™æ—¥èªŒã¸è¿½è¨˜ï¼‰
    const DAY_NOTE_TEMPLATES_KEY = "group_home_day_note_templates_v1";
    const DAY_NOTE_PATTERN_STATE_KEY = "group_home_day_note_pattern_state_v1";
    const VITALS_KEY = "group_home_vitals_v1";
    const DEFAULT_DAY_NOTE_TEMPLATES = [
      { id: "dnt_walk",   name: "æ•£æ­©åŒè¡Œï¼ˆä½™æš‡ï¼‰", text: "ã€æ—¥ä¸­æ”¯æ´ï¼ˆä½™æš‡ï¼‰ã€‘è·å“¡åŒè¡Œã§æ•£æ­©ã¸å¤–å‡ºã€‚æœ¬äººã®æ§˜å­ï¼šï¼¿ï¼¿ã€‚æ”¯æ´ï¼šå£°ã‹ã‘ãƒ»è¦‹å®ˆã‚Šï¼ˆå¿…è¦æ™‚ä»‹åŠ©ï¼‰ã€‚å®‰å…¨é…æ…®ï¼šè»¢å€’ãƒ»äº¤é€šã«ç•™æ„ã€‚" },
      { id: "dnt_shop",   name: "è²·ã„ç‰©åŒè¡Œï¼ˆä½™æš‡ï¼‰", text: "ã€æ—¥ä¸­æ”¯æ´ï¼ˆä½™æš‡ï¼‰ã€‘è·å“¡åŒè¡Œã§è²·ã„ç‰©ã€‚æœ¬äººã®å¸Œæœ›ç¢ºèªï¼šï¼¿ï¼¿ã€‚æ”¯æ´ï¼šå•†å“é¸æŠã®å£°ã‹ã‘ã€é‡‘éŠ­ç®¡ç†ã®è¦‹å®ˆã‚Šã€‚å®‰å…¨é…æ…®ï¼šäººæ··ã¿ãƒ»ä½“èª¿å¤‰åŒ–ã«ç•™æ„ã€‚" },
      { id: "dnt_outing", name: "å¤–å‡ºæ”¯æ´ï¼ˆå…¬å…±æ©Ÿé–¢ï¼‰", text: "ã€æ—¥ä¸­æ”¯æ´ã€‘å¤–å‡ºæ”¯æ´ï¼ˆå…¬å…±æ©Ÿé–¢ã®åˆ©ç”¨ç­‰ï¼‰ã€‚æ”¯æ´ï¼šè¡Œãå…ˆã®ç¢ºèªã€ç§»å‹•æ™‚ã®è¦‹å®ˆã‚Šã€å¿…è¦æ™‚ã®ä»‹åŠ©ã€‚å®‰å…¨é…æ…®ï¼šè»¢å€’ãƒ»è¿·å­ã«ç•™æ„ã€‚" },
      { id: "dnt_leisure",name: "ä½™æš‡æ´»å‹•ï¼ˆå®¤å†…ï¼‰", text: "ã€æ—¥ä¸­æ”¯æ´ï¼ˆä½™æš‡ï¼‰ã€‘å®¤å†…ã§ä½™æš‡æ´»å‹•ï¼ˆTV/èª­æ›¸/ã‚²ãƒ¼ãƒ ç­‰ï¼‰ã€‚æœ¬äººã®æ§˜å­ï¼šï¼¿ï¼¿ã€‚æ”¯æ´ï¼šå£°ã‹ã‘ãƒ»è¦‹å®ˆã‚Šã€æ°—åˆ†è»¢æ›ã®ææ¡ˆã€‚" },
      { id: "dnt_consult",name: "ç›¸è«‡å¯¾å¿œï¼ˆç”Ÿæ´»ï¼‰", text: "ã€æ—¥ä¸­æ”¯æ´ã€‘ç”Ÿæ´»ãƒ»å¯¾äººé¢ã®ç›¸è«‡å¯¾å¿œã€‚å†…å®¹ï¼šï¼¿ï¼¿ã€‚æ”¯æ´ï¼šå‚¾è´ã€æ•´ç†ã®å£°ã‹ã‘ã€å¿…è¦æ™‚ã«é–¢ä¿‚æ©Ÿé–¢ã¸ç›¸è«‡ã€‚" },
      { id: "dnt_support",name: "ç”Ÿæ´»ãƒªã‚ºãƒ èª¿æ•´", text: "ã€æ—¥ä¸­æ”¯æ´ã€‘ç”Ÿæ´»ãƒªã‚ºãƒ ã®èª¿æ•´æ”¯æ´ã€‚æ”¯æ´ï¼šèµ·åºŠãƒ»æ´»å‹•ã®å£°ã‹ã‘ã€æ—¥ä¸­ã®éã”ã—æ–¹ã®ææ¡ˆã€è¦‹å®ˆã‚Šã€‚" },
    ];


    const DEFAULT_AUTO_ITEM_DEFS = [
  { key: "med_combo",   label: "æœè–¬å¯¾å¿œï¼ˆç®¡ç†ãƒ»ç¢ºèªï¼‰", defaultText: "æœè–¬å¯¾å¿œï¼ˆç®¡ç†ãƒ»ç¢ºèªï¼‰ï¼šæ‰‹æ¸¡ã—ã§ç›®è¦–ç¢ºèªï¼ˆå‡¦æ–¹è–¬ã¯äº‹å‹™æ‰€ç®¡ç†ï¼‰ã€‚" },
  { key: "bathing",     label: "å…¥æµ´å¯¾å¿œ",               defaultText: "å…¥æµ´å¯¾å¿œï¼šå£°ã‹ã‘ãƒ»è¦‹å®ˆã‚Šãƒ»ä»‹åŠ©ã‚’å®Ÿæ–½ã€‚" },
  { key: "health",      label: "ä½“èª¿ç®¡ç†",               defaultText: "ä½“èª¿ç®¡ç†ï¼šè¡€åœ§ãƒ»æ¤œæ¸©ãƒ»ç—‡çŠ¶ç¢ºèªç­‰ã‚’å®Ÿæ–½ã€‚" },
  { key: "day_support", label: "æ—¥ä¸­æ”¯æ´åŠ ç®—",           defaultText: "æ—¥ä¸­æ”¯æ´åŠ ç®—ï¼š{{daySupportTypeLabel}}ã®å¯¾è±¡ã¨ã—ã¦ã€æ—¥ä¸­ã‚‚GHå†…ã§è¦‹å®ˆã‚Šã€å£°ã‹ã‘ã€èª˜å°ç­‰ã®æ”¯æ´ã‚’ç¶™ç¶šã—ã¦å®Ÿæ–½ã—ãŸã€‚" },
  { key: "clean_keep",  label: "æ¸…æ½”ä¿æŒ",               defaultText: "æ¸…æ½”ä¿æŒï¼šæ¸…æ½”ä¿æŒã®ãŸã‚ã€ç€æ›¿ãˆã«ã¤ã„ã¦å£°ã‹ã‘ã‚’è¡Œã£ãŸã€‚" }
];

    const DEFAULT_TAG_LIST = [
      "æœè–¬","é€šé™¢","å…¥æµ´","å¤–å‡º","ä½“èª¿ä¸è‰¯","ç›¸è«‡","ä»•äº‹","æƒé™¤","é‡‘éŠ­","å¤œé–“å¯¾å¿œ"
    ];

    const DEFAULT_RECORDER_LIST = ["è·å“¡A","è·å“¡B","è·å“¡C","è·å“¡D","è·å“¡E","è·å“¡F"];

    // â˜…åˆ©ç”¨è€…åˆ¥ã€Œã‚ˆãä½¿ã†é …ç›®ã€æœªè¨­å®šæ™‚ã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆï¼ˆâ‘¡ è‡ªå‹•å…¥åŠ›ï¼‰
    const DEFAULT_FAV_AUTO_KEYS = [];

    // â˜…åˆ©ç”¨è€…åˆ¥ã€Œã‚ˆãä½¿ã†é …ç›®ã€æœªè¨­å®šæ™‚ã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆï¼ˆâ‘¢ ä¸»ãªæ”¯æ´ã®åˆæœŸONï¼‰
    const DEFAULT_FAV_DAY_MAIN = [];



    // â˜…æ—¥ä¸­æ”¯æ´ï¼šä¸»ãªæ”¯æ´ï¼ˆåˆæœŸï¼‰
    const DEFAULT_DAY_SUPPORT_MAIN = [
      "ä½“èª¿ç®¡ç†",
      "æœè–¬ç®¡ç†ãƒ»å†…æœç¢ºèª",
      "æ°´åˆ†æ‘‚å–ã®å£°ã‹ã‘",
      "æ’æ³„ï¼ˆãƒˆã‚¤ãƒ¬ï¼‰ã®å£°ã‹ã‘ãƒ»ä»‹åŠ©",
      "å…¥æµ´å¯¾å¿œ",
      "æ¸…æ½”ä¿æŒï¼ˆæ•´å®¹ãƒ»ç€æ›¿ãˆï¼‰",
      "å®‰å…¨ç¢ºèªãƒ»è¦‹å®ˆã‚Šï¼ˆäº‹æ•…äºˆé˜²ï¼‰",
      "ç”Ÿæ´»ãƒªã‚ºãƒ èª¿æ•´ï¼ˆèµ·åºŠãƒ»ä¼‘æ¯ãªã©ï¼‰",
      "ç›¸è«‡ãƒ»å‚¾è´ï¼ˆå¿ƒç†é¢æ”¯æ´ï¼‰",
      "ä½™æš‡æ´»å‹•æ”¯æ´ï¼ˆæ•£æ­©ãƒ»ã‚²ãƒ¼ãƒ ãƒ»å‰µä½œãªã©ï¼‰",
      "å®¶äº‹æ”¯æ´ï¼ˆæƒé™¤ãƒ»æ´—æ¿¯ãƒ»ç‰‡ä»˜ã‘ï¼‰",
      "å¤–å‡ºãƒ»è²·ã„ç‰©åŒè¡Œ",
      "é€šé™¢ãƒ»å—è¨ºåŒè¡Œï¼ˆåŒ»ç™‚é€£æºï¼‰",
      "é‡‘éŠ­ç®¡ç†æ”¯æ´",
      "é–¢ä¿‚æ©Ÿé–¢é€£çµ¡ãƒ»èª¿æ•´ï¼ˆå®¶æ—ãƒ»ç›¸è«‡æ”¯æ´ãƒ»é€šæ‰€å…ˆãªã©ï¼‰",
    ];

    // â˜…æ—¥ä¸­æ”¯æ´ï¼šç†ç”±ï¼ˆåˆæœŸï¼‰
    const DEFAULT_DAY_SUPPORT_REASON = [
      "ä½“èª¿ä¸è‰¯ã§æ—¥ä¸­æ´»å‹•ï¼ˆé€šæ‰€ãƒ»å°±åŠ´ï¼‰ã‚’æ¬ å¸­",
      "é€šæ‰€å…ˆãƒ»å°±åŠ´å…ˆãŒä¼‘ã¿ï¼è‡¨æ™‚ä¼‘æ¥­ã®ãŸã‚åœ¨å®…",
      "éšœå®³ç‰¹æ€§ãƒ»è¡Œå‹•é¢ã®ä¸å®‰ã§æ—¥ä¸­æ´»å‹•åˆ©ç”¨ãŒå›°é›£",
      "åŒ»å¸«ã®æŒ‡ç¤ºã§å¤–å‡ºãƒ»é€šæ‰€ã‚’æ§ãˆã¦ã„ã‚‹"
    ];

    // â˜…æ—¥ä¸­æ´»å‹•ï¼ˆé€šæ‰€ / æ¬ å¸­ï¼‰ â€»å›ºå®šï¼ˆåˆ©ç”¨è€…åˆ¥ç·¨é›†ã®å¯¾è±¡å¤–ï¼‰
    const DAY_ACTIVITY_LIST = [
      "Aå‹äº‹æ¥­æ‰€é€šæ‰€",
      "Aå‹äº‹æ¥­æ‰€æ¬ å¸­",
      "Bå‹äº‹æ¥­æ‰€é€šæ‰€",
      "Bå‹äº‹æ¥­æ‰€æ¬ å¸­"
    ];

    // â˜…è¤‡åˆãƒã‚§ãƒƒã‚¯ï¼ˆå…¥æµ´å¯¾å¿œï¼šå£°ã‹ã‘/è¦‹å®ˆã‚Š/ä»‹åŠ©ï¼‰
    const BATHING_MAIN_KEY = "å…¥æµ´å¯¾å¿œ";
    const BATHING_SUB_OPTIONS = ["å£°ã‹ã‘", "è¦‹å®ˆã‚Š", "ä»‹åŠ©"];

    function isBathingMainItemText(text) {
      return typeof text === "string" && /^å…¥æµ´å¯¾å¿œ/.test(text.trim());
    }

    function makeBathingCompositeHTML(mode = "main") {
      // mode: "main" or "edit"
      const parentClass = mode === "edit" ? "edit-day-main-item edit-day-main-bathing" : "day-main-item day-main-bathing";
      const subClass    = mode === "edit" ? "edit-day-main-bathing-sub" : "day-main-bathing-sub";
      const baseLabel   = BATHING_MAIN_KEY;

      const subs = BATHING_SUB_OPTIONS.map((t) => {
        return `<label><input type="checkbox" class="${subClass}" value="${escapeHtmlAttr(t)}"> ${escapeHtml(t)}</label>`;
      }).join("");

      return `
        <div class="day-main-composite">
          <label><input type="checkbox" class="${parentClass}" value="${escapeHtmlAttr(BATHING_MAIN_KEY)}"> ${escapeHtml(baseLabel)}</label>
          <span class="day-main-subwrap disabled">
            <span class="paren">ï¼ˆ</span>
            ${subs}
            <span class="paren">ï¼‰</span>
          </span>
        </div>
      `;
    }

    function syncBathingCompositeInWrap(wrapEl, mode = "main") {
      if (!wrapEl) return;
      const parentSelector = mode === "edit" ? "input.edit-day-main-bathing" : "input.day-main-bathing";
      const subSelector    = mode === "edit" ? "input.edit-day-main-bathing-sub" : "input.day-main-bathing-sub";

      wrapEl.querySelectorAll(".day-main-composite").forEach((comp) => {
        const parent = comp.querySelector(parentSelector);
        const subWrap = comp.querySelector(".day-main-subwrap");
        if (!parent || !subWrap) return;
        subWrap.classList.toggle("disabled", !parent.checked);
      });

      // è¦ªãŒOFFãªã‚‰ã‚µãƒ–ã‚‚OFFï¼ˆå®‰å…¨å´ï¼‰
      wrapEl.querySelectorAll(".day-main-composite").forEach((comp) => {
        const parent = comp.querySelector(parentSelector);
        const subs = Array.from(comp.querySelectorAll(subSelector));
        if (!parent) return;
        if (!parent.checked) subs.forEach((s) => { s.checked = false; });
      });
    }

    function bindBathingCompositeHandlersOnce(wrapId, mode = "main") {
      const wrapEl = document.getElementById(wrapId);
      if (!wrapEl) return;
      const flag = mode === "edit" ? "bathingBoundEdit" : "bathingBoundMain";
      if (wrapEl.dataset[flag] === "1") return;
      wrapEl.dataset[flag] = "1";

      const parentClass = mode === "edit" ? "edit-day-main-bathing" : "day-main-bathing";
      const subClass    = mode === "edit" ? "edit-day-main-bathing-sub" : "day-main-bathing-sub";

      wrapEl.addEventListener("change", (e) => {
        const t = e.target;
        if (!t) return;
        const comp = t.closest(".day-main-composite");
        if (!comp) return;

        const parent = comp.querySelector(`input.${parentClass}`);
        const subs = Array.from(comp.querySelectorAll(`input.${subClass}`));

        if (t.classList.contains(subClass)) {
          const any = subs.some((s) => s.checked);
          if (parent) parent.checked = any;
        }

        if (t.classList.contains(parentClass)) {
          // è¦ªOFFãªã‚‰ã‚µãƒ–ã‚’å…¨è§£é™¤ï¼è¦ªONã§ã‚µãƒ–0ãªã‚‰ãƒ‡ãƒ•ã‚©ON
          if (parent && !parent.checked) {
            subs.forEach((s) => { s.checked = false; });
          } else if (parent && parent.checked) {
            if (!subs.some((s) => s.checked)) {
              // å…¥æµ´ã¯ã€Œå£°ã‹ã‘ãƒ»è¦‹å®ˆã‚Šãƒ»ä»‹åŠ©ã€ã‚’ãƒ‡ãƒ•ã‚©ON
              subs.forEach((s) => { s.checked = true; });
            }
          }
        }

        const subWrap = comp.querySelector(".day-main-subwrap");
        if (subWrap && parent) subWrap.classList.toggle("disabled", !parent.checked);
      });
    }

    function getBathingSubSelected(mode = "main") {
      const sel = mode === "edit" ? ".edit-day-main-bathing-sub:checked" : ".day-main-bathing-sub:checked";
      return Array.from(document.querySelectorAll(sel)).map((x) => x.value);
    }

    function applyBathingSubSelected(arr, mode = "main") {
      const sel = mode === "edit" ? ".edit-day-main-bathing-sub" : ".day-main-bathing-sub";
      const set = new Set(Array.isArray(arr) ? arr : []);
      document.querySelectorAll(sel).forEach((cb) => { cb.checked = set.has(cb.value); });

      // è¦ªã®ON/OFFã‚’åˆã‚ã›ã‚‹
      const parentSel = mode === "edit" ? ".edit-day-main-bathing" : ".day-main-bathing";
      const parent = document.querySelector(parentSel);
      if (parent) parent.checked = (set.size > 0);

      const wrapId = mode === "edit" ? "editDaySupportMainCheckboxes" : "daySupportMainCheckboxes";
      syncBathingCompositeInWrap(document.getElementById(wrapId), mode);
    }


    // â˜…è¤‡åˆãƒã‚§ãƒƒã‚¯ï¼ˆä½“èª¿ç®¡ç†ï¼šè¡€åœ§/ä½“é‡/æ¤œæ¸©/ç—‡çŠ¶ç¢ºèª/å®‰é™è¦‹å®ˆã‚Šï¼‰
    const HEALTH_MAIN_KEY = "ä½“èª¿ç®¡ç†";
    const HEALTH_SUB_OPTIONS = ["è¡€åœ§", "ä½“é‡", "æ¤œæ¸©", "ç—‡çŠ¶ç¢ºèª", "å®‰é™è¦‹å®ˆã‚Š"];

    function isHealthMainItemText(text) {
      return typeof text === "string" && /^ä½“èª¿ç®¡ç†/.test(text.trim());
    }

    function makeHealthCompositeHTML(mode = "main") {
      const parentClass = mode === "edit" ? "edit-day-main-item edit-day-main-health" : "day-main-item day-main-health";
      const subClass    = mode === "edit" ? "edit-day-main-health-sub" : "day-main-health-sub";
      const baseLabel   = HEALTH_MAIN_KEY;

      const subs = HEALTH_SUB_OPTIONS.map((t) => {
        return `<label><input type="checkbox" class="${subClass}" value="${escapeHtmlAttr(t)}"> ${escapeHtml(t)}</label>`;
      }).join("");

      return `
        <div class="day-main-composite">
          <label><input type="checkbox" class="${parentClass}" value="${escapeHtmlAttr(HEALTH_MAIN_KEY)}"> ${escapeHtml(baseLabel)}</label>
          <span class="day-main-subwrap disabled">
            <span class="paren">ï¼ˆ</span>
            ${subs}
            <span class="paren">ï¼‰</span>
          </span>
        </div>
      `;
    }

    function syncHealthCompositeInWrap(wrapEl, mode = "main") {
      if (!wrapEl) return;
      const parentSelector = mode === "edit" ? "input.edit-day-main-health" : "input.day-main-health";
      const subSelector    = mode === "edit" ? "input.edit-day-main-health-sub" : "input.day-main-health-sub";

      wrapEl.querySelectorAll(".day-main-composite").forEach((comp) => {
        const parent = comp.querySelector(parentSelector);
        const subWrap = comp.querySelector(".day-main-subwrap");
        if (!parent || !subWrap) return;
        subWrap.classList.toggle("disabled", !parent.checked);
      });

      // è¦ªãŒOFFãªã‚‰ã‚µãƒ–ã‚‚OFFï¼ˆå®‰å…¨å´ï¼‰
      wrapEl.querySelectorAll(".day-main-composite").forEach((comp) => {
        const parent = comp.querySelector(parentSelector);
        const subs = Array.from(comp.querySelectorAll(subSelector));
        if (!parent) return;
        if (!parent.checked) subs.forEach((s) => { s.checked = false; });
      });
    }

    function bindHealthCompositeHandlersOnce(wrapId, mode = "main") {
      const wrapEl = document.getElementById(wrapId);
      if (!wrapEl) return;
      const flag = mode === "edit" ? "healthBoundEdit" : "healthBoundMain";
      if (wrapEl.dataset[flag] === "1") return;
      wrapEl.dataset[flag] = "1";

      const parentClass = mode === "edit" ? "edit-day-main-health" : "day-main-health";
      const subClass    = mode === "edit" ? "edit-day-main-health-sub" : "day-main-health-sub";

      wrapEl.addEventListener("change", (e) => {
        const t = e.target;
        if (!t) return;
        const comp = t.closest(".day-main-composite");
        if (!comp) return;

        const parent = comp.querySelector(`input.${parentClass}`);
        const subs = Array.from(comp.querySelectorAll(`input.${subClass}`));

        if (t.classList.contains(subClass)) {
          const any = subs.some((s) => s.checked);
          if (parent) parent.checked = any;
        }

        if (t.classList.contains(parentClass)) {
          if (parent && !parent.checked) {
            subs.forEach((s) => { s.checked = false; });
          } else if (parent && parent.checked) {
            // è¦ªONã§ã‚µãƒ–0ãªã‚‰ã€Œè¡€åœ§ã€ã‚’ãƒ‡ãƒ•ã‚©ON
            if (!subs.some((s) => s.checked)) {
              const bp = subs.find((x) => x.value === "è¡€åœ§");
              if (bp) bp.checked = true;
            }
          }
        }

        const subWrap = comp.querySelector(".day-main-subwrap");
        if (subWrap && parent) subWrap.classList.toggle("disabled", !parent.checked);
      });
    }

    function getHealthSubSelected(mode = "main") {
      const sel = mode === "edit" ? ".edit-day-main-health-sub:checked" : ".day-main-health-sub:checked";
      return Array.from(document.querySelectorAll(sel)).map((x) => x.value);
    }

    function applyHealthSubSelected(arr, mode = "main") {
      const sel = mode === "edit" ? ".edit-day-main-health-sub" : ".day-main-health-sub";
      const set = new Set(Array.isArray(arr) ? arr : []);
      document.querySelectorAll(sel).forEach((cb) => { cb.checked = set.has(cb.value); });

      const parentSel = mode === "edit" ? ".edit-day-main-health" : ".day-main-health";
      const parent = document.querySelector(parentSel);
      if (parent) parent.checked = (set.size > 0);

      const wrapId = mode === "edit" ? "editDaySupportMainCheckboxes" : "daySupportMainCheckboxes";
      syncHealthCompositeInWrap(document.getElementById(wrapId), mode);
    }




    let records = [];
    let residents = [];
    let recorders = [];
    let currentTags = [];
    let templates = [];
    let dayNoteTemplates = [];
    let dayNotePatternState = {};
    let dayNoteInsertedMap = { note: {}, editNote: {} };


    // è‡ªå‹•å…¥åŠ›é …ç›® / ã‚¿ã‚°
    let AUTO_ITEM_DEFS = [];
    let TAG_LIST = [];

    // æ—¥ä¸­æ”¯æ´ãƒã‚§ãƒƒã‚¯ï¼ˆãƒ•ã‚©ãƒ¼ãƒ è¡¨ç¤ºç”¨ï¼šç¾åœ¨ã®åˆ©ç”¨è€…ã«åˆã‚ã›ã‚‹ï¼‰
    let DAY_SUPPORT_MAIN_LIST = DEFAULT_DAY_SUPPORT_MAIN.slice();
    let DAY_SUPPORT_REASON_LIST = DEFAULT_DAY_SUPPORT_REASON.slice();

    // åˆ©ç”¨è€…åˆ¥ãƒ‡ãƒ¼ã‚¿
    let favByResident = {};
    let residentAutoTemplates = {};
    let daySupportByResident = {};
    let daySupportDefault = { main: DEFAULT_DAY_SUPPORT_MAIN.slice(), reason: DEFAULT_DAY_SUPPORT_REASON.slice() };

    // ç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ«ç”¨
    let editingRecordId = null;
    let editTags = [];

    function loadJSON(key, fallback) {
      const raw = localStorage.getItem(key);
      if (!raw) return fallback;
      try {
        const parsed = JSON.parse(raw);
        return parsed ?? fallback;
      } catch {
        return fallback;
      }
    }

    function saveJSON(key, value) {
      localStorage.setItem(key, JSON.stringify(value));
    }

    function loadTags() {
      const parsed = loadJSON(TAGS_KEY, null);
      if (Array.isArray(parsed) && parsed.length) return parsed;
      saveJSON(TAGS_KEY, DEFAULT_TAG_LIST);
      return DEFAULT_TAG_LIST.slice();
    }

    function saveTags() { saveJSON(TAGS_KEY, TAG_LIST); }

    // ===== æ—¥ä¸­æ”¯æ´ãƒ†ãƒ³ãƒ—ãƒ¬ï¼ˆæ—¥ä¸­æ”¯æ´åŠ ç®—â… ãƒ»æ¥­å‹™æ—¥èªŒã¸è¿½è¨˜ï¼‰ =====
    function loadDayNoteTemplates() {
      const parsed = loadJSON(DAY_NOTE_TEMPLATES_KEY, null);
      if (Array.isArray(parsed) && parsed.length) {
        return parsed
          .filter((t) => t && typeof t.id === "string" && typeof t.name === "string" && typeof t.text === "string")
          .map((t) => ({ id: String(t.id), name: String(t.name), text: String(t.text) }));
      }
      // åˆå›ã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚’å…¥ã‚Œã‚‹
      saveJSON(DAY_NOTE_TEMPLATES_KEY, DEFAULT_DAY_NOTE_TEMPLATES);
      return DEFAULT_DAY_NOTE_TEMPLATES.slice();
    }

    function saveDayNoteTemplates() {
      saveJSON(DAY_NOTE_TEMPLATES_KEY, Array.isArray(dayNoteTemplates) ? dayNoteTemplates : []);
    }

    function appendTextToTextarea(textareaEl, addText) {
      if (!textareaEl || !addText) return;
      const cur = String(textareaEl.value || "");
      const add = String(addText).trimEnd();
      if (!cur.trim()) {
        textareaEl.value = add;
      } else {
        textareaEl.value = cur + (cur.endsWith("\n") ? "" : "\n") + add;
      }
      textareaEl.dispatchEvent(new Event("input", { bubbles: true }));
    }

    function __normalizeNL(s) { return String(s ?? "").replace(/\r\n?/g, "\n"); }

    function hasTextBlock(textareaEl, blockText) {
      if (!textareaEl) return false;
      const cur = __normalizeNL(textareaEl.value || "");
      const blk = __normalizeNL(blockText || "").trimEnd();
      if (!blk) return false;
      return cur.indexOf(blk) !== -1;
    }

    function removeTextFromTextarea(textareaEl, removeText) {
      if (!textareaEl || !removeText) return;
      let cur = __normalizeNL(textareaEl.value || "");
      const blk = __normalizeNL(removeText || "").trimEnd();
      if (!blk) return;

      const idx = cur.indexOf(blk);
      if (idx === -1) return;

      let start = idx;
      let end = idx + blk.length;

      // ä½™è¨ˆãªç©ºè¡Œã‚’ä½œã‚‰ãªã„ã‚ˆã†ã«ã€å‰å¾Œã®æ”¹è¡Œã‚’1ã¤ã ã‘å¸å
      if (start === 0) {
        if (cur[end] === "\n") end += 1;
      } else if (cur[start - 1] === "\n") {
        start -= 1;
      } else if (cur[end] === "\n") {
        end += 1;
      }

      textareaEl.value = (cur.slice(0, start) + cur.slice(end)).replace(/^\n+/, "");
      textareaEl.dispatchEvent(new Event("input", { bubbles: true }));
    }



    // ===== æ—¥ä¸­æ”¯æ´ãƒ†ãƒ³ãƒ—ãƒ¬ï¼šãƒ‘ã‚¿ãƒ¼ãƒ³ï¼ˆâ‘ â‘¡â‘¢ï¼‰ =====
    function loadDayNotePatternState(){
      const raw = localStorage.getItem(DAY_NOTE_PATTERN_STATE_KEY);
      if(!raw) return {};
      try{
        const obj = JSON.parse(raw);
        return (obj && typeof obj === 'object') ? obj : {};
      }catch{
        return {};
      }
    }
    function saveDayNotePatternState(){
      localStorage.setItem(DAY_NOTE_PATTERN_STATE_KEY, JSON.stringify(dayNotePatternState || {}));
    }
    function getDayNotePat(tplId){
      const v = (dayNotePatternState || {})[tplId];
      const n = parseInt(v, 10);
      return (n === 2 || n === 3) ? n : 1;
    }
    function setDayNotePat(tplId, pat){
      if(!tplId) return;
      const n = (pat === 2 || pat === 3) ? pat : 1;
      dayNotePatternState = dayNotePatternState || {};
      dayNotePatternState[tplId] = n;
      saveDayNotePatternState();
    }

    function _fill(text, re, fill){
      const v = String(fill || '').trim();
      if(!v) return text;
      return String(text || '').replace(re, (m) => {
        // m æœ«å°¾ã®å¥ç‚¹ã‚’ç¶­æŒ
        const hasMaru = /ã€‚$/.test(m);
        const head = m.replace(/ï¼¿ï¼¿ã€‚?$/, '');
        return head + v + (hasMaru ? 'ã€‚' : '');
      });
    }

    function getDayNotePatternText(tpl, pat){
      const id = String(tpl?.id || '');
      const base = String(tpl?.text || '').trimEnd();
      const p = (pat === 2 || pat === 3) ? pat : 1;
      if(!base) return '';

      // å€‹åˆ¥æœ€é©ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãƒ†ãƒ³ãƒ—ãƒ¬ã¯ã“ã“ã§ç¶ºéº—ã«å·®ã—æ›¿ãˆï¼‰
      if(id === 'dnt_walk'){
        const fills = {
          1: 'è½ã¡ç€ã„ãŸæ§˜å­ã§æ­©è¡Œã§ããŸ',
          2: 'é€”ä¸­ã§ä¼‘æ†©ã‚’æŒŸã¿ãªãŒã‚‰ç„¡ç†ãªãæ­©è¡Œã§ããŸ',
          3: 'ä¼šè©±ãŒè¦‹ã‚‰ã‚Œæ„æ¬²çš„ã«å‚åŠ ã§ããŸ'
        };
        return _fill(base, /æœ¬äººã®æ§˜å­ï¼šï¼¿ï¼¿ã€‚?/g, fills[p]);
      }
      if(id === 'dnt_shop'){
        const fills = {
          1: 'è³¼å…¥å¸Œæœ›ã‚’ç¢ºèªã—ã€è½ã¡ç€ã„ã¦å•†å“é¸æŠã§ããŸ',
          2: 'å•†å“é¸æŠã«è¿·ã„ãŒã‚ã‚Šã€å£°ã‹ã‘ã§æ•´ç†ã—ãªãŒã‚‰é¸æŠã§ããŸ',
          3: 'ä¼šè©±ã—ãªãŒã‚‰æ„æ¬²çš„ã«å•†å“é¸æŠã§ããŸ'
        };
        return _fill(base, /æœ¬äººã®å¸Œæœ›ç¢ºèªï¼šï¼¿ï¼¿ã€‚?/g, fills[p]);
      }
      if(id === 'dnt_leisure'){
        const fills = {
          1: 'ç©ã‚„ã‹ã«éã”ã•ã‚Œã€æ°—åˆ†è»¢æ›ã¨ãªã£ãŸ',
          2: 'é›†ä¸­ã—ã¦å–ã‚Šçµ„ã‚ãŸ',
          3: 'é€”ä¸­ã§ä¼‘æ†©ã‚’æŒŸã¿ãªãŒã‚‰ç¶™ç¶šã§ããŸ'
        };
        return _fill(base, /æœ¬äººã®æ§˜å­ï¼šï¼¿ï¼¿ã€‚?/g, fills[p]);
      }
      if(id === 'dnt_consult'){
        const fills = {
          1: 'ç”Ÿæ´»é¢ã®ä¸å®‰ã«ã¤ã„ã¦ç›¸è«‡ã‚ã‚Š',
          2: 'å¯¾äººé¢ã®æ‚©ã¿ã«ã¤ã„ã¦ç›¸è«‡ã‚ã‚Š',
          3: 'äºˆå®šå¤‰æ›´ã«ä¼´ã†ä¸å®‰ã«ã¤ã„ã¦ç›¸è«‡ã‚ã‚Š'
        };
        return _fill(base, /å†…å®¹ï¼šï¼¿ï¼¿ã€‚?/g, fills[p]);
      }
      if(id === 'dnt_outing'){
        const suffix = {
          1: 'æœ¬äººã¯è½ã¡ç€ã„ã¦ç§»å‹•ã§ããŸã€‚',
          2: 'é€”ä¸­ã§ä¸å®‰ãŒã¿ã‚‰ã‚Œã€å£°ã‹ã‘ã§è½ã¡ç€ã„ãŸã€‚',
          3: 'ä½“èª¿å¤‰åŒ–ãªãå®Ÿæ–½ã§ããŸã€‚'
        };
        return base + (base.endsWith('ã€‚') ? '' : 'ã€‚') + '\n' + suffix[p];
      }
      if(id === 'dnt_support'){
        const suffix = {
          1: 'å£°ã‹ã‘ã«ã‚ˆã‚Šæ—¥ä¸­ã®éã”ã—æ–¹ã‚’æ•´ãˆãŸã€‚',
          2: 'ä¼‘æ¯ã‚‚ç¢ºä¿ã—ã€ç„¡ç†ã®ãªã„ç¯„å›²ã§èª¿æ•´ã—ãŸã€‚',
          3: 'æ´»å‹•ã®ææ¡ˆã«ã‚ˆã‚Šæ„æ¬²ãŒè¦‹ã‚‰ã‚ŒãŸã€‚'
        };
        return base + (base.endsWith('ã€‚') ? '' : 'ã€‚') + '\n' + suffix[p];
      }

      // æ±ç”¨ï¼šã‚ˆãã‚ã‚‹ã€Œï¼¿ï¼¿ã€ã‚’è‡ªå‹•è£œå®Œï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼ä½œæˆãƒ†ãƒ³ãƒ—ãƒ¬ã‚‚æœ€ä½é™å¯¾å¿œï¼‰
      const genericFills = {
        1: 'è½ã¡ç€ã„ãŸæ§˜å­ã§å‚åŠ ã§ããŸ',
        2: 'é€”ä¸­ã§ä¼‘æ†©ã‚’æŒŸã¿ãªãŒã‚‰ç„¡ç†ãªãå‚åŠ ã§ããŸ',
        3: 'ä¼šè©±ãŒè¦‹ã‚‰ã‚Œæ„æ¬²çš„ã«å‚åŠ ã§ããŸ'
      };
      let out = base;
      // æœ¬äººã®æ§˜å­
      out = _fill(out, /æœ¬äººã®æ§˜å­ï¼šï¼¿ï¼¿ã€‚?/g, genericFills[p]);
      // å¸Œæœ›ç¢ºèª
      out = _fill(out, /æœ¬äººã®å¸Œæœ›ç¢ºèªï¼šï¼¿ï¼¿ã€‚?/g, genericFills[p]);
      // å†…å®¹
      out = _fill(out, /å†…å®¹ï¼šï¼¿ï¼¿ã€‚?/g, genericFills[p]);
      // ã‚‚ã—ç½®æ›ã§ããªã„å ´åˆã¯æœ«å°¾ã«1è¡Œã ã‘è¶³ã™
      if(/ï¼¿ï¼¿/.test(out)){
        out = out.replace(/ï¼¿ï¼¿/g, genericFills[p]);
      }
      if(out === base){
        const suffix = {
          1: 'æœ¬äººã¯è½ã¡ç€ã„ãŸæ§˜å­ã§å‚åŠ ã§ããŸã€‚',
          2: 'é€”ä¸­ã§ä¼‘æ†©ã‚’æŒŸã¿ãªãŒã‚‰ç„¡ç†ãªãå®Ÿæ–½ã§ããŸã€‚',
          3: 'ä¼šè©±ãŒè¦‹ã‚‰ã‚Œæ„æ¬²çš„ã«å‚åŠ ã§ããŸã€‚'
        };
        out = base + (base.endsWith('ã€‚') ? '' : 'ã€‚') + '\n' + suffix[p];
      }
      return out;
    }

    function removeDayNoteTplAny(ta, tpl, areaKey){
      if(!ta || !tpl) return;
      const id = String(tpl.id || '');
      if(!id) return;
      dayNoteInsertedMap[areaKey] = dayNoteInsertedMap[areaKey] || {};
      const prev = dayNoteInsertedMap[areaKey][id];
      if(prev && hasTextBlock(ta, prev)) removeTextFromTextarea(ta, prev);
      // å¿µã®ãŸã‚ï¼šå…¨ãƒ‘ã‚¿ãƒ¼ãƒ³ï¼‹å…ƒãƒ†ã‚­ã‚¹ãƒˆã‚‚é™¤å»ã‚’è©¦ã™
      [1,2,3].forEach((p) => {
        const t = getDayNotePatternText(tpl, p);
        if(t && hasTextBlock(ta, t)) removeTextFromTextarea(ta, t);
      });
      if(tpl.text && hasTextBlock(ta, tpl.text)) removeTextFromTextarea(ta, tpl.text);
      delete dayNoteInsertedMap[areaKey][id];
    }

    
    
    

    // ===== æ—¥ä¸­æ”¯æ´ãƒ†ãƒ³ãƒ—ãƒ¬ï¼ˆæ—¥ä¸­æ”¯æ´åŠ ç®—â… ãƒ»æ¥­å‹™æ—¥èªŒã¸è¿½è¨˜ï¼‰ï¼šãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ï¼†ãƒˆãƒ¼ã‚¹ãƒˆ =====
    let __dnToastTimer = null;

    function __dnOneLine(s){
      return String(s || "").replace(/\r?\n/g, " ").replace(/\s+/g, " ").trim();
    }
    function __dnSnippet(s, maxLen=110){
      const one = __dnOneLine(s);
      if (one.length <= maxLen) return one;
      return one.slice(0, Math.max(0, maxLen-1)) + "â€¦";
    }

    function setDayNoteLastPreview(fullText){
      const el = document.getElementById("dayNoteLastPreview");
      if(!el) return;
      const txt = String(fullText || "").trim();
      if(!txt){
        el.textContent = "æœ€æ–°ï¼šãªã—";
        el.classList.add("empty");
        el.dataset.full = "";
        el.title = "ç›´è¿‘ã®è¿½è¨˜å†…å®¹ï¼ˆã‚¯ãƒªãƒƒã‚¯ã§è¡¨ç¤ºï¼‰";
        return;
      }
      el.textContent = "æœ€æ–°ï¼š" + __dnSnippet(txt, 120);
      el.classList.remove("empty");
      el.dataset.full = txt;
      el.title = txt;
    }

    function hideDayNoteToast(){
      const toast = document.getElementById("dnToast");
      if(!toast) return;
      toast.classList.remove("show");
      toast.setAttribute("aria-hidden", "true");
      if(__dnToastTimer){ clearTimeout(__dnToastTimer); __dnToastTimer = null; }
    }

    function showDayNoteToast(title, fullText){
      const toast = document.getElementById("dnToast");
      const tEl = document.getElementById("dnToastTitle");
      const bEl = document.getElementById("dnToastBody");
      if(!toast || !tEl || !bEl) return;
      tEl.textContent = title || "æ¥­å‹™æ—¥èªŒã«åæ˜ ã—ã¾ã—ãŸ";
      bEl.textContent = String(fullText || "").trim();
      toast.classList.add("show");
      toast.setAttribute("aria-hidden", "false");
      if(__dnToastTimer){ clearTimeout(__dnToastTimer); __dnToastTimer = null; }
      __dnToastTimer = setTimeout(() => hideDayNoteToast(), 6500);
    }

    function jumpToNote(){
      const field = document.getElementById("noteField");
      const ta = document.getElementById("note");
      if(field) field.scrollIntoView({behavior:"smooth", block:"start"});
      if(ta){
        ta.focus({preventScroll:true});
        ta.classList.add("dn-flash");
        setTimeout(() => ta.classList.remove("dn-flash"), 1250);
      }
    }

    function notifyDayNoteTplChange(action, tplName, pat, fullText, textareaId){
      // ãƒ¡ã‚¤ãƒ³ãƒ•ã‚©ãƒ¼ãƒ ï¼ˆnoteï¼‰ã ã‘ï¼šãƒã‚§ãƒƒã‚¯å¾Œã«ä¸‹ã‚’è¦‹ã«è¡Œã‹ãªãã¦ã‚‚ç¢ºèªã§ãã‚‹ã‚ˆã†ã«
      if(textareaId !== "note") return;

      const p = (pat === 2 || pat === 3) ? pat : 1;

      if(action === "remove"){
        setDayNoteLastPreview("å‰Šé™¤ï¼š" + (tplName || "ãƒ†ãƒ³ãƒ—ãƒ¬"));
        showDayNoteToast("æ¥­å‹™æ—¥èªŒã‹ã‚‰å‰Šé™¤ã—ã¾ã—ãŸï¼š" + (tplName || ""), "");
        return;
      }

      const txt = String(fullText || "").trim();
      if(!txt) return;

      setDayNoteLastPreview(txt);
      showDayNoteToast(`æ¥­å‹™æ—¥èªŒã«è¿½è¨˜ã—ã¾ã—ãŸï¼š${tplName || ""}ï¼ˆ${p}ï¼‰`, txt);
    }

    document.addEventListener("DOMContentLoaded", () => {
      document.getElementById("dnToastCloseBtn")?.addEventListener("click", hideDayNoteToast);
      document.getElementById("dnToastJumpBtn")?.addEventListener("click", () => { hideDayNoteToast(); jumpToNote(); });

      const toast = document.getElementById("dnToast");
      if(toast){
        toast.addEventListener("mouseenter", () => { if(__dnToastTimer){ clearTimeout(__dnToastTimer); __dnToastTimer = null; } });
        toast.addEventListener("mouseleave", () => {
          if(toast.classList.contains("show")){
            if(__dnToastTimer) clearTimeout(__dnToastTimer);
            __dnToastTimer = setTimeout(() => hideDayNoteToast(), 4000);
          }
        });
      }

      const prev = document.getElementById("dayNoteLastPreview");
      if(prev){
        prev.addEventListener("click", () => {
          const full = prev.dataset.full || "";
          if(full) showDayNoteToast("æœ€æ–°ã®è¿½è¨˜å†…å®¹", full);
        });
      }
    });
function renderDayNoteTemplateChecks() {

      const targets = [
        { wrapId: "dayNoteTemplateChecks", textareaId: "note", emptyText: "ï¼ˆãƒ†ãƒ³ãƒ—ãƒ¬ãŒã‚ã‚Šã¾ã›ã‚“ï¼‰" },
        { wrapId: "editDayNoteTemplateChecks", textareaId: "editNote", emptyText: "ï¼ˆãƒ†ãƒ³ãƒ—ãƒ¬ãŒã‚ã‚Šã¾ã›ã‚“ï¼‰" },
      ];

      targets.forEach(({ wrapId, textareaId, emptyText }) => {
        const wrap = document.getElementById(wrapId);
        if (!wrap) return;

        wrap.innerHTML = "";
        const ta = document.getElementById(textareaId);
        const list = Array.isArray(dayNoteTemplates) ? dayNoteTemplates : [];

        if (!list.length) {
          const span = document.createElement("span");
          span.className = "small-text";
          span.textContent = emptyText;
          wrap.appendChild(span);
          return;
        }

        // areaKey: note / editNote
        dayNoteInsertedMap[textareaId] = dayNoteInsertedMap[textareaId] || {};

        list.forEach((tpl) => {
          const comp = document.createElement("div");
          comp.className = "dn-compound";

          const patName = `dnt_pat_${tpl.id}_${wrapId}`;
          const curPat = getDayNotePat(tpl.id);

          comp.innerHTML = `
            <label><input type="checkbox" class="day-note-tpl-check" value="${escapeHtmlAttr(tpl.id)}"> ${escapeHtml(tpl.name)}</label>
            <span class="dn-subwrap disabled">
              <span class="paren">ï¼ˆ</span>
              <label><input type="radio" class="day-note-tpl-pat" name="${escapeHtmlAttr(patName)}" value="1">â‘ </label>
              <label><input type="radio" class="day-note-tpl-pat" name="${escapeHtmlAttr(patName)}" value="2">â‘¡</label>
              <label><input type="radio" class="day-note-tpl-pat" name="${escapeHtmlAttr(patName)}" value="3">â‘¢</label>
              <span class="paren">ï¼‰</span>
            </span>
          `;

          const parent = comp.querySelector(".day-note-tpl-check");
          const subWrap = comp.querySelector(".dn-subwrap");
          const radios = Array.from(comp.querySelectorAll(".day-note-tpl-pat"));
          const radio = radios.find((r) => String(r.value) === String(curPat)) || radios[0];
          if (radio) radio.checked = true;

          const syncUI = () => {
            if (subWrap && parent) subWrap.classList.toggle("disabled", !parent.checked);
          };

          const applyInsert = () => {
            const selRadio = radios.find((r) => r.checked) || radios[0];
            const pat = parseInt(selRadio?.value || "1", 10) || 1;
            setDayNotePat(tpl.id, (pat === 2 || pat === 3) ? pat : 1);

            if (!ta) return;

            // æ—¢å­˜ã®ã“ã®ãƒ†ãƒ³ãƒ—ãƒ¬æ–‡ï¼ˆå…¨ãƒ‘ã‚¿ãƒ¼ãƒ³ï¼‰ã‚’å‰Šé™¤ â†’ é¸æŠä¸­ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’è¿½è¨˜
            removeDayNoteTplAny(ta, tpl, textareaId);
            const addText = getDayNotePatternText(tpl, getDayNotePat(tpl.id));
            if (!addText) return;
            if (!hasTextBlock(ta, addText)) appendTextToTextarea(ta, addText);
            dayNoteInsertedMap[textareaId][tpl.id] = addText;

            // è¿½è¨˜ã®ç¢ºèªï¼ˆãƒˆãƒ¼ã‚¹ãƒˆï¼‹ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ï¼‰
            notifyDayNoteTplChange("add", tpl.name, getDayNotePat(tpl.id), addText, textareaId);
          };

          const applyRemove = () => {
            if (!ta) return;
            removeDayNoteTplAny(ta, tpl, textareaId);

            // å‰Šé™¤ã®ç¢ºèªï¼ˆãƒˆãƒ¼ã‚¹ãƒˆï¼‹ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ï¼‰
            notifyDayNoteTplChange("remove", tpl.name, getDayNotePat(tpl.id), "", textareaId);
          };

          comp.addEventListener("change", (e) => {
            const t = e.target;
            if (!t) return;

            // ãƒ‘ã‚¿ãƒ¼ãƒ³é¸æŠï¼ˆã‚µãƒ–ï¼‰â†’ è¦ªON + è¿½è¨˜
            if (t.classList.contains("day-note-tpl-pat")) {
              if (parent && !parent.checked) parent.checked = true;
              syncUI();
              applyInsert();
              return;
            }

            // è¦ªã®ON/OFF
            if (t.classList.contains("day-note-tpl-check")) {
              syncUI();
              if (parent && parent.checked) {
                applyInsert();
              } else {
                applyRemove();
              }
            }
          });

          syncUI();
          wrap.appendChild(comp);
        });
      });
    }

    // ---- ç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ«ï¼ˆå…±é€šï¼‰ ----
    function openDayNoteTemplateModal() {
      const modal = document.getElementById("dayNoteTplModal");
      if (!modal) return;
      renderDayNoteTemplateManager();
      clearDayNoteTemplateManagerInputs();
      modal.classList.add("show");
    }

    function closeDayNoteTemplateModal() {
      const modal = document.getElementById("dayNoteTplModal");
      if (!modal) return;
      modal.classList.remove("show");
    }

    function renderDayNoteTemplateManager() {
      const sel = document.getElementById("dnTplSelect");
      if (!sel) return;
      const prev = sel.value || "";
      sel.innerHTML = '<option value="">ï¼ˆæ–°è¦ä½œæˆï¼‰</option>';
      (dayNoteTemplates || []).forEach((t) => {
        const opt = document.createElement("option");
        opt.value = t.id;
        opt.textContent = t.name;
        sel.appendChild(opt);
      });
      sel.value = prev && (dayNoteTemplates || []).some((t) => t.id === prev) ? prev : "";
    }

    function fillDayNoteTemplateManagerInputs() {
      const selId = document.getElementById("dnTplSelect")?.value || "";
      const nameEl = document.getElementById("dnTplName");
      const textEl = document.getElementById("dnTplText");
      if (!nameEl || !textEl) return;
      if (!selId) {
        nameEl.value = "";
        textEl.value = "";
        return;
      }
      const tpl = (dayNoteTemplates || []).find((t) => t.id === selId);
      nameEl.value = tpl?.name || "";
      textEl.value = tpl?.text || "";
    }

    function clearDayNoteTemplateManagerInputs() {
      const sel = document.getElementById("dnTplSelect");
      const nameEl = document.getElementById("dnTplName");
      const textEl = document.getElementById("dnTplText");
      if (sel) sel.value = "";
      if (nameEl) nameEl.value = "";
      if (textEl) textEl.value = "";
    }

    function saveDayNoteTemplateFromManager() {
      const sel = document.getElementById("dnTplSelect");
      const name = document.getElementById("dnTplName")?.value?.trim() || "";
      const textV = document.getElementById("dnTplText")?.value || "";
      if (!name) { alert("ãƒ†ãƒ³ãƒ—ãƒ¬åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„"); return; }
      if (!textV.trim()) { alert("æœ¬æ–‡ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„"); return; }

      const selectedId = sel?.value || "";
      if (selectedId) {
        const idx = (dayNoteTemplates || []).findIndex((t) => t.id === selectedId);
        if (idx >= 0) dayNoteTemplates[idx] = { id: selectedId, name, text: textV };
      } else {
        const newId = "dnt_" + Date.now().toString(36) + "_" + Math.random().toString(36).slice(2, 7);
        (dayNoteTemplates || []).push({ id: newId, name, text: textV });
        if (sel) sel.value = newId;
      }

      saveDayNoteTemplates();
      renderDayNoteTemplateManager();
      renderDayNoteTemplateChecks();
      alert("ä¿å­˜ã—ã¾ã—ãŸ");
    }

    function deleteDayNoteTemplateFromManager() {
      const selId = document.getElementById("dnTplSelect")?.value || "";
      if (!selId) { alert("å‰Šé™¤ã™ã‚‹ãƒ†ãƒ³ãƒ—ãƒ¬ã‚’é¸æŠã—ã¦ãã ã•ã„"); return; }
      if (!confirm("ã“ã®ãƒ†ãƒ³ãƒ—ãƒ¬ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")) return;
      dayNoteTemplates = (dayNoteTemplates || []).filter((t) => t.id !== selId);
      saveDayNoteTemplates();
      renderDayNoteTemplateManager();
      clearDayNoteTemplateManagerInputs();
      renderDayNoteTemplateChecks();
      alert("å‰Šé™¤ã—ã¾ã—ãŸ");
    }

    function resetDayNoteTemplatesToDefault() {
      if (!confirm("æ—¥ä¸­æ”¯æ´ãƒ†ãƒ³ãƒ—ãƒ¬ã‚’åˆæœŸçŠ¶æ…‹ã«æˆ»ã—ã¾ã™ã‹ï¼Ÿ\nï¼ˆä½œæˆã—ãŸãƒ†ãƒ³ãƒ—ãƒ¬ã¯æ¶ˆãˆã¾ã™ï¼‰")) return;
      dayNoteTemplates = DEFAULT_DAY_NOTE_TEMPLATES.slice();
      saveDayNoteTemplates();
      renderDayNoteTemplateManager();
      clearDayNoteTemplateManagerInputs();
      renderDayNoteTemplateChecks();
      alert("åˆæœŸã«æˆ»ã—ã¾ã—ãŸ");
    }


    function loadAutoItemDefs() {
  const raw = localStorage.getItem(AUTO_ITEM_DEFS_KEY);
  if (raw) {
    try {
      const parsed = JSON.parse(raw);
      if (Array.isArray(parsed)) {
        let changed = false;

        // â‘  å½¢ã‚’æ­£è¦åŒ–ï¼ˆä¸æ­£ãƒ‡ãƒ¼ã‚¿ã¯å¼¾ãï¼‰
        let updated = parsed.filter((d) => d && typeof d === "object" && typeof d.key === "string")
          .map((d) => ({
            ...d,
            label: (typeof d.label === "string") ? d.label : "",
            defaultText: (typeof d.defaultText === "string") ? d.defaultText : "",
          }));

        const hasKey = (k) => updated.some((d) => d.key === k);

        // â‘¡ æ—§ã‚­ãƒ¼ï¼ˆæœè–¬ç®¡ç† / å†…æœç¢ºèªï¼‰â†’ æ–°ã‚­ãƒ¼ï¼ˆæœè–¬å¯¾å¿œï¼‰ã¸ç§»è¡Œ
        const hasOldMed = hasKey("med_manage") || hasKey("oral_check");
        if (hasOldMed && !hasKey("med_combo")) {
          updated = updated.filter((d) => d.key !== "med_manage" && d.key !== "oral_check");
          updated.unshift({
            key: "med_combo",
            label: "æœè–¬å¯¾å¿œï¼ˆç®¡ç†ãƒ»ç¢ºèªï¼‰",
            defaultText: "æœè–¬å¯¾å¿œï¼ˆç®¡ç†ãƒ»ç¢ºèªï¼‰ï¼šæ‰‹æ¸¡ã—ã§ç›®è¦–ç¢ºèªï¼ˆå‡¦æ–¹è–¬ã¯äº‹å‹™æ‰€ç®¡ç†ï¼‰ã€‚"
          });
          changed = true;
        }

        // â‘¢ å…¥æµ´å¯¾å¿œï¼šæ—§æ–‡è¨€ã ã‘è£œæ­£ï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼ç·¨é›†ã¯ä¸Šæ›¸ãã—ãªã„ï¼‰
        updated = updated.map((d) => {
          if (d.key === "bathing") {
            const t = (d.defaultText || "").trim();
            if (t === "å…¥æµ´å¯¾å¿œï¼šå£°ã‹ã‘ã‚’å®Ÿæ–½ã€‚") {
              changed = true;
              return { ...d, label: d.label || "å…¥æµ´å¯¾å¿œ", defaultText: "å…¥æµ´å¯¾å¿œï¼šå£°ã‹ã‘ãƒ»è¦‹å®ˆã‚Šãƒ»ä»‹åŠ©ã‚’å®Ÿæ–½ã€‚" };
            }
            if (!d.label) {
              changed = true;
              return { ...d, label: "å…¥æµ´å¯¾å¿œ" };
            }
          }
          if (d.key === "day_support") {
            const t = (d.defaultText || "");
            if (t.includes("ã€æ—¥ä¸­æ”¯æ´åŠ ç®—ã€‘")) {
              changed = true;
              return { ...d, defaultText: "æ—¥ä¸­æ”¯æ´åŠ ç®—ï¼š{{daySupportTypeLabel}}ã®å¯¾è±¡ã¨ã—ã¦ã€æ—¥ä¸­ã‚‚GHå†…ã§è¦‹å®ˆã‚Šã€å£°ã‹ã‘ã€èª˜å°ç­‰ã®æ”¯æ´ã‚’ç¶™ç¶šã—ã¦å®Ÿæ–½ã—ãŸã€‚" };
            }
          }
          return d;
        });

        // â‘£ å¿…é ˆé …ç›®ã®è£œå®Œï¼ˆå­˜åœ¨ã—ãªã„å ´åˆã®ã¿è¿½åŠ ï¼‰
        if (!hasKey("med_combo")) {
          updated.unshift({
            key: "med_combo",
            label: "æœè–¬å¯¾å¿œï¼ˆç®¡ç†ãƒ»ç¢ºèªï¼‰",
            defaultText: "æœè–¬å¯¾å¿œï¼ˆç®¡ç†ãƒ»ç¢ºèªï¼‰ï¼šæ‰‹æ¸¡ã—ã§ç›®è¦–ç¢ºèªï¼ˆå‡¦æ–¹è–¬ã¯äº‹å‹™æ‰€ç®¡ç†ï¼‰ã€‚"
          });
          changed = true;
        }
        if (!hasKey("clean_keep")) {
          updated.push({ key: "clean_keep", label: "æ¸…æ½”ä¿æŒ", defaultText: "æ¸…æ½”ä¿æŒï¼šæ¸…æ½”ä¿æŒã®ãŸã‚ã€ç€æ›¿ãˆã«ã¤ã„ã¦å£°ã‹ã‘ã‚’è¡Œã£ãŸã€‚" });
          changed = true;
        }
        if (!hasKey("day_support")) {
          updated.push({ key: "day_support", label: "æ—¥ä¸­æ”¯æ´åŠ ç®—", defaultText: "æ—¥ä¸­æ”¯æ´åŠ ç®—ï¼š{{daySupportTypeLabel}}ã®å¯¾è±¡ã¨ã—ã¦ã€æ—¥ä¸­ã‚‚GHå†…ã§è¦‹å®ˆã‚Šã€å£°ã‹ã‘ã€èª˜å°ç­‰ã®æ”¯æ´ã‚’ç¶™ç¶šã—ã¦å®Ÿæ–½ã—ãŸã€‚" });
          changed = true;
        }
        if (!hasKey("bathing")) {
          updated.push({ key: "bathing", label: "å…¥æµ´å¯¾å¿œ", defaultText: "å…¥æµ´å¯¾å¿œï¼šå£°ã‹ã‘ãƒ»è¦‹å®ˆã‚Šãƒ»ä»‹åŠ©ã‚’å®Ÿæ–½ã€‚" });
          changed = true;
        }

        if (!hasKey("health")) {
          updated.push({ key: "health", label: "ä½“èª¿ç®¡ç†", defaultText: "ä½“èª¿ç®¡ç†ï¼šè¡€åœ§ãƒ»æ¤œæ¸©ãƒ»ç—‡çŠ¶ç¢ºèªç­‰ã‚’å®Ÿæ–½ã€‚" });
          changed = true;
        }

        // â‘¤ æ—§ã‚­ãƒ¼ãŒæ®‹ã£ã¦ã„ã‚Œã°å‰Šé™¤ï¼ˆé‡è¤‡é˜²æ­¢ï¼‰
        const beforeLen = updated.length;
        updated = updated.filter((d) => d.key !== "med_manage" && d.key !== "oral_check");
        if (updated.length !== beforeLen) changed = true;

        if (changed) localStorage.setItem(AUTO_ITEM_DEFS_KEY, JSON.stringify(updated));
        return updated;
      }
    } catch {}
  }
  localStorage.setItem(AUTO_ITEM_DEFS_KEY, JSON.stringify(DEFAULT_AUTO_ITEM_DEFS));
  return DEFAULT_AUTO_ITEM_DEFS.slice();
}

function saveAutoItemDefs() {
      localStorage.setItem(AUTO_ITEM_DEFS_KEY, JSON.stringify(AUTO_ITEM_DEFS));
    }

    function loadRecords() {
      try {
        const raw = localStorage.getItem(STORAGE_KEY);
        if (!raw) return [];
        const parsed = JSON.parse(raw);
        if (!Array.isArray(parsed)) return [];
        return parsed;
      } catch (e) {
        console.error("load error", e);
        return [];
      }
    }

    function saveRecords() { localStorage.setItem(STORAGE_KEY, JSON.stringify(records)); }

    function loadResidents() {
      try {
        const raw = localStorage.getItem(RESIDENTS_KEY);
        if (raw) {
          const parsed = JSON.parse(raw);
          if (Array.isArray(parsed) && parsed.length > 0) return parsed;
        }
      } catch (e) {
        console.error("load residents error", e);
      }
      const fromRecords = Array.from(new Set(records.map((r) => r.resident).filter(Boolean)));
      if (fromRecords.length > 0) return fromRecords;
      return ["åˆ©ç”¨è€…A","åˆ©ç”¨è€…B","åˆ©ç”¨è€…C","åˆ©ç”¨è€…D","åˆ©ç”¨è€…E","åˆ©ç”¨è€…F","åˆ©ç”¨è€…G"];
    }

    function saveResidents() { localStorage.setItem(RESIDENTS_KEY, JSON.stringify(residents)); }

    function loadRecorders() {
      try {
        const raw = localStorage.getItem(RECORDERS_KEY);
        if (raw) {
          const parsed = JSON.parse(raw);
          if (Array.isArray(parsed) && parsed.length > 0) return parsed;
        }
      } catch (e) {
        console.error("load recorders error", e);
      }
      const fromRecords = Array.from(new Set(records.map((r) => r.recorder).filter(Boolean)));
      if (fromRecords.length > 0) return fromRecords;
      return (typeof DEFAULT_RECORDER_LIST !== "undefined" && Array.isArray(DEFAULT_RECORDER_LIST) && DEFAULT_RECORDER_LIST.length) ? DEFAULT_RECORDER_LIST.slice() : ["è·å“¡A"];
    }

    function saveRecorders() { localStorage.setItem(RECORDERS_KEY, JSON.stringify(recorders)); }


    // ===== åˆ©ç”¨è€…åˆ¥ï¼šã‚ˆãä½¿ã†é …ç›®ï¼ˆæ—§ãƒ‡ãƒ¼ã‚¿å¯¾ç­–ã‚ã‚Šï¼‰ =====
    function normalizeFavStore(obj) {
      const out = { ...(obj || {}) };
      Object.keys(out).forEach((name) => {
        const v = out[name];

        const mapAutoKeys = (arr) => {
          const a = Array.isArray(arr) ? arr.slice() : [];
          // æ—§ã‚­ãƒ¼ â†’ æ–°ã‚­ãƒ¼ã¸ç§»è¡Œ
          const mapped = a.map((k) => (k === "med_manage" || k === "oral_check") ? "med_combo" : k);
          // é‡è¤‡é™¤å»
          return Array.from(new Set(mapped));
        };

        // æ—§å½¢å¼ï¼šé…åˆ—ï¼ˆautoKeysã®ã¿ï¼‰â†’ æ–°å½¢å¼ã¸å¤‰æ›
        if (Array.isArray(v)) {
          out[name] = { autoKeys: mapAutoKeys(v), dayMain: [], autoBathSubs: [], autoHealthSubs: [], dayBathingSubs: [], dayHealthSubs: [] };
          return;
        }
        // æ–°å½¢å¼ï¼šã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ
        if (v && typeof v === "object") {
          out[name] = {
            autoKeys: mapAutoKeys(v.autoKeys),
            dayMain: Array.isArray(v.dayMain) ? v.dayMain : [],
            autoBathSubs: Array.isArray(v.autoBathSubs) ? v.autoBathSubs : [],
            autoHealthSubs: Array.isArray(v.autoHealthSubs) ? v.autoHealthSubs : [],
            dayBathingSubs: Array.isArray(v.dayBathingSubs) ? v.dayBathingSubs : [],
            dayHealthSubs: Array.isArray(v.dayHealthSubs) ? v.dayHealthSubs : [],
          };
          return;
        }
        out[name] = { autoKeys: [], dayMain: [], autoBathSubs: [], autoHealthSubs: [], dayBathingSubs: [], dayHealthSubs: [] };
      });
      return out;
    }

    function loadFavByResident() {
      const raw = loadJSON(FAV_BY_RESIDENT_KEY, {});
      const norm = normalizeFavStore(raw);
      saveJSON(FAV_BY_RESIDENT_KEY, norm);
      return norm;
    }
    function saveFavByResident() { saveJSON(FAV_BY_RESIDENT_KEY, favByResident); }

    function getFavForResident(name) {
      const v = favByResident[name];

      const mapAutoKeys = (arr) => {
        const a = Array.isArray(arr) ? arr.slice() : [];
        const mapped = a.map((k) => (k === "med_manage" || k === "oral_check") ? "med_combo" : k);
        return Array.from(new Set(mapped));
      };

      if (Array.isArray(v)) return { autoKeys: mapAutoKeys(v), dayMain: [], autoBathSubs: [], autoHealthSubs: [], dayBathingSubs: [], dayHealthSubs: [] }; // æ—§å½¢å¼å¯¾ç­–
      if (v && typeof v === "object") {
        return {
          autoKeys: mapAutoKeys(v.autoKeys),
          dayMain: Array.isArray(v.dayMain) ? v.dayMain : [],
          autoBathSubs: Array.isArray(v.autoBathSubs) ? v.autoBathSubs : [],
          autoHealthSubs: Array.isArray(v.autoHealthSubs) ? v.autoHealthSubs : [],
          dayBathingSubs: Array.isArray(v.dayBathingSubs) ? v.dayBathingSubs : [],
          dayHealthSubs: Array.isArray(v.dayHealthSubs) ? v.dayHealthSubs : [],
        };
      }

      // æœªè¨­å®šãªã‚‰ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆï¼ˆâ‘¡ è‡ªå‹•å…¥åŠ›ã®åˆæœŸONï¼‰
      return { autoKeys: (DEFAULT_FAV_AUTO_KEYS || []).slice(), dayMain: (DEFAULT_FAV_DAY_MAIN || []).slice(), autoBathSubs: [], autoHealthSubs: [], dayBathingSubs: [], dayHealthSubs: [] };
    }

    function applyFavToMainCheckboxes(name) {
      const fav = getFavForResident(name);

      // ã“ã®åˆ©ç”¨è€…ã«ã€Œã‚ˆãä½¿ã†é …ç›®ã€ãŒä¿å­˜ã•ã‚Œã¦ã„ã‚‹ã‹ï¼ˆæœªè¨­å®šãªã‚‰ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆæ‰±ã„ï¼‰
      const hasStored = !!(name && Object.prototype.hasOwnProperty.call(favByResident || {}, name));

      // è‡ªå‹•å…¥åŠ›ï¼ˆæ”¯æ´é …ç›®ï¼‰
      const autoSet = new Set(fav.autoKeys);
      document.querySelectorAll(".auto-item").forEach((cb) => {
        cb.checked = autoSet.has(cb.value);
      });

      // å…¥æµ´ï¼ˆâ‘¡ è‡ªå‹•å…¥åŠ›ï¼‰è¤‡åˆãƒã‚§ãƒƒã‚¯ã®æœ‰åŠ¹/ç„¡åŠ¹ã‚’åŒæœŸï¼ˆåˆ©ç”¨è€…åˆ‡æ›¿ã§è¦ªãŒè‡ªå‹•ONã«ãªã‚‹ãŸã‚ï¼‰
      setupAutoBathCompound();
      setupAutoHealthCompound();

      // å…¥æµ´ï¼ˆâ‘¡ è‡ªå‹•å…¥åŠ›ï¼‰ã‚µãƒ–ãƒã‚§ãƒƒã‚¯ï¼šåˆ©ç”¨è€…åˆ¥ã«å¾©å…ƒï¼ˆæœªè¨­å®šãªã‚‰ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆï¼‰
      const __autoWrap = document.getElementById("autoItemCheckboxes");
      if (__autoWrap) {
        const subs = Array.from(__autoWrap.querySelectorAll(".auto-bath-sub"));
        if (autoSet.has("bathing")) {
          if (hasStored) {
            const saved = Array.isArray(fav.autoBathSubs) ? fav.autoBathSubs : [];
            if (saved.length) {
              subs.forEach((cb) => { cb.checked = saved.includes(cb.dataset.sub); });
            } else {
              subs.forEach((cb) => { cb.checked = false; });
            }
          } else {
            // â˜…ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆæ™‚ï¼šå…¥æµ´å¯¾å¿œã¯ã€Œå£°ã‹ã‘ãƒ»è¦‹å®ˆã‚Šãƒ»ä»‹åŠ©ã€ã‚’åˆæœŸON
            if (subs.length) subs.forEach((cb) => { cb.checked = true; });
          }
        } else {
          subs.forEach((cb) => { cb.checked = false; });
        }
      }


      // ä½“èª¿ç®¡ç†ï¼ˆâ‘¡ è‡ªå‹•å…¥åŠ›ï¼‰ã‚µãƒ–ãƒã‚§ãƒƒã‚¯ï¼šåˆ©ç”¨è€…åˆ¥ã«å¾©å…ƒï¼ˆæœªè¨­å®šãªã‚‰ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆï¼‰
      const __autoWrapH = document.getElementById("autoItemCheckboxes");
      if (__autoWrapH) {
        const subs = Array.from(__autoWrapH.querySelectorAll(".auto-health-sub"));
        if (autoSet.has("health")) {
          if (hasStored) {
            const saved = Array.isArray(fav.autoHealthSubs) ? fav.autoHealthSubs : [];
            if (saved.length) {
              subs.forEach((cb) => { cb.checked = saved.includes(cb.dataset.sub); });
            } else {
              subs.forEach((cb) => { cb.checked = false; });
            }
          } else {
            // â˜…ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆæ™‚ï¼šæœªè¨­å®šãªã‚‰ã‚µãƒ–ã¯æœªãƒã‚§ãƒƒã‚¯ï¼ˆåˆ©ç”¨è€…åˆ¥è¨­å®šã§æŒ‡å®šï¼‰
            subs.forEach((cb) => { cb.checked = false; });
          }
        } else {
          subs.forEach((cb) => { cb.checked = false; });
        }
      }

      // æ—¥ä¸­æ”¯æ´ï¼šä¸»ãªæ”¯æ´
      const daySet = new Set(fav.dayMain);
      document.querySelectorAll(".day-main-item").forEach((cb) => {
        cb.checked = daySet.has(cb.value);
      });

      // å…¥æµ´ï¼ˆâ‘¢ ä¸»ãªæ”¯æ´ï¼‰ã‚µãƒ–ãƒã‚§ãƒƒã‚¯ï¼šåˆ©ç”¨è€…åˆ¥ã«å¾©å…ƒï¼ˆæœªè¨­å®šãªã‚‰ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆï¼‰
      if (daySet.has(BATHING_MAIN_KEY)) {
        const saved = Array.isArray(fav.dayBathingSubs) ? fav.dayBathingSubs : [];
        const subs = (saved && saved.length) ? saved : [];
        applyBathingSubSelected(subs, "main");
      } else {
        applyBathingSubSelected([], "main");
      }

      // ä½“èª¿ç®¡ç†ï¼ˆâ‘¢ ä¸»ãªæ”¯æ´ï¼‰ã‚µãƒ–ãƒã‚§ãƒƒã‚¯ï¼šåˆ©ç”¨è€…åˆ¥ã«å¾©å…ƒï¼ˆæœªè¨­å®šãªã‚‰ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆï¼‰
      if (daySet.has(HEALTH_MAIN_KEY)) {
        const saved = Array.isArray(fav.dayHealthSubs) ? fav.dayHealthSubs : [];
        const subs = (saved && saved.length) ? saved : [];
        applyHealthSubSelected(subs, "main");
      } else {
        applyHealthSubSelected([], "main");
      }

      // â‘¡ è‡ªå‹•å…¥åŠ›ï¼ˆæ”¯æ´é …ç›®ï¼‰â†’ æœ¬æ—¥ã®æ”¯æ´å†…å®¹ã¸åæ˜ 
      syncAutoItemsToSupport();
    }

    // ===== åˆ©ç”¨è€…åˆ¥ï¼šè‡ªå‹•ãƒ†ãƒ³ãƒ—ãƒ¬ =====
    function loadResidentAutoTemplates() { return loadJSON(RESIDENT_AUTO_TEMPLATES_KEY, {}); }
    function saveResidentAutoTemplates() { saveJSON(RESIDENT_AUTO_TEMPLATES_KEY, residentAutoTemplates); }

    function ensureResidentTemplateState(resident) {
      if (!residentAutoTemplates[resident] || typeof residentAutoTemplates[resident] !== "object") {
        residentAutoTemplates[resident] = { templates: [], defaultId: "" };
      }
      const st = residentAutoTemplates[resident];
      if (!Array.isArray(st.templates)) st.templates = [];
      if (typeof st.defaultId !== "string") st.defaultId = "";
      return st;
    }

    // ===== æ—¥ä¸­æ”¯æ´ãƒã‚§ãƒƒã‚¯ï¼ˆåˆ©ç”¨è€…åˆ¥ + å…±é€šãƒ‡ãƒ•ã‚©ãƒ«ãƒˆï¼‰ =====
    function mergeListUnique(list, additions) {
      if (!Array.isArray(list)) return false;
      let changed = false;
      const set = new Set(list);
      for (const s of additions) {
        if (!set.has(s)) {
          list.push(s);
          set.add(s);
          changed = true;
        }
      }
      return changed;
    }

    function loadDaySupportByResident() {
      const st = loadJSON(DAY_SUPPORT_BY_RESIDENT_KEY, {});
      if (!st || typeof st !== "object") return {};
      let changed = false;

      for (const key of Object.keys(st)) {
        const v = st[key];
        if (!v || typeof v !== "object") continue;

        if (!Array.isArray(v.main)) { v.main = []; changed = true; }
        if (!Array.isArray(v.reason)) { v.reason = []; changed = true; }

        // æ—¢å­˜ã®ä¸¦ã³ã¯ç¶­æŒã—ã¤ã¤ã€ä¸è¶³åˆ†ã ã‘æœ«å°¾ã«è¿½åŠ 
        changed = mergeListUnique(v.main, DEFAULT_DAY_SUPPORT_MAIN) || changed;
        changed = mergeListUnique(v.reason, DEFAULT_DAY_SUPPORT_REASON) || changed;
      }

      if (changed) saveJSON(DAY_SUPPORT_BY_RESIDENT_KEY, st);
      return st;
    }
    function saveDaySupportByResident() { saveJSON(DAY_SUPPORT_BY_RESIDENT_KEY, daySupportByResident); }

    function loadDaySupportDefault() {
      const st = loadJSON(DAY_SUPPORT_DEFAULT_KEY, null);

      // æ—¢å­˜ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ãƒ‡ãƒ¼ã‚¿ãŒã‚ã£ã¦ã‚‚ã€è¿½åŠ ã•ã‚ŒãŸãƒ‡ãƒ•ã‚©ãƒ«ãƒˆé …ç›®ã¯è‡ªå‹•ã§æœ«å°¾ã«è£œå®Œ
      if (st && Array.isArray(st.main) && Array.isArray(st.reason)) {
        const main = st.main.slice();
        const reason = st.reason.slice();

        const changedMain = mergeListUnique(main, DEFAULT_DAY_SUPPORT_MAIN);
        const changedReason = mergeListUnique(reason, DEFAULT_DAY_SUPPORT_REASON);

        if (changedMain || changedReason) {
          const merged = { main, reason };
          saveJSON(DAY_SUPPORT_DEFAULT_KEY, merged);
          return merged;
        }
        return { main, reason };
      }

      const init = { main: DEFAULT_DAY_SUPPORT_MAIN.slice(), reason: DEFAULT_DAY_SUPPORT_REASON.slice() };
      saveJSON(DAY_SUPPORT_DEFAULT_KEY, init);
      return init;
    }
    function saveDaySupportDefault() { saveJSON(DAY_SUPPORT_DEFAULT_KEY, daySupportDefault); }

    function getDefaultDaySupport() {
      if (daySupportDefault && Array.isArray(daySupportDefault.main) && Array.isArray(daySupportDefault.reason)) {
        return { main: daySupportDefault.main.slice(), reason: daySupportDefault.reason.slice() };
      }
      return { main: DEFAULT_DAY_SUPPORT_MAIN.slice(), reason: DEFAULT_DAY_SUPPORT_REASON.slice() };
    }

    function getDaySupportForResident(resident) {
      if (resident) {
        const st = daySupportByResident[resident];
        if (st && Array.isArray(st.main) && Array.isArray(st.reason)) return { main: st.main.slice(), reason: st.reason.slice() };
      }
      return getDefaultDaySupport();
    }

    function applyDaySupportListsForResident(resident) {
      // residentãŒç©ºãªã‚‰ã€Œå…±é€šãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã€ã‚’é©ç”¨

      // ç¾åœ¨ãƒã‚§ãƒƒã‚¯ã‚’é€€é¿ï¼ˆå†æç”»ã§æ¶ˆãˆã‚‹ã®ã§ï¼‰
      const prevMain = new Set(Array.from(document.querySelectorAll(".day-main-item:checked")).map((x) => x.value));
      const prevReason = new Set(Array.from(document.querySelectorAll(".day-reason-item:checked")).map((x) => x.value));

            const prevBathingSub = Array.from(document.querySelectorAll(".day-main-bathing-sub:checked")).map((x) => x.value);
      const prevHealthSub = Array.from(document.querySelectorAll(".day-main-health-sub:checked")).map((x) => x.value);
      const conf = getDaySupportForResident(resident || "");
      DAY_SUPPORT_MAIN_LIST = conf.main.slice();
      DAY_SUPPORT_REASON_LIST = conf.reason.slice();

      renderDayActivityCheckboxes();
      renderDaySupportMainCheckboxes();
      renderDaySupportReasonCheckboxes();
      renderDayNoteTemplateChecks();

      // é€€é¿ã—ãŸãƒã‚§ãƒƒã‚¯ã‚’å¾©å…ƒï¼ˆå­˜åœ¨ã™ã‚‹ã‚‚ã®ã ã‘ï¼‰
      document.querySelectorAll(".day-main-item").forEach((x) => { x.checked = prevMain.has(x.value); });
      document.querySelectorAll(".day-reason-item").forEach((x) => { x.checked = prevReason.has(x.value); });

      // è¤‡åˆï¼ˆå…¥æµ´å¯¾å¿œï¼‰ã‚µãƒ–ãƒã‚§ãƒƒã‚¯ã‚‚å¾©å…ƒ
      applyBathingSubSelected(prevBathingSub, "main");
      applyHealthSubSelected(prevHealthSub, "main");


      // ãƒã‚§ãƒƒã‚¯å†…å®¹ã®è‡ªå‹•åæ˜ ï¼ˆæ¥­å‹™æ—¥èªŒæ¬„ï¼‰
      updateAutoNoteMain();
    }

    // ===== ãƒ†ãƒ³ãƒ—ãƒ¬ï¼ˆå…±é€šï¼‰ =====
    function loadTemplates() {
      try {
        const raw = localStorage.getItem(TEMPLATES_KEY);
        if (!raw) return [];
        const parsed = JSON.parse(raw);
        if (!Array.isArray(parsed)) return [];
        return parsed
          .filter((t) => t && typeof t.name === "string" && typeof t.text === "string")
          .map((t) => (!t.scope ? { ...t, scope: "common" } : t));
      } catch (e) {
        console.error("load templates error", e);
        return [];
      }
    }
    function saveTemplates() { localStorage.setItem(TEMPLATES_KEY, JSON.stringify(templates)); }

    // ===== å…±é€šãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ =====
    function escapeHtml(str) {
      return String(str)
        .replaceAll("&", "&amp;")
        .replaceAll("<", "&lt;")
        .replaceAll(">", "&gt;")
        .replaceAll('"', "&quot;")
        .replaceAll("'", "&#039;");
    }
    function toLocalISODate(d = new Date()) {
  const tz = d.getTimezoneOffset() * 60000;
  return new Date(d.getTime() - tz).toISOString().slice(0, 10);
}
function parseLocalISODate(iso) {
  return iso ? new Date(iso + "T00:00:00") : null; // ãƒ­ãƒ¼ã‚«ãƒ«0æ™‚
}


const DOW_JP = ["æ—¥","æœˆ","ç«","æ°´","æœ¨","é‡‘","åœŸ"];
function formatDateWithDow(iso) {
  // è¿”ã‚Šå€¤ï¼šæ—¥ä»˜(ä¸Šæ®µ)ï¼‹æ›œæ—¥(ä¸‹æ®µ) ç”¨
  if (!iso) return { dateText: "", dowText: "", className: "" };
  const d = parseLocalISODate(iso);
  if (!d || isNaN(d.getTime())) return { dateText: iso, dowText: "", className: "" };
  const dow = d.getDay();
  let className = "";
  if (dow === 0) className = "dow-sun";
  else if (dow === 6) className = "dow-sat";
  return { dateText: iso, dowText: `ï¼ˆ${DOW_JP[dow]}ï¼‰`, className };
}

    function escapeHtmlAttr(str) { return escapeHtml(str); }

    function populateResidentSelect(selectEl, placeholderText = "é¸æŠã—ã¦ãã ã•ã„") {
      if (!selectEl) return;
      const cur = selectEl.value;
      selectEl.innerHTML = "";
      const ph = document.createElement("option");
      ph.value = "";
      ph.textContent = placeholderText;
      selectEl.appendChild(ph);
      residents.forEach((name) => {
        const opt = document.createElement("option");
        opt.value = name;
        opt.textContent = name;
        selectEl.appendChild(opt);
      });
      selectEl.value = (cur && residents.includes(cur)) ? cur : "";
    }



    function populateRecorderSelect(selectEl, placeholderText = "ï¼ˆé¸æŠï¼‰") {
      if (!selectEl) return;
      const cur = selectEl.value;
      selectEl.innerHTML = "";
      const ph = document.createElement("option");
      ph.value = "";
      ph.textContent = placeholderText;
      selectEl.appendChild(ph);
      (recorders || []).forEach((name) => {
        const opt = document.createElement("option");
        opt.value = name;
        opt.textContent = name;
        selectEl.appendChild(opt);
      });
      selectEl.value = (cur && (recorders || []).includes(cur)) ? cur : "";
    }

    function ensureSelectHasValue(selectEl, value) {
      if (!selectEl) return;
      const v = (value || "").trim();
      if (!v) return;
      const exists = Array.from(selectEl.options).some((o) => o.value === v);
      if (exists) return;
      const opt = document.createElement("option");
      opt.value = v;
      opt.textContent = v;
      selectEl.appendChild(opt);
    }

    function renderRecorderSelects() {
      const recorderSelect = document.getElementById("recorder");
      const editSelect = document.getElementById("editRecorder");
      const manageSelect = document.getElementById("recorderManageSelect");
      const recorderCountLabel = document.getElementById("recorderCount");

      if (recorderCountLabel) recorderCountLabel.textContent = (recorders || []).length + "å";

      populateRecorderSelect(recorderSelect, "ï¼ˆé¸æŠï¼‰");
      populateRecorderSelect(editSelect, "ï¼ˆé¸æŠï¼‰");
      populateRecorderSelect(manageSelect, "é¸æŠã—ã¦ãã ã•ã„");
    }
    function renderResidentSelects() {
      const residentSelect = document.getElementById("resident");
      const filterSelect = document.getElementById("filterResident");
      const manageSelect = document.getElementById("residentManageSelect");
      const residentCountLabel = document.getElementById("residentCount");

      if (residentCountLabel) residentCountLabel.textContent = residents.length + "å";

      if (residentSelect) {
        const current = residentSelect.value;
        residentSelect.innerHTML = "";
        const placeholder = document.createElement("option");
        placeholder.value = "";
        placeholder.textContent = "é¸æŠã—ã¦ãã ã•ã„";
        residentSelect.appendChild(placeholder);
        residents.forEach((name) => {
          const opt = document.createElement("option");
          opt.value = name;
          opt.textContent = name;
          residentSelect.appendChild(opt);
        });
        residentSelect.value = (current && residents.includes(current)) ? current : "";
      }

      if (filterSelect) {
        const current = filterSelect.value;
        filterSelect.innerHTML = "";
        const optAll = document.createElement("option");
        optAll.value = "";
        optAll.textContent = "å…¨å“¡";
        filterSelect.appendChild(optAll);
        residents.forEach((name) => {
          const opt = document.createElement("option");
          opt.value = name;
          opt.textContent = name;
          filterSelect.appendChild(opt);
        });
        filterSelect.value = (current && residents.includes(current)) ? current : "";
      }

      if (manageSelect) {
        const current = manageSelect.value;
        manageSelect.innerHTML = "";
        const placeholder = document.createElement("option");
        placeholder.value = "";
        placeholder.textContent = "é¸æŠã—ã¦ãã ã•ã„";
        manageSelect.appendChild(placeholder);
        residents.forEach((name) => {
          const opt = document.createElement("option");
          opt.value = name;
          opt.textContent = name;
          manageSelect.appendChild(opt);
        });
        manageSelect.value = (current && residents.includes(current)) ? current : "";
      }

      // ç®¡ç†ï¼šåˆ©ç”¨è€…åˆ¥ç³»
      populateResidentSelect(document.getElementById("favResidentSelect"));
      populateResidentSelect(document.getElementById("rtResidentSelect"));
      populateResidentSelect(document.getElementById("dsResidentSelect"));

      // ç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ«ï¼šåˆ©ç”¨è€…
      populateResidentSelect(document.getElementById("editResident"));
    }

    function formatSupportSummary(text) {
      if (!text) return "";
      const trimmed = text.trim().replace(/\s+/g, " ");
      if (trimmed.length <= 40) return trimmed;
      return trimmed.slice(0, 40) + "â€¦";
    }

    function getTimeBadgeClass(timeSlot) {
      switch (timeSlot) {
        case "æ—¥ä¸­": return "badge-day";
        case "å¤•æ–¹": return "badge-evening";
        case "å¤œé–“": return "badge-night";
        default: return "badge-day";
      }
    }

    function renderRecords() {
      const tbody = document.getElementById("recordTableBody");
      const filterResident = document.getElementById("filterResident").value;
      const keyword = document.getElementById("searchKeyword").value.trim().toLowerCase().replace(/ï¼ƒ/g, "#");

      const specialOnlyCb = document.getElementById("filterSpecialOnly");
      const specialOnly = !!specialOnlyCb?.checked;
      const specialCountEl = document.getElementById("specialOnlyCount");
      const specialLabelEl = document.getElementById("specialFilterLabel");


      const periodFilterElement = document.getElementById("periodFilter");
      const periodFilter = periodFilterElement ? periodFilterElement.value : "month";

      const periodFromInput = document.getElementById("periodFrom");
      const periodToInput = document.getElementById("periodTo");
      const periodFrom = periodFromInput ? periodFromInput.value : "";
      const periodTo = periodToInput ? periodToInput.value : "";

     const now = new Date();
const todayStr = toLocalISODate(now);
const today0 = parseLocalISODate(todayStr);
const monthPrefix = todayStr.slice(0, 7);
const yearPrefix = todayStr.slice(0, 4);

const weekStart = new Date(today0);
weekStart.setDate(weekStart.getDate() - 6);


      tbody.innerHTML = "";

      const filteredBase = records.filter((r) => {
        if (filterResident && r.resident !== filterResident) return false;

        const dateStr = r.date;
        if (dateStr) {
          if (periodFilter === "today") {
            if (dateStr !== todayStr) return false;
          } else if (periodFilter === "week") {
            const d = new Date(dateStr);
            const d0 = parseLocalISODate(dateStr);
if (!d0) return false;
if (d0 < weekStart || d0 > today0) return false;
          } else if (periodFilter === "month") {
            if (dateStr.slice(0, 7) !== monthPrefix) return false;
          } else if (periodFilter === "year") {
            if (dateStr.slice(0, 4) !== yearPrefix) return false;
          } else if (periodFilter === "custom") {
            if (periodFrom && dateStr < periodFrom) return false;
            if (periodTo && dateStr > periodTo) return false;
          }
        } else {
          if (periodFilter !== "all") return false;
        }

        if (keyword) {
          const tagsText = (r.tags || []).join(" ");
          const tagsTextHash = (r.tags || []).map(t => "#" + t).join(" ");
          const target = (((r.support || "") + " " + (r.note || "") + " " + tagsText + " " + tagsTextHash)).toLowerCase();
          if (!target.includes(keyword)) return false;
        }

        return true;
      });

 
      const specialCount = filteredBase.filter((r) => !!r.hasSpecialNote).length;
      if (specialCountEl) specialCountEl.textContent = `ç‰¹è¨˜äº‹é …ã‚ã‚Šï¼š${specialCount}ä»¶`;
      if (specialLabelEl) specialLabelEl.classList.toggle("special-filter-on", specialOnly);

      const filtered = specialOnly ? filteredBase.filter((r) => !!r.hasSpecialNote) : filteredBase;

     document.getElementById("recordCount").textContent = filtered.length + "ä»¶";

      if (filtered.length === 0) {
        const tr = document.createElement("tr");
        const td = document.createElement("td");
        td.colSpan = 6;
        td.className = "no-records";
        td.textContent = "ã¾ã è¨˜éŒ²ãŒã‚ã‚Šã¾ã›ã‚“ã€‚å·¦ã®ãƒ•ã‚©ãƒ¼ãƒ ã‹ã‚‰ç™»éŒ²ã™ã‚‹ã‹ã€æœŸé–“ãƒ»åˆ©ç”¨è€…ã®æ¡ä»¶ã‚’å¤‰ãˆã¦ã¿ã¦ãã ã•ã„ã€‚";
        tr.appendChild(td);
        tbody.appendChild(tr);
        return;
      }

      filtered.slice().sort((a, b) => (a.date < b.date ? 1 : -1)).forEach((record) => {
        const tr = document.createElement("tr");

        const tdDate = document.createElement("td");
        tdDate.classList.add("date-cell");

        const dInfo = formatDateWithDow(record.date || "");
        // ä¸Šï¼šæ—¥ä»˜ / ä¸‹ï¼šæ›œæ—¥ï¼ˆè‰²ã¯åœŸ=é’ãƒ»æ—¥=èµ¤ï¼‰
        const dateTop = document.createElement("div");
        dateTop.textContent = dInfo.dateText || "";
        tdDate.appendChild(dateTop);

        if (dInfo.dowText) {
          const dateDow = document.createElement("div");
          dateDow.className = "date-dow";
          dateDow.textContent = dInfo.dowText;
          if (dInfo.className) dateDow.classList.add(dInfo.className);
          tdDate.appendChild(dateDow);
        }

        tr.appendChild(tdDate);

        
const tdResident = document.createElement("td");
const nameSpan = document.createElement("span");
nameSpan.textContent = record.resident || "";
tdResident.appendChild(nameSpan);

if (record.hasSpecialNote) {
  const badge = document.createElement("span");
  badge.className = "special-badge";
  badge.textContent = "ç‰¹è¨˜äº‹é …";
  tdResident.appendChild(badge);
}

tr.appendChild(tdResident);
const tdDayMain = document.createElement("td");
        const mainItemsRaw = Array.isArray(record.daySupportMainItems) ? record.daySupportMainItems : [];
        const mainItems = formatDaySupportMainItems(mainItemsRaw, record.daySupportBathingSubItems, record.daySupportHealthSubItems);
        if (mainItems.length) {
          const wrap = document.createElement("div");
          wrap.className = "list-support-tags";
          mainItems.forEach((t) => {
            const chip = document.createElement("span");
            chip.className = "list-support-tag";
            chip.textContent = t;
            wrap.appendChild(chip);
          });
          tdDayMain.appendChild(wrap);
        } else {
          tdDayMain.innerHTML = "<span class='small-text'>ï¼ˆãªã—ï¼‰</span>";
        }
        tr.appendChild(tdDayMain);

        const tdSupport = document.createElement("td");


// æ”¯æ´å†…å®¹ï¼ˆæŠ˜ã‚ŠãŸãŸã¿ï¼‰
const full = (record.support || "").trim();
const supportDiv = document.createElement("div");
supportDiv.className = "support-preview";
supportDiv.textContent = full;

// é•·æ–‡ã ã‘ã€Œã‚‚ã£ã¨è¦‹ã‚‹ã€ã‚’å‡ºã™
const needToggle = full.length > 120 || full.includes("\n");
if (needToggle) {
  const toggle = document.createElement("button");
  toggle.type = "button";
  toggle.className = "support-toggle";
  toggle.textContent = "ã‚‚ã£ã¨è¦‹ã‚‹";
  toggle.addEventListener("click", () => {
    const expanded = supportDiv.classList.toggle("expanded");
    toggle.textContent = expanded ? "é–‰ã˜ã‚‹" : "ã‚‚ã£ã¨è¦‹ã‚‹";
  });
  tdSupport.appendChild(supportDiv);
  tdSupport.appendChild(toggle);
} else {
  tdSupport.appendChild(supportDiv);
}

// ã‚¿ã‚°è¡¨ç¤ºï¼ˆä»Šã¾ã§é€šã‚Šï¼‰
if (record.tags && record.tags.length) {
  const tagDiv = document.createElement("div");
  tagDiv.className = "small-text";
  record.tags.forEach((tag) => {
    const spanTag = document.createElement("span");
    spanTag.className = "tag-chip";
    spanTag.textContent = "#" + tag;
    tagDiv.appendChild(spanTag);
  });
  tdSupport.appendChild(tagDiv);
}

tr.appendChild(tdSupport);
        const tdActions = document.createElement("td");

        const viewBtn = document.createElement("button");
        viewBtn.textContent = "è©³ç´°";
        viewBtn.className = "btn-secondary";
        viewBtn.style.fontSize = "12px";
        viewBtn.onclick = () => showRecordDetail(record.id);

        const editBtn = document.createElement("button");
        editBtn.textContent = "ç·¨é›†";
        editBtn.className = "btn-secondary";
        editBtn.style.fontSize = "12px";
        editBtn.onclick = () => openEditModal(record.id);

        const delBtn = document.createElement("button");
        delBtn.textContent = "å‰Šé™¤";
        delBtn.className = "btn-danger";
        delBtn.style.fontSize = "12px";
        delBtn.onclick = () => deleteRecord(record.id);

        tdActions.appendChild(viewBtn);
        tdActions.appendChild(editBtn);
        tdActions.appendChild(delBtn);
        tr.appendChild(tdActions);

        tbody.appendChild(tr);
      });
    }

    function resetForm() {
      document.getElementById("recordForm").reset();
      document.getElementById("date").value = toLocalISODate();
      const _ts = document.getElementById("timeSlot");
      if (_ts) _ts.value = "æ—¥ä¸­";
      const _cond = document.getElementById("condition");
      if (_cond) _cond.value = "è‰¯å¥½";
      const _ment = document.getElementById("mental");
      if (_ment) _ment.value = "å®‰å®š";

      const daySupportType = document.getElementById("daySupportType");
      if (daySupportType) daySupportType.value = "";      currentTags = [];
      updateTagUI();
      syncQuickButtonsAll();

      document.getElementById("modeLabel").textContent = "æ–°è¦å…¥åŠ›ãƒ¢ãƒ¼ãƒ‰";
      document.getElementById("modeLabel").style.background = "#eff6ff";
      document.getElementById("modeLabel").style.color = "#1d4ed8";
      document.getElementById("saveButton").textContent = "ğŸ’¾ è¨˜éŒ²ã‚’ä¿å­˜";

      document.querySelectorAll(".auto-item").forEach((el) => { el.checked = false; });
      // å…¥æµ´ï¼ˆâ‘¡ è‡ªå‹•å…¥åŠ›ï¼‰ã‚µãƒ–ãƒã‚§ãƒƒã‚¯ã‚‚ãƒªã‚»ãƒƒãƒˆ
      document.querySelectorAll(".auto-bath-sub").forEach((el) => { el.checked = false; });
      setupAutoBathCompound();
      setupAutoHealthCompound();
      syncAutoItemsToSupport();

      // æ—¥ä¸­æ”¯æ´ãƒ†ãƒ³ãƒ—ãƒ¬ï¼ˆæ—¥ä¸­æ”¯æ´åŠ ç®—â… ãƒ»æ¥­å‹™æ—¥èªŒã¸è¿½è¨˜ï¼‰ã®ãƒã‚§ãƒƒã‚¯ã‚‚ãƒªã‚»ãƒƒãƒˆ
      document.querySelectorAll("#dayNoteTemplateChecks .day-note-tpl-check").forEach((el) => { el.checked = false; });

      // æ—¥ä¸­æ”¯æ´ãƒã‚§ãƒƒã‚¯ãƒªã‚»ãƒƒãƒˆ
      document.querySelectorAll(".day-activity-item").forEach((el) => { el.checked = false; });
      document.querySelectorAll(".day-main-item").forEach((el) => { el.checked = false; });
      document.querySelectorAll(".day-main-bathing-sub").forEach((el) => { el.checked = false; });

      document.querySelectorAll(".day-reason-item").forEach((el) => { el.checked = false; });

      const templateScope = document.getElementById("templateScope");
      if (templateScope) templateScope.value = "common";
      renderTemplateSelect();

      // åˆ©ç”¨è€…åˆ¥ãƒ†ãƒ³ãƒ—ãƒ¬ã®é¸æŠã‚‚æ›´æ–°
      renderResidentTemplateSelectForForm();

      // ç‰¹è¨˜äº‹é …ã‚ã‚Šï¼šå¼·èª¿è§£é™¤
      const __scb = document.getElementById("hasSpecialNote");
      if (__scb) __scb.checked = false;
      const __nta = document.getElementById("note");
      if (__nta) __nta.classList.remove("special-note-on");

      // ãƒã‚¤ã‚¿ãƒ«ï¼ˆä½“é‡ãƒ»è¡€åœ§ãƒ»è„ˆæ‹ï¼‰
      const __vW  = document.getElementById("abnormalWeight");
      const __vS  = document.getElementById("abnormalBPsys");
      const __vD  = document.getElementById("abnormalBPdia");
      const __vP  = document.getElementById("abnormalPulse");
      if (__vW) __vW.value = "";
      if (__vS) __vS.value = "";
      if (__vD) __vD.value = "";
      if (__vP) __vP.value = "";
      syncAbnormalVitalsUI("main");
      updateAutoNoteMain();

    }

    function deleteRecord(id) {
      if (!confirm("ã“ã®è¨˜éŒ²ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")) return;
      records = records.filter((r) => r.id !== id);
      saveRecords();
      renderRecords();
    }

    // ===== ä¿å­˜ã—ã¾ã—ãŸï¼ˆãƒˆãƒ¼ã‚¹ãƒˆï¼‰ =====
    let __toastTimer = null;
    function showToast(message) {
      const el = document.getElementById("saveToast");
      if (!el) { alert(message || "ä¿å­˜ã—ã¾ã—ãŸ"); return; }
      el.textContent = (message || "ä¿å­˜ã—ã¾ã—ãŸ");
      el.classList.add("show");
      if (__toastTimer) clearTimeout(__toastTimer);
      __toastTimer = setTimeout(() => el.classList.remove("show"), 1600);
    }

// ===== ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ— / å¾©å…ƒ =====
function buildBackupPayload() {
  return {
    app: "group_home_personal_record",
    schemaVersion: 1,
    exportedAt: new Date().toISOString(),
    data: {
      records: Array.isArray(records) ? records : [],
      residents: Array.isArray(residents) ? residents : [],
      recorders: Array.isArray(recorders) ? recorders : [],
      templates: Array.isArray(templates) ? templates : [],
      autoItemDefs: Array.isArray(AUTO_ITEM_DEFS) ? AUTO_ITEM_DEFS : [],
      tags: Array.isArray(TAG_LIST) ? TAG_LIST : [],
      favByResident: (favByResident && typeof favByResident === "object") ? favByResident : {},
      residentAutoTemplates: (residentAutoTemplates && typeof residentAutoTemplates === "object") ? residentAutoTemplates : {},
      daySupportByResident: (daySupportByResident && typeof daySupportByResident === "object") ? daySupportByResident : {},
      dayNoteTemplates: Array.isArray(dayNoteTemplates) ? dayNoteTemplates : [],
      vitals: (function(){ try { const r = localStorage.getItem(VITALS_KEY); const v = JSON.parse(r||'[]'); return Array.isArray(v)?v:[]; } catch(e){ return []; } })(),
    }
  };
}

function yyyymmdd_hhmmss() {
  const d = new Date();
  const pad = (n) => String(n).padStart(2, "0");
  const y = d.getFullYear();
  const m = pad(d.getMonth() + 1);
  const da = pad(d.getDate());
  const h = pad(d.getHours());
  const mi = pad(d.getMinutes());
  const s = pad(d.getSeconds());
  return `${y}${m}${da}_${h}${mi}${s}`;
}

function downloadTextFile(filename, textContent, mime = "application/json") {
  const blob = new Blob([textContent], { type: mime });
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = filename;
  document.body.appendChild(a);
  a.click();
  a.remove();
  setTimeout(() => URL.revokeObjectURL(url), 5000);
}

function downloadBackup(suffix = "") {
  const payload = buildBackupPayload();
  const filename = `group_home_backup_${yyyymmdd_hhmmss()}${suffix ? "_" + suffix : ""}.json`;
  downloadTextFile(filename, JSON.stringify(payload, null, 2));
  showToast("ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‚’ä¿å­˜ã—ã¾ã—ãŸ");
}

function normalizeBackupData(parsed) {
  // æ–°å½¢å¼: { data: { ... } }
  if (parsed && typeof parsed === "object" && parsed.data && typeof parsed.data === "object") return parsed.data;

  // æ—§å½¢å¼: { records:..., residents:..., ... }
  const keys = ["records","residents","recorders","templates","autoItemDefs","tags","favByResident","residentAutoTemplates","daySupportByResident","dayNoteTemplates","vitals"];
  const hasAny = keys.some((k) => Object.prototype.hasOwnProperty.call(parsed || {}, k));
  if (hasAny) {
    return {
      records: parsed.records,
      residents: parsed.residents,
      recorders: parsed.recorders,
      templates: parsed.templates,
      autoItemDefs: parsed.autoItemDefs,
      tags: parsed.tags,
      favByResident: parsed.favByResident,
      residentAutoTemplates: parsed.residentAutoTemplates,
      daySupportByResident: parsed.daySupportByResident,
      dayNoteTemplates: parsed.dayNoteTemplates,
      vitals: parsed.vitals,
    };
  }
  return null;
}

function applyRestoreData(data) {
  const safeArr = (v) => Array.isArray(v) ? v : [];
  const safeObj = (v) => (v && typeof v === "object" && !Array.isArray(v)) ? v : {};

  const next = {
    records: safeArr(data.records),
    residents: safeArr(data.residents),
    recorders: safeArr(data.recorders),
    templates: safeArr(data.templates),
    autoItemDefs: safeArr(data.autoItemDefs),
    tags: safeArr(data.tags),
    favByResident: safeObj(data.favByResident),
    residentAutoTemplates: safeObj(data.residentAutoTemplates),
    daySupportByResident: safeObj(data.daySupportByResident),
    dayNoteTemplates: safeArr(data.dayNoteTemplates),
    vitals: safeArr(data.vitals),
  };

  // localStorageã¸åæ˜ ï¼ˆã‚¢ãƒ—ãƒªã®å„ãƒ‡ãƒ¼ã‚¿ï¼‰
  localStorage.setItem(STORAGE_KEY, JSON.stringify(next.records));
  localStorage.setItem(RESIDENTS_KEY, JSON.stringify(next.residents));
  localStorage.setItem(RECORDERS_KEY, JSON.stringify(next.recorders));
  localStorage.setItem(TEMPLATES_KEY, JSON.stringify(next.templates));
  localStorage.setItem(AUTO_ITEM_DEFS_KEY, JSON.stringify(next.autoItemDefs));
  localStorage.setItem(TAGS_KEY, JSON.stringify(next.tags));
  localStorage.setItem(FAV_BY_RESIDENT_KEY, JSON.stringify(next.favByResident));
  localStorage.setItem(RESIDENT_AUTO_TEMPLATES_KEY, JSON.stringify(next.residentAutoTemplates));
  localStorage.setItem(DAY_SUPPORT_BY_RESIDENT_KEY, JSON.stringify(next.daySupportByResident));
  localStorage.setItem(DAY_NOTE_TEMPLATES_KEY, JSON.stringify(next.dayNoteTemplates));
  localStorage.setItem(VITALS_KEY, JSON.stringify(next.vitals));
}

function handleRestoreFile(file) {
  if (!file) return;
  const reader = new FileReader();
  reader.onload = () => {
    try {
      const raw = String(reader.result || "");
      const parsed = JSON.parse(raw);
      const data = normalizeBackupData(parsed);
      if (!data) {
        alert("ã“ã®ãƒ•ã‚¡ã‚¤ãƒ«ã¯å¾©å…ƒç”¨ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã¨ã—ã¦èªè­˜ã§ãã¾ã›ã‚“ã§ã—ãŸï¼ˆJSONå½¢å¼ã¯OKã§ã™ãŒä¸­èº«ãŒé•ã†å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ï¼‰ã€‚");
        return;
      }

      const nowCount = Array.isArray(records) ? records.length : 0;
      const backupCount = Array.isArray(data.records) ? data.records.length : 0;

      // âœ… å¾©å…ƒå‰ã«ã€Œç¾åœ¨ãƒ‡ãƒ¼ã‚¿ã€ã‚’è‡ªå‹•ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ï¼ˆå®‰å…¨ï¼‰
      downloadBackup("before_restore");

      const ok = confirm(
        `å¾©å…ƒã—ã¾ã™ã‹ï¼Ÿ\n\n` +
        `ç¾åœ¨ã®è¨˜éŒ²ï¼š${nowCount}ä»¶\n` +
        `ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã®è¨˜éŒ²ï¼š${backupCount}ä»¶\n\n` +
        `â€»å¾©å…ƒã™ã‚‹ã¨ã€ç¾åœ¨ã®ãƒ‡ãƒ¼ã‚¿ã¯ä¸Šæ›¸ãã•ã‚Œã¾ã™ã€‚`
      );
      if (!ok) return;

      applyRestoreData(data);

      showToast("å¾©å…ƒã—ã¾ã—ãŸï¼ˆå†èª­ã¿è¾¼ã¿ã—ã¾ã™ï¼‰");
      setTimeout(() => location.reload(), 450);
    } catch (e) {
      alert("å¾©å…ƒã«å¤±æ•—ã—ã¾ã—ãŸã€‚JSONãƒ•ã‚¡ã‚¤ãƒ«ãŒå£Šã‚Œã¦ã„ã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚\n" + (e?.message || e));
    }
  };
  reader.onerror = () => alert("ãƒ•ã‚¡ã‚¤ãƒ«ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚");
  reader.readAsText(file, "utf-8");
}


    function handleSubmit(event) {
      event.preventDefault();

      const date = document.getElementById("date").value;
      const resident = document.getElementById("resident").value;
      if (!date || !resident) {
        alert("æ—¥ä»˜ã¨åˆ©ç”¨è€…ã¯å¿…é ˆã§ã™ã€‚");
        return;
      }

      const daySupportType = document.getElementById("daySupportType")?.value || "";      const dayActivityItems = Array.from(document.querySelectorAll(".day-activity-item:checked")).map((el) => el.value);

      const daySupportMainItems = Array.from(document.querySelectorAll(".day-main-item:checked")).map((el) => el.value);
      const daySupportReasonItems = Array.from(document.querySelectorAll(".day-reason-item:checked")).map((el) => el.value);

      const recordData = {
        id: Date.now().toString(),
        date,
        resident,
        recorder: document.getElementById("recorder")?.value || "",        medTaken: false,
        support: document.getElementById("support").value,
        note: document.getElementById("note").value,
        hasSpecialNote: !!document.getElementById("hasSpecialNote")?.checked,
        tags: [...currentTags],
        daySupportType,        dayActivityItems,
        daySupportMainItems,
        daySupportReasonItems,
        daySupportBathingSubItems: getBathingSubSelected("main"),
        daySupportHealthSubItems: getHealthSubSelected("main"),
        abnormalVitalsOn: !!((document.getElementById("abnormalWeight")?.value || "").trim() || (document.getElementById("abnormalBPsys")?.value || "").trim() || (document.getElementById("abnormalBPdia")?.value || "").trim() || (document.getElementById("abnormalPulse")?.value || "").trim()),
        abnormalWeight: (document.getElementById("abnormalWeight")?.value || "").trim(),
        abnormalBPsys: (document.getElementById("abnormalBPsys")?.value || "").trim(),
        abnormalBPdia: (document.getElementById("abnormalBPdia")?.value || "").trim(),
        abnormalPulse: (document.getElementById("abnormalPulse")?.value || "").trim(),
      };

      records.push(recordData);
      saveRecords();
      showToast("ä¿å­˜ã—ã¾ã—ãŸ");
      renderRecords();
      resetForm();
    }

    // â˜…è‡ªå‹•ï¼šåˆ©ç”¨è€…åˆ¥ãƒ†ãƒ³ãƒ—ãƒ¬ï¼ˆé¸æŠï¼‰ï¼‹å…±é€šãƒ†ãƒ³ãƒ—ãƒ¬ï¼ˆé¸æŠï¼‰ï¼‹ãƒã‚§ãƒƒã‚¯é …ç›®ï¼ˆé¸æŠï¼‰ã‚’ã¾ã¨ã‚ã¦è¿½è¨˜
    function generateSupportText() {
      const textArea = document.getElementById("support");
      const resident = document.getElementById("resident")?.value;

      const parts = [];

      // 1) åˆ©ç”¨è€…åˆ¥ãƒ†ãƒ³ãƒ—ãƒ¬ï¼ˆé¸æŠã•ã‚Œã¦ã„ã‚Œã°ï¼‰
      const rtSel = document.getElementById("residentTemplateSelect");
      if (resident && rtSel && rtSel.value) {
        const st = ensureResidentTemplateState(resident);
        const tpl = st.templates.find((t) => t.id === rtSel.value);
        if (tpl && (tpl.text || "").trim()) parts.push(tpl.text.trim());
      }

      // 2) å…±é€šãƒ†ãƒ³ãƒ—ãƒ¬ï¼ˆé¸æŠã•ã‚Œã¦ã„ã‚Œã°ï¼‰
      const templateSelectEl = document.getElementById("templateSelect");
      const idxStr = templateSelectEl ? templateSelectEl.value : "";
      if (idxStr) {
        const idx = parseInt(idxStr, 10);
        if (!Number.isNaN(idx) && templates[idx]) {
          const t = (templates[idx].text || "").trim();
          if (t) parts.push(t);
        }
      }

      // 3) ãƒã‚§ãƒƒã‚¯é …ç›®
      // â‘¡ãƒã‚§ãƒƒã‚¯é€£å‹•ã®ã€Œå®Œå…¨è‡ªå‹•ã€ãƒ–ãƒ­ãƒƒã‚¯ãŒæ—¢ã«ã‚ã‚‹å ´åˆã¯ã€ã“ã“ã§é‡è¤‡è¿½è¨˜ã—ãªã„
      if (!hasAutoSupportBlock(textArea?.value || "")) {
        const checkedKeys = Array.from(document.querySelectorAll(".auto-item:checked")).map((el) => el.value);
        if (checkedKeys.length > 0) {
          const daySupportType = document.getElementById("daySupportType")?.value || "";
          const daySupportTypeLabel = daySupportType ? ("æ—¥ä¸­æ”¯æ´åŠ ç®—" + daySupportType) : "æ—¥ä¸­æ”¯æ´åŠ ç®—";

          checkedKeys.forEach((key) => {
            // å…¥æµ´ã ã‘ã¯è¤‡åˆãƒã‚§ãƒƒã‚¯ã‹ã‚‰æ–‡ç« ç”Ÿæˆ
            if (key === "bathing") {
              const t = buildAutoBathSentence();
              if (t) parts.push(t);
              return;
            }

            if (key === "health") {
              const t = buildAutoHealthSentence();
              if (t) parts.push(t);
              return;
            }
            const def = AUTO_ITEM_DEFS.find((d) => d.key === key);
            if (!def) return;
            let text = (def.defaultText || "").trim();
            if (!text) return;
            text = text.replaceAll("{{daySupportTypeLabel}}", daySupportTypeLabel);
            parts.push(text);
          });
        }
      }

      if (parts.length === 0) {
        alert("è¿½è¨˜ã™ã‚‹å†…å®¹ãŒã‚ã‚Šã¾ã›ã‚“ã€‚\nãƒ»è‡ªå‹•ãƒ†ãƒ³ãƒ—ãƒ¬ï¼ˆåˆ©ç”¨è€…åˆ¥ï¼‰ã‚’é¸ã¶\nãƒ»å…±é€šãƒ†ãƒ³ãƒ—ãƒ¬ã‚’é¸ã¶\nãƒ»ã¾ãŸã¯ã€Œè‡ªå‹•å…¥åŠ›ã—ãŸã„æ”¯æ´é …ç›®ã€ã«ãƒã‚§ãƒƒã‚¯\nã®ã©ã‚Œã‹ã‚’è¡Œã£ã¦ãã ã•ã„ã€‚");
        return;
      }

      const newText = parts.join("\n");

      if (textArea.value.trim()) textArea.value = textArea.value.replace(/\s*$/, "") + "\n" + newText;
      else textArea.value = newText;
    }

      // è¨˜éŒ²è©³ç´°ãƒ¢ãƒ¼ãƒ€ãƒ«è¡¨ç¤º
    function showRecordDetail(id) {
      const record = records.find((r) => r.id === id);
      if (!record) return;

      const modal = document.getElementById("detailModal");
      const content = document.getElementById("detailModalContent");
      const titleEl = document.getElementById("detailModalTitle");
      if (!modal || !content) return;

      content.innerHTML = "";

      const addRow = (label, value) => {
        const div = document.createElement("div");
        div.className = "detail-field";
        const strong = document.createElement("strong");
        strong.textContent = label;
        const span = document.createElement("span");
        span.textContent = value || "";
        div.appendChild(strong);
        div.appendChild(span);
        content.appendChild(div);
      };

      // âœ… ã‚¿ã‚°è¡Œï¼ˆä¸»ãªæ”¯æ´ / æ¬ å¸­ç†ç”±ï¼‰
      const addTagRow = (label, items, type = "main") => {
        const div = document.createElement("div");
        div.className = "detail-field detail-tagrow";

        const strong = document.createElement("strong");
        strong.textContent = label;
        div.appendChild(strong);

        const arr = Array.isArray(items) ? items : [];
        if (arr.length === 0) {
          const span = document.createElement("span");
          span.textContent = "ãªã—";
          div.appendChild(span);
        } else {
          const box = document.createElement("div");
          box.className = "support-tags";

          arr.forEach((txt) => {
            const tag = document.createElement("span");
            tag.className = "support-tag" + (type === "reason" ? " reason" : "");
            tag.textContent = txt;
            box.appendChild(tag);
          });

          div.appendChild(box);
        }

        content.appendChild(div);
      };

      const addMultiline = (label, value) => {
        const wrap = document.createElement("div");
        wrap.className = "detail-multiline";
        const strong = document.createElement("strong");
        strong.textContent = label;
        const pre = document.createElement("pre");
        pre.textContent = value || "";
        wrap.appendChild(strong);
        wrap.appendChild(pre);
        content.appendChild(wrap);
      };

      const tagsText = record.tags && record.tags.length ? record.tags.map((t) => "#" + t).join(" ") : "ãªã—";
const daySupportTypeLabel = record.daySupportType ? "æ—¥ä¸­æ”¯æ´åŠ ç®—" + record.daySupportType : "ãªã—";

      if (titleEl) titleEl.textContent = `${record.date || ""} ${record.resident || ""} ã•ã‚“ã®è¨˜éŒ²`;

      addRow("æ—¥ä»˜ï¼š", record.date || "");
      addRow("åˆ©ç”¨è€…ï¼š", record.resident || "");
      addRow("è¨˜éŒ²è€…ï¼š", record.recorder || "");// ãƒã‚¤ã‚¿ãƒ«ï¼ˆä½“é‡ãƒ»è¡€åœ§ãƒ»è„ˆæ‹ï¼‰
      if ((record.abnormalVitalsOn || record.abnormalWeight || record.abnormalBPsys || record.abnormalBPdia || record.abnormalPulse)) {
        const parts = [];
        if (record.abnormalWeight) parts.push(`ä½“é‡ ${record.abnormalWeight}kg`);
        if (record.abnormalBPsys && record.abnormalBPdia) parts.push(`è¡€åœ§ ${record.abnormalBPsys}/${record.abnormalBPdia}mmHg`);
        else if (record.abnormalBPsys) parts.push(`è¡€åœ§ ä¸Š${record.abnormalBPsys}mmHg`);
        else if (record.abnormalBPdia) parts.push(`è¡€åœ§ ä¸‹${record.abnormalBPdia}mmHg`);
        if (record.abnormalPulse) parts.push(`è„ˆæ‹ ${record.abnormalPulse}å›/åˆ†`);
        addRow("ãƒã‚¤ã‚¿ãƒ«ï¼š", parts.join("ã€"));
      }
      addRow("ã‚¿ã‚°ï¼š", tagsText);
      addRow("æ—¥ä¸­æ”¯æ´åŠ ç®—åŒºåˆ†ï¼š", daySupportTypeLabel);      // âœ… ã“ã“ãŒã‚¿ã‚°è¡¨ç¤º
      addTagRow("æ—¥ä¸­æ´»å‹•ï¼š", record.dayActivityItems, "activity");
      addTagRow("ä¸»ãªæ”¯æ´ï¼š", formatDaySupportMainItems(record.daySupportMainItems, record.daySupportBathingSubItems, record.daySupportHealthSubItems), "main");
      addTagRow("æ¬ å¸­ç†ç”±ï¼š", record.daySupportReasonItems, "reason");
      // ç‰¹è¨˜äº‹é …ã‚ã‚Šï¼ˆä¸€è¦§ã‹ã‚‰ä¸€ç¬ã§åˆ†ã‹ã‚‹ã‚ˆã†ã«ï¼‰
      addRow("ç‰¹è¨˜äº‹é …ï¼š", record.hasSpecialNote ? "ã‚ã‚Š" : "ãªã—");
      addMultiline("æœ¬æ—¥ã®æ”¯æ´å†…å®¹ (è·å“¡å´)ï¼š", record.support || "");
addMultiline("æ¥­å‹™æ—¥èªŒãƒ»åˆ©ç”¨è€…ã®æ´»å‹•çŠ¶æ³ï¼ˆç‰¹è¨˜äº‹é …å«ã‚€ï¼‰ï¼š", record.note || "");

      modal.classList.add("show");
    }


    
    function formatDaySupportMainItems(items, bathingSubItems, healthSubItems) {
      const arr = Array.isArray(items) ? items.slice() : [];
      const bathSubs = Array.isArray(bathingSubItems) ? bathingSubItems.filter(Boolean) : [];
      const healthSubs = Array.isArray(healthSubItems) ? healthSubItems.filter(Boolean) : [];

      return arr.map((x) => {
        if (x === BATHING_MAIN_KEY) {
          return bathSubs.length ? `${BATHING_MAIN_KEY}ï¼ˆ${bathSubs.join("ãƒ»")}ï¼‰` : BATHING_MAIN_KEY;
        }
        if (x === HEALTH_MAIN_KEY) {
          return healthSubs.length ? `${HEALTH_MAIN_KEY}ï¼ˆ${healthSubs.join("ãƒ»")}ï¼‰` : HEALTH_MAIN_KEY;
        }
        return x;
      });
    }

function closeRecordDetail() {
      const modal = document.getElementById("detailModal");
      if (modal) modal.classList.remove("show");
    }

    // ===== ã‚¿ã‚°ï¼ˆãƒ¡ã‚¤ãƒ³ï¼‰ =====
    function setupTagButtons() {
      const container = document.getElementById("tagButtons");
      container.innerHTML = "";
      TAG_LIST.forEach((tag) => {
        const btn = document.createElement("button");
        btn.type = "button";
        btn.className = "tag-button";
        btn.textContent = "#" + tag;
        btn.dataset.tag = tag;
        btn.addEventListener("click", () => toggleTag(tag));
        container.appendChild(btn);
      });
      updateTagUI();
    }

    function toggleTag(tag) {
      const idx = currentTags.indexOf(tag);
      if (idx >= 0) currentTags.splice(idx, 1);
      else currentTags.push(tag);
      updateTagUI();
    }

    function updateTagUI() {
      const info = document.getElementById("selectedTagsInfo");
      if (!info) return;

      if (currentTags.length === 0) info.textContent = "é¸æŠä¸­ï¼šãªã—";
      else info.textContent = "é¸æŠä¸­ï¼š " + currentTags.map((t) => "#" + t).join(" ");

      const buttons = document.querySelectorAll("#tagButtons .tag-button");
      buttons.forEach((btn) => {
        const t = btn.dataset.tag;
        if (currentTags.includes(t)) btn.classList.add("tag-button-active");
        else btn.classList.remove("tag-button-active");
      });
    }

    // ===== ã‚¿ã‚°ï¼ˆç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ«ï¼‰ =====
    function renderEditTagButtons() {
      const container = document.getElementById("editTagButtons");
      const info = document.getElementById("editSelectedTagsInfo");
      if (!container || !info) return;

      container.innerHTML = "";
      TAG_LIST.forEach((tag) => {
        const btn = document.createElement("button");
        btn.type = "button";
        btn.className = "tag-button";
        btn.textContent = "#" + tag;
        btn.dataset.tag = tag;
        btn.addEventListener("click", () => {
          const idx = editTags.indexOf(tag);
          if (idx >= 0) editTags.splice(idx, 1);
          else editTags.push(tag);
          updateEditTagUI();
        });
        container.appendChild(btn);
      });
      updateEditTagUI();
    }

    function updateEditTagUI() {
      const info = document.getElementById("editSelectedTagsInfo");
      if (!info) return;

      if (editTags.length === 0) info.textContent = "é¸æŠä¸­ï¼šãªã—";
      else info.textContent = "é¸æŠä¸­ï¼š " + editTags.map((t) => "#" + t).join(" ");

      const buttons = document.querySelectorAll("#editTagButtons .tag-button");
      buttons.forEach((btn) => {
        const t = btn.dataset.tag;
        if (editTags.includes(t)) btn.classList.add("tag-button-active");
        else btn.classList.remove("tag-button-active");
      });
    }

    // ===== ã‚¯ã‚¤ãƒƒã‚¯ãƒœã‚¿ãƒ³ =====
    function setupQuickButtons() {
      const groups = document.querySelectorAll(".quick-row");
      groups.forEach((row) => {
        const targetId = row.dataset.target;
        const select = document.getElementById(targetId);
        if (!select) return;

        const buttons = row.querySelectorAll(".quick-btn");

        function syncFromSelect() {
          const val = select.value;
          buttons.forEach((btn) => {
            if (btn.dataset.value === val) btn.classList.add("quick-btn-active");
            else btn.classList.remove("quick-btn-active");
          });
        }

        buttons.forEach((btn) => {
          btn.addEventListener("click", () => {
            select.value = btn.dataset.value;
            syncFromSelect();
          });
        });

        select.addEventListener("change", syncFromSelect);
        syncFromSelect();
      });
    }

    function syncQuickButtonsAll() {
      const groups = document.querySelectorAll(".quick-row");
      groups.forEach((row) => {
        const targetId = row.dataset.target;
        const select = document.getElementById(targetId);
        if (!select) return;
        const buttons = row.querySelectorAll(".quick-btn");
        const val = select.value;
        buttons.forEach((btn) => {
          if (btn.dataset.value === val) btn.classList.add("quick-btn-active");
          else btn.classList.remove("quick-btn-active");
        });
      });
    }

    // ===== åˆ©ç”¨è€…ç®¡ç† =====
    function handleResidentAdd() {
      const nameInput = document.getElementById("residentNameInput");
      const name = nameInput.value.trim();
      if (!name) { alert("è¿½åŠ ã™ã‚‹åå‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚"); return; }
      if (residents.includes(name)) { alert("åŒã˜åå‰ã®åˆ©ç”¨è€…ãŒã™ã§ã«å­˜åœ¨ã—ã¾ã™ã€‚"); return; }
      residents.push(name);
      saveResidents();
      renderResidentSelects();
      renderRecorderSelects();
      renderAllResidentScopedUIs();
      nameInput.value = "";
      alert("åˆ©ç”¨è€…ã‚’è¿½åŠ ã—ã¾ã—ãŸã€‚");
    }

    function handleResidentRename() {
      const manageSelect = document.getElementById("residentManageSelect");
      const oldName = manageSelect.value;
      const nameInput = document.getElementById("residentNameInput");
      const newName = nameInput.value.trim();

      if (!oldName) { alert("å¤‰æ›´ã™ã‚‹åˆ©ç”¨è€…ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚"); return; }
      if (!newName) { alert("æ–°ã—ã„åå‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚"); return; }
      if (oldName === newName) { alert("åŒã˜åå‰ã§ã™ã€‚"); return; }

      if (residents.includes(newName)) {
        const ok = confirm("åŒã˜åå‰ã®åˆ©ç”¨è€…ãŒã™ã§ã«å­˜åœ¨ã—ã¾ã™ã€‚çµ±åˆã—ã¾ã™ã‹ï¼Ÿ");
        if (!ok) return;
      }

      // residents / records
      residents = residents.map((n) => (n === oldName ? newName : n));
      records = records.map((r) => (r.resident === oldName ? { ...r, resident: newName } : r));

      // åˆ©ç”¨è€…åˆ¥ãƒ‡ãƒ¼ã‚¿ã‚‚å¼•ãç¶™ã
      if (favByResident[oldName] && !favByResident[newName]) favByResident[newName] = favByResident[oldName];
      delete favByResident[oldName];
      saveFavByResident();

      if (residentAutoTemplates[oldName] && !residentAutoTemplates[newName]) residentAutoTemplates[newName] = residentAutoTemplates[oldName];
      delete residentAutoTemplates[oldName];
      saveResidentAutoTemplates();

      if (daySupportByResident[oldName] && !daySupportByResident[newName]) daySupportByResident[newName] = daySupportByResident[oldName];
      delete daySupportByResident[oldName];
      saveDaySupportByResident();

      saveResidents();
      saveRecords();
      renderResidentSelects();
      renderRecorderSelects();
      renderRecords();
      renderAllResidentScopedUIs();

      nameInput.value = "";
      alert("åˆ©ç”¨è€…åã‚’å¤‰æ›´ã—ã¾ã—ãŸã€‚");
    }

    function handleResidentDelete() {
      const manageSelect = document.getElementById("residentManageSelect");
      const target = manageSelect.value;
      if (!target) { alert("å‰Šé™¤ã™ã‚‹åˆ©ç”¨è€…ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚"); return; }

      const ok = confirm(target + " ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ\nã“ã®åˆ©ç”¨è€…ã®ã™ã¹ã¦ã®è¨˜éŒ²ã‚‚å‰Šé™¤ã•ã‚Œã¾ã™ã€‚");
      if (!ok) return;

      residents = residents.filter((n) => n !== target);
      records = records.filter((r) => r.resident !== target);

      // åˆ©ç”¨è€…åˆ¥ãƒ‡ãƒ¼ã‚¿ã‚‚å‰Šé™¤
      delete favByResident[target];
      delete residentAutoTemplates[target];
      delete daySupportByResident[target];
      saveFavByResident();
      saveResidentAutoTemplates();
      saveDaySupportByResident();

      saveResidents();
      saveRecords();
      renderResidentSelects();
      renderRecorderSelects();
      renderRecords();
      renderAllResidentScopedUIs();

      document.getElementById("residentNameInput").value = "";
      alert("å‰Šé™¤ã—ã¾ã—ãŸã€‚");
    }



    // ===== è¨˜éŒ²è€…ç®¡ç† =====
    function handleRecorderAdd() {
      const nameInput = document.getElementById("recorderNameInput");
      const name = (nameInput?.value || "").trim();
      if (!name) { alert("è¿½åŠ ã™ã‚‹åå‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚"); return; }
      if ((recorders || []).includes(name)) { alert("åŒã˜åå‰ã®è¨˜éŒ²è€…ãŒã™ã§ã«å­˜åœ¨ã—ã¾ã™ã€‚"); return; }
      recorders.push(name);
      saveRecorders();
      renderRecorderSelects();
      if (nameInput) nameInput.value = "";
      alert("è¨˜éŒ²è€…ã‚’è¿½åŠ ã—ã¾ã—ãŸã€‚");
    }

    function handleRecorderRename() {
      const manageSelect = document.getElementById("recorderManageSelect");
      const oldName = manageSelect?.value || "";
      const nameInput = document.getElementById("recorderNameInput");
      const newName = (nameInput?.value || "").trim();

      if (!oldName) { alert("å¤‰æ›´ã™ã‚‹è¨˜éŒ²è€…ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚"); return; }
      if (!newName) { alert("æ–°ã—ã„åå‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚"); return; }
      if (oldName === newName) { alert("åŒã˜åå‰ã§ã™ã€‚"); return; }

      if ((recorders || []).includes(newName)) {
        const ok = confirm("åŒã˜åå‰ã®è¨˜éŒ²è€…ãŒã™ã§ã«å­˜åœ¨ã—ã¾ã™ã€‚çµ±åˆã—ã¾ã™ã‹ï¼Ÿ");
        if (!ok) return;
      }

      // å€™è£œãƒªã‚¹ãƒˆ
      recorders = (recorders || []).map((n) => (n === oldName ? newName : n));
      // è¨˜éŒ²ãƒ‡ãƒ¼ã‚¿ï¼ˆéå»åˆ†ã‚‚ç½®æ›ï¼‰
      records = (records || []).map((r) => (r.recorder === oldName ? { ...r, recorder: newName } : r));

      saveRecorders();
      saveRecords();
      renderRecorderSelects();
      renderRecords();

      if (nameInput) nameInput.value = "";
      alert("è¨˜éŒ²è€…åã‚’å¤‰æ›´ã—ã¾ã—ãŸã€‚");
    }

    function handleRecorderDelete() {
      const manageSelect = document.getElementById("recorderManageSelect");
      const target = manageSelect?.value || "";
      if (!target) { alert("å‰Šé™¤ã™ã‚‹è¨˜éŒ²è€…ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚"); return; }

      const ok = confirm(target + " ã‚’å€™è£œã‹ã‚‰å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ\nâ€»éå»ã®è¨˜éŒ²ãƒ‡ãƒ¼ã‚¿ã¯æ¶ˆãˆã¾ã›ã‚“ã€‚\nï¼ˆç·¨é›†æ™‚ã¯ãã®è¨˜éŒ²ã®è¨˜éŒ²è€…åã‚‚ä¿æŒã•ã‚Œã¾ã™ï¼‰");
      if (!ok) return;

      recorders = (recorders || []).filter((n) => n !== target);
      saveRecorders();
      renderRecorderSelects();

      const nameInput = document.getElementById("recorderNameInput");
      if (nameInput) nameInput.value = "";
      alert("å‰Šé™¤ã—ã¾ã—ãŸã€‚");
    }
    // ===== å…±é€šãƒ†ãƒ³ãƒ—ãƒ¬ï¼ˆscopeï¼‰ =====
    function renderTemplateSelect() {
      const select = document.getElementById("templateSelect");
      const scopeSelect = document.getElementById("templateScope");
      if (!select || !scopeSelect) return;

      const currentScope = scopeSelect.value || "common";
      const currentScopeNorm = (currentScope === "med_manage" || currentScope === "oral_check") ? "med_combo" : currentScope;

      select.innerHTML = "";
      const placeholder = document.createElement("option");
      placeholder.value = "";
      placeholder.textContent = "é¸æŠã—ã¦ãã ã•ã„";
      select.appendChild(placeholder);

      templates.forEach((tpl, index) => {
        const scope = tpl.scope || "common";
        const scopeNorm = (scope === "med_manage" || scope === "oral_check") ? "med_combo" : scope;
        if (scopeNorm !== currentScopeNorm) return;
        const opt = document.createElement("option");
        opt.value = String(index);
        opt.textContent = tpl.name;
        select.appendChild(opt);
      });
    }

    function handleTemplateApply() {
      const select = document.getElementById("templateSelect");
      const idxStr = select.value;
      if (!idxStr) { alert("æŒ¿å…¥ã™ã‚‹ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚"); return; }
      const idx = parseInt(idxStr, 10);
      const tpl = templates[idx];
      if (!tpl) { alert("ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚"); return; }
      const support = document.getElementById("support");

      if (support.value.trim()) support.value = support.value.replace(/\s*$/, "") + "\n" + tpl.text;
      else support.value = tpl.text;
    }

    function handleTemplateSave() {
      const nameInput = document.getElementById("templateNameInput");
      const name = nameInput.value.trim();
      if (!name) { alert("ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆåã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚"); return; }

      const scopeSelect = document.getElementById("templateScope");
      const scope = scopeSelect ? (scopeSelect.value || "common") : "common";

      const support = document.getElementById("support");
      const text = support.value;

      if (!text.trim()) {
        const ok = confirm("ã€æœ¬æ—¥ã®æ”¯æ´å†…å®¹ (è·å“¡å´)ã€ãŒç©ºã§ã™ãŒã€ã“ã®ã¾ã¾ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã¨ã—ã¦ä¿å­˜ã—ã¾ã™ã‹ï¼Ÿ");
        if (!ok) return;
      }

      const existingIndex = templates.findIndex((t) => t.name === name && (t.scope || "common") === scope);

      let targetIndex;
      if (existingIndex >= 0) {
        const ok = confirm("åŒã˜åå‰ãƒ»å¯¾è±¡é …ç›®ã®ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆãŒã‚ã‚Šã¾ã™ã€‚ä¸Šæ›¸ãã—ã¾ã™ã‹ï¼Ÿ");
        if (!ok) return;
        templates[existingIndex].text = text;
        targetIndex = existingIndex;
      } else {
        templates.push({ name, text, scope });
        targetIndex = templates.length - 1;
      }

      saveTemplates();
      renderTemplateSelect();

      const select = document.getElementById("templateSelect");
      if (select) select.value = String(targetIndex);

      alert("ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’ä¿å­˜ã—ã¾ã—ãŸã€‚ï¼ˆãƒ—ãƒ«ãƒ€ã‚¦ãƒ³ã«é¸æŠã•ã‚Œã¾ã—ãŸï¼‰");
    }

    function handleTemplateDelete() {
      const select = document.getElementById("templateSelect");
      const idxStr = select.value;
      if (!idxStr) { alert("å‰Šé™¤ã™ã‚‹ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚"); return; }
      const idx = parseInt(idxStr, 10);
      const tpl = templates[idx];
      if (!tpl) { alert("ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚"); return; }
      const ok = confirm(`ã€Œ${tpl.name}ã€ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ`);
      if (!ok) return;

      templates.splice(idx, 1);
      saveTemplates();
      renderTemplateSelect();
      alert("ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’å‰Šé™¤ã—ã¾ã—ãŸã€‚");
    }

    // ===== è‡ªå‹•å…¥åŠ›é …ç›®ãƒã‚§ãƒƒã‚¯æ¬„ =====
        // ===== è‡ªå‹•å…¥åŠ›é …ç›®ãƒã‚§ãƒƒã‚¯æ¬„ =====
    function renderAutoItemCheckboxes() {
      const wrap = document.getElementById("autoItemCheckboxes");
      if (!wrap) return;

      wrap.innerHTML = "";
      AUTO_ITEM_DEFS.forEach((def) => {
        // å…¥æµ´ã ã‘ï¼šè¤‡åˆãƒã‚§ãƒƒã‚¯ï¼ˆå£°ã‹ã‘/è¦‹å®ˆã‚Š/ä»‹åŠ©ï¼‰
        if (def.key === "bathing") {
          const box = document.createElement("div");
          box.className = "auto-compound";
          box.innerHTML = `
            <label><input type="checkbox" class="auto-item" value="bathing"> ${escapeHtml(def.label || "å…¥æµ´å¯¾å¿œ")}</label>
            <span class="auto-compound-sub">
              <label><input type="checkbox" class="auto-bath-sub" data-sub="prompt" data-label="å£°ã‹ã‘">å£°ã‹ã‘</label>
              <label><input type="checkbox" class="auto-bath-sub" data-sub="watch" data-label="è¦‹å®ˆã‚Š">è¦‹å®ˆã‚Š</label>
              <label><input type="checkbox" class="auto-bath-sub" data-sub="assist" data-label="ä»‹åŠ©">ä»‹åŠ©</label>
            </span>
          `;
          wrap.appendChild(box);
          return;
        }

        // ä½“èª¿ç®¡ç†ï¼šè¤‡åˆãƒã‚§ãƒƒã‚¯ï¼ˆè¡€åœ§/ä½“é‡/æ¤œæ¸©/ç—‡çŠ¶ç¢ºèª/å®‰é™è¦‹å®ˆã‚Šï¼‰
        if (def.key === "health") {
          const box = document.createElement("div");
          box.className = "auto-compound";
          box.innerHTML = `
            <label><input type="checkbox" class="auto-item" value="health"> ${escapeHtml(def.label || "ä½“èª¿ç®¡ç†")}</label>
            <span class="auto-compound-sub">
              <label><input type="checkbox" class="auto-health-sub" data-sub="bp" data-label="è¡€åœ§">è¡€åœ§</label>
              <label><input type="checkbox" class="auto-health-sub" data-sub="wt" data-label="ä½“é‡">ä½“é‡</label>
              <label><input type="checkbox" class="auto-health-sub" data-sub="temp" data-label="æ¤œæ¸©">æ¤œæ¸©</label>
              <label><input type="checkbox" class="auto-health-sub" data-sub="symp" data-label="ç—‡çŠ¶ç¢ºèª">ç—‡çŠ¶ç¢ºèª</label>
              <label><input type="checkbox" class="auto-health-sub" data-sub="rest" data-label="å®‰é™è¦‹å®ˆã‚Š">å®‰é™è¦‹å®ˆã‚Š</label>
            </span>
          `;
          wrap.appendChild(box);
          return;
        }

        const label = document.createElement("label");
        label.innerHTML = `<input type="checkbox" class="auto-item" value="${def.key}"> ${escapeHtml(def.label)}`;
        wrap.appendChild(label);
      });

      setupAutoBathCompound();
      setupAutoHealthCompound();
      // â‘¡ã®ãƒã‚§ãƒƒã‚¯æ“ä½œã ã‘ã§ã€Œæœ¬æ—¥ã®æ”¯æ´å†…å®¹ã€ã‚’å¸¸ã«æœ€æ–°ã«ã™ã‚‹ï¼ˆãƒœã‚¿ãƒ³ç„¡ã—ã®å®Œå…¨è‡ªå‹•ï¼‰
      setupAutoSupportAutoSync();
      syncAutoItemsToSupport();
    }

    // å…¥æµ´ï¼ˆâ‘¡ è‡ªå‹•å…¥åŠ›ï¼‰è¤‡åˆãƒã‚§ãƒƒã‚¯ï¼šè¦ªOFFãªã‚‰ã‚µãƒ–ç„¡åŠ¹ï¼†OFFï¼ã‚µãƒ–ONãªã‚‰è¦ªON
        // å…¥æµ´ï¼ˆâ‘¡ è‡ªå‹•å…¥åŠ›ï¼‰è¤‡åˆãƒã‚§ãƒƒã‚¯ï¼šè¦ªOFFãªã‚‰ã‚µãƒ–ç„¡åŠ¹ï¼†OFFï¼ã‚µãƒ–ONãªã‚‰è¦ªON
    function setupAutoBathCompound() {
      const wrap = document.getElementById("autoItemCheckboxes");
      if (!wrap) return;

      const parent = wrap.querySelector('.auto-item[value="bathing"]');
      const subs = Array.from(wrap.querySelectorAll('.auto-bath-sub'));
      if (!parent || subs.length === 0) return;

      const sync = () => {
        const on = !!parent.checked;
        subs.forEach((cb) => {
          cb.disabled = !on;
          const lbl = cb.closest("label");
          if (lbl) lbl.style.opacity = on ? "1" : "0.55";
          if (!on) cb.checked = false;
        });
      };

      // æ—¢ã«é…ç·šæ¸ˆã¿ãªã‚‰çŠ¶æ…‹åŒæœŸã ã‘
      if (parent.dataset.wired === "1") {
        sync();
        return;
      }
      parent.dataset.wired = "1";

      parent.addEventListener("change", sync);
      subs.forEach((cb) => {
        cb.addEventListener("change", () => {
          if (cb.checked && !parent.checked) parent.checked = true;
          sync();
        });
      });

      sync();
    }



    // ä½“èª¿ç®¡ç†ï¼ˆâ‘¡ è‡ªå‹•å…¥åŠ›ï¼‰è¤‡åˆãƒã‚§ãƒƒã‚¯ï¼šè¦ªOFFãªã‚‰ã‚µãƒ–ç„¡åŠ¹ï¼†OFFï¼ã‚µãƒ–ONãªã‚‰è¦ªON
    function setupAutoHealthCompound() {
      const wrap = document.getElementById("autoItemCheckboxes");
      if (!wrap) return;

      const parent = wrap.querySelector('.auto-item[value="health"]');
      const subs = Array.from(wrap.querySelectorAll('.auto-health-sub'));
      if (!parent || subs.length === 0) return;

      const sync = () => {
        const on = !!parent.checked;
        subs.forEach((cb) => {
          cb.disabled = !on;
          const lbl = cb.closest("label");
          if (lbl) lbl.style.opacity = on ? "1" : "0.55";
          if (!on) cb.checked = false;
        });
      };

      if (parent.dataset.wired === "1") { sync(); return; }
      parent.dataset.wired = "1";

      parent.addEventListener("change", sync);
      subs.forEach((cb) => {
        cb.addEventListener("change", () => {
          if (cb.checked && !parent.checked) parent.checked = true;
          sync();
        });
      });

      sync();
    }

function buildAutoBathSentence() {
      const wrap = document.getElementById("autoItemCheckboxes");
      if (!wrap) return "";

      const parent = wrap.querySelector('.auto-item[value="bathing"]');
      if (!parent || !parent.checked) return "";

      const subs = Array.from(wrap.querySelectorAll('.auto-bath-sub'));
      let picked = subs.filter((cb) => cb.checked).map((cb) => cb.dataset.label || "");

      if (picked.length === 0) {
        const prompt = wrap.querySelector('.auto-bath-sub[data-sub="prompt"]');
        if (prompt) {
          prompt.checked = true;
          picked = [prompt.dataset.label || "å£°ã‹ã‘"];
        }
      }

      return `å…¥æµ´å¯¾å¿œï¼š${picked.join("ãƒ»")}ã‚’å®Ÿæ–½ã€‚`;
    }




    function buildAutoHealthSentence() {
      const wrap = document.getElementById("autoItemCheckboxes");
      if (!wrap) return "";

      const parent = wrap.querySelector('.auto-item[value="health"]');
      if (!parent || !parent.checked) return "";

      const subs = Array.from(wrap.querySelectorAll('.auto-health-sub'));
      const picked = subs.filter((cb) => cb.checked).map((cb) => cb.dataset.label || "").filter(Boolean);

      return picked.length ? `ä½“èª¿ç®¡ç†ï¼š${picked.join("ãƒ»")}ã‚’å®Ÿæ–½ã€‚` : "ä½“èª¿ç®¡ç†ã‚’å®Ÿæ–½ã€‚";
    }

    // ===== â‘¡ è‡ªå‹•å…¥åŠ›ï¼ˆæ”¯æ´é …ç›®ï¼‰â†’ æœ¬æ—¥ã®æ”¯æ´å†…å®¹ã¸å®Œå…¨è‡ªå‹•åæ˜  =====
    // â€»è¡¨ç¤ºç”¨ãƒ†ã‚­ã‚¹ãƒˆã«ã€â‘¡ è‡ªå‹•å…¥åŠ›ã€‘/ã€/â‘¡ è‡ªå‹•å…¥åŠ›ã€‘ã‚’å‡ºã•ãªã„ã‚ˆã†ã€ä¸å¯è¦–ã‚¿ã‚°ã§å†…éƒ¨ç®¡ç†ã—ã¾ã™
    const LEGACY_AUTO_SUPPORT_BLOCK_START = "ã€â‘¡ è‡ªå‹•å…¥åŠ›ã€‘";
    const LEGACY_AUTO_SUPPORT_BLOCK_END   = "ã€/â‘¡ è‡ªå‹•å…¥åŠ›ã€‘";
    const AUTO_SUPPORT_BLOCK_START = "\u200B"; // zero-width space
    const AUTO_SUPPORT_BLOCK_END   = "\u200C"; // zero-width non-joiner

    function hasAutoSupportBlock(text) {
      if (typeof text !== "string") return false;
      const s = text.indexOf(AUTO_SUPPORT_BLOCK_START);
      const e = text.indexOf(AUTO_SUPPORT_BLOCK_END);
      return s !== -1 && e !== -1 && e > s;
    }

    function buildAutoItemsTextForSupport() {
      const checkedKeys = Array.from(document.querySelectorAll(".auto-item:checked")).map((el) => el.value);
      if (!checkedKeys.length) return "";

      const daySupportType = document.getElementById("daySupportType")?.value || "";
      const daySupportTypeLabel = daySupportType ? ("æ—¥ä¸­æ”¯æ´åŠ ç®—" + daySupportType) : "æ—¥ä¸­æ”¯æ´åŠ ç®—";

      const lines = [];
      checkedKeys.forEach((key) => {
        if (key === "bathing") {
          const t = buildAutoBathSentence();
          if (t) lines.push(t);
          return;
        }
        if (key === "health") {
          const t = buildAutoHealthSentence();
          if (t) lines.push(t);
          return;
        }
        const def = AUTO_ITEM_DEFS.find((d) => d.key === key);
        if (!def) return;
        let text = (def.defaultText || "").trim();
        if (!text) return;
        text = text.replaceAll("{{daySupportTypeLabel}}", daySupportTypeLabel);
        lines.push(text);
      });
      return lines.join("\n").trim();
    }

    function upsertAutoSupportBlock(currentText, innerText) {
      const full = String(currentText || "");
      const inner = String(innerText || "").trim();

      const s = full.indexOf(AUTO_SUPPORT_BLOCK_START);
      const e = full.indexOf(AUTO_SUPPORT_BLOCK_END);

      // æ—¢å­˜ãƒ–ãƒ­ãƒƒã‚¯ãŒã‚ã‚‹
      if (s !== -1 && e !== -1 && e > s) {
        const before = full.slice(0, s).replace(/\s*$/, "");
        const after  = full.slice(e + AUTO_SUPPORT_BLOCK_END.length).replace(/^\s*/, "");

        if (!inner) {
          // ãƒ–ãƒ­ãƒƒã‚¯å‰Šé™¤
          if (before && after) return (before + "\n" + after).trimEnd();
          return (before || after || "").trimEnd();
        }

        const block = `${AUTO_SUPPORT_BLOCK_START}${inner}${AUTO_SUPPORT_BLOCK_END}`;
        let out = before ? (before + "\n\n" + block) : block;
        if (after) out = out + "\n\n" + after;
        return out.trimEnd();
      }

      // æ—¢å­˜ãƒ–ãƒ­ãƒƒã‚¯ãªã— â†’ è¿½è¨˜
      if (!inner) return full;
      const block = `${AUTO_SUPPORT_BLOCK_START}${inner}${AUTO_SUPPORT_BLOCK_END}`;
      if (full.trim()) return full.replace(/\s*$/, "") + "\n\n" + block;
      return block;
    }

    function syncAutoItemsToSupport() {
      const textArea = document.getElementById("support");
      if (!textArea) return;

      // æ—§ç‰ˆã®å¯è¦–ã‚¿ã‚°ï¼ˆã€â‘¡ è‡ªå‹•å…¥åŠ›ã€‘/ã€/â‘¡ è‡ªå‹•å…¥åŠ›ã€‘ï¼‰ãŒæ®‹ã£ã¦ã„ã‚‹å ´åˆã¯ä¸å¯è¦–ã‚¿ã‚°ã¸ç½®æ›
      textArea.value = String(textArea.value || "")
        .replaceAll(LEGACY_AUTO_SUPPORT_BLOCK_START, AUTO_SUPPORT_BLOCK_START)
        .replaceAll(LEGACY_AUTO_SUPPORT_BLOCK_END, AUTO_SUPPORT_BLOCK_END);

      const inner = buildAutoItemsTextForSupport();
      textArea.value = upsertAutoSupportBlock(textArea.value, inner);
    }

    function setupAutoSupportAutoSync() {
      const wrap = document.getElementById("autoItemCheckboxes");
      if (wrap && wrap.dataset.autoSupportWired !== "1") {
        wrap.dataset.autoSupportWired = "1";
        wrap.addEventListener("change", (e) => {
          const t = e?.target;
          if (!t || !t.classList) return;
          if (t.classList.contains("auto-item") || t.classList.contains("auto-bath-sub") || t.classList.contains("auto-health-sub")) {
            syncAutoItemsToSupport();
          }
        });
      }

      const ds = document.getElementById("daySupportType");
      if (ds && ds.dataset.autoSupportWired !== "1") {
        ds.dataset.autoSupportWired = "1";
        ds.addEventListener("change", syncAutoItemsToSupport);
      }
    }


    // ===== æ—¥ä¸­æ´»å‹•ï¼ˆãƒ•ã‚©ãƒ¼ãƒ ï¼‰ãƒã‚§ãƒƒã‚¯ç”Ÿæˆ =====
    function renderDayActivityCheckboxes() {
      const wrap = document.getElementById("dayActivityCheckboxes");
      if (!wrap) return;
      wrap.innerHTML = "";

      const conflict = {
        "Aå‹äº‹æ¥­æ‰€é€šæ‰€": "Aå‹äº‹æ¥­æ‰€æ¬ å¸­",
        "Aå‹äº‹æ¥­æ‰€æ¬ å¸­": "Aå‹äº‹æ¥­æ‰€é€šæ‰€",
        "Bå‹äº‹æ¥­æ‰€é€šæ‰€": "Bå‹äº‹æ¥­æ‰€æ¬ å¸­",
        "Bå‹äº‹æ¥­æ‰€æ¬ å¸­": "Bå‹äº‹æ¥­æ‰€é€šæ‰€",
      };

      DAY_ACTIVITY_LIST.forEach((text) => {
        const label = document.createElement("label");
        label.innerHTML = `<input type="checkbox" class="day-activity-item" value="${escapeHtmlAttr(text)}"> ${escapeHtml(text)}`;
        wrap.appendChild(label);
      });

      // åŒä¸€äº‹æ¥­æ‰€ã®ã€Œé€šæ‰€ã€ã¨ã€Œæ¬ å¸­ã€ã¯åŒæ™‚ã«ãƒã‚§ãƒƒã‚¯ã§ããªã„ã‚ˆã†ã«ã™ã‚‹ï¼ˆçŸ›ç›¾é˜²æ­¢ï¼‰
      wrap.querySelectorAll(".day-activity-item").forEach((cb) => {
        cb.addEventListener("change", () => {
          if (!cb.checked) return;
          const other = conflict[cb.value];
          if (!other) return;
          const otherCb = wrap.querySelector(`.day-activity-item[value="${CSS.escape(other)}"]`);
          if (otherCb) otherCb.checked = false;
        });
      });
    }

    // ===== æ—¥ä¸­æ”¯æ´ï¼ˆãƒ•ã‚©ãƒ¼ãƒ ï¼‰ãƒã‚§ãƒƒã‚¯ç”Ÿæˆ =====
    function renderDaySupportMainCheckboxes() {
      const wrap = document.getElementById("daySupportMainCheckboxes");
      wrap.innerHTML = "";

      DAY_SUPPORT_MAIN_LIST.forEach((text) => {
        if (isBathingMainItemText(text)) {
          const holder = document.createElement("div");
          holder.innerHTML = makeBathingCompositeHTML("main");
          wrap.appendChild(holder.firstElementChild);
          return;
        }
        if (isHealthMainItemText(text)) {
          const holder = document.createElement("div");
          holder.innerHTML = makeHealthCompositeHTML("main");
          wrap.appendChild(holder.firstElementChild);
          return;
        }

        const label = document.createElement("label");
        label.innerHTML = `<input type="checkbox" class="day-main-item" value="${escapeHtmlAttr(text)}"> ${escapeHtml(text)}`;
        wrap.appendChild(label);
      });

      bindBathingCompositeHandlersOnce("daySupportMainCheckboxes", "main");
      syncBathingCompositeInWrap(wrap, "main");

      bindHealthCompositeHandlersOnce("daySupportMainCheckboxes", "main");
      syncHealthCompositeInWrap(wrap, "main");

      // ãƒã‚§ãƒƒã‚¯å¤‰æ›´ã§è‡ªå‹•è¿½è¨˜ï¼ˆæ¥­å‹™æ—¥èªŒï¼‰
      wrap.querySelectorAll("input[type=checkbox]").forEach((el) => {
        el.addEventListener("change", () => {
          updateAutoNoteMain();
        });
      });
    }

    function renderDaySupportReasonCheckboxes() {
      const wrap = document.getElementById("daySupportReasonCheckboxes");
      if (!wrap) return;
      wrap.innerHTML = "";
      DAY_SUPPORT_REASON_LIST.forEach((text) => {
        const label = document.createElement("label");
        label.innerHTML = `<input type="checkbox" class="day-reason-item" value="${escapeHtmlAttr(text)}"> ${escapeHtml(text)}`;
        wrap.appendChild(label);
      });
    }

    // ===== æ—¥ä¸­æ´»å‹• / æ¬ å¸­ç†ç”± â†’ æ¥­å‹™æ—¥èªŒæ¬„ã¸è‡ªå‹•åæ˜  =====
    const AUTO_NOTE_ACTIVITY_PREFIX = "æ—¥ä¸­æ´»å‹•ï¼š";
    const AUTO_NOTE_REASON_PREFIX   = "æ¬ å¸­ç†ç”±ï¼š";
    const AUTO_NOTE_REASON_PREFIX_OLD = "ã€æ—¥ä¸­æ´»å‹•ã«è¡Œã‘ãªã‹ã£ãŸç†ç”±ã€‘ï¼š";
    const AUTO_NOTE_VITAL_PREFIX    = "ãƒã‚¤ã‚¿ãƒ«ï¼š";
    const AUTO_NOTE_VITAL_PREFIX_OLD = "ç•°å¸¸æ™‚ãƒã‚¤ã‚¿ãƒ«ï¼š";
    const AUTO_NOTE_HEADER        = "â–¼è‡ªå‹•å…¥åŠ›ï¼ˆãƒã‚§ãƒƒã‚¯é€£å‹•ï¼‰";
    const AUTO_NOTE_SEPARATOR     = "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€";
    const AUTO_NOTE_MANUAL_HEADER = "â–¼è·å“¡ãƒ¡ãƒ¢ï¼ˆã“ã“ã‹ã‚‰æ‰‹å…¥åŠ›ï¼‰";

    function stripAutoNoteLines(raw) {
      const lines = (raw || "").split(/\r?\n/);
      const filtered = lines.filter((l) => {
        return !l.startsWith(AUTO_NOTE_ACTIVITY_PREFIX)
          && !l.startsWith(AUTO_NOTE_REASON_PREFIX)
          && !l.startsWith(AUTO_NOTE_REASON_PREFIX_OLD)
          && !l.startsWith(AUTO_NOTE_VITAL_PREFIX)
          && !l.startsWith(AUTO_NOTE_VITAL_PREFIX_OLD)
          && l.trim() !== AUTO_NOTE_HEADER
          && l.trim() !== AUTO_NOTE_SEPARATOR
          && l.trim() !== AUTO_NOTE_MANUAL_HEADER;
      });
      // å…ˆé ­ã®ç©ºè¡Œã‚’å‰Šã‚‹ï¼ˆè¦‹ãŸç›®ã‚’æ•´ãˆã‚‹ï¼‰
      while (filtered.length && filtered[0].trim() === "") filtered.shift();
      return filtered.join("\n");
    }

    function applyAutoNoteLines(textarea, activityArr, reasonArr, vitalObj) {
      if (!textarea) return;

      const userText = stripAutoNoteLines(textarea.value);

      const autoLines = [];
      if (Array.isArray(activityArr) && activityArr.length) {
        autoLines.push(AUTO_NOTE_ACTIVITY_PREFIX + " " + activityArr.join(" / "));
      }
      if (Array.isArray(reasonArr) && reasonArr.length) {
        // ä¾‹ï¼šæ¬ å¸­ç†ç”±ï¼šä½“èª¿ä¸è‰¯ / é€šæ‰€å…ˆãƒ»å°±åŠ´å…ˆãŒä¼‘ã¿ï¼è‡¨æ™‚ä¼‘æ¥­ã®ãŸã‚åœ¨å®…
        autoLines.push(AUTO_NOTE_REASON_PREFIX + reasonArr.join(" / "));
      }
      if (vitalObj) {
        const w = (vitalObj.weight || "").toString().trim();
        const sys = (vitalObj.bpSys || "").toString().trim();
        const dia = (vitalObj.bpDia || "").toString().trim();
        const p = (vitalObj.pulse || "").toString().trim();
        if (w || sys || dia || p) {
          const parts = [];
          if (w) parts.push(`ä½“é‡ ${w}kg`);
          if (sys && dia) parts.push(`è¡€åœ§ ${sys}/${dia}mmHg`);
          else if (sys) parts.push(`è¡€åœ§ ä¸Š${sys}mmHg`);
          else if (dia) parts.push(`è¡€åœ§ ä¸‹${dia}mmHg`);
          if (p) parts.push(`è„ˆæ‹ ${p}å›/åˆ†`);
          autoLines.push(AUTO_NOTE_VITAL_PREFIX + " " + parts.join("ã€"));
        }
      }

      const cleanedUser = (userText || "").replace(/^\s+/, "");

      if (autoLines.length === 0) {
        textarea.value = cleanedUser;
      } else {
        let out = autoLines.join("\n");
        if (cleanedUser) out += "\n\n" + cleanedUser;
        else out += "\n";
        textarea.value = out;
      }
    }

    function syncAbnormalVitalsUI(scope) {
      const isEdit = (scope === "edit");
      const inputsWrap = document.getElementById(isEdit ? "editAbnormalVitalsInputs" : "abnormalVitalsInputs");
      if (!inputsWrap) return;
      // ã„ã¤ã§ã‚‚è¡¨ç¤ºï¼ˆãƒã‚§ãƒƒã‚¯å¼ã¯å»ƒæ­¢ï¼‰
      inputsWrap.style.display = "grid";
    }



    function updateAutoNoteMain() {
      const ta = document.getElementById("note");
      if (!ta) return;
      const activity = Array.from(document.querySelectorAll(".day-activity-item:checked")).map((x) => x.value);
      const reasons  = Array.from(document.querySelectorAll(".day-reason-item:checked")).map((x) => x.value);
      const vital = {
        weight: document.getElementById("abnormalWeight")?.value || "",
        bpSys: document.getElementById("abnormalBPsys")?.value || "",
        bpDia: document.getElementById("abnormalBPdia")?.value || "",
        pulse: document.getElementById("abnormalPulse")?.value || "",
      };
      applyAutoNoteLines(ta, activity, reasons, vital);
    }

    function setupAutoNoteMain() {
      const actWrap = document.getElementById("dayActivityCheckboxes");
      const reaWrap = document.getElementById("daySupportReasonCheckboxes");

      // ã‚¤ãƒ™ãƒ³ãƒˆå§”è­²ï¼ˆå†æç”»ã•ã‚Œã¦ã‚‚OKï¼‰
      if (actWrap) actWrap.addEventListener("change", (e) => {
        if (e?.target?.classList?.contains("day-activity-item")) updateAutoNoteMain();
      });
      if (reaWrap) reaWrap.addEventListener("change", (e) => {
        if (e?.target?.classList?.contains("day-reason-item")) updateAutoNoteMain();
      });

      // ãƒã‚¤ã‚¿ãƒ«ï¼ˆä½“é‡ãƒ»è¡€åœ§ãƒ»è„ˆæ‹ï¼‰
      const __vW  = document.getElementById("abnormalWeight");
      const __vS  = document.getElementById("abnormalBPsys");
      const __vD  = document.getElementById("abnormalBPdia");
      const __vP  = document.getElementById("abnormalPulse");
      [__vW, __vS, __vD, __vP].forEach((el) => {
        if (!el) return;
        el.addEventListener("input", () => { updateAutoNoteMain(); });
      });
      // åˆæœŸUIï¼ˆå¸¸æ™‚è¡¨ç¤ºï¼‰
      syncAbnormalVitalsUI("main");

      // åˆæœŸåæ˜ ï¼ˆä»Šã®ãƒã‚§ãƒƒã‚¯çŠ¶æ…‹ã‚’æ¥­å‹™æ—¥èªŒæ¬„ã¸ï¼‰
      updateAutoNoteMain();
    }

    function updateAutoNoteEdit() {
      const ta = document.getElementById("editNote");
      if (!ta) return;
      const activity = Array.from(document.querySelectorAll(".edit-day-activity-item:checked")).map((x) => x.value);
      const reasons  = Array.from(document.querySelectorAll(".edit-day-reason-item:checked")).map((x) => x.value);
      const vital = {
        weight: document.getElementById("editAbnormalWeight")?.value || "",
        bpSys: document.getElementById("editAbnormalBPsys")?.value || "",
        bpDia: document.getElementById("editAbnormalBPdia")?.value || "",
        pulse: document.getElementById("editAbnormalPulse")?.value || "",
      };
      applyAutoNoteLines(ta, activity, reasons, vital);
    }

    function setupAutoNoteEdit() {
      const actWrap = document.getElementById("editDayActivityCheckboxes");
      const reaWrap = document.getElementById("editDaySupportReasonCheckboxes");

      if (actWrap) actWrap.addEventListener("change", (e) => {
        if (e?.target?.classList?.contains("edit-day-activity-item")) updateAutoNoteEdit();
      });
      if (reaWrap) reaWrap.addEventListener("change", (e) => {
        if (e?.target?.classList?.contains("edit-day-reason-item")) updateAutoNoteEdit();
      });

      // ãƒã‚¤ã‚¿ãƒ«ï¼ˆä½“é‡ãƒ»è¡€åœ§ãƒ»è„ˆæ‹ï¼‰
      const __evW  = document.getElementById("editAbnormalWeight");
      const __evS  = document.getElementById("editAbnormalBPsys");
      const __evD  = document.getElementById("editAbnormalBPdia");
      const __evP  = document.getElementById("editAbnormalPulse");
      [__evW, __evS, __evD, __evP].forEach((el) => {
        if (!el) return;
        el.addEventListener("input", () => { updateAutoNoteEdit(); });
      });
      // åˆæœŸUIï¼ˆå¸¸æ™‚è¡¨ç¤ºï¼‰ã ã‘åæ˜ 
      syncAbnormalVitalsUI("edit");

      // â˜… ç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ«ã¯ã€Œé–‹ã„ãŸç¬é–“ã«å‹æ‰‹ã«æ›¸ãæ›ãˆãªã„ã€ãŸã‚ã€åˆå›åæ˜ ã¯ã—ãªã„
    }


    // ===== æ”¯æ´é …ç›®ç®¡ç†UI =====
    function renderAutoItemManager() {
      const sel = document.getElementById("autoItemSelect");
      const count = document.getElementById("autoItemCount");
      if (!sel) return;

      sel.innerHTML = `<option value="">ï¼ˆæ–°è¦è¿½åŠ ï¼‰</option>`;
      AUTO_ITEM_DEFS.forEach((d, i) => {
        const opt = document.createElement("option");
        opt.value = String(i);
        opt.textContent = `${d.label}ï¼ˆ${d.key}ï¼‰`;
        sel.appendChild(opt);
      });

      if (count) count.textContent = AUTO_ITEM_DEFS.length + "ä»¶";
    }

    function clearAutoItemInputs() {
      document.getElementById("autoItemSelect").value = "";
      document.getElementById("autoItemKey").value = "";
      document.getElementById("autoItemLabel").value = "";
      document.getElementById("autoItemText").value = "";
    }

    function fillAutoItemInputsBySelect() {
      const sel = document.getElementById("autoItemSelect");
      const idxStr = sel.value;
      if (!idxStr) {
        clearAutoItemInputs();
        return;
      }
      const idx = parseInt(idxStr, 10);
      const d = AUTO_ITEM_DEFS[idx];
      if (!d) return;

      document.getElementById("autoItemKey").value = d.key || "";
      document.getElementById("autoItemLabel").value = d.label || "";
      document.getElementById("autoItemText").value = d.defaultText || "";
    }

    function saveAutoItemFromInputs() {
      const sel = document.getElementById("autoItemSelect");
      const idxStr = sel.value;

      const key = document.getElementById("autoItemKey").value.trim();
      const label = document.getElementById("autoItemLabel").value.trim();
      const text = document.getElementById("autoItemText").value;

      if (!key) { alert("å†…éƒ¨ã‚­ãƒ¼ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ï¼ˆè‹±æ•°å­—ãƒ»é‡è¤‡ä¸å¯ï¼‰"); return; }
      if (!/^[a-zA-Z0-9_]+$/.test(key)) {
        alert("å†…éƒ¨ã‚­ãƒ¼ã¯è‹±æ•°å­—ã¨ _ ã®ã¿ã§å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚ä¾‹ï¼šmoney_support");
        return;
      }
      if (!label) { alert("è¡¨ç¤ºåã‚’å…¥åŠ›ã—ã¦ãã ã•ã„"); return; }
      if (!text.trim()) { alert("å®šå‹æ–‡ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„"); return; }

      const existsOther = AUTO_ITEM_DEFS.some((d, i) => d.key === key && String(i) !== idxStr);
      if (existsOther) {
        alert("åŒã˜å†…éƒ¨ã‚­ãƒ¼ãŒã™ã§ã«å­˜åœ¨ã—ã¾ã™ã€‚åˆ¥ã®ã‚­ãƒ¼ã«ã—ã¦ãã ã•ã„ã€‚");
        return;
      }

      if (idxStr) {
        const idx = parseInt(idxStr, 10);
        if (!AUTO_ITEM_DEFS[idx]) return;
        AUTO_ITEM_DEFS[idx] = { key, label, defaultText: text };
      } else {
        AUTO_ITEM_DEFS.push({ key, label, defaultText: text });
      }

      saveAutoItemDefs();
      renderAutoItemCheckboxes();
      renderAutoItemManager();
      renderFavManager(); // åˆ©ç”¨è€…åˆ¥UIã‚‚æ›´æ–°
      alert("ä¿å­˜ã—ã¾ã—ãŸã€‚");
    }

    function deleteSelectedAutoItem() {
      const sel = document.getElementById("autoItemSelect");
      const idxStr = sel.value;
      if (!idxStr) { alert("å‰Šé™¤ã™ã‚‹é …ç›®ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚"); return; }

      const idx = parseInt(idxStr, 10);
      const d = AUTO_ITEM_DEFS[idx];
      if (!d) return;

      const ok = confirm(`ã€Œ${d.label}ï¼ˆ${d.key}ï¼‰ã€ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ`);
      if (!ok) return;

      AUTO_ITEM_DEFS.splice(idx, 1);
      saveAutoItemDefs();
      renderAutoItemCheckboxes();
      renderAutoItemManager();
      renderFavManager();
      clearAutoItemInputs();
      alert("å‰Šé™¤ã—ã¾ã—ãŸã€‚");
    }

    function resetAutoItemsToDefault() {
      const ok = confirm("è‡ªå‹•å…¥åŠ›ã®æ”¯æ´é …ç›®ã‚’åˆæœŸçŠ¶æ…‹ã«æˆ»ã—ã¾ã™ã‹ï¼Ÿï¼ˆä»Šè¿½åŠ ã—ãŸé …ç›®ã¯æ¶ˆãˆã¾ã™ï¼‰");
      if (!ok) return;
      AUTO_ITEM_DEFS = DEFAULT_AUTO_ITEM_DEFS.slice();
      saveAutoItemDefs();
      renderAutoItemCheckboxes();
      renderAutoItemManager();
      renderFavManager();
      clearAutoItemInputs();
      alert("åˆæœŸçŠ¶æ…‹ã«æˆ»ã—ã¾ã—ãŸã€‚");
    }

    // ===== ã‚¿ã‚°ç®¡ç†ï¼ˆè¿½åŠ ãƒ»ç·¨é›†ãƒ»å‰Šé™¤ï¼‰ =====
    function renderTagManager() {
      const sel = document.getElementById("tagSelect");
      const count = document.getElementById("tagCount");
      if (!sel) return;

      sel.innerHTML = `<option value="">ï¼ˆæ–°è¦è¿½åŠ ï¼‰</option>`;
      TAG_LIST.forEach((t, i) => {
        const opt = document.createElement("option");
        opt.value = String(i);
        opt.textContent = t;
        sel.appendChild(opt);
      });

      if (count) count.textContent = TAG_LIST.length + "ä»¶";
    }

    function clearTagInputs() {
      document.getElementById("tagSelect").value = "";
      document.getElementById("tagNameInput").value = "";
    }

    function fillTagInputBySelect() {
      const sel = document.getElementById("tagSelect");
      const idxStr = sel.value;
      if (!idxStr) { clearTagInputs(); return; }
      const idx = parseInt(idxStr, 10);
      const t = TAG_LIST[idx];
      if (!t) return;
      document.getElementById("tagNameInput").value = t;
    }

    function saveTagFromInputs() {
      const sel = document.getElementById("tagSelect");
      const idxStr = sel.value;

      let name = document.getElementById("tagNameInput").value.trim();
      name = name.replace(/^#/, "").trim();
      if (!name) { alert("ã‚¿ã‚°åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„"); return; }

      const existsOther = TAG_LIST.some((t, i) => t === name && String(i) !== idxStr);
      if (existsOther) { alert("åŒã˜ã‚¿ã‚°ãŒã™ã§ã«å­˜åœ¨ã—ã¾ã™ã€‚åˆ¥åã«ã—ã¦ãã ã•ã„ã€‚"); return; }

      if (idxStr) {
        const idx = parseInt(idxStr, 10);
        if (!TAG_LIST[idx]) return;
        TAG_LIST[idx] = name;
      } else {
        TAG_LIST.push(name);
      }

      saveTags();
      setupTagButtons();
      renderTagManager();
      renderEditTagButtons();
      alert("ä¿å­˜ã—ã¾ã—ãŸã€‚");
    }

    function deleteSelectedTag() {
      const sel = document.getElementById("tagSelect");
      const idxStr = sel.value;
      if (!idxStr) { alert("å‰Šé™¤ã™ã‚‹ã‚¿ã‚°ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚"); return; }
      const idx = parseInt(idxStr, 10);
      const t = TAG_LIST[idx];
      if (!t) return;

      const ok = confirm(`ã€Œ${t}ã€ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ`);
      if (!ok) return;

      currentTags = currentTags.filter((x) => x !== t);
      editTags = editTags.filter((x) => x !== t);

      TAG_LIST.splice(idx, 1);
      saveTags();
      setupTagButtons();
      renderTagManager();
      renderEditTagButtons();
      clearTagInputs();
      updateTagUI();
      updateEditTagUI();
      alert("å‰Šé™¤ã—ã¾ã—ãŸã€‚");
    }

    function resetTagsToDefault() {
      const ok = confirm("ã‚¿ã‚°ã‚’åˆæœŸçŠ¶æ…‹ã«æˆ»ã—ã¾ã™ã‹ï¼Ÿï¼ˆä»Šè¿½åŠ ã—ãŸã‚¿ã‚°ã¯æ¶ˆãˆã¾ã™ï¼‰");
      if (!ok) return;
      TAG_LIST = DEFAULT_TAG_LIST.slice();
      saveTags();
      setupTagButtons();
      renderTagManager();
      renderEditTagButtons();
      clearTagInputs();
      alert("åˆæœŸã‚¿ã‚°ã«æˆ»ã—ã¾ã—ãŸã€‚");
    }

    // ===== ã‚ˆãä½¿ã†é …ç›® ç®¡ç†ï¼ˆåˆ©ç”¨è€…åˆ¥ï¼‰ =====
    function renderFavManager() {
      const resSel = document.getElementById("favResidentSelect");
      const autoBox = document.getElementById("favAutoItemCheckboxes");
      const dayBox  = document.getElementById("favDaySupportMainCheckboxes");
      if (!resSel || !autoBox || !dayBox) return;

      populateResidentSelect(resSel);
      const resident = resSel.value || residents[0] || "";
      if (!resSel.value && resident) resSel.value = resident;

      const fav = getFavForResident(resident);
      const autoSet = new Set(fav.autoKeys || []);
      const daySet  = new Set(fav.dayMain || []);

      const savedAutoBathSubs = Array.isArray(fav.autoBathSubs) ? fav.autoBathSubs : [];
      const savedAutoHealthSubs = Array.isArray(fav.autoHealthSubs) ? fav.autoHealthSubs : [];
      const savedDayBathSubs = Array.isArray(fav.dayBathingSubs) ? fav.dayBathingSubs : [];
      const savedDayHealthSubs = Array.isArray(fav.dayHealthSubs) ? fav.dayHealthSubs : [];

      const setupCompound = (parent, subs, defaultSub) => {
        if (!parent || !subs || subs.length === 0) return;
        const sync = () => {
          const on = !!parent.checked;
          subs.forEach((cb) => {
            cb.disabled = !on;
            const lbl = cb.closest("label");
            if (lbl) lbl.style.opacity = on ? "1" : "0.55";
            if (!on) cb.checked = false;
          });
          if (on && !subs.some((cb) => cb.checked) && defaultSub) {
            const d = subs.find((cb) => (cb.dataset.sub || cb.value) === defaultSub);
            if (d) d.checked = true;
          }
        };

        parent.addEventListener("change", sync);
        subs.forEach((cb) => {
          cb.addEventListener("change", () => {
            if (cb.checked && !parent.checked) parent.checked = true;
            sync();
          });
        });

        sync();
      };

      // â‘¡ è‡ªå‹•å…¥åŠ›ï¼ˆæ”¯æ´é …ç›®ï¼‰
      autoBox.innerHTML = "";
      AUTO_ITEM_DEFS.forEach((def) => {
        if (def.key === "bathing") {
          const box = document.createElement("div");
          box.className = "auto-compound";
          box.innerHTML = `
            <label><input type="checkbox" class="fav-item" value="bathing"> ${escapeHtml(def.label || "å…¥æµ´å¯¾å¿œ")}</label>
            <span class="auto-compound-sub">
              <label><input type="checkbox" class="fav-auto-bath-sub" data-sub="prompt" data-label="å£°ã‹ã‘">å£°ã‹ã‘</label>
              <label><input type="checkbox" class="fav-auto-bath-sub" data-sub="watch" data-label="è¦‹å®ˆã‚Š">è¦‹å®ˆã‚Š</label>
              <label><input type="checkbox" class="fav-auto-bath-sub" data-sub="assist" data-label="ä»‹åŠ©">ä»‹åŠ©</label>
            </span>
          `;
          autoBox.appendChild(box);
          return;
        }
        if (def.key === "health") {
          const box = document.createElement("div");
          box.className = "auto-compound";
          box.innerHTML = `
            <label><input type="checkbox" class="fav-item" value="health"> ${escapeHtml(def.label || "ä½“èª¿ç®¡ç†")}</label>
            <span class="auto-compound-sub">
              <label><input type="checkbox" class="fav-auto-health-sub" data-sub="bp" data-label="è¡€åœ§">è¡€åœ§</label>
              <label><input type="checkbox" class="fav-auto-health-sub" data-sub="wt" data-label="ä½“é‡">ä½“é‡</label>
              <label><input type="checkbox" class="fav-auto-health-sub" data-sub="temp" data-label="æ¤œæ¸©">æ¤œæ¸©</label>
              <label><input type="checkbox" class="fav-auto-health-sub" data-sub="symp" data-label="ç—‡çŠ¶ç¢ºèª">ç—‡çŠ¶ç¢ºèª</label>
              <label><input type="checkbox" class="fav-auto-health-sub" data-sub="rest" data-label="å®‰é™è¦‹å®ˆã‚Š">å®‰é™è¦‹å®ˆã‚Š</label>
            </span>
          `;
          autoBox.appendChild(box);
          return;
        }
        const label = document.createElement("label");
        label.innerHTML = `<input type="checkbox" class="fav-item" value="${def.key}"> ${escapeHtml(def.label)}`;
        autoBox.appendChild(label);
      });

      autoBox.querySelectorAll(".fav-item").forEach((cb) => {
        cb.checked = autoSet.has(cb.value);
      });

      // â‘¡ã‚µãƒ–ï¼ˆå…¥æµ´/ä½“èª¿ï¼‰
      const bathParent = autoBox.querySelector('.fav-item[value="bathing"]');
      const bathSubs = Array.from(autoBox.querySelectorAll('.fav-auto-bath-sub'));
      bathSubs.forEach((cb) => cb.checked = savedAutoBathSubs.includes(cb.dataset.sub));
      setupCompound(bathParent, bathSubs, "prompt");

      const healthParent = autoBox.querySelector('.fav-item[value="health"]');
      const healthSubs = Array.from(autoBox.querySelectorAll('.fav-auto-health-sub'));
      healthSubs.forEach((cb) => cb.checked = savedAutoHealthSubs.includes(cb.dataset.sub));
      setupCompound(healthParent, healthSubs, "bp");

      // â‘¢ æ—¥ä¸­æ”¯æ´ï¼šä¸»ãªæ”¯æ´ï¼ˆåˆ©ç”¨è€…åˆ¥ãƒªã‚¹ãƒˆã«åˆã‚ã›ã‚‹ï¼‰
      const conf = getDaySupportForResident(resident);
      dayBox.innerHTML = "";
      (conf.main || []).forEach((text) => {
        if (text === BATHING_MAIN_KEY) {
          const box = document.createElement("div");
          box.className = "auto-compound";
          box.innerHTML = `
            <label><input type="checkbox" class="fav-day-main-item" value="${escapeHtmlAttr(BATHING_MAIN_KEY)}"> ${escapeHtml(BATHING_MAIN_KEY)}</label>
            <span class="auto-compound-sub">
              <label><input type="checkbox" class="fav-day-bath-sub" data-sub="å£°ã‹ã‘" value="å£°ã‹ã‘">å£°ã‹ã‘</label>
              <label><input type="checkbox" class="fav-day-bath-sub" data-sub="è¦‹å®ˆã‚Š" value="è¦‹å®ˆã‚Š">è¦‹å®ˆã‚Š</label>
              <label><input type="checkbox" class="fav-day-bath-sub" data-sub="ä»‹åŠ©" value="ä»‹åŠ©">ä»‹åŠ©</label>
            </span>
          `;
          dayBox.appendChild(box);
          return;
        }
        if (text === HEALTH_MAIN_KEY) {
          const box = document.createElement("div");
          box.className = "auto-compound";
          box.innerHTML = `
            <label><input type="checkbox" class="fav-day-main-item" value="${escapeHtmlAttr(HEALTH_MAIN_KEY)}"> ${escapeHtml(HEALTH_MAIN_KEY)}</label>
            <span class="auto-compound-sub">
              <label><input type="checkbox" class="fav-day-health-sub" data-sub="è¡€åœ§" value="è¡€åœ§">è¡€åœ§</label>
              <label><input type="checkbox" class="fav-day-health-sub" data-sub="ä½“é‡" value="ä½“é‡">ä½“é‡</label>
              <label><input type="checkbox" class="fav-day-health-sub" data-sub="æ¤œæ¸©" value="æ¤œæ¸©">æ¤œæ¸©</label>
              <label><input type="checkbox" class="fav-day-health-sub" data-sub="ç—‡çŠ¶ç¢ºèª" value="ç—‡çŠ¶ç¢ºèª">ç—‡çŠ¶ç¢ºèª</label>
              <label><input type="checkbox" class="fav-day-health-sub" data-sub="å®‰é™è¦‹å®ˆã‚Š" value="å®‰é™è¦‹å®ˆã‚Š">å®‰é™è¦‹å®ˆã‚Š</label>
            </span>
          `;
          dayBox.appendChild(box);
          return;
        }
        const label = document.createElement("label");
        label.innerHTML = `<input type="checkbox" class="fav-day-main-item" value="${escapeHtmlAttr(text)}"> ${escapeHtml(text)}`;
        dayBox.appendChild(label);
      });

      dayBox.querySelectorAll(".fav-day-main-item").forEach((cb) => {
        cb.checked = daySet.has(cb.value);
      });

      // â‘¢ã‚µãƒ–ï¼ˆå…¥æµ´/ä½“èª¿ï¼‰
      const dayBathParent = Array.from(dayBox.querySelectorAll('.fav-day-main-item')).find((x) => x.value === BATHING_MAIN_KEY);
      const dayBathSubs = Array.from(dayBox.querySelectorAll('.fav-day-bath-sub'));
      dayBathSubs.forEach((cb) => cb.checked = savedDayBathSubs.includes(cb.dataset.sub));
      setupCompound(dayBathParent, dayBathSubs, "å£°ã‹ã‘");

      const dayHealthParent = Array.from(dayBox.querySelectorAll('.fav-day-main-item')).find((x) => x.value === HEALTH_MAIN_KEY);
      const dayHealthSubs = Array.from(dayBox.querySelectorAll('.fav-day-health-sub'));
      dayHealthSubs.forEach((cb) => cb.checked = savedDayHealthSubs.includes(cb.dataset.sub));
      setupCompound(dayHealthParent, dayHealthSubs, "è¡€åœ§");
    }

function saveFavFromManager() {
      const res = document.getElementById("favResidentSelect")?.value;
      if (!res) { alert("å¯¾è±¡ã®åˆ©ç”¨è€…ã‚’é¸æŠã—ã¦ãã ã•ã„"); return; }

      const autoKeys = Array.from(document.querySelectorAll("#favAutoItemCheckboxes .fav-item:checked")).map((x) => x.value);
      const dayMain  = Array.from(document.querySelectorAll("#favDaySupportMainCheckboxes .fav-day-main-item:checked")).map((x) => x.value);

      // â‘¡ã‚µãƒ–
      let autoBathSubs = [];
      const bathParent = document.querySelector('#favAutoItemCheckboxes .fav-item[value="bathing"]');
      if (bathParent && bathParent.checked) {
        autoBathSubs = Array.from(document.querySelectorAll('#favAutoItemCheckboxes .fav-auto-bath-sub:checked')).map((x) => x.dataset.sub);
        if (autoBathSubs.length === 0) autoBathSubs = ["prompt"]; // ã‚µãƒ–å¿…é ˆ
      }

      let autoHealthSubs = [];
      const healthParent = document.querySelector('#favAutoItemCheckboxes .fav-item[value="health"]');
      if (healthParent && healthParent.checked) {
        autoHealthSubs = Array.from(document.querySelectorAll('#favAutoItemCheckboxes .fav-auto-health-sub:checked')).map((x) => x.dataset.sub);
        if (autoHealthSubs.length === 0) autoHealthSubs = ["bp"]; // ã‚µãƒ–å¿…é ˆ
      }

      // â‘¢ã‚µãƒ–
      let dayBathingSubs = [];
      const dayBathParent = Array.from(document.querySelectorAll('#favDaySupportMainCheckboxes .fav-day-main-item')).find((x) => x.value === BATHING_MAIN_KEY);
      if (dayBathParent && dayBathParent.checked) {
        dayBathingSubs = Array.from(document.querySelectorAll('#favDaySupportMainCheckboxes .fav-day-bath-sub:checked')).map((x) => x.dataset.sub);
        if (dayBathingSubs.length === 0) dayBathingSubs = ["å£°ã‹ã‘"];
      }

      let dayHealthSubs = [];
      const dayHealthParent = Array.from(document.querySelectorAll('#favDaySupportMainCheckboxes .fav-day-main-item')).find((x) => x.value === HEALTH_MAIN_KEY);
      if (dayHealthParent && dayHealthParent.checked) {
        dayHealthSubs = Array.from(document.querySelectorAll('#favDaySupportMainCheckboxes .fav-day-health-sub:checked')).map((x) => x.dataset.sub);
        if (dayHealthSubs.length === 0) dayHealthSubs = ["è¡€åœ§"];
      }

      const prev = getFavForResident(res);

      favByResident[res] = { ...prev, autoKeys, dayMain, autoBathSubs, autoHealthSubs, dayBathingSubs, dayHealthSubs };
      saveFavByResident();
      alert("ä¿å­˜ã—ã¾ã—ãŸã€‚");
    }

function applyFavNowFromManager() {
      const res = document.getElementById("favResidentSelect")?.value;
      if (!res) return;

      const autoKeys = Array.from(document.querySelectorAll("#favAutoItemCheckboxes .fav-item:checked")).map((x) => x.value);
      const dayMain  = Array.from(document.querySelectorAll("#favDaySupportMainCheckboxes .fav-day-main-item:checked")).map((x) => x.value);

      // â‘¡ã‚µãƒ–
      let autoBathSubs = [];
      const bathParent = document.querySelector('#favAutoItemCheckboxes .fav-item[value="bathing"]');
      if (bathParent && bathParent.checked) {
        autoBathSubs = Array.from(document.querySelectorAll('#favAutoItemCheckboxes .fav-auto-bath-sub:checked')).map((x) => x.dataset.sub);
        if (autoBathSubs.length === 0) autoBathSubs = ["prompt"];
      }

      let autoHealthSubs = [];
      const healthParent = document.querySelector('#favAutoItemCheckboxes .fav-item[value="health"]');
      if (healthParent && healthParent.checked) {
        autoHealthSubs = Array.from(document.querySelectorAll('#favAutoItemCheckboxes .fav-auto-health-sub:checked')).map((x) => x.dataset.sub);
        if (autoHealthSubs.length === 0) autoHealthSubs = ["bp"];
      }

      // â‘¢ã‚µãƒ–
      let dayBathingSubs = [];
      const dayBathParent = Array.from(document.querySelectorAll('#favDaySupportMainCheckboxes .fav-day-main-item')).find((x) => x.value === BATHING_MAIN_KEY);
      if (dayBathParent && dayBathParent.checked) {
        dayBathingSubs = Array.from(document.querySelectorAll('#favDaySupportMainCheckboxes .fav-day-bath-sub:checked')).map((x) => x.dataset.sub);
        if (dayBathingSubs.length === 0) dayBathingSubs = ["å£°ã‹ã‘"];
      }

      let dayHealthSubs = [];
      const dayHealthParent = Array.from(document.querySelectorAll('#favDaySupportMainCheckboxes .fav-day-main-item')).find((x) => x.value === HEALTH_MAIN_KEY);
      if (dayHealthParent && dayHealthParent.checked) {
        dayHealthSubs = Array.from(document.querySelectorAll('#favDaySupportMainCheckboxes .fav-day-health-sub:checked')).map((x) => x.dataset.sub);
        if (dayHealthSubs.length === 0) dayHealthSubs = ["è¡€åœ§"];
      }

      const prev = getFavForResident(res);

      favByResident[res] = { ...prev, autoKeys, dayMain, autoBathSubs, autoHealthSubs, dayBathingSubs, dayHealthSubs };
      saveFavByResident();

      const current = document.getElementById("resident")?.value;
      if (current === res) {
        applyDaySupportListsForResident(res);
        applyFavToMainCheckboxes(res);
      }
      alert("ãƒ•ã‚©ãƒ¼ãƒ ã¸åæ˜ ã—ã¾ã—ãŸã€‚");
    }

function clearFavChecks() {
      const autoParents = Array.from(document.querySelectorAll('#favAutoItemCheckboxes .fav-item'));
      autoParents.forEach((x) => { x.checked = false; });
      // è¦ªã®changeã‚’æŠ•ã’ã¦ã‚µãƒ–ã‚’OFF&ç„¡åŠ¹åŒ–
      autoParents.forEach((x) => x.dispatchEvent(new Event('change')));

      const dayParents = Array.from(document.querySelectorAll('#favDaySupportMainCheckboxes .fav-day-main-item'));
      dayParents.forEach((x) => { x.checked = false; });
      dayParents.forEach((x) => x.dispatchEvent(new Event('change')));
    }




    // ===== è‡ªå‹•ãƒ†ãƒ³ãƒ—ãƒ¬ï¼ˆåˆ©ç”¨è€…åˆ¥ï¼‰ç®¡ç†ï¼ˆä¸‹ã®ç®¡ç†ã‚«ãƒ¼ãƒ‰ï¼‰ =====
    function renderResidentTemplateManager() {
      const resSel = document.getElementById("rtResidentSelect");
      const tplSel = document.getElementById("rtTemplateSelect");
      const defInfo = document.getElementById("rtDefaultInfo");
      if (!resSel || !tplSel) return;

      populateResidentSelect(resSel);
      const resident = resSel.value || residents[0] || "";
      if (!resSel.value && resident) resSel.value = resident;

      const st = ensureResidentTemplateState(resident);

      tplSel.innerHTML = `<option value="">ï¼ˆæ–°è¦ä½œæˆï¼‰</option>`;
      st.templates.forEach((t) => {
        const opt = document.createElement("option");
        opt.value = t.id;
        opt.textContent = t.name;
        tplSel.appendChild(opt);
      });

      const defaultName = st.templates.find((t) => t.id === st.defaultId)?.name || "ãªã—";
      if (defInfo) defInfo.textContent = "æ—¢å®šï¼š" + defaultName;
    }

    function fillResidentTemplateManagerInputs() {
      const resident = document.getElementById("rtResidentSelect")?.value;
      const tplId = document.getElementById("rtTemplateSelect")?.value;
      const nameEl = document.getElementById("rtTemplateName");
      const textEl = document.getElementById("rtTemplateText");
      if (!resident || !nameEl || !textEl) return;

      const st = ensureResidentTemplateState(resident);
      const tpl = st.templates.find((t) => t.id === tplId);

      if (!tplId || !tpl) {
        nameEl.value = "";
        textEl.value = "";
        return;
      }
      nameEl.value = tpl.name || "";
      textEl.value = tpl.text || "";
    }

    function saveResidentTemplateFromManager() {
      const resident = document.getElementById("rtResidentSelect")?.value;
      const tplId = document.getElementById("rtTemplateSelect")?.value;
      const name = document.getElementById("rtTemplateName")?.value.trim();
      const text = document.getElementById("rtTemplateText")?.value || "";
      if (!resident) { alert("å¯¾è±¡ã®åˆ©ç”¨è€…ã‚’é¸æŠã—ã¦ãã ã•ã„"); return; }
      if (!name) { alert("ãƒ†ãƒ³ãƒ—ãƒ¬åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„"); return; }
      if (!text.trim()) { if (!confirm("æœ¬æ–‡ãŒç©ºã§ã™ãŒä¿å­˜ã—ã¾ã™ã‹ï¼Ÿ")) return; }

      const st = ensureResidentTemplateState(resident);
      if (tplId) {
        const idx = st.templates.findIndex((t) => t.id === tplId);
        if (idx >= 0) st.templates[idx] = { ...st.templates[idx], name, text };
      } else {
        st.templates.push({ id: Date.now().toString(), name, text });
      }

      saveResidentAutoTemplates();
      renderResidentTemplateManager();
      document.getElementById("rtTemplateSelect").value = "";
      fillResidentTemplateManagerInputs();
      renderResidentTemplateSelectForForm();
      alert("ä¿å­˜ã—ã¾ã—ãŸ");
    }

    function setDefaultResidentTemplateFromManager() {
      const resident = document.getElementById("rtResidentSelect")?.value;
      const tplId = document.getElementById("rtTemplateSelect")?.value;
      if (!resident) return;
      if (!tplId) { alert("æ—¢å®šã«ã™ã‚‹ãƒ†ãƒ³ãƒ—ãƒ¬ã‚’é¸æŠã—ã¦ãã ã•ã„"); return; }
      const st = ensureResidentTemplateState(resident);
      st.defaultId = tplId;
      saveResidentAutoTemplates();
      renderResidentTemplateManager();
      renderResidentTemplateSelectForForm();
      alert("æ—¢å®šã«è¨­å®šã—ã¾ã—ãŸ");
    }

    function deleteResidentTemplateFromManager() {
      const resident = document.getElementById("rtResidentSelect")?.value;
      const tplId = document.getElementById("rtTemplateSelect")?.value;
      if (!resident || !tplId) { alert("å‰Šé™¤ã™ã‚‹ãƒ†ãƒ³ãƒ—ãƒ¬ã‚’é¸æŠã—ã¦ãã ã•ã„"); return; }

      const st = ensureResidentTemplateState(resident);
      const tpl = st.templates.find((t) => t.id === tplId);
      if (!confirm(`ã€Œ${tpl?.name || ""}ã€ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ`)) return;

      st.templates = st.templates.filter((t) => t.id !== tplId);
      if (st.defaultId === tplId) st.defaultId = "";

      saveResidentAutoTemplates();
      renderResidentTemplateManager();
      document.getElementById("rtTemplateSelect").value = "";
      fillResidentTemplateManagerInputs();
      renderResidentTemplateSelectForForm();
      alert("å‰Šé™¤ã—ã¾ã—ãŸ");
    }

    function clearResidentTemplateManagerInputs() {
      document.getElementById("rtTemplateSelect").value = "";
      document.getElementById("rtTemplateName").value = "";
      document.getElementById("rtTemplateText").value = "";
    }

    function renderResidentTemplateSelectForForm() {
      const resident = document.getElementById("resident")?.value;
      const sel = document.getElementById("residentTemplateSelect");
      if (!sel) return;

      sel.innerHTML = `<option value="">ï¼ˆãªã—ï¼‰</option>`;
      if (!resident) return;

      const st = ensureResidentTemplateState(resident);
      st.templates.forEach((t) => {
        const opt = document.createElement("option");
        opt.value = t.id;
        opt.textContent = t.name;
        sel.appendChild(opt);
      });

      if (st.defaultId && st.templates.some((t) => t.id === st.defaultId)) sel.value = st.defaultId;
      else sel.value = "";
    }

    // ===== æ—¥ä¸­æ”¯æ´ãƒã‚§ãƒƒã‚¯ï¼ˆåˆ©ç”¨è€…åˆ¥ï¼‰ç®¡ç†ï¼ˆä¸‹ã®ç®¡ç†ã‚«ãƒ¼ãƒ‰ï¼‰ =====
    function ensureDaySupportDefaultOption(sel) {
      // å…ˆé ­ï¼šç©ºã®ãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€ã€æ¬¡ã«ã€Œå…±é€šãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã€ã‚’å·®ã—è¾¼ã‚€
      if (!sel) return;
      const exists = Array.from(sel.options).some((o) => o.value === DAY_SUPPORT_DEFAULT_VALUE);
      if (exists) return;
      const opt = document.createElement("option");
      opt.value = DAY_SUPPORT_DEFAULT_VALUE;
      opt.textContent = "ï¼ˆå…±é€šãƒ‡ãƒ•ã‚©ãƒ«ãƒˆï¼‰";
      // index1ã«æŒ¿å…¥ï¼ˆplaceholderã®æ¬¡ï¼‰
      sel.insertBefore(opt, sel.options[1] || null);
    }

    function renderDaySupportManager() {
      const sel = document.getElementById("dsResidentSelect");
      const mainTa = document.getElementById("dsMainList");
      const reasonTa = document.getElementById("dsReasonList");
      if (!sel || !mainTa || !reasonTa) return;

      const prev = sel.value || "";

      populateResidentSelect(sel);
      ensureDaySupportDefaultOption(sel);

      // é¸æŠã‚’å¾©å…ƒï¼ˆãªã‘ã‚Œã°ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆâ†’å…ˆé ­åˆ©ç”¨è€…ã®é †ï¼‰
      if (prev && Array.from(sel.options).some((o) => o.value === prev)) {
        sel.value = prev;
      } else if (Array.from(sel.options).some((o) => o.value === DAY_SUPPORT_DEFAULT_VALUE)) {
        sel.value = DAY_SUPPORT_DEFAULT_VALUE;
      } else {
        const resident = residents[0] || "";
        if (resident) sel.value = resident;
      }

      const val = sel.value || "";
      const conf = (val === DAY_SUPPORT_DEFAULT_VALUE) ? getDefaultDaySupport() : getDaySupportForResident(val);
      mainTa.value = (conf.main || []).join("\n");
      reasonTa.value = (conf.reason || []).join("\n");
    }

    function saveDaySupportFromManager() {
      const selVal = document.getElementById("dsResidentSelect")?.value || "";
      if (!selVal) return;

      const mainLines = (document.getElementById("dsMainList")?.value || "")
        .split("\n").map((x) => x.trim()).filter(Boolean);
      const reasonLines = (document.getElementById("dsReasonList")?.value || "")
        .split("\n").map((x) => x.trim()).filter(Boolean);

      if (selVal === DAY_SUPPORT_DEFAULT_VALUE) {
        if (mainLines.length === 0 && !confirm("ä¸»ãªæ”¯æ´ãŒç©ºã§ã™ã€‚ç©ºã§ä¿å­˜ã—ã¾ã™ã‹ï¼Ÿ")) return;

        daySupportDefault = { main: mainLines, reason: reasonLines };
        saveDaySupportDefault();
        renderDaySupportManager();

        const current = document.getElementById("resident")?.value || "";
        applyDaySupportListsForResident(current); // ç©ºãªã‚‰ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆé©ç”¨

        alert("ä¿å­˜ã—ã¾ã—ãŸï¼ˆå…±é€šãƒ‡ãƒ•ã‚©ãƒ«ãƒˆï¼‰");
        return;
      }

      const resident = selVal;
      if (mainLines.length === 0 && !confirm("ä¸»ãªæ”¯æ´ãŒç©ºã§ã™ã€‚ç©ºã§ä¿å­˜ã—ã¾ã™ã‹ï¼Ÿ")) return;

      daySupportByResident[resident] = { main: mainLines, reason: reasonLines };
      saveDaySupportByResident();

      const current = document.getElementById("resident")?.value || "";
      if (current === resident) applyDaySupportListsForResident(resident);

      alert("ä¿å­˜ã—ã¾ã—ãŸï¼ˆãƒ•ã‚©ãƒ¼ãƒ ã«ã‚‚åæ˜ æ¸ˆã¿ï¼‰");
    }

    function resetDaySupportToDefaultFromManager() {
      const selVal = document.getElementById("dsResidentSelect")?.value || "";
      if (!selVal) return;

      if (selVal === DAY_SUPPORT_DEFAULT_VALUE) {
        if (!confirm("å…±é€šãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®æ—¥ä¸­æ”¯æ´ãƒã‚§ãƒƒã‚¯ã‚’åˆæœŸçŠ¶æ…‹ã«æˆ»ã—ã¾ã™ã‹ï¼Ÿ")) return;

        daySupportDefault = { main: DEFAULT_DAY_SUPPORT_MAIN.slice(), reason: DEFAULT_DAY_SUPPORT_REASON.slice() };
        saveDaySupportDefault();
        renderDaySupportManager();

        const current = document.getElementById("resident")?.value || "";
        applyDaySupportListsForResident(current);

        alert("åˆæœŸã«æˆ»ã—ã¾ã—ãŸï¼ˆå…±é€šãƒ‡ãƒ•ã‚©ãƒ«ãƒˆï¼‰");
        return;
      }

      const resident = selVal;
      if (!confirm("ã“ã®åˆ©ç”¨è€…ã®æ—¥ä¸­æ”¯æ´ãƒã‚§ãƒƒã‚¯ã‚’åˆæœŸã«æˆ»ã—ã¾ã™ã‹ï¼Ÿ")) return;

      delete daySupportByResident[resident];
      saveDaySupportByResident();
      renderDaySupportManager();

      const current = document.getElementById("resident")?.value || "";
      if (current === resident) applyDaySupportListsForResident(resident);

      alert("åˆæœŸã«æˆ»ã—ã¾ã—ãŸ");
    }

    // ===== ç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ«ï¼ˆè¨˜éŒ²ç·¨é›†ï¼‰ =====
    function openEditModal(id) {
      const record = records.find((r) => r.id === id);
      if (!record) return;

      editingRecordId = id;

      // åˆ©ç”¨è€…ãŒrecordsç”±æ¥ã§æœªç™»éŒ²ãªã‚‰è¿½åŠ 
      if (record.resident && !residents.includes(record.resident)) {
        residents.push(record.resident);
        saveResidents();
        renderResidentSelects();
      renderRecorderSelects();
        renderAllResidentScopedUIs();
      }

      // å…¥åŠ›
      document.getElementById("editDate").value = record.date || "";
      document.getElementById("editResident").value = record.resident || "";
      const __er = document.getElementById("editRecorder");
      if (__er) {
        ensureSelectHasValue(__er, record.recorder || "");
        __er.value = record.recorder || "";
      }
      const _ets = document.getElementById("editTimeSlot");
      if (_ets) _ets.value = record.timeSlot || "æ—¥ä¸­";
      const _ec = document.getElementById("editCondition");
      if (_ec) _ec.value = record.condition || "è‰¯å¥½";
      const _em = document.getElementById("editMental");
      if (_em) _em.value = record.mental || "å®‰å®š";document.getElementById("editSupport").value = record.support || "";
      document.getElementById("editNote").value = record.note || "";

      // æ—¥ä¸­æ”¯æ´ãƒ†ãƒ³ãƒ—ãƒ¬ï¼ˆæ—¥ä¸­æ”¯æ´åŠ ç®—â… ãƒ»æ¥­å‹™æ—¥èªŒã¸è¿½è¨˜ï¼‰ãƒã‚§ãƒƒã‚¯ï¼šå‰å›ã®ç·¨é›†çŠ¶æ…‹ã‚’æ®‹ã•ãªã„
      document.querySelectorAll("#editDayNoteTemplateChecks .day-note-tpl-check").forEach((el) => { el.checked = false; });

      // ãƒã‚¤ã‚¿ãƒ«ï¼ˆä½“é‡ãƒ»è¡€åœ§ãƒ»è„ˆæ‹ï¼‰
      const __evW  = document.getElementById("editAbnormalWeight");
      const __evS  = document.getElementById("editAbnormalBPsys");
      const __evD  = document.getElementById("editAbnormalBPdia");
      const __evP  = document.getElementById("editAbnormalPulse");
      if (__evW) __evW.value = record.abnormalWeight || "";
      if (__evS) __evS.value = record.abnormalBPsys || "";
      if (__evD) __evD.value = record.abnormalBPdia || "";
      if (__evP) __evP.value = record.abnormalPulse || "";
      syncAbnormalVitalsUI("edit");
      
      const __sh = document.getElementById("editHasSpecialNote");
      if (__sh) __sh.checked = !!record.hasSpecialNote;
      
      const __en = document.getElementById("editNote");
      if (__en) __en.classList.toggle("special-note-on", !!record.hasSpecialNote);
document.getElementById("editDaySupportType").value = record.daySupportType || "";      // ã‚¿ã‚°
      editTags = Array.isArray(record.tags) ? [...record.tags] : [];
      renderEditTagButtons();

      // æ—¥ä¸­æ´»å‹•ãƒã‚§ãƒƒã‚¯
      renderEditDayActivityCheckboxes(record.dayActivityItems || []);

      // æ—¥ä¸­æ”¯æ´ãƒã‚§ãƒƒã‚¯ï¼ˆã“ã®è¨˜éŒ²ã®åˆ©ç”¨è€…ã«åˆã‚ã›ã‚‹ï¼‰
      renderEditDaySupportCheckboxes(record.resident, record.daySupportMainItems || [], record.daySupportReasonItems || []);
      applyBathingSubSelected(record.daySupportBathingSubItems || [], "edit");
      applyHealthSubSelected(record.daySupportHealthSubItems || [], "edit");

      document.getElementById("editModalTitle").textContent = `è¨˜éŒ²ã®ç·¨é›†ï¼ˆ${record.date || ""} / ${record.resident || ""}ï¼‰`;

      document.getElementById("editModal").classList.add("show");
    }

    function closeEditModal() {
      document.getElementById("editModal").classList.remove("show");
      editingRecordId = null;
      editTags = [];
    }

    function renderEditDaySupportCheckboxes(resident, checkedMainArr, checkedReasonArr) {
      const conf = getDaySupportForResident(resident || "");
      const mainList = conf.main || [];
      const reasonList = conf.reason || [];

      const wrapMain = document.getElementById("editDaySupportMainCheckboxes");
      const wrapReason = document.getElementById("editDaySupportReasonCheckboxes");
      wrapMain.innerHTML = "";
      wrapReason.innerHTML = "";

      const checkedMain = new Set(Array.isArray(checkedMainArr) ? checkedMainArr : []);
      const checkedReason = new Set(Array.isArray(checkedReasonArr) ? checkedReasonArr : []);

      mainList.forEach((text) => {
        if (isBathingMainItemText(text)) {
          const holder = document.createElement("div");
          holder.innerHTML = makeBathingCompositeHTML("edit");
          const comp = holder.firstElementChild;
          const parent = comp.querySelector("input.edit-day-main-bathing");
          if (parent) parent.checked = checkedMain.has(BATHING_MAIN_KEY);
          wrapMain.appendChild(comp);
          return;
        }
        if (isHealthMainItemText(text)) {
          const holder = document.createElement("div");
          holder.innerHTML = makeHealthCompositeHTML("edit");
          const comp = holder.firstElementChild;
          const parent = comp.querySelector("input.edit-day-main-health");
          if (parent) parent.checked = checkedMain.has(HEALTH_MAIN_KEY);
          wrapMain.appendChild(comp);
          return;
        }

        const label = document.createElement("label");
        label.innerHTML = `<input type="checkbox" class="edit-day-main-item" value="${escapeHtmlAttr(text)}"> ${escapeHtml(text)}`;
        const cb = label.querySelector("input");
        cb.checked = checkedMain.has(text);
        wrapMain.appendChild(label);
      });

      reasonList.forEach((text) => {
        const label = document.createElement("label");
        label.innerHTML = `<input type="checkbox" class="edit-day-reason-item" value="${escapeHtmlAttr(text)}"> ${escapeHtml(text)}`;
        const cb = label.querySelector("input");
        cb.checked = checkedReason.has(text);
        wrapReason.appendChild(label);
      });

      bindBathingCompositeHandlersOnce("editDaySupportMainCheckboxes", "edit");
      syncBathingCompositeInWrap(wrapMain, "edit");

      bindHealthCompositeHandlersOnce("editDaySupportMainCheckboxes", "edit");
      syncHealthCompositeInWrap(wrapMain, "edit");
    }

    function saveEditModal() {
      if (!editingRecordId) return;
      const idx = records.findIndex((r) => r.id === editingRecordId);
      if (idx < 0) return;

      const resident = document.getElementById("editResident").value;
      const date = document.getElementById("editDate").value;
      if (!resident || !date) { alert("æ—¥ä»˜ã¨åˆ©ç”¨è€…ã¯å¿…é ˆã§ã™"); return; }

      const activityItems = Array.from(document.querySelectorAll(".edit-day-activity-item:checked")).map((x) => x.value);
      const mainItems = Array.from(document.querySelectorAll(".edit-day-main-item:checked")).map((x) => x.value);
      const reasonItems = Array.from(document.querySelectorAll(".edit-day-reason-item:checked")).map((x) => x.value);

      const updated = {
        ...records[idx],
        date,
        resident,
        recorder: document.getElementById("editRecorder")?.value || "",        medTaken: false,
        support: document.getElementById("editSupport").value,
        note: document.getElementById("editNote").value,
        hasSpecialNote: !!document.getElementById("editHasSpecialNote")?.checked,
        tags: [...editTags],
        daySupportType: document.getElementById("editDaySupportType").value,        dayActivityItems: activityItems,
        daySupportMainItems: mainItems,
        daySupportReasonItems: reasonItems,
        daySupportBathingSubItems: getBathingSubSelected("edit"),
        daySupportHealthSubItems: getHealthSubSelected("edit"),
        abnormalVitalsOn: !!((document.getElementById("editAbnormalWeight")?.value || "").trim() || (document.getElementById("editAbnormalBPsys")?.value || "").trim() || (document.getElementById("editAbnormalBPdia")?.value || "").trim() || (document.getElementById("editAbnormalPulse")?.value || "").trim()),
        abnormalWeight: (document.getElementById("editAbnormalWeight")?.value || "").trim(),
        abnormalBPsys: (document.getElementById("editAbnormalBPsys")?.value || "").trim(),
        abnormalBPdia: (document.getElementById("editAbnormalBPdia")?.value || "").trim(),
        abnormalPulse: (document.getElementById("editAbnormalPulse")?.value || "").trim(),
      };

      records[idx] = updated;
      saveRecords();
      renderRecords();
      closeEditModal();
      alert("ä¿å­˜ã—ã¾ã—ãŸ");
    }

    // ===== ãƒ•ã‚©ãƒ¼ãƒ å´ï¼šã‚ˆãä½¿ã†é …ç›®ç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ«ï¼ˆã“ã®åˆ©ç”¨è€…ï¼‰ =====
    function openFavModalForCurrentResident() {
      const resident = document.getElementById("resident")?.value;
      if (!resident) { alert("å…ˆã«åˆ©ç”¨è€…ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚"); return; }

      document.getElementById("favModalTitle").textContent = `ã‚ˆãä½¿ã†é …ç›®ï¼ˆ${resident}ï¼‰`;

      const fav = getFavForResident(resident);
      const autoSet = new Set(fav.autoKeys || []);
      const daySet  = new Set(fav.dayMain || []);

      // è‡ªå‹•å…¥åŠ›
      const autoWrap = document.getElementById("favModalCheckboxes");
      autoWrap.innerHTML = "";

      const savedBathSubs = Array.isArray(fav.autoBathSubs) ? fav.autoBathSubs : [];

      const savedHealthSubs = Array.isArray(fav.autoHealthSubs) ? fav.autoHealthSubs : [];

      AUTO_ITEM_DEFS.forEach((def) => {
        // å…¥æµ´ã ã‘ï¼šè¤‡åˆãƒã‚§ãƒƒã‚¯ï¼ˆå£°ã‹ã‘/è¦‹å®ˆã‚Š/ä»‹åŠ©ï¼‰ã‚’ãƒ¢ãƒ¼ãƒ€ãƒ«ã§ã‚‚é¸æŠå¯ã«ã™ã‚‹
        if (def.key === "bathing") {
          const box = document.createElement("div");
          box.className = "auto-compound";
          box.innerHTML = `
            <label><input type="checkbox" class="fav-modal-item fav-modal-bathing-parent" value="bathing"> ${escapeHtml(def.label || "å…¥æµ´å¯¾å¿œ")}</label>
            <span class="auto-compound-sub">
              <label><input type="checkbox" class="fav-modal-auto-bath-sub" data-sub="prompt" data-label="å£°ã‹ã‘">å£°ã‹ã‘</label>
              <label><input type="checkbox" class="fav-modal-auto-bath-sub" data-sub="watch" data-label="è¦‹å®ˆã‚Š">è¦‹å®ˆã‚Š</label>
              <label><input type="checkbox" class="fav-modal-auto-bath-sub" data-sub="assist" data-label="ä»‹åŠ©">ä»‹åŠ©</label>
            </span>
          `;
          autoWrap.appendChild(box);
          return;
        }

        // ä½“èª¿ç®¡ç†ï¼šè¤‡åˆãƒã‚§ãƒƒã‚¯ï¼ˆè¡€åœ§/ä½“é‡/æ¤œæ¸©/ç—‡çŠ¶ç¢ºèª/å®‰é™è¦‹å®ˆã‚Šï¼‰
        if (def.key === "health") {
          const box = document.createElement("div");
          box.className = "auto-compound";
          box.innerHTML = `
            <label><input type="checkbox" class="fav-modal-item fav-modal-health-parent" value="health"> ${escapeHtml(def.label || "ä½“èª¿ç®¡ç†")}</label>
            <span class="auto-compound-sub">
              <label><input type="checkbox" class="fav-modal-auto-health-sub" data-sub="bp" data-label="è¡€åœ§">è¡€åœ§</label>
              <label><input type="checkbox" class="fav-modal-auto-health-sub" data-sub="wt" data-label="ä½“é‡">ä½“é‡</label>
              <label><input type="checkbox" class="fav-modal-auto-health-sub" data-sub="temp" data-label="æ¤œæ¸©">æ¤œæ¸©</label>
              <label><input type="checkbox" class="fav-modal-auto-health-sub" data-sub="symp" data-label="ç—‡çŠ¶ç¢ºèª">ç—‡çŠ¶ç¢ºèª</label>
              <label><input type="checkbox" class="fav-modal-auto-health-sub" data-sub="rest" data-label="å®‰é™è¦‹å®ˆã‚Š">å®‰é™è¦‹å®ˆã‚Š</label>
            </span>
          `;
          autoWrap.appendChild(box);
          return;
        }

        const label = document.createElement("label");
        label.innerHTML = `<input type="checkbox" class="fav-modal-item" value="${def.key}"> ${escapeHtml(def.label)}`;
        autoWrap.appendChild(label);
      });

      // ãƒã‚§ãƒƒã‚¯å¾©å…ƒ
      autoWrap.querySelectorAll(".fav-modal-item").forEach((cb) => {
        cb.checked = autoSet.has(cb.value);
      });


      // ä½“èª¿ç®¡ç†ã‚µãƒ–ï¼ˆã“ã®åˆ©ç”¨è€…ï¼‰
      const healthParent = autoWrap.querySelector('.fav-modal-item[value="health"]');
      if (healthParent && savedHealthSubs.length && !healthParent.checked) healthParent.checked = true;

      autoWrap.querySelectorAll(".fav-modal-auto-health-sub").forEach((cb) => {
        cb.checked = savedHealthSubs.includes(cb.dataset.sub);
      });

      // å…¥æµ´ã‚µãƒ–ï¼ˆã“ã®åˆ©ç”¨è€…ï¼‰
      const bathParent = autoWrap.querySelector('.fav-modal-item[value="bathing"]');
      if (bathParent && savedBathSubs.length && !bathParent.checked) bathParent.checked = true;

      autoWrap.querySelectorAll(".fav-modal-auto-bath-sub").forEach((cb) => {
        cb.checked = savedBathSubs.includes(cb.dataset.sub);
      });

      // å…¥æµ´ï¼ˆãƒ¢ãƒ¼ãƒ€ãƒ«ï¼‰è¤‡åˆãƒã‚§ãƒƒã‚¯ã®åŒæœŸï¼šè¦ªOFFãªã‚‰ã‚µãƒ–ç„¡åŠ¹ï¼†OFFï¼ã‚µãƒ–ONãªã‚‰è¦ªON
      (function setupFavModalBathCompound(){
        const parent = autoWrap.querySelector('.fav-modal-item[value="bathing"]');
        const subs = Array.from(autoWrap.querySelectorAll('.fav-modal-auto-bath-sub'));
        if (!parent || subs.length === 0) return;

        const sync = () => {
          const on = !!parent.checked;
          subs.forEach((cb) => {
            cb.disabled = !on;
            const lbl = cb.closest("label");
            if (lbl) lbl.style.opacity = on ? "1" : "0.55";
            if (!on) cb.checked = false;
          });
        };

        if (parent.dataset.wired === "1") { sync(); return; }
        parent.dataset.wired = "1";

        parent.addEventListener("change", sync);
        subs.forEach((cb) => {
          cb.addEventListener("change", () => {
            if (cb.checked && !parent.checked) parent.checked = true;
            sync();
          });
        });

        sync();
      })();


      // ä½“èª¿ç®¡ç†ï¼ˆãƒ¢ãƒ¼ãƒ€ãƒ«ï¼‰è¤‡åˆãƒã‚§ãƒƒã‚¯ã®åŒæœŸï¼šè¦ªOFFãªã‚‰ã‚µãƒ–ç„¡åŠ¹ï¼†OFFï¼ã‚µãƒ–ONãªã‚‰è¦ªON
      (function setupFavModalHealthCompound(){
        const parent = autoWrap.querySelector('.fav-modal-item[value="health"]');
        const subs = Array.from(autoWrap.querySelectorAll('.fav-modal-auto-health-sub'));
        if (!parent || subs.length === 0) return;

        const sync = () => {
          const on = !!parent.checked;
          subs.forEach((cb) => {
            cb.disabled = !on;
            const lbl = cb.closest("label");
            if (lbl) lbl.style.opacity = on ? "1" : "0.55";
            if (!on) cb.checked = false;
          });
        };

        if (parent.dataset.wired === "1") { sync(); return; }
        parent.dataset.wired = "1";

        parent.addEventListener("change", sync);
        subs.forEach((cb) => {
          cb.addEventListener("change", () => {
            if (cb.checked && !parent.checked) parent.checked = true;
            sync();
          });
        });

        sync();
      })();

      // æ—¥ä¸­æ”¯æ´ï¼šä¸»ãªæ”¯æ´ï¼ˆåˆ©ç”¨è€…åˆ¥ãƒªã‚¹ãƒˆï¼‰
      const dayWrap = document.getElementById("favModalDaySupportMainCheckboxes");
      const conf = getDaySupportForResident(resident);
      const savedDayBath = Array.isArray(fav.dayBathingSubs) ? fav.dayBathingSubs : [];
      const savedDayHealth = Array.isArray(fav.dayHealthSubs) ? fav.dayHealthSubs : [];

      dayWrap.innerHTML = "";
      (conf.main || []).forEach((text) => {
        if (isBathingMainItemText(text)) {
          const holder = document.createElement("div");
          holder.innerHTML = `
            <div class="day-main-composite">
              <label><input type="checkbox" class="fav-modal-day-main-item fav-modal-day-bathing" value="${escapeHtmlAttr(BATHING_MAIN_KEY)}"> ${escapeHtml(BATHING_MAIN_KEY)}</label>
              <span class="day-main-subwrap disabled">
                <span class="paren">ï¼ˆ</span>
                <label><input type="checkbox" class="fav-modal-day-bath-sub" data-sub="å£°ã‹ã‘" value="å£°ã‹ã‘"> å£°ã‹ã‘</label>
                <label><input type="checkbox" class="fav-modal-day-bath-sub" data-sub="è¦‹å®ˆã‚Š" value="è¦‹å®ˆã‚Š"> è¦‹å®ˆã‚Š</label>
                <label><input type="checkbox" class="fav-modal-day-bath-sub" data-sub="ä»‹åŠ©" value="ä»‹åŠ©"> ä»‹åŠ©</label>
                <span class="paren">ï¼‰</span>
              </span>
            </div>
          `;
          dayWrap.appendChild(holder.firstElementChild);
          return;
        }
        if (isHealthMainItemText(text)) {
          const holder = document.createElement("div");
          holder.innerHTML = `
            <div class="day-main-composite">
              <label><input type="checkbox" class="fav-modal-day-main-item fav-modal-day-health" value="${escapeHtmlAttr(HEALTH_MAIN_KEY)}"> ${escapeHtml(HEALTH_MAIN_KEY)}</label>
              <span class="day-main-subwrap disabled">
                <span class="paren">ï¼ˆ</span>
                <label><input type="checkbox" class="fav-modal-day-health-sub" data-sub="è¡€åœ§" value="è¡€åœ§"> è¡€åœ§</label>
                <label><input type="checkbox" class="fav-modal-day-health-sub" data-sub="ä½“é‡" value="ä½“é‡"> ä½“é‡</label>
                <label><input type="checkbox" class="fav-modal-day-health-sub" data-sub="æ¤œæ¸©" value="æ¤œæ¸©"> æ¤œæ¸©</label>
                <label><input type="checkbox" class="fav-modal-day-health-sub" data-sub="ç—‡çŠ¶ç¢ºèª" value="ç—‡çŠ¶ç¢ºèª"> ç—‡çŠ¶ç¢ºèª</label>
                <label><input type="checkbox" class="fav-modal-day-health-sub" data-sub="å®‰é™è¦‹å®ˆã‚Š" value="å®‰é™è¦‹å®ˆã‚Š"> å®‰é™è¦‹å®ˆã‚Š</label>
                <span class="paren">ï¼‰</span>
              </span>
            </div>
          `;
          dayWrap.appendChild(holder.firstElementChild);
          return;
        }

        const label = document.createElement("label");
        label.innerHTML = `<input type="checkbox" class="fav-modal-day-main-item" value="${escapeHtmlAttr(text)}"> ${escapeHtml(text)}`;
        dayWrap.appendChild(label);
      });

      // è¦ªãƒã‚§ãƒƒã‚¯å¾©å…ƒ
      dayWrap.querySelectorAll(".fav-modal-day-main-item").forEach((cb) => {
        cb.checked = daySet.has(cb.value);
      });

      // ã‚µãƒ–å¾©å…ƒï¼ˆè¦ªãŒONã®ã¨ãã ã‘ï¼‰
      const dayBathParent = dayWrap.querySelector('input.fav-modal-day-bathing');
      const dayBathSubs = Array.from(dayWrap.querySelectorAll('.fav-modal-day-bath-sub'));
      if (dayBathParent && dayBathParent.checked) {
        const set = new Set(savedDayBath);
        dayBathSubs.forEach((cb) => cb.checked = set.has(cb.dataset.sub));
      }

      const dayHealthParent = dayWrap.querySelector('input.fav-modal-day-health');
      const dayHealthSubs = Array.from(dayWrap.querySelectorAll('.fav-modal-day-health-sub'));
      if (dayHealthParent && dayHealthParent.checked) {
        const set = new Set(savedDayHealth);
        dayHealthSubs.forEach((cb) => cb.checked = set.has(cb.dataset.sub));
      }

      // è¦ªå­åŒæœŸï¼ˆè¦ªOFFã§ã‚µãƒ–ç„¡åŠ¹ï¼†OFFï¼ã‚µãƒ–ONã§è¦ªONï¼‰
      (function setupFavModalDayBath(){
        if (!dayBathParent || dayBathSubs.length === 0) return;
        const sync = () => {
          const on = !!dayBathParent.checked;
          const wrap = dayBathParent.closest('.day-main-composite')?.querySelector('.day-main-subwrap');
          if (wrap) wrap.classList.toggle('disabled', !on);
          dayBathSubs.forEach((cb) => {
            cb.disabled = !on;
            const lbl = cb.closest('label');
            if (lbl) lbl.style.opacity = on ? '1' : '0.55';
            if (!on) cb.checked = false;
          });
        };
        dayBathParent.addEventListener('change', sync);
        dayBathSubs.forEach((cb) => cb.addEventListener('change', () => { if (cb.checked && !dayBathParent.checked) dayBathParent.checked = true; sync(); }));
        sync();
      })();

      (function setupFavModalDayHealth(){
        if (!dayHealthParent || dayHealthSubs.length === 0) return;
        const sync = () => {
          const on = !!dayHealthParent.checked;
          const wrap = dayHealthParent.closest('.day-main-composite')?.querySelector('.day-main-subwrap');
          if (wrap) wrap.classList.toggle('disabled', !on);
          dayHealthSubs.forEach((cb) => {
            cb.disabled = !on;
            const lbl = cb.closest('label');
            if (lbl) lbl.style.opacity = on ? '1' : '0.55';
            if (!on) cb.checked = false;
          });
        };
        dayHealthParent.addEventListener('change', sync);
        dayHealthSubs.forEach((cb) => cb.addEventListener('change', () => { if (cb.checked && !dayHealthParent.checked) dayHealthParent.checked = true; sync(); }));
        sync();
      })();

      document.getElementById("favModal").classList.add("show");
    }

    function saveFavModal() {
      const resident = document.getElementById("resident")?.value;
      if (!resident) return;

      const autoKeys = Array.from(document.querySelectorAll("#favModalCheckboxes .fav-modal-item:checked"))
        .map((x) => x.value);

      const dayMain = Array.from(document.querySelectorAll("#favModalDaySupportMainCheckboxes .fav-modal-day-main-item:checked"))
        .map((x) => x.value);

      let autoBathSubs = [];

      let autoHealthSubs = [];

      let dayBathingSubs = [];
      let dayHealthSubs = [];

      const bathParent = document.querySelector('#favModalCheckboxes .fav-modal-item[value="bathing"]');
      if (bathParent && bathParent.checked) {
        autoBathSubs = Array.from(document.querySelectorAll('#favModalCheckboxes .fav-modal-auto-bath-sub:checked')).map((x) => x.dataset.sub);
        if (autoBathSubs.length === 0) autoBathSubs = ["prompt"];
      }


      const healthParent2 = document.querySelector('#favModalCheckboxes .fav-modal-item[value="health"]');
      if (healthParent2 && healthParent2.checked) {
        autoHealthSubs = Array.from(document.querySelectorAll('#favModalCheckboxes .fav-modal-auto-health-sub:checked')).map((x) => x.dataset.sub);
      }

      

      const dayBathParent2 = document.querySelector('#favModalDaySupportMainCheckboxes input.fav-modal-day-bathing');
      if (dayBathParent2 && dayBathParent2.checked) {
        dayBathingSubs = Array.from(document.querySelectorAll('#favModalDaySupportMainCheckboxes .fav-modal-day-bath-sub:checked')).map((x) => x.dataset.sub);
      }

      const dayHealthParent2 = document.querySelector('#favModalDaySupportMainCheckboxes input.fav-modal-day-health');
      if (dayHealthParent2 && dayHealthParent2.checked) {
        dayHealthSubs = Array.from(document.querySelectorAll('#favModalDaySupportMainCheckboxes .fav-modal-day-health-sub:checked')).map((x) => x.dataset.sub);
      }
favByResident[resident] = { autoKeys, dayMain, autoBathSubs, autoHealthSubs, dayBathingSubs, dayHealthSubs };
      saveFavByResident();

      // åæ˜ ï¼ˆãƒ•ã‚©ãƒ¼ãƒ å´ï¼‰
      applyDaySupportListsForResident(resident);
      applyFavToMainCheckboxes(resident);

      renderFavManager();

      document.getElementById("favModal").classList.remove("show");
      alert("ä¿å­˜ã—ã¾ã—ãŸï¼ˆãƒ•ã‚©ãƒ¼ãƒ ã«åæ˜ ï¼‰");
    }

    // ===== ãƒ•ã‚©ãƒ¼ãƒ å´ï¼šè‡ªå‹•ãƒ†ãƒ³ãƒ—ãƒ¬ç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ«ï¼ˆã“ã®åˆ©ç”¨è€…ï¼‰ =====
    function openResidentTemplateModalForCurrentResident() {
      const resident = document.getElementById("resident")?.value;
      if (!resident) { alert("å…ˆã«åˆ©ç”¨è€…ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚"); return; }

      const st = ensureResidentTemplateState(resident);
      document.getElementById("rtModalResidentInfo").textContent = `å¯¾è±¡ï¼š${resident}`;

      const sel = document.getElementById("rtModalSelect");
      sel.innerHTML = `<option value="">ï¼ˆæ–°è¦ä½œæˆï¼‰</option>`;
      st.templates.forEach((t) => {
        const opt = document.createElement("option");
        opt.value = t.id;
        opt.textContent = t.name;
        sel.appendChild(opt);
      });

      const defaultName = st.templates.find((t) => t.id === st.defaultId)?.name || "ãªã—";
      document.getElementById("rtModalDefaultInfo").textContent = "æ—¢å®šï¼š" + defaultName;

      document.getElementById("rtModalName").value = "";
      document.getElementById("rtModalText").value = "";
      sel.value = "";

      document.getElementById("rtModal").classList.add("show");
    }

    function fillResidentTemplateModalInputs() {
      const resident = document.getElementById("resident")?.value;
      if (!resident) return;
      const st = ensureResidentTemplateState(resident);
      const id = document.getElementById("rtModalSelect").value;

      const tpl = st.templates.find((t) => t.id === id);
      if (!id || !tpl) {
        document.getElementById("rtModalName").value = "";
        document.getElementById("rtModalText").value = "";
        return;
      }
      document.getElementById("rtModalName").value = tpl.name || "";
      document.getElementById("rtModalText").value = tpl.text || "";
    }

    function saveResidentTemplateModal() {
      const resident = document.getElementById("resident")?.value;
      if (!resident) return;
      const st = ensureResidentTemplateState(resident);

      const id = document.getElementById("rtModalSelect").value;
      const name = document.getElementById("rtModalName").value.trim();
      const text = document.getElementById("rtModalText").value || "";

      if (!name) { alert("ãƒ†ãƒ³ãƒ—ãƒ¬åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„"); return; }
      if (!text.trim()) { if (!confirm("æœ¬æ–‡ãŒç©ºã§ã™ãŒä¿å­˜ã—ã¾ã™ã‹ï¼Ÿ")) return; }

      if (id) {
        const idx = st.templates.findIndex((t) => t.id === id);
        if (idx >= 0) st.templates[idx] = { ...st.templates[idx], name, text };
      } else {
        st.templates.push({ id: Date.now().toString(), name, text });
      }

      saveResidentAutoTemplates();
      renderResidentTemplateSelectForForm();
      renderResidentTemplateManager();

      alert("ä¿å­˜ã—ã¾ã—ãŸ");
      openResidentTemplateModalForCurrentResident();
    }

    function setDefaultResidentTemplateModal() {
      const resident = document.getElementById("resident")?.value;
      if (!resident) return;
      const st = ensureResidentTemplateState(resident);
      const id = document.getElementById("rtModalSelect").value;
      if (!id) { alert("æ—¢å®šã«ã™ã‚‹ãƒ†ãƒ³ãƒ—ãƒ¬ã‚’é¸æŠã—ã¦ãã ã•ã„"); return; }
      st.defaultId = id;
      saveResidentAutoTemplates();
      renderResidentTemplateSelectForForm();
      renderResidentTemplateManager();
      alert("æ—¢å®šã«è¨­å®šã—ã¾ã—ãŸ");
      openResidentTemplateModalForCurrentResident();
    }

    function deleteResidentTemplateModal() {
      const resident = document.getElementById("resident")?.value;
      if (!resident) return;
      const st = ensureResidentTemplateState(resident);
      const id = document.getElementById("rtModalSelect").value;
      if (!id) { alert("å‰Šé™¤ã™ã‚‹ãƒ†ãƒ³ãƒ—ãƒ¬ã‚’é¸æŠã—ã¦ãã ã•ã„"); return; }

      const tpl = st.templates.find((t) => t.id === id);
      if (!confirm(`ã€Œ${tpl?.name || ""}ã€ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ`)) return;

      st.templates = st.templates.filter((t) => t.id !== id);
      if (st.defaultId === id) st.defaultId = "";

      saveResidentAutoTemplates();
      renderResidentTemplateSelectForForm();
      renderResidentTemplateManager();

      alert("å‰Šé™¤ã—ã¾ã—ãŸ");
      openResidentTemplateModalForCurrentResident();
    }

    // ===== æ—¥ä¸­æ”¯æ´ãƒã‚§ãƒƒã‚¯ï¼ˆã“ã®åˆ©ç”¨è€…ï¼‰å°çª“ =====
    function openDaySupportModalForCurrentResident() {
      const resident = document.getElementById("resident")?.value || "";
      const modal = document.getElementById("dsModal");
      if (!modal) return;

      if (resident) {
        modal.dataset.mode = "resident";
        modal.dataset.resident = resident;
        document.getElementById("dsModalResidentInfo").textContent = `å¯¾è±¡ï¼š${resident}ï¼ˆåˆ©ç”¨è€…åˆ¥ï¼‰`;
      } else {
        modal.dataset.mode = "default";
        modal.dataset.resident = "";
        document.getElementById("dsModalResidentInfo").textContent = "å¯¾è±¡ï¼šå…±é€šãƒ‡ãƒ•ã‚©ãƒ«ãƒˆï¼ˆåˆ©ç”¨è€…æœªé¸æŠï¼‰";
      }

      const conf = resident ? getDaySupportForResident(resident) : getDefaultDaySupport();
      document.getElementById("dsModalMain").value = (conf.main || []).join("\n");
      document.getElementById("dsModalReason").value = (conf.reason || []).join("\n");

      modal.classList.add("show");
    }

    function saveDaySupportModal() {
      const modal = document.getElementById("dsModal");
      if (!modal) return;

      const mode = modal.dataset.mode || "resident";
      const resident = modal.dataset.resident || "";

      const mainLines = (document.getElementById("dsModalMain")?.value || "")
        .split("\n").map((x) => x.trim()).filter(Boolean);
      const reasonLines = (document.getElementById("dsModalReason")?.value || "")
        .split("\n").map((x) => x.trim()).filter(Boolean);

      if (mode === "default") {
        if (mainLines.length === 0 && !confirm("ä¸»ãªæ”¯æ´ãŒç©ºã§ã™ã€‚ç©ºã§ä¿å­˜ã—ã¾ã™ã‹ï¼Ÿ")) return;

        daySupportDefault = { main: mainLines, reason: reasonLines };
        saveDaySupportDefault();

        const current = document.getElementById("resident")?.value || "";
        applyDaySupportListsForResident(current); // ç©ºãªã‚‰ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆé©ç”¨

        renderDaySupportManager();
        alert("ä¿å­˜ã—ã¾ã—ãŸï¼ˆå…±é€šãƒ‡ãƒ•ã‚©ãƒ«ãƒˆï¼‰");
        modal.classList.remove("show");
        return;
      }

      if (!resident) { alert("å…ˆã«åˆ©ç”¨è€…ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚"); return; }
      if (mainLines.length === 0 && !confirm("ä¸»ãªæ”¯æ´ãŒç©ºã§ã™ã€‚ç©ºã§ä¿å­˜ã—ã¾ã™ã‹ï¼Ÿ")) return;

      daySupportByResident[resident] = { main: mainLines, reason: reasonLines };
      saveDaySupportByResident();

      const current = document.getElementById("resident")?.value || "";
      if (current === resident) applyDaySupportListsForResident(resident);

      renderDaySupportManager();
      alert("ä¿å­˜ã—ã¾ã—ãŸ");
      modal.classList.remove("show");
    }

    function resetDaySupportModalToDefault() {
      const modal = document.getElementById("dsModal");
      if (!modal) return;

      const mode = modal.dataset.mode || "resident";
      const resident = modal.dataset.resident || "";

      if (mode === "default") {
        if (!confirm("å…±é€šãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚’åˆæœŸçŠ¶æ…‹ã«æˆ»ã—ã¾ã™ã‹ï¼Ÿ")) return;

        daySupportDefault = { main: DEFAULT_DAY_SUPPORT_MAIN.slice(), reason: DEFAULT_DAY_SUPPORT_REASON.slice() };
        saveDaySupportDefault();

        const current = document.getElementById("resident")?.value || "";
        applyDaySupportListsForResident(current);

        renderDaySupportManager();
        alert("åˆæœŸã«æˆ»ã—ã¾ã—ãŸï¼ˆå…±é€šãƒ‡ãƒ•ã‚©ãƒ«ãƒˆï¼‰");
        openDaySupportModalForCurrentResident();
        return;
      }

      if (!resident) { alert("å…ˆã«åˆ©ç”¨è€…ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚"); return; }
      if (!confirm("ã“ã®åˆ©ç”¨è€…ã®æ—¥ä¸­æ”¯æ´ãƒã‚§ãƒƒã‚¯ã‚’åˆæœŸã«æˆ»ã—ã¾ã™ã‹ï¼Ÿ")) return;

      delete daySupportByResident[resident];
      saveDaySupportByResident();

      const current = document.getElementById("resident")?.value || "";
      if (current === resident) applyDaySupportListsForResident(resident);

      renderDaySupportManager();
      alert("åˆæœŸã«æˆ»ã—ã¾ã—ãŸ");
      openDaySupportModalForCurrentResident();
    }

    function renderAllResidentScopedUIs() {
      renderFavManager();
      renderResidentTemplateManager();
      renderDaySupportManager();
      renderResidentTemplateSelectForForm();
    }

    // ===== èµ·å‹• =====
    
// ===== Excel(.xlsx) å‡ºåŠ›ï¼ˆã‚»ãƒ«çµ±åˆãƒ»æŠ˜ã‚Šè¿”ã—ãƒ»æ¸¸ã‚´ã‚·ãƒƒã‚¯ãƒ»Dåˆ—å¹…45.5ï¼‰ =====
function getWeekdayJa(dateStr) {
  // dateStr: "YYYY-MM-DD"
  if (!dateStr) return "";
  const d = new Date(dateStr + "T00:00:00");
  const w = ["æ—¥","æœˆ","ç«","æ°´","æœ¨","é‡‘","åœŸ"];
  return w[d.getDay()] || "";
}

function exportExcelXlsxMerged() {
  try {
    if (typeof XLSX === "undefined") {
      alert("Excelãƒ©ã‚¤ãƒ–ãƒ©ãƒªãŒèª­ã¿è¾¼ã¾ã‚Œã¦ã„ã¾ã›ã‚“ã€‚ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒƒãƒˆæ¥ç¶šã‚’ã”ç¢ºèªãã ã•ã„ã€‚");
      return;
    }

    const all = Array.isArray(records) ? records.slice() : [];
    if (!all.length) {
      alert("å‡ºåŠ›ã™ã‚‹è¨˜éŒ²ãŒã‚ã‚Šã¾ã›ã‚“ã€‚");
      return;
    }

    // âœ… åˆ©ç”¨è€…åˆ—ã¯å‰Šé™¤ã€‚ãã®ä»£ã‚ã‚Šã€Œåˆ©ç”¨è€…ã”ã¨ã«åˆ¥ã‚·ãƒ¼ãƒˆã€ã‚’æ¨™æº–ã§ä½œã‚‹
    const groups = {};
    all.forEach((r) => {
      const residentName = (r?.resident || "").toString().trim() || "æœªè¨­å®š";
      (groups[residentName] = groups[residentName] || []).push(r);
    });

    const now = new Date();
    const fileDate = now.toISOString().slice(0, 10);

    // Excelã‚·ãƒ¼ãƒˆåã¯ 31æ–‡å­—åˆ¶é™ï¼†ç¦æ­¢æ–‡å­—ãŒã‚ã‚‹ã®ã§æ•´å½¢
    function safeSheetName(name) {
      const s = (name || "").toString().trim() || "æœªè¨­å®š";
      return s
        .replace(/[\[\]\:\*\?\/\\]/g, " ")
        .replace(/\s+/g, " ")
        .trim()
        .slice(0, 31);
    }

    function buildSheetForRecords(list) {
      // âœ… ãƒ˜ãƒƒãƒ€ãƒ¼ï¼ˆåˆ©ç”¨è€…åˆ—ãªã—ï¼‰
      // A:æ—¥ä»˜ / B:æ›œæ—¥ / C:æ”¯æ´å†…å®¹ãƒ»æ§˜å­ï¼ˆé•·æ–‡ï¼‰ / D:è¨˜éŒ²è€…
      const header = ["æ—¥ä»˜", "æ›œæ—¥", "æ”¯æ´å†…å®¹ãƒ»æ§˜å­", "è¨˜éŒ²è€…"];
      const wsData = [header];

      // âœ… Cåˆ—ï¼ˆæ”¯æ´å†…å®¹ãƒ»æ§˜å­ï¼‰ã¯ã€Œæ–‡å­—æ•°ã«å¿œã˜ã¦ã€ç¸¦ã®çµåˆè¡Œæ•°ã‚’è‡ªå‹•èª¿æ•´
      // ãƒ»æœ€ä½3è¡Œã¯ç¢ºä¿
      // ãƒ»é•·æ–‡ã»ã©çµåˆè¡Œæ•°ã‚’å¢—ã‚„ã—ã¦ã€Œéš ã‚Œã€ã‚’é˜²ã
      const MIN_ROWS_PER_RECORD = 3;
      const C_COL_WCH = 76; // Cåˆ—ã®å¹…ï¼ˆwchï¼‰

      // æ–‡å­—æ•°ã‹ã‚‰ã€Œå¿…è¦è¡Œæ•°ã€ã‚’ã–ã£ãã‚Šæ¨å®šï¼ˆæ”¹è¡Œã‚‚è€ƒæ…®ï¼‰
      function estimateRowsForSupport(text) {
  // âœ… Cåˆ—ï¼ˆæ”¯æ´å†…å®¹ãƒ»æ§˜å­ï¼‰ã®æ–‡å­—é‡ã«å¿œã˜ã¦è¡Œæ•°ã‚’æ¨å®šï¼ˆæœ€ä½3è¡Œã€æœ€å¤§40è¡Œï¼‰
  const t0 = (text || "").toString();
  if (!t0.trim()) return 3;

  // ASCII=1ã€å…¨è§’=2 ã§ã€Œè¦‹ãŸç›®ã®å¹…ã€ã‚’æ•°ãˆã‚‹
  function visualLen(s) {
    let n = 0;
    for (const ch of (s || "")) {
      const code = ch.codePointAt(0);
      // æ”¹è¡Œã‚„ã‚¿ãƒ–ãªã©ã®åˆ¶å¾¡æ–‡å­—ã¯å¹…0æ‰±ã„
      if (code === 10 || code === 13 || code === 9) continue;
      n += (code <= 0x7f) ? 1 : 2;
    }
    return n;
  }

  // Cåˆ—å¹…ï¼ˆwch=76ï¼‰ã‚’å‰æã«ã€å…¨è§’ä¸­å¿ƒã§ã ã„ãŸã„ã€Œ38æ–‡å­—/è¡Œã€ãã‚‰ã„ã§æŠ˜ã‚Šè¿”ã™æƒ³å®š
  // â€»ã‚‚ã£ã¨è¡Œæ•°ã‚’å¢—ã‚„ã—ãŸã„å ´åˆã¯ 38 â†’ 32 ãªã©ã«ä¸‹ã’ã‚‹
  const CHARS_PER_LINE = 38;

  // âœ… HTMLåŸ‹ã‚è¾¼ã¿ã§å£Šã‚Œãªã„ã‚ˆã†ã€ã‚¨ã‚¹ã‚±ãƒ¼ãƒ—ã‚„æ­£è¦è¡¨ç¾ãƒªãƒ†ãƒ©ãƒ«ã‚’ä½¿ã‚ãšã«æ”¹è¡Œåˆ†å‰²
  const LF = String.fromCharCode(10);
  const CR = String.fromCharCode(13);
  const t = t0.split(CR).join("");
  const lines = t.split(LF);

  let needed = 0;
  for (const line of lines) {
    const len = visualLen(line);
    needed += Math.max(1, Math.ceil(len / CHARS_PER_LINE));
  }

  return Math.min(40, Math.max(3, needed + 1));
}


      const merges = [];

      // å¯å¤‰è¡Œæ•°ãªã®ã§ã€ç¾åœ¨ã®æ›¸ãè¾¼ã¿è¡Œï¼ˆãƒ˜ãƒƒãƒ€ãƒ¼ã®æ¬¡=1ï¼‰ã‚’è‡ªåˆ†ã§é€²ã‚ã‚‹
      let curRow = 1;

      (list || []).forEach((r) => {
        const date = r?.date || "";
        const youbi = getWeekdayJa(date);
        const recorder = r?.recorder || "";
        const support = (r?.support || "").trim();

        const rowsForThis = estimateRowsForSupport(support);
        const rowBase = curRow; // 0-based (ãƒ˜ãƒƒãƒ€ãƒ¼=0)

        // 1è¡Œç›®ï¼šæ—¥ä»˜/æ›œæ—¥/æ”¯æ´å†…å®¹ï¼ˆCã®å·¦ä¸Šã‚»ãƒ«ã«ã ã‘å…¥ã‚Œã‚‹ï¼‰
        wsData.push([date, youbi, support, ""]);

        // 2è¡Œç›®ã€œï¼ˆæœ€å¾Œã®1è¡Œæ‰‹å‰ã¾ã§ï¼‰ï¼šç©ºè¡Œï¼ˆé«˜ã•ç¢ºä¿ç”¨ï¼‰
        for (let i = 0; i < rowsForThis - 2; i++) {
          wsData.push(["", "", "", ""]);
        }

        // æœ€çµ‚è¡Œï¼šè¨˜éŒ²è€…ï¼ˆDåˆ—ï¼‰
        wsData.push(["", "", "", recorder]);

        // Cåˆ—ã‚’ç¸¦çµåˆï¼ˆrowBase ã€œ rowBase+rowsForThis-1ï¼‰
        merges.push({ s: { r: rowBase, c: 2 }, e: { r: rowBase + rowsForThis - 1, c: 2 } });

        // æ¬¡ã®ãƒ¬ã‚³ãƒ¼ãƒ‰é–‹å§‹è¡Œã¸
        curRow += rowsForThis;
      });
      const ws = XLSX.utils.aoa_to_sheet(wsData);

      // âœ… è¡Œé«˜ã‚’å›ºå®šï¼ˆé•·æ–‡ãŒéš ã‚Œã«ããã€è¦‹ãŸç›®ãŒæƒã†ï¼‰
      // ãƒ˜ãƒƒãƒ€ãƒ¼=å°‘ã—é«˜ã‚ã€ãƒ‡ãƒ¼ã‚¿è¡Œ=æ¨™æº–
      ws["!rows"] = wsData.map((_, ri) => (ri === 0 ? { hpt: 17.65 } : { hpt: 14.25 }));



// âœ… æ›œæ—¥ï¼ˆBåˆ—ï¼‰ã‚’ä¸­å¤®æƒãˆï¼ˆãƒ‡ãƒ¼ã‚¿è¡Œï¼‰ â€» rangeæœªå®šç¾©ã§ã‚‚å‹•ãã‚ˆã†ã«ãƒ­ãƒ¼ã‚«ãƒ«ã§å–å¾—
const __rangeB = XLSX.utils.decode_range(ws["!ref"] || "A1:D1");
for (let r = 1; r <= __rangeB.e.r; r++) {
  const addr = XLSX.utils.encode_cell({ r, c: 1 }); // Båˆ—
  if (!ws[addr]) continue;
  ws[addr].s = ws[addr].s || {};
  ws[addr].s.alignment = Object.assign({}, ws[addr].s.alignment || {}, {
    horizontal: "center",
    vertical: "center",
    wrapText: false
  });
}

      // âœ… å®Ÿéš›ã«çµåˆã™ã‚‹ã®ã¯ã€Œæ”¯æ´å†…å®¹ãƒ»æ§˜å­ã€ã ã‘
      ws["!merges"] = merges;

      // âœ… åˆ—å¹…ï¼ˆCåˆ—=45.5ç›¸å½“ï¼‰
      ws["!cols"] = [
      { wch: 12.8125 }, // A æ—¥ä»˜
      { wch: 6.8125  }, // B æ›œæ—¥
      { wch: 76      }, // C æ”¯æ´å†…å®¹ãƒ»æ§˜å­
      { wch: 12.8125 }, // D è¨˜éŒ²è€…
    ];

      // âœ… å…¨ã‚»ãƒ«ï¼šãƒ•ã‚©ãƒ³ãƒˆã ã‘ã€Œæ¸¸ã‚´ã‚·ãƒƒã‚¯ï¼ˆæ¨™æº–ï¼‰ã€ã«çµ±ä¸€ï¼ˆâ€»é…ç½®ã¯è§¦ã‚‰ãªã„ï¼‰
      Object.keys(ws).forEach((addr) => {
        if (addr[0] === "!") return;
        const cell = ws[addr];
        if (!cell) return;
        cell.s = cell.s || {};
        cell.s.font = { name: "æ¸¸ã‚´ã‚·ãƒƒã‚¯", sz: 11 };
      });

      // âœ… ã‚»ãƒ«çµ±åˆã—ãŸéƒ¨åˆ†ï¼šå·¦æƒãˆï¼‹ä¸Šæƒãˆï¼‹æŠ˜ã‚Šè¿”ã—ã¦å…¨æ–‡è¡¨ç¤º
      (merges || []).forEach((mg) => {
        for (let r = mg.s.r; r <= mg.e.r; r++) {
          for (let c = mg.s.c; c <= mg.e.c; c++) {
            const a = XLSX.utils.encode_cell({ r, c });
            if (!ws[a]) ws[a] = { t: "s", v: "" }; // å¿µã®ãŸã‚
            ws[a].s = ws[a].s || {};
            ws[a].s.font = ws[a].s.font || { name: "æ¸¸ã‚´ã‚·ãƒƒã‚¯", sz: 11 };
            ws[a].s.alignment = Object.assign({}, ws[a].s.alignment || {}, {
              horizontal: "left",
              vertical: "top",
              wrapText: true
            });
          }
        }
      });

      // âœ… ãƒ˜ãƒƒãƒ€ãƒ¼ã ã‘å¤ªå­—ï¼†ä¸­å¤®å¯„ã›
      for (let c = 0; c < header.length; c++) {
        const a = XLSX.utils.encode_cell({ r: 0, c });
        if (!ws[a]) continue;
        ws[a].s = ws[a].s || {};
        ws[a].s.font = { name: "æ¸¸ã‚´ã‚·ãƒƒã‚¯", sz: 11, bold: true };
        ws[a].s.alignment = { vertical: "center", horizontal: "center", wrapText: true };
      }

      return ws;
    }

    const wb = XLSX.utils.book_new();

    // âœ… å…ˆé ­ã«ã€Œåˆ©ç”¨è€…ä¸€è¦§ã€ã‚·ãƒ¼ãƒˆï¼ˆä»¶æ•°ã ã‘ï¼‰
    const residentsSorted = Object.keys(groups).sort((a, b) => a.localeCompare(b, "ja"));
    const infoData = [["åˆ©ç”¨è€…", "ä»¶æ•°"]];
    residentsSorted.forEach((name) => infoData.push([name, (groups[name] || []).length]));
    const infoWs = XLSX.utils.aoa_to_sheet(infoData);
    infoWs["!cols"] = [{ wch: 22 }, { wch: 8 }];
    Object.keys(infoWs).forEach((addr) => {
      if (addr[0] === "!") return;
      const cell = infoWs[addr];
      if (!cell) return;
      cell.s = cell.s || {};
      cell.s.font = { name: "æ¸¸ã‚´ã‚·ãƒƒã‚¯", sz: 11 };
    });
    for (let c = 0; c < 2; c++) {
      const a = XLSX.utils.encode_cell({ r: 0, c });
      if (!infoWs[a]) continue;
      infoWs[a].s = infoWs[a].s || {};
      infoWs[a].s.font = { name: "æ¸¸ã‚´ã‚·ãƒƒã‚¯", sz: 11, bold: true };
      infoWs[a].s.alignment = { vertical: "center", horizontal: "center", wrapText: true };
    }
    XLSX.utils.book_append_sheet(wb, infoWs, "åˆ©ç”¨è€…ä¸€è¦§");

    // âœ… åˆ©ç”¨è€…ã”ã¨ã®ã‚·ãƒ¼ãƒˆã‚’è¿½åŠ 
    residentsSorted.forEach((residentName) => {
      const sheetName = safeSheetName(residentName);
      const ws = buildSheetForRecords(groups[residentName] || []);
      XLSX.utils.book_append_sheet(wb, ws, sheetName);
    });

    const fname = `è¨˜éŒ²ä¸€è¦§_åˆ©ç”¨è€…åˆ¥_${fileDate}.xlsx`;

      XLSX.writeFile(wb, fname, { bookType: "xlsx", cellStyles: true });
  } catch (e) {
    alert("Excelå‡ºåŠ›ã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: " + (e?.message || e));
  }
}


document.addEventListener("DOMContentLoaded", () => {
  // âœ… ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆè£œæ­£ï¼šè¨˜éŒ²ä¸€è¦§ã‚«ãƒ¼ãƒ‰ãŒä¸‹ã«è½ã¡ã‚‹å ´åˆã¯ã€.layout ã«æˆ»ã™
  ;(function fixRecordListPlacement(){
    const layout = document.querySelector('.layout');
    const recordCard = document.querySelector('#recordTableBody')?.closest('section.card');
    if(layout && recordCard && recordCard.parentElement !== layout){
      layout.appendChild(recordCard);
    }
  })();

      
  // Excelå‡ºåŠ›
  document.getElementById("exportExcelBtn")?.addEventListener("click", exportExcelXlsxMerged);
document.getElementById("date").value = toLocalISODate();

      records = loadRecords();
      residents = loadResidents();
      recorders = loadRecorders();
      templates = loadTemplates();

      AUTO_ITEM_DEFS = loadAutoItemDefs();
      TAG_LIST = loadTags();

      favByResident = loadFavByResident();
      residentAutoTemplates = loadResidentAutoTemplates();
      daySupportByResident = loadDaySupportByResident();
      daySupportDefault = loadDaySupportDefault();
      dayNoteTemplates = loadDayNoteTemplates();
      dayNotePatternState = loadDayNotePatternState();

      renderResidentSelects();
      renderRecorderSelects();
      renderRecords();

      setupTagButtons();
      updateTagUI();

      setupQuickButtons();
      syncQuickButtonsAll();

      renderAutoItemCheckboxes();
      renderAutoItemManager();

      // åˆæœŸï¼ˆæ—¥ä¸­æ”¯æ´ãƒã‚§ãƒƒã‚¯ï¼‰â€»åˆ©ç”¨è€…æœªé¸æŠæ™‚ã¯ã€Œå…±é€šãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã€
      const defDaySupport = getDefaultDaySupport();
      DAY_SUPPORT_MAIN_LIST = defDaySupport.main.slice();
      DAY_SUPPORT_REASON_LIST = defDaySupport.reason.slice();
      renderDayActivityCheckboxes();
      renderDaySupportMainCheckboxes();
      renderDaySupportReasonCheckboxes();
      renderDayNoteTemplateChecks();

      // æ—¥ä¸­æ´»å‹• / æ¬ å¸­ç†ç”± ã®ãƒã‚§ãƒƒã‚¯ â†’ æ¥­å‹™æ—¥èªŒæ¬„ã¸è‡ªå‹•åæ˜ 
      setupAutoNoteMain();
      setupAutoNoteEdit();


      const templateScopeEl = document.getElementById("templateScope");
      if (templateScopeEl) {
        templateScopeEl.addEventListener("change", renderTemplateSelect);
        templateScopeEl.value = "common";
      }
      renderTemplateSelect();

      renderAllResidentScopedUIs();

      // ===== åŸºæœ¬ã‚¤ãƒ™ãƒ³ãƒˆ =====
      document.getElementById("recordForm").addEventListener("submit", handleSubmit);
      document.
getElementById("resetButton").addEventListener("click", resetForm);

      // ===== æ—¥ä¸­æ”¯æ´ãƒ†ãƒ³ãƒ—ãƒ¬ï¼ˆæ—¥ä¸­æ”¯æ´åŠ ç®—â… ãƒ»æ¥­å‹™æ—¥èªŒã¸è¿½è¨˜ï¼‰: ãƒã‚§ãƒƒã‚¯ã§è‡ªå‹•è¿½è¨˜ =====
      // ï¼ˆé…ç·šã¯ renderDayNoteTemplateChecks() å†…ã§è¡Œã„ã¾ã™ï¼‰

      document.getElementById("openDayNoteTemplateModalBtn")?.addEventListener("click", openDayNoteTemplateModal);
      document.getElementById("dayNoteTplModalClose")?.addEventListener("click", closeDayNoteTemplateModal);
      document.getElementById("dayNoteTplModalCloseBtn")?.addEventListener("click", closeDayNoteTemplateModal);
      document.getElementById("dayNoteTplModal")?.addEventListener("click", (e) => {
        if (e.target === e.currentTarget) closeDayNoteTemplateModal();
      });

      document.getElementById("dnTplSelect")?.addEventListener("change", fillDayNoteTemplateManagerInputs);
      document.getElementById("dnTplSaveBtn")?.addEventListener("click", saveDayNoteTemplateFromManager);
      document.getElementById("dnTplDeleteBtn")?.addEventListener("click", deleteDayNoteTemplateFromManager);
      document.getElementById("dnTplClearBtn")?.addEventListener("click", clearDayNoteTemplateManagerInputs);
      document.getElementById("dnTplResetDefaultBtn")?.addEventListener("click", resetDayNoteTemplatesToDefault);

      // ç‰¹è¨˜äº‹é …ã‚ã‚Šï¼ˆãƒ•ã‚©ãƒ¼ãƒ /ç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ«ã®è¦‹ãŸç›®å¼·èª¿ï¼‰
      const __specialCb = document.getElementById("hasSpecialNote");
      const __noteTa = document.getElementById("note");
      const __syncSpecial = () => { if (__specialCb && __noteTa) __noteTa.classList.toggle("special-note-on", !!__specialCb.checked); };
      if (__specialCb) __specialCb.addEventListener("change", __syncSpecial);
      __syncSpecial();

      const __editSpecialCb = document.getElementById("editHasSpecialNote");
      const __editNoteTa = document.getElementById("editNote");
      const __syncEditSpecial = () => { if (__editSpecialCb && __editNoteTa) __editNoteTa.classList.toggle("special-note-on", !!__editSpecialCb.checked); };
      if (__editSpecialCb) __editSpecialCb.addEventListener("change", __syncEditSpecial);
      __syncEditSpecial();


      document.getElementById("filterResident").addEventListener("change", renderRecords);
      const __specialFilterCb = document.getElementById("filterSpecialOnly");
      if (__specialFilterCb) {
        // å‰å›çŠ¶æ…‹ã®å¾©å…ƒ
        try {
          const saved = localStorage.getItem("filterSpecialOnly");
          if (saved !== null) __specialFilterCb.checked = (saved === "1");
        } catch(e){}
        __specialFilterCb.addEventListener("change", () => {
          try { localStorage.setItem("filterSpecialOnly", __specialFilterCb.checked ? "1" : "0"); } catch(e){}
          renderRecords();
        });
      }

      document.getElementById("searchKeyword").addEventListener("input", renderRecords);
      document.getElementById("searchClearButton").addEventListener("click", () => {
        document.getElementById("searchKeyword").value = "";
        renderRecords();
      });

// ğŸ§· ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ— / â™» å¾©å…ƒ
const backupBtn = document.getElementById("backupBtn");
if (backupBtn) backupBtn.addEventListener("click", () => downloadBackup());

const restoreBtn = document.getElementById("restoreBtn");
const restoreFile = document.getElementById("restoreFile");
if (restoreBtn && restoreFile) {
  restoreBtn.addEventListener("click", () => restoreFile.click());
  restoreFile.addEventListener("change", (e) => {
    const file = e.target?.files?.[0];
    e.target.value = ""; // åŒã˜ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é€£ç¶šã§é¸ã¹ã‚‹ã‚ˆã†ã«
    handleRestoreFile(file);
  });
}

      const periodFilterElement = document.getElementById("periodFilter");
      if (periodFilterElement) {
        periodFilterElement.addEventListener("change", () => {
          const val = periodFilterElement.value;
          const row = document.getElementById("customPeriodRow");
          if (row) row.style.display = (val === "custom") ? "flex" : "none";
          renderRecords();
        });
      }
      document.getElementById("applyCustomPeriod").addEventListener("click", renderRecords);

      // âœ… åˆ©ç”¨è€…å¤‰æ›´ï¼šã‚ˆãä½¿ã†é …ç›®ON / æ—¥ä¸­æ”¯æ´ãƒªã‚¹ãƒˆåæ˜  / åˆ©ç”¨è€…åˆ¥ãƒ†ãƒ³ãƒ—ãƒ¬é¸æŠæ›´æ–°
      document.getElementById("resident")?.addEventListener("change", () => {
        const r = document.getElementById("resident").value || "";
        applyDaySupportListsForResident(r); // ç©ºãªã‚‰ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆé©ç”¨
        if (!r) return;
        applyFavToMainCheckboxes(r);
        renderResidentTemplateSelectForForm();
      });

      // è‡ªå‹•
            {
        const autoBtn = document.getElementById("autoSupportBtn");
        if(autoBtn) autoBtn.addEventListener("click", generateSupportText);
      }

      // ãƒ†ãƒ³ãƒ—ãƒ¬ï¼ˆå…±é€šï¼‰
      document.getElementById("templateApplyButton")?.addEventListener("click", handleTemplateApply);
      document.getElementById("templateSaveButton")?.addEventListener("click", handleTemplateSave);
      document.getElementById("templateDeleteButton")?.addEventListener("click", handleTemplateDelete);

      // è©³ç´°ãƒ¢ãƒ¼ãƒ€ãƒ«
      const detailModal = document.getElementById("detailModal");
      const detailModalClose = document.getElementById("detailModalClose");
      if (detailModal && detailModalClose) {
        detailModalClose.addEventListener("click", closeRecordDetail);
        detailModal.addEventListener("click", (e) => { if (e.target === detailModal) closeRecordDetail(); });
      }

      // ç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ«
      document.getElementById("editModalClose").addEventListener("click", closeEditModal);
      document.getElementById("editModalCancelBtn").addEventListener("click", closeEditModal);
      document.getElementById("editModalSaveBtn").addEventListener("click", saveEditModal);
      document.getElementById("editModal").addEventListener("click", (e) => { if (e.target.id === "editModal") closeEditModal(); });

      // ç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ«ï¼šåˆ©ç”¨è€…å¤‰æ›´æ™‚
      document.getElementById("editResident").addEventListener("change", () => {
        const res = document.getElementById("editResident").value;
        const mainChecked = Array.from(document.querySelectorAll(".edit-day-main-item:checked")).map(x => x.value);
        const reasonChecked = Array.from(document.querySelectorAll(".edit-day-reason-item:checked")).map(x => x.value);
        renderEditDaySupportCheckboxes(res, mainChecked, reasonChecked);
      });

      // åˆ©ç”¨è€…ç®¡ç†
      document.getElementById("residentAddButton").addEventListener("click", handleResidentAdd);
      document.getElementById("residentRenameButton").addEventListener("click", handleResidentRename);
      document.getElementById("residentDeleteButton").addEventListener("click", handleResidentDelete);

      // è¨˜éŒ²è€…ç®¡ç†
      document.getElementById("recorderAddButton").addEventListener("click", handleRecorderAdd);
      document.getElementById("recorderRenameButton").addEventListener("click", handleRecorderRename);
      document.getElementById("recorderDeleteButton").addEventListener("click", handleRecorderDelete);

      // æ”¯æ´é …ç›®ç®¡ç†UI
      document.getElementById("autoItemSelect").addEventListener("change", fillAutoItemInputsBySelect);
      document.getElementById("autoItemSaveBtn").addEventListener("click", saveAutoItemFromInputs);
      document.getElementById("autoItemDeleteBtn").addEventListener("click", deleteSelectedAutoItem);
      document.getElementById("autoItemClearBtn").addEventListener("click", clearAutoItemInputs);
      document.getElementById("autoItemResetDefaultBtn").addEventListener("click", resetAutoItemsToDefault);

      // ã‚¿ã‚°ç®¡ç†UI
      renderTagManager();
      document.getElementById("tagSelect").addEventListener("change", fillTagInputBySelect);
      document.getElementById("tagSaveBtn").addEventListener("click", saveTagFromInputs);
      document.getElementById("tagDeleteBtn").addEventListener("click", deleteSelectedTag);
      document.getElementById("tagClearBtn").addEventListener("click", clearTagInputs);
      document.getElementById("tagResetDefaultBtn").addEventListener("click", resetTagsToDefault);

      // ã‚ˆãä½¿ã†é …ç›®ï¼ˆåˆ©ç”¨è€…åˆ¥ï¼‰
      document.getElementById("favResidentSelect").addEventListener("change", renderFavManager);
      document.getElementById("favSaveBtn").addEventListener("click", saveFavFromManager);
      document.getElementById("favApplyNowBtn").addEventListener("click", applyFavNowFromManager);
      document.getElementById("favClearBtn").addEventListener("click", clearFavChecks);

      // è‡ªå‹•ãƒ†ãƒ³ãƒ—ãƒ¬ï¼ˆåˆ©ç”¨è€…åˆ¥ï¼‰ç®¡ç†
      document.getElementById("rtResidentSelect")?.addEventListener("change", () => {
        renderResidentTemplateManager();
        document.getElementById("rtTemplateSelect").value = "";
        fillResidentTemplateManagerInputs();
      });
      document.getElementById("rtTemplateSelect")?.addEventListener("change", fillResidentTemplateManagerInputs);
      document.getElementById("rtSaveBtn")?.addEventListener("click", saveResidentTemplateFromManager);
      document.getElementById("rtSetDefaultBtn")?.addEventListener("click", setDefaultResidentTemplateFromManager);
      document.getElementById("rtDeleteBtn")?.addEventListener("click", deleteResidentTemplateFromManager);
      document.getElementById("rtClearBtn")?.addEventListener("click", clearResidentTemplateManagerInputs);

      // æ—¥ä¸­æ”¯æ´ãƒã‚§ãƒƒã‚¯ï¼ˆåˆ©ç”¨è€…åˆ¥ï¼‰ç®¡ç†
      document.getElementById("dsResidentSelect").addEventListener("change", renderDaySupportManager);
      document.getElementById("dsSaveBtn").addEventListener("click", saveDaySupportFromManager);
      document.getElementById("dsResetBtn").addEventListener("click", resetDaySupportToDefaultFromManager);

      // ===== ãƒ•ã‚©ãƒ¼ãƒ å´ãƒœã‚¿ãƒ³ï¼ˆå°çª“ï¼‰ =====
      document.getElementById("openFavModalBtn").addEventListener("click", openFavModalForCurrentResident);
      document.getElementById("favModalClose").addEventListener("click", () => document.getElementById("favModal").classList.remove("show"));
      document.getElementById("favModalCancel").addEventListener("click", () => document.getElementById("favModal").classList.remove("show"));
      document.getElementById("favModalSave").addEventListener("click", saveFavModal);
      document.getElementById("favModal").addEventListener("click", (e) => { if (e.target.id === "favModal") document.getElementById("favModal").classList.remove("show"); });

      // è‡ªå‹•ãƒ†ãƒ³ãƒ—ãƒ¬å°çª“ï¼ˆrtModalï¼‰
      document.getElementById("openResidentTemplateModalBtn")?.addEventListener("click", openResidentTemplateModalForCurrentResident);
      document.getElementById("rtModalClose")?.addEventListener("click", () => document.getElementById("rtModal").classList.remove("show"));
      document.getElementById("rtModalCloseBtn")?.addEventListener("click", () => document.getElementById("rtModal").classList.remove("show"));
      document.getElementById("rtModalSelect")?.addEventListener("change", fillResidentTemplateModalInputs);
      document.getElementById("rtModalSaveBtn")?.addEventListener("click", saveResidentTemplateModal);
      document.getElementById("rtModalSetDefaultBtn")?.addEventListener("click", setDefaultResidentTemplateModal);
      document.getElementById("rtModalDeleteBtn")?.addEventListener("click", deleteResidentTemplateModal);
      document.getElementById("rtModal")?.addEventListener("click", (e) => { if (e.target.id === "rtModal") document.getElementById("rtModal").classList.remove("show"); });

      // æ—¥ä¸­æ”¯æ´å°çª“ï¼ˆdsModalï¼‰
      document.getElementById("openDaySupportModalBtn").addEventListener("click", openDaySupportModalForCurrentResident);
      document.getElementById("dsModalClose").addEventListener("click", () => document.getElementById("dsModal").classList.remove("show"));
      document.getElementById("dsModalCloseBtn").addEventListener("click", () => document.getElementById("dsModal").classList.remove("show"));
      document.getElementById("dsModalSaveBtn").addEventListener("click", saveDaySupportModal);
      document.getElementById("dsModalResetBtn").addEventListener("click", resetDaySupportModalToDefault);
      document.getElementById("dsModal").addEventListener("click", (e) => { if (e.target.id === "dsModal") document.getElementById("dsModal").classList.remove("show"); });
    });
  </script>

  <!-- éŸ³å£°å…¥åŠ›ã‚¹ã‚¯ãƒªãƒ—ãƒˆï¼ˆæ¥­å‹™æ—¥èªŒï¼šãƒ¡ã‚¤ãƒ³ï¼‹ç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ«ï¼‰ -->
  <script>
    document.addEventListener("DOMContentLoaded", () => {
      const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;

      function attachVoice(buttonId, statusId, textareaId){
        const btn = document.getElementById(buttonId);
        const status = document.getElementById(statusId);
        const ta = document.getElementById(textareaId);
        if(!btn || !status || !ta) return;

        if(!SpeechRecognition){
          btn.disabled = true;
          status.textContent = "â€» ã“ã®ãƒ–ãƒ©ã‚¦ã‚¶ã§ã¯éŸ³å£°å…¥åŠ›ãŒä½¿ãˆã¾ã›ã‚“ï¼ˆChrome / Edge æ¨å¥¨ï¼‰";
          return;
        }

        const recognition = new SpeechRecognition();
        recognition.lang = "ja-JP";
        recognition.interimResults = true;
        recognition.continuous = true;

        let recognizing = false;

        btn.addEventListener("click", () => {
          if(!recognizing){
            try { recognition.start(); } catch(e) {}
          }else{
            recognition.stop();
          }
        });

        recognition.addEventListener("start", () => {
          recognizing = true;
          btn.textContent = "â–  åœæ­¢";
          status.textContent = "éŸ³å£°å…¥åŠ›ä¸­â€¦ è©±ã—çµ‚ã‚ã£ãŸã‚‰ã‚‚ã†ä¸€åº¦ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦åœæ­¢ã—ã¦ãã ã•ã„ã€‚";
        });

        recognition.addEventListener("end", () => {
          recognizing = false;
          btn.textContent = "ğŸ™ éŸ³å£°å…¥åŠ›";
          status.textContent = "";
        });

        recognition.addEventListener("result", (event) => {
          let finalText = "";
          for(let i = event.resultIndex; i < event.results.length; i++){
            const res = event.results[i];
            if(res.isFinal) finalText += res[0].transcript;
          }
          if(!finalText) return;

          if(ta.value.trim()) ta.value = ta.value.replace(/\s*$/, "") + "\n" + finalText;
          else ta.value = finalText;
        });

        recognition.addEventListener("error", (e) => {
          recognizing = false;
          btn.textContent = "ğŸ™ éŸ³å£°å…¥åŠ›";
          status.textContent = "éŸ³å£°å…¥åŠ›ã‚¨ãƒ©ãƒ¼ï¼š" + e.error;
        });
      }

      // ãƒ¡ã‚¤ãƒ³ãƒ•ã‚©ãƒ¼ãƒ ã®æ¥­å‹™æ—¥èªŒ
      attachVoice("voiceNoteBtn", "voiceNoteStatus", "note");
      // ç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ«ã®æ¥­å‹™æ—¥èªŒ
      attachVoice("voiceEditNoteBtn", "voiceEditNoteStatus", "editNote");
    });
  </script>

  
  <!-- ğŸ†• ã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ãƒˆé€šçŸ¥ã‚¹ã‚¯ãƒªãƒ—ãƒˆ -->
  <script>
    (function(){
      const UPDATE_VERSION = "2026-01-15_v9";
      const UPDATE_DATE = "2026-01-15";
      const UPDATE_ITEMS = [
        "æ—¥ä¸­æ´»å‹•ï¼ˆAå‹/ Bå‹ï¼šé€šæ‰€ãƒ»æ¬ å¸­ï¼‰ãƒã‚§ãƒƒã‚¯è¿½åŠ ",
        "æ—¥ä¸­æ´»å‹•ãƒ»æ¬ å¸­ç†ç”±ã®ãƒã‚§ãƒƒã‚¯å†…å®¹ã‚’ã€æ¥­å‹™æ—¥èªŒã¸è‡ªå‹•è¨˜å…¥ï¼ˆè‡ªå‹•/æ‰‹å…¥åŠ›ã‚’åŒºåˆ‡ã‚Šè¡¨ç¤ºï¼‰",
        "ã€Œç‰¹è¨˜äº‹é …ã‚ã‚Šã€ãƒã‚§ãƒƒã‚¯è¿½åŠ ï¼ˆä¸€è¦§ã§ãƒãƒƒã‚¸è¡¨ç¤ºï¼‰",
        "ä¸€è¦§ã«ã€Œç‰¹è¨˜äº‹é …ã‚ã‚Šã®ã¿è¡¨ç¤ºã€ãƒ•ã‚£ãƒ«ã‚¿è¿½åŠ ",
        "â‘¢ä¸»ãªæ”¯æ´ã«ã€Œå¤–å‡ºãƒ»é€šé™¢åŒè¡Œã€ç­‰ã‚’è¿½åŠ "
      ];
      const STORAGE_KEY = "plusR_update_seen";

      function el(id){ return document.getElementById(id); }

      function renderBanner(){
        const banner = el("updateBanner");
        if(!banner) return;

        const meta = el("updateBannerMeta");
        const list = el("updateBannerList");
        if(meta) meta.textContent = "æ›´æ–°æ—¥ï¼š" + UPDATE_DATE;

        if(list){
          list.innerHTML = UPDATE_ITEMS.map(t => "<li>" + String(t) + "</li>").join("");
        }

        const closeBtn = el("updateBannerClose");
        if(closeBtn){
          closeBtn.addEventListener("click", () => {
            banner.classList.remove("show");
            try{ localStorage.setItem(STORAGE_KEY, UPDATE_VERSION); }catch(e){}
          });
        }
      }

      function shouldShow(){
        try{
          const seen = localStorage.getItem(STORAGE_KEY);
          return seen !== UPDATE_VERSION;
        }catch(e){
          return true; // localStorageä½¿ãˆãªã„å ´åˆã¯æ¯å›è¡¨ç¤º
        }
      }

      document.addEventListener("DOMContentLoaded", () => {
        renderBanner();
        const banner = el("updateBanner");
        if(!banner) return;

        if(shouldShow()){
          banner.classList.add("show");
        }
      });
    })();
  </script>


<!-- ä¿å­˜ã—ã¾ã—ãŸï¼šãƒˆãƒ¼ã‚¹ãƒˆè¡¨ç¤º -->
  <div id="saveToast" role="status" aria-live="polite"></div>


  <!-- æ—¥ä¸­æ”¯æ´ãƒ†ãƒ³ãƒ—ãƒ¬ï¼šãƒã‚§ãƒƒã‚¯ç›´å¾Œã®ç¢ºèªãƒˆãƒ¼ã‚¹ãƒˆ -->
  <div class="dn-toast" id="dnToast" aria-hidden="true">
    <div class="dn-toast-title" id="dnToastTitle">æ¥­å‹™æ—¥èªŒã«åæ˜ ã—ã¾ã—ãŸ</div>
    <div class="dn-toast-body" id="dnToastBody"></div>
    <div class="dn-toast-actions">
      <button type="button" class="btn-secondary" id="dnToastJumpBtn">æ¥­å‹™æ—¥èªŒã¸ç§»å‹•</button>
      <button type="button" class="btn-secondary" id="dnToastCloseBtn">é–‰ã˜ã‚‹</button>
    </div>
  </div>

</body>
</html>





