<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>ã‚°ãƒ«ãƒ¼ãƒ—ãƒ›ãƒ¼ãƒ  å€‹äººè¨˜éŒ²</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <style>
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: -apple-system, BlinkMacSystemFont, "Helvetica Neue",
        "YuGothic", "Meiryo", sans-serif;
      background: #f3f4f6;
      color: #111827;
      font-size: 16px;
      line-height: 1.6;
    }
    header {
      background: #2563eb;
      color: white;
      padding: 16px 18px;
      font-size: 22px;
      font-weight: bold;
      text-align: center;
      position: sticky;
      top: 0;
      z-index: 10;
    }
    main { max-width: 1280px; margin: 0 auto; padding: 18px; }
    .layout { display: grid; grid-template-columns: repeat(2, minmax(0, 1fr)); gap: 18px; }
    @media (max-width: 900px) { .layout { grid-template-columns: 1fr; } }

    .card {
      background: white;
      border-radius: 18px;
      padding: 20px 22px 22px;
      box-shadow: 0 8px 24px rgba(15, 23, 42, 0.1);
      margin-bottom: 18px;
    }
    .card-title {
      font-size: 20px;
      font-weight: 600;
      margin-bottom: 14px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 10px;
      flex-wrap: wrap;
    }
    .card-subtitle { font-size: 13px; color: #6b7280; margin-bottom: 14px; }
    label { font-size: 14px; font-weight: 600; display: block; margin-bottom: 5px; color: #374151; }

    input[type="text"], input[type="date"], select, textarea {
      width: 100%;
      border-radius: 12px;
      border: 1px solid #d1d5db;
      padding: 10px 12px;
      font-size: 15px;
      outline: none;
      transition: border-color 0.15s, box-shadow 0.15s;
      background: #f9fafb;
    }
    input[type="text"]:focus, input[type="date"]:focus, select:focus, textarea:focus {
      border-color: #2563eb;
      box-shadow: 0 0 0 1px rgba(37, 99, 235, 0.5);
      background: white;
    }
    textarea { min-height: 80px; resize: vertical; }
    .field-row { display: grid; grid-template-columns: repeat(2, minmax(0, 1fr)); gap: 12px; }
    .field-row-3 { display: grid; grid-template-columns: repeat(3, minmax(0, 1fr)); gap: 12px; }
    .field { margin-bottom: 12px; }

    .checkbox-row {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      align-items: center;
      margin-bottom: 6px;
    }
    .checkbox-row label {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      font-weight: 500;
      font-size: 14px;
      margin-bottom: 0;
    }

    .btn-row { display: flex; flex-wrap: wrap; gap: 12px; margin-top: 12px; align-items: center; }
    button {
      border: none;
      border-radius: 999px;
      padding: 10px 18px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: transform 0.05s ease-out, box-shadow 0.1s;
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }
    button:active { transform: translateY(1px); box-shadow: none; }
    .btn-primary { background: #2563eb; color: white; box-shadow: 0 4px 12px rgba(37, 99, 235, 0.4); }
    .btn-secondary { background: #e5e7eb; color: #111827; }
    .btn-danger { background: #dc2626; color: white; }

    .pill {
      border-radius: 999px;
      background: #eff6ff;
      padding: 4px 11px;
      font-size: 12px;
      color: #1d4ed8;
      border: 1px solid #bfdbfe;
      white-space: nowrap;
    }
    .record-count { font-size: 13px; color: #6b7280; white-space: nowrap; }

    table { width: 100%; border-collapse: collapse; font-size: 13px; margin-top: 6px; }
    thead { position: sticky; top: 0; background: #eff6ff; z-index: 1; }
    th, td { border-bottom: 1px solid #e5e7eb; padding: 8px 6px; text-align: left; vertical-align: top; }
    th { font-weight: 600; color: #374151; white-space: nowrap; }
    tbody tr:nth-child(even) { background: #f9fafb; }

    .table-wrapper {
      max-height: 520px;
      overflow: auto;
      border-radius: 14px;
      border: 1px solid #e5e7eb;
      margin-top: 10px;
    }

    .badge {
      display: inline-block;
      padding: 3px 9px;
      border-radius: 999px;
      font-size: 11px;
      font-weight: 600;
      color: white;
      white-space: nowrap;
    }
    .badge-day { background: #22c55e; }
    .badge-evening { background: #f59e0b; }
    .badge-night { background: #6366f1; }

    .small-text { font-size: 12px; color: #6b7280; }
    .no-records { padding: 14px; font-size: 13px; color: #6b7280; text-align: center; }

    .resident-select-row {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      margin-bottom: 10px;
      align-items: center;
    }
    .resident-select-row span { font-size: 13px; color: #4b5563; }
    .resident-select-row select { max-width: 240px; }

    .tag-buttons { display: flex; flex-wrap: wrap; gap: 6px; margin-bottom: 4px; }
    .tag-button {
      border-radius: 999px;
      border: 1px solid #e5e7eb;
      background: #f3f4f6;
      padding: 4px 10px;
      font-size: 12px;
      cursor: pointer;
    }
    .tag-button.tag-button-active { background: #f59e0b; border-color: #f97316; color: #fff; }
    .tag-chip {
      display: inline-block;
      margin-top: 2px;
      margin-right: 4px;
      padding: 2px 7px;
      border-radius: 999px;
      border: 1px solid #fde68a;
      background: #fffbeb;
      font-size: 11px;
      white-space: nowrap;
    }

    .quick-row { display: flex; gap: 8px; flex-wrap: wrap; margin-top: 6px; margin-bottom: 4px; }
    .quick-btn {
      flex: 1 0 0;
      min-width: 70px;
      justify-content: center;
      padding: 8px 10px;
      border-radius: 999px;
      border: 1px solid #d1d5db;
      background: #f3f4f6;
      font-size: 13px;
      cursor: pointer;
    }
    .quick-btn-active {
      background: #2563eb;
      color: #fff;
      border-color: #1d4ed8;
      box-shadow: 0 0 0 1px rgba(37, 99, 235, 0.4);
    }

    .detail-modal-backdrop {
      position: fixed;
      inset: 0;
      background: rgba(15, 23, 42, 0.45);
      display: none;
      align-items: center;
      justify-content: center;
      padding: 16px;
      z-index: 50;
    }
    .detail-modal-backdrop.show { display: flex; }
    .detail-modal {
      background: #ffffff;
      border-radius: 18px;
      max-width: 820px;
      width: 100%;
      max-height: 90vh;
      padding: 18px 20px 20px;
      box-shadow: 0 20px 40px rgba(15, 23, 42, 0.35);
      overflow: auto;
    }
    .detail-modal-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 8px;
      gap: 10px;
      flex-wrap: wrap;
    }
    .detail-modal-title { font-size: 18px; font-weight: 600; }
    .detail-modal-close {
      border-radius: 999px;
      border: none;
      padding: 6px 12px;
      font-size: 14px;
      cursor: pointer;
      background: #e5e7eb;
    }
    .detail-modal-body { font-size: 14px; color: #111827; }
    .detail-field { margin-bottom: 6px; }
    .detail-field strong { display: inline-block; min-width: 140px; color: #4b5563; }
    .detail-multiline { margin-top: 8px; margin-bottom: 8px; }
    .detail-multiline strong { display: block; margin-bottom: 2px; color: #4b5563; }
    .detail-multiline pre {
      margin: 0;
      padding: 8px 10px;
      background: #f9fafb;
      border-radius: 10px;
      border: 1px solid #e5e7eb;
      white-space: pre-wrap;
      word-break: break-word;
      font-family: inherit;
      font-size: 13px;
    }

    .auto-tpl-grid { display: grid; grid-template-columns: 1fr; gap: 10px; margin-top: 8px; }
    @media (min-width: 900px) { .auto-tpl-grid { grid-template-columns: 1fr 1fr; } }
    .auto-tpl-item {
      border: 1px solid #e5e7eb;
      background: #f9fafb;
      border-radius: 14px;
      padding: 10px 12px;
    }
    .auto-tpl-item-title {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 10px;
      margin-bottom: 8px;
      flex-wrap: wrap;
    }
    .auto-tpl-item-title .name { font-weight: 800; font-size: 14px; color: #111827; }
    .auto-tpl-item-title .key {
      font-size: 11px;
      color: #6b7280;
      background: #fff;
      border: 1px solid #e5e7eb;
      border-radius: 999px;
      padding: 2px 8px;
      white-space: nowrap;
    }
    .mini-btn { font-size: 12px; padding: 7px 12px; border-radius: 999px; }

    /* ç®¡ç†è€…å‘ã‘ã‚¨ãƒªã‚¢ï¼ˆè‰²åˆ†ã‘ï¼‰ */
    .admin-card{
      --admin-accent:#f59e0b;
      --admin-bg:#fff7ed;
      border-left: 12px solid var(--admin-accent);
      background: var(--admin-bg);
      position: relative;
    }
    .admin-badge{
      display:inline-flex;
      align-items:center;
      gap:6px;
      padding:4px 10px;
      border-radius:999px;
      font-size:12px;
      font-weight:800;
      border:1px solid rgba(0,0,0,0.08);
      background: rgba(255,255,255,0.7);
      white-space: nowrap;
    }
    .admin-note{ margin-top:6px; font-size:12px; color:#92400e; }
    .admin-manage { --admin-accent:#f59e0b; --admin-bg:#fff7ed; }
    .admin-danger { --admin-accent:#ef4444; --admin-bg:#fff1f2; }
    .admin-card input[type="text"], .admin-card input[type="date"], .admin-card select, .admin-card textarea{
      background: rgba(255,255,255,0.92);
    }
    .danger-hint{ box-shadow: 0 0 0 2px rgba(239,68,68,0.18) inset; }

    /* è¦‹å‡ºã—åˆ†é›¢ã®è¦‹ãŸç›®ï¼ˆåˆå¿ƒè€…å‘ã‘ï¼‰ */
    .section-split {
      border: 1px dashed #d1d5db;
      border-radius: 14px;
      padding: 12px 12px;
      background: rgba(255,255,255,0.65);
      margin-top: 8px;
    }
    .section-split-title {
      font-weight: 800;
      font-size: 14px;
      margin-bottom: 6px;
      color: #111827;
    }
  </style>
</head>
<body>
  <header>ã‚°ãƒ«ãƒ¼ãƒ—ãƒ›ãƒ¼ãƒ  å€‹äººè¨˜éŒ² WEBã‚¢ãƒ—ãƒªï¼ˆã‚¿ã‚°ãƒ»æ¤œç´¢ä»˜ãï¼‰</header>

  <main>
    <div class="layout">
      <!-- å…¥åŠ›ãƒ•ã‚©ãƒ¼ãƒ  -->
      <section class="card">
        <div class="card-title">
          <span>ä»Šæ—¥ã®å€‹äººè¨˜éŒ²</span>
          <span class="pill" id="modeLabel">æ–°è¦å…¥åŠ›ãƒ¢ãƒ¼ãƒ‰</span>
        </div>
        <div class="card-subtitle">
          åˆ©ç”¨è€…ã‚’é¸ã³ã€æ—¥ä¸­ã®æ§˜å­ãƒ»æ”¯æ´å†…å®¹ãƒ»æœè–¬çŠ¶æ³ãªã©ã‚’è¨˜éŒ²ã—ã¾ã™ã€‚<br>
          â€»åˆ©ç”¨è€…ã‚’é¸ã¶ã¨ã€ãã®äººã®ã€Œã‚ˆãä½¿ã†é …ç›®ï¼ˆè‡ªå‹•ONï¼‰ã€ãŒè‡ªå‹•ã§ONã«ãªã‚Šã¾ã™ã€‚
        </div>

        <form id="recordForm">
          <div class="field-row">
            <div class="field">
              <label for="date">æ—¥ä»˜</label>
              <input type="date" id="date" required />
            </div>
            <div class="field">
              <label for="resident">åˆ©ç”¨è€…</label>
              <select id="resident" required></select>
              <div class="small-text">â€»åˆ©ç”¨è€…ã‚’é¸ã¶ã¨ã€Œâ‘ è‡ªå‹•å…¥åŠ›æ”¯æ´é …ç›®ã€ã€Œâ‘¡æ—¥ä¸­æ”¯æ´ãƒã‚§ãƒƒã‚¯ã€ãŒè‡ªå‹•ã§ONã«ãªã‚Šã¾ã™ã€‚</div>
            </div>
          </div>

          <div class="field-row-3">
            <div class="field">
              <label for="timeSlot">æ™‚é–“å¸¯</label>
              <select id="timeSlot">
                <option>æ—¥ä¸­</option><option>å¤•æ–¹</option><option>å¤œé–“</option>
              </select>
              <div class="quick-row" data-target="timeSlot">
                <button type="button" class="quick-btn" data-value="æ—¥ä¸­">æ—¥ä¸­</button>
                <button type="button" class="quick-btn" data-value="å¤•æ–¹">å¤•æ–¹</button>
                <button type="button" class="quick-btn" data-value="å¤œé–“">å¤œé–“</button>
              </div>
              <div class="small-text">ä¸Šã®ãƒœã‚¿ãƒ³ã§é¸ã¹ã¾ã™ã€‚</div>
            </div>
            <div class="field">
              <label for="condition">ä½“èª¿</label>
              <select id="condition">
                <option>è‰¯å¥½</option><option>æ™®é€š</option><option>ä¸è‰¯</option>
              </select>
              <div class="quick-row" data-target="condition">
                <button type="button" class="quick-btn" data-value="è‰¯å¥½">ğŸ˜Š è‰¯å¥½</button>
                <button type="button" class="quick-btn" data-value="æ™®é€š">ğŸ˜ æ™®é€š</button>
                <button type="button" class="quick-btn" data-value="ä¸è‰¯">ğŸ˜Ÿ ä¸è‰¯</button>
              </div>
              <div class="small-text">ãƒœã‚¿ãƒ³ã§é¸ã¹ã¾ã™ã€‚</div>
            </div>
            <div class="field">
              <label for="mental">å¿ƒã®çŠ¶æ…‹</label>
              <select id="mental">
                <option>å®‰å®š</option><option>ã‚„ã‚„ä¸å®‰</option><option>ä¸å®‰å®š</option>
              </select>
              <div class="quick-row" data-target="mental">
                <button type="button" class="quick-btn" data-value="å®‰å®š">ğŸ˜Š å®‰å®š</button>
                <button type="button" class="quick-btn" data-value="ã‚„ã‚„ä¸å®‰">ğŸ˜ ã‚„ã‚„ä¸å®‰</button>
                <button type="button" class="quick-btn" data-value="ä¸å®‰å®š">ğŸ˜Ÿ ä¸å®‰å®š</button>
              </div>
              <div class="small-text">ãƒœã‚¿ãƒ³ã§é¸ã¹ã¾ã™ã€‚</div>
            </div>
          </div>

          <div class="field">
            <label for="meal">é£Ÿäº‹ã®æ§˜å­ï¼ˆæœãƒ»æ˜¼ãƒ»å¤• / æ‘‚å–é‡ãªã©ï¼‰</label>
            <input type="text" id="meal" placeholder="ä¾‹ï¼‰æœï¼šå®Œé£Ÿ / æ˜¼ï¼š7å‰² / å¤•ï¼šå°‘ãªã‚ ãªã©" />
          </div>

          <div class="field">
            <div class="checkbox-row">
              <label><input type="checkbox" id="medTaken" /> æœè–¬æ¸ˆã¿</label>
              <span class="small-text">ï¼ˆé£²ã¿å¿˜ã‚Œç­‰ã¯æ”¯æ´å†…å®¹ã«è¨˜å…¥ï¼‰</span>
            </div>
          </div>

          <div class="field">
            <label>ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ï¼ˆã‚¿ã‚°ï¼‰</label>
            <div class="tag-buttons" id="tagButtons"></div>
            <div class="small-text" id="selectedTagsInfo">é¸æŠä¸­ï¼šãªã—</div>
          </div>

          <!-- â‘  è‡ªå‹•å…¥åŠ›ï¼ˆæ–‡ç« è¿½è¨˜ï¼‰ -->
          <div class="field">
            <div style="display:flex; justify-content:space-between; align-items:center; gap:10px; flex-wrap:wrap;">
              <label style="margin-bottom:0;">â‘  è‡ªå‹•å…¥åŠ›ã—ãŸã„æ”¯æ´é …ç›®ï¼ˆãƒã‚§ãƒƒã‚¯ã—ãŸå®šå‹æ–‡ã ã‘ã‚’è¿½è¨˜ï¼‰</label>
              <button type="button" class="btn-secondary mini-btn" id="openResidentAutoTplBtn">ğŸ›  è‡ªå‹•ãƒ†ãƒ³ãƒ—ãƒ¬ç·¨é›†ï¼ˆåˆ©ç”¨è€…åˆ¥ï¼‰</button>
            </div>
            <div class="checkbox-row" id="autoItemCheckboxes"></div>
            <div class="small-text">
              ãƒ»ã€Œè‡ªå‹•ã€ãƒœã‚¿ãƒ³ â†’ ãƒã‚§ãƒƒã‚¯ã—ãŸé …ç›®ã®å®šå‹æ–‡ã ã‘ã‚’ã€Œè¿½è¨˜ã€ï¼ˆç½®ãæ›ãˆãªã—ï¼‰<br>
              ãƒ»ãƒ†ãƒ³ãƒ—ãƒ¬é¸æŠä¸­ â†’ ãƒ†ãƒ³ãƒ—ãƒ¬ã ã‘ã‚’è¿½è¨˜
            </div>
          </div>

          <!-- æ—¥ä¸­æ”¯æ´åŠ ç®— åŒºåˆ† -->
          <div class="field">
            <label for="daySupportType">æ—¥ä¸­æ”¯æ´åŠ ç®—ã®åŒºåˆ†</label>
            <select id="daySupportType">
              <option value="">é¸æŠãªã—</option>
              <option value="â… ">æ—¥ä¸­æ”¯æ´åŠ ç®—â… </option>
              <option value="â…¡">æ—¥ä¸­æ”¯æ´åŠ ç®—â…¡</option>
            </select>
            <div class="small-text">è©²å½“ã™ã‚‹å ´åˆã®ã¿é¸æŠã—ã¦ãã ã•ã„ã€‚</div>
          </div>

          <!-- â‘¡ æ—¥ä¸­æ”¯æ´ãƒã‚§ãƒƒã‚¯ï¼ˆç†ç”±ï¼†ä¸»ãªæ”¯æ´ï¼‰ -->
          <div class="field">
            <label>â‘¡ æ—¥ä¸­æ”¯æ´åŠ ç®—ã«é–¢ã‚ã‚‹çŠ¶æ³ãƒ»æ”¯æ´å†…å®¹ï¼ˆãƒã‚§ãƒƒã‚¯ç”¨ãƒ¡ãƒ¢ï¼‰</label>
            <div class="small-text" style="margin-bottom:6px;">
              â€»ã“ã“ã¯ã€Œãƒã‚§ãƒƒã‚¯ã®è¨˜éŒ²ã€ã§ã™ï¼ˆæ–‡ç« è¿½è¨˜ã¨ã¯åˆ¥ï¼‰ã€‚é …ç›®ã¯ã‚µã‚¤ãƒˆä¸Šã§ç·¨é›†ã§ãã¾ã™ã€‚
            </div>

            <div class="section-split">
              <div class="section-split-title">ã€æ—¥ä¸­æ´»å‹•ã«è¡Œã‘ãªã‹ã£ãŸç†ç”±ã€‘</div>
              <div class="checkbox-row" id="daySupportReasonCheckboxes"></div>
            </div>

            <div class="section-split">
              <div class="section-split-title">ã€æ—¥ä¸­ã«è¡Œã£ãŸä¸»ãªæ”¯æ´ã€‘</div>
              <div class="checkbox-row" id="daySupportSupportCheckboxes"></div>
            </div>
          </div>

          <div class="field">
            <label for="daySupportTime">æ—¥ä¸­æ”¯æ´ã®ä¸»ãªæ™‚é–“å¸¯ï¼ˆä»»æ„ï¼‰</label>
            <input type="text" id="daySupportTime" placeholder="ä¾‹ï¼‰9:00ã€œ15:00 ã®é–“ã€å±…å®¤ã¨å…±æœ‰ã‚¹ãƒšãƒ¼ã‚¹ã§ç¶™ç¶šçš„ã«è¦‹å®ˆã‚Šæ”¯æ´" />
          </div>

          <!-- è‡ªä½œãƒ†ãƒ³ãƒ—ãƒ¬ï¼ˆæ–‡ç« ï¼‰ -->
          <div class="field">
            <label>æ”¯æ´å†…å®¹ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆï¼ˆè‡ªä½œï¼‰</label>

            <div class="field-row">
              <div class="field">
                <label for="templateScope" class="small-text">ãƒ†ãƒ³ãƒ—ãƒ¬ã®å¯¾è±¡é …ç›®</label>
                <select id="templateScope">
                  <option value="common">å…±é€šï¼ˆã©ã®é …ç›®ã§ã‚‚ï¼‰</option>
                  <option value="med_manage">æœè–¬ç®¡ç†</option>
                  <option value="oral_check">å†…æœç¢ºèª</option>
                  <option value="bathing">å…¥æµ´</option>
                  <option value="day_support">æ—¥ä¸­æ”¯æ´åŠ ç®—</option>
                </select>
                <div class="small-text">å¯¾è±¡ã‚’é¸ã¶ã¨ã€ãã®é …ç›®ç”¨ã®ãƒ†ãƒ³ãƒ—ãƒ¬ä¸€è¦§ãŒä¸‹ã«è¡¨ç¤ºã•ã‚Œã¾ã™ã€‚</div>
              </div>
              <div class="field">
                <label for="templateNameInput" class="small-text">ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆå</label>
                <input type="text" id="templateNameInput" placeholder="ä¾‹ï¼šæœè–¬ç®¡ç†ãƒ»å®‰å®šãƒ‘ã‚¿ãƒ¼ãƒ³" />
                <div class="small-text">ä»Šã®ã€Œæœ¬æ—¥ã®æ”¯æ´å†…å®¹ãƒ»æ§˜å­ã€ã‚’ãƒ†ãƒ³ãƒ—ãƒ¬ã¨ã—ã¦ä¿å­˜ã—ã¾ã™ã€‚</div>
              </div>
            </div>

            <div class="field" style="margin-top:8px;">
              <select id="templateSelect"><option value="">é¸æŠã—ã¦ãã ã•ã„</option></select>
              <div class="small-text">
                ãƒ»ã€è‡ªå‹•ã€ã¯ãƒ†ãƒ³ãƒ—ãƒ¬ãŒé¸ã°ã‚Œã¦ã„ã‚Œã°ãƒ†ãƒ³ãƒ—ãƒ¬è¿½è¨˜ã€‚<br>
                ãƒ»æœªé¸æŠãªã‚‰â‘ ã®ãƒã‚§ãƒƒã‚¯å®šå‹æ–‡ã‚’è¿½è¨˜ã€‚<br>
                â€»ã„ãšã‚Œã‚‚ã€Œè¿½è¨˜ã€ã§ã€æ—¢å­˜æ–‡ç« ã¯æ¶ˆãˆã¾ã›ã‚“ã€‚
              </div>
            </div>

            <div class="btn-row">
              <button type="button" class="btn-secondary" id="templateApplyButton">ãƒ†ãƒ³ãƒ—ãƒ¬æŒ¿å…¥</button>
              <button type="button" class="btn-primary" id="templateSaveButton">ãƒ†ãƒ³ãƒ—ãƒ¬ä¿å­˜ / ä¸Šæ›¸ã</button>
              <button type="button" class="btn-danger" id="templateDeleteButton">é¸æŠãƒ†ãƒ³ãƒ—ãƒ¬å‰Šé™¤</button>
            </div>
            <div class="small-text">â€»ãƒ†ãƒ³ãƒ—ãƒ¬ã¯ã“ã®PCã®ãƒ–ãƒ©ã‚¦ã‚¶ã«ä¿å­˜ã•ã‚Œã¾ã™ã€‚</div>
          </div>

          <div class="field">
            <label for="support">æœ¬æ—¥ã®æ”¯æ´å†…å®¹ãƒ»æ§˜å­</label>
            <textarea id="support" rows="8" placeholder="ä¾‹ï¼‰
æ—¥ä¸­ã¯è½ã¡ç€ã„ã¦ç©ã‚„ã‹ã«éã”ã•ã‚Œã‚‹ã€‚é£Ÿäº‹ãƒ»æœè–¬ã¨ã‚‚ã«è¦‹å®ˆã‚Šä¸­å¿ƒã§å®Ÿæ–½ã€‚
å¿…è¦æ™‚ã®ã¿å£°ã‹ã‘ãƒ»ä»‹åŠ©ã‚’è¡Œã£ãŸã€‚"></textarea>
          </div>

          <div class="btn-row">
            <button type="button" class="btn-secondary" id="autoSupportBtn">è‡ªå‹•</button>
            <button type="button" class="btn-secondary" id="voiceSupportBtn">ğŸ™ éŸ³å£°å…¥åŠ›</button>
            <span class="small-text">
              ãƒ»ãƒ†ãƒ³ãƒ—ãƒ¬é¸æŠã‚ã‚Š â†’ ãƒ†ãƒ³ãƒ—ãƒ¬è¿½è¨˜<br>
              ãƒ»ãƒ†ãƒ³ãƒ—ãƒ¬æœªé¸æŠ â†’ â‘ ã®ãƒã‚§ãƒƒã‚¯å®šå‹æ–‡ã‚’è¿½è¨˜ï¼ˆåˆ©ç”¨è€…åˆ¥ä¸Šæ›¸ããŒã‚ã‚Œã°å„ªå…ˆï¼‰<br>
              ãƒ»ğŸ™ éŸ³å£°å…¥åŠ›ã‚‚è¿½è¨˜ã•ã‚Œã¾ã™
            </span>
          </div>
          <div class="small-text" id="voiceStatus" style="margin-top:4px;"></div>

          <div class="field">
            <label for="note">ç‰¹è¨˜äº‹é …ï¼ˆäº‹æ•…ãƒ»ãƒˆãƒ©ãƒ–ãƒ«ãƒ»å—è¨ºãƒ»ç›¸è«‡ãªã©ï¼‰</label>
            <textarea id="note" rows="4" placeholder="ä¾‹ï¼‰é€šé™¢ã€å®¶æ—ã‹ã‚‰ã®é›»è©±ã€å¤œé–“ã®è¦‹å®ˆã‚Šå¼·åŒ–ãŒå¿…è¦ ãªã©"></textarea>
          </div>

          <div class="btn-row">
            <button type="submit" class="btn-primary" id="saveButton">ğŸ’¾ è¨˜éŒ²ã‚’ä¿å­˜</button>
            <button type="button" class="btn-secondary" id="resetButton">ğŸ§¹ å…¥åŠ›ãƒªã‚»ãƒƒãƒˆ</button>
          </div>
        </form>
      </section>

      <!-- ä¸€è¦§è¡¨ç¤º -->
      <section class="card">
        <div class="card-title">
          <span>è¨˜éŒ²ä¸€è¦§</span>
          <div style="display:flex; align-items:center; gap:8px;">
            <button type="button" onclick="window.open('records.html', '_blank')" class="btn-secondary" style="font-size:12px; padding:6px 10px;">ğŸ“„ åˆ¥ãƒšãƒ¼ã‚¸ã§é–‹ã</button>
            <span class="record-count" id="recordCount">0ä»¶</span>
          </div>
        </div>

        <div class="resident-select-row">
          <span>è¡¨ç¤ºã™ã‚‹åˆ©ç”¨è€…ï¼š</span>
          <select id="filterResident"></select>
          <span class="small-text">â€»ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã§çµã‚Šè¾¼ã¿</span>
        </div>

        <div class="resident-select-row">
          <span>æœŸé–“ï¼š</span>
          <select id="periodFilter">
            <option value="today">ä»Šæ—¥</option>
            <option value="week">ç›´è¿‘7æ—¥é–“</option>
            <option value="month" selected>ä»Šæœˆ</option>
            <option value="year">ä»Šå¹´</option>
            <option value="all">å…¨æœŸé–“</option>
            <option value="custom">æ—¥ä»˜æŒ‡å®š</option>
          </select>
          <span class="small-text">â€»å…¨æœŸé–“ã¯ä»¶æ•°ãŒå¤šã„å ´åˆãŒã‚ã‚Šã¾ã™</span>
        </div>

        <div class="resident-select-row" id="customPeriodRow" style="display:none;">
          <span>æœŸé–“æŒ‡å®šï¼š</span>
          <input type="date" id="periodFrom">
          <span>ã€œ</span>
          <input type="date" id="periodTo">
          <button type="button" class="btn-secondary" id="applyCustomPeriod">åæ˜ </button>
        </div>

        <div class="resident-select-row">
          <span>ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰æ¤œç´¢ï¼š</span>
          <input type="text" id="searchKeyword" placeholder="ä¾‹ï¼šé€šé™¢, å¤œé–“, #ä½“èª¿ä¸è‰¯ ãªã©" style="flex:1; min-width:180px;" />
          <button type="button" class="btn-secondary" id="searchClearButton">ã‚¯ãƒªã‚¢</button>
        </div>

        <div class="table-wrapper" id="tableWrapper">
          <table>
            <thead>
              <tr>
                <th>æ—¥ä»˜</th>
                <th>åˆ©ç”¨è€…</th>
                <th>æ™‚é–“å¸¯</th>
                <th>ä½“èª¿ / å¿ƒã®çŠ¶æ…‹</th>
                <th>æ”¯æ´å†…å®¹ãƒ»ã‚¿ã‚°</th>
                <th>æœè–¬</th>
                <th>æ“ä½œ</th>
              </tr>
            </thead>
            <tbody id="recordTableBody"></tbody>
          </table>
        </div>
      </section>
    </div>

    <!-- åˆ©ç”¨è€…ç®¡ç†ï¼ˆç®¡ç†è€…å‘ã‘ï¼‰ -->
    <section class="card admin-card admin-manage">
      <div class="card-title">
        <span>åˆ©ç”¨è€…ç®¡ç†</span>
        <span class="admin-badge">ğŸ›  ç®¡ç†è€…å‘ã‘</span>
      </div>
      <div class="admin-note">â€»åˆå¿ƒè€…ã¯è§¦ã‚‰ãªã„ã§ãã ã•ã„ï¼ˆåå‰å¤‰æ›´ãƒ»å‰Šé™¤ã§è¨˜éŒ²ãƒ‡ãƒ¼ã‚¿ã«å½±éŸ¿ã—ã¾ã™ï¼‰</div>

      <div class="card-subtitle">åˆ©ç”¨è€…åã®è¿½åŠ ãƒ»å¤‰æ›´ãƒ»å‰Šé™¤ã‚’è¡Œã„ã¾ã™ã€‚</div>

      <div class="field-row">
        <div class="field">
          <label for="residentManageSelect">å¯¾è±¡ã®åˆ©ç”¨è€…</label>
          <select id="residentManageSelect"></select>
        </div>
        <div class="field">
          <label for="residentNameInput">åå‰ï¼ˆè¿½åŠ ãƒ»å¤‰æ›´å¾Œï¼‰</label>
          <input type="text" id="residentNameInput" placeholder="ä¾‹ï¼šAã•ã‚“" />
        </div>
      </div>

      <div class="btn-row">
        <button type="button" class="btn-primary" id="residentAddButton">ï¼‹ æ–°ã—ãè¿½åŠ </button>
        <button type="button" class="btn-secondary" id="residentRenameButton">âœï¸ é¸æŠã‚’ã“ã®åå‰ã«å¤‰æ›´</button>
        <button type="button" class="btn-danger" id="residentDeleteButton">ğŸ—‘ï¸ åˆ©ç”¨è€…ã¨è¨˜éŒ²ã‚’å‰Šé™¤</button>
      </div>
      <div class="small-text" style="margin-top:6px;">â€»å‰Šé™¤ã™ã‚‹ã¨ã€ãã®åˆ©ç”¨è€…ã®ã™ã¹ã¦ã®è¨˜éŒ²ã‚‚å‰Šé™¤ã•ã‚Œã¾ã™ã€‚</div>
    </section>

    <!-- ã‚ˆãä½¿ã†é …ç›® ç®¡ç†ï¼ˆåˆ©ç”¨è€…åˆ¥ï¼‰ï¼ˆç®¡ç†è€…å‘ã‘ï¼‰ -->
    <section class="card admin-card admin-manage">
      <div class="card-title">
        <span>ã‚ˆãä½¿ã†é …ç›® ç®¡ç†ï¼ˆåˆ©ç”¨è€…åˆ¥ï¼‰</span>
        <span class="admin-badge">ğŸ›  ç®¡ç†è€…å‘ã‘</span>
      </div>
      <div class="admin-note">â€»åˆå¿ƒè€…ã¯è§¦ã‚‰ãªã„ã§ãã ã•ã„ï¼ˆåˆ©ç”¨è€…é¸æŠæ™‚ã«è‡ªå‹•ONã«ãªã‚‹é …ç›®ãŒå¤‰ã‚ã‚Šã¾ã™ï¼‰</div>

      <div class="field-row">
        <div class="field">
          <label for="favManageResident">å¯¾è±¡ã®åˆ©ç”¨è€…</label>
          <select id="favManageResident"></select>
          <div class="small-text">ã“ã“ã§è¨­å®šã—ãŸé …ç›®ãŒã€ä¸Šã®ãƒ•ã‚©ãƒ¼ãƒ ã§åˆ©ç”¨è€…ã‚’é¸ã¶ã¨è‡ªå‹•ã§ONã«ãªã‚Šã¾ã™ã€‚</div>
        </div>

        <div class="field">
          <label>è‡ªå‹•ONé …ç›®ï¼ˆåˆ†é›¢ã—ã¦ã‚ã‹ã‚Šã‚„ã™ãï¼‰</label>

          <div class="section-split">
            <div class="section-split-title">â‘  è‡ªå‹•å…¥åŠ›ï¼ˆæ–‡ç« è¿½è¨˜ï¼‰</div>
            <div class="checkbox-row" id="favManageCheckboxes"></div>
          </div>

          <div class="section-split">
            <div class="section-split-title">â‘¡ æ—¥ä¸­æ”¯æ´ãƒã‚§ãƒƒã‚¯ï¼šç†ç”±</div>
            <div class="checkbox-row" id="favManageDayReason"></div>
          </div>

          <div class="section-split">
            <div class="section-split-title">â‘¡ æ—¥ä¸­æ”¯æ´ãƒã‚§ãƒƒã‚¯ï¼šä¸»ãªæ”¯æ´</div>
            <div class="checkbox-row" id="favManageDaySupport"></div>
          </div>
        </div>
      </div>

      <div class="btn-row">
        <button type="button" class="btn-primary" id="favManageSaveBtn">ğŸ’¾ ã“ã®åˆ©ç”¨è€…ã®è¨­å®šã‚’ä¿å­˜</button>
        <button type="button" class="btn-secondary danger-hint" id="favManageResetBtn">â†© ã“ã®åˆ©ç”¨è€…ã‚’åˆæœŸã«æˆ»ã™</button>
      </div>
      <div class="small-text">â€»ã€ŒåˆæœŸã«æˆ»ã™ã€ã¯ã€ã“ã®åˆ©ç”¨è€…ã®â€œè‡ªå‹•ONè¨­å®šâ€ã ã‘ã‚’ãƒªã‚»ãƒƒãƒˆï¼ˆè¨˜éŒ²ã¯æ¶ˆãˆã¾ã›ã‚“ï¼‰ã€‚</div>
    </section>

    <!-- è‡ªå‹•å…¥åŠ›ã®æ”¯æ´é …ç›® ç®¡ç†ï¼ˆç®¡ç†è€…å‘ã‘ï¼‰ -->
    <section class="card admin-card admin-manage">
      <div class="card-title">
        <span>è‡ªå‹•å…¥åŠ›ã®æ”¯æ´é …ç›® ç®¡ç†ï¼ˆã‚µã‚¤ãƒˆä¸Šã§è¿½åŠ ãƒ»ç·¨é›†ãƒ»å‰Šé™¤ï¼‰</span>
        <span class="admin-badge">ğŸ›  ç®¡ç†è€…å‘ã‘</span>
      </div>
      <div class="admin-note">â€»åˆå¿ƒè€…ã¯è§¦ã‚‰ãªã„ã§ãã ã•ã„ï¼ˆæ–‡ç« ãƒ»é …ç›®ãŒå¤‰ã‚ã‚Šã¾ã™ï¼‰</div>
      <div class="card-subtitle">ã“ã“ã§è¿½åŠ ã—ãŸé …ç›®ã¯ã€ä¸Šã®ã€Œâ‘  è‡ªå‹•å…¥åŠ›æ”¯æ´é …ç›®ã€ã«è¡¨ç¤ºã•ã‚Œã¾ã™ã€‚</div>

      <div class="field-row">
        <div class="field">
          <label for="autoItemSelect">æ—¢å­˜é …ç›®ï¼ˆç·¨é›†ã—ãŸã„å ´åˆã«é¸æŠï¼‰</label>
          <select id="autoItemSelect"><option value="">ï¼ˆæ–°è¦è¿½åŠ ï¼‰</option></select>
          <div class="small-text">é¸ã¶ã¨ä¸‹ã®å…¥åŠ›æ¬„ã«å†…å®¹ãŒå…¥ã‚Šã¾ã™ã€‚</div>
        </div>
        <div class="field">
          <label for="autoItemKey">å†…éƒ¨ã‚­ãƒ¼ï¼ˆè‹±æ•°å­—ãƒ»é‡è¤‡ä¸å¯ï¼‰</label>
          <input type="text" id="autoItemKey" placeholder="ä¾‹ï¼šmoney_support" />
          <div class="small-text">â€»æœ€åˆã«æ±ºã‚ãŸã‚‰åŸºæœ¬å¤‰æ›´ã—ãªã„ã®ãŒå®‰å…¨ã§ã™ã€‚</div>
        </div>
      </div>

      <div class="field-row">
        <div class="field">
          <label for="autoItemLabel">è¡¨ç¤ºå</label>
          <input type="text" id="autoItemLabel" placeholder="ä¾‹ï¼šé‡‘éŠ­ç®¡ç†" />
        </div>
        <div class="field">
          <label for="autoItemText">è‡ªå‹•ã§è¿½è¨˜ã™ã‚‹å®šå‹æ–‡</label>
          <textarea id="autoItemText" rows="3" placeholder="ä¾‹ï¼šã€é‡‘éŠ­ç®¡ç†ã€‘é‡‘éŠ­ã®ç¢ºèªã¨å£°ã‹ã‘ã‚’è¡Œã„ã€å¿…è¦ã«å¿œã˜ã¦æ”¯æ´ã—ãŸã€‚"></textarea>
          <div class="small-text">ç½®æ›ï¼š<b>{{daySupportTypeLabel}}</b> â†’ æ—¥ä¸­æ”¯æ´åŠ ç®—â… /â…¡</div>
        </div>
      </div>

      <div class="btn-row">
        <button type="button" class="btn-primary" id="autoItemSaveBtn">ğŸ’¾ è¿½åŠ  / æ›´æ–°</button>
        <button type="button" class="btn-danger" id="autoItemDeleteBtn">ğŸ—‘ï¸ é¸æŠé …ç›®ã‚’å‰Šé™¤</button>
        <button type="button" class="btn-secondary" id="autoItemClearBtn">ğŸ§¹ å…¥åŠ›ã‚¯ãƒªã‚¢</button>
        <button type="button" class="btn-secondary danger-hint" id="autoItemResetDefaultBtn">â†© åˆæœŸé …ç›®ã«æˆ»ã™</button>
      </div>
    </section>

    <!-- â˜…è¿½åŠ ï¼šæ—¥ä¸­æ”¯æ´ãƒã‚§ãƒƒã‚¯é …ç›® ç®¡ç†ï¼ˆç†ç”±/ä¸»ãªæ”¯æ´ï¼‰ -->
    <section class="card admin-card admin-manage">
      <div class="card-title">
        <span>æ—¥ä¸­æ”¯æ´ãƒã‚§ãƒƒã‚¯é …ç›® ç®¡ç†ï¼ˆç†ç”± / ä¸»ãªæ”¯æ´ï¼‰</span>
        <span class="admin-badge">ğŸ›  ç®¡ç†è€…å‘ã‘</span>
      </div>
      <div class="admin-note">â€»åˆå¿ƒè€…ã¯è§¦ã‚‰ãªã„ã§ãã ã•ã„ï¼ˆãƒã‚§ãƒƒã‚¯é …ç›®ãŒå¤‰ã‚ã‚Šã¾ã™ï¼‰</div>
      <div class="card-subtitle">
        ã“ã“ã§ç·¨é›†ã—ãŸå†…å®¹ã¯ã€ä¸Šã®ã€Œâ‘¡ æ—¥ä¸­æ”¯æ´ãƒã‚§ãƒƒã‚¯ï¼ˆç†ç”±/ä¸»ãªæ”¯æ´ï¼‰ã€ã¨ã€Œã‚ˆãä½¿ã†é …ç›® ç®¡ç†ï¼ˆåˆ©ç”¨è€…åˆ¥ï¼‰ã€ã«åæ˜ ã•ã‚Œã¾ã™ã€‚
      </div>

      <div class="field-row">
        <div class="field">
          <label for="dayItemSelect">æ—¢å­˜é …ç›®ï¼ˆç·¨é›†ã—ãŸã„å ´åˆã«é¸æŠï¼‰</label>
          <select id="dayItemSelect"><option value="">ï¼ˆæ–°è¦è¿½åŠ ï¼‰</option></select>
          <div class="small-text">é¸ã¶ã¨ä¸‹ã®å…¥åŠ›æ¬„ã«å†…å®¹ãŒå…¥ã‚Šã¾ã™ã€‚</div>
        </div>
        <div class="field">
          <label for="dayItemGroup">åˆ†é¡</label>
          <select id="dayItemGroup">
            <option value="reason">ç†ç”±ï¼ˆè¡Œã‘ãªã‹ã£ãŸç†ç”±ï¼‰</option>
            <option value="support">ä¸»ãªæ”¯æ´ï¼ˆè¡Œã£ãŸæ”¯æ´ï¼‰</option>
          </select>
          <div class="small-text">ã©ã¡ã‚‰ã®æ ã«è¡¨ç¤ºã™ã‚‹ã‹ã‚’é¸ã³ã¾ã™ã€‚</div>
        </div>
      </div>

      <div class="field-row">
        <div class="field">
          <label for="dayItemKey">å†…éƒ¨ã‚­ãƒ¼ï¼ˆè‹±æ•°å­—ãƒ»é‡è¤‡ä¸å¯ï¼‰</label>
          <input type="text" id="dayItemKey" placeholder="ä¾‹ï¼šreason_health" />
          <div class="small-text">â€»ç©ºã§ã‚‚OKï¼ˆè‡ªå‹•ã§ä½œã‚Šã¾ã™ï¼‰</div>
        </div>
        <div class="field">
          <label for="dayItemLabel">è¡¨ç¤ºåï¼ˆãƒã‚§ãƒƒã‚¯é …ç›®ã®æ–‡è¨€ï¼‰</label>
          <input type="text" id="dayItemLabel" placeholder="ä¾‹ï¼šä½“èª¿ä¸è‰¯ã§æ—¥ä¸­æ´»å‹•ã‚’æ¬ å¸­" />
        </div>
      </div>

      <div class="btn-row">
        <button type="button" class="btn-primary" id="dayItemSaveBtn">ğŸ’¾ è¿½åŠ  / æ›´æ–°</button>
        <button type="button" class="btn-danger" id="dayItemDeleteBtn">ğŸ—‘ï¸ é¸æŠé …ç›®ã‚’å‰Šé™¤</button>
        <button type="button" class="btn-secondary" id="dayItemClearBtn">ğŸ§¹ å…¥åŠ›ã‚¯ãƒªã‚¢</button>
        <button type="button" class="btn-secondary danger-hint" id="dayItemResetDefaultBtn">â†© åˆæœŸé …ç›®ã«æˆ»ã™</button>
      </div>
    </section>
  </main>

  <!-- è¨˜éŒ²ã®è©³ç´°ãƒ¢ãƒ¼ãƒ€ãƒ« -->
  <div id="detailModal" class="detail-modal-backdrop">
    <div class="detail-modal">
      <div class="detail-modal-header">
        <div class="detail-modal-title" id="detailModalTitle">è¨˜éŒ²ã®è©³ç´°</div>
        <button type="button" class="detail-modal-close" id="detailModalClose">Ã— é–‰ã˜ã‚‹</button>
      </div>
      <div class="detail-modal-body" id="detailModalContent"></div>
    </div>
  </div>

  <!-- è‡ªå‹•ãƒ†ãƒ³ãƒ—ãƒ¬ç·¨é›†ï¼ˆåˆ©ç”¨è€…åˆ¥ï¼‰ãƒ¢ãƒ¼ãƒ€ãƒ« -->
  <div id="residentAutoTplModal" class="detail-modal-backdrop">
    <div class="detail-modal">
      <div class="detail-modal-header">
        <div>
          <div class="detail-modal-title">ğŸ›  è‡ªå‹•ãƒ†ãƒ³ãƒ—ãƒ¬ç·¨é›†ï¼ˆåˆ©ç”¨è€…åˆ¥ï¼‰</div>
          <div class="small-text">ã“ã®å°çª“ã§ã€Œè‡ªå‹•ONã€ã¨ã€Œæ–‡ç« ä¸Šæ›¸ãã€ã‚’ç·¨é›†ã§ãã¾ã™ã€‚</div>
        </div>
        <div style="display:flex; gap:8px; align-items:center; flex-wrap:wrap;">
          <button type="button" class="detail-modal-close" id="residentAutoTplCloseBtn">Ã— é–‰ã˜ã‚‹</button>
        </div>
      </div>

      <div class="detail-modal-body">
        <div class="resident-select-row" style="margin-top:6px;">
          <span>ç·¨é›†ã™ã‚‹åˆ©ç”¨è€…ï¼š</span>
          <select id="residentAutoTplResident"></select>
          <span class="small-text">ï¼ˆãƒ•ã‚©ãƒ¼ãƒ ã®é¸æŠãŒè‡ªå‹•ã§å…¥ã‚Šã¾ã™ï¼‰</span>
        </div>

        <div class="card" style="box-shadow:none; margin:10px 0 0; padding:14px 14px; border:1px solid #e5e7eb;">
          <div style="font-weight:900; margin-bottom:6px;">âœ… è‡ªå‹•ONï¼ˆâ‘  è‡ªå‹•å…¥åŠ›ï¼šæ–‡ç« è¿½è¨˜ï¼‰</div>
          <div class="checkbox-row" id="residentFavCheckboxes"></div>
          <div class="small-text">â€»ã“ã“ã§ãƒã‚§ãƒƒã‚¯ã—ãŸé …ç›®ãŒã€åˆ©ç”¨è€…é¸æŠæ™‚ã«è‡ªå‹•ã§ONã«ãªã‚Šã¾ã™ã€‚</div>
        </div>

        <!-- â˜…è¿½åŠ ï¼šæ—¥ä¸­æ”¯æ´ãƒã‚§ãƒƒã‚¯ã‚‚è‡ªå‹•ONå¯¾è±¡ã« -->
        <div class="card" style="box-shadow:none; margin:10px 0 0; padding:14px 14px; border:1px solid #e5e7eb;">
          <div style="font-weight:900; margin-bottom:6px;">âœ… è‡ªå‹•ONï¼ˆâ‘¡ æ—¥ä¸­æ”¯æ´ãƒã‚§ãƒƒã‚¯ï¼šç†ç”±ï¼‰</div>
          <div class="checkbox-row" id="residentDayReasonFav"></div>
          <div style="font-weight:900; margin:12px 0 6px;">âœ… è‡ªå‹•ONï¼ˆâ‘¡ æ—¥ä¸­æ”¯æ´ãƒã‚§ãƒƒã‚¯ï¼šä¸»ãªæ”¯æ´ï¼‰</div>
          <div class="checkbox-row" id="residentDaySupportFav"></div>
          <div class="small-text">â€»ã“ã“ã§ãƒã‚§ãƒƒã‚¯ã—ãŸé …ç›®ãŒã€åˆ©ç”¨è€…é¸æŠæ™‚ã«è‡ªå‹•ã§ONã«ãªã‚Šã¾ã™ã€‚</div>
        </div>

        <div class="card" style="box-shadow:none; margin:10px 0 0; padding:14px 14px; border:1px solid #e5e7eb;">
          <div style="font-weight:900; margin-bottom:6px;">ğŸ“ æ–‡ç« ä¸Šæ›¸ãï¼ˆåˆ©ç”¨è€…åˆ¥ï¼šä»»æ„ï¼‰</div>
          <div class="small-text">ç©ºæ¬„ã®ã¾ã¾ä¿å­˜ã™ã‚‹ã¨ã€ãã®é …ç›®ã¯ã€Œå…±é€šã®å®šå‹æ–‡ã€ãŒä½¿ã‚ã‚Œã¾ã™ã€‚</div>
          <div class="auto-tpl-grid" id="residentAutoTplTextGrid"></div>
        </div>

        <div class="btn-row">
          <button type="button" class="btn-primary" id="residentAutoTplSaveBtn">ğŸ’¾ ã“ã®åˆ©ç”¨è€…ã®è¨­å®šã‚’ä¿å­˜</button>
          <button type="button" class="btn-secondary danger-hint" id="residentAutoTplResetBtn">â†© ã“ã®åˆ©ç”¨è€…ã‚’åˆæœŸã«æˆ»ã™</button>
        </div>
        <div class="small-text">â€»ã€ŒåˆæœŸã«æˆ»ã™ã€ã¯ã€ã“ã®åˆ©ç”¨è€…ã®â€œè‡ªå‹•ONâ€ã¨â€œæ–‡ç« ä¸Šæ›¸ãâ€ã®ã¿ãƒªã‚»ãƒƒãƒˆã—ã¾ã™ã€‚</div>
      </div>
    </div>
  </div>

  <script>
    const STORAGE_KEY   = "group_home_records_v1";
    const RESIDENTS_KEY = "group_home_residents_v1";
    const TEMPLATES_KEY = "group_home_support_templates_v1";

    const AUTO_ITEM_DEFS_KEY = "group_home_auto_item_defs_v1";
    const RESIDENT_AUTO_TPL_KEY = "group_home_resident_auto_templates_v2";

    // â˜…è¿½åŠ ï¼šæ—¥ä¸­æ”¯æ´ãƒã‚§ãƒƒã‚¯é …ç›®ï¼ˆç†ç”±/ä¸»ãªæ”¯æ´ï¼‰ã‚’ç·¨é›†å¯èƒ½ã«
    const DAY_SUPPORT_DEFS_KEY = "group_home_day_support_defs_v1";

    const DEFAULT_AUTO_ITEM_DEFS = [
      { key: "med_manage", label: "æœè–¬ç®¡ç†", defaultText: "ã€æœè–¬ç®¡ç†ã€‘å‡¦æ–¹è–¬ã¯äº‹å‹™æ‰€ã«ã¦ä¸€æ‹¬ç®¡ç†ã—ã€æœè–¬æ™‚ã«è·å“¡ãŒæ‰‹æ¸¡ã—å¯¾å¿œã‚’è¡Œã£ãŸã€‚" },
      { key: "oral_check", label: "å†…æœç¢ºèª", defaultText: "ã€å†…æœç¢ºèªã€‘æœè–¬æ™‚ã¯è·å“¡ãŒæ‰‹æ¸¡ã—ã€ç›®ã®å‰ã§é£²ã‚“ã§é ‚ãå†…æœç¢ºèªã‚’è¡Œã£ãŸã€‚" },
      { key: "bathing", label: "å…¥æµ´", defaultText: "ã€å…¥æµ´ã€‘å…¥æµ´ã®å£°ã‹ã‘ã¨æº–å‚™ã®ä¸€éƒ¨ä»‹åŠ©ã‚’è¡Œã„ã€æœ¬äººã®ãƒšãƒ¼ã‚¹ã‚’å°Šé‡ã—ãªãŒã‚‰è¦‹å®ˆã£ãŸã€‚" },
      { key: "day_support", label: "æ—¥ä¸­æ”¯æ´åŠ ç®—", defaultText: "ã€æ—¥ä¸­æ”¯æ´åŠ ç®—ã€‘{{daySupportTypeLabel}}ã®å¯¾è±¡ã¨ã—ã¦ã€æ—¥ä¸­ã‚‚ã‚°ãƒ«ãƒ¼ãƒ—ãƒ›ãƒ¼ãƒ å†…ã§è¦‹å®ˆã‚Šãƒ»å£°ã‹ã‘ãƒ»èª˜å°ç­‰ã®æ”¯æ´ã‚’ç¶™ç¶šã—ã¦å®Ÿæ–½ã—ãŸã€‚" }
    ];

    // â˜…åˆæœŸï¼šæ—¥ä¸­æ”¯æ´ãƒã‚§ãƒƒã‚¯ï¼ˆç†ç”±/ä¸»ãªæ”¯æ´ï¼‰
    const DEFAULT_DAY_SUPPORT_DEFS = {
      reasons: [
        { key: "reason_health",   label: "ä½“èª¿ä¸è‰¯ã§æ—¥ä¸­æ´»å‹•ã‚’æ¬ å¸­" },
        { key: "reason_closed",   label: "é€šæ‰€å…ˆãƒ»å°±åŠ´å…ˆãŒä¼‘ã¿ã‚„è‡¨æ™‚ä¼‘æ¥­ã§åœ¨å®…" },
        { key: "reason_behavior", label: "éšœå®³ç‰¹æ€§ã‚„è¡Œå‹•é¢ã®ä¸å®‰ã§æ—¥ä¸­æ´»å‹•åˆ©ç”¨ãŒå›°é›£" },
        { key: "reason_doctor",   label: "åŒ»å¸«ã®æŒ‡ç¤ºã§å¤–å‡ºã‚„é€šæ‰€ã‚’æ§ãˆã¦ã„ã‚‹" }
      ],
      supports: [
        { key: "support_health_manage",  label: "ä½“èª¿ç®¡ç†ï¼ˆæ¤œæ¸©ãƒ»ç—‡çŠ¶ç¢ºèªãƒ»å®‰é™ã®è¦‹å®ˆã‚Šãªã©ï¼‰" },
        { key: "support_meal",           label: "é£Ÿäº‹ã®æ”¯æ´ï¼ˆæº–å‚™ãƒ»é…è†³ãƒ»ä»‹åŠ©ï¼‰" },
        { key: "support_med",            label: "æœè–¬ç®¡ç†ãƒ»å†…æœç¢ºèª" },
        { key: "support_water_toilet",   label: "æ°´åˆ†ãƒ»ãƒˆã‚¤ãƒ¬ã®å£°ã‹ã‘ãƒ»ä»‹åŠ©" },
        { key: "support_hygiene",        label: "å…¥æµ´ãƒ»æ¸…æ½”ä¿æŒã®æ”¯æ´" },
        { key: "support_safety",         label: "è¡Œå‹•ã‚„å®‰å…¨é¢ã®è¦‹å®ˆã‚Š" },
        { key: "support_mental",         label: "å¿ƒç†é¢ã®æ”¯æ´ã‚„ç›¸è«‡" },
        { key: "support_rhythm",         label: "æ—¥ä¸­ã®æ´»å‹•æ”¯æ´ãƒ»ç”Ÿæ´»ãƒªã‚ºãƒ ã®èª¿æ•´" }
      ]
    };

    const TAG_LIST = ["æœè–¬","é€šé™¢","å…¥æµ´","å¤–å‡º","ä½“èª¿ä¸è‰¯","ç›¸è«‡","ä»•äº‹","æƒé™¤","é‡‘éŠ­","å¤œé–“å¯¾å¿œ"];

    let records = [];
    let residents = [];
    let currentTags = [];
    let editingIndex = null;
    let templates = [];

    let AUTO_ITEM_DEFS = [];
    let residentAutoTpl = {}; // { resident: { favorites:[], texts:{}, daySupportFavorites:[] } }

    let daySupportDefs = { reasons: [], supports: [] };

    function safeJSONParse(raw, fallback) {
      try { if (!raw) return fallback; const parsed = JSON.parse(raw); return parsed ?? fallback; }
      catch { return fallback; }
    }

    function loadAutoItemDefs() {
      const raw = localStorage.getItem(AUTO_ITEM_DEFS_KEY);
      if (raw) {
        const parsed = safeJSONParse(raw, null);
        if (Array.isArray(parsed)) return parsed;
      }
      localStorage.setItem(AUTO_ITEM_DEFS_KEY, JSON.stringify(DEFAULT_AUTO_ITEM_DEFS));
      return DEFAULT_AUTO_ITEM_DEFS.slice();
    }
    function saveAutoItemDefs() { localStorage.setItem(AUTO_ITEM_DEFS_KEY, JSON.stringify(AUTO_ITEM_DEFS)); }

    function loadDaySupportDefs() {
      const raw = localStorage.getItem(DAY_SUPPORT_DEFS_KEY);
      if (raw) {
        const parsed = safeJSONParse(raw, null);
        if (parsed && typeof parsed === "object") {
          const reasons = Array.isArray(parsed.reasons) ? parsed.reasons : [];
          const supports = Array.isArray(parsed.supports) ? parsed.supports : [];
          return { reasons, supports };
        }
      }
      localStorage.setItem(DAY_SUPPORT_DEFS_KEY, JSON.stringify(DEFAULT_DAY_SUPPORT_DEFS));
      return { reasons: DEFAULT_DAY_SUPPORT_DEFS.reasons.slice(), supports: DEFAULT_DAY_SUPPORT_DEFS.supports.slice() };
    }
    function saveDaySupportDefs() { localStorage.setItem(DAY_SUPPORT_DEFS_KEY, JSON.stringify(daySupportDefs)); }

    function loadResidentAutoTpl() {
      const raw = localStorage.getItem(RESIDENT_AUTO_TPL_KEY);
      const obj = safeJSONParse(raw, {});
      return (obj && typeof obj === "object" && !Array.isArray(obj)) ? obj : {};
    }
    function saveResidentAutoTpl() { localStorage.setItem(RESIDENT_AUTO_TPL_KEY, JSON.stringify(residentAutoTpl)); }

    function getResidentAutoData(name) {
      if (!name) return { favorites: [], texts: {}, daySupportFavorites: [] };
      const data = residentAutoTpl[name];
      if (!data || typeof data !== "object") return { favorites: [], texts: {}, daySupportFavorites: [] };

      const favorites = Array.isArray(data.favorites) ? data.favorites : [];
      const texts = (data.texts && typeof data.texts === "object") ? data.texts : {};
      const daySupportFavorites = Array.isArray(data.daySupportFavorites) ? data.daySupportFavorites : [];
      return { favorites, texts, daySupportFavorites };
    }

    function setResidentAutoData(name, data) {
      if (!name) return;
      residentAutoTpl[name] = {
        favorites: Array.isArray(data.favorites) ? data.favorites : [],
        texts: (data.texts && typeof data.texts === "object") ? data.texts : {},
        daySupportFavorites: Array.isArray(data.daySupportFavorites) ? data.daySupportFavorites : []
      };
      saveResidentAutoTpl();
    }

    function mergeResidentAutoData(a, b) {
      const favA = Array.isArray(a?.favorites) ? a.favorites : [];
      const favB = Array.isArray(b?.favorites) ? b.favorites : [];
      const favorites = Array.from(new Set([...favA, ...favB]));

      const textsA = (a?.texts && typeof a.texts === "object") ? a.texts : {};
      const textsB = (b?.texts && typeof b.texts === "object") ? b.texts : {};
      const texts = { ...textsB, ...textsA }; // aå„ªå…ˆ

      const dsA = Array.isArray(a?.daySupportFavorites) ? a.daySupportFavorites : [];
      const dsB = Array.isArray(b?.daySupportFavorites) ? b.daySupportFavorites : [];
      const daySupportFavorites = Array.from(new Set([...dsA, ...dsB]));

      return { favorites, texts, daySupportFavorites };
    }

    function deleteResidentAutoData(name) {
      if (!name) return;
      delete residentAutoTpl[name];
      saveResidentAutoTpl();
    }

    function loadRecords() {
      const raw = localStorage.getItem(STORAGE_KEY);
      const parsed = safeJSONParse(raw, []);
      return Array.isArray(parsed) ? parsed : [];
    }
    function saveRecords() { localStorage.setItem(STORAGE_KEY, JSON.stringify(records)); }

    function loadResidents() {
      const raw = localStorage.getItem(RESIDENTS_KEY);
      const parsed = safeJSONParse(raw, null);
      if (Array.isArray(parsed) && parsed.length > 0) return parsed;
      const fromRecords = Array.from(new Set(records.map((r) => r.resident).filter(Boolean)));
      if (fromRecords.length > 0) return fromRecords;
      return ["åˆ©ç”¨è€…A","åˆ©ç”¨è€…B","åˆ©ç”¨è€…C","åˆ©ç”¨è€…D","åˆ©ç”¨è€…E","åˆ©ç”¨è€…F","åˆ©ç”¨è€…G"];
    }
    function saveResidents() { localStorage.setItem(RESIDENTS_KEY, JSON.stringify(residents)); }

    function renderResidentSelects() {
      const residentSelect = document.getElementById("resident");
      const filterSelect = document.getElementById("filterResident");
      const manageSelect = document.getElementById("residentManageSelect");
      const favManageSelect = document.getElementById("favManageResident");
      const modalResidentSelect = document.getElementById("residentAutoTplResident");

      const fill = (sel, list, withAll=false) => {
        if (!sel) return;
        const current = sel.value;
        sel.innerHTML = "";
        const first = document.createElement("option");
        first.value = "";
        first.textContent = withAll ? "å…¨å“¡" : "é¸æŠã—ã¦ãã ã•ã„";
        sel.appendChild(first);
        list.forEach((name) => {
          const opt = document.createElement("option");
          opt.value = name;
          opt.textContent = name;
          sel.appendChild(opt);
        });
        sel.value = (current && list.includes(current)) ? current : "";
      };

      fill(residentSelect, residents, false);
      fill(filterSelect, residents, true);
      fill(manageSelect, residents, false);
      fill(favManageSelect, residents, false);
      fill(modalResidentSelect, residents, false);
    }

    function formatSupportSummary(text) {
      if (!text) return "";
      const trimmed = text.trim().replace(/\s+/g, " ");
      return trimmed.length <= 40 ? trimmed : (trimmed.slice(0, 40) + "â€¦");
    }
    function getTimeBadgeClass(timeSlot) {
      if (timeSlot === "å¤•æ–¹") return "badge-evening";
      if (timeSlot === "å¤œé–“") return "badge-night";
      return "badge-day";
    }

    function daySupportLabelByKey(keyOrLabel) {
      const all = [...daySupportDefs.reasons, ...daySupportDefs.supports];
      const byKey = all.find(x => x.key === keyOrLabel);
      if (byKey) return byKey.label;
      const byLabel = all.find(x => x.label === keyOrLabel);
      if (byLabel) return byLabel.label;
      return keyOrLabel || "";
    }

    function normalizeDaySupportSelections(arr) {
      const input = Array.isArray(arr) ? arr : [];
      const all = [...daySupportDefs.reasons, ...daySupportDefs.supports];
      const out = [];
      input.forEach(v => {
        if (!v) return;
        if (all.some(x => x.key === v)) out.push(v);
        else {
          const hit = all.find(x => x.label === v);
          if (hit) out.push(hit.key);
        }
      });
      return Array.from(new Set(out));
    }

    function renderRecords() {
      const tbody = document.getElementById("recordTableBody");
      const filterResident = document.getElementById("filterResident").value;
      const keyword = document.getElementById("searchKeyword").value.trim().toLowerCase();
      const periodFilter = document.getElementById("periodFilter")?.value || "month";
      const periodFrom = document.getElementById("periodFrom")?.value || "";
      const periodTo = document.getElementById("periodTo")?.value || "";

      const today = new Date();
      const todayStr = today.toISOString().slice(0, 10);
      const monthPrefix = todayStr.slice(0, 7);
      const yearPrefix = todayStr.slice(0, 4);
      const weekStart = new Date(today); weekStart.setDate(weekStart.getDate() - 6);

      tbody.innerHTML = "";

      const filtered = records.filter((r) => {
        if (filterResident && r.resident !== filterResident) return false;

        const dateStr = r.date;
        if (dateStr) {
          if (periodFilter === "today" && dateStr !== todayStr) return false;
          if (periodFilter === "week") {
            const d = new Date(dateStr);
            if (isNaN(d)) return false;
            if (d < weekStart || d > today) return false;
          }
          if (periodFilter === "month" && dateStr.slice(0, 7) !== monthPrefix) return false;
          if (periodFilter === "year" && dateStr.slice(0, 4) !== yearPrefix) return false;
          if (periodFilter === "custom") {
            if (periodFrom && dateStr < periodFrom) return false;
            if (periodTo && dateStr > periodTo) return false;
          }
        } else {
          if (periodFilter !== "all") return false;
        }

        if (keyword) {
          const tagsText = (r.tags || []).join(" ");
          const dsLabels = (r.daySupportItems || []).map(daySupportLabelByKey).join(" ");
          const target = (((r.support || "") + " " + (r.note || "") + " " + (r.meal || "") + " " + tagsText + " " + dsLabels)).toLowerCase();
          if (!target.includes(keyword)) return false;
        }

        return true;
      });

      document.getElementById("recordCount").textContent = filtered.length + "ä»¶";

      if (filtered.length === 0) {
        const tr = document.createElement("tr");
        const td = document.createElement("td");
        td.colSpan = 7;
        td.className = "no-records";
        td.textContent = "ã¾ã è¨˜éŒ²ãŒã‚ã‚Šã¾ã›ã‚“ã€‚å·¦ã®ãƒ•ã‚©ãƒ¼ãƒ ã‹ã‚‰ç™»éŒ²ã™ã‚‹ã‹ã€æ¡ä»¶ã‚’å¤‰ãˆã¦ã¿ã¦ãã ã•ã„ã€‚";
        tr.appendChild(td);
        tbody.appendChild(tr);
        return;
      }

      filtered.slice().sort((a, b) => (a.date < b.date ? 1 : -1)).forEach((record) => {
        const tr = document.createElement("tr");

        const tdDate = document.createElement("td");
        tdDate.textContent = record.date || "";
        tr.appendChild(tdDate);

        const tdResident = document.createElement("td");
        tdResident.textContent = record.resident || "";
        tr.appendChild(tdResident);

        const tdTime = document.createElement("td");
        const span = document.createElement("span");
        span.textContent = record.timeSlot || "";
        span.className = "badge " + getTimeBadgeClass(record.timeSlot);
        tdTime.appendChild(span);
        tr.appendChild(tdTime);

        const tdCond = document.createElement("td");
        tdCond.innerHTML = (record.condition || "") + "<br><span class='small-text'>" + (record.mental || "") + "</span>";
        tr.appendChild(tdCond);

        const tdSupport = document.createElement("td");
        tdSupport.textContent = formatSupportSummary(record.support);

        if (record.tags && record.tags.length) {
          const tagDiv = document.createElement("div");
          tagDiv.className = "small-text";
          record.tags.forEach((tag) => {
            const spanTag = document.createElement("span");
            spanTag.className = "tag-chip";
            spanTag.textContent = "#" + tag;
            tagDiv.appendChild(spanTag);
          });
          tdSupport.appendChild(document.createElement("br"));
          tdSupport.appendChild(tagDiv);
        }
        tr.appendChild(tdSupport);

        const tdMed = document.createElement("td");
        tdMed.textContent = record.medTaken ? "æœè–¬æ¸ˆã¿" : "";
        tr.appendChild(tdMed);

        const tdActions = document.createElement("td");

        const viewBtn = document.createElement("button");
        viewBtn.textContent = "è©³ç´°";
        viewBtn.className = "btn-secondary";
        viewBtn.style.fontSize = "12px";
        viewBtn.onclick = () => showRecordDetail(record.id);

        const editBtn = document.createElement("button");
        editBtn.textContent = "ç·¨é›†";
        editBtn.className = "btn-secondary";
        editBtn.style.fontSize = "12px";
        editBtn.onclick = () => startEdit(record.id);

        const delBtn = document.createElement("button");
        delBtn.textContent = "å‰Šé™¤";
        delBtn.className = "btn-danger";
        delBtn.style.fontSize = "12px";
        delBtn.onclick = () => deleteRecord(record.id);

        tdActions.appendChild(viewBtn);
        tdActions.appendChild(editBtn);
        tdActions.appendChild(delBtn);
        tr.appendChild(tdActions);

        tbody.appendChild(tr);
      });
    }

    function resetForm() {
      document.getElementById("recordForm").reset();
      document.getElementById("date").value = new Date().toISOString().slice(0, 10);
      document.getElementById("timeSlot").value = "æ—¥ä¸­";
      document.getElementById("condition").value = "è‰¯å¥½";
      document.getElementById("mental").value = "å®‰å®š";
      document.getElementById("medTaken").checked = false;

      document.getElementById("daySupportType").value = "";
      document.getElementById("daySupportTime").value = "";

      editingIndex = null;
      currentTags = [];
      updateTagUI();
      syncQuickButtonsAll();

      document.getElementById("modeLabel").textContent = "æ–°è¦å…¥åŠ›ãƒ¢ãƒ¼ãƒ‰";
      document.getElementById("modeLabel").style.background = "#eff6ff";
      document.getElementById("modeLabel").style.color = "#1d4ed8";
      document.getElementById("saveButton").textContent = "ğŸ’¾ è¨˜éŒ²ã‚’ä¿å­˜";

      clearAutoItemChecks();
      clearDaySupportChecks();

      document.getElementById("templateScope").value = "common";
      renderTemplateSelect();
    }

    function startEdit(id) {
      const index = records.findIndex((r) => r.id === id);
      if (index === -1) return;
      const r = records[index];

      if (r.resident && !residents.includes(r.resident)) {
        residents.push(r.resident);
        saveResidents();
        renderResidentSelects();
      }

      editingIndex = index;

      document.getElementById("date").value = r.date || "";
      document.getElementById("resident").value = r.resident || "";
      document.getElementById("timeSlot").value = r.timeSlot || "æ—¥ä¸­";
      document.getElementById("condition").value = r.condition || "è‰¯å¥½";
      document.getElementById("mental").value = r.mental || "å®‰å®š";
      document.getElementById("meal").value = r.meal || "";
      document.getElementById("medTaken").checked = !!r.medTaken;
      document.getElementById("support").value = r.support || "";
      document.getElementById("note").value = r.note || "";
      document.getElementById("daySupportType").value = r.daySupportType || "";
      document.getElementById("daySupportTime").value = r.daySupportTime || "";

      // â˜…æ—¥ä¸­æ”¯æ´ãƒã‚§ãƒƒã‚¯ï¼šæ—§ãƒ‡ãƒ¼ã‚¿ï¼ˆãƒ©ãƒ™ãƒ«ä¿å­˜ï¼‰ã‚‚å¸å
      clearDaySupportChecks();
      const keys = normalizeDaySupportSelections(r.daySupportItems || []);
      keys.forEach((k) => {
        const el = document.querySelector(`.day-support-item[value="${CSS.escape(k)}"]`);
        if (el) el.checked = true;
      });

      currentTags = Array.isArray(r.tags) ? [...r.tags] : [];
      updateTagUI();
      syncQuickButtonsAll();

      document.getElementById("modeLabel").textContent = "ç·¨é›†ãƒ¢ãƒ¼ãƒ‰ï¼ˆä¸Šæ›¸ãä¿å­˜ï¼‰";
      document.getElementById("modeLabel").style.background = "#fee2e2";
      document.getElementById("modeLabel").style.color = "#b91c1c";
      document.getElementById("saveButton").textContent = "âœï¸ ã“ã®å†…å®¹ã§ä¸Šæ›¸ã";

      // â˜…åˆ©ç”¨è€…é¸æŠã®è‡ªå‹•ON
      applyResidentFavorites(r.resident || "");
      applyResidentDaySupportFavorites(r.resident || "");
    }

    function deleteRecord(id) {
      if (!confirm("ã“ã®è¨˜éŒ²ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")) return;
      records = records.filter((r) => r.id !== id);
      saveRecords();
      renderRecords();
      if (editingIndex !== null) resetForm();
    }

    function handleSubmit(event) {
      event.preventDefault();

      const date = document.getElementById("date").value;
      const resident = document.getElementById("resident").value;
      if (!date || !resident) { alert("æ—¥ä»˜ã¨åˆ©ç”¨è€…ã¯å¿…é ˆã§ã™ã€‚"); return; }

      const daySupportType = document.getElementById("daySupportType")?.value || "";
      const daySupportTime = document.getElementById("daySupportTime")?.value || "";

      // â˜…æ—¥ä¸­æ”¯æ´ãƒã‚§ãƒƒã‚¯ï¼šã‚­ãƒ¼ã§ä¿å­˜
      const daySupportItems = Array.from(document.querySelectorAll(".day-support-item:checked")).map((el) => el.value);

      const recordData = {
        id: (editingIndex !== null) ? records[editingIndex].id : Date.now().toString(),
        date,
        resident,
        timeSlot: document.getElementById("timeSlot").value,
        condition: document.getElementById("condition").value,
        mental: document.getElementById("mental").value,
        meal: document.getElementById("meal").value,
        medTaken: document.getElementById("medTaken").checked,
        support: document.getElementById("support").value,
        note: document.getElementById("note").value,
        tags: [...currentTags],
        daySupportType,
        daySupportItems,
        daySupportTime,
      };

      if (editingIndex !== null) records[editingIndex] = recordData;
      else records.push(recordData);

      saveRecords();
      renderRecords();
      resetForm();
    }

    function showRecordDetail(id) {
      const record = records.find((r) => r.id === id);
      if (!record) return;

      const modal = document.getElementById("detailModal");
      const content = document.getElementById("detailModalContent");
      const titleEl = document.getElementById("detailModalTitle");
      if (!modal || !content) return;
      content.innerHTML = "";

      const addRow = (label, value) => {
        const div = document.createElement("div");
        div.className = "detail-field";
        const strong = document.createElement("strong");
        strong.textContent = label;
        const span = document.createElement("span");
        span.textContent = value || "";
        div.appendChild(strong);
        div.appendChild(span);
        content.appendChild(div);
      };
      const addMultiline = (label, value) => {
        const wrap = document.createElement("div");
        wrap.className = "detail-multiline";
        const strong = document.createElement("strong");
        strong.textContent = label;
        const pre = document.createElement("pre");
        pre.textContent = value || "";
        wrap.appendChild(strong);
        wrap.appendChild(pre);
        content.appendChild(wrap);
      };

      const tagsText = record.tags && record.tags.length ? record.tags.map((t) => "#" + t).join(" ") : "ãªã—";
      const medText = record.medTaken ? "æœè–¬æ¸ˆã¿" : "æœªç¢ºèªï¼æœªå†…æœã®å¯èƒ½æ€§ã‚ã‚Š";

      const daySupportTypeLabel = record.daySupportType ? "æ—¥ä¸­æ”¯æ´åŠ ç®—" + record.daySupportType : "ãªã—";
      const dsLabels = (record.daySupportItems || []).map(daySupportLabelByKey).filter(Boolean);
      const daySupportItemsText = dsLabels.length ? dsLabels.join("ã€") : "ãªã—";

      if (titleEl) titleEl.textContent = `${record.date || ""} ${record.resident || ""} ã•ã‚“ã®è¨˜éŒ²`;

      addRow("æ—¥ä»˜ï¼š", record.date || "");
      addRow("åˆ©ç”¨è€…ï¼š", record.resident || "");
      addRow("æ™‚é–“å¸¯ï¼š", record.timeSlot || "");
      addRow("ä½“èª¿ï¼š", record.condition || "");
      addRow("å¿ƒã®çŠ¶æ…‹ï¼š", record.mental || "");
      addRow("é£Ÿäº‹ã®æ§˜å­ï¼š", record.meal || "");
      addRow("æœè–¬ï¼š", medText);
      addRow("ã‚¿ã‚°ï¼š", tagsText);
      addRow("æ—¥ä¸­æ”¯æ´åŠ ç®—åŒºåˆ†ï¼š", daySupportTypeLabel);
      addRow("æ—¥ä¸­æ”¯æ´ã®æ™‚é–“å¸¯ï¼š", record.daySupportTime || "");
      addRow("æ—¥ä¸­æ”¯æ´ãƒã‚§ãƒƒã‚¯ï¼š", daySupportItemsText);

      addMultiline("æœ¬æ—¥ã®æ”¯æ´å†…å®¹ãƒ»æ§˜å­ï¼š", record.support || "");
      addMultiline("ç‰¹è¨˜äº‹é …ï¼š", record.note || "");

      modal.classList.add("show");
    }

    function closeRecordDetail() {
      const modal = document.getElementById("detailModal");
      if (modal) modal.classList.remove("show");
    }

    // ã‚¿ã‚°
    function setupTagButtons() {
      const container = document.getElementById("tagButtons");
      container.innerHTML = "";
      TAG_LIST.forEach((tag) => {
        const btn = document.createElement("button");
        btn.type = "button";
        btn.className = "tag-button";
        btn.textContent = "#" + tag;
        btn.dataset.tag = tag;
        btn.addEventListener("click", () => toggleTag(tag));
        container.appendChild(btn);
      });
      updateTagUI();
    }
    function toggleTag(tag) {
      const idx = currentTags.indexOf(tag);
      if (idx >= 0) currentTags.splice(idx, 1);
      else currentTags.push(tag);
      updateTagUI();
    }
    function updateTagUI() {
      const info = document.getElementById("selectedTagsInfo");
      if (!info) return;
      info.textContent = (currentTags.length === 0) ? "é¸æŠä¸­ï¼šãªã—" : ("é¸æŠä¸­ï¼š " + currentTags.map((t) => "#" + t).join(" "));
      document.querySelectorAll(".tag-button").forEach((btn) => {
        const t = btn.dataset.tag;
        btn.classList.toggle("tag-button-active", currentTags.includes(t));
      });
    }

    // ã‚¯ã‚¤ãƒƒã‚¯ãƒœã‚¿ãƒ³
    function setupQuickButtons() {
      document.querySelectorAll(".quick-row").forEach((row) => {
        const targetId = row.dataset.target;
        const select = document.getElementById(targetId);
        if (!select) return;
        const buttons = row.querySelectorAll(".quick-btn");

        const sync = () => {
          const val = select.value;
          buttons.forEach((btn) => btn.classList.toggle("quick-btn-active", btn.dataset.value === val));
        };

        buttons.forEach((btn) => {
          btn.addEventListener("click", () => { select.value = btn.dataset.value; sync(); });
        });

        select.addEventListener("change", sync);
        sync();
      });
    }
    function syncQuickButtonsAll() {
      document.querySelectorAll(".quick-row").forEach((row) => {
        const targetId = row.dataset.target;
        const select = document.getElementById(targetId);
        if (!select) return;
        const val = select.value;
        row.querySelectorAll(".quick-btn").forEach((btn) => btn.classList.toggle("quick-btn-active", btn.dataset.value === val));
      });
    }

    // ===== ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆï¼ˆæ–‡ç« ï¼‰ =====
    function loadTemplates() {
      const raw = localStorage.getItem(TEMPLATES_KEY);
      const parsed = safeJSONParse(raw, []);
      return Array.isArray(parsed)
        ? parsed.filter(t => t && typeof t.name === "string" && typeof t.text === "string")
          .map(t => (!t.scope ? { ...t, scope: "common" } : t))
        : [];
    }
    function saveTemplates() { localStorage.setItem(TEMPLATES_KEY, JSON.stringify(templates)); }

    function renderTemplateSelect() {
      const select = document.getElementById("templateSelect");
      const scopeSelect = document.getElementById("templateScope");
      if (!select || !scopeSelect) return;
      const currentScope = scopeSelect.value || "common";

      select.innerHTML = "";
      const placeholder = document.createElement("option");
      placeholder.value = "";
      placeholder.textContent = "é¸æŠã—ã¦ãã ã•ã„";
      select.appendChild(placeholder);

      templates.forEach((tpl, index) => {
        const scope = tpl.scope || "common";
        if (scope !== currentScope) return;
        const opt = document.createElement("option");
        opt.value = String(index);
        opt.textContent = tpl.name;
        select.appendChild(opt);
      });
    }

    function handleTemplateApply() {
      const idxStr = document.getElementById("templateSelect").value;
      if (!idxStr) { alert("æŒ¿å…¥ã™ã‚‹ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚"); return; }
      const idx = parseInt(idxStr, 10);
      const tpl = templates[idx];
      if (!tpl) return;
      const support = document.getElementById("support");
      support.value = support.value.trim() ? (support.value.replace(/\s*$/, "") + "\n" + tpl.text) : tpl.text;
    }

    function handleTemplateSave() {
      const name = document.getElementById("templateNameInput").value.trim();
      if (!name) { alert("ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆåã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚"); return; }
      const scope = document.getElementById("templateScope")?.value || "common";
      const text = document.getElementById("support").value;

      if (!text.trim()) {
        const ok = confirm("æ”¯æ´å†…å®¹ãŒç©ºã§ã™ãŒã€ã“ã®ã¾ã¾ä¿å­˜ã—ã¾ã™ã‹ï¼Ÿ");
        if (!ok) return;
      }

      const existingIndex = templates.findIndex((t) => t.name === name && (t.scope || "common") === scope);
      let targetIndex;
      if (existingIndex >= 0) {
        const ok = confirm("åŒã˜åå‰ãƒ»å¯¾è±¡é …ç›®ã®ãƒ†ãƒ³ãƒ—ãƒ¬ãŒå­˜åœ¨ã—ã¾ã™ã€‚ä¸Šæ›¸ãã—ã¾ã™ã‹ï¼Ÿ");
        if (!ok) return;
        templates[existingIndex].text = text;
        targetIndex = existingIndex;
      } else {
        templates.push({ name, text, scope });
        targetIndex = templates.length - 1;
      }

      saveTemplates();
      renderTemplateSelect();
      document.getElementById("templateSelect").value = String(targetIndex);
      alert("ãƒ†ãƒ³ãƒ—ãƒ¬ã‚’ä¿å­˜ã—ã¾ã—ãŸã€‚");
    }

    function handleTemplateDelete() {
      const idxStr = document.getElementById("templateSelect").value;
      if (!idxStr) { alert("å‰Šé™¤ã™ã‚‹ãƒ†ãƒ³ãƒ—ãƒ¬ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚"); return; }
      const idx = parseInt(idxStr, 10);
      const tpl = templates[idx];
      if (!tpl) return;
      const ok = confirm(`ã€Œ${tpl.name}ã€ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ`);
      if (!ok) return;
      templates.splice(idx, 1);
      saveTemplates();
      renderTemplateSelect();
      alert("å‰Šé™¤ã—ã¾ã—ãŸã€‚");
    }

    // ===== â‘  è‡ªå‹•å…¥åŠ›ï¼ˆæ–‡ç« è¿½è¨˜ï¼‰ =====
    function renderAutoItemCheckboxes() {
      const wrap = document.getElementById("autoItemCheckboxes");
      wrap.innerHTML = "";
      AUTO_ITEM_DEFS.forEach((def) => {
        const label = document.createElement("label");
        label.innerHTML = `<input type="checkbox" class="auto-item" value="${def.key}"> ${escapeHTML(def.label)}`;
        wrap.appendChild(label);
      });
    }
    function clearAutoItemChecks() {
      document.querySelectorAll(".auto-item").forEach((el) => { el.checked = false; });
    }

    function applyResidentFavorites(residentName) {
      clearAutoItemChecks();
      if (!residentName) return;
      const data = getResidentAutoData(residentName);
      const favorites = (data.favorites || []).filter((k) => AUTO_ITEM_DEFS.some((d) => d.key === k));
      favorites.forEach((key) => {
        const el = document.querySelector(`.auto-item[value="${CSS.escape(key)}"]`);
        if (el) el.checked = true;
      });
    }

    // ===== â‘¡ æ—¥ä¸­æ”¯æ´ãƒã‚§ãƒƒã‚¯ï¼ˆç†ç”±/ä¸»ãªæ”¯æ´ï¼‰ =====
    function renderDaySupportCheckboxes() {
      const reasonWrap = document.getElementById("daySupportReasonCheckboxes");
      const supportWrap = document.getElementById("daySupportSupportCheckboxes");
      if (!reasonWrap || !supportWrap) return;

      reasonWrap.innerHTML = "";
      supportWrap.innerHTML = "";

      daySupportDefs.reasons.forEach((it) => {
        const label = document.createElement("label");
        label.innerHTML = `<input type="checkbox" class="day-support-item" data-group="reason" value="${escapeHTML(it.key)}"> ${escapeHTML(it.label)}`;
        reasonWrap.appendChild(label);
      });

      daySupportDefs.supports.forEach((it) => {
        const label = document.createElement("label");
        label.innerHTML = `<input type="checkbox" class="day-support-item" data-group="support" value="${escapeHTML(it.key)}"> ${escapeHTML(it.label)}`;
        supportWrap.appendChild(label);
      });
    }

    function clearDaySupportChecks() {
      document.querySelectorAll(".day-support-item").forEach((el) => { el.checked = false; });
    }

    function applyResidentDaySupportFavorites(residentName) {
      // â‘¡ã‚‚è‡ªå‹•ON
      if (!residentName) { clearDaySupportChecks(); return; }
      clearDaySupportChecks();
      const data = getResidentAutoData(residentName);
      const favs = Array.isArray(data.daySupportFavorites) ? data.daySupportFavorites : [];

      favs.forEach((key) => {
        const el = document.querySelector(`.day-support-item[value="${CSS.escape(key)}"]`);
        if (el) el.checked = true;
      });
    }

    // è‡ªå‹•æ–‡ç« ç”Ÿæˆ
    function generateSupportText() {
      const textArea = document.getElementById("support");

      // ãƒ†ãƒ³ãƒ—ãƒ¬å„ªå…ˆ
      const idxStr = document.getElementById("templateSelect")?.value || "";
      if (idxStr) {
        const idx = parseInt(idxStr, 10);
        if (!Number.isNaN(idx) && templates[idx]) {
          const newText = templates[idx].text || "";
          textArea.value = textArea.value.trim() ? (textArea.value.replace(/\s*$/, "") + "\n" + newText) : newText;
          return;
        }
      }

      const checkedKeys = Array.from(document.querySelectorAll(".auto-item:checked")).map((el) => el.value);
      if (checkedKeys.length === 0) { alert("â‘ è‡ªå‹•å…¥åŠ›ã®é …ç›®ã«ãƒã‚§ãƒƒã‚¯ãŒã‚ã‚Šã¾ã›ã‚“ã€‚"); return; }

      const daySupportType = document.getElementById("daySupportType")?.value || "";
      const daySupportTypeLabel = daySupportType ? ("æ—¥ä¸­æ”¯æ´åŠ ç®—" + daySupportType) : "æ—¥ä¸­æ”¯æ´åŠ ç®—";

      const resident = document.getElementById("resident")?.value || "";
      const rData = getResidentAutoData(resident);
      const rTexts = (rData.texts && typeof rData.texts === "object") ? rData.texts : {};

      const parts = [];
      checkedKeys.forEach((key) => {
        const def = AUTO_ITEM_DEFS.find((d) => d.key === key);
        if (!def) return;

        const override = (rTexts[key] || "").trim();
        let text = override ? override : (def.defaultText || "").trim();
        if (!text) return;

        text = text.replaceAll("{{daySupportTypeLabel}}", daySupportTypeLabel);
        parts.push(text);
      });

      if (parts.length === 0) { alert("å®šå‹æ–‡ãŒç©ºã®é …ç›®ãŒã‚ã‚Šã¾ã™ã€‚ç®¡ç†ã§æ–‡ç« ã‚’å…¥ã‚Œã¦ãã ã•ã„ã€‚"); return; }
      const newText = parts.join("\n");
      textArea.value = textArea.value.trim() ? (textArea.value.replace(/\s*$/, "") + "\n" + newText) : newText;
    }

    // ===== ç®¡ç†ï¼šè‡ªå‹•å…¥åŠ›é …ç›® =====
    function renderAutoItemManager() {
      const sel = document.getElementById("autoItemSelect");
      sel.innerHTML = `<option value="">ï¼ˆæ–°è¦è¿½åŠ ï¼‰</option>`;
      AUTO_ITEM_DEFS.forEach((d, i) => {
        const opt = document.createElement("option");
        opt.value = String(i);
        opt.textContent = `${d.label}ï¼ˆ${d.key}ï¼‰`;
        sel.appendChild(opt);
      });
    }
    function clearAutoItemInputs() {
      document.getElementById("autoItemSelect").value = "";
      document.getElementById("autoItemKey").value = "";
      document.getElementById("autoItemLabel").value = "";
      document.getElementById("autoItemText").value = "";
    }
    function fillAutoItemInputsBySelect() {
      const idxStr = document.getElementById("autoItemSelect").value;
      if (!idxStr) { clearAutoItemInputs(); return; }
      const idx = parseInt(idxStr, 10);
      const d = AUTO_ITEM_DEFS[idx];
      if (!d) return;
      document.getElementById("autoItemKey").value = d.key || "";
      document.getElementById("autoItemLabel").value = d.label || "";
      document.getElementById("autoItemText").value = d.defaultText || "";
    }
    function saveAutoItemFromInputs() {
      const idxStr = document.getElementById("autoItemSelect").value;
      const key = document.getElementById("autoItemKey").value.trim();
      const label = document.getElementById("autoItemLabel").value.trim();
      const text = document.getElementById("autoItemText").value;

      if (!key) { alert("å†…éƒ¨ã‚­ãƒ¼ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„"); return; }
      if (!/^[a-zA-Z0-9_]+$/.test(key)) { alert("å†…éƒ¨ã‚­ãƒ¼ã¯è‹±æ•°å­—ã¨ _ ã®ã¿"); return; }
      if (!label) { alert("è¡¨ç¤ºåã‚’å…¥åŠ›ã—ã¦ãã ã•ã„"); return; }
      if (!text.trim()) { alert("å®šå‹æ–‡ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„"); return; }

      const existsOther = AUTO_ITEM_DEFS.some((d, i) => d.key === key && String(i) !== idxStr);
      if (existsOther) { alert("åŒã˜å†…éƒ¨ã‚­ãƒ¼ãŒå­˜åœ¨ã—ã¾ã™"); return; }

      if (idxStr) {
        const idx = parseInt(idxStr, 10);
        if (!AUTO_ITEM_DEFS[idx]) return;
        AUTO_ITEM_DEFS[idx] = { key, label, defaultText: text };
      } else {
        AUTO_ITEM_DEFS.push({ key, label, defaultText: text });
      }

      saveAutoItemDefs();
      renderAutoItemCheckboxes();
      renderAutoItemManager();
      renderFavManageCheckboxes();
      renderResidentAutoTplModalUI();
      alert("ä¿å­˜ã—ã¾ã—ãŸã€‚");
    }
    function deleteSelectedAutoItem() {
      const idxStr = document.getElementById("autoItemSelect").value;
      if (!idxStr) { alert("å‰Šé™¤ã™ã‚‹é …ç›®ã‚’é¸æŠã—ã¦ãã ã•ã„"); return; }
      const idx = parseInt(idxStr, 10);
      const d = AUTO_ITEM_DEFS[idx];
      if (!d) return;
      const ok = confirm(`ã€Œ${d.label}ï¼ˆ${d.key}ï¼‰ã€ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ`);
      if (!ok) return;

      AUTO_ITEM_DEFS.splice(idx, 1);
      saveAutoItemDefs();
      renderAutoItemCheckboxes();
      renderAutoItemManager();
      clearAutoItemInputs();
      renderFavManageCheckboxes();
      renderResidentAutoTplModalUI();
      alert("å‰Šé™¤ã—ã¾ã—ãŸã€‚");
    }
    function resetAutoItemsToDefault() {
      const ok = confirm("è‡ªå‹•å…¥åŠ›ã®æ”¯æ´é …ç›®ã‚’åˆæœŸçŠ¶æ…‹ã«æˆ»ã—ã¾ã™ã‹ï¼Ÿï¼ˆè¿½åŠ åˆ†ã¯æ¶ˆãˆã¾ã™ï¼‰");
      if (!ok) return;
      AUTO_ITEM_DEFS = DEFAULT_AUTO_ITEM_DEFS.slice();
      saveAutoItemDefs();
      renderAutoItemCheckboxes();
      renderAutoItemManager();
      clearAutoItemInputs();
      renderFavManageCheckboxes();
      renderResidentAutoTplModalUI();
      alert("åˆæœŸçŠ¶æ…‹ã«æˆ»ã—ã¾ã—ãŸã€‚");
    }

    // ===== ç®¡ç†ï¼šæ—¥ä¸­æ”¯æ´ãƒã‚§ãƒƒã‚¯é …ç›® =====
    function renderDayItemManager() {
      const sel = document.getElementById("dayItemSelect");
      sel.innerHTML = `<option value="">ï¼ˆæ–°è¦è¿½åŠ ï¼‰</option>`;
      daySupportDefs.reasons.forEach((d, i) => {
        const opt = document.createElement("option");
        opt.value = `reason:${i}`;
        opt.textContent = `ã€ç†ç”±ã€‘${d.label}ï¼ˆ${d.key}ï¼‰`;
        sel.appendChild(opt);
      });
      daySupportDefs.supports.forEach((d, i) => {
        const opt = document.createElement("option");
        opt.value = `support:${i}`;
        opt.textContent = `ã€ä¸»ãªæ”¯æ´ã€‘${d.label}ï¼ˆ${d.key}ï¼‰`;
        sel.appendChild(opt);
      });
    }

    function clearDayItemInputs() {
      document.getElementById("dayItemSelect").value = "";
      document.getElementById("dayItemGroup").value = "reason";
      document.getElementById("dayItemKey").value = "";
      document.getElementById("dayItemLabel").value = "";
    }

    function fillDayItemInputsBySelect() {
      const val = document.getElementById("dayItemSelect").value;
      if (!val) { clearDayItemInputs(); return; }
      const [group, idxStr] = val.split(":");
      const idx = parseInt(idxStr, 10);
      const arr = (group === "support") ? daySupportDefs.supports : daySupportDefs.reasons;
      const d = arr[idx];
      if (!d) return;
      document.getElementById("dayItemGroup").value = group;
      document.getElementById("dayItemKey").value = d.key || "";
      document.getElementById("dayItemLabel").value = d.label || "";
    }

    function saveDayItemFromInputs() {
      const selected = document.getElementById("dayItemSelect").value;
      const group = document.getElementById("dayItemGroup").value; // reason/support
      let key = document.getElementById("dayItemKey").value.trim();
      const label = document.getElementById("dayItemLabel").value.trim();

      if (!label) { alert("è¡¨ç¤ºåã‚’å…¥åŠ›ã—ã¦ãã ã•ã„"); return; }
      if (!key) key = "ds_" + Date.now(); // ç©ºãªã‚‰è‡ªå‹•ã‚­ãƒ¼

      if (!/^[a-zA-Z0-9_]+$/.test(key)) { alert("å†…éƒ¨ã‚­ãƒ¼ã¯è‹±æ•°å­—ã¨ _ ã®ã¿"); return; }

      const all = [...daySupportDefs.reasons, ...daySupportDefs.supports];
      const existsOther = all.some((d) => d.key === key) &&
        !(selected && (() => {
          const [g, iStr] = selected.split(":");
          const i = parseInt(iStr, 10);
          const arr = (g === "support") ? daySupportDefs.supports : daySupportDefs.reasons;
          return arr[i] && arr[i].key === key;
        })());

      if (existsOther) { alert("åŒã˜å†…éƒ¨ã‚­ãƒ¼ãŒã™ã§ã«å­˜åœ¨ã—ã¾ã™"); return; }

      if (selected) {
        const [g, iStr] = selected.split(":");
        const i = parseInt(iStr, 10);
        const arr = (g === "support") ? daySupportDefs.supports : daySupportDefs.reasons;
        if (!arr[i]) return;

        // åˆ†é¡ãŒå¤‰æ›´ã•ã‚ŒãŸå ´åˆã¯ç§»å‹•
        if (g !== group) {
          const old = arr[i];
          arr.splice(i, 1);
          const targetArr = (group === "support") ? daySupportDefs.supports : daySupportDefs.reasons;
          targetArr.push({ key, label });
        } else {
          arr[i] = { key, label };
        }
      } else {
        const targetArr = (group === "support") ? daySupportDefs.supports : daySupportDefs.reasons;
        targetArr.push({ key, label });
      }

      saveDaySupportDefs();
      renderDaySupportCheckboxes();
      renderDayItemManager();
      renderFavManageDaySupportCheckboxes();
      renderResidentAutoTplModalDaySupportFavUI();

      alert("ä¿å­˜ã—ã¾ã—ãŸã€‚");
    }

    function deleteSelectedDayItem() {
      const selected = document.getElementById("dayItemSelect").value;
      if (!selected) { alert("å‰Šé™¤ã™ã‚‹é …ç›®ã‚’é¸æŠã—ã¦ãã ã•ã„"); return; }
      const [g, iStr] = selected.split(":");
      const i = parseInt(iStr, 10);
      const arr = (g === "support") ? daySupportDefs.supports : daySupportDefs.reasons;
      const d = arr[i];
      if (!d) return;

      const ok = confirm(`ã€Œ${d.label}ï¼ˆ${d.key}ï¼‰ã€ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ`);
      if (!ok) return;

      arr.splice(i, 1);
      saveDaySupportDefs();
      renderDaySupportCheckboxes();
      renderDayItemManager();
      clearDayItemInputs();
      renderFavManageDaySupportCheckboxes();
      renderResidentAutoTplModalDaySupportFavUI();
      alert("å‰Šé™¤ã—ã¾ã—ãŸã€‚");
    }

    function resetDayItemsToDefault() {
      const ok = confirm("æ—¥ä¸­æ”¯æ´ãƒã‚§ãƒƒã‚¯é …ç›®ã‚’åˆæœŸçŠ¶æ…‹ã«æˆ»ã—ã¾ã™ã‹ï¼Ÿï¼ˆè¿½åŠ åˆ†ã¯æ¶ˆãˆã¾ã™ï¼‰");
      if (!ok) return;
      daySupportDefs = {
        reasons: DEFAULT_DAY_SUPPORT_DEFS.reasons.slice(),
        supports: DEFAULT_DAY_SUPPORT_DEFS.supports.slice()
      };
      saveDaySupportDefs();
      renderDaySupportCheckboxes();
      renderDayItemManager();
      clearDayItemInputs();
      renderFavManageDaySupportCheckboxes();
      renderResidentAutoTplModalDaySupportFavUI();
      alert("åˆæœŸçŠ¶æ…‹ã«æˆ»ã—ã¾ã—ãŸã€‚");
    }

    // ===== ã‚ˆãä½¿ã†é …ç›®ï¼ˆåˆ©ç”¨è€…åˆ¥ï¼‰ =====
    function renderFavManageCheckboxes() {
      const wrap = document.getElementById("favManageCheckboxes");
      wrap.innerHTML = "";
      AUTO_ITEM_DEFS.forEach((def) => {
        const label = document.createElement("label");
        label.innerHTML = `<input type="checkbox" class="fav-manage-item" value="${escapeHTML(def.key)}"> ${escapeHTML(def.label)}`;
        wrap.appendChild(label);
      });
    }

    function renderFavManageDaySupportCheckboxes() {
      const reasonWrap = document.getElementById("favManageDayReason");
      const supportWrap = document.getElementById("favManageDaySupport");
      if (!reasonWrap || !supportWrap) return;

      reasonWrap.innerHTML = "";
      supportWrap.innerHTML = "";

      daySupportDefs.reasons.forEach((it) => {
        const label = document.createElement("label");
        label.innerHTML = `<input type="checkbox" class="fav-manage-day" data-group="reason" value="${escapeHTML(it.key)}"> ${escapeHTML(it.label)}`;
        reasonWrap.appendChild(label);
      });

      daySupportDefs.supports.forEach((it) => {
        const label = document.createElement("label");
        label.innerHTML = `<input type="checkbox" class="fav-manage-day" data-group="support" value="${escapeHTML(it.key)}"> ${escapeHTML(it.label)}`;
        supportWrap.appendChild(label);
      });
    }

    function syncFavManageUIFromResident(residentName) {
      document.querySelectorAll(".fav-manage-item").forEach((el) => { el.checked = false; });
      document.querySelectorAll(".fav-manage-day").forEach((el) => { el.checked = false; });
      if (!residentName) return;

      const data = getResidentAutoData(residentName);
      const favs = (data.favorites || []).filter((k) => AUTO_ITEM_DEFS.some((d) => d.key === k));
      favs.forEach((key) => {
        const el = document.querySelector(`.fav-manage-item[value="${CSS.escape(key)}"]`);
        if (el) el.checked = true;
      });

      const dsFav = (data.daySupportFavorites || []).filter((k) => {
        return [...daySupportDefs.reasons, ...daySupportDefs.supports].some(x => x.key === k);
      });
      dsFav.forEach((key) => {
        const el = document.querySelector(`.fav-manage-day[value="${CSS.escape(key)}"]`);
        if (el) el.checked = true;
      });
    }

    function saveFavManageForResident() {
      const residentName = document.getElementById("favManageResident")?.value || "";
      if (!residentName) { alert("å¯¾è±¡ã®åˆ©ç”¨è€…ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚"); return; }

      const favs = Array.from(document.querySelectorAll(".fav-manage-item:checked")).map((el) => el.value);
      const dsFav = Array.from(document.querySelectorAll(".fav-manage-day:checked")).map((el) => el.value);

      const old = getResidentAutoData(residentName);
      setResidentAutoData(residentName, { favorites: favs, texts: old.texts || {}, daySupportFavorites: dsFav });

      // ãƒ•ã‚©ãƒ¼ãƒ ã«å³åæ˜ 
      const formResident = document.getElementById("resident")?.value || "";
      if (formResident === residentName) {
        applyResidentFavorites(residentName);
        applyResidentDaySupportFavorites(residentName);
      }

      alert("ä¿å­˜ã—ã¾ã—ãŸã€‚");
    }

    function resetFavManageForResident() {
      const residentName = document.getElementById("favManageResident")?.value || "";
      if (!residentName) { alert("å¯¾è±¡ã®åˆ©ç”¨è€…ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚"); return; }

      const ok = confirm("ã“ã®åˆ©ç”¨è€…ã®ã€Œã‚ˆãä½¿ã†é …ç›®ï¼ˆè‡ªå‹•ONï¼‰ã€ã‚’åˆæœŸã«æˆ»ã—ã¾ã™ã‹ï¼Ÿ");
      if (!ok) return;

      const old = getResidentAutoData(residentName);
      setResidentAutoData(residentName, { favorites: [], texts: old.texts || {}, daySupportFavorites: [] });
      syncFavManageUIFromResident(residentName);

      const formResident = document.getElementById("resident")?.value || "";
      if (formResident === residentName) {
        applyResidentFavorites(residentName);
        applyResidentDaySupportFavorites(residentName);
      }
      alert("åˆæœŸã«æˆ»ã—ã¾ã—ãŸã€‚");
    }

    // ===== åˆ©ç”¨è€…ç®¡ç† =====
    function handleResidentAdd() {
      const name = document.getElementById("residentNameInput").value.trim();
      if (!name) { alert("è¿½åŠ ã™ã‚‹åå‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚"); return; }
      if (residents.includes(name)) { alert("åŒã˜åå‰ãŒå­˜åœ¨ã—ã¾ã™ã€‚"); return; }
      residents.push(name);
      saveResidents();
      renderResidentSelects();
      document.getElementById("residentNameInput").value = "";
      alert("è¿½åŠ ã—ã¾ã—ãŸã€‚");
    }

    function handleResidentRename() {
      const oldName = document.getElementById("residentManageSelect").value;
      const newName = document.getElementById("residentNameInput").value.trim();
      if (!oldName) { alert("å¤‰æ›´ã™ã‚‹åˆ©ç”¨è€…ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚"); return; }
      if (!newName) { alert("æ–°ã—ã„åå‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚"); return; }
      if (oldName === newName) { alert("åŒã˜åå‰ã§ã™ã€‚"); return; }

      if (residents.includes(newName)) {
        const ok = confirm("åŒã˜åå‰ãŒå­˜åœ¨ã—ã¾ã™ã€‚çµ±åˆã—ã¾ã™ã‹ï¼Ÿ");
        if (!ok) return;
      }

      residents = residents.map((n) => (n === oldName ? newName : n));
      records = records.map((r) => (r.resident === oldName ? { ...r, resident: newName } : r));

      // åˆ©ç”¨è€…åˆ¥è¨­å®šã‚‚ç§»è¡Œ
      const oldData = residentAutoTpl[oldName];
      if (oldData) {
        const newData = residentAutoTpl[newName];
        residentAutoTpl[newName] = newData ? mergeResidentAutoData(newData, oldData) : oldData;
        delete residentAutoTpl[oldName];
        saveResidentAutoTpl();
      }

      saveResidents();
      saveRecords();
      renderResidentSelects();
      renderRecords();
      document.getElementById("residentNameInput").value = "";
      alert("å¤‰æ›´ã—ã¾ã—ãŸã€‚");
    }

    function handleResidentDelete() {
      const target = document.getElementById("residentManageSelect").value;
      if (!target) { alert("å‰Šé™¤ã™ã‚‹åˆ©ç”¨è€…ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚"); return; }
      const ok = confirm(target + " ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ\nã“ã®åˆ©ç”¨è€…ã®è¨˜éŒ²ã‚‚å‰Šé™¤ã•ã‚Œã¾ã™ã€‚");
      if (!ok) return;

      residents = residents.filter((n) => n !== target);
      records = records.filter((r) => r.resident !== target);
      deleteResidentAutoData(target);

      saveResidents();
      saveRecords();
      renderResidentSelects();
      renderRecords();
      document.getElementById("residentNameInput").value = "";
      alert("å‰Šé™¤ã—ã¾ã—ãŸã€‚");
    }

    // ===== è‡ªå‹•ãƒ†ãƒ³ãƒ—ãƒ¬ç·¨é›†ï¼ˆåˆ©ç”¨è€…åˆ¥ï¼‰ãƒ¢ãƒ¼ãƒ€ãƒ« =====
    function openResidentAutoTplModal() {
      const formResident = document.getElementById("resident")?.value || "";
      if (!formResident) { alert("å…ˆã«ãƒ•ã‚©ãƒ¼ãƒ ã§åˆ©ç”¨è€…ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚"); return; }
      document.getElementById("residentAutoTplResident").value = formResident;

      renderResidentAutoTplModalUI();
      renderResidentAutoTplModalDaySupportFavUI();
      syncResidentAutoTplModalUIFromResident(formResident);

      document.getElementById("residentAutoTplModal").classList.add("show");
    }
    function closeResidentAutoTplModal() {
      document.getElementById("residentAutoTplModal").classList.remove("show");
    }

    function renderResidentAutoTplModalUI() {
      const favWrap = document.getElementById("residentFavCheckboxes");
      favWrap.innerHTML = "";
      AUTO_ITEM_DEFS.forEach((def) => {
        const label = document.createElement("label");
        label.innerHTML = `<input type="checkbox" class="resident-fav-item" value="${escapeHTML(def.key)}"> ${escapeHTML(def.label)}`;
        favWrap.appendChild(label);
      });

      const grid = document.getElementById("residentAutoTplTextGrid");
      grid.innerHTML = "";
      AUTO_ITEM_DEFS.forEach((def) => {
        const box = document.createElement("div");
        box.className = "auto-tpl-item";
        box.dataset.key = def.key;
        box.innerHTML = `
          <div class="auto-tpl-item-title">
            <div class="name">${escapeHTML(def.label)}</div>
            <div class="key">${escapeHTML(def.key)}</div>
          </div>
          <label class="small-text" style="margin-bottom:6px;">ã“ã®åˆ©ç”¨è€…ã®æ–‡ç« ï¼ˆç©ºãªã‚‰å…±é€šã®å®šå‹æ–‡ï¼‰</label>
          <textarea class="resident-tpl-text" rows="3" placeholder="ï¼ˆç©ºãªã‚‰å…±é€šãŒä½¿ã‚ã‚Œã¾ã™ï¼‰"></textarea>
          <div class="small-text" style="margin-top:6px;">
            å…±é€šã®å®šå‹æ–‡ï¼š
            <div style="background:#fff; border:1px solid #e5e7eb; border-radius:10px; padding:8px 10px; margin-top:4px; white-space:pre-wrap; font-size:12px; color:#374151;">${escapeHTML(def.defaultText || "")}</div>
          </div>
        `;
        grid.appendChild(box);
      });
    }

    function renderResidentAutoTplModalDaySupportFavUI() {
      const reasonWrap = document.getElementById("residentDayReasonFav");
      const supportWrap = document.getElementById("residentDaySupportFav");
      reasonWrap.innerHTML = "";
      supportWrap.innerHTML = "";

      daySupportDefs.reasons.forEach((it) => {
        const label = document.createElement("label");
        label.innerHTML = `<input type="checkbox" class="resident-day-fav" data-group="reason" value="${escapeHTML(it.key)}"> ${escapeHTML(it.label)}`;
        reasonWrap.appendChild(label);
      });
      daySupportDefs.supports.forEach((it) => {
        const label = document.createElement("label");
        label.innerHTML = `<input type="checkbox" class="resident-day-fav" data-group="support" value="${escapeHTML(it.key)}"> ${escapeHTML(it.label)}`;
        supportWrap.appendChild(label);
      });
    }

    function syncResidentAutoTplModalUIFromResident(residentName) {
      document.querySelectorAll(".resident-fav-item").forEach((el) => { el.checked = false; });
      document.querySelectorAll(".resident-day-fav").forEach((el) => { el.checked = false; });
      document.querySelectorAll(".resident-tpl-text").forEach((el) => { el.value = ""; });

      if (!residentName) return;

      const data = getResidentAutoData(residentName);
      (data.favorites || []).forEach((key) => {
        const el = document.querySelector(`.resident-fav-item[value="${CSS.escape(key)}"]`);
        if (el) el.checked = true;
      });

      (data.daySupportFavorites || []).forEach((key) => {
        const el = document.querySelector(`.resident-day-fav[value="${CSS.escape(key)}"]`);
        if (el) el.checked = true;
      });

      const texts = data.texts || {};
      document.querySelectorAll(".auto-tpl-item").forEach((box) => {
        const key = box.dataset.key;
        const ta = box.querySelector(".resident-tpl-text");
        if (!ta) return;
        ta.value = texts[key] || "";
      });
    }

    function saveResidentAutoTplFromModal() {
      const residentName = document.getElementById("residentAutoTplResident")?.value || "";
      if (!residentName) { alert("åˆ©ç”¨è€…ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚"); return; }

      const favs = Array.from(document.querySelectorAll(".resident-fav-item:checked")).map((el) => el.value);
      const dsFav = Array.from(document.querySelectorAll(".resident-day-fav:checked")).map((el) => el.value);

      const texts = {};
      document.querySelectorAll(".auto-tpl-item").forEach((box) => {
        const key = box.dataset.key;
        const ta = box.querySelector(".resident-tpl-text");
        const val = (ta ? ta.value : "").trim();
        if (val) texts[key] = val;
      });

      setResidentAutoData(residentName, { favorites: favs, texts, daySupportFavorites: dsFav });

      // åæ˜ ï¼šç®¡ç†æ¬„
      const favManageResident = document.getElementById("favManageResident")?.value || "";
      if (favManageResident === residentName) syncFavManageUIFromResident(residentName);

      // åæ˜ ï¼šãƒ•ã‚©ãƒ¼ãƒ 
      const formResident = document.getElementById("resident")?.value || "";
      if (formResident === residentName) {
        applyResidentFavorites(residentName);
        applyResidentDaySupportFavorites(residentName);
      }

      alert("ä¿å­˜ã—ã¾ã—ãŸã€‚");
    }

    function resetResidentAutoTplFromModal() {
      const residentName = document.getElementById("residentAutoTplResident")?.value || "";
      if (!residentName) { alert("åˆ©ç”¨è€…ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚"); return; }
      const ok = confirm("ã“ã®åˆ©ç”¨è€…ã®ã€Œè‡ªå‹•ONã€ã¨ã€Œæ–‡ç« ä¸Šæ›¸ãã€ã‚’åˆæœŸã«æˆ»ã—ã¾ã™ã‹ï¼Ÿ");
      if (!ok) return;

      setResidentAutoData(residentName, { favorites: [], texts: {}, daySupportFavorites: [] });
      syncResidentAutoTplModalUIFromResident(residentName);

      const favManageResident = document.getElementById("favManageResident")?.value || "";
      if (favManageResident === residentName) syncFavManageUIFromResident(residentName);

      const formResident = document.getElementById("resident")?.value || "";
      if (formResident === residentName) {
        applyResidentFavorites(residentName);
        applyResidentDaySupportFavorites(residentName);
      }

      alert("åˆæœŸã«æˆ»ã—ã¾ã—ãŸã€‚");
    }

    function escapeHTML(str) {
      return String(str ?? "")
        .replaceAll("&", "&amp;")
        .replaceAll("<", "&lt;")
        .replaceAll(">", "&gt;")
        .replaceAll('"', "&quot;")
        .replaceAll("'", "&#039;");
    }

    // ===== èµ·å‹• =====
    document.addEventListener("DOMContentLoaded", () => {
      document.getElementById("date").value = new Date().toISOString().slice(0, 10);

      records = loadRecords();
      residents = loadResidents();
      templates = loadTemplates();

      AUTO_ITEM_DEFS = loadAutoItemDefs();
      residentAutoTpl = loadResidentAutoTpl();
      daySupportDefs = loadDaySupportDefs();

      renderResidentSelects();
      renderRecords();
      setupTagButtons();
      setupQuickButtons();
      syncQuickButtonsAll();

      renderAutoItemCheckboxes();
      renderDaySupportCheckboxes();

      renderAutoItemManager();
      renderFavManageCheckboxes();

      renderDayItemManager();
      renderFavManageDaySupportCheckboxes();

      document.getElementById("templateScope").addEventListener("change", renderTemplateSelect);
      document.getElementById("templateScope").value = "common";
      renderTemplateSelect();

      document.getElementById("recordForm").addEventListener("submit", handleSubmit);
      document.getElementById("resetButton").addEventListener("click", resetForm);

      document.getElementById("filterResident").addEventListener("change", renderRecords);
      document.getElementById("searchKeyword").addEventListener("input", renderRecords);
      document.getElementById("searchClearButton").addEventListener("click", () => {
        document.getElementById("searchKeyword").value = "";
        renderRecords();
      });

      document.getElementById("periodFilter").addEventListener("change", () => {
        const val = document.getElementById("periodFilter").value;
        document.getElementById("customPeriodRow").style.display = (val === "custom") ? "flex" : "none";
        renderRecords();
      });
      document.getElementById("applyCustomPeriod").addEventListener("click", renderRecords);

      document.getElementById("autoSupportBtn").addEventListener("click", generateSupportText);
      document.getElementById("templateApplyButton").addEventListener("click", handleTemplateApply);
      document.getElementById("templateSaveButton").addEventListener("click", handleTemplateSave);
      document.getElementById("templateDeleteButton").addEventListener("click", handleTemplateDelete);

      // è©³ç´°ãƒ¢ãƒ¼ãƒ€ãƒ«
      const detailModal = document.getElementById("detailModal");
      document.getElementById("detailModalClose").addEventListener("click", closeRecordDetail);
      detailModal.addEventListener("click", (e) => { if (e.target === detailModal) closeRecordDetail(); });

      // åˆ©ç”¨è€…ç®¡ç†
      document.getElementById("residentAddButton").addEventListener("click", handleResidentAdd);
      document.getElementById("residentRenameButton").addEventListener("click", handleResidentRename);
      document.getElementById("residentDeleteButton").addEventListener("click", handleResidentDelete);

      // è‡ªå‹•å…¥åŠ›é …ç›® ç®¡ç†
      document.getElementById("autoItemSelect").addEventListener("change", fillAutoItemInputsBySelect);
      document.getElementById("autoItemSaveBtn").addEventListener("click", saveAutoItemFromInputs);
      document.getElementById("autoItemDeleteBtn").addEventListener("click", deleteSelectedAutoItem);
      document.getElementById("autoItemClearBtn").addEventListener("click", clearAutoItemInputs);
      document.getElementById("autoItemResetDefaultBtn").addEventListener("click", resetAutoItemsToDefault);

      // æ—¥ä¸­æ”¯æ´ãƒã‚§ãƒƒã‚¯é …ç›® ç®¡ç†
      document.getElementById("dayItemSelect").addEventListener("change", fillDayItemInputsBySelect);
      document.getElementById("dayItemSaveBtn").addEventListener("click", saveDayItemFromInputs);
      document.getElementById("dayItemDeleteBtn").addEventListener("click", deleteSelectedDayItem);
      document.getElementById("dayItemClearBtn").addEventListener("click", clearDayItemInputs);
      document.getElementById("dayItemResetDefaultBtn").addEventListener("click", resetDayItemsToDefault);

      // ã‚ˆãä½¿ã†é …ç›®ï¼ˆåˆ©ç”¨è€…åˆ¥ï¼‰
      document.getElementById("favManageResident").addEventListener("change", (e) => {
        syncFavManageUIFromResident(e.target.value);
      });
      document.getElementById("favManageSaveBtn").addEventListener("click", saveFavManageForResident);
      document.getElementById("favManageResetBtn").addEventListener("click", resetFavManageForResident);

      // ãƒ•ã‚©ãƒ¼ãƒ ï¼šåˆ©ç”¨è€…é¸æŠ â†’ è‡ªå‹•ONï¼ˆâ‘ ï¼‹â‘¡ï¼‰
      document.getElementById("resident").addEventListener("change", (e) => {
        applyResidentFavorites(e.target.value);
        applyResidentDaySupportFavorites(e.target.value);
      });

      // è‡ªå‹•ãƒ†ãƒ³ãƒ—ãƒ¬ç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ«
      document.getElementById("openResidentAutoTplBtn").addEventListener("click", openResidentAutoTplModal);
      const autoTplModal = document.getElementById("residentAutoTplModal");
      document.getElementById("residentAutoTplCloseBtn").addEventListener("click", closeResidentAutoTplModal);
      autoTplModal.addEventListener("click", (e) => { if (e.target === autoTplModal) closeResidentAutoTplModal(); });

      document.getElementById("residentAutoTplResident").addEventListener("change", (e) => {
        syncResidentAutoTplModalUIFromResident(e.target.value);
      });

      document.getElementById("residentAutoTplSaveBtn").addEventListener("click", saveResidentAutoTplFromModal);
      document.getElementById("residentAutoTplResetBtn").addEventListener("click", resetResidentAutoTplFromModal);

      // åˆæœŸåŒæœŸ
      const initFavResident = document.getElementById("favManageResident").value;
      if (initFavResident) syncFavManageUIFromResident(initFavResident);
    });
  </script>

  <!-- éŸ³å£°å…¥åŠ› -->
  <script>
    document.addEventListener("DOMContentLoaded", () => {
      const voiceBtn = document.getElementById("voiceSupportBtn");
      const voiceStatus = document.getElementById("voiceStatus");
      const support = document.getElementById("support");
      if (!voiceBtn || !voiceStatus || !support) return;

      const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
      if (!SpeechRecognition) {
        voiceBtn.disabled = true;
        voiceStatus.textContent = "â€» ã“ã®ãƒ–ãƒ©ã‚¦ã‚¶ã§ã¯éŸ³å£°å…¥åŠ›ãŒä½¿ãˆã¾ã›ã‚“ï¼ˆChrome / Edge æ¨å¥¨ï¼‰";
        return;
      }

      const recognition = new SpeechRecognition();
      recognition.lang = "ja-JP";
      recognition.interimResults = true;
      recognition.continuous = true;

      let recognizing = false;

      voiceBtn.addEventListener("click", () => {
        if (!recognizing) { try { recognition.start(); } catch(e) {} }
        else recognition.stop();
      });

      recognition.addEventListener("start", () => {
        recognizing = true;
        voiceBtn.textContent = "â–  åœæ­¢";
        voiceStatus.textContent = "éŸ³å£°å…¥åŠ›ä¸­â€¦ è©±ã—çµ‚ã‚ã£ãŸã‚‰ã‚‚ã†ä¸€åº¦ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦åœæ­¢ã—ã¦ãã ã•ã„ã€‚";
      });

      recognition.addEventListener("end", () => {
        recognizing = false;
        voiceBtn.textContent = "ğŸ™ éŸ³å£°å…¥åŠ›";
        voiceStatus.textContent = "";
      });

      recognition.addEventListener("result", (event) => {
        let finalText = "";
        for (let i = event.resultIndex; i < event.results.length; i++) {
          const res = event.results[i];
          if (res.isFinal) finalText += res[0].transcript;
        }
        if (!finalText) return;
        support.value = support.value.trim() ? (support.value.replace(/\s*$/, "") + "\n" + finalText) : finalText;
      });

      recognition.addEventListener("error", (e) => {
        recognizing = false;
        voiceBtn.textContent = "ğŸ™ éŸ³å£°å…¥åŠ›";
        voiceStatus.textContent = "éŸ³å£°å…¥åŠ›ã‚¨ãƒ©ãƒ¼ï¼š" + e.error;
      });
    });
  </script>
</body>
</html>
