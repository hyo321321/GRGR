<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>ã‚°ãƒ«ãƒ¼ãƒ—ãƒ›ãƒ¼ãƒ  å€‹äººè¨˜éŒ²</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <style>
    * { box-sizing: border-box; }

    body {
      margin: 0;
      font-family: -apple-system, BlinkMacSystemFont, "Helvetica Neue",
        "YuGothic", "Meiryo", sans-serif;
      background: #f3f4f6;
      color: #111827;
      font-size: 16px;
      line-height: 1.6;
    }

    header {
      background: #2563eb;
      color: white;
      padding: 16px 18px;
      font-size: 22px;
      font-weight: bold;
      text-align: center;
      position: sticky;
      top: 0;
      z-index: 10;
    }

    main {
      max-width: 1280px;
      margin: 0 auto;
      padding: 18px;
    }

    .layout {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 18px;
    }

    @media (max-width: 900px) {
      .layout { grid-template-columns: 1fr; }
    }

    .card {
      background: white;
      border-radius: 18px;
      padding: 20px 22px 22px;
      box-shadow: 0 8px 24px rgba(15, 23, 42, 0.1);
      margin-bottom: 18px;
    }

    .card-title {
      font-size: 20px;
      font-weight: 600;
      margin-bottom: 14px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 10px;
      flex-wrap: wrap;
    }

    .card-subtitle {
      font-size: 13px;
      color: #6b7280;
      margin-bottom: 14px;
    }

    label {
      font-size: 14px;
      font-weight: 600;
      display: block;
      margin-bottom: 5px;
      color: #374151;
    }

    input[type="text"],
    input[type="date"],
    select,
    textarea {
      width: 100%;
      border-radius: 12px;
      border: 1px solid #d1d5db;
      padding: 10px 12px;
      font-size: 15px;
      outline: none;
      transition: border-color 0.15s, box-shadow 0.15s;
      background: #f9fafb;
    }

    input[type="text"]:focus,
    input[type="date"]:focus,
    select:focus,
    textarea:focus {
      border-color: #2563eb;
      box-shadow: 0 0 0 1px rgba(37, 99, 235, 0.5);
      background: white;
    }

    textarea { min-height: 80px; resize: vertical; }

    .field-row {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 12px;
    }

    .field-row-3 {
      display: grid;
      grid-template-columns: repeat(3, minmax(0, 1fr));
      gap: 12px;
    }

    .field { margin-bottom: 12px; }

    .checkbox-row {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      align-items: center;
      margin-bottom: 6px;
    }

    .checkbox-row label {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      font-weight: 500;
      font-size: 14px;
      margin-bottom: 0;
    }

    .btn-row {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      margin-top: 12px;
      align-items: center;
    }

    button {
      border: none;
      border-radius: 999px;
      padding: 10px 18px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: transform 0.05s ease-out, box-shadow 0.1s;
      display: inline-flex;
      align-items: center;
      gap: 4px;
      user-select: none;
    }

    button:active { transform: translateY(1px); box-shadow: none; }

    .btn-primary {
      background: #2563eb;
      color: white;
      box-shadow: 0 4px 12px rgba(37, 99, 235, 0.4);
    }

    .btn-secondary { background: #e5e7eb; color: #111827; }

    .btn-danger { background: #dc2626; color: white; }

    .pill {
      border-radius: 999px;
      background: #eff6ff;
      padding: 4px 11px;
      font-size: 12px;
      color: #1d4ed8;
      border: 1px solid #bfdbfe;
    }

    .record-count { font-size: 13px; color: #6b7280; }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 13px;
      margin-top: 6px;
    }

    thead {
      position: sticky;
      top: 0;
      background: #eff6ff;
      z-index: 1;
    }

    th, td {
      border-bottom: 1px solid #e5e7eb;
      padding: 8px 6px;
      text-align: left;
      vertical-align: top;
    }

    th {
      font-weight: 600;
      color: #374151;
      white-space: nowrap;
    }

    tbody tr:nth-child(even) { background: #f9fafb; }

    .table-wrapper {
      max-height: 520px;
      overflow: auto;
      border-radius: 14px;
      border: 1px solid #e5e7eb;
      margin-top: 10px;
    }

    .badge {
      display: inline-block;
      padding: 3px 9px;
      border-radius: 999px;
      font-size: 11px;
      font-weight: 600;
      color: white;
    }

    .badge-day { background: #22c55e; }
    .badge-evening { background: #f59e0b; }
    .badge-night { background: #6366f1; }

    .small-text { font-size: 12px; color: #6b7280; }

    .no-records {
      padding: 14px;
      font-size: 13px;
      color: #6b7280;
      text-align: center;
    }

    .resident-select-row {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      margin-bottom: 10px;
      align-items: center;
    }

    .resident-select-row span { font-size: 13px; color: #4b5563; }
    .resident-select-row select { max-width: 240px; }

    /* ã‚¿ã‚°ãƒœã‚¿ãƒ³ã¾ã‚ã‚Š */
    .tag-buttons {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      margin-bottom: 4px;
    }

    .tag-button {
      border-radius: 999px;
      border: 1px solid #e5e7eb;
      background: #f3f4f6;
      padding: 4px 10px;
      font-size: 12px;
      cursor: pointer;
    }

    .tag-button.tag-button-active {
      background: #f59e0b;
      border-color: #f97316;
      color: #fff;
    }

    .tag-chip {
      display: inline-block;
      margin-top: 2px;
      margin-right: 4px;
      padding: 2px 7px;
      border-radius: 999px;
      border: 1px solid #fde68a;
      background: #fffbeb;
      font-size: 11px;
    }

    /* PCè‹¦æ‰‹ãªäººå‘ã‘ï¼šå¤§ããªé¸æŠãƒœã‚¿ãƒ³ */
    .quick-row {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      margin-top: 6px;
      margin-bottom: 4px;
    }

    .quick-btn {
      flex: 1 0 0;
      min-width: 70px;
      justify-content: center;
      padding: 8px 10px;
      border-radius: 999px;
      border: 1px solid #d1d5db;
      background: #f3f4f6;
      font-size: 13px;
      cursor: pointer;
    }

    .quick-btn-active {
      background: #2563eb;
      color: #fff;
      border-color: #1d4ed8;
      box-shadow: 0 0 0 1px rgba(37, 99, 235, 0.4);
    }

    /* è©³ç´°ãƒ¢ãƒ¼ãƒ€ãƒ« */
    .detail-modal-backdrop {
      position: fixed;
      inset: 0;
      background: rgba(15, 23, 42, 0.45);
      display: none;
      align-items: center;
      justify-content: center;
      padding: 16px;
      z-index: 50;
    }

    .detail-modal-backdrop.show { display: flex; }

    .detail-modal {
      background: #ffffff;
      border-radius: 18px;
      max-width: 820px;
      width: 100%;
      max-height: 90vh;
      padding: 18px 20px 20px;
      box-shadow: 0 20px 40px rgba(15, 23, 42, 0.35);
      overflow: auto;
    }

    .detail-modal-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
      margin-bottom: 8px;
      flex-wrap: wrap;
    }

    .detail-modal-title { font-size: 18px; font-weight: 600; }

    .detail-modal-close {
      border-radius: 999px;
      border: none;
      padding: 4px 10px;
      font-size: 16px;
      cursor: pointer;
      background: #e5e7eb;
    }

    .detail-modal-body { font-size: 14px; color: #111827; }

    .detail-field { margin-bottom: 6px; }
    .detail-field strong { display: inline-block; min-width: 120px; color: #4b5563; }

    .detail-multiline { margin-top: 8px; margin-bottom: 8px; }
    .detail-multiline strong { display: block; margin-bottom: 2px; color: #4b5563; }

    .detail-multiline pre {
      margin: 0;
      padding: 8px 10px;
      background: #f9fafb;
      border-radius: 10px;
      border: 1px solid #e5e7eb;
      white-space: pre-wrap;
      word-break: break-word;
      font-family: inherit;
      font-size: 13px;
    }

    /* è‡ªå‹•ãƒ†ãƒ³ãƒ—ãƒ¬ç·¨é›†ç”¨ */
    .auto-editor-grid {
      display: grid;
      grid-template-columns: 1fr;
      gap: 10px;
      margin-top: 10px;
    }

    .auto-editor-item {
      border: 1px solid #e5e7eb;
      border-radius: 14px;
      padding: 10px 12px;
      background: #ffffff;
    }

    .auto-editor-item label {
      margin-bottom: 6px;
      font-size: 13px;
      color: #374151;
    }

    .auto-editor-item textarea {
      min-height: 72px;
      font-size: 13px;
    }

    .auto-editor-hint {
      font-size: 12px;
      color: #6b7280;
      margin-top: 6px;
      line-height: 1.5;
    }

    .mono {
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size: 12px;
      background: #f3f4f6;
      border: 1px solid #e5e7eb;
      padding: 6px 8px;
      border-radius: 10px;
      display: inline-block;
    }
  </style>
</head>

<body>
  <header>ã‚°ãƒ«ãƒ¼ãƒ—ãƒ›ãƒ¼ãƒ  å€‹äººè¨˜éŒ² WEBã‚¢ãƒ—ãƒªï¼ˆã‚¿ã‚°ãƒ»æ¤œç´¢ä»˜ãï¼‰</header>

  <main>
    <div class="layout">
      <!-- å…¥åŠ›ãƒ•ã‚©ãƒ¼ãƒ  -->
      <section class="card">
        <div class="card-title">
          <span>ä»Šæ—¥ã®å€‹äººè¨˜éŒ²</span>
          <span class="pill" id="modeLabel">æ–°è¦å…¥åŠ›ãƒ¢ãƒ¼ãƒ‰</span>
        </div>
        <div class="card-subtitle">
          åˆ©ç”¨è€…ã‚’é¸ã³ã€æ—¥ä¸­ã®æ§˜å­ãƒ»æ”¯æ´å†…å®¹ãƒ»æœè–¬çŠ¶æ³ãªã©ã‚’è¨˜éŒ²ã—ã¾ã™ã€‚<br>
          ãƒ‘ã‚½ã‚³ãƒ³æ“ä½œã«ä¸æ…£ã‚Œãªæ–¹ã§ã‚‚ã€ã§ãã‚‹ã ã‘ã€Œãƒœã‚¿ãƒ³ã‚’æŠ¼ã™ã ã‘ã€ã§å…¥åŠ›ã§ãã‚‹ã‚ˆã†ã«ã—ã¦ã„ã¾ã™ã€‚
        </div>

        <form id="recordForm">
          <div class="field-row">
            <div class="field">
              <label for="date">æ—¥ä»˜</label>
              <input type="date" id="date" required />
            </div>
            <div class="field">
              <label for="resident">åˆ©ç”¨è€…</label>
              <select id="resident" required></select>
            </div>
          </div>

          <div class="field-row-3">
            <div class="field">
              <label for="timeSlot">æ™‚é–“å¸¯</label>
              <select id="timeSlot">
                <option>æ—¥ä¸­</option>
                <option>å¤•æ–¹</option>
                <option>å¤œé–“</option>
              </select>
              <div class="quick-row" data-target="timeSlot">
                <button type="button" class="quick-btn" data-value="æ—¥ä¸­">æ—¥ä¸­</button>
                <button type="button" class="quick-btn" data-value="å¤•æ–¹">å¤•æ–¹</button>
                <button type="button" class="quick-btn" data-value="å¤œé–“">å¤œé–“</button>
              </div>
              <div class="small-text">ä¸Šã®ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯ã™ã‚‹ã¨æ™‚é–“å¸¯ãŒé¸æŠã•ã‚Œã¾ã™ã€‚</div>
            </div>

            <div class="field">
              <label for="condition">ä½“èª¿</label>
              <select id="condition">
                <option>è‰¯å¥½</option>
                <option>æ™®é€š</option>
                <option>ä¸è‰¯</option>
              </select>
              <div class="quick-row" data-target="condition">
                <button type="button" class="quick-btn" data-value="è‰¯å¥½">ğŸ˜Š è‰¯å¥½</button>
                <button type="button" class="quick-btn" data-value="æ™®é€š">ğŸ˜ æ™®é€š</button>
                <button type="button" class="quick-btn" data-value="ä¸è‰¯">ğŸ˜Ÿ ä¸è‰¯</button>
              </div>
              <div class="small-text">ãƒœã‚¿ãƒ³ã‚’æŠ¼ã™ã ã‘ã§ä½“èª¿ã‚’é¸ã¹ã¾ã™ã€‚</div>
            </div>

            <div class="field">
              <label for="mental">å¿ƒã®çŠ¶æ…‹</label>
              <select id="mental">
                <option>å®‰å®š</option>
                <option>ã‚„ã‚„ä¸å®‰</option>
                <option>ä¸å®‰å®š</option>
              </select>
              <div class="quick-row" data-target="mental">
                <button type="button" class="quick-btn" data-value="å®‰å®š">ğŸ˜Š å®‰å®š</button>
                <button type="button" class="quick-btn" data-value="ã‚„ã‚„ä¸å®‰">ğŸ˜ ã‚„ã‚„ä¸å®‰</button>
                <button type="button" class="quick-btn" data-value="ä¸å®‰å®š">ğŸ˜Ÿ ä¸å®‰å®š</button>
              </div>
              <div class="small-text">å¿ƒã®çŠ¶æ…‹ã‚‚ãƒœã‚¿ãƒ³ã§é¸ã¹ã¾ã™ã€‚</div>
            </div>
          </div>

          <div class="field">
            <label for="meal">é£Ÿäº‹ã®æ§˜å­ï¼ˆæœãƒ»æ˜¼ãƒ»å¤• / æ‘‚å–é‡ãªã©ï¼‰</label>
            <input type="text" id="meal" placeholder="ä¾‹ï¼‰æœï¼šå®Œé£Ÿ / æ˜¼ï¼š7å‰² / å¤•ï¼šå°‘ãªã‚ ãªã©" />
          </div>

          <div class="field">
            <div class="checkbox-row">
              <label>
                <input type="checkbox" id="medTaken" />
                æœè–¬æ¸ˆã¿
              </label>
              <span class="small-text">ï¼ˆé£²ã¿å¿˜ã‚ŒãŒã‚ã‚Œã°ä¸‹ã®æ”¯æ´å†…å®¹ã«è¨˜å…¥ï¼‰</span>
            </div>
          </div>

          <div class="field">
            <label>ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ï¼ˆã‚¿ã‚°ï¼‰</label>
            <div class="tag-buttons" id="tagButtons"></div>
            <div class="small-text" id="selectedTagsInfo">é¸æŠä¸­ï¼šãªã—</div>
          </div>

          <!-- è‡ªå‹•å…¥åŠ›å¯¾è±¡ï¼ˆåˆ©ç”¨è€…åˆ¥ãƒ†ãƒ³ãƒ—ãƒ¬ï¼‰ -->
          <div class="field">
            <div style="display:flex; align-items:center; justify-content:space-between; gap:10px; flex-wrap:wrap;">
              <label style="margin:0;">è‡ªå‹•å…¥åŠ›ã—ãŸã„æ”¯æ´é …ç›®ï¼ˆåˆ©ç”¨è€…åˆ¥ãƒ†ãƒ³ãƒ—ãƒ¬ï¼‰</label>
              <button type="button" class="btn-secondary" id="openAutoTemplateEditor" style="font-size:12px; padding:6px 10px;">
                âš™ è‡ªå‹•ãƒ†ãƒ³ãƒ—ãƒ¬ç·¨é›†
              </button>
            </div>

            <div class="checkbox-row" id="autoItemsContainer">
              <!-- JSã§ç”Ÿæˆ -->
            </div>

            <div class="small-text">
              ãƒ»ã€è‡ªå‹•ã€ã¯ã€ãƒã‚§ãƒƒã‚¯ã—ãŸé …ç›®ã®<strong>å®šå‹æ–‡ã ã‘</strong>ã‚’ä¸Šã‹ã‚‰é †ã«è¿½è¨˜ã—ã¾ã™ï¼ˆä¸Šæ›¸ãã—ã¾ã›ã‚“ï¼‰ã€‚<br>
              ãƒ»åˆ©ç”¨è€…åˆ¥ã®ãƒ†ãƒ³ãƒ—ãƒ¬ãŒç„¡ã„å ´åˆã¯ã€Œå…±é€šï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆï¼‰ã€ãŒä½¿ã‚ã‚Œã¾ã™ã€‚
            </div>
          </div>

          <!-- æ—¥ä¸­æ”¯æ´åŠ ç®— åŒºåˆ† -->
          <div class="field">
            <label for="daySupportType">æ—¥ä¸­æ”¯æ´åŠ ç®—ã®åŒºåˆ†</label>
            <select id="daySupportType">
              <option value="">é¸æŠãªã—</option>
              <option value="â… ">æ—¥ä¸­æ”¯æ´åŠ ç®—â… </option>
              <option value="â…¡">æ—¥ä¸­æ”¯æ´åŠ ç®—â…¡</option>
            </select>
            <div class="small-text">æ—¥ä¸­æ”¯æ´åŠ ç®—ã«è©²å½“ã™ã‚‹å ´åˆã®ã¿ã€â…  / â…¡ ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚</div>
          </div>

          <!-- æ—¥ä¸­æ”¯æ´åŠ ç®—ã®çŠ¶æ³ãƒ»æ”¯æ´å†…å®¹ï¼ˆãƒã‚§ãƒƒã‚¯ï¼‰ -->
          <div class="field">
            <label>æ—¥ä¸­æ”¯æ´åŠ ç®—ã«é–¢ã‚ã‚‹çŠ¶æ³ãƒ»æ”¯æ´å†…å®¹ï¼ˆãƒã‚§ãƒƒã‚¯ç”¨ãƒ¡ãƒ¢ï¼‰</label>
            <div class="small-text" style="margin-bottom:4px;">
              è©²å½“ã™ã‚‹ã‚‚ã®ã«ãƒã‚§ãƒƒã‚¯ã—ã¦ãã ã•ã„ï¼ˆãƒ†ãƒ³ãƒ—ãƒ¬æ–‡ç« ã®è£œè¶³ã«åˆ©ç”¨ã§ãã¾ã™ï¼‰ã€‚
            </div>

            <div class="checkbox-row"><span class="small-text">ã€æ—¥ä¸­æ´»å‹•ã«è¡Œã‘ãªã‹ã£ãŸç†ç”±ã€‘</span></div>
            <div class="checkbox-row">
              <label>
                <input type="checkbox" class="day-support-item" value="ä½“èª¿ä¸è‰¯ã§æ—¥ä¸­æ´»å‹•ã‚’æ¬ å¸­" />
                ä½“èª¿ä¸è‰¯ã§æ—¥ä¸­æ´»å‹•ï¼ˆé€šæ‰€ãƒ»å°±åŠ´ï¼‰ã‚’æ¬ å¸­
              </label>
              <label>
                <input type="checkbox" class="day-support-item" value="é€šæ‰€å…ˆãƒ»å°±åŠ´å…ˆãŒä¼‘ã¿ã‚„è‡¨æ™‚ä¼‘æ¥­ã§åœ¨å®…" />
                é€šæ‰€å…ˆãƒ»å°±åŠ´å…ˆãŒä¼‘ã¿ï¼è‡¨æ™‚ä¼‘æ¥­ã®ãŸã‚åœ¨å®…
              </label>
            </div>
            <div class="checkbox-row">
              <label>
                <input type="checkbox" class="day-support-item" value="éšœå®³ç‰¹æ€§ã‚„è¡Œå‹•é¢ã®ä¸å®‰ã§æ—¥ä¸­æ´»å‹•åˆ©ç”¨ãŒå›°é›£" />
                éšœå®³ç‰¹æ€§ãƒ»è¡Œå‹•é¢ã®ä¸å®‰ã§æ—¥ä¸­æ´»å‹•åˆ©ç”¨ãŒå›°é›£
              </label>
              <label>
                <input type="checkbox" class="day-support-item" value="åŒ»å¸«ã®æŒ‡ç¤ºã§å¤–å‡ºã‚„é€šæ‰€ã‚’æ§ãˆã¦ã„ã‚‹" />
                åŒ»å¸«ã®æŒ‡ç¤ºã§å¤–å‡ºãƒ»é€šæ‰€ã‚’æ§ãˆã¦ã„ã‚‹
              </label>
            </div>

            <div class="checkbox-row" style="margin-top:8px;"><span class="small-text">ã€æ—¥ä¸­ã«è¡Œã£ãŸä¸»ãªæ”¯æ´ã€‘</span></div>
            <div class="checkbox-row">
              <label>
                <input type="checkbox" class="day-support-item" value="ä½“èª¿ç®¡ç†ï¼ˆæ¤œæ¸©ãƒ»ç—‡çŠ¶ç¢ºèªãƒ»å®‰é™ã®è¦‹å®ˆã‚Šãªã©ï¼‰" />
                ä½“èª¿ç®¡ç†ï¼ˆæ¤œæ¸©ãƒ»ç—‡çŠ¶ç¢ºèªãƒ»å®‰é™ã®è¦‹å®ˆã‚Šãªã©ï¼‰
              </label>
              <label>
                <input type="checkbox" class="day-support-item" value="é£Ÿäº‹ã®æ”¯æ´ï¼ˆæº–å‚™ãƒ»é…è†³ãƒ»ä»‹åŠ©ãƒ»æ‘‚å–é‡ã®è¦³å¯Ÿãªã©ï¼‰" />
                é£Ÿäº‹ã®æ”¯æ´ï¼ˆæº–å‚™ãƒ»é…è†³ãƒ»ä»‹åŠ©ï¼‰
              </label>
            </div>
            <div class="checkbox-row">
              <label>
                <input type="checkbox" class="day-support-item" value="æœè–¬ç®¡ç†ãƒ»å†…æœç¢ºèªï¼ˆæ—¥ä¸­ã®æœè–¬å£°ã‹ã‘ã‚„æ®‹è–¬ç¢ºèªãªã©ï¼‰" />
                æœè–¬ç®¡ç†ãƒ»å†…æœç¢ºèª
              </label>
              <label>
                <input type="checkbox" class="day-support-item" value="æ°´åˆ†ãƒ»ãƒˆã‚¤ãƒ¬ã®å£°ã‹ã‘ã‚„èª˜å°ãƒ»ä»‹åŠ©" />
                æ°´åˆ†ãƒ»ãƒˆã‚¤ãƒ¬ã®å£°ã‹ã‘ãƒ»ä»‹åŠ©
              </label>
            </div>
            <div class="checkbox-row">
              <label>
                <input type="checkbox" class="day-support-item" value="å…¥æµ´ã‚„æ¸…æ½”ä¿æŒã®æ”¯æ´ï¼ˆæ´—é¢ãƒ»æ›´è¡£ãƒ»æ•´å®¹ãªã©ï¼‰" />
                å…¥æµ´ãƒ»æ¸…æ½”ä¿æŒã®æ”¯æ´
              </label>
              <label>
                <input type="checkbox" class="day-support-item" value="è¡Œå‹•ã‚„å®‰å…¨é¢ã®è¦‹å®ˆã‚Šï¼ˆè»¢å€’ãƒ»å¾˜å¾Šãªã©ã¸ã®å¯¾å¿œï¼‰" />
                è¡Œå‹•ã‚„å®‰å…¨é¢ã®è¦‹å®ˆã‚Š
              </label>
            </div>
            <div class="checkbox-row">
              <label>
                <input type="checkbox" class="day-support-item" value="å¿ƒç†é¢ã®æ”¯æ´ã‚„ç›¸è«‡ï¼ˆä¸å®‰æ™‚ã®å‚¾è´ã‚„æ°—åˆ†è»¢æ›ãªã©ï¼‰" />
                å¿ƒç†é¢ã®æ”¯æ´ã‚„ç›¸è«‡
              </label>
              <label>
                <input type="checkbox" class="day-support-item" value="æ—¥ä¸­ã®æ´»å‹•æ”¯æ´ã‚„ç”Ÿæ´»ãƒªã‚ºãƒ ã®èª¿æ•´" />
                æ—¥ä¸­ã®æ´»å‹•æ”¯æ´ãƒ»ç”Ÿæ´»ãƒªã‚ºãƒ ã®èª¿æ•´
              </label>
            </div>
          </div>

          <div class="field">
            <label for="daySupportTime">æ—¥ä¸­æ”¯æ´ã®ä¸»ãªæ™‚é–“å¸¯ï¼ˆä»»æ„ï¼‰</label>
            <input type="text" id="daySupportTime" placeholder="ä¾‹ï¼‰9:00ã€œ15:00 ã®é–“ã€å±…å®¤ã¨å…±æœ‰ã‚¹ãƒšãƒ¼ã‚¹ã§ç¶™ç¶šçš„ã«è¦‹å®ˆã‚Šæ”¯æ´" />
          </div>

          <!-- è‡ªä½œãƒ†ãƒ³ãƒ—ãƒ¬ç®¡ç†ï¼ˆé …ç›®ã”ã¨ï¼‰ -->
          <div class="field">
            <label>æ”¯æ´å†…å®¹ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆï¼ˆè‡ªä½œï¼‰</label>

            <div class="field-row">
              <div class="field">
                <label for="templateScope" class="small-text">ãƒ†ãƒ³ãƒ—ãƒ¬ã®å¯¾è±¡é …ç›®</label>
                <select id="templateScope"></select>
                <div class="small-text">å¯¾è±¡ã‚’é¸ã¶ã¨ã€ãã®é …ç›®ç”¨ã®ãƒ†ãƒ³ãƒ—ãƒ¬ä¸€è¦§ãŒä¸‹ã«è¡¨ç¤ºã•ã‚Œã¾ã™ã€‚</div>
              </div>
              <div class="field">
                <label for="templateNameInput" class="small-text">ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆå</label>
                <input type="text" id="templateNameInput" placeholder="ä¾‹ï¼šæœè–¬ç®¡ç†ãƒ»å®‰å®šãƒ‘ã‚¿ãƒ¼ãƒ³" />
                <div class="small-text">ä»Šã®ã€Œæœ¬æ—¥ã®æ”¯æ´å†…å®¹ãƒ»æ§˜å­ã€ã‚’ã€ã“ã®åå‰ãƒ»å¯¾è±¡é …ç›®ã®ãƒ†ãƒ³ãƒ—ãƒ¬ã¨ã—ã¦ä¿å­˜ã—ã¾ã™ã€‚</div>
              </div>
            </div>

            <div class="field" style="margin-top:8px;">
              <select id="templateSelect">
                <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
              </select>
              <div class="small-text">
                ãƒ»ã€ãƒ†ãƒ³ãƒ—ãƒ¬æŒ¿å…¥ã€ã¯ã€é¸ã‚“ã ãƒ†ãƒ³ãƒ—ãƒ¬ã‚’è¿½è¨˜ã—ã¾ã™ï¼ˆä¸Šæ›¸ãã—ã¾ã›ã‚“ï¼‰ã€‚<br>
                ãƒ»ã€è‡ªå‹•ã€ã¯ã€ãƒã‚§ãƒƒã‚¯ã—ãŸé …ç›®ã®å®šå‹æ–‡ï¼ˆåˆ©ç”¨è€…åˆ¥ãƒ†ãƒ³ãƒ—ãƒ¬ï¼‰ã‚’è¿½è¨˜ã—ã¾ã™ã€‚
              </div>
            </div>

            <div class="btn-row">
              <button type="button" class="btn-secondary" id="templateApplyButton">ãƒ†ãƒ³ãƒ—ãƒ¬æŒ¿å…¥</button>
              <button type="button" class="btn-primary" id="templateSaveButton">ãƒ†ãƒ³ãƒ—ãƒ¬ä¿å­˜ / ä¸Šæ›¸ã</button>
              <button type="button" class="btn-danger" id="templateDeleteButton">é¸æŠãƒ†ãƒ³ãƒ—ãƒ¬å‰Šé™¤</button>
            </div>
            <div class="small-text">â€»ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã¯ã“ã®ãƒ‘ã‚½ã‚³ãƒ³ã®ãƒ–ãƒ©ã‚¦ã‚¶ã«ä¿å­˜ã•ã‚Œã¾ã™ã€‚ä»–ã®PCã¨ã¯å…±æœ‰ã•ã‚Œã¾ã›ã‚“ã€‚</div>
          </div>

          <div class="field">
            <label for="support">æœ¬æ—¥ã®æ”¯æ´å†…å®¹ãƒ»æ§˜å­</label>
            <textarea id="support" rows="8" placeholder="ã€æ¨™æº–ã®æ›¸ãæ–¹ä¾‹ã€‘
æ—¥ä¸­ã¯è½ã¡ç€ã„ã¦ç©ã‚„ã‹ã«éã”ã•ã‚Œã‚‹ã€‚é£Ÿäº‹ãƒ»æœè–¬ã¨ã‚‚ã«è¦‹å®ˆã‚Šä¸­å¿ƒã§å®Ÿæ–½ã€‚
å¿…è¦æ™‚ã®ã¿å£°ã‹ã‘ãƒ»ä»‹åŠ©ã‚’è¡Œã£ãŸã€‚"></textarea>
          </div>

          <div class="btn-row">
            <button type="button" class="btn-secondary" id="autoSupportBtn">è‡ªå‹•</button>
            <button type="button" class="btn-secondary" id="voiceSupportBtn">ğŸ™ éŸ³å£°å…¥åŠ›</button>

            <span class="small-text">
              ãƒ»ã€è‡ªå‹•ã€ã¯ãƒã‚§ãƒƒã‚¯é …ç›®ã®å®šå‹æ–‡ã‚’è¿½è¨˜<br>
              ãƒ»ã€ãƒ†ãƒ³ãƒ—ãƒ¬æŒ¿å…¥ã€ã¯ãƒ—ãƒ«ãƒ€ã‚¦ãƒ³ã®ãƒ†ãƒ³ãƒ—ãƒ¬ã‚’è¿½è¨˜<br>
              ãƒ»ã©ã¡ã‚‰ã‚‚ä¸Šæ›¸ãã›ãšã€ä¸‹ã«è¿½è¨˜ã—ã¾ã™<br>
              ãƒ»ğŸ™ éŸ³å£°å…¥åŠ›ã‚‚è¿½è¨˜ã•ã‚Œã¾ã™
            </span>
          </div>
          <div class="small-text" id="voiceStatus" style="margin-top:4px;"></div>

          <div class="field">
            <label for="note">ç‰¹è¨˜äº‹é …ï¼ˆäº‹æ•…ãƒ»ãƒˆãƒ©ãƒ–ãƒ«ãƒ»å—è¨ºãƒ»ç›¸è«‡ãªã©ï¼‰</label>
            <textarea id="note" rows="4" placeholder="ä¾‹ï¼‰é€šé™¢ã€å®¶æ—ã‹ã‚‰ã®é›»è©±ã€å¤œé–“ã®è¦‹å®ˆã‚Šå¼·åŒ–ãŒå¿…è¦ ãªã©"></textarea>
          </div>

          <div class="btn-row">
            <button type="submit" class="btn-primary" id="saveButton">ğŸ’¾ è¨˜éŒ²ã‚’ä¿å­˜</button>
            <button type="button" class="btn-secondary" id="resetButton">ğŸ§¹ å…¥åŠ›ãƒªã‚»ãƒƒãƒˆ</button>
          </div>
        </form>
      </section>

      <!-- ä¸€è¦§è¡¨ç¤º -->
      <section class="card">
        <div class="card-title">
          <span>è¨˜éŒ²ä¸€è¦§</span>
          <div style="display:flex; align-items:center; gap:8px;">
            <button type="button"
                    onclick="window.open('records.html', '_blank')"
                    class="btn-secondary"
                    style="font-size:12px; padding:6px 10px;">
              ğŸ“„ åˆ¥ãƒšãƒ¼ã‚¸ã§é–‹ã
            </button>
            <span class="record-count" id="recordCount">0ä»¶</span>
          </div>
        </div>

        <div class="resident-select-row">
          <span>è¡¨ç¤ºã™ã‚‹åˆ©ç”¨è€…ï¼š</span>
          <select id="filterResident"></select>
          <span class="small-text">â€»ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã‚’å¤‰ãˆã‚‹ã¨ã€ãã®åˆ©ç”¨è€…ã®è¨˜éŒ²ã ã‘è¡¨ç¤ºã•ã‚Œã¾ã™ã€‚</span>
        </div>

        <div class="resident-select-row">
          <span>æœŸé–“ï¼š</span>
          <select id="periodFilter">
            <option value="today">ä»Šæ—¥</option>
            <option value="week">ç›´è¿‘7æ—¥é–“</option>
            <option value="month" selected>ä»Šæœˆ</option>
            <option value="year">ä»Šå¹´</option>
            <option value="all">å…¨æœŸé–“</option>
            <option value="custom">æ—¥ä»˜æŒ‡å®š</option>
          </select>
          <span class="small-text">â€»å…¨æœŸé–“ã¯ä»¶æ•°ãŒå¤šããªã‚‹å ´åˆãŒã‚ã‚Šã¾ã™ã€‚</span>
        </div>

        <div class="resident-select-row" id="customPeriodRow" style="display:none;">
          <span>æœŸé–“æŒ‡å®šï¼š</span>
          <input type="date" id="periodFrom">
          <span>ã€œ</span>
          <input type="date" id="periodTo">
          <button type="button" class="btn-secondary" id="applyCustomPeriod">åæ˜ </button>
        </div>

        <div class="resident-select-row">
          <span>ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰æ¤œç´¢ï¼š</span>
          <input type="text" id="searchKeyword" placeholder="ä¾‹ï¼šé€šé™¢, å¤œé–“, #ä½“èª¿ä¸è‰¯ ãªã©" style="flex:1; min-width:180px;" />
          <button type="button" class="btn-secondary" id="searchClearButton">ã‚¯ãƒªã‚¢</button>
        </div>

        <div class="table-wrapper" id="tableWrapper">
          <table>
            <thead>
              <tr>
                <th>æ—¥ä»˜</th>
                <th>åˆ©ç”¨è€…</th>
                <th>æ™‚é–“å¸¯</th>
                <th>ä½“èª¿ / å¿ƒã®çŠ¶æ…‹</th>
                <th>æ”¯æ´å†…å®¹ãƒ»ã‚¿ã‚°</th>
                <th>æœè–¬</th>
                <th>æ“ä½œ</th>
              </tr>
            </thead>
            <tbody id="recordTableBody"></tbody>
          </table>
        </div>
      </section>
    </div>

    <!-- åˆ©ç”¨è€…ç®¡ç† -->
    <section class="card">
      <div class="card-title">
        <span>åˆ©ç”¨è€…ç®¡ç†</span>
        <span class="record-count" id="residentCount">0å</span>
      </div>
      <div class="card-subtitle">
        åˆ©ç”¨è€…åã®è¿½åŠ ãƒ»å¤‰æ›´ãƒ»å‰Šé™¤ã‚’è¡Œã„ã¾ã™ã€‚ã“ã“ã§å¤‰æ›´ã™ã‚‹ã¨ã€è¨˜éŒ²ä¸€è¦§ã®è¡¨ç¤ºã«ã‚‚åæ˜ ã•ã‚Œã¾ã™ã€‚
      </div>

      <div class="field-row">
        <div class="field">
          <label for="residentManageSelect">å¯¾è±¡ã®åˆ©ç”¨è€…</label>
          <select id="residentManageSelect"></select>
        </div>
        <div class="field">
          <label for="residentNameInput">åå‰ï¼ˆè¿½åŠ ãƒ»å¤‰æ›´å¾Œï¼‰</label>
          <input type="text" id="residentNameInput" placeholder="ä¾‹ï¼šAã•ã‚“" />
        </div>
      </div>

      <div class="btn-row">
        <button type="button" class="btn-primary" id="residentAddButton">ï¼‹ æ–°ã—ãè¿½åŠ </button>
        <button type="button" class="btn-secondary" id="residentRenameButton">âœï¸ é¸æŠã‚’ã“ã®åå‰ã«å¤‰æ›´</button>
        <button type="button" class="btn-danger" id="residentDeleteButton">ğŸ—‘ï¸ åˆ©ç”¨è€…ã¨è¨˜éŒ²ã‚’å‰Šé™¤</button>
      </div>

      <div class="small-text" style="margin-top:6px;">
        â€»å‰Šé™¤ã™ã‚‹ã¨ã€ãã®åˆ©ç”¨è€…ã®ã™ã¹ã¦ã®è¨˜éŒ²ã‚‚å‰Šé™¤ã•ã‚Œã¾ã™ã€‚
      </div>
    </section>
  </main>

  <!-- è¨˜éŒ²ã®è©³ç´°ãƒ¢ãƒ¼ãƒ€ãƒ« -->
  <div id="detailModal" class="detail-modal-backdrop">
    <div class="detail-modal">
      <div class="detail-modal-header">
        <div class="detail-modal-title" id="detailModalTitle">è¨˜éŒ²ã®è©³ç´°</div>
        <button type="button" class="detail-modal-close" id="detailModalClose">Ã—</button>
      </div>
      <div class="detail-modal-body" id="detailModalContent"></div>
    </div>
  </div>

  <!-- è‡ªå‹•ãƒ†ãƒ³ãƒ—ãƒ¬ç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ« -->
  <div id="autoTemplateModal" class="detail-modal-backdrop">
    <div class="detail-modal">
      <div class="detail-modal-header">
        <div class="detail-modal-title">è‡ªå‹•ãƒ†ãƒ³ãƒ—ãƒ¬ç·¨é›†ï¼ˆåˆ©ç”¨è€…åˆ¥ï¼‰</div>
        <button type="button" class="detail-modal-close" id="autoTemplateClose">Ã—</button>
      </div>

      <div class="detail-modal-body">
        <div class="field-row">
          <div class="field">
            <label for="autoTemplateResidentSelect">å¯¾è±¡ï¼ˆåˆ©ç”¨è€… / å…±é€šï¼‰</label>
            <select id="autoTemplateResidentSelect"></select>
            <div class="auto-editor-hint">
              ã€Œå…±é€šï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆï¼‰ã€ã¯ã€åˆ©ç”¨è€…åˆ¥ãƒ†ãƒ³ãƒ—ãƒ¬ãŒç„¡ã„ã¨ãã«ä½¿ã‚ã‚Œã¾ã™ã€‚
            </div>
          </div>

          <div class="field">
            <label>ä½¿ãˆã‚‹ç½®ãæ›ãˆï¼ˆä»»æ„ï¼‰</label>
            <div class="auto-editor-hint">
              æ–‡ç« å†…ã«å…¥ã‚Œã‚‹ã¨è‡ªå‹•ã§ç½®ãæ›ã‚ã‚Šã¾ã™ï¼š<br>
              <span class="mono">{{resident}}</span>
              <span class="mono">{{date}}</span>
              <span class="mono">{{timeSlot}}</span>
              <span class="mono">{{daySupportTypeLabel}}</span>
              <span class="mono">{{daySupportItems}}</span>
              <span class="mono">{{daySupportTime}}</span>
            </div>
          </div>
        </div>

        <div id="autoEditorContainer" class="auto-editor-grid"></div>

        <div class="btn-row" style="margin-top:14px;">
          <button type="button" class="btn-primary" id="autoTemplateSaveBtn">ğŸ’¾ ä¿å­˜</button>
          <button type="button" class="btn-secondary" id="autoTemplateCopyDefaultBtn">ğŸ“¥ ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚’ã‚³ãƒ”ãƒ¼</button>
          <button type="button" class="btn-danger" id="autoTemplateClearResidentBtn">ğŸ—‘ï¸ ã“ã®åˆ©ç”¨è€…ã®è¨­å®šã‚’å‰Šé™¤</button>
        </div>

        <div class="auto-editor-hint">
          â€»é …ç›®ã‚’å¢—ã‚„ã—ãŸã„å ´åˆã¯ã€JSã® <span class="mono">AUTO_ITEM_DEFS</span> ã«1è¡Œè¿½åŠ ã™ã‚‹ã ã‘ã§ã€
          ãƒã‚§ãƒƒã‚¯æ¬„ã¨ç·¨é›†æ¬„ãŒè‡ªå‹•ã§å¢—ãˆã¾ã™ã€‚
        </div>
      </div>
    </div>
  </div>

  <!-- ãƒ¡ã‚¤ãƒ³ã‚¹ã‚¯ãƒªãƒ—ãƒˆ -->
  <script>
    const STORAGE_KEY = "group_home_records_v1";
    const RESIDENTS_KEY = "group_home_residents_v1";
    const TEMPLATES_KEY = "group_home_support_templates_v1";

    // â˜… åˆ©ç”¨è€…åˆ¥ã®ã€Œè‡ªå‹•ãƒ†ãƒ³ãƒ—ãƒ¬ã€ä¿å­˜ã‚­ãƒ¼
    const AUTO_TEMPLATES_KEY = "group_home_auto_templates_v1";

    const TAG_LIST = [
      "æœè–¬","é€šé™¢","å…¥æµ´","å¤–å‡º","ä½“èª¿ä¸è‰¯","ç›¸è«‡","ä»•äº‹","æƒé™¤","é‡‘éŠ­","å¤œé–“å¯¾å¿œ",
    ];

    // â˜… ä»Šå¾Œé …ç›®ã‚’å¢—ã‚„ã™ã®ã¯ã“ã“ã«è¿½åŠ ã™ã‚‹ã ã‘
    // key ãŒä¿å­˜ç”¨ID / label ãŒç”»é¢è¡¨ç¤º / defaultText ãŒå…±é€šãƒ†ãƒ³ãƒ—ãƒ¬ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆï¼‰
    const AUTO_ITEM_DEFS = [
      {
        key: "med_manage",
        label: "æœè–¬ç®¡ç†",
        defaultText: "ã€æœè–¬ç®¡ç†ã€‘å‡¦æ–¹è–¬ã¯äº‹å‹™æ‰€ã«ã¦ä¸€æ‹¬ç®¡ç†ã—ã€æœè–¬æ™‚ã«è·å“¡ãŒæ‰‹æ¸¡ã—å¯¾å¿œã‚’è¡Œã£ãŸã€‚"
      },
      {
        key: "oral_check",
        label: "å†…æœç¢ºèª",
        defaultText: "ã€å†…æœç¢ºèªã€‘æœè–¬æ™‚ã¯è·å“¡ãŒæ‰‹æ¸¡ã—ã€ç›®ã®å‰ã§é£²ã‚“ã§é ‚ãå†…æœç¢ºèªã‚’è¡Œã£ãŸã€‚"
      },
      {
        key: "bathing",
        label: "å…¥æµ´",
        defaultText: "ã€å…¥æµ´ã€‘å…¥æµ´ã®å£°ã‹ã‘ã¨æº–å‚™ã®ä¸€éƒ¨ä»‹åŠ©ã‚’è¡Œã„ã€æœ¬äººã®ãƒšãƒ¼ã‚¹ã‚’å°Šé‡ã—ãªãŒã‚‰è¦‹å®ˆã£ãŸã€‚"
      },
      {
        key: "day_support",
        label: "æ—¥ä¸­æ”¯æ´åŠ ç®—",
        defaultText: "ã€æ—¥ä¸­æ”¯æ´åŠ ç®—ã€‘{{daySupportTypeLabel}}ã®å¯¾è±¡ã¨ã—ã¦ã€æ—¥ä¸­ã‚‚ã‚°ãƒ«ãƒ¼ãƒ—ãƒ›ãƒ¼ãƒ å†…ã§è¦‹å®ˆã‚Šãƒ»å£°ã‹ã‘ãƒ»èª˜å°ç­‰ã®æ”¯æ´ã‚’ç¶™ç¶šã—ã¦å®Ÿæ–½ã—ãŸã€‚"
      }
    ];

    let records = [];
    let residents = [];
    let currentTags = [];
    let editingIndex = null;
    let templates = [];

    // â˜… åˆ©ç”¨è€…åˆ¥ è‡ªå‹•ãƒ†ãƒ³ãƒ—ãƒ¬ï¼ˆ{ _default: {key:text}, "åˆ©ç”¨è€…A": {key:text} }ï¼‰
    let autoTemplates = {};

    function loadRecords() {
      try {
        const raw = localStorage.getItem(STORAGE_KEY);
        if (!raw) return [];
        const parsed = JSON.parse(raw);
        if (!Array.isArray(parsed)) return [];
        return parsed;
      } catch (e) {
        console.error("load error", e);
        return [];
      }
    }

    function saveRecords() {
      localStorage.setItem(STORAGE_KEY, JSON.stringify(records));
    }

    function loadResidents() {
      try {
        const raw = localStorage.getItem(RESIDENTS_KEY);
        if (raw) {
          const parsed = JSON.parse(raw);
          if (Array.isArray(parsed) && parsed.length > 0) {
            return parsed;
          }
        }
      } catch (e) {
        console.error("load residents error", e);
      }

      const fromRecords = Array.from(
        new Set(records.map((r) => r.resident).filter(Boolean))
      );
      if (fromRecords.length > 0) return fromRecords;

      return ["åˆ©ç”¨è€…A","åˆ©ç”¨è€…B","åˆ©ç”¨è€…C","åˆ©ç”¨è€…D","åˆ©ç”¨è€…E","åˆ©ç”¨è€…F","åˆ©ç”¨è€…G"];
    }

    function saveResidents() {
      localStorage.setItem(RESIDENTS_KEY, JSON.stringify(residents));
    }

    function renderResidentSelects() {
      const residentSelect = document.getElementById("resident");
      const filterSelect = document.getElementById("filterResident");
      const manageSelect = document.getElementById("residentManageSelect");
      const residentCountLabel = document.getElementById("residentCount");

      if (residentCountLabel) {
        residentCountLabel.textContent = residents.length + "å";
      }

      if (residentSelect) {
        const current = residentSelect.value;
        residentSelect.innerHTML = "";
        const placeholder = document.createElement("option");
        placeholder.value = "";
        placeholder.textContent = "é¸æŠã—ã¦ãã ã•ã„";
        residentSelect.appendChild(placeholder);
        residents.forEach((name) => {
          const opt = document.createElement("option");
          opt.value = name;
          opt.textContent = name;
          residentSelect.appendChild(opt);
        });
        residentSelect.value = (current && residents.includes(current)) ? current : "";
      }

      if (filterSelect) {
        const current = filterSelect.value;
        filterSelect.innerHTML = "";
        const optAll = document.createElement("option");
        optAll.value = "";
        optAll.textContent = "å…¨å“¡";
        filterSelect.appendChild(optAll);
        residents.forEach((name) => {
          const opt = document.createElement("option");
          opt.value = name;
          opt.textContent = name;
          filterSelect.appendChild(opt);
        });
        filterSelect.value = (current && residents.includes(current)) ? current : "";
      }

      if (manageSelect) {
        const current = manageSelect.value;
        manageSelect.innerHTML = "";
        const placeholder = document.createElement("option");
        placeholder.value = "";
        placeholder.textContent = "é¸æŠã—ã¦ãã ã•ã„";
        manageSelect.appendChild(placeholder);
        residents.forEach((name) => {
          const opt = document.createElement("option");
          opt.value = name;
          opt.textContent = name;
          manageSelect.appendChild(opt);
        });
        manageSelect.value = (current && residents.includes(current)) ? current : "";
      }
    }

    function formatSupportSummary(text) {
      if (!text) return "";
      const trimmed = text.trim().replace(/\s+/g, " ");
      if (trimmed.length <= 40) return trimmed;
      return trimmed.slice(0, 40) + "â€¦";
    }

    function getTimeBadgeClass(timeSlot) {
      switch (timeSlot) {
        case "æ—¥ä¸­": return "badge-day";
        case "å¤•æ–¹": return "badge-evening";
        case "å¤œé–“": return "badge-night";
        default: return "badge-day";
      }
    }

    function renderRecords() {
      const tbody = document.getElementById("recordTableBody");
      const filterResident = document.getElementById("filterResident").value;
      const keyword = document.getElementById("searchKeyword").value.trim().toLowerCase();

      const periodFilterElement = document.getElementById("periodFilter");
      const periodFilter = periodFilterElement ? periodFilterElement.value : "month";

      const periodFromInput = document.getElementById("periodFrom");
      const periodToInput = document.getElementById("periodTo");
      const periodFrom = periodFromInput ? periodFromInput.value : "";
      const periodTo = periodToInput ? periodToInput.value : "";

      const today = new Date();
      const todayStr = today.toISOString().slice(0, 10);
      const monthPrefix = todayStr.slice(0, 7);
      const yearPrefix = todayStr.slice(0, 4);

      const weekStart = new Date(today);
      weekStart.setDate(weekStart.getDate() - 6);

      tbody.innerHTML = "";

      const filtered = records.filter((r) => {
        if (filterResident && r.resident !== filterResident) return false;

        const dateStr = r.date;
        if (dateStr) {
          if (periodFilter === "today") {
            if (dateStr !== todayStr) return false;
          } else if (periodFilter === "week") {
            const d = new Date(dateStr);
            if (isNaN(d)) return false;
            if (d < weekStart || d > today) return false;
          } else if (periodFilter === "month") {
            if (dateStr.slice(0, 7) !== monthPrefix) return false;
          } else if (periodFilter === "year") {
            if (dateStr.slice(0, 4) !== yearPrefix) return false;
          } else if (periodFilter === "custom") {
            if (periodFrom && dateStr < periodFrom) return false;
            if (periodTo && dateStr > periodTo) return false;
          }
        } else {
          if (periodFilter !== "all") return false;
        }

        if (keyword) {
          const tagsText = (r.tags || []).join(" ");
          const target =
            ((r.support || "") + " " + (r.note || "") + " " + (r.meal || "") + " " + tagsText).toLowerCase();
          if (!target.includes(keyword)) return false;
        }

        return true;
      });

      document.getElementById("recordCount").textContent = filtered.length + "ä»¶";

      if (filtered.length === 0) {
        const tr = document.createElement("tr");
        const td = document.createElement("td");
        td.colSpan = 7;
        td.className = "no-records";
        td.textContent = "ã¾ã è¨˜éŒ²ãŒã‚ã‚Šã¾ã›ã‚“ã€‚å·¦ã®ãƒ•ã‚©ãƒ¼ãƒ ã‹ã‚‰ç™»éŒ²ã™ã‚‹ã‹ã€æœŸé–“ãƒ»åˆ©ç”¨è€…ã®æ¡ä»¶ã‚’å¤‰ãˆã¦ã¿ã¦ãã ã•ã„ã€‚";
        tr.appendChild(td);
        tbody.appendChild(tr);
        return;
      }

      filtered
        .slice()
        .sort((a, b) => (a.date < b.date ? 1 : -1))
        .forEach((record) => {
          const tr = document.createElement("tr");

          const tdDate = document.createElement("td");
          tdDate.textContent = record.date || "";
          tr.appendChild(tdDate);

          const tdResident = document.createElement("td");
          tdResident.textContent = record.resident || "";
          tr.appendChild(tdResident);

          const tdTime = document.createElement("td");
          const span = document.createElement("span");
          span.textContent = record.timeSlot || "";
          span.className = "badge " + getTimeBadgeClass(record.timeSlot);
          tdTime.appendChild(span);
          tr.appendChild(tdTime);

          const tdCond = document.createElement("td");
          tdCond.innerHTML =
            (record.condition || "") + "<br><span class='small-text'>" + (record.mental || "") + "</span>";
          tr.appendChild(tdCond);

          const tdSupport = document.createElement("td");
          tdSupport.textContent = formatSupportSummary(record.support);

          if (record.tags && record.tags.length) {
            const tagDiv = document.createElement("div");
            tagDiv.className = "small-text";
            record.tags.forEach((tag) => {
              const spanTag = document.createElement("span");
              spanTag.className = "tag-chip";
              spanTag.textContent = "#" + tag;
              tagDiv.appendChild(spanTag);
            });
            tdSupport.appendChild(document.createElement("br"));
            tdSupport.appendChild(tagDiv);
          }

          tr.appendChild(tdSupport);

          const tdMed = document.createElement("td");
          tdMed.textContent = record.medTaken ? "æœè–¬æ¸ˆã¿" : "";
          tr.appendChild(tdMed);

          const tdActions = document.createElement("td");

          const viewBtn = document.createElement("button");
          viewBtn.textContent = "è©³ç´°";
          viewBtn.className = "btn-secondary";
          viewBtn.style.fontSize = "12px";
          viewBtn.onclick = () => showRecordDetail(record.id);

          const editBtn = document.createElement("button");
          editBtn.textContent = "ç·¨é›†";
          editBtn.className = "btn-secondary";
          editBtn.style.fontSize = "12px";
          editBtn.onclick = () => startEdit(record.id);

          const delBtn = document.createElement("button");
          delBtn.textContent = "å‰Šé™¤";
          delBtn.className = "btn-danger";
          delBtn.style.fontSize = "12px";
          delBtn.onclick = () => deleteRecord(record.id);

          tdActions.appendChild(viewBtn);
          tdActions.appendChild(editBtn);
          tdActions.appendChild(delBtn);
          tr.appendChild(tdActions);

          tbody.appendChild(tr);
        });
    }

    function resetForm() {
      document.getElementById("recordForm").reset();
      document.getElementById("date").value = new Date().toISOString().slice(0, 10);
      document.getElementById("timeSlot").value = "æ—¥ä¸­";
      document.getElementById("condition").value = "è‰¯å¥½";
      document.getElementById("mental").value = "å®‰å®š";
      document.getElementById("medTaken").checked = false;

      const daySupportType = document.getElementById("daySupportType");
      if (daySupportType) daySupportType.value = "";
      const daySupportTime = document.getElementById("daySupportTime");
      if (daySupportTime) daySupportTime.value = "";

      editingIndex = null;
      currentTags = [];
      updateTagUI();
      syncQuickButtonsAll();

      document.getElementById("modeLabel").textContent = "æ–°è¦å…¥åŠ›ãƒ¢ãƒ¼ãƒ‰";
      document.getElementById("modeLabel").style.background = "#eff6ff";
      document.getElementById("modeLabel").style.color = "#1d4ed8";
      document.getElementById("saveButton").textContent = "ğŸ’¾ è¨˜éŒ²ã‚’ä¿å­˜";

      document.querySelectorAll(".auto-item").forEach((el) => { el.checked = false; });
      document.querySelectorAll(".day-support-item").forEach((el) => { el.checked = false; });

      const templateScope = document.getElementById("templateScope");
      if (templateScope) templateScope.value = "common";
      renderTemplateSelect();
    }

    function startEdit(id) {
      const index = records.findIndex((r) => r.id === id);
      if (index === -1) return;

      const r = records[index];

      if (r.resident && !residents.includes(r.resident)) {
        residents.push(r.resident);
        saveResidents();
        renderResidentSelects();
      }

      editingIndex = index;

      document.getElementById("date").value = r.date || "";
      document.getElementById("resident").value = r.resident || "";
      document.getElementById("timeSlot").value = r.timeSlot || "æ—¥ä¸­";
      document.getElementById("condition").value = r.condition || "è‰¯å¥½";
      document.getElementById("mental").value = r.mental || "å®‰å®š";
      document.getElementById("meal").value = r.meal || "";
      document.getElementById("medTaken").checked = !!r.medTaken;
      document.getElementById("support").value = r.support || "";
      document.getElementById("note").value = r.note || "";

      const daySupportType = document.getElementById("daySupportType");
      if (daySupportType) daySupportType.value = r.daySupportType || "";

      const daySupportTime = document.getElementById("daySupportTime");
      if (daySupportTime) daySupportTime.value = r.daySupportTime || "";

      const items = Array.isArray(r.daySupportItems) ? r.daySupportItems : [];
      document.querySelectorAll(".day-support-item").forEach((el) => {
        el.checked = items.includes(el.value);
      });

      currentTags = Array.isArray(r.tags) ? [...r.tags] : [];
      updateTagUI();
      syncQuickButtonsAll();

      document.getElementById("modeLabel").textContent = "ç·¨é›†ãƒ¢ãƒ¼ãƒ‰ï¼ˆä¸Šæ›¸ãä¿å­˜ï¼‰";
      document.getElementById("modeLabel").style.background = "#fee2e2";
      document.getElementById("modeLabel").style.color = "#b91c1c";
      document.getElementById("saveButton").textContent = "âœï¸ ã“ã®å†…å®¹ã§ä¸Šæ›¸ã";

      document.querySelectorAll(".auto-item").forEach((el) => { el.checked = false; });
    }

    function deleteRecord(id) {
      if (!confirm("ã“ã®è¨˜éŒ²ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")) return;
      records = records.filter((r) => r.id !== id);
      saveRecords();
      renderRecords();
      if (editingIndex !== null) resetForm();
    }

    function handleSubmit(event) {
      event.preventDefault();

      const date = document.getElementById("date").value;
      const resident = document.getElementById("resident").value;
      if (!date || !resident) {
        alert("æ—¥ä»˜ã¨åˆ©ç”¨è€…ã¯å¿…é ˆã§ã™ã€‚");
        return;
      }

      const daySupportTypeEl = document.getElementById("daySupportType");
      const daySupportType = daySupportTypeEl ? daySupportTypeEl.value : "";
      const daySupportTimeEl = document.getElementById("daySupportTime");
      const daySupportTime = daySupportTimeEl ? daySupportTimeEl.value : "";
      const daySupportItems = Array.from(document.querySelectorAll(".day-support-item:checked")).map((el) => el.value);

      const recordData = {
        id: editingIndex !== null ? records[editingIndex].id : Date.now().toString(),
        date,
        resident,
        timeSlot: document.getElementById("timeSlot").value,
        condition: document.getElementById("condition").value,
        mental: document.getElementById("mental").value,
        meal: document.getElementById("meal").value,
        medTaken: document.getElementById("medTaken").checked,
        support: document.getElementById("support").value,
        note: document.getElementById("note").value,
        tags: [...currentTags],
        daySupportType,
        daySupportItems,
        daySupportTime,
      };

      if (editingIndex !== null) records[editingIndex] = recordData;
      else records.push(recordData);

      saveRecords();
      renderRecords();
      resetForm();
    }

    // ======= è‡ªå‹•ãƒ†ãƒ³ãƒ—ãƒ¬ï¼ˆåˆ©ç”¨è€…åˆ¥ï¼‰ =======
    function loadAutoTemplates() {
      try {
        const raw = localStorage.getItem(AUTO_TEMPLATES_KEY);
        if (!raw) return {};
        const parsed = JSON.parse(raw);
        return parsed && typeof parsed === "object" ? parsed : {};
      } catch (e) {
        console.error("load auto templates error", e);
        return {};
      }
    }

    function saveAutoTemplates(map) {
      localStorage.setItem(AUTO_TEMPLATES_KEY, JSON.stringify(map || {}));
    }

    function getDefaultTextForKey(key) {
      const def = AUTO_ITEM_DEFS.find(d => d.key === key);
      return def ? (def.defaultText || "") : "";
    }

    function getAutoTemplateTextForResident(residentName, key) {
      // 1) åˆ©ç”¨è€…åˆ¥
      if (residentName && autoTemplates[residentName] && typeof autoTemplates[residentName][key] === "string") {
        const t = autoTemplates[residentName][key].trim();
        if (t) return t;
      }
      // 2) å…±é€šï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆï¼‰
      if (autoTemplates._default && typeof autoTemplates._default[key] === "string") {
        const t = autoTemplates._default[key].trim();
        if (t) return t;
      }
      // 3) ã‚³ãƒ¼ãƒ‰å†…ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ
      const fallback = (getDefaultTextForKey(key) || "").trim();
      return fallback;
    }

    function applyPlaceholders(text, ctx) {
      if (!text) return "";
      return text
        .replaceAll("{{resident}}", ctx.resident || "")
        .replaceAll("{{date}}", ctx.date || "")
        .replaceAll("{{timeSlot}}", ctx.timeSlot || "")
        .replaceAll("{{daySupportTypeLabel}}", ctx.daySupportTypeLabel || "")
        .replaceAll("{{daySupportItems}}", ctx.daySupportItems || "")
        .replaceAll("{{daySupportTime}}", ctx.daySupportTime || "");
    }

    // â˜…ã€è‡ªå‹•ã€ï¼šãƒã‚§ãƒƒã‚¯ã—ãŸé …ç›®ã®ãƒ†ãƒ³ãƒ—ãƒ¬ã ã‘ã‚’è¿½è¨˜
    // ãƒ»ãƒ†ãƒ³ãƒ—ãƒ¬é¸æŠã‚ã‚Š â†’ ãã®ãƒ†ãƒ³ãƒ—ãƒ¬ã‚’è¿½è¨˜ï¼ˆå¾“æ¥é€šã‚Šï¼‰
    // ãƒ»ãƒ†ãƒ³ãƒ—ãƒ¬æœªé¸æŠ â†’ ãƒã‚§ãƒƒã‚¯é …ç›®ã®è‡ªå‹•ãƒ†ãƒ³ãƒ—ãƒ¬ã‚’é †ã«è¿½è¨˜ï¼ˆåˆ©ç”¨è€…åˆ¥â†’å…±é€šâ†’å†…è”µãƒ‡ãƒ•ã‚©ãƒ«ãƒˆï¼‰
    function generateSupportText() {
      const textArea = document.getElementById("support");

      // 1) ã¾ãšã€Œæ”¯æ´å†…å®¹ãƒ†ãƒ³ãƒ—ãƒ¬ï¼ˆè‡ªä½œï¼‰ã€ãŒé¸ã°ã‚Œã¦ã„ã‚‹ã‹ï¼Ÿ
      const templateSelectEl = document.getElementById("templateSelect");
      const idxStr = templateSelectEl ? templateSelectEl.value : "";
      if (idxStr) {
        const idx = parseInt(idxStr, 10);
        if (!Number.isNaN(idx) && templates[idx]) {
          const tpl = templates[idx];
          const newText = (tpl.text || "").trim();
          if (!newText) return;

          if (textArea.value.trim()) textArea.value = textArea.value.replace(/\s*$/, "") + "\n" + newText;
          else textArea.value = newText;
          return;
        }
      }

      // 2) è‡ªå‹•ãƒ†ãƒ³ãƒ—ãƒ¬ï¼šãƒã‚§ãƒƒã‚¯é …ç›®ã‚’å–å¾—
      const checkedKeys = Array.from(document.querySelectorAll(".auto-item:checked")).map((el) => el.value);
      if (checkedKeys.length === 0) {
        alert("è‡ªå‹•ã§è¿½è¨˜ã™ã‚‹é …ç›®ã«ãƒã‚§ãƒƒã‚¯ãŒå…¥ã£ã¦ã„ã¾ã›ã‚“ã€‚\nï¼ˆæœè–¬ç®¡ç† / å†…æœç¢ºèª / å…¥æµ´ / æ—¥ä¸­æ”¯æ´åŠ ç®—ãªã©ï¼‰");
        return;
      }

      const date = document.getElementById("date").value || "";
      const resident = document.getElementById("resident").value || "";
      const timeSlot = document.getElementById("timeSlot").value || "";
      const daySupportType = (document.getElementById("daySupportType") || {}).value || "";
      const daySupportTypeLabel = daySupportType ? ("æ—¥ä¸­æ”¯æ´åŠ ç®—" + daySupportType) : "æ—¥ä¸­æ”¯æ´åŠ ç®—";
      const daySupportItems = Array.from(document.querySelectorAll(".day-support-item:checked")).map(el => el.value).join("ã€");
      const daySupportTime = (document.getElementById("daySupportTime") || {}).value || "";

      const ctx = {
        date,
        resident,
        timeSlot,
        daySupportTypeLabel,
        daySupportItems,
        daySupportTime
      };

      const parts = [];
      checkedKeys.forEach((key) => {
        const base = getAutoTemplateTextForResident(resident, key);
        const applied = applyPlaceholders(base, ctx).trim();
        if (applied) parts.push(applied);
      });

      if (parts.length === 0) return;

      const newText = parts.join("\n");
      if (textArea.value.trim()) textArea.value = textArea.value.replace(/\s*$/, "") + "\n" + newText;
      else textArea.value = newText;
    }

    // è¨˜éŒ²è©³ç´°ãƒ¢ãƒ¼ãƒ€ãƒ«è¡¨ç¤º
    function showRecordDetail(id) {
      const record = records.find((r) => r.id === id);
      if (!record) return;

      const modal = document.getElementById("detailModal");
      const content = document.getElementById("detailModalContent");
      const titleEl = document.getElementById("detailModalTitle");
      if (!modal || !content) return;

      content.innerHTML = "";

      const addRow = (label, value) => {
        const div = document.createElement("div");
        div.className = "detail-field";
        const strong = document.createElement("strong");
        strong.textContent = label;
        const span = document.createElement("span");
        span.textContent = value || "";
        div.appendChild(strong);
        div.appendChild(span);
        content.appendChild(div);
      };

      const addMultiline = (label, value) => {
        const wrap = document.createElement("div");
        wrap.className = "detail-multiline";
        const strong = document.createElement("strong");
        strong.textContent = label;
        const pre = document.createElement("pre");
        pre.textContent = value || "";
        wrap.appendChild(strong);
        wrap.appendChild(pre);
        content.appendChild(wrap);
      };

      const tagsText = record.tags && record.tags.length ? record.tags.map((t) => "#" + t).join(" ") : "ãªã—";
      const medText = record.medTaken ? "æœè–¬æ¸ˆã¿" : "æœªç¢ºèªï¼æœªå†…æœã®å¯èƒ½æ€§ã‚ã‚Š";

      const daySupportTypeLabel = record.daySupportType ? "æ—¥ä¸­æ”¯æ´åŠ ç®—" + record.daySupportType : "ãªã—";
      const daySupportItemsText = record.daySupportItems && record.daySupportItems.length ? record.daySupportItems.join("ã€") : "ãªã—";

      if (titleEl) titleEl.textContent = `${record.date || ""} ${record.resident || ""} ã•ã‚“ã®è¨˜éŒ²`;

      addRow("æ—¥ä»˜ï¼š", record.date || "");
      addRow("åˆ©ç”¨è€…ï¼š", record.resident || "");
      addRow("æ™‚é–“å¸¯ï¼š", record.timeSlot || "");
      addRow("ä½“èª¿ï¼š", record.condition || "");
      addRow("å¿ƒã®çŠ¶æ…‹ï¼š", record.mental || "");
      addRow("é£Ÿäº‹ã®æ§˜å­ï¼š", record.meal || "");
      addRow("æœè–¬ï¼š", medText);
      addRow("ã‚¿ã‚°ï¼š", tagsText);
      addRow("æ—¥ä¸­æ”¯æ´åŠ ç®—åŒºåˆ†ï¼š", daySupportTypeLabel);
      addRow("æ—¥ä¸­æ”¯æ´ã®æ™‚é–“å¸¯ï¼š", record.daySupportTime || "");
      addRow("æ—¥ä¸­æ”¯æ´ã®çŠ¶æ³ãƒ»æ”¯æ´å†…å®¹ï¼š", daySupportItemsText);

      addMultiline("æœ¬æ—¥ã®æ”¯æ´å†…å®¹ãƒ»æ§˜å­ï¼š", record.support || "");
      addMultiline("ç‰¹è¨˜äº‹é …ï¼š", record.note || "");

      modal.classList.add("show");
    }

    function closeRecordDetail() {
      const modal = document.getElementById("detailModal");
      if (modal) modal.classList.remove("show");
    }

    // ã‚¿ã‚°ãƒœã‚¿ãƒ³
    function setupTagButtons() {
      const container = document.getElementById("tagButtons");
      container.innerHTML = "";
      TAG_LIST.forEach((tag) => {
        const btn = document.createElement("button");
        btn.type = "button";
        btn.className = "tag-button";
        btn.textContent = "#" + tag;
        btn.dataset.tag = tag;
        btn.addEventListener("click", () => toggleTag(tag));
        container.appendChild(btn);
      });
      updateTagUI();
    }

    function toggleTag(tag) {
      const idx = currentTags.indexOf(tag);
      if (idx >= 0) currentTags.splice(idx, 1);
      else currentTags.push(tag);
      updateTagUI();
    }

    function updateTagUI() {
      const info = document.getElementById("selectedTagsInfo");
      if (!info) return;

      info.textContent = currentTags.length === 0
        ? "é¸æŠä¸­ï¼šãªã—"
        : "é¸æŠä¸­ï¼š " + currentTags.map((t) => "#" + t).join(" ");

      const buttons = document.querySelectorAll(".tag-button");
      buttons.forEach((btn) => {
        const t = btn.dataset.tag;
        if (currentTags.includes(t)) btn.classList.add("tag-button-active");
        else btn.classList.remove("tag-button-active");
      });
    }

    // ã‚¯ã‚¤ãƒƒã‚¯ãƒœã‚¿ãƒ³
    function setupQuickButtons() {
      const groups = document.querySelectorAll(".quick-row");
      groups.forEach((row) => {
        const targetId = row.dataset.target;
        const select = document.getElementById(targetId);
        if (!select) return;

        const buttons = row.querySelectorAll(".quick-btn");

        function syncFromSelect() {
          const val = select.value;
          buttons.forEach((btn) => {
            if (btn.dataset.value === val) btn.classList.add("quick-btn-active");
            else btn.classList.remove("quick-btn-active");
          });
        }

        buttons.forEach((btn) => {
          btn.addEventListener("click", () => {
            select.value = btn.dataset.value;
            syncFromSelect();
          });
        });

        select.addEventListener("change", syncFromSelect);
        syncFromSelect();
      });
    }

    function syncQuickButtonsAll() {
      const groups = document.querySelectorAll(".quick-row");
      groups.forEach((row) => {
        const targetId = row.dataset.target;
        const select = document.getElementById(targetId);
        if (!select) return;
        const buttons = row.querySelectorAll(".quick-btn");
        const val = select.value;
        buttons.forEach((btn) => {
          if (btn.dataset.value === val) btn.classList.add("quick-btn-active");
          else btn.classList.remove("quick-btn-active");
        });
      });
    }

    // åˆ©ç”¨è€…ç®¡ç†
    function handleResidentAdd() {
      const nameInput = document.getElementById("residentNameInput");
      const name = nameInput.value.trim();
      if (!name) return alert("è¿½åŠ ã™ã‚‹åå‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚");
      if (residents.includes(name)) return alert("åŒã˜åå‰ã®åˆ©ç”¨è€…ãŒã™ã§ã«å­˜åœ¨ã—ã¾ã™ã€‚");
      residents.push(name);
      saveResidents();
      renderResidentSelects();
      nameInput.value = "";
      alert("åˆ©ç”¨è€…ã‚’è¿½åŠ ã—ã¾ã—ãŸã€‚");
    }

    function handleResidentRename() {
      const manageSelect = document.getElementById("residentManageSelect");
      const oldName = manageSelect.value;
      const nameInput = document.getElementById("residentNameInput");
      const newName = nameInput.value.trim();

      if (!oldName) return alert("å¤‰æ›´ã™ã‚‹åˆ©ç”¨è€…ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚");
      if (!newName) return alert("æ–°ã—ã„åå‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚");
      if (oldName === newName) return alert("åŒã˜åå‰ã§ã™ã€‚");

      if (residents.includes(newName)) {
        const ok = confirm("åŒã˜åå‰ã®åˆ©ç”¨è€…ãŒã™ã§ã«å­˜åœ¨ã—ã¾ã™ã€‚çµ±åˆã—ã¾ã™ã‹ï¼Ÿ");
        if (!ok) return;
      }

      residents = residents.map((n) => (n === oldName ? newName : n));
      records = records.map((r) => (r.resident === oldName ? { ...r, resident: newName } : r));

      // â˜… è‡ªå‹•ãƒ†ãƒ³ãƒ—ãƒ¬ã‚‚åˆ©ç”¨è€…åå¤‰æ›´
      if (autoTemplates[oldName]) {
        autoTemplates[newName] = { ...(autoTemplates[newName] || {}), ...autoTemplates[oldName] };
        delete autoTemplates[oldName];
        saveAutoTemplates(autoTemplates);
      }

      saveResidents();
      saveRecords();
      renderResidentSelects();
      renderRecords();
      nameInput.value = "";
      alert("åˆ©ç”¨è€…åã‚’å¤‰æ›´ã—ã¾ã—ãŸã€‚");
    }

    function handleResidentDelete() {
      const manageSelect = document.getElementById("residentManageSelect");
      const target = manageSelect.value;
      if (!target) return alert("å‰Šé™¤ã™ã‚‹åˆ©ç”¨è€…ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚");

      const ok = confirm(target + " ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ\nã“ã®åˆ©ç”¨è€…ã®ã™ã¹ã¦ã®è¨˜éŒ²ã‚‚å‰Šé™¤ã•ã‚Œã¾ã™ã€‚");
      if (!ok) return;

      residents = residents.filter((n) => n !== target);
      records = records.filter((r) => r.resident !== target);

      // â˜… è‡ªå‹•ãƒ†ãƒ³ãƒ—ãƒ¬ã‚‚å‰Šé™¤
      if (autoTemplates[target]) {
        delete autoTemplates[target];
        saveAutoTemplates(autoTemplates);
      }

      saveResidents();
      saveRecords();
      renderResidentSelects();
      renderRecords();
      document.getElementById("residentNameInput").value = "";
      alert("å‰Šé™¤ã—ã¾ã—ãŸã€‚");
    }

    // æ”¯æ´å†…å®¹ãƒ†ãƒ³ãƒ—ãƒ¬ï¼ˆè‡ªä½œï¼‰
    function loadTemplates() {
      try {
        const raw = localStorage.getItem(TEMPLATES_KEY);
        if (!raw) return [];
        const parsed = JSON.parse(raw);
        if (!Array.isArray(parsed)) return [];
        return parsed
          .filter((t) => t && typeof t.name === "string" && typeof t.text === "string")
          .map((t) => (!t.scope ? { ...t, scope: "common" } : t));
      } catch (e) {
        console.error("load templates error", e);
        return [];
      }
    }

    function saveTemplates() { localStorage.setItem(TEMPLATES_KEY, JSON.stringify(templates)); }

    function renderTemplateScopeOptions() {
      const scopeSelect = document.getElementById("templateScope");
      if (!scopeSelect) return;

      const current = scopeSelect.value || "common";
      scopeSelect.innerHTML = "";

      const optCommon = document.createElement("option");
      optCommon.value = "common";
      optCommon.textContent = "å…±é€šï¼ˆã©ã®é …ç›®ã§ã‚‚ï¼‰";
      scopeSelect.appendChild(optCommon);

      AUTO_ITEM_DEFS.forEach((d) => {
        const opt = document.createElement("option");
        opt.value = d.key;
        opt.textContent = d.label;
        scopeSelect.appendChild(opt);
      });

      scopeSelect.value = current;
      if (![ "common", ...AUTO_ITEM_DEFS.map(d => d.key) ].includes(scopeSelect.value)) {
        scopeSelect.value = "common";
      }
    }

    function renderTemplateSelect() {
      const select = document.getElementById("templateSelect");
      const scopeSelect = document.getElementById("templateScope");
      if (!select || !scopeSelect) return;
      const currentScope = scopeSelect.value || "common";

      select.innerHTML = "";
      const placeholder = document.createElement("option");
      placeholder.value = "";
      placeholder.textContent = "é¸æŠã—ã¦ãã ã•ã„";
      select.appendChild(placeholder);

      templates.forEach((tpl, index) => {
        const scope = tpl.scope || "common";
        if (scope !== currentScope) return;
        const opt = document.createElement("option");
        opt.value = String(index);
        opt.textContent = tpl.name;
        select.appendChild(opt);
      });
    }

    function handleTemplateApply() {
      const select = document.getElementById("templateSelect");
      const idxStr = select.value;
      if (!idxStr) return alert("æŒ¿å…¥ã™ã‚‹ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚");
      const idx = parseInt(idxStr, 10);
      const tpl = templates[idx];
      if (!tpl) return alert("ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚");

      const support = document.getElementById("support");
      const text = (tpl.text || "").trim();
      if (!text) return;

      if (support.value.trim()) support.value = support.value.replace(/\s*$/, "") + "\n" + text;
      else support.value = text;
    }

    function handleTemplateSave() {
      const nameInput = document.getElementById("templateNameInput");
      const name = nameInput.value.trim();
      if (!name) return alert("ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆåã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚");

      const scopeSelect = document.getElementById("templateScope");
      const scope = scopeSelect ? (scopeSelect.value || "common") : "common";

      const support = document.getElementById("support");
      const text = support.value;
      if (!text.trim()) {
        const ok = confirm("ã€æœ¬æ—¥ã®æ”¯æ´å†…å®¹ãƒ»æ§˜å­ã€ãŒç©ºã§ã™ãŒã€ã“ã®ã¾ã¾ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã¨ã—ã¦ä¿å­˜ã—ã¾ã™ã‹ï¼Ÿ");
        if (!ok) return;
      }

      const existingIndex = templates.findIndex((t) => t.name === name && (t.scope || "common") === scope);

      let targetIndex;
      if (existingIndex >= 0) {
        const ok = confirm("åŒã˜åå‰ãƒ»å¯¾è±¡é …ç›®ã®ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆãŒã‚ã‚Šã¾ã™ã€‚ä¸Šæ›¸ãã—ã¾ã™ã‹ï¼Ÿ");
        if (!ok) return;
        templates[existingIndex].text = text;
        targetIndex = existingIndex;
      } else {
        templates.push({ name, text, scope });
        targetIndex = templates.length - 1;
      }

      saveTemplates();
      renderTemplateSelect();

      const select = document.getElementById("templateSelect");
      if (select) select.value = String(targetIndex);

      alert("ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’ä¿å­˜ã—ã¾ã—ãŸã€‚ï¼ˆãƒ—ãƒ«ãƒ€ã‚¦ãƒ³ã«é¸æŠã•ã‚Œã¾ã—ãŸï¼‰");
    }

    function handleTemplateDelete() {
      const select = document.getElementById("templateSelect");
      const idxStr = select.value;
      if (!idxStr) return alert("å‰Šé™¤ã™ã‚‹ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚");
      const idx = parseInt(idxStr, 10);
      const tpl = templates[idx];
      if (!tpl) return alert("ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚");

      const ok = confirm(`ã€Œ${tpl.name}ã€ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ`);
      if (!ok) return;

      templates.splice(idx, 1);
      saveTemplates();
      renderTemplateSelect();
      alert("ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’å‰Šé™¤ã—ã¾ã—ãŸã€‚");
    }

    // è‡ªå‹•é …ç›®ï¼ˆãƒã‚§ãƒƒã‚¯æ¬„ï¼‰ã‚’ AUTO_ITEM_DEFS ã‹ã‚‰ç”Ÿæˆ
    function setupAutoItemsUI() {
      const container = document.getElementById("autoItemsContainer");
      if (!container) return;
      container.innerHTML = "";

      AUTO_ITEM_DEFS.forEach((d) => {
        const lab = document.createElement("label");
        const inp = document.createElement("input");
        inp.type = "checkbox";
        inp.className = "auto-item";
        inp.value = d.key;
        lab.appendChild(inp);
        lab.appendChild(document.createTextNode(" " + d.label));
        container.appendChild(lab);
      });
    }

    // è‡ªå‹•ãƒ†ãƒ³ãƒ—ãƒ¬ç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ«
    function openAutoTemplateEditor() {
      const modal = document.getElementById("autoTemplateModal");
      if (!modal) return;

      renderAutoTemplateResidentSelect();
      // åˆæœŸã¯ã€Œãƒ•ã‚©ãƒ¼ãƒ ã®åˆ©ç”¨è€…ã€ã‚’å„ªå…ˆã—ã¦é–‹ãï¼ˆç„¡ã‘ã‚Œã°ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆï¼‰
      const currentResident = document.getElementById("resident").value || "";
      const select = document.getElementById("autoTemplateResidentSelect");
      if (select) {
        if (currentResident && residents.includes(currentResident)) select.value = currentResident;
        else select.value = "_default";
      }
      renderAutoEditorFields();
      updateAutoEditorButtons();
      modal.classList.add("show");
    }

    function closeAutoTemplateEditor() {
      const modal = document.getElementById("autoTemplateModal");
      if (modal) modal.classList.remove("show");
    }

    function renderAutoTemplateResidentSelect() {
      const select = document.getElementById("autoTemplateResidentSelect");
      if (!select) return;
      const current = select.value || "_default";
      select.innerHTML = "";

      const optDef = document.createElement("option");
      optDef.value = "_default";
      optDef.textContent = "å…±é€šï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆï¼‰";
      select.appendChild(optDef);

      residents.forEach((name) => {
        const opt = document.createElement("option");
        opt.value = name;
        opt.textContent = name;
        select.appendChild(opt);
      });

      select.value = (current && (current === "_default" || residents.includes(current))) ? current : "_default";
    }

    function getEditorTargetKey() {
      const select = document.getElementById("autoTemplateResidentSelect");
      if (!select) return "_default";
      return select.value || "_default";
    }

    function renderAutoEditorFields() {
      const wrap = document.getElementById("autoEditorContainer");
      if (!wrap) return;
      wrap.innerHTML = "";

      const target = getEditorTargetKey();
      const map = (target === "_default") ? (autoTemplates._default || {}) : (autoTemplates[target] || {});

      AUTO_ITEM_DEFS.forEach((d) => {
        const box = document.createElement("div");
        box.className = "auto-editor-item";

        const lab = document.createElement("label");
        lab.textContent = d.label + " ã®ãƒ†ãƒ³ãƒ—ãƒ¬";

        const ta = document.createElement("textarea");
        ta.id = "autoTpl_" + d.key;
        ta.placeholder = "ç©ºã®å ´åˆã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆï¼ˆå…±é€šï¼å†…è”µï¼‰ã«æˆ»ã‚Šã¾ã™ã€‚";
        ta.value = (typeof map[d.key] === "string" ? map[d.key] : "");

        const hint = document.createElement("div");
        hint.className = "auto-editor-hint";
        hint.textContent = "ï¼ˆæœªè¨­å®šãªã‚‰ã€å…±é€šâ†’å†…è”µãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãŒä½¿ã‚ã‚Œã¾ã™ï¼‰";

        box.appendChild(lab);
        box.appendChild(ta);
        box.appendChild(hint);

        wrap.appendChild(box);
      });
    }

    function updateAutoEditorButtons() {
      const target = getEditorTargetKey();
      const copyBtn = document.getElementById("autoTemplateCopyDefaultBtn");
      const clearBtn = document.getElementById("autoTemplateClearResidentBtn");

      if (copyBtn) copyBtn.disabled = (target === "_default");
      if (clearBtn) clearBtn.disabled = (target === "_default");
    }

    function saveAutoEditorFields() {
      const target = getEditorTargetKey();

      if (target === "_default") {
        autoTemplates._default = autoTemplates._default || {};
        AUTO_ITEM_DEFS.forEach((d) => {
          const ta = document.getElementById("autoTpl_" + d.key);
          const val = ta ? ta.value.trim() : "";
          if (val) autoTemplates._default[d.key] = val;
          else delete autoTemplates._default[d.key];
        });

        // ç©ºãªã‚‰å‰Šé™¤ã—ã¦ç¶ºéº—ã«
        if (autoTemplates._default && Object.keys(autoTemplates._default).length === 0) {
          delete autoTemplates._default;
        }

        saveAutoTemplates(autoTemplates);
        alert("å…±é€šï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆï¼‰ã‚’ä¿å­˜ã—ã¾ã—ãŸã€‚");
        return;
      }

      autoTemplates[target] = autoTemplates[target] || {};
      AUTO_ITEM_DEFS.forEach((d) => {
        const ta = document.getElementById("autoTpl_" + d.key);
        const val = ta ? ta.value.trim() : "";
        if (val) autoTemplates[target][d.key] = val;
        else delete autoTemplates[target][d.key];
      });

      if (autoTemplates[target] && Object.keys(autoTemplates[target]).length === 0) {
        delete autoTemplates[target];
      }

      saveAutoTemplates(autoTemplates);
      alert("åˆ©ç”¨è€…åˆ¥ãƒ†ãƒ³ãƒ—ãƒ¬ã‚’ä¿å­˜ã—ã¾ã—ãŸã€‚");
    }

    function copyDefaultToResident() {
      const target = getEditorTargetKey();
      if (target === "_default") return;

      const defMap = autoTemplates._default || {};
      autoTemplates[target] = autoTemplates[target] || {};
      AUTO_ITEM_DEFS.forEach((d) => {
        const v = typeof defMap[d.key] === "string" ? defMap[d.key].trim() : "";
        if (v) autoTemplates[target][d.key] = v;
        else delete autoTemplates[target][d.key];
      });

      saveAutoTemplates(autoTemplates);
      renderAutoEditorFields();
      alert("ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸã€‚å¿…è¦ãªã‚‰ç·¨é›†ã—ã¦ä¿å­˜ã—ã¦ãã ã•ã„ã€‚");
    }

    function clearResidentAutoTemplates() {
      const target = getEditorTargetKey();
      if (target === "_default") return;
      const ok = confirm("ã“ã®åˆ©ç”¨è€…ã®è‡ªå‹•ãƒ†ãƒ³ãƒ—ãƒ¬è¨­å®šã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿï¼ˆå…±é€šãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã«æˆ»ã‚Šã¾ã™ï¼‰");
      if (!ok) return;

      if (autoTemplates[target]) delete autoTemplates[target];
      saveAutoTemplates(autoTemplates);
      renderAutoEditorFields();
      alert("å‰Šé™¤ã—ã¾ã—ãŸã€‚");
    }

    // ======= åˆæœŸåŒ– =======
    document.addEventListener("DOMContentLoaded", () => {
      document.getElementById("date").value = new Date().toISOString().slice(0, 10);

      records = loadRecords();
      residents = loadResidents();
      templates = loadTemplates();
      autoTemplates = loadAutoTemplates();

      renderResidentSelects();
      renderRecords();
      setupTagButtons();
      updateTagUI();
      setupQuickButtons();
      syncQuickButtonsAll();

      setupAutoItemsUI();

      // ãƒ†ãƒ³ãƒ—ãƒ¬å¯¾è±¡é …ç›®ï¼ˆè‡ªå‹•ã§å¢—ãˆã‚‹ï¼‰
      renderTemplateScopeOptions();

      const templateScopeEl = document.getElementById("templateScope");
      if (templateScopeEl) {
        templateScopeEl.addEventListener("change", renderTemplateSelect);
        templateScopeEl.value = "common";
      }
      renderTemplateSelect();

      document.getElementById("recordForm").addEventListener("submit", handleSubmit);
      document.getElementById("resetButton").addEventListener("click", resetForm);

      document.getElementById("filterResident").addEventListener("change", renderRecords);
      document.getElementById("searchKeyword").addEventListener("input", renderRecords);

      document.getElementById("searchClearButton").addEventListener("click", () => {
        document.getElementById("searchKeyword").value = "";
        renderRecords();
      });

      document.getElementById("residentAddButton").addEventListener("click", handleResidentAdd);
      document.getElementById("residentRenameButton").addEventListener("click", handleResidentRename);
      document.getElementById("residentDeleteButton").addEventListener("click", handleResidentDelete);

      const periodFilterElement = document.getElementById("periodFilter");
      if (periodFilterElement) {
        periodFilterElement.addEventListener("change", () => {
          const val = periodFilterElement.value;
          const row = document.getElementById("customPeriodRow");
          if (row) row.style.display = val === "custom" ? "flex" : "none";
          renderRecords();
        });
      }

      const applyCustomBtn = document.getElementById("applyCustomPeriod");
      if (applyCustomBtn) applyCustomBtn.addEventListener("click", renderRecords);

      const autoSupportBtn = document.getElementById("autoSupportBtn");
      if (autoSupportBtn) autoSupportBtn.addEventListener("click", generateSupportText);

      const templateApplyBtn = document.getElementById("templateApplyButton");
      if (templateApplyBtn) templateApplyBtn.addEventListener("click", handleTemplateApply);

      const templateSaveBtn = document.getElementById("templateSaveButton");
      if (templateSaveBtn) templateSaveBtn.addEventListener("click", handleTemplateSave);

      const templateDeleteBtn = document.getElementById("templateDeleteButton");
      if (templateDeleteBtn) templateDeleteBtn.addEventListener("click", handleTemplateDelete);

      const detailModal = document.getElementById("detailModal");
      const detailModalClose = document.getElementById("detailModalClose");
      if (detailModal && detailModalClose) {
        detailModalClose.addEventListener("click", closeRecordDetail);
        detailModal.addEventListener("click", (e) => { if (e.target === detailModal) closeRecordDetail(); });
      }

      // è‡ªå‹•ãƒ†ãƒ³ãƒ—ãƒ¬ç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ«
      const openBtn = document.getElementById("openAutoTemplateEditor");
      if (openBtn) openBtn.addEventListener("click", openAutoTemplateEditor);

      const autoModal = document.getElementById("autoTemplateModal");
      const autoClose = document.getElementById("autoTemplateClose");
      if (autoModal && autoClose) {
        autoClose.addEventListener("click", closeAutoTemplateEditor);
        autoModal.addEventListener("click", (e) => { if (e.target === autoModal) closeAutoTemplateEditor(); });
      }

      const residentSel = document.getElementById("autoTemplateResidentSelect");
      if (residentSel) {
        residentSel.addEventListener("change", () => {
          renderAutoEditorFields();
          updateAutoEditorButtons();
        });
      }

      const saveBtn = document.getElementById("autoTemplateSaveBtn");
      if (saveBtn) saveBtn.addEventListener("click", saveAutoEditorFields);

      const copyBtn = document.getElementById("autoTemplateCopyDefaultBtn");
      if (copyBtn) copyBtn.addEventListener("click", copyDefaultToResident);

      const clearBtn = document.getElementById("autoTemplateClearResidentBtn");
      if (clearBtn) clearBtn.addEventListener("click", clearResidentAutoTemplates);
    });

    // ===== æœªå®šç¾©é–¢æ•°ï¼ˆæ—¢å­˜ã® records.html æƒ³å®šé–¢æ•°ã«åˆã‚ã›ã¦ã„ã‚‹ãŸã‚ï¼‰=====
    // æ—¢å­˜UIã«ã‚ã‚‹ã€Œç·¨é›†ã€ã€Œå‰Šé™¤ã€ã‚’å‹•ã‹ã™ãŸã‚ã®æœ€ä½é™ï¼ˆã‚ãªãŸã®å…ƒã‚³ãƒ¼ãƒ‰äº’æ›ï¼‰
    function startEditPlaceholder() {}
    function startEdit(id) { startEdit(id); } // ãƒ€ãƒŸãƒ¼å›é¿ç”¨ï¼ˆä¸Šã§å®šç¾©æ¸ˆã¿ï¼‰
  </script>

  <!-- éŸ³å£°å…¥åŠ›ã‚¹ã‚¯ãƒªãƒ—ãƒˆ -->
  <script>
    document.addEventListener("DOMContentLoaded", () => {
      const voiceBtn = document.getElementById("voiceSupportBtn");
      const voiceStatus = document.getElementById("voiceStatus");
      const support = document.getElementById("support");
      if (!voiceBtn || !voiceStatus || !support) return;

      const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
      if (!SpeechRecognition) {
        voiceBtn.disabled = true;
        voiceStatus.textContent = "â€» ã“ã®ãƒ–ãƒ©ã‚¦ã‚¶ã§ã¯éŸ³å£°å…¥åŠ›ãŒä½¿ãˆã¾ã›ã‚“ï¼ˆChrome / Edge æ¨å¥¨ï¼‰";
        return;
      }

      const recognition = new SpeechRecognition();
      recognition.lang = "ja-JP";
      recognition.interimResults = true;
      recognition.continuous = true;

      let recognizing = false;

      voiceBtn.addEventListener("click", () => {
        if (!recognizing) {
          try { recognition.start(); } catch (e) {}
        } else {
          recognition.stop();
        }
      });

      recognition.addEventListener("start", () => {
        recognizing = true;
        voiceBtn.textContent = "â–  åœæ­¢";
        voiceStatus.textContent = "éŸ³å£°å…¥åŠ›ä¸­â€¦ è©±ã—çµ‚ã‚ã£ãŸã‚‰ã‚‚ã†ä¸€åº¦ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦åœæ­¢ã—ã¦ãã ã•ã„ã€‚";
      });

      recognition.addEventListener("end", () => {
        recognizing = false;
        voiceBtn.textContent = "ğŸ™ éŸ³å£°å…¥åŠ›";
        voiceStatus.textContent = "";
      });

      recognition.addEventListener("result", (event) => {
        let finalText = "";
        for (let i = event.resultIndex; i < event.results.length; i++) {
          const res = event.results[i];
          if (res.isFinal) finalText += res[0].transcript;
        }
        if (!finalText) return;

        if (support.value.trim()) support.value = support.value.replace(/\s*$/, "") + "\n" + finalText;
        else support.value = finalText;
      });

      recognition.addEventListener("error", (e) => {
        recognizing = false;
        voiceBtn.textContent = "ğŸ™ éŸ³å£°å…¥åŠ›";
        voiceStatus.textContent = "éŸ³å£°å…¥åŠ›ã‚¨ãƒ©ãƒ¼ï¼š" + e.error;
      });
    });
  </script>
</body>
</html>
