<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>ã‚°ãƒ«ãƒ¼ãƒ—ãƒ›ãƒ¼ãƒ  å€‹äººè¨˜éŒ²</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    * { box-sizing: border-box; }
    body{
      margin:0;
      font-family:-apple-system,BlinkMacSystemFont,"Helvetica Neue","YuGothic","Meiryo",sans-serif;
      background:#f3f4f6;
      color:#111827;
      font-size:16px;
      line-height:1.6;
    }
    header{
      background:#2563eb;
      color:#fff;
      padding:14px 16px;
      font-size:20px;
      font-weight:700;
      text-align:center;
      position:sticky; top:0; z-index:10;
    }
    main{
      max-width:1200px;
      margin:0 auto;
      padding:16px;
    }
    .grid{
      display:grid;
      grid-template-columns: 1.1fr 0.9fr;
      gap:14px;
      align-items:start;
    }
    @media (max-width: 980px){
      .grid{ grid-template-columns:1fr; }
      header{ font-size:18px; }
      main{ padding:10px; }
    }
    .card{
      background:#fff;
      border-radius:18px;
      padding:18px 20px 20px;
      box-shadow:0 8px 24px rgba(15,23,42,0.10);
    }
    .card-title{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
      margin-bottom:8px;
    }
    .card-title h2{
      margin:0;
      font-size:18px;
      font-weight:700;
    }
    .muted{ color:#6b7280; font-size:13px; }
    .row{
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      align-items:center;
      margin-top:10px;
    }
    label{ font-size:13px; color:#374151; font-weight:600; }
    input[type="text"], input[type="date"], select, textarea{
      width:100%;
      border-radius:14px;
      border:1px solid #d1d5db;
      padding:10px 12px;
      font-size:14px;
      background:#f9fafb;
      outline:none;
    }
    textarea{ min-height:92px; resize:vertical; }
    input:focus, select:focus, textarea:focus{
      border-color:#2563eb;
      box-shadow:0 0 0 2px rgba(37,99,235,0.18);
      background:#fff;
    }
    .col2{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
    }
    .col3{
      display:grid;
      grid-template-columns: 1fr 1fr 1fr;
      gap:10px;
    }
    @media (max-width: 700px){
      .col2,.col3{ grid-template-columns:1fr; }
    }
    button{
      border:none;
      border-radius:999px;
      padding:9px 14px;
      font-size:13px;
      font-weight:700;
      cursor:pointer;
      background:#e5e7eb;
      color:#111827;
      white-space:nowrap;
    }
    .btn-primary{ background:#2563eb; color:#fff; }
    .btn-danger{ background:#ef4444; color:#fff; }
    .btn-ghost{ background:#f3f4f6; }
    .chip{
      display:inline-flex;
      gap:6px;
      align-items:center;
      border-radius:999px;
      border:1px solid #e5e7eb;
      background:#f9fafb;
      padding:6px 10px;
      font-size:12px;
      color:#374151;
    }
    .badge{
      display:inline-block;
      padding:3px 9px;
      border-radius:999px;
      font-size:11px;
      font-weight:800;
      color:#fff;
    }
    .badge-day{ background:#22c55e; }
    .badge-evening{ background:#f59e0b; }
    .badge-night{ background:#6366f1; }
    .divider{
      height:1px;
      background:#e5e7eb;
      margin:14px 0;
    }
    .mini{
      font-size:12px;
      color:#6b7280;
    }
    .inline{
      display:flex;
      gap:10px;
      align-items:center;
      flex-wrap:wrap;
    }
    .checkgrid{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:8px;
      margin-top:8px;
    }
    @media (max-width: 700px){
      .checkgrid{ grid-template-columns:1fr; }
    }
    .checkitem{
      display:flex;
      gap:8px;
      align-items:flex-start;
      background:#f9fafb;
      border:1px solid #e5e7eb;
      border-radius:12px;
      padding:8px 10px;
      font-size:13px;
    }
    .checkitem input{ margin-top:3px; }
    .table-wrapper{
      max-height: 48vh;
      overflow:auto;
      border-radius:14px;
      border:1px solid #e5e7eb;
      margin-top:10px;
    }
    table{
      width:100%;
      border-collapse:collapse;
      font-size:13px;
    }
    thead{
      position:sticky; top:0;
      background:#eff6ff;
      z-index:1;
    }
    th,td{
      border-bottom:1px solid #e5e7eb;
      padding:8px 6px;
      text-align:left;
      vertical-align:top;
    }
    th{ font-weight:800; color:#374151; white-space:nowrap; }
    tbody tr:nth-child(even){ background:#f9fafb; }
    .support-snippet{
      max-width:520px;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
      color:#374151;
    }
    .right-tools{
      display:flex;
      gap:8px;
      align-items:center;
      flex-wrap:wrap;
      justify-content:flex-end;
    }
    .micbtn{
      border-radius:999px;
      padding:8px 12px;
      background:#111827;
      color:#fff;
      font-weight:800;
      font-size:12px;
    }
    .micbtn.off{
      background:#e5e7eb;
      color:#111827;
    }
    .hint{
      background:#fffbeb;
      border:1px solid #fde68a;
      border-radius:14px;
      padding:10px 12px;
      font-size:12px;
      color:#92400e;
      margin-top:10px;
    }
  </style>
</head>
<body>
<header>ã‚°ãƒ«ãƒ¼ãƒ—ãƒ›ãƒ¼ãƒ  å€‹äººè¨˜éŒ²ï¼ˆå…¥åŠ›ãƒ»ä¿å­˜ï¼‰</header>

<main>
  <div class="grid">
    <!-- LEFT: å…¥åŠ› -->
    <section class="card">
      <div class="card-title">
        <h2>å€‹äººè¨˜éŒ²å…¥åŠ›</h2>
        <div class="right-tools">
          <button type="button" id="openRecords" class="btn-primary">ä¸€è¦§ãƒšãƒ¼ã‚¸ï¼ˆrecords.htmlï¼‰</button>
        </div>
      </div>
      <div class="muted">â€»ä¿å­˜ãƒ‡ãƒ¼ã‚¿ã¯ãƒ–ãƒ©ã‚¦ã‚¶å†…ï¼ˆã“ã®ç«¯æœ«ã®localStorageï¼‰ã§ã™ã€‚GitHub Pagesã§ã‚‚ç«¯æœ«ã”ã¨ã«åˆ¥ä¿å­˜ã«ãªã‚Šã¾ã™ã€‚</div>

      <div class="divider"></div>

      <div class="col3">
        <div>
          <label>æ—¥ä»˜</label>
          <input type="date" id="date" />
        </div>
        <div>
          <label>åˆ©ç”¨è€…</label>
          <select id="resident"></select>
          <div class="mini">â€»åˆ©ç”¨è€…ãŒãªã„å ´åˆã¯å³ã®ã€Œåˆ©ç”¨è€…ç®¡ç†ã€ã§è¿½åŠ </div>
        </div>
        <div>
          <label>æ™‚é–“å¸¯</label>
          <select id="timeSlot">
            <option value="æ—¥ä¸­">æ—¥ä¸­</option>
            <option value="å¤•æ–¹">å¤•æ–¹</option>
            <option value="å¤œé–“">å¤œé–“</option>
          </select>
        </div>
      </div>

      <div class="col2" style="margin-top:10px;">
        <div>
          <label>ä½“èª¿</label>
          <input type="text" id="condition" placeholder="ä¾‹ï¼šè‰¯å¥½ã€å€¦æ€ æ„Ÿã‚ã‚Šã€ç™ºç†±ãªã— ãªã©" />
        </div>
        <div>
          <label>å¿ƒã®çŠ¶æ…‹</label>
          <input type="text" id="mental" placeholder="ä¾‹ï¼šè½ã¡ç€ã„ã¦ã„ã‚‹ã€ä¸å®‰è¨´ãˆã‚ã‚Š ãªã©" />
        </div>
      </div>

      <div style="margin-top:10px;">
        <label>é£Ÿäº‹</label>
        <input type="text" id="meal" placeholder="ä¾‹ï¼šæœâ—‹/æ˜¼â—‹/å¤•â–³ã€æ°´åˆ†æ‘‚å–ã‚ã‚Š ãªã©" />
      </div>

      <div class="row" style="justify-content:space-between;">
        <div class="inline">
          <label style="margin-right:6px;">æ”¯æ´å†…å®¹ï¼ˆå…¨æ–‡ï¼‰</label>
          <span class="mini">â€»æ”¹è¡ŒOK / records.htmlã§å…¨æ–‡è¡¨ç¤º</span>
        </div>
        <div class="inline">
          <button type="button" class="micbtn off" id="micSupport">ğŸ™ æ”¯æ´</button>
        </div>
      </div>
      <textarea id="support" placeholder="ä¾‹ï¼šå£°ã‹ã‘ã€æœè–¬è¦‹å®ˆã‚Šã€å¤–å‡ºç¢ºèªã€é‡‘éŠ­ç®¡ç†æ”¯æ´ã€é€šé™¢åŒè¡Œ ãªã©"></textarea>

      <div class="row" style="justify-content:space-between;">
        <div class="inline">
          <label style="margin-right:6px;">ç‰¹è¨˜äº‹é …ï¼ˆãƒ¡ãƒ¢ï¼‰</label>
          <span class="mini">â€»æ¤œç´¢å¯¾è±¡ã«ãªã‚Šã¾ã™</span>
        </div>
        <div class="inline">
          <button type="button" class="micbtn off" id="micNote">ğŸ™ ãƒ¡ãƒ¢</button>
        </div>
      </div>
      <textarea id="note" placeholder="ä¾‹ï¼šå¤œé–“è¦šé†’ã‚ã‚Šã€‚è·å“¡å¯¾å¿œã§å†å…¥çœ ã€‚ãªã©"></textarea>

      <div style="margin-top:10px;">
        <label>ã‚¿ã‚°ï¼ˆä»»æ„ï¼‰</label>
        <input type="text" id="tags" placeholder="ä¾‹ï¼š#ä½“èª¿ä¸è‰¯ #é€šé™¢  ï¼ˆã‚¹ãƒšãƒ¼ã‚¹/ã‚«ãƒ³ãƒ/ã€åŒºåˆ‡ã‚ŠOKï¼‰" />
      </div>

      <div class="divider"></div>

      <div class="col2">
        <div>
          <label>æœè–¬</label>
          <div class="inline" style="margin-top:6px;">
            <span class="chip">
              <input type="checkbox" id="medTaken" />
              <span>æœè–¬æ¸ˆã¿</span>
            </span>
          </div>

          <div class="row" style="justify-content:space-between; margin-top:8px;">
            <div class="inline">
              <label style="margin-right:6px;">æœè–¬ãƒ¡ãƒ¢ï¼ˆè©³ç´°ï¼‰</label>
              <span class="mini">â€»ãƒ†ãƒ³ãƒ—ãƒ¬1ã€œ3ã‚’è¿½è¨˜ã§ãã¾ã™</span>
            </div>
            <div class="inline">
              <button type="button" class="micbtn off" id="micMed">ğŸ™ æœè–¬</button>
            </div>
          </div>
          <textarea id="medNote" placeholder="ä¾‹ï¼šäº‹å‹™æ‰€ä¿ç®¡ã€‚è·å“¡æ‰‹æ¸¡ã—ã§å†…æœç¢ºèªã€‚"></textarea>

          <div class="row">
            <label style="min-width:110px;">ãƒ†ãƒ³ãƒ—ãƒ¬</label>
            <select id="medTemplateLevel" style="max-width:260px;">
              <option value="1">â‘ çŸ­ã‚</option>
              <option value="2" selected>â‘¡æ¨™æº–</option>
              <option value="3">â‘¢ç›£æŸ»å‘ã‘ï¼ˆä¸å¯§ï¼‰</option>
            </select>
            <button type="button" id="insertMedTemplate">ãƒ†ãƒ³ãƒ—ãƒ¬ã‚’è¿½è¨˜</button>
            <button type="button" id="clearMedNote" class="btn-ghost">æœè–¬ãƒ¡ãƒ¢ã ã‘ã‚¯ãƒªã‚¢</button>
          </div>

          <div class="hint">
            ã€Œãƒ†ãƒ³ãƒ—ãƒ¬ã‚’è¿½è¨˜ã€ã¯ <b>ç½®ãæ›ãˆã§ã¯ãªãæœ«å°¾ã«è¿½è¨˜</b> ã—ã¾ã™ã€‚<br>
            ç›£æŸ»å‘ã‘ï¼ˆâ‘¢ï¼‰ã¯é•·ã‚ãªã®ã§ã€å¿…è¦ã«å¿œã˜ã¦å‰Šã£ã¦èª¿æ•´ã—ã¦ãã ã•ã„ã€‚
          </div>
        </div>

        <div>
          <label>æ—¥ä¸­æ”¯æ´</label>
          <div class="mini" style="margin-top:6px;">â€»ã€ŒåŠ ç®—ã‚¿ã‚¤ãƒ—ã€ã¨ã€Œé …ç›®ã€ã‚’è¨˜éŒ²ï¼ˆå¤ã„è¨˜éŒ²ã¯ç©ºæ¬„ã§ã‚‚OKï¼‰</div>

          <div class="row" style="margin-top:8px;">
            <label style="min-width:110px;">åŠ ç®—ã‚¿ã‚¤ãƒ—</label>
            <select id="daySupportType" style="max-width:260px;">
              <option value="">ï¼ˆãªã—ï¼‰</option>
              <option value="1">1</option>
              <option value="2">2</option>
              <option value="3">3</option>
            </select>
          </div>

          <div style="margin-top:8px;">
            <label>æ—¥ä¸­ã«è¡Œã£ãŸä¸»ãªæ”¯æ´ï¼ˆãƒã‚§ãƒƒã‚¯ï¼‰</label>
            <div class="mini">â€»å³ã®ã€Œã‚ˆãä½¿ã†é …ç›®ï¼ˆåˆ©ç”¨è€…åˆ¥ï¼‰ã€ã§å€™è£œã‚’è¿½åŠ /å‰Šé™¤ã§ãã¾ã™</div>
            <div class="checkgrid" id="daySupportChecks"></div>
          </div>

          <div style="margin-top:10px;">
            <label>æ—¥ä¸­ã«è¡Œã£ãŸä¸»ãªæ”¯æ´ï¼ˆè‡ªç”±è¨˜è¿°ï¼‰</label>
            <textarea id="dayMainSupport" placeholder="ä¾‹ï¼šè²·ã„ç‰©åŒè¡Œã€å—è¨ºäºˆç´„ã®é›»è©±ã€é‡‘éŠ­ç®¡ç†æ”¯æ´ã€æ¸…æƒã®è¦‹å®ˆã‚Š ãªã©"></textarea>
          </div>

          <div class="row">
            <input type="text" id="daySupportAddOne" placeholder="ãƒã‚§ãƒƒã‚¯é …ç›®ã‚’1ã¤è¿½åŠ ï¼ˆä¾‹ï¼šè²·ã„ç‰©åŒè¡Œï¼‰" style="flex:1; min-width:180px;" />
            <button type="button" id="addDaySupportItem">è¿½åŠ </button>
          </div>
        </div>
      </div>

      <div class="divider"></div>

      <div class="row" style="justify-content:space-between;">
        <div class="inline">
          <span class="chip"><span id="modeBadge" class="badge badge-day">æ–°è¦</span></span>
          <span class="mini" id="editHint">ä¿å­˜ã§æ–°è¦è¿½åŠ ã•ã‚Œã¾ã™</span>
        </div>
        <div class="inline" style="gap:8px;">
          <button type="button" id="save" class="btn-primary">ä¿å­˜</button>
          <button type="button" id="clearForm">ãƒ•ã‚©ãƒ¼ãƒ ã‚¯ãƒªã‚¢</button>
          <button type="button" id="cancelEdit" class="btn-ghost" style="display:none;">ç·¨é›†ã‚’ã‚„ã‚ã‚‹</button>
        </div>
      </div>
    </section>

    <!-- RIGHT: ç®¡ç† / ä¸€è¦§ / ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ— -->
    <section class="card">
      <div class="card-title">
        <h2>åˆ©ç”¨è€…ç®¡ç†ãƒ»ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—</h2>
        <div class="right-tools">
          <span class="muted" id="counts">0ä»¶</span>
        </div>
      </div>

      <div class="divider"></div>

      <div>
        <label>åˆ©ç”¨è€…ã‚’è¿½åŠ </label>
        <div class="row">
          <input type="text" id="newResident" placeholder="ä¾‹ï¼šå±±ç”° å¤ªéƒ" style="flex:1; min-width:180px;" />
          <button type="button" id="addResident" class="btn-primary">è¿½åŠ </button>
        </div>
        <div class="mini">â€»è¿½åŠ ã™ã‚‹ã¨é¸æŠè‚¢ã«å‡ºã¾ã™ï¼ˆæ—¢å­˜ã®è¨˜éŒ²ãƒ‡ãƒ¼ã‚¿ã¯ãã®ã¾ã¾ï¼‰</div>
      </div>

      <div style="margin-top:12px;">
        <label>ç™»éŒ²æ¸ˆã¿åˆ©ç”¨è€…</label>
        <div class="row" id="residentList"></div>
      </div>

      <div class="divider"></div>

      <div>
        <label>ã‚ˆãä½¿ã†é …ç›®ï¼ˆåˆ©ç”¨è€…åˆ¥ï¼šæ—¥ä¸­æ”¯æ´ãƒã‚§ãƒƒã‚¯å€™è£œï¼‰</label>
        <div class="mini">â€»ã€Œåˆ©ç”¨è€…ã€ã‚’é¸ã¶ã¨ã€ãã®äººå°‚ç”¨ã®ãƒã‚§ãƒƒã‚¯å€™è£œãŒåæ˜ ã•ã‚Œã¾ã™ã€‚</div>
        <div class="row" style="margin-top:8px;">
          <select id="favResident" style="flex:1; min-width:160px;"></select>
        </div>
        <div class="row">
          <input type="text" id="favAdd" placeholder="å€™è£œã‚’è¿½åŠ ï¼ˆä¾‹ï¼šé€šé™¢åŒè¡Œï¼‰" style="flex:1; min-width:180px;">
          <button type="button" id="addFav">è¿½åŠ </button>
        </div>
        <div class="row" id="favChips"></div>
      </div>

      <div class="divider"></div>

      <div>
        <label>ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ï¼ˆæ¨å¥¨ï¼‰</label>
        <div class="mini">â€»ã‚³ãƒ¼ãƒ‰å·®ã—æ›¿ãˆå‰ã«1å›æŠ¼ã—ã¦ãŠãã¨å®‰å¿ƒã§ã™ã€‚</div>
        <div class="row" style="margin-top:8px;">
          <button type="button" id="exportData" class="btn-primary">ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ä¿å­˜ï¼ˆJSONï¼‰</button>
          <label class="chip" style="cursor:pointer;">
            <input type="file" id="importFile" accept="application/json" style="display:none;">
            <span>ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—èª­è¾¼</span>
          </label>
        </div>
      </div>

      <div class="divider"></div>

      <div class="card-title" style="margin-bottom:6px;">
        <h2 style="font-size:16px; margin:0;">ä¿å­˜æ¸ˆã¿è¨˜éŒ²ï¼ˆç·¨é›†/å‰Šé™¤ï¼‰</h2>
        <span class="muted" id="listCount">0ä»¶</span>
      </div>

      <div class="row">
        <select id="listFilterResident" style="flex:1; min-width:140px;"></select>
        <input type="text" id="listKeyword" placeholder="ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰æ¤œç´¢ï¼ˆæ”¯æ´/ãƒ¡ãƒ¢/æœè–¬/æ—¥ä¸­æ”¯æ´/ã‚¿ã‚°ï¼‰" style="flex:2; min-width:180px;">
        <button type="button" id="listClear">ã‚¯ãƒªã‚¢</button>
      </div>

      <div class="table-wrapper">
        <table>
          <thead>
          <tr>
            <th>æ—¥ä»˜</th>
            <th>åˆ©ç”¨è€…</th>
            <th>æ™‚é–“å¸¯</th>
            <th>æ”¯æ´ï¼ˆå…ˆé ­ï¼‰</th>
            <th>æ“ä½œ</th>
          </tr>
          </thead>
          <tbody id="savedTbody"></tbody>
        </table>
      </div>

      <div class="mini" style="margin-top:10px;">
        â€»ã€Œä¸€è¦§å°‚ç”¨ã€ã¯ <b>records.html</b> ã«ã¾ã¨ã‚ã¦è¡¨ç¤ºï¼ˆå…¨æ–‡ãƒ»æ”¹è¡Œã‚ã‚Šï¼‰ã—ã¾ã™ã€‚
      </div>
    </section>
  </div>
</main>

<script>
  const STORAGE_KEY   = "group_home_records_v1";
  const RESIDENTS_KEY = "group_home_residents_v1";
  const FAVORITES_KEY = "group_home_favorites_v1"; // è¿½åŠ ï¼ˆæ—¢å­˜ã«å½±éŸ¿ãªã—ï¼‰

  // ===== Utility =====
  const $ = (id) => document.getElementById(id);

  function todayStr() {
    const d = new Date();
    const pad = (n) => String(n).padStart(2,"0");
    return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`;
  }

  function safeJsonParse(raw, fallback) {
    try { return JSON.parse(raw); } catch(e) { return fallback; }
  }

  function loadRecords() {
    const raw = localStorage.getItem(STORAGE_KEY);
    const arr = safeJsonParse(raw || "[]", []);
    if (!Array.isArray(arr)) return [];
    // id ãŒãªã„å¤ã„ãƒ‡ãƒ¼ã‚¿ã« id ã‚’ä»˜ä¸
    let changed = false;
    arr.forEach(r => {
      if (!r.id) { r.id = cryptoRandomId(); changed = true; }
      if (!Array.isArray(r.tags)) r.tags = normalizeTags(r.tags || "");
      if (!Array.isArray(r.daySupportItems)) r.daySupportItems = (r.daySupportItems ? [].concat(r.daySupportItems) : []);
    });
    if (changed) saveRecords(arr);
    return arr;
  }

  function saveRecords(records) {
    localStorage.setItem(STORAGE_KEY, JSON.stringify(records));
  }

  function loadResidentsFromKey(records) {
    const raw = localStorage.getItem(RESIDENTS_KEY);
    const arr = safeJsonParse(raw || "[]", []);
    if (Array.isArray(arr) && arr.length) return arr;

    // ã‚‚ã— residents key ãŒç©ºãªã‚‰ã€è¨˜éŒ²ã‹ã‚‰æ¨æ¸¬ã—ã¦ä¿å­˜
    const set = new Set(records.map(r => r.resident).filter(Boolean));
    const inferred = Array.from(set);
    if (inferred.length) localStorage.setItem(RESIDENTS_KEY, JSON.stringify(inferred));
    return inferred;
  }

  function saveResidents(list) {
    localStorage.setItem(RESIDENTS_KEY, JSON.stringify(list));
  }

  function loadFavorites() {
    const raw = localStorage.getItem(FAVORITES_KEY);
    const obj = safeJsonParse(raw || "{}", {});
    return (obj && typeof obj === "object") ? obj : {};
  }

  function saveFavorites(obj) {
    localStorage.setItem(FAVORITES_KEY, JSON.stringify(obj));
  }

  function cryptoRandomId() {
    // å¯èƒ½ãªã‚‰ crypto ã‚’ä½¿ã†ï¼ˆå¤ã„ç’°å¢ƒã¯ fallbackï¼‰
    try {
      const a = new Uint32Array(2);
      crypto.getRandomValues(a);
      return `${Date.now().toString(36)}-${a[0].toString(36)}${a[1].toString(36)}`;
    } catch(e) {
      return `${Date.now().toString(36)}-${Math.random().toString(36).slice(2,10)}`;
    }
  }

  function normalizeTags(input) {
    if (Array.isArray(input)) return input.map(t => String(t).trim()).filter(Boolean);
    const s = String(input || "").trim();
    if (!s) return [];
    return s
      .split(/[\s,ã€]+/g)
      .map(x => x.trim())
      .filter(Boolean)
      .map(x => x.startsWith("#") ? x.slice(1) : x)
      .filter(Boolean);
  }

  function getTimeBadgeClass(timeSlot) {
    switch (timeSlot) {
      case "æ—¥ä¸­": return "badge-day";
      case "å¤•æ–¹": return "badge-evening";
      case "å¤œé–“": return "badge-night";
      default: return "badge-day";
    }
  }

  function escapeHtml(str) {
    return String(str || "")
      .replaceAll("&","&amp;")
      .replaceAll("<","&lt;")
      .replaceAll(">","&gt;")
      .replaceAll('"',"&quot;")
      .replaceAll("'","&#039;");
  }

  function medTemplate(level) {
    // 1ã€œ3ï¼šçŸ­ã‚ / æ¨™æº– / ç›£æŸ»å‘ã‘
    if (String(level) === "1") {
      return [
        "æœè–¬ç®¡ç†ï¼šå‡¦æ–¹è–¬ã¯äº‹å‹™æ‰€ã«ã¦ä¸€æ‹¬ç®¡ç†ã—ã¦ã„ã‚‹ã€‚",
        "å†…æœç¢ºèªï¼šæœè–¬æ™‚ã¯è·å“¡ãŒæ‰‹æ¸¡ã—ã€å†…æœç¢ºèªã‚’å®Ÿæ–½ã€‚"
      ].join("\n");
    }
    if (String(level) === "3") {
      return [
        "æœè–¬ç®¡ç†ï¼šå‡¦æ–¹è–¬ã¯äº‹å‹™æ‰€ã«ã¦ä¸€æ‹¬ç®¡ç†ï¼ˆæ–½éŒ ä¿ç®¡ï¼‰ã—ã€å—é ˜æ™‚ã«è–¬å‰¤åãƒ»æ•°é‡ç­‰ã‚’ç¢ºèªã—ã¦ç®¡ç†ã—ã¦ã„ã‚‹ã€‚é…è–¬ã¯è·å“¡ãŒå®Ÿæ–½ã—ã€èª¤è–¬é˜²æ­¢ã®ãŸã‚æœ¬äººç¢ºèªã¨è–¬å‰¤å†…å®¹ã®ç…§åˆã‚’è¡Œã†ã€‚",
        "å†…æœç¢ºèªï¼šæœè–¬å¾Œã¯æœç”¨çŠ¶æ³ã‚’å£é ­ãƒ»ç›®è¦–ç­‰ã§ç¢ºèªã—è¨˜éŒ²ã—ã¦ã„ã‚‹ã€‚æ‹’å¦ãƒ»æœç”¨ä¸èƒ½æ™‚ã¯çŠ¶æ³ã¨å¯¾å¿œã‚’è¨˜éŒ²ã—ã€å¿…è¦ã«å¿œã˜ã¦ç®¡ç†è€…ã¸å ±å‘Šã™ã‚‹ã€‚"
      ].join("\n");
    }
    // â‘¡æ¨™æº–
    return [
      "æœè–¬ç®¡ç†ï¼šå‡¦æ–¹è–¬ã¯äº‹å‹™æ‰€ã§ä¸€æ‹¬ç®¡ç†ã—ã€è·å“¡ãŒæœè–¬æ™‚ã«æ‰‹æ¸¡ã—ã—ã¦ã„ã‚‹ã€‚",
      "å†…æœç¢ºèªï¼šè·å“¡ãŒæœè–¬çŠ¶æ³ã‚’ç¢ºèªã—ã€è¨˜éŒ²ã—ã¦ã„ã‚‹ã€‚"
    ].join("\n");
  }

  function appendToTextarea(el, text) {
    const current = (el.value || "").trimEnd();
    const add = String(text || "").trim();
    if (!add) return;
    el.value = current ? (current + "\n" + add) : add;
    el.focus();
  }

  // ===== Speech Recognitionï¼ˆç°¡æ˜“ï¼‰=====
  function setupSpeechButton(btnId, targetTextareaId) {
    const btn = $(btnId);
    const target = $(targetTextareaId);

    const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
    if (!SR) {
      btn.classList.add("off");
      btn.title = "ã“ã®ãƒ–ãƒ©ã‚¦ã‚¶ã¯éŸ³å£°å…¥åŠ›ã«éå¯¾å¿œã§ã™";
      btn.addEventListener("click", () => alert("ã“ã®ãƒ–ãƒ©ã‚¦ã‚¶ã¯éŸ³å£°å…¥åŠ›ï¼ˆSpeechRecognitionï¼‰ã«å¯¾å¿œã—ã¦ã„ã¾ã›ã‚“ã€‚"));
      return;
    }

    let rec = null;
    let listening = false;

    function start() {
      if (listening) return;
      rec = new SR();
      rec.lang = "ja-JP";
      rec.interimResults = false;
      rec.maxAlternatives = 1;

      listening = true;
      btn.classList.remove("off");
      btn.textContent = "â— éŒ²éŸ³ä¸­";

      rec.onresult = (e) => {
        const t = e.results?.[0]?.[0]?.transcript || "";
        if (t) appendToTextarea(target, t);
      };
      rec.onerror = (e) => {
        console.error(e);
      };
      rec.onend = () => {
        listening = false;
        btn.classList.add("off");
        btn.textContent = btn.dataset.label || btn.textContent;
        btn.textContent = btn.dataset.label;
      };

      rec.start();
    }

    btn.dataset.label = btn.textContent;
    btn.addEventListener("click", () => {
      if (!listening) start();
      else {
        try { rec.stop(); } catch(e) {}
      }
    });
  }

  // ===== State =====
  let records = [];
  let residents = [];
  let favorites = {};
  let editingId = null;

  const DEFAULT_DAY_SUPPORT = [
    "å£°ã‹ã‘","è¦‹å®ˆã‚Š","æœè–¬è¦‹å®ˆã‚Š","å¤–å‡ºç¢ºèª","é‡‘éŠ­ç®¡ç†æ”¯æ´","æ¸…æƒæ”¯æ´",
    "å…¥æµ´ç¢ºèª","å¥åº·ç¢ºèª","é–¢ä¿‚æ©Ÿé–¢é€£çµ¡","é€šé™¢åŒè¡Œ","è²·ã„ç‰©åŒè¡Œ","ç›¸è«‡å¯¾å¿œ"
  ];

  // ===== Renderers =====
  function renderResidentSelects() {
    // main resident select
    const sel = $("resident");
    sel.innerHTML = "";

    const opt0 = document.createElement("option");
    opt0.value = "";
    opt0.textContent = "ï¼ˆé¸æŠï¼‰";
    sel.appendChild(opt0);

    residents.forEach(name => {
      const opt = document.createElement("option");
      opt.value = name;
      opt.textContent = name;
      sel.appendChild(opt);
    });

    // right-side favResident
    const favSel = $("favResident");
    favSel.innerHTML = "";
    const optF0 = document.createElement("option");
    optF0.value = "";
    optF0.textContent = "ï¼ˆåˆ©ç”¨è€…ã‚’é¸æŠï¼‰";
    favSel.appendChild(optF0);
    residents.forEach(name => {
      const opt = document.createElement("option");
      opt.value = name;
      opt.textContent = name;
      favSel.appendChild(opt);
    });

    // list filter
    const lsel = $("listFilterResident");
    lsel.innerHTML = "";
    const optAll = document.createElement("option");
    optAll.value = "";
    optAll.textContent = "å…¨å“¡";
    lsel.appendChild(optAll);
    residents.forEach(name => {
      const opt = document.createElement("option");
      opt.value = name;
      opt.textContent = name;
      lsel.appendChild(opt);
    });
  }

  function renderResidentList() {
    const wrap = $("residentList");
    wrap.innerHTML = "";
    if (!residents.length) {
      const s = document.createElement("span");
      s.className = "muted";
      s.textContent = "ã¾ã ç™»éŒ²ãŒã‚ã‚Šã¾ã›ã‚“ã€‚";
      wrap.appendChild(s);
      return;
    }
    residents.forEach(name => {
      const chip = document.createElement("span");
      chip.className = "chip";
      chip.innerHTML = `<b>${escapeHtml(name)}</b>`;
      const del = document.createElement("button");
      del.type = "button";
      del.className = "btn-danger";
      del.style.padding = "6px 10px";
      del.textContent = "å‰Šé™¤";
      del.addEventListener("click", () => {
        if (!confirm(`åˆ©ç”¨è€…ã€Œ${name}ã€ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿï¼ˆè¨˜éŒ²ãƒ‡ãƒ¼ã‚¿ã¯æ®‹ã‚Šã¾ã™ï¼‰`)) return;
        residents = residents.filter(x => x !== name);
        saveResidents(residents);
        // favoritesã‚‚æ•´ç†
        if (favorites[name]) {
          delete favorites[name];
          saveFavorites(favorites);
        }
        renderAll();
      });
      chip.appendChild(del);
      wrap.appendChild(chip);
    });
  }

  function getCurrentResident() {
    return $("resident").value || "";
  }

  function getFavListForResident(name) {
    const list = favorites[name];
    if (Array.isArray(list) && list.length) return list;
    return DEFAULT_DAY_SUPPORT.slice();
  }

  function renderDaySupportChecks() {
    const wrap = $("daySupportChecks");
    wrap.innerHTML = "";
    const name = getCurrentResident();
    const list = getFavListForResident(name);

    list.forEach(item => {
      const div = document.createElement("label");
      div.className = "checkitem";
      const cb = document.createElement("input");
      cb.type = "checkbox";
      cb.value = item;
      cb.checked = false;
      div.appendChild(cb);

      const span = document.createElement("span");
      span.textContent = item;
      div.appendChild(span);
      wrap.appendChild(div);
    });
  }

  function setCheckedDaySupport(items) {
    const wrap = $("daySupportChecks");
    const set = new Set((items || []).map(String));
    wrap.querySelectorAll("input[type=checkbox]").forEach(cb => {
      cb.checked = set.has(cb.value);
    });
  }

  function getCheckedDaySupport() {
    const wrap = $("daySupportChecks");
    const items = [];
    wrap.querySelectorAll("input[type=checkbox]").forEach(cb => {
      if (cb.checked) items.push(cb.value);
    });
    return items;
  }

  function renderFavoritesEditor() {
    const name = $("favResident").value || "";
    const chips = $("favChips");
    chips.innerHTML = "";

    if (!name) {
      const s = document.createElement("span");
      s.className = "muted";
      s.textContent = "åˆ©ç”¨è€…ã‚’é¸ã‚“ã§ãã ã•ã„ã€‚";
      chips.appendChild(s);
      return;
    }

    const list = getFavListForResident(name);

    list.forEach(item => {
      const chip = document.createElement("span");
      chip.className = "chip";
      chip.innerHTML = `${escapeHtml(item)}`;
      const del = document.createElement("button");
      del.type = "button";
      del.className = "btn-danger";
      del.style.padding = "6px 10px";
      del.textContent = "å‰Šé™¤";
      del.addEventListener("click", () => {
        const current = getFavListForResident(name).filter(x => x !== item);
        favorites[name] = current;
        saveFavorites(favorites);
        renderFavoritesEditor();
        // å…¥åŠ›æ¬„å´ãŒåŒåˆ©ç”¨è€…ãªã‚‰åæ˜ 
        if (getCurrentResident() === name) renderDaySupportChecks();
      });
      chip.appendChild(del);
      chips.appendChild(chip);
    });
  }

  function renderCounts() {
    $("counts").textContent = `${records.length}ä»¶`;
    $("listCount").textContent = `${records.length}ä»¶`;
  }

  function renderSavedList() {
    const tbody = $("savedTbody");
    tbody.innerHTML = "";

    const filterResident = $("listFilterResident").value;
    const keyword = ($("listKeyword").value || "").trim().toLowerCase();

    let filtered = records.slice();

    if (filterResident) {
      filtered = filtered.filter(r => r.resident === filterResident);
    }
    if (keyword) {
      filtered = filtered.filter(r => {
        const tagsText = (r.tags || []).join(" ");
        const target = (
          (r.support || "") + " " +
          (r.note || "") + " " +
          (r.meal || "") + " " +
          (r.medNote || "") + " " +
          (r.dayMainSupport || "") + " " +
          (r.daySupportItems || []).join(" ") + " " +
          tagsText
        ).toLowerCase();
        return target.includes(keyword);
      });
    }

    filtered.sort((a,b) => (a.date < b.date ? 1 : -1));

    if (!filtered.length) {
      const tr = document.createElement("tr");
      const td = document.createElement("td");
      td.colSpan = 5;
      td.className = "muted";
      td.style.padding = "12px";
      td.textContent = "è©²å½“ã™ã‚‹è¨˜éŒ²ãŒã‚ã‚Šã¾ã›ã‚“ã€‚";
      tr.appendChild(td);
      tbody.appendChild(tr);
      $("listCount").textContent = "0ä»¶";
      return;
    }

    $("listCount").textContent = `${filtered.length}ä»¶`;

    filtered.slice(0, 200).forEach(r => {
      const tr = document.createElement("tr");

      const tdDate = document.createElement("td");
      tdDate.textContent = r.date || "";
      tr.appendChild(tdDate);

      const tdRes = document.createElement("td");
      tdRes.textContent = r.resident || "";
      tr.appendChild(tdRes);

      const tdTime = document.createElement("td");
      const span = document.createElement("span");
      span.className = "badge " + getTimeBadgeClass(r.timeSlot);
      span.textContent = r.timeSlot || "";
      tdTime.appendChild(span);
      tr.appendChild(tdTime);

      const tdSup = document.createElement("td");
      tdSup.className = "support-snippet";
      tdSup.textContent = (r.support || "").replace(/\n/g," ");
      tr.appendChild(tdSup);

      const tdAct = document.createElement("td");
      const editBtn = document.createElement("button");
      editBtn.type = "button";
      editBtn.textContent = "ç·¨é›†";
      editBtn.className = "btn-primary";
      editBtn.style.padding = "6px 10px";
      editBtn.addEventListener("click", () => startEdit(r.id));

      const delBtn = document.createElement("button");
      delBtn.type = "button";
      delBtn.textContent = "å‰Šé™¤";
      delBtn.className = "btn-danger";
      delBtn.style.padding = "6px 10px";
      delBtn.style.marginLeft = "6px";
      delBtn.addEventListener("click", () => {
        if (!confirm("ã“ã®è¨˜éŒ²ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")) return;
        records = records.filter(x => x.id !== r.id);
        saveRecords(records);
        renderAll();
      });

      tdAct.appendChild(editBtn);
      tdAct.appendChild(delBtn);
      tr.appendChild(tdAct);

      tbody.appendChild(tr);
    });
  }

  // ===== Form =====
  function setModeBadge() {
    const badge = $("modeBadge");
    const hint = $("editHint");
    const cancel = $("cancelEdit");

    if (editingId) {
      badge.textContent = "ç·¨é›†ä¸­";
      badge.className = "badge badge-evening";
      hint.textContent = "ä¿å­˜ã§ä¸Šæ›¸ãæ›´æ–°ã•ã‚Œã¾ã™";
      cancel.style.display = "inline-block";
    } else {
      badge.textContent = "æ–°è¦";
      badge.className = "badge badge-day";
      hint.textContent = "ä¿å­˜ã§æ–°è¦è¿½åŠ ã•ã‚Œã¾ã™";
      cancel.style.display = "none";
    }
  }

  function clearForm(keepResident=false) {
    $("date").value = todayStr();
    if (!keepResident) $("resident").value = "";
    $("timeSlot").value = "æ—¥ä¸­";
    $("condition").value = "";
    $("mental").value = "";
    $("meal").value = "";
    $("support").value = "";
    $("note").value = "";
    $("tags").value = "";
    $("medTaken").checked = false;
    $("medNote").value = "";
    $("daySupportType").value = "";
    $("dayMainSupport").value = "";
    renderDaySupportChecks();
    setCheckedDaySupport([]);
    editingId = null;
    setModeBadge();
  }

  function startEdit(id) {
    const r = records.find(x => x.id === id);
    if (!r) return;

    editingId = id;
    $("date").value = r.date || todayStr();
    $("resident").value = r.resident || "";
    $("timeSlot").value = r.timeSlot || "æ—¥ä¸­";
    $("condition").value = r.condition || "";
    $("mental").value = r.mental || "";
    $("meal").value = r.meal || "";
    $("support").value = r.support || "";
    $("note").value = r.note || "";
    $("tags").value = (r.tags || []).map(t => "#" + t).join(" ");
    $("medTaken").checked = !!r.medTaken;
    $("medNote").value = r.medNote || "";
    $("daySupportType").value = r.daySupportType || "";
    $("dayMainSupport").value = r.dayMainSupport || "";

    renderDaySupportChecks();
    setCheckedDaySupport(r.daySupportItems || []);

    setModeBadge();
    window.scrollTo({ top: 0, behavior: "smooth" });
  }

  function buildRecordFromForm(existingId=null) {
    const date = $("date").value;
    const resident = $("resident").value;
    if (!date) { alert("æ—¥ä»˜ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„"); return null; }
    if (!resident) { alert("åˆ©ç”¨è€…ã‚’é¸æŠã—ã¦ãã ã•ã„"); return null; }

    const tags = normalizeTags($("tags").value);
    const daySupportItems = getCheckedDaySupport();

    return {
      id: existingId || cryptoRandomId(),
      date,
      resident,
      timeSlot: $("timeSlot").value || "æ—¥ä¸­",
      condition: $("condition").value || "",
      mental: $("mental").value || "",
      meal: $("meal").value || "",
      support: $("support").value || "",
      note: $("note").value || "",
      tags,
      medTaken: $("medTaken").checked,
      medNote: $("medNote").value || "",
      daySupportType: $("daySupportType").value || "",
      daySupportItems,
      dayMainSupport: $("dayMainSupport").value || ""
    };
  }

  function upsertRecord(r) {
    const idx = records.findIndex(x => x.id === r.id);
    if (idx >= 0) records[idx] = r;
    else records.push(r);
    saveRecords(records);
  }

  // ===== Export / Import =====
  function exportData() {
    const payload = {
      exportedAt: new Date().toISOString(),
      records,
      residents,
      favorites
    };
    const blob = new Blob([JSON.stringify(payload, null, 2)], { type: "application/json" });
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = `group_home_backup_${todayStr()}.json`;
    document.body.appendChild(a);
    a.click();
    a.remove();
    URL.revokeObjectURL(url);
  }

  async function importData(file) {
    const text = await file.text();
    const parsed = safeJsonParse(text, null);
    if (!parsed || typeof parsed !== "object") {
      alert("JSONã®å½¢å¼ãŒæ­£ã—ãã‚ã‚Šã¾ã›ã‚“ã€‚");
      return;
    }
    const rec = Array.isArray(parsed.records) ? parsed.records : null;
    const res = Array.isArray(parsed.residents) ? parsed.residents : null;
    const fav = (parsed.favorites && typeof parsed.favorites === "object") ? parsed.favorites : null;

    if (!rec || !res) {
      alert("ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã®ä¸­èº«ãŒä¸è¶³ã—ã¦ã„ã¾ã™ï¼ˆrecords / residentsï¼‰ã€‚");
      return;
    }
    if (!confirm("ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‚’èª­ã¿è¾¼ã¿ã¾ã™ã€‚ç¾åœ¨ã®ãƒ‡ãƒ¼ã‚¿ã¯ä¸Šæ›¸ãã•ã‚Œã¾ã™ã€‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ")) return;

    records = rec;
    residents = res;
    favorites = fav || {};

    // æ­£è¦åŒ–
    records.forEach(r => {
      if (!r.id) r.id = cryptoRandomId();
      if (!Array.isArray(r.tags)) r.tags = normalizeTags(r.tags || "");
      if (!Array.isArray(r.daySupportItems)) r.daySupportItems = (r.daySupportItems ? [].concat(r.daySupportItems) : []);
    });

    saveRecords(records);
    saveResidents(residents);
    saveFavorites(favorites);

    renderAll();
    alert("èª­ã¿è¾¼ã¿ãŒå®Œäº†ã—ã¾ã—ãŸã€‚");
  }

  // ===== Main Render =====
  function renderAll() {
    renderResidentSelects();
    renderResidentList();
    renderDaySupportChecks();
    renderFavoritesEditor();
    renderCounts();
    renderSavedList();
    setModeBadge();

    // ç·¨é›†ä¸­ã®åˆ©ç”¨è€…ãŒæ¶ˆãˆã¦ã„ãŸã‚‰è§£é™¤
    if (editingId && !records.find(r => r.id === editingId)) {
      editingId = null;
      setModeBadge();
    }
  }

  // ===== Events =====
  document.addEventListener("DOMContentLoaded", () => {
    records = loadRecords();
    residents = loadResidentsFromKey(records);
    favorites = loadFavorites();

    // åˆæœŸæ—¥ä»˜
    $("date").value = todayStr();

    renderAll();

    // éŸ³å£°ãƒœã‚¿ãƒ³
    setupSpeechButton("micSupport", "support");
    setupSpeechButton("micNote", "note");
    setupSpeechButton("micMed", "medNote");

    // resident change => day supportå€™è£œåæ˜ 
    $("resident").addEventListener("change", () => {
      renderDaySupportChecks();
      // ç·¨é›†ä¸­ã®ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚‹ãªã‚‰ãƒã‚§ãƒƒã‚¯å¾©å…ƒã¯ã—ãªã„ï¼ˆèª¤ä¸Šæ›¸ãé˜²æ­¢ï¼‰
      if (!editingId) setCheckedDaySupport([]);
    });

    // open records page
    $("openRecords").addEventListener("click", () => {
      window.location.href = "./records.html";
    });

    // add resident
    $("addResident").addEventListener("click", () => {
      const name = ($("newResident").value || "").trim();
      if (!name) return;
      if (residents.includes(name)) {
        alert("åŒã˜åå‰ãŒæ—¢ã«ã‚ã‚Šã¾ã™ã€‚");
        return;
      }
      residents.push(name);
      saveResidents(residents);
      $("newResident").value = "";
      renderAll();
      $("resident").value = name;
      renderDaySupportChecks();
    });

    // favorites editor resident change
    $("favResident").addEventListener("change", () => renderFavoritesEditor());

    // add favorite chip
    $("addFav").addEventListener("click", () => {
      const name = $("favResident").value || "";
      if (!name) { alert("åˆ©ç”¨è€…ã‚’é¸ã‚“ã§ãã ã•ã„"); return; }
      const item = ($("favAdd").value || "").trim();
      if (!item) return;

      const list = getFavListForResident(name);
      if (list.includes(item)) { alert("åŒã˜é …ç›®ãŒæ—¢ã«ã‚ã‚Šã¾ã™"); return; }

      favorites[name] = list.concat(item);
      saveFavorites(favorites);
      $("favAdd").value = "";
      renderFavoritesEditor();

      if (getCurrentResident() === name) renderDaySupportChecks();
    });

    // add day support item (input side)
    $("addDaySupportItem").addEventListener("click", () => {
      const name = getCurrentResident();
      if (!name) { alert("å…ˆã«åˆ©ç”¨è€…ã‚’é¸æŠã—ã¦ãã ã•ã„"); return; }
      const item = ($("daySupportAddOne").value || "").trim();
      if (!item) return;

      const list = getFavListForResident(name);
      if (!list.includes(item)) {
        favorites[name] = list.concat(item);
        saveFavorites(favorites);
      }
      $("daySupportAddOne").value = "";
      renderDaySupportChecks();
    });

    // insert med template (append)
    $("insertMedTemplate").addEventListener("click", () => {
      const level = $("medTemplateLevel").value;
      appendToTextarea($("medNote"), medTemplate(level));
    });

    $("clearMedNote").addEventListener("click", () => {
      if (!confirm("æœè–¬ãƒ¡ãƒ¢ã ã‘æ¶ˆã—ã¾ã™ã‹ï¼Ÿ")) return;
      $("medNote").value = "";
    });

    // save
    $("save").addEventListener("click", () => {
      const r = buildRecordFromForm(editingId);
      if (!r) return;

      upsertRecord(r);

      // residents key ã®æ•´åˆ
      if (!residents.includes(r.resident)) {
        residents.push(r.resident);
        saveResidents(residents);
      }

      // ç·¨é›†çµ‚äº†
      const keepRes = true;
      clearForm(keepRes);
      renderAll();
      alert("ä¿å­˜ã—ã¾ã—ãŸã€‚");
    });

    $("clearForm").addEventListener("click", () => {
      if (!confirm("å…¥åŠ›ä¸­ã®å†…å®¹ã‚’ã‚¯ãƒªã‚¢ã—ã¾ã™ã‹ï¼Ÿï¼ˆä¿å­˜æ¸ˆã¿ãƒ‡ãƒ¼ã‚¿ã¯æ¶ˆãˆã¾ã›ã‚“ï¼‰")) return;
      clearForm(false);
    });

    $("cancelEdit").addEventListener("click", () => {
      if (!confirm("ç·¨é›†ã‚’ã‚„ã‚ã¦ãƒ•ã‚©ãƒ¼ãƒ ã‚’ã‚¯ãƒªã‚¢ã—ã¾ã™ã‹ï¼Ÿ")) return;
      clearForm(false);
      renderAll();
    });

    // list filters
    $("listFilterResident").addEventListener("change", renderSavedList);
    $("listKeyword").addEventListener("input", renderSavedList);
    $("listClear").addEventListener("click", () => {
      $("listKeyword").value = "";
      $("listFilterResident").value = "";
      renderSavedList();
    });

    // export/import
    $("exportData").addEventListener("click", exportData);
    $("importFile").addEventListener("change", async (e) => {
      const f = e.target.files?.[0];
      if (!f) return;
      await importData(f);
      e.target.value = "";
    });
  });
</script>
</body>
</html>
