<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>グループホーム 個人記録 - 一覧ページ</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
<style>
    * { box-sizing: border-box; }
    body{
      margin: 0;
      font-family: -apple-system, BlinkMacSystemFont, "Helvetica Neue",
        "YuGothic", "Meiryo", sans-serif;
      background:#f3f4f6;
      color:#111827;
      font-size:16px;
      line-height:1.6;
    }
    header{
      background:#2563eb;
      color:#fff;
      padding:16px 18px;
      font-size:22px;
      font-weight:800;
      text-align:center;
      position: sticky;
      top:0;
      z-index:10;
    }
    main{
      max-width: 1280px;
      margin: 0 auto;
      padding: 18px;
    }
    .card{
      background:#fff;
      border-radius:18px;
      padding:18px 20px 20px;
      box-shadow:0 8px 24px rgba(15,23,42,0.10);
    }
    .card-title{
      font-size:20px;
      font-weight:700;
      margin-bottom:8px;
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
      flex-wrap:wrap;
    }
    .title-right{
      display:flex;
      align-items:center;
      gap:10px;
      flex-wrap:wrap;
      justify-content:flex-end;
    }
    .card-subtitle{
      font-size:13px;
      color:#6b7280;
      margin-bottom:12px;
    }
    .record-count{
      font-size:13px;
      color:#6b7280;
      white-space:nowrap;
    }

    .control-row{
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      align-items:center;
      margin-bottom:10px;
    }
    .control-row span{
      font-size:13px;
      color:#4b5563;
    }

    input[type="text"],
    input[type="date"],
    select{
      border-radius: 12px;
      border: 1px solid #d1d5db;
      padding: 8px 10px;
      font-size: 14px;
      background:#f9fafb;
      outline:none;
    }
    input[type="text"]:focus,
    input[type="date"]:focus,
    select:focus{
      border-color:#2563eb;
      box-shadow:0 0 0 2px rgba(37,99,235,0.25);
      background:#fff;
    }

    button{
      border:none;
      border-radius: 999px;
      padding: 10px 14px;
      font-size: 13px;
      font-weight: 700;
      cursor:pointer;
      background:#e5e7eb;
      color:#111827;
      display:inline-flex;
      align-items:center;
      gap:6px;
      line-height:1;
      user-select:none;
    }
    button:hover{ filter: brightness(0.98); }
    button:active{ transform: translateY(1px); }

    .btn-primary{ background:#2563eb; color:#fff; }
    .btn-secondary{ background:#e5e7eb; color:#111827; }
    .btn-small{ padding: 7px 12px; font-size: 12px; }

    .small-text{ font-size:12px; color:#6b7280; }

    .table-wrapper{
      max-height: calc(100vh - 270px);
      overflow:auto;
      border-radius:14px;
      border:1px solid #e5e7eb;
      background:#fff;
    }
    table{
      width:100%;
      border-collapse: collapse;
      font-size:13px;
    }
    thead{
      position: sticky;
      top:0;
      background:#eff6ff;
      z-index:1;
    }
    th, td{
      border-bottom:1px solid #e5e7eb;
      padding:8px 6px;
      text-align:left;
      vertical-align: top;
    }
    th{
      font-weight:700;
      color:#374151;
      white-space: nowrap;
    }
    tbody tr:nth-child(even){ background:#f9fafb; }

    .badge{
      display:inline-block;
      padding:3px 9px;
      border-radius:999px;
      font-size:11px;
      font-weight:700;
      color:#fff;
      white-space:nowrap;
    }
    .badge-day{ background:#22c55e; }
    .badge-evening{ background:#f59e0b; }
    .badge-night{ background:#6366f1; }

    .tag-chip{
      display:inline-block;
      margin-top:2px;
      margin-right:4px;
      padding:2px 7px;
      border-radius:999px;
      border:1px solid #fde68a;
      background:#fffbeb;
      font-size:11px;
      white-space:nowrap;
    }

    .tag-chip-main{
      border:1px solid #bfdbfe;
      background:#eff6ff;
      color:#1d4ed8;
      font-weight:800;
    }

    .no-records{
      padding:14px;
      font-size:13px;
      text-align:center;
      color:#6b7280;
    }
    .support-cell{
      white-space: pre-wrap;
      word-wrap: break-word;
    }

    @media (max-width: 800px){
      header{ font-size:18px; padding:14px 14px; }
      main{ padding: 10px; }
      .card{ padding: 14px 12px 16px; }
      .card-title{ font-size:18px; }
      .control-row{ gap: 6px; }
      table{ font-size: 12px; }
      input[type="text"], input[type="date"], select{
        font-size:13px;
        padding:7px 9px;
      }
    }
  
    .op-cell{ white-space: nowrap; }

    /* ==== 編集モーダル（一覧ページ内で編集） ==== */
    .modal-backdrop{
      position: fixed;
      inset: 0;
      background: rgba(15,23,42,0.35);
      display: none;
      align-items: center;
      justify-content: center;
      padding: 14px;
      z-index: 60;
    }
    .modal-backdrop.show{ display: flex; }

    .modal{
      background:#fff;
      border-radius:18px;
      width: min(760px, 100%);
      max-height: 90vh;
      overflow:auto;
      box-shadow:0 16px 40px rgba(15,23,42,0.22);
      padding: 14px 14px 12px;
    }
    .modal-header{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      margin-bottom:10px;
    }
    .modal-title{
      font-size:18px;
      font-weight:800;
      margin:0;
    }
    .modal-close{
      border:none;
      background:transparent;
      font-size:18px;
      font-weight:800;
      cursor:pointer;
      padding: 4px 8px;
      border-radius:10px;
    }
    .modal-close:hover{ background:#f3f4f6; }

    .form-row{
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      margin-bottom:10px;
    }
    .form-col{ flex:1; min-width: 180px; }
    .form-col label{
      display:block;
      font-size:12px;
      color:#4b5563;
      margin: 0 0 4px;
    }
    textarea{
      border-radius: 12px;
      border: 1px solid #d1d5db;
      padding: 8px 10px;
      font-size: 14px;
      background:#f9fafb;
      outline:none;
      width: 100%;
      min-height: 110px;
      resize: vertical;
      line-height: 1.5;
      font-family: inherit;
    }
    textarea:focus{
      border-color:#2563eb;
      box-shadow:0 0 0 2px rgba(37,99,235,0.25);
      background:#fff;
    }
    .btn-row{
      display:flex;
      gap:10px;
      justify-content:flex-end;
      margin-top:10px;
      flex-wrap:wrap;
    }

  </style>
</head>
<body>
  <header>グループホーム 個人記録 WEBアプリ（一覧）</header>

  <main>
    <section class="card">
      <div class="card-title">
        <span>記録一覧（編集できます）</span>
        <div class="title-right">
          <span class="record-count" id="recordCount">0件</span>
          <button type="button" id="backIndex" class="btn-secondary btn-small">↩ 個人記録に戻る</button>
        </div>
      </div>

      <div class="card-subtitle">
        入力ページ（index.html）で保存した記録を、<strong>大きな画面で一覧表示</strong>するページです。<br>
        ここでも編集ができます（保存すると記録が更新されます）。
      </div>

      <div class="control-row">
        <span>利用者：</span>
        <select id="filterResident"></select>

        <span>期間：</span>
        <select id="periodFilter">
          <option value="today">今日</option>
          <option value="week">直近7日間</option>
          <option value="month" selected>今月</option>
          <option value="year">今年</option>
          <option value="all">全期間</option>
          <option value="custom">日付指定</option>
        </select>
      </div>

      <div class="control-row" id="customPeriodRow" style="display:none;">
        <span>期間指定：</span>
        <input type="date" id="periodFrom">
        <span>〜</span>
        <input type="date" id="periodTo">
        <button type="button" id="applyCustomPeriod" class="btn-secondary btn-small">反映</button>
      </div>

      <div class="control-row">
        <span>キーワード：</span>
        <input type="text" id="searchKeyword"
               placeholder="例：通院, 夜間, #体調不良 など"
               style="flex:1; min-width:180px;">
        <button type="button" id="searchClearButton" class="btn-secondary btn-small">クリア</button>
        <span class="small-text">※支援内容・特記事項・タグから検索します。</span>
      </div>

      <div class="table-wrapper">
        <table>
          <thead>
            <tr>
              <th>日付</th>
              <th>利用者</th>
              <th>【日中に行った主な支援】</th>
              <th>支援内容（全文）</th>
            <th>操作</th>
            </tr>
          </thead>
          <tbody id="recordTableBody">
            <!-- JSで挿入 -->
          </tbody>
        </table>
      </div>
    </section>
  </main>

  <!-- ===== 編集モーダル ===== -->
  <div id="editBackdrop" class="modal-backdrop" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="editModalTitle">
      <div class="modal-header">
        <h3 class="modal-title" id="editModalTitle">記録を編集</h3>
        <button type="button" class="modal-close" id="editClose" aria-label="閉じる">✕</button>
      </div>

      <div class="form-row">
        <div class="form-col">
          <label for="editDate">日付</label>
          <input type="date" id="editDate">
        </div>
        <div class="form-col">
          <label for="editResident">利用者</label>
          <input type="text" id="editResident" placeholder="例：山田 太郎">
        </div>
      </div>

      <div class="form-row">
        <div class="form-col" style="min-width:260px;">
          <label for="editDayMain">日中に行った主な支援（カンマ/改行/、区切り）</label>
          <input type="text" id="editDayMain" placeholder="例：清潔保持, 通院同行, 見守り">
        </div>
      </div>

      <div class="form-row">
        <div class="form-col" style="min-width:260px;">
          <label for="editSupport">支援内容（全文）</label>
          <textarea id="editSupport" placeholder="支援内容を入力"></textarea>
        </div>
      </div>

      <div class="form-row">
        <div class="form-col" style="min-width:260px;">
          <label for="editNote">特記事項</label>
          <textarea id="editNote" placeholder="特記事項があれば入力"></textarea>
        </div>
      </div>

      <div class="form-row">
        <div class="form-col" style="min-width:260px;">
          <label for="editTags">タグ（スペース/カンマ/、区切り、#は任意）</label>
          <input type="text" id="editTags" placeholder="#体調不良 #通院 など">
        </div>
        <div class="form-col">
          <label for="editRecorder">記録者</label>
          <input type="text" id="editRecorder" placeholder="例：職員名">
        </div>
      </div>

      <div class="btn-row">
        <button type="button" class="btn-secondary" id="editCancel">キャンセル</button>
        <button type="button" class="btn-primary" id="editSave">保存</button>
      </div>

      <div class="small-text" style="margin-top:8px;">
        ※保存すると localStorage の記録が更新され、index.html 側の記録にも反映されます。
      </div>
    </div>
  </div>


<script>
  const STORAGE_KEY   = "group_home_records_v1";
  const RESIDENTS_KEY = "group_home_residents_v1";


  // ===== 一覧ページ内編集用 =====
  let currentEditIdx = null;

  function buildRecordsWithIdx(base){
    const arr = Array.isArray(base) ? base : [];
    return arr.map((r, idx) => Object.assign({_idx: idx}, r));
  }

  function optionExists(selectEl, value){
    if (!selectEl) return false;
    return Array.from(selectEl.options || []).some(o => o.value === value);
  }

  function updateResidentFilterOptions(baseRecords){
    const sel = document.getElementById("filterResident");
    const prev = sel ? sel.value : "";
    renderFilters(loadResidents(baseRecords || []));
    if (sel && optionExists(sel, prev)) sel.value = prev;
    else if (sel) sel.value = "";
  }

  function parseList(str){
    return String(str || "")
      .split(/[\,\n、]/)
      .map(s => s.trim())
      .filter(Boolean);
  }


  function parseTags(str){
    return String(str || "")
      .split(/[\,\s\n、]+/)
      .map(s => s.trim().replace(/^#+/, ""))
      .filter(Boolean);
  }


  function openEditModalByIdx(idx){
    const base = loadRecords();
    const r = base[idx];
    if (!r) return;
    currentEditIdx = idx;

    const mainItems = (r.daySupportMainItems && r.daySupportMainItems.length)
      ? r.daySupportMainItems
      : (r.daySupportItems || []);

    document.getElementById("editDate").value = r.date || "";
    document.getElementById("editResident").value = r.resident || "";
    document.getElementById("editDayMain").value = (mainItems || []).join(", ");
    document.getElementById("editSupport").value = r.support || "";
    document.getElementById("editNote").value = r.note || "";
    document.getElementById("editTags").value = (r.tags || []).map(t => "#" + t).join(" ");
    document.getElementById("editRecorder").value = r.recorder || "";

    const backdrop = document.getElementById("editBackdrop");
    backdrop.classList.add("show");
    backdrop.setAttribute("aria-hidden", "false");
  }

  function closeEditModal(){
    currentEditIdx = null;
    const backdrop = document.getElementById("editBackdrop");
    if (!backdrop) return;
    backdrop.classList.remove("show");
    backdrop.setAttribute("aria-hidden", "true");
  }

  function saveEditModal(){
    if (currentEditIdx === null || currentEditIdx === undefined) return;

    const base = loadRecords();
    const old = base[currentEditIdx] || {};
    const updated = Object.assign({}, old);

    updated.date = document.getElementById("editDate").value || "";
    updated.resident = (document.getElementById("editResident").value || "").trim();

    const main = parseList(document.getElementById("editDayMain").value);
    updated.daySupportMainItems = main;
    updated.daySupportItems = main; // 互換用（古い表示にも対応）

    updated.support = document.getElementById("editSupport").value || "";
    updated.note = document.getElementById("editNote").value || "";
    updated.tags = parseTags(document.getElementById("editTags").value);
    updated.recorder = (document.getElementById("editRecorder").value || "").trim();

    base[currentEditIdx] = updated;
    localStorage.setItem(STORAGE_KEY, JSON.stringify(base));

    closeEditModal();

    // 一覧を更新（フィルタ選択は保持）
    updateResidentFilterOptions(base);
    renderRecords(buildRecordsWithIdx(base));
  }

  function loadRecords() {
    try {
      const raw = localStorage.getItem(STORAGE_KEY);
      if (!raw) return [];
      const parsed = JSON.parse(raw);
      return Array.isArray(parsed) ? parsed : [];
    } catch(e) {
      console.error(e);
      return [];
    }
  }

  function loadResidents(records) {
    try {
      const raw = localStorage.getItem(RESIDENTS_KEY);
      if (raw) {
        const parsed = JSON.parse(raw);
        if (Array.isArray(parsed) && parsed.length > 0) return parsed;
      }
    } catch(e) {
      console.error(e);
    }
    return Array.from(
      new Set(records.map(r => r.resident).filter(Boolean))
    );
  }

  function getTimeBadgeClass(timeSlot) {
    switch (timeSlot) {
      case "日中": return "badge-day";
      case "夕方": return "badge-evening";
      case "夜間": return "badge-night";
      default: return "badge-day";
    }
  }


  function getWeekdayJP(dateStr){
    if (!dateStr) return "";
    const d = new Date(dateStr);
    if (isNaN(d)) return "";
    const w = ["日","月","火","水","木","金","土"][d.getDay()];
    return w;
  }

  function renderFilters(residents) {
    const filterResident = document.getElementById("filterResident");
    filterResident.innerHTML = "";

    const optAll = document.createElement("option");
    optAll.value = "";
    optAll.textContent = "全員";
    filterResident.appendChild(optAll);

    residents.forEach(name => {
      const opt = document.createElement("option");
      opt.value = name;
      opt.textContent = name;
      filterResident.appendChild(opt);
    });
  }

  function renderRecords(records) {
    const tbody = document.getElementById("recordTableBody");
    const filterResident = document.getElementById("filterResident").value;
    const keyword = document.getElementById("searchKeyword").value.trim().toLowerCase().replace(/＃/g, "#");
    const periodFilter = document.getElementById("periodFilter").value;
    const periodFrom = document.getElementById("periodFrom").value;
    const periodTo   = document.getElementById("periodTo").value;

    const today = new Date();
    const todayStr = today.toISOString().slice(0,10);
    const monthPrefix = todayStr.slice(0,7);
    const yearPrefix  = todayStr.slice(0,4);

    const weekStart = new Date(today);
    weekStart.setDate(weekStart.getDate() - 6);

    tbody.innerHTML = "";

    const filtered = records.filter(r => {
      if (filterResident && r.resident !== filterResident) return false;

      const dateStr = r.date;
      if (dateStr) {
        if (periodFilter === "today") {
          if (dateStr !== todayStr) return false;
        } else if (periodFilter === "week") {
          const d = new Date(dateStr);
          if (isNaN(d)) return false;
          if (d < weekStart || d > today) return false;
        } else if (periodFilter === "month") {
          if (dateStr.slice(0,7) !== monthPrefix) return false;
        } else if (periodFilter === "year") {
          if (dateStr.slice(0,4) !== yearPrefix) return false;
        } else if (periodFilter === "custom") {
          if (periodFrom && dateStr < periodFrom) return false;
          if (periodTo   && dateStr > periodTo)   return false;
        }
      } else {
        if (periodFilter !== "all") return false;
      }

      if (keyword) {
        const tagsText = (r.tags || []).join(" ");
        const tagsTextHash = (r.tags || []).map(t => "#" + t).join(" ");
        const mainText = ((r.daySupportMainItems && r.daySupportMainItems.length) ? r.daySupportMainItems : (r.daySupportItems || [])).join(" ");
        const target = (
          (r.support || "") + " " +
          (r.note || "")    + " " +
          mainText          + " " +
          tagsText          + " " +
          tagsTextHash
        ).toLowerCase();
        if (!target.includes(keyword)) return false;
      }

      return true;
    });

    document.getElementById("recordCount").textContent =
      filtered.length + "件";

    if (filtered.length === 0) {
      const tr = document.createElement("tr");
      const td = document.createElement("td");
      td.colSpan = 5;
      td.className = "no-records";
      td.textContent =
        "該当する記録がありません。利用者・期間・キーワードを確認してください。";
      tr.appendChild(td);
      tbody.appendChild(tr);
      return;
    }

    filtered
      .slice()
      .sort((a,b) => (a.date < b.date ? 1 : -1))
      .forEach(record => {
        const tr = document.createElement("tr");

        const tdDate = document.createElement("td");
        const w = getWeekdayJP(record.date);
        tdDate.textContent = record.date ? (w ? `${record.date}（${w}）` : record.date) : "";
        tr.appendChild(tdDate);

        const tdResident = document.createElement("td");
        tdResident.textContent = record.resident || "";
        tr.appendChild(tdResident);

        const tdDayMain = document.createElement("td");
        const mainItems = (record.daySupportMainItems && record.daySupportMainItems.length)
          ? record.daySupportMainItems
          : (record.daySupportItems || []);
        if (mainItems && mainItems.length) {
          // index.html と同じ「日中に行った主な支援」を表示
          const wrap = document.createElement("div");
          wrap.className = "small-text";
          mainItems.forEach(item => {
            const chip = document.createElement("span");
            chip.className = "tag-chip tag-chip-main";
            chip.textContent = item;
            wrap.appendChild(chip);
          });
          tdDayMain.appendChild(wrap);
        } else {
          tdDayMain.textContent = "";
        }
        tr.appendChild(tdDayMain);

        const tdSupport = document.createElement("td");
        tdSupport.className = "support-cell";
        let supportText = record.support || "";
        if (record.note && String(record.note).trim()) {
          
          supportText += (supportText.trim() ? "\n\n" : "") + "【特記事項】\n" + String(record.note).trim();
        
        }
        tdSupport.textContent = supportText;
        if (record.tags && record.tags.length) {
          const tagDiv = document.createElement("div");
          tagDiv.className = "small-text";
          record.tags.forEach(tag => {
            const chip = document.createElement("span");
            chip.className = "tag-chip";
            chip.textContent = "#" + tag;
            tagDiv.appendChild(chip);
          });
          tdSupport.appendChild(document.createElement("br"));
          tdSupport.appendChild(tagDiv);
        }
        
        if (record.recorder && String(record.recorder).trim()) {
          const recDiv = document.createElement("div");
          recDiv.className = "small-text";
          recDiv.textContent = "記録者： " + String(record.recorder).trim();
          tdSupport.appendChild(document.createElement("br"));
          tdSupport.appendChild(recDiv);
        }
        tr.appendChild(tdSupport);

        const tdOp = document.createElement("td");
        tdOp.className = "op-cell";
        const editBtn = document.createElement("button");
        editBtn.type = "button";
        editBtn.className = "btn-secondary btn-small";
        editBtn.textContent = "編集";
        editBtn.addEventListener("click", (e) => {
          e.stopPropagation();
          openEditModalByIdx(record._idx);
        });
        tdOp.appendChild(editBtn);
        tr.appendChild(tdOp);

        tbody.appendChild(tr);
      });
  }

  document.addEventListener("DOMContentLoaded", () => {
    // 初期表示
    const baseInit = loadRecords();
    updateResidentFilterOptions(baseInit);
    renderRecords(buildRecordsWithIdx(baseInit));

    // 再描画（フィルタ/検索の状態はDOMから取得するので、そのまま反映されます）
    function rerender(){
      const base = loadRecords();
      renderRecords(buildRecordsWithIdx(base));
    }

    document.getElementById("filterResident")
      .addEventListener("change", () => rerender());

    document.getElementById("searchKeyword")
      .addEventListener("input", () => rerender());

    document.getElementById("searchClearButton")
      .addEventListener("click", () => {
        document.getElementById("searchKeyword").value = "";
        rerender();
      });

    const periodFilterEl = document.getElementById("periodFilter");
    const customRow = document.getElementById("customPeriodRow");
    periodFilterEl.addEventListener("change", () => {
      const v = periodFilterEl.value;
      customRow.style.display = v === "custom" ? "flex" : "none";
      if (v !== "custom") rerender();
    });

    document.getElementById("applyCustomPeriod")
      .addEventListener("click", () => rerender());

    document.getElementById("backIndex")
      .addEventListener("click", () => {
        window.location.href = "./index.html";
      });

    // モーダル操作
    document.getElementById("editClose").addEventListener("click", closeEditModal);
    document.getElementById("editCancel").addEventListener("click", closeEditModal);
    document.getElementById("editSave").addEventListener("click", saveEditModal);

    const backdrop = document.getElementById("editBackdrop");
    backdrop.addEventListener("click", (e) => {
      if (e.target === backdrop) closeEditModal();
    });

    document.addEventListener("keydown", (e) => {
      if (e.key === "Escape") closeEditModal();
    });
  });
</script>
</body>
</html>
