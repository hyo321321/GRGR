<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>ãƒã‚¤ã‚¿ãƒ«è¨˜éŒ²ï¼ˆä½“é‡ãƒ»è¡€åœ§ãƒ»è„ˆæ‹ï¼‰</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans JP", "Yu Gothic UI", sans-serif;
      background: #f6f7fb;
      color: #0f172a;
    }
    a { color: #2563eb; text-decoration: none; }
    a:hover { text-decoration: underline; }

    .topbar {
      position: sticky;
      top: 0;
      background: #ffffffcc;
      backdrop-filter: blur(10px);
      border-bottom: 1px solid #e5e7eb;
      padding: 12px 16px;
      z-index: 10;
    }
    .topbar-inner {
      max-width: 1100px;
      margin: 0 auto;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      flex-wrap: wrap;
    }
    .title {
      font-weight: 800;
      letter-spacing: .2px;
    }
    .subtitle {
      font-size: 12px;
      color: #475569;
      margin-top: 2px;
    }

    .wrap { max-width: 1100px; margin: 14px auto 24px; padding: 0 16px; }

    .layout {
      display: grid;
      grid-template-columns: 1fr 420px;
      gap: 12px;
      align-items: start;
    }
    .layout > * { min-width: 0; }

    .card {
      background: #fff;
      border: 1px solid #e5e7eb;
      border-radius: 14px;
      box-shadow: 0 4px 16px rgba(2,6,23,.04);
      padding: 14px;
    }
    .card-title {
      font-weight: 800;
      margin-bottom: 10px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
    }

    .grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
    }
    .grid-3 {
      display: grid;
      grid-template-columns: 1fr 1fr 1fr;
      gap: 10px;
    }

    label { display: block; font-size: 12px; color: #475569; margin: 0 0 6px; }
    input, select, textarea {
      width: 100%;
      padding: 10px 10px;
      border: 1px solid #e5e7eb;
      border-radius: 10px;
      font-size: 14px;
      background: #fff;
    }
    input:focus, select:focus, textarea:focus {
      outline: none;
      border-color: #93c5fd;
      box-shadow: 0 0 0 3px rgba(59,130,246,.15);
    }
    textarea { resize: vertical; min-height: 78px; }

    .btn-row { display: flex; gap: 8px; flex-wrap: wrap; margin-top: 10px; }
    .btn {
      border: 1px solid #e5e7eb;
      border-radius: 10px;
      padding: 10px 12px;
      background: #fff;
      cursor: pointer;
      font-weight: 700;
      font-size: 13px;
    }
    .btn-primary { background: #2563eb; color: #fff; border-color: #2563eb; }
    .btn-danger { background: #ef4444; color: #fff; border-color: #ef4444; }
    .btn-ghost { background: #fff; color: #0f172a; }

    .hint { font-size: 12px; color: #475569; line-height: 1.45; }

    .tools {
      display: flex;
      gap: 8px;
      align-items: center;
      justify-content: space-between;
      flex-wrap: wrap;
      margin-bottom: 10px;
    }

    .list { display: flex; flex-direction: column; gap: 10px; }
    .item {
      border: 1px solid #e5e7eb;
      border-radius: 12px;
      padding: 10px;
      background: #fff;
    }
    .item-head {
      display: flex;
      align-items: baseline;
      justify-content: space-between;
      gap: 10px;
      flex-wrap: wrap;
    }
    .item-title { font-weight: 800; }
    .item-meta { font-size: 12px; color: #475569; }
    .item-body { margin-top: 6px; font-size: 13px; line-height: 1.5; }
    .pill {
      display: inline-block;
      font-size: 11px;
      padding: 2px 8px;
      border-radius: 999px;
      border: 1px solid #e5e7eb;
      color: #334155;
      background: #f8fafc;
      margin-right: 6px;
    }

    .toast {
      position: fixed;
      left: 50%;
      transform: translateX(-50%);
      bottom: 18px;
      background: #111827;
      color: #fff;
      padding: 10px 14px;
      border-radius: 999px;
      font-size: 13px;
      opacity: 0;
      pointer-events: none;
      transition: opacity .2s ease;
      z-index: 50;
    }
    .toast.show { opacity: 1; }

    .modal-backdrop {
      position: fixed;
      inset: 0;
      background: rgba(15,23,42,.45);
      display: none;
      align-items: center;
      justify-content: center;
      padding: 16px;
      z-index: 60;
    }
    .modal {
      width: min(720px, 100%);
      background: #fff;
      border-radius: 14px;
      border: 1px solid #e5e7eb;
      box-shadow: 0 18px 55px rgba(2,6,23,.25);
      padding: 14px;
    }

    .chart-wrap {
      margin: 10px 0 0;
      padding: 10px;
      border: 1px solid #e5e7eb;
      border-radius: 12px;
      background: #f8fafc;
    }
    .chart-title {
      font-weight: 900;
      font-size: 13px;
      margin-bottom: 6px;
      display: flex;
      align-items: baseline;
      justify-content: space-between;
      gap: 8px;
    }
    .chart-sub {
      font-size: 12px;
      color: #475569;
      font-weight: 700;
    }
    canvas.chart {
      width: 100%;
      height: 170px;
      display: block;
      border-radius: 10px;
      background: #ffffff;
      border: 1px solid #e5e7eb;
    }
    .legend {
      margin-top: 8px;
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      font-size: 12px;
      color: #475569;
    }
    .legend span {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      font-weight: 700;
    }
    .legend i {
      width: 10px;
      height: 10px;
      border-radius: 3px;
      display: inline-block;
    }


    @media (max-width: 980px) {
      .layout { grid-template-columns: 1fr; }
    }
  </style>
</head>
<body>
  <div class="topbar">
    <div class="topbar-inner">
      <div>
        <div class="title">ğŸ©º ãƒã‚¤ã‚¿ãƒ«è¨˜éŒ²ï¼ˆä½“é‡ãƒ»è¡€åœ§ãƒ»è„ˆæ‹ï¼‰</div>
        <div class="subtitle">â€»ä¿å­˜å…ˆã¯ãƒ–ãƒ©ã‚¦ã‚¶ã®ä¿å­˜é ˜åŸŸï¼ˆlocalStorageï¼‰ã§ã™ã€‚åˆ©ç”¨è€…ãƒ»è¨˜éŒ²è€…ãƒªã‚¹ãƒˆã¯æœ¬ä½“ã‚¢ãƒ—ãƒªã¨å…±æœ‰ã—ã¾ã™ã€‚</div>
      </div>
      <div style="display:flex; gap:10px; align-items:center; flex-wrap:wrap;">
        <a href="index.html">â† å€‹äººè¨˜éŒ²ã¸æˆ»ã‚‹</a>
        <button class="btn btn-ghost" id="exportCsvBtn">â¬‡ CSV</button>
        <button class="btn btn-ghost" id="backupVitalsBtn">ğŸ§· ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—</button>
        <button class="btn btn-ghost" id="restoreVitalsBtn">â™» å¾©å…ƒ</button>
        <input type="file" id="restoreVitalsFile" accept=".json,application/json" style="display:none" />
      </div>
    </div>
  </div>

  <div class="wrap">
    <div class="layout">
      <div class="card">
        <div class="card-title">
          <span>å…¥åŠ›</span>
          <span class="hint" id="quickStatus"></span>
        </div>

        <div class="grid">
          <div>
            <label>æ—¥ä»˜</label>
            <input type="date" id="vDate" />
          </div>
          <div>
            <label>æ™‚åˆ»</label>
            <input type="time" id="vTime" />
          </div>
        </div>

        <div class="grid" style="margin-top:10px;">
          <div>
            <label>åˆ©ç”¨è€…</label>
            <select id="vResident"></select>
          </div>
          <div>
            <label>è¨˜éŒ²è€…</label>
            <select id="vRecorder"></select>
          </div>
        </div>

        <div class="grid-3" style="margin-top:10px;">
          <div>
            <label>ä½“é‡ï¼ˆkgï¼‰</label>
            <input type="number" id="vWeight" inputmode="decimal" step="0.1" placeholder="ä¾‹ï¼‰58.4" />
          </div>
          <div>
            <label>è¡€åœ§ï¼ˆä¸Šï¼‰</label>
            <input type="number" id="vBpSys" inputmode="numeric" step="1" placeholder="ä¾‹ï¼‰128" />
          </div>
          <div>
            <label>è¡€åœ§ï¼ˆä¸‹ï¼‰</label>
            <input type="number" id="vBpDia" inputmode="numeric" step="1" placeholder="ä¾‹ï¼‰78" />
          </div>
        </div>

        <div class="grid" style="margin-top:10px;">
          <div>
            <label>è„ˆæ‹ï¼ˆå›/åˆ†ï¼‰</label>
            <input type="number" id="vPulse" inputmode="numeric" step="1" placeholder="ä¾‹ï¼‰72" />
          </div>
          <div>
            <label>ãƒ¡ãƒ¢ï¼ˆä»»æ„ï¼‰</label>
            <input type="text" id="vMemo" placeholder="ä¾‹ï¼‰èµ·åºŠå¾Œã€æœè–¬å‰" />
          </div>
        </div>

        <div class="btn-row">
          <button class="btn btn-primary" id="saveVitalBtn">ğŸ’¾ ä¿å­˜</button>
          <button class="btn" id="clearBtn">ğŸ§¹ ã‚¯ãƒªã‚¢</button>
          <button class="btn" id="copyBtn">ğŸ“‹ ã‚³ãƒ”ãƒ¼</button>
        </div>

        <div class="hint" style="margin-top:10px;">
          ãƒ»ä¿å­˜ã™ã‚‹ã¨å³ã®ä¸€è¦§ã«å‡ºã¾ã™ï¼ˆæ–°ã—ã„é †ï¼‰ã€‚<br>
          ãƒ»ã€ŒğŸ“‹ ã‚³ãƒ”ãƒ¼ã€ã¯ã€ä»Šå…¥åŠ›ã—ã¦ã„ã‚‹å†…å®¹ã‚’ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã¸ï¼ˆä¾‹ï¼šãƒã‚¤ã‚¿ãƒ«ï¼šä½“é‡58.4kgã€è¡€åœ§128/78ã€è„ˆæ‹72ï¼‰ã€‚
        </div>
      </div>

      <div class="card">
        <div class="card-title">
          <span>ä¸€è¦§</span>
          <span class="hint" id="countLabel"></span>
        </div>

        <div class="chart-wrap" id="chartsWrap">
          <div class="chart-title">
            <span>ä½“é‡ï¼ˆkgï¼‰</span>
            <span class="chart-sub" id="chartResidentLabel"></span>
          </div>
          <canvas id="chartWeight" class="chart"></canvas>
          <div class="hint" id="chartWeightHint" style="margin-top:6px"></div>
        </div>

        <div class="chart-wrap" id="chartsWrap2">
          <div class="chart-title"><span>è¡€åœ§ãƒ»è„ˆæ‹</span><span class="chart-sub" id="chartRangeLabel"></span></div>
          <canvas id="chartVitals" class="chart"></canvas>
          <div class="legend">
            <span><i style="background:#ef4444"></i>è¡€åœ§ï¼ˆä¸Šï¼‰</span>
            <span><i style="background:#f59e0b"></i>è¡€åœ§ï¼ˆä¸‹ï¼‰</span>
            <span><i style="background:#10b981"></i>è„ˆæ‹</span>
          </div>
          <div class="hint" id="chartVitalsHint" style="margin-top:6px"></div>
        </div>


        <div class="tools">
          <div style="display:flex; gap:8px; align-items:center; flex-wrap:wrap;">
            <label style="margin:0">è¡¨ç¤ºï¼š</label>
            <select id="filterResident" style="width:auto; min-width: 180px;"></select>
            <select id="filterRange" style="width:auto">
              <option value="today">ä»Šæ—¥</option>
              <option value="week" selected>ç›´è¿‘7æ—¥</option>
              <option value="month">ä»Šæœˆ</option>
              <option value="all">å…¨æœŸé–“</option>
            </select>
          </div>
          <input type="text" id="search" placeholder="æ¤œç´¢ï¼ˆãƒ¡ãƒ¢/æ•°å€¤ï¼‰" style="width: 180px;" />
        </div>

        <div class="list" id="list"></div>
      </div>
    </div>
  </div>

  <div class="toast" id="toast"></div>

  <div class="modal-backdrop" id="modalBg">
    <div class="modal">
      <div class="card-title"><span>ç·¨é›†</span><button class="btn" id="closeModalBtn">âœ•</button></div>

      <div class="grid">
        <div><label>æ—¥ä»˜</label><input type="date" id="eDate" /></div>
        <div><label>æ™‚åˆ»</label><input type="time" id="eTime" /></div>
      </div>

      <div class="grid" style="margin-top:10px;">
        <div><label>åˆ©ç”¨è€…</label><select id="eResident"></select></div>
        <div><label>è¨˜éŒ²è€…</label><select id="eRecorder"></select></div>
      </div>

      <div class="grid-3" style="margin-top:10px;">
        <div><label>ä½“é‡ï¼ˆkgï¼‰</label><input type="number" id="eWeight" step="0.1" /></div>
        <div><label>è¡€åœ§ï¼ˆä¸Šï¼‰</label><input type="number" id="eBpSys" step="1" /></div>
        <div><label>è¡€åœ§ï¼ˆä¸‹ï¼‰</label><input type="number" id="eBpDia" step="1" /></div>
      </div>

      <div class="grid" style="margin-top:10px;">
        <div><label>è„ˆæ‹ï¼ˆå›/åˆ†ï¼‰</label><input type="number" id="ePulse" step="1" /></div>
        <div><label>ãƒ¡ãƒ¢ï¼ˆä»»æ„ï¼‰</label><input type="text" id="eMemo" /></div>
      </div>

      <div class="btn-row">
        <button class="btn btn-primary" id="saveEditBtn">ğŸ’¾ æ›´æ–°</button>
        <button class="btn btn-danger" id="deleteEditBtn">ğŸ—‘ å‰Šé™¤</button>
      </div>
    </div>
  </div>

  <script>
    // å…±æœ‰ã‚­ãƒ¼ï¼ˆæœ¬ä½“ã‚¢ãƒ—ãƒªã¨åˆã‚ã›ã‚‹ï¼‰
    const RESIDENTS_KEY = "group_home_residents_v1";
    const RECORDERS_KEY = "group_home_recorders_v1";
    const VITALS_KEY    = "group_home_vitals_v1";

    const $ = (id) => document.getElementById(id);

    const toast = (msg) => {
      const el = $('toast');
      el.textContent = msg || '';
      el.classList.add('show');
      clearTimeout(window.__toastT);
      window.__toastT = setTimeout(() => el.classList.remove('show'), 1400);
    };

    const loadJSON = (key, fallback) => {
      try {
        const raw = localStorage.getItem(key);
        if (!raw) return fallback;
        const v = JSON.parse(raw);
        return v;
      } catch (e) {
        return fallback;
      }
    };
    const saveJSON = (key, value) => {
      localStorage.setItem(key, JSON.stringify(value));
    };

    const pad2 = (n) => String(n).padStart(2, '0');
    const nowLocalDate = () => {
      const d = new Date();
      return `${d.getFullYear()}-${pad2(d.getMonth()+1)}-${pad2(d.getDate())}`;
    };
    const nowLocalTime = () => {
      const d = new Date();
      return `${pad2(d.getHours())}:${pad2(d.getMinutes())}`;
    };

    function buildMeasuredAt(dateStr, timeStr) {
      // date/time (local) -> ISO string
      const [y,m,da] = dateStr.split('-').map(Number);
      const [h,mi] = timeStr.split(':').map(Number);
      const d = new Date(y, (m-1), da, h, mi, 0, 0);
      return d.toISOString();
    }

    function formatJP(iso) {
      const d = new Date(iso);
      const y = d.getFullYear();
      const m = pad2(d.getMonth()+1);
      const da = pad2(d.getDate());
      const h = pad2(d.getHours());
      const mi = pad2(d.getMinutes());
      return `${y}/${m}/${da} ${h}:${mi}`;
    }

    function vitalsToText(v) {
      const parts = [];
      const w = (v.weight ?? '');
      const s = (v.bpSys ?? '');
      const d = (v.bpDia ?? '');
      const p = (v.pulse ?? '');
      if (String(w).trim() !== '') parts.push(`ä½“é‡${w}kg`);
      if (String(s).trim() !== '' || String(d).trim() !== '') parts.push(`è¡€åœ§${s || 'â€•'}/${d || 'â€•'}`);
      if (String(p).trim() !== '') parts.push(`è„ˆæ‹${p}`);
      const memo = String(v.memo || '').trim();
      const base = parts.length ? parts.join('ã€') : 'ï¼ˆæœªå…¥åŠ›ï¼‰';
      return memo ? `ãƒã‚¤ã‚¿ãƒ«ï¼š${base}ï¼ˆ${memo}ï¼‰` : `ãƒã‚¤ã‚¿ãƒ«ï¼š${base}`;
    }

    function buildResidentsSelect(selectEl, list, allowAll=false) {
      selectEl.innerHTML = '';
      if (allowAll) {
        const opt = document.createElement('option');
        opt.value = '__all__';
        opt.textContent = 'å…¨å“¡';
        selectEl.appendChild(opt);
      }
      if (!Array.isArray(list) || list.length === 0) {
        const opt = document.createElement('option');
        opt.value = '';
        opt.textContent = 'ï¼ˆåˆ©ç”¨è€…ãŒæœªç™»éŒ²ã§ã™ï¼‰';
        selectEl.appendChild(opt);
        return;
      }
      for (const name of list) {
        const opt = document.createElement('option');
        opt.value = name;
        opt.textContent = name;
        selectEl.appendChild(opt);
      }
    }

    function buildRecordersSelect(selectEl, list) {
      selectEl.innerHTML = '';
      if (!Array.isArray(list) || list.length === 0) {
        const opt = document.createElement('option');
        opt.value = '';
        opt.textContent = 'ï¼ˆè¨˜éŒ²è€…ãŒæœªç™»éŒ²ã§ã™ï¼‰';
        selectEl.appendChild(opt);
        return;
      }
      for (const name of list) {
        const opt = document.createElement('option');
        opt.value = name;
        opt.textContent = name;
        selectEl.appendChild(opt);
      }
    }

    function loadVitals() {
      const v = loadJSON(VITALS_KEY, []);
      return Array.isArray(v) ? v : [];
    }
    function saveVitals(list) {
      saveJSON(VITALS_KEY, list);
    }

    function getFilterRange() {
      const mode = $('filterRange').value;
      const now = new Date();
      const end = now.getTime();
      let start = 0;
      if (mode === 'today') {
        const d = new Date(now.getFullYear(), now.getMonth(), now.getDate(), 0,0,0,0);
        start = d.getTime();
      } else if (mode === 'week') {
        start = end - 7*24*60*60*1000;
      } else if (mode === 'month') {
        const d = new Date(now.getFullYear(), now.getMonth(), 1, 0,0,0,0);
        start = d.getTime();
      } else {
        start = 0;
      }
      return { start, end };
    }

    function normalizeNum(v) {
      if (v == null) return '';
      const s = String(v).trim();
      return s;
    }


    function parseNumOrNull(v) {
      const s = String(v ?? '').trim();
      if (!s) return null;
      const n = Number(s);
      return Number.isFinite(n) ? n : null;
    }

    function dayKeyFromISO(iso) {
      const d = new Date(iso);
      return `${d.getFullYear()}-${pad2(d.getMonth()+1)}-${pad2(d.getDate())}`;
    }

    function shortLabelFromISO(iso) {
      const d = new Date(iso);
      return `${pad2(d.getMonth()+1)}/${pad2(d.getDate())}`;
    }

    function groupByDayLastMetrics(records) {
      // records: measuredAt ASC recommended
      const map = new Map();
      for (const v of records) {
        const iso = v.measuredAt;
        if (!iso) continue;
        const k = dayKeyFromISO(iso);
        let cur = map.get(k);
        if (!cur) {
          cur = { day: k, label: shortLabelFromISO(iso), lastISO: iso, weight: null, bpSys: null, bpDia: null, pulse: null };
          map.set(k, cur);
        }
        // keep latest ISO for label positioning
        if (String(iso).localeCompare(String(cur.lastISO)) > 0) {
          cur.lastISO = iso;
          cur.label = shortLabelFromISO(iso);
        }
        const w = parseNumOrNull(v.weight);
        const s = parseNumOrNull(v.bpSys);
        const d = parseNumOrNull(v.bpDia);
        const p = parseNumOrNull(v.pulse);
        if (w != null) cur.weight = w;
        if (s != null) cur.bpSys = s;
        if (d != null) cur.bpDia = d;
        if (p != null) cur.pulse = p;
      }
      const days = Array.from(map.values()).sort((a,b) => a.day.localeCompare(b.day));
      return days;
    }

    function sizeCanvasToCSS(canvas) {
      const rect = canvas.getBoundingClientRect();
      const dpr = window.devicePixelRatio || 1;
      const w = Math.max(1, Math.floor(rect.width * dpr));
      const h = Math.max(1, Math.floor(rect.height * dpr));
      if (canvas.width !== w || canvas.height !== h) {
        canvas.width = w;
        canvas.height = h;
      }
      return { cssW: rect.width, cssH: rect.height, dpr };
    }

    function drawLineChart(canvas, labels, series, opts) {
      const ctx = canvas.getContext('2d');
      const { cssW, cssH, dpr } = sizeCanvasToCSS(canvas);
      ctx.setTransform(dpr,0,0,dpr,0,0);
      ctx.clearRect(0,0,cssW,cssH);

      const padL = 46, padR = 10, padT = 10, padB = 30;
      const innerW = Math.max(10, cssW - padL - padR);
      const innerH = Math.max(10, cssH - padT - padB);

      // collect y values
      const ys = [];
      for (const s of series) {
        for (const y of s.y) if (y != null) ys.push(y);
      }
      if (labels.length < 1 || ys.length === 0) {
        // empty
        ctx.fillStyle = '#475569';
        ctx.font = '12px system-ui, -apple-system, Segoe UI, Roboto, Noto Sans JP, Yu Gothic UI, sans-serif';
        ctx.fillText('ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“ï¼ˆæœŸé–“/åˆ©ç”¨è€…ã‚’åˆ‡ã‚Šæ›¿ãˆã¦ãã ã•ã„ï¼‰', 12, 22);
        return;
      }

      let yMin = Math.min(...ys);
      let yMax = Math.max(...ys);
      if (!Number.isFinite(yMin) || !Number.isFinite(yMax)) return;
      if (yMin === yMax) {
        yMin -= 1;
        yMax += 1;
      } else {
        const pad = (yMax - yMin) * 0.08;
        yMin -= pad;
        yMax += pad;
      }

      const xCount = labels.length;
      const xAt = (i) => padL + (xCount === 1 ? 0 : (i * innerW / (xCount - 1)));
      const yAt = (v) => padT + (yMax - v) * innerH / (yMax - yMin);

      // grid
      ctx.strokeStyle = '#e5e7eb';
      ctx.lineWidth = 1;
      const gridN = 4;
      for (let g=0; g<=gridN; g++) {
        const y = padT + innerH * (g / gridN);
        ctx.beginPath();
        ctx.moveTo(padL, y);
        ctx.lineTo(padL + innerW, y);
        ctx.stroke();
      }

      // y labels
      ctx.fillStyle = '#475569';
      ctx.font = '12px system-ui, -apple-system, Segoe UI, Roboto, Noto Sans JP, Yu Gothic UI, sans-serif';
      for (let g=0; g<=gridN; g++) {
        const v = yMax - (yMax - yMin) * (g / gridN);
        const y = padT + innerH * (g / gridN);
        ctx.fillText((opts && opts.yFmt ? opts.yFmt(v) : String(Math.round(v))), 6, y + 4);
      }

      // x labels (few ticks)
      const ticks = []
      if (xCount <= 6) {
        for (let i=0;i<xCount;i++) ticks.push(i);
      } else {
        ticks.push(0);
        ticks.push(Math.floor((xCount-1)*0.25));
        ticks.push(Math.floor((xCount-1)*0.5));
        ticks.push(Math.floor((xCount-1)*0.75));
        ticks.push(xCount-1);
      }
      const uniqTicks = Array.from(new Set(ticks)).sort((a,b)=>a-b);
      for (const i of uniqTicks) {
        const x = xAt(i);
        const txt = labels[i] || '';
        ctx.fillText(txt, Math.min(cssW-28, Math.max(0, x-12)), padT + innerH + 22);
      }

      // series lines
      for (const s of series) {
        ctx.strokeStyle = s.color;
        ctx.lineWidth = 2;
        ctx.beginPath();
        let started = false;
        for (let i=0;i<xCount;i++) {
          const yv = s.y[i];
          if (yv == null) {
            started = false;
            continue;
          }
          const x = xAt(i);
          const y = yAt(yv);
          if (!started) {
            ctx.moveTo(x,y);
            started = true;
          } else {
            ctx.lineTo(x,y);
          }
        }
        ctx.stroke();

        // points
        ctx.fillStyle = s.color;
        for (let i=0;i<xCount;i++) {
          const yv = s.y[i];
          if (yv == null) continue;
          const x = xAt(i);
          const y = yAt(yv);
          ctx.beginPath();
          ctx.arc(x, y, 3, 0, Math.PI*2);
          ctx.fill();
        }
      }
    }

    function getFilteredForChart() {
      const all = loadVitals();
      const resident = $('filterResident').value;
      const { start, end } = getFilterRange();
      return all
        .slice()
        .sort((a,b) => (a.measuredAt || '').localeCompare(b.measuredAt || ''))
        .filter(v => {
          const t = new Date(v.measuredAt || 0).getTime();
          if (start && t < start) return false;
          if (end && t > end) return false;
          if (resident && resident !== '__all__' && v.resident !== resident) return false;
          return true;
        });
    }

    function getRangeLabel() {
      const mode = $('filterRange').value;
      if (mode === 'today') return 'ä»Šæ—¥';
      if (mode === 'week') return 'ç›´è¿‘7æ—¥';
      if (mode === 'month') return 'ä»Šæœˆ';
      return 'å…¨æœŸé–“';
    }

    function renderCharts() {
      const records = getFilteredForChart();
      const days = groupByDayLastMetrics(records);
      const labels = days.map(d => d.label);

      const resident = $('filterResident').value;
      const residentLabel = (resident && resident !== '__all__') ? resident : 'ï¼ˆå…¨å“¡ï¼‰';
      const rangeLabel = getRangeLabel();

      const cr = $('chartResidentLabel');
      const rg = $('chartRangeLabel');
      if (cr) cr.textContent = residentLabel;
      if (rg) rg.textContent = rangeLabel;

      const weightY = days.map(d => d.weight);
      const bpSysY = days.map(d => d.bpSys);
      const bpDiaY = days.map(d => d.bpDia);
      const pulseY = days.map(d => d.pulse);

      // weight chart
      const wHint = $('chartWeightHint');
      const vHint = $('chartVitalsHint');
      if (resident === '__all__') {
        if (wHint) wHint.textContent = 'â€»å…¨å“¡è¡¨ç¤ºã ã¨æ··åœ¨ã—ã¾ã™ã€‚åˆ©ç”¨è€…ã§çµã‚‹ã¨è¦‹ã‚„ã™ã„ã§ã™ã€‚';
      } else {
        if (wHint) wHint.textContent = '';
      }

      drawLineChart($('chartWeight'), labels, [
        { name: 'ä½“é‡', color: '#2563eb', y: weightY }
      ], { yFmt: (v) => (Math.round(v*10)/10).toString() });

      // vitals chart
      if (vHint) vHint.textContent = '';
      drawLineChart($('chartVitals'), labels, [
        { name: 'è¡€åœ§ï¼ˆä¸Šï¼‰', color: '#ef4444', y: bpSysY },
        { name: 'è¡€åœ§ï¼ˆä¸‹ï¼‰', color: '#f59e0b', y: bpDiaY },
        { name: 'è„ˆæ‹', color: '#10b981', y: pulseY },
      ], { yFmt: (v) => String(Math.round(v)) });
    }

    function renderList() {
      const listEl = $('list');
      const all = loadVitals();
      const resident = $('filterResident').value;
      const q = String($('search').value || '').trim().toLowerCase();
      const { start, end } = getFilterRange();

      const filtered = all
        .slice()
        .sort((a,b) => (b.measuredAt || '').localeCompare(a.measuredAt || ''))
        .filter(v => {
          const t = new Date(v.measuredAt || 0).getTime();
          if (start && t < start) return false;
          if (end && t > end) return false;
          if (resident && resident !== '__all__' && v.resident !== resident) return false;
          if (q) {
            const hay = [
              v.resident, v.recorder, v.memo,
              normalizeNum(v.weight), normalizeNum(v.bpSys), normalizeNum(v.bpDia), normalizeNum(v.pulse)
            ].join(' ').toLowerCase();
            if (!hay.includes(q)) return false;
          }
          return true;
        });

      $('countLabel').textContent = `${filtered.length}ä»¶`;
      listEl.innerHTML = '';

      renderCharts();

      if (filtered.length === 0) {
        const div = document.createElement('div');
        div.className = 'hint';
        div.textContent = 'ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“ã€‚å·¦ã§å…¥åŠ›ã—ã¦ä¿å­˜ã—ã¦ãã ã•ã„ã€‚';
        listEl.appendChild(div);
        return;
      }

      for (const v of filtered) {
        const item = document.createElement('div');
        item.className = 'item';

        const head = document.createElement('div');
        head.className = 'item-head';

        const left = document.createElement('div');
        left.innerHTML = `<div class="item-title">${formatJP(v.measuredAt)} <span class="pill">${escapeHTML(v.resident || '')}</span></div>`;

        const right = document.createElement('div');
        right.className = 'item-meta';
        right.textContent = v.recorder ? `è¨˜éŒ²è€…ï¼š${v.recorder}` : '';

        head.appendChild(left);
        head.appendChild(right);

        const body = document.createElement('div');
        body.className = 'item-body';

        const chunks = [];
        if (String(v.weight||'').trim() !== '') chunks.push(`ä½“é‡ ${v.weight}kg`);
        if (String(v.bpSys||'').trim() !== '' || String(v.bpDia||'').trim() !== '') chunks.push(`è¡€åœ§ ${v.bpSys||'â€•'}/${v.bpDia||'â€•'}`);
        if (String(v.pulse||'').trim() !== '') chunks.push(`è„ˆæ‹ ${v.pulse}`);
        const memo = String(v.memo||'').trim();
        body.innerHTML = `${chunks.map(c=>`<span class="pill">${escapeHTML(c)}</span>`).join(' ')}${memo?`<div class="item-meta" style="margin-top:6px">ãƒ¡ãƒ¢ï¼š${escapeHTML(memo)}</div>`:''}`;

        const btns = document.createElement('div');
        btns.className = 'btn-row';
        btns.style.marginTop = '8px';

        const bCopy = document.createElement('button');
        bCopy.className = 'btn';
        bCopy.textContent = 'ğŸ“‹ ã‚³ãƒ”ãƒ¼';
        bCopy.onclick = () => {
          const txt = vitalsToText(v);
          navigator.clipboard?.writeText(txt).then(() => toast('ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ')).catch(() => {
            fallbackCopy(txt);
            toast('ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ');
          });
        };

        const bEdit = document.createElement('button');
        bEdit.className = 'btn';
        bEdit.textContent = 'âœ ç·¨é›†';
        bEdit.onclick = () => openEdit(v.id);

        btns.appendChild(bCopy);
        btns.appendChild(bEdit);

        item.appendChild(head);
        item.appendChild(body);
        item.appendChild(btns);
        listEl.appendChild(item);
      }
    }

    function escapeHTML(s){
      return String(s ?? '').replace(/[&<>\"']/g, (c) => ({'&':'&amp;','<':'&lt;','>':'&gt;','\"':'&quot;',"'":'&#39;'}[c]));
    }

    function fallbackCopy(text){
      const ta = document.createElement('textarea');
      ta.value = text;
      document.body.appendChild(ta);
      ta.select();
      document.execCommand('copy');
      ta.remove();
    }

    function clearInputs() {
      $('vWeight').value = '';
      $('vBpSys').value = '';
      $('vBpDia').value = '';
      $('vPulse').value = '';
      $('vMemo').value = '';
      $('quickStatus').textContent = '';
    }

    function getCurrentDraft() {
      const date = $('vDate').value;
      const time = $('vTime').value;
      const resident = $('vResident').value;
      const recorder = $('vRecorder').value;
      const weight = String($('vWeight').value || '').trim();
      const bpSys = String($('vBpSys').value || '').trim();
      const bpDia = String($('vBpDia').value || '').trim();
      const pulse = String($('vPulse').value || '').trim();
      const memo = String($('vMemo').value || '').trim();
      return { date, time, resident, recorder, weight, bpSys, bpDia, pulse, memo };
    }

    function saveDraftToVitals() {
      const d = getCurrentDraft();
      if (!d.resident) {
        toast('åˆ©ç”¨è€…ã‚’é¸æŠã—ã¦ãã ã•ã„');
        return;
      }
      if (!d.date || !d.time) {
        toast('æ—¥ä»˜ã¨æ™‚åˆ»ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
        return;
      }

      const entry = {
        id: crypto?.randomUUID ? crypto.randomUUID() : String(Date.now()) + '_' + Math.random().toString(16).slice(2),
        resident: d.resident,
        recorder: d.recorder || '',
        measuredAt: buildMeasuredAt(d.date, d.time),
        weight: d.weight,
        bpSys: d.bpSys,
        bpDia: d.bpDia,
        pulse: d.pulse,
        memo: d.memo,
      };

      const all = loadVitals();
      all.push(entry);
      saveVitals(all);

      $('quickStatus').textContent = 'ä¿å­˜ã—ã¾ã—ãŸ';
      toast('ä¿å­˜ã—ã¾ã—ãŸ');

      // æ¬¡ã®å…¥åŠ›ç”¨ã«æ™‚åˆ»ã ã‘æ›´æ–°ï¼ˆä½“é‡ç­‰ã¯ã‚¯ãƒªã‚¢ï¼‰
      $('vTime').value = nowLocalTime();
      clearInputs();

      renderList();

      window.addEventListener('resize', () => {
        // resize charts for new width
        try { renderCharts(); } catch(e) {}
      });
    }

    // --- ç·¨é›† ---
    let editingId = null;

    function openEdit(id) {
      const all = loadVitals();
      const v = all.find(x => x.id === id);
      if (!v) return;
      editingId = id;

      const d = new Date(v.measuredAt);
      $('eDate').value = `${d.getFullYear()}-${pad2(d.getMonth()+1)}-${pad2(d.getDate())}`;
      $('eTime').value = `${pad2(d.getHours())}:${pad2(d.getMinutes())}`;

      $('eResident').value = v.resident || '';
      $('eRecorder').value = v.recorder || '';
      $('eWeight').value = v.weight ?? '';
      $('eBpSys').value = v.bpSys ?? '';
      $('eBpDia').value = v.bpDia ?? '';
      $('ePulse').value = v.pulse ?? '';
      $('eMemo').value = v.memo ?? '';

      $('modalBg').style.display = 'flex';
    }

    function closeEdit() {
      editingId = null;
      $('modalBg').style.display = 'none';
    }

    function applyEdit() {
      if (!editingId) return;
      const all = loadVitals();
      const idx = all.findIndex(x => x.id === editingId);
      if (idx < 0) return;

      const date = $('eDate').value;
      const time = $('eTime').value;
      if (!date || !time) { toast('æ—¥ä»˜ã¨æ™‚åˆ»ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„'); return; }

      all[idx] = {
        ...all[idx],
        resident: $('eResident').value || '',
        recorder: $('eRecorder').value || '',
        measuredAt: buildMeasuredAt(date, time),
        weight: String($('eWeight').value || '').trim(),
        bpSys: String($('eBpSys').value || '').trim(),
        bpDia: String($('eBpDia').value || '').trim(),
        pulse: String($('ePulse').value || '').trim(),
        memo: String($('eMemo').value || '').trim(),
      };

      saveVitals(all);
      toast('æ›´æ–°ã—ã¾ã—ãŸ');
      closeEdit();
      renderList();

      window.addEventListener('resize', () => {
        // resize charts for new width
        try { renderCharts(); } catch(e) {}
      });
    }

    function deleteEdit() {
      if (!editingId) return;
      const ok = confirm('ã“ã®ãƒã‚¤ã‚¿ãƒ«è¨˜éŒ²ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ');
      if (!ok) return;
      const all = loadVitals().filter(x => x.id !== editingId);
      saveVitals(all);
      toast('å‰Šé™¤ã—ã¾ã—ãŸ');
      closeEdit();
      renderList();

      window.addEventListener('resize', () => {
        // resize charts for new width
        try { renderCharts(); } catch(e) {}
      });
    }

    // --- CSV / ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ— / å¾©å…ƒï¼ˆã“ã®ãƒšãƒ¼ã‚¸å˜ä½“ï¼‰ ---
    function yyyymmdd_hhmmss(){
      const d = new Date();
      return `${d.getFullYear()}${pad2(d.getMonth()+1)}${pad2(d.getDate())}_${pad2(d.getHours())}${pad2(d.getMinutes())}${pad2(d.getSeconds())}`;
    }

    function downloadTextFile(filename, text, mime){
      const blob = new Blob([text], {type: mime || 'text/plain'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      a.remove();
      setTimeout(()=>URL.revokeObjectURL(url), 3000);
    }

    function exportCsv(){
      const rows = [
        ['measuredAt','resident','recorder','weight','bpSys','bpDia','pulse','memo']
      ];
      for (const v of loadVitals()) {
        rows.push([
          v.measuredAt||'', v.resident||'', v.recorder||'', v.weight||'', v.bpSys||'', v.bpDia||'', v.pulse||'', (v.memo||'').replace(/\r?\n/g,' ')
        ]);
      }
      const csv = rows.map(r => r.map(cell => {
        const s = String(cell ?? '');
        if (/[\",\n]/.test(s)) return '"' + s.replace(/"/g,'""') + '"';
        return s;
      }).join(',')).join('\n');
      downloadTextFile(`vitals_${yyyymmdd_hhmmss()}.csv`, csv, 'text/csv');
      toast('CSVã‚’ä¿å­˜ã—ã¾ã—ãŸ');
    }

    function backupVitals(){
      const payload = {
        app: 'group_home_vitals',
        schemaVersion: 1,
        exportedAt: new Date().toISOString(),
        vitals: loadVitals(),
      };
      downloadTextFile(`vitals_backup_${yyyymmdd_hhmmss()}.json`, JSON.stringify(payload, null, 2), 'application/json');
      toast('ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‚’ä¿å­˜ã—ã¾ã—ãŸ');
    }

    function normalizeVitalsBackup(parsed){
      if (parsed && parsed.vitals && Array.isArray(parsed.vitals)) return parsed.vitals;
      if (Array.isArray(parsed)) return parsed;
      return null;
    }

    function restoreVitalsFile(file){
      if (!file) return;
      const reader = new FileReader();
      reader.onload = () => {
        try {
          const parsed = JSON.parse(String(reader.result||''));
          const vitals = normalizeVitalsBackup(parsed);
          if (!vitals) { alert('ã“ã®ãƒ•ã‚¡ã‚¤ãƒ«ã¯ãƒã‚¤ã‚¿ãƒ«å¾©å…ƒç”¨ã¨ã—ã¦èªè­˜ã§ãã¾ã›ã‚“ã§ã—ãŸ'); return; }
          const ok = confirm(`å¾©å…ƒã—ã¾ã™ã‹ï¼Ÿ\n\nç¾åœ¨ï¼š${loadVitals().length}ä»¶\nå¾©å…ƒï¼š${vitals.length}ä»¶\n\nâ€»ç¾åœ¨ã®ãƒã‚¤ã‚¿ãƒ«ã¯ä¸Šæ›¸ãã•ã‚Œã¾ã™ã€‚`);
          if (!ok) return;
          saveVitals(Array.isArray(vitals)?vitals:[]);
          toast('å¾©å…ƒã—ã¾ã—ãŸ');
          renderList();

      window.addEventListener('resize', () => {
        // resize charts for new width
        try { renderCharts(); } catch(e) {}
      });
        } catch (e) {
          alert('å¾©å…ƒã«å¤±æ•—ã—ã¾ã—ãŸï¼š' + (e?.message || e));
        }
      };
      reader.readAsText(file);
    }

    // --- åˆæœŸåŒ– ---
    function init(){
      $('vDate').value = nowLocalDate();
      $('vTime').value = nowLocalTime();

      const residents = loadJSON(RESIDENTS_KEY, []);
      const recorders = loadJSON(RECORDERS_KEY, []);

      buildResidentsSelect($('vResident'), residents, false);
      buildRecordersSelect($('vRecorder'), recorders);
      buildResidentsSelect($('filterResident'), residents, true);

      // filterResident: ãªã‚‹ã¹ãã€Œæœ€å¾Œã«ä½¿ã£ãŸåˆ©ç”¨è€…ã€ã¸ï¼ˆã‚°ãƒ©ãƒ•ãŒè¦‹ã‚„ã™ã„ï¼‰
      $('filterResident').value = '__all__';

      // ç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ«å´
      buildResidentsSelect($('eResident'), residents, false);
      buildRecordersSelect($('eRecorder'), recorders);

      // è¨­å®šã®å¾©å…ƒï¼ˆæœ€å¾Œã«ä½¿ã£ãŸåˆ©ç”¨è€…/è¨˜éŒ²è€…ï¼‰
      try {
        const last = loadJSON('group_home_vitals_last_v1', {});
        if (last && typeof last === 'object') {
          if (last.resident && Array.from($('vResident').options).some(o=>o.value===last.resident)) $('vResident').value = last.resident;
          if (last.recorder && Array.from($('vRecorder').options).some(o=>o.value===last.recorder)) $('vRecorder').value = last.recorder;
        }
      } catch(e){}

      // ã§ãã‚Œã°ä¸€è¦§ã‚‚åŒã˜åˆ©ç”¨è€…ã«åˆã‚ã›ã‚‹ï¼ˆè¦‹ã‚„ã™ã•å„ªå…ˆï¼‰
      try {
        const cur = $('vResident').value;
        if (cur && Array.from($('filterResident').options).some(o=>o.value===cur)) {
          $('filterResident').value = cur;
        } else {
          const first = Array.from($('filterResident').options).find(o => o.value && o.value !== '__all__');
          if (first) $('filterResident').value = first.value;
        }
      } catch(e){}

      $('saveVitalBtn').onclick = () => {
        // last used
        try { saveJSON('group_home_vitals_last_v1', { resident: $('vResident').value, recorder: $('vRecorder').value }); } catch(e){}
        saveDraftToVitals();
      };
      $('clearBtn').onclick = clearInputs;
      $('copyBtn').onclick = () => {
        const d = getCurrentDraft();
        const v = { weight:d.weight, bpSys:d.bpSys, bpDia:d.bpDia, pulse:d.pulse, memo:d.memo };
        const txt = vitalsToText(v);
        navigator.clipboard?.writeText(txt).then(() => toast('ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ')).catch(()=>{ fallbackCopy(txt); toast('ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ'); });
      };

      $('filterResident').onchange = renderList;
      $('filterRange').onchange = renderList;
      $('search').oninput = renderList;

      $('closeModalBtn').onclick = closeEdit;
      $('modalBg').addEventListener('click', (e) => { if (e.target === $('modalBg')) closeEdit(); });
      $('saveEditBtn').onclick = applyEdit;
      $('deleteEditBtn').onclick = deleteEdit;

      $('exportCsvBtn').onclick = exportCsv;
      $('backupVitalsBtn').onclick = backupVitals;
      $('restoreVitalsBtn').onclick = () => $('restoreVitalsFile').click();
      $('restoreVitalsFile').addEventListener('change', (e) => restoreVitalsFile(e.target.files?.[0]));

      renderList();

      window.addEventListener('resize', () => {
        // resize charts for new width
        try { renderCharts(); } catch(e) {}
      });

      // æ³¨æ„è¡¨ç¤º
      if (!Array.isArray(residents) || residents.length==0) {
        $('quickStatus').textContent = 'â€»åˆ©ç”¨è€…ãŒæœªç™»éŒ²ã§ã™ï¼ˆæœ¬ä½“ã®ã€Œâ‘  åˆ©ç”¨è€…ç®¡ç†ã€ã§ç™»éŒ²ã—ã¦ãã ã•ã„ï¼‰';
      }
    }

  
    document.addEventListener('DOMContentLoaded', init);

  </script>
</body>
</html>
